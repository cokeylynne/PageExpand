// --------------------------------------------------------------------------------
// PageExpand
//
// Hakuhin 2010-2013  http://hakuhin.jp
// --------------------------------------------------------------------------------


	// --------------------------------------------------------------------------------
	// 手動インポート
	//
	// 設定からエクスポートした文字列を記述すると、その設定値で動作します。
	// --------------------------------------------------------------------------------
	var project_import_manual = null;


	// --------------------------------------------------------------------------------
	// プライベート変数
	// --------------------------------------------------------------------------------

	// PageExpand プロジェクト
	var page_expand_project;

	// プロジェクト
	var project;

	// イベントディスパッチャー
	var page_expand_event_dispatcher;

	// マウス入力
	var input_mouse;

	// 実行キュー関連
	var execute_queue;

	// ローダーキュー関連
	var loader_queue;

	// アドレス関連
	var address_collection;

	// タスク関連
	var task_container;

	// デバッグ関連
	var page_expand_debug;

	// DOMノードが外れたか監視
	var document_observer_remove_node;

	// スクロール監視
	var document_observer_scroll;

	// 進捗通知
	var notify_progress;

	// イメージ管理
	var element_limitter_image;

	// サウンド管理
	var element_limitter_sound;

	// ビデオ管理
	var element_limitter_video;

	// アンカー監視
	var anchor_monitor;

	// リダイレクト辞書
	var redirect_url_dictionary;

	// 掲示板辞書
	var bbs_dictionary;

	// 解析辞書
	var analyze_work_dictionary;

	// 掲示板拡張
	var expand_bbs;

	// 拡張機能通信
	var extension_message;

	// 初期化済み
	var initialized = false;

	// 開始済み
	var started = false;

	// 解析が有効か
	var enable_analyze = true;


	// --------------------------------------------------------------------------------
	// PageExpand 初期化
	// --------------------------------------------------------------------------------
	function PageExpandInitialize(){

		if(initialized)	return;
		initialized = true;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		{
			// イベントディスパッチャー
			page_expand_event_dispatcher = new EventDispatcher();

			// マウス入力
			input_mouse = new InputMouse();

			// 実行キュー
			execute_queue = new ExecuteQueue();

			// ローダーキュー
			loader_queue = new LoaderQueue();

			// アドレスコレクション
			address_collection = new AddressCollection();

			// タスクコンテナを生成
			task_container = new TaskContainer();

			// デバッグ
			page_expand_debug = new PageExpandDebug();

			// DOMノードが外れたか監視
			document_observer_remove_node = new DocumentObserverRemoveDomNode();

			// スクロール監視
			document_observer_scroll = new DocumentObserverScroll();

			// 進捗通知
			notify_progress = new NotifyProgress();

			// イメージ管理
			element_limitter_image = new ElementLimiterByByteSize();

			// サウンド管理
			element_limitter_sound = new ElementLimiterByCount();

			// ビデオ管理
			element_limitter_video = new ElementLimiterByCount();

			// アンカー監視
			anchor_monitor = new AnchorMonitor();

			// リダイレクト辞書
			redirect_url_dictionary = new RedirectUrlDictionary();

			// 掲示板辞書
			bbs_dictionary = new BbsDictionary();

			// 解析辞書
			analyze_work_dictionary = new AnalyzeWorkDictionary();

			// 掲示板拡張
			expand_bbs = {
				enable:false,
				initialized:false,
				node_queue:new Array(),
				work:new Object()
			};

		}

		// --------------------------------------------------------------------------------
		// 実行ループ
		// --------------------------------------------------------------------------------
		(function(){
			var time_handle;

			// タスクを毎サイクル実行
			function TaskContainerExecute(){
				task_container.execute(0xffffffff);
			}

			// 開始関数をセット
			task_container.setStartFunc(function(){
				time_handle = setInterval(TaskContainerExecute, 1000 / 60);
			});

			// 終了関数をセット
			task_container.setEndFunc(function(){
				clearInterval(time_handle);
				time_handle = undefined;
			});
		})();

	}


	// --------------------------------------------------------------------------------
	// PageExpand プロジェクト
	// --------------------------------------------------------------------------------
	function PageExpandProject(){

		var _container = new Object();

		// --------------------------------------------------------------------------------
		// プロジェクトのアップデート
		// --------------------------------------------------------------------------------
		function ProjectUpdate(proj,param){

			// --------------------------------------------------------------------------------
			// プリセットを追加
			// --------------------------------------------------------------------------------
			function addPreset(ary,id,insert){
				var i;
				var obj;
				var num = ary.length;
				for(i=0;i<num;i++){
					if(ary[i].id == id){
						obj = ary[i];
						break;
					}
				}

				if(!obj){
					if(insert){
						// 挿入位置を検索
						for(i=num-1;i>=0;i--){
							if(ary[i].id == insert){
								break;
							}
						}
						if(i < 0){
							i = 0;
						}
					}else{
						i = num;
					}

					// オブジェクトを新規作成
					obj = new Object();
					obj.id = id;
					ary.splice(i,0,obj);
				}else{
					// ユーザー設定
					if(obj.user){
						// 複製
						var copy = ObjectCopy(obj);
						delete obj.user;
						delete copy.preset;

						var user = copy.user;
						user.name.standard += " (BackUp)";
						var locales = user.name.locales;
						for(var p in locales){
							locales[p] += " (BackUp)";
						}
						ary.splice(i+1, 0, copy);
						copy.id = createUserId(ary);
					}
				}

				return obj;
			}

			// --------------------------------------------------------------------------------
			// プリセットを取得
			// --------------------------------------------------------------------------------
			function getPreset(ary,id){
				var i;
				var param;
				var num = ary.length;
				for(i=0;i<num;i++){
					param = ary[i];
					if(param.id == id){
						if(param.preset){
							return param.preset;
						}else{
							break;
						}
					}
				}

				return null;
			}

			// --------------------------------------------------------------------------------
			// プリセットを破棄
			// --------------------------------------------------------------------------------
			function removePreset(asset,id){
				var ary = proj[asset];
				var i;
				var obj;
				var num = ary.length;
				for(i=0;i<num;i++){
					if(ary[i].id == id){
						obj = ary[i];
						break;
					}
				}

				if(obj){
					// オブジェクトを破棄
					ary.splice(i,1);

					var check = false;
					var urlmaps = proj.urlmap;
					var urlmap_num = urlmaps.length;

					// URLマッピングで使用中
					for(i=0;i<urlmap_num;i++){
						var urlmap = urlmaps[i];
						if(urlmap.user){
							if(urlmap.user[asset].id == id){
								check = true;
								break;
							}
						}
					}
					if(!check){
						// ユーザー設定を持つ
						if(obj.user){
							check = true;
						}
					}

					// プリセットをバックアップ
					if(check){
						var copy = ObjectCopy(obj);
						if(!copy.user){
							copy.user = copy.preset;
						}
						delete obj.user;
						delete copy.preset;

						var user = copy.user;
						user.name.standard += " (BackUp)";
						var locales = user.name.locales;
						for(var p in locales){
							locales[p] += " (BackUp)";
						}
						ary.splice(num-1, 0, copy);
						copy.id = createUserId(ary);

						// 複製先に変更
						for(i=0;i<urlmap_num;i++){
							var urlmap = urlmaps[i];
							if(urlmap.user){
								if(urlmap.user[asset].id == id){
									urlmap.user[asset].id = copy.id;
								}
							}
						}
					}

					// 未使用
					for(i=0;i<urlmap_num;i++){
						var urlmap = urlmaps[i];
						if(urlmap.preset){
							if(urlmap.preset[asset].id == id){
								urlmap.preset[asset].id = "";
								urlmap.preset[asset].enable = false;
							}
						}
					}
				}

				return obj;
			}

			// --------------------------------------------------------------------------------
			// プリセット更新
			// --------------------------------------------------------------------------------
			function updatePreset(ary,id,func){
				var i;
				var param;
				var num = ary.length;
				for(i=0;i<num;i++){
					param = ary[i];
					if(id == "*" || param.id == id){
						if(param.preset)	func(param.preset);
					}
				}
			}

			// --------------------------------------------------------------------------------
			// 更新
			// --------------------------------------------------------------------------------
			function update(ary,id,func){
				var i;
				var param;
				var num = ary.length;
				for(i=0;i<num;i++){
					param = ary[i];
					if(id == "*" || param.id == id){
						if(param.user)		func(param.user);
						if(param.preset)	func(param.preset);
					}
				}
			}

			// --------------------------------------------------------------------------------
			// 配列コンテナを作成
			// --------------------------------------------------------------------------------
			function createArrayContainer(name){
				if(typeof(proj[name]) == "object"){
					if(proj[name].constructor == Array){
						return proj[name];
					}
				}

				proj[name] = new Array();
				return proj[name];
			}

			// --------------------------------------------------------------------------------
			// 終了
			// --------------------------------------------------------------------------------
			function exit(){
				if(param){
					if(param.version !== undefined){
						if(proj.version >= param.version){
							return true;
						}
					}
				}

				return false;
			}

			// --------------------------------------------------------------------------------
			// プロジェクトワーク作成
			// --------------------------------------------------------------------------------
			if(!proj){
				proj = new Object();

				// バージョン値
				proj.version = 0;
			}
			if(exit())	return proj;

			// --------------------------------------------------------------------------------
			// プロジェクト ver.1
			// --------------------------------------------------------------------------------
			if(proj.version < 1){
				// バージョン値
				proj.version = 1;

				// --------------------------------------------------------------------------------
				// 基本設定
				// --------------------------------------------------------------------------------
				proj.standard = {
					filter_type:"deny",
					filter_deny:[
						"*://example.com/*",
						"*://*.example.com/*"
					],
					filter_allow:[
						"*://example.com/*",
						"*://*.example.com/*"
					],
					enable_debug_mode:false,
					enable_icon_address_bar:true,
					enable_context_menu:true,
					enable_enable_startup:true,
					load_thread_max:10,
					execute_queue:{
						time_occupancy:5,
						time_sleep:0
					}
				};

				// --------------------------------------------------------------------------------
				// 掲示板設定
				// --------------------------------------------------------------------------------
				createArrayContainer("expand_bbs");

				// 追加
				update(proj.expand_bbs,"*",function(obj){
					if(!(obj.name))						obj.name = new Object();
					if(!(obj.name.standard))			obj.name.standard = "";
					if(!(obj.name.locales))				obj.name.locales = new Object();

					if(!(obj.enable))					obj.enable = false;
					if(!(obj.script_allow))				obj.script_allow = "[]";
					if(!(obj.script_callback))			obj.script_callback = "[]";

					if(!(obj.popup))					obj.popup = new Object();
					if(!(obj.popup.origin_type))		obj.popup.origin_type = "adsorb_top_down";
					if(!(obj.popup.position_type))		obj.popup.position_type = "absolute";
					if(!(obj.popup.enable_animation))	obj.popup.enable_animation = false;
					if(!(obj.popup.percent))			obj.popup.percent = new Object();
					if(!(obj.popup.percent.x))			obj.popup.percent.x = 0;
					if(!(obj.popup.percent.y))			obj.popup.percent.y = 0;
					if(!(obj.popup.time_wait_open))		obj.popup.time_wait_open = 0;
					if(!(obj.popup.time_wait_close))	obj.popup.time_wait_close = 0;
					if(!(obj.popup.style_sheet))		obj.popup.style_sheet = 0;
				});

				// ２ちゃんねる掲示板
				var obj = addPreset(proj.expand_bbs,"2ch",null);
				obj.preset = {
					name:{
						standard:"2ch.net",
						locales:{
							ja:"２ちゃんねる掲示板",
							en:"2ch.net"
						}
					},
					enable:true,
					script_allow:"",
					script_callback:"",
					popup:{
						origin_type:"adsorb_top_bottom",
						position_type:"absolute",
						enable_animation:true,
						percent:{x:75,y:90},
						time_wait_open:0,
						time_wait_close:250,
						style_sheet:"padding:20px 10px; border:1px solid #000; background:#FFF; overflow-y:auto; word-wrap:break-word; word-break:break-all;"
					}
				};

				// ログ速
				var obj = addPreset(proj.expand_bbs,"logsoku","2ch");
				obj.preset = {
					name:{
						standard:"logsoku.com",
						locales:{
							ja:"ログ速",
							en:"logsoku.com"
						}
					},
					enable:true,
					script_allow:"",
					script_callback:"",
					popup:{
						origin_type:"adsorb_top_bottom",
						position_type:"absolute",
						enable_animation:true,
						percent:{x:75,y:90},
						time_wait_open:0,
						time_wait_close:250,
						style_sheet:"padding:20px 10px; border:1px solid #000; background:#FFF; overflow-y:auto; word-wrap:break-word; word-break:break-all;"
					}
				};

				// みみずん検索
				var obj = addPreset(proj.expand_bbs,"mimizun","logsoku");
				obj.preset = {
					name:{
						standard:"mimizun.com",
						locales:{
							ja:"みみずん検索",
							en:"mimizun.com"
						}
					},
					enable:true,
					script_allow:"",
					script_callback:"",
					popup:{
						origin_type:"adsorb_top_bottom",
						position_type:"absolute",
						enable_animation:true,
						percent:{x:75,y:90},
						time_wait_open:0,
						time_wait_close:250,
						style_sheet:"padding:20px 10px; border:1px solid #000; background:#FFF; overflow-y:auto; word-wrap:break-word; word-break:break-all;"
					}
				};

				// ふたば☆ちゃんねる
				var obj = addPreset(proj.expand_bbs,"2chan","mimizun");
				obj.preset = {
					name:{
						standard:"2chan.net",
						locales:{
							ja:"ふたば☆ちゃんねる",
							en:"2chan.net"
						}
					},
					enable:true,
					script_allow:"",
					script_callback:"",
					popup:{
						origin_type:"adsorb_top_bottom",
						position_type:"absolute",
						enable_animation:true,
						percent:{x:75,y:90},
						time_wait_open:0,
						time_wait_close:250,
						style_sheet:"padding:20px 10px; border:1px solid #000; background:#FFF; overflow-y:auto; word-wrap:break-word; word-break:break-all;"
					}
				};

				// 4chan.org
				var obj = addPreset(proj.expand_bbs,"4chan","2chan");
				obj.preset = {
					name:{
						standard:"4chan.org",
						locales:{
							ja:"4chan",
							en:"4chan.org"
						}
					},
					enable:true,
					script_allow:"",
					script_callback:"",
					popup:{
						origin_type:"adsorb_top_bottom",
						position_type:"absolute",
						enable_animation:true,
						percent:{x:75,y:90},
						time_wait_open:0,
						time_wait_close:250,
						style_sheet:"padding:20px 10px; border:1px solid #000; background:#FFF; overflow-y:auto; word-wrap:break-word; word-break:break-all;"
					}
				};

				// --------------------------------------------------------------------------------
				// URLマッピング設定
				// --------------------------------------------------------------------------------
				createArrayContainer("urlmap");

				// 追加
				update(proj.urlmap,"*",function(obj){
					if(!(obj.name))						obj.name = new Object();
					if(!(obj.name.standard))			obj.name.standard = "";
					if(!(obj.name.locales))				obj.name.locales = new Object();

					if(!(obj.enable))							obj.enable = false;
					if(!(obj.filter))							obj.filter = [];
					if(!(obj.access_block))						obj.access_block = new Object();
					if(!(obj.access_block.enable))				obj.access_block.enable = false;
					if(!(obj.replacement_to_element))			obj.replacement_to_element = new Object();
					if(!(obj.replacement_to_element.enable))	obj.replacement_to_element.enable = false;
					if(!(obj.replacement_to_text))				obj.replacement_to_text = new Object();
					if(!(obj.replacement_to_text.enable))		obj.replacement_to_text.enable = false;
					if(!(obj.replacement_to_link))				obj.replacement_to_link = new Object();
					if(!(obj.replacement_to_link.enable))		obj.replacement_to_link.enable = false;
					if(!(obj.replacement_to_referer))			obj.replacement_to_referer = new Object();
					if(!(obj.replacement_to_referer.enable))	obj.replacement_to_referer.enable = false;
					if(!(obj.replacement_to_useragent))			obj.replacement_to_useragent = new Object();
					if(!(obj.replacement_to_useragent.enable))	obj.replacement_to_useragent.enable = false;
					if(!(obj.make_link_to_text))				obj.make_link_to_text = new Object();
					if(!(obj.make_link_to_text.enable))			obj.make_link_to_text.enable = false;
					if(!(obj.expand_short_url))					obj.expand_short_url = new Object();
					if(!(obj.expand_short_url.enable))			obj.expand_short_url.enable = false;
					if(!(obj.expand_text))						obj.expand_text = new Object();
					if(!(obj.expand_text.enable))				obj.expand_text.enable = false;
					if(!(obj.expand_image))						obj.expand_image = new Object();
					if(!(obj.expand_image.enable))				obj.expand_image.enable = false;
					if(!(obj.expand_sound))						obj.expand_sound = new Object();
					if(!(obj.expand_sound.enable))				obj.expand_sound.enable = false;
					if(!(obj.expand_video))						obj.expand_video = new Object();
					if(!(obj.expand_video.enable))				obj.expand_video.enable = false;
					if(!(obj.expand_iframe))					obj.expand_iframe = new Object();
					if(!(obj.expand_iframe.enable))				obj.expand_iframe.enable = false;
					if(!(obj.style_sheet))						obj.style_sheet = new Object();
					if(!(obj.style_sheet.enable))				obj.style_sheet.enable = false;
					if(!(obj.experimental))						obj.experimental = new Object();
					if(!(obj.experimental.enable))				obj.experimental.enable = false;
				});

				// デフォルト
				var obj = addPreset(proj.urlmap,"default",null);
				obj.preset = {
					name:{
						standard:"Default",
						locales:{
							ja:"デフォルト（すべて）",
							en:"Default"
						}
					},
					enable:true,
					filter:[
						"*://*"
					],
					access_block:{enable:false,id:""},
					replacement_to_element:{enable:false,id:""},
					replacement_to_text:{enable:false,id:""},
					replacement_to_link:{enable:false,id:""},
					replacement_to_referer:{enable:false,id:""},
					replacement_to_useragent:{enable:false,id:""},
					make_link_to_text:{enable:true,id:"simple"},
					expand_short_url:{enable:true,id:"simple"},
					expand_text:{enable:false,id:""},
					expand_image:{enable:true,id:"popup"},
					expand_sound:{enable:false,id:""},
					expand_video:{enable:false,id:""},
					expand_iframe:{enable:false,id:""},
					style_sheet:{enable:true,id:"default"},
					experimental:{enable:false,id:""}
				};

				// twitter
				var obj = addPreset(proj.urlmap,"twitter","default");
				obj.preset = {
					name:{
						standard:"twitter.com",
						locales:{
							ja:"ツイッター",
							en:"twitter.com"
						}
					},
					enable:true,
					filter:[
						"*://twitter.com/*"
					],
					access_block:{enable:false,id:""},
					replacement_to_element:{enable:false,id:""},
					replacement_to_text:{enable:false,id:""},
					replacement_to_link:{enable:true,id:"no_referrer"},
					replacement_to_referer:{enable:true,id:"replacement_link"},
					replacement_to_useragent:{enable:false,id:""},
					make_link_to_text:{enable:true,id:"simple"},
					expand_short_url:{enable:true,id:"detail"},
					expand_text:{enable:false,id:""},
					expand_image:{enable:true,id:"thumbnail"},
					expand_sound:{enable:true,id:"inline"},
					expand_video:{enable:true,id:"inline"},
					expand_iframe:{enable:false,id:""},
					style_sheet:{enable:true,id:"default"},
					experimental:{enable:false,id:""}
				};

				// スレッド掲示板
				var obj = addPreset(proj.urlmap,"bbs","twitter");
				obj.preset = {
					name:{
						standard:"2ch.net",
						locales:{
							ja:"スレッド掲示板",
							en:"2ch.net"
						}
					},
					enable:true,
					filter:[
						"*://2ch.net/*",
						"*://*.2ch.net/*",
						"*://*.machi.to/*",
						"*://machibbs.net/*",
						"*://*.machibbs.net/*",
						"*://*.bbspink.com/*",
						"*://jbbs.livedoor.jp/*",
						"*://logsoku.com/*",
						"*://mimizun.com/log/*/*",
						"*://*.kakiko.com/*",
						"*://*.60.kg/*",
						"*://*.atchs.jp/*"
					],
					access_block:{enable:false,id:""},
					replacement_to_element:{enable:false,id:""},
					replacement_to_text:{enable:false,id:""},
					replacement_to_link:{enable:true,id:"direct_link_bbs"},
					replacement_to_referer:{enable:true,id:"replacement_link"},
					replacement_to_useragent:{enable:false,id:""},
					make_link_to_text:{enable:true,id:"detail"},
					expand_short_url:{enable:true,id:"detail"},
					expand_text:{enable:false,id:""},
					expand_image:{enable:true,id:"thumbnail"},
					expand_sound:{enable:true,id:"inline"},
					expand_video:{enable:true,id:"inline"},
					expand_iframe:{enable:false,id:""},
					style_sheet:{enable:true,id:"default"},
					experimental:{enable:false,id:""}
				};

				// 画像掲示板
				var obj = addPreset(proj.urlmap,"image_bbs","bbs");
				obj.preset = {
					name:{
						standard:"www.4chan.org",
						locales:{
							ja:"画像掲示板",
							en:"www.4chan.org"
						}
					},
					enable:true,
					filter:[
						"*://*.4chan.org/*",
						"*://*.2chan.net/*"
					],
					access_block:{enable:false,id:""},
					replacement_to_element:{enable:false,id:""},
					replacement_to_text:{enable:false,id:""},
					replacement_to_link:{enable:true,id:"no_referrer"},
					replacement_to_referer:{enable:true,id:"replacement_link"},
					replacement_to_useragent:{enable:false,id:""},
					make_link_to_text:{enable:true,id:"detail"},
					expand_short_url:{enable:true,id:"detail"},
					expand_text:{enable:false,id:""},
					expand_image:{enable:true,id:"popup"},
					expand_sound:{enable:true,id:"inline"},
					expand_video:{enable:true,id:"inline"},
					expand_iframe:{enable:false,id:""},
					style_sheet:{enable:true,id:"default"},
					experimental:{enable:false,id:""}
				};

				// 検索サイト
				var obj = addPreset(proj.urlmap,"search","image_bbs");
				obj.preset = {
					name:{
						standard:"Search",
						locales:{
							ja:"検索サイト",
							en:"Search"
						}
					},
					enable:true,
					filter:[
						"*://www.google.com/#*q=*",
						"*://www.google.com/search?*",
						"*://www.google.co.jp/#*q=*",
						"*://www.google.co.jp/search?*",
						"*://search.yahoo.com/search*",
						"*://search.yahoo.co.jp/*",
						"*://www.bing.com/search?*q=*",
						"*://topsy.com/s*"
					],
					access_block:{enable:false,id:""},
					replacement_to_element:{enable:false,id:""},
					replacement_to_text:{enable:false,id:""},
					replacement_to_link:{enable:true,id:"direct_link_search"},
					replacement_to_referer:{enable:false,id:""},
					replacement_to_useragent:{enable:false,id:""},
					make_link_to_text:{enable:true,id:"simple"},
					expand_short_url:{enable:true,id:"simple"},
					expand_text:{enable:false,id:""},
					expand_image:{enable:true,id:"popup"},
					expand_sound:{enable:true,id:"inline"},
					expand_video:{enable:true,id:"inline"},
					expand_iframe:{enable:false,id:""},
					style_sheet:{enable:true,id:"default"},
					experimental:{enable:false,id:""}
				};

				// 画像検索サイト
				var obj = addPreset(proj.urlmap,"image_search","search");
				obj.preset = {
					name:{
						standard:"Image Search",
						locales:{
							ja:"画像検索サイト",
							en:"Image Search"
						}
					},
					enable:true,
					filter:[],
					access_block:{enable:false,id:""},
					replacement_to_element:{enable:false,id:""},
					replacement_to_text:{enable:false,id:""},
					replacement_to_link:{enable:true,id:"direct_link_image_search"},
					replacement_to_referer:{enable:true,id:"replacement_link"},
					replacement_to_useragent:{enable:false,id:""},
					make_link_to_text:{enable:true,id:"simple"},
					expand_short_url:{enable:true,id:"simple"},
					expand_text:{enable:false,id:""},
					expand_image:{enable:true,id:"popup"},
					expand_sound:{enable:false,id:""},
					expand_video:{enable:false,id:""},
					expand_iframe:{enable:false,id:""},
					style_sheet:{enable:true,id:"default"},
					experimental:{enable:false,id:""}
				};

				// リアルタイム検索サイト
				var obj = addPreset(proj.urlmap,"realtime_search","image_search");
				obj.preset = {
					name:{
						standard:"Real Time Search",
						locales:{
							ja:"リアルタイム検索サイト",
							en:"Real Time Search"
						}
					},
					enable:true,
					filter:[
						"*://realtime.search.yahoo.co.jp/*",
						"*://topsy.com/s/*/tweet?*",
						"*://topsy.com/s?*type=tweet*",
						"*://www.bing.com/social/search*",
						"*://*search.naver.jp/realtime?*"
					],
					access_block:{enable:false,id:""},
					replacement_to_element:{enable:false,id:""},
					replacement_to_text:{enable:false,id:""},
					replacement_to_link:{enable:true,id:"direct_link_realtime_search"},
					replacement_to_referer:{enable:false,id:""},
					replacement_to_useragent:{enable:false,id:""},
					make_link_to_text:{enable:true,id:"simple"},
					expand_short_url:{enable:true,id:"simple"},
					expand_text:{enable:false,id:""},
					expand_image:{enable:true,id:"thumbnail"},
					expand_sound:{enable:true,id:"inline"},
					expand_video:{enable:true,id:"inline"},
					expand_iframe:{enable:false,id:""},
					style_sheet:{enable:true,id:"default"},
					experimental:{enable:false,id:""}
				};

				// --------------------------------------------------------------------------------
				// アクセスブロック定義
				// --------------------------------------------------------------------------------
				createArrayContainer("access_block");

				// 追加
				update(proj.access_block,"*",function(obj){
					if(!(obj.name))						obj.name = new Object();
					if(!(obj.name.standard))			obj.name.standard = "";
					if(!(obj.name.locales))				obj.name.locales = new Object();

					if(!(obj.filter))	obj.filter = [];
				});

				// --------------------------------------------------------------------------------
				// エレメント置換定義
				// --------------------------------------------------------------------------------
				createArrayContainer("replacement_to_element");

				// 追加
				update(proj.replacement_to_element,"*",function(obj){
					if(!(obj.name))						obj.name = new Object();
					if(!(obj.name.standard))			obj.name.standard = "";
					if(!(obj.name.locales))				obj.name.locales = new Object();

					if(!(obj.script))	obj.script = "[]";
				});

				// フォントの種類をメイリオに変更
				var obj = addPreset(proj.replacement_to_element,"meiryo_font",null);
				obj.preset = {
					name:{
						standard:"Meiryo Font",
						locales:{
							ja:"フォントの種類をメイリオに変更",
							en:"Meiryo Font"
						}
					},
					script:
"[\n\t" + 
	function(info,response){
		var element = info.element;
		var style = element.style;
		if(style){
			// フォントのサイズ(font-size)
			//style.fontSize = "12px";

			// フォントの太さ(font-weight)
			//style.fontWeight = "bold";

			// フォントの斜体(font-style)
			//style.fontStyle = "italic";

			// フォントの種類(font-family)
			style.fontFamily = "'メイリオ','Meiryo'";

			// 行の高さ(line-height)
			//style.lineHeight = "1.4";
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]"
				};

				// --------------------------------------------------------------------------------
				// テキスト置換定義
				// --------------------------------------------------------------------------------
				createArrayContainer("replacement_to_text");

				// 追加
				update(proj.replacement_to_text,"*",function(obj){
					if(!(obj.name))						obj.name = new Object();
					if(!(obj.name.standard))			obj.name.standard = "";
					if(!(obj.name.locales))				obj.name.locales = new Object();

					if(!(obj.script))	obj.script = "[]";
				});

				// 英数字記号を半角、カタカナを全角に変更
				var obj = addPreset(proj.replacement_to_text,"alphanumeric_half",null);
				obj.preset = {
					name:{
						standard:"String Convert From AlphanumericHalf To AlphanumericFull",
						locales:{
							ja:"英数字記号を半角、カタカナを全角に変更",
							en:"String Convert From AlphanumericHalf To AlphanumericFull"
						}
					},
					script:
"[\n\t" + 
	function(info,response){
		var text_node = info.text_node;

		// 文字列を取得
		var str = DomNodeGetNodeValue(text_node);
		if(!str){
			return false;
		}

		// 小文字化
		//str = str.toLowerCase();

		// 大文字化
		//str = str.toUpperCase();

		// 全角アルファベットから半角アルファベットに変換
		str = StringConvertFromAlphabeticFullToAlphabeticHalf(str);

		// 半角アルファベットから全角アルファベットに変換
		//str = StringConvertFromAlphabeticHalfToAlphabeticFull(str);

		// 全角数字から半角数字に変換
		str = StringConvertFromNumericFullToNumericHalf(str);

		// 半角英数字から全角英数字に変換
		//str = StringConvertFromNumericHalfToNumericFull(str);

		// 全角記号から半角記号に変換
		str = StringConvertFromSignFullToSignHalf(str);

		// 半角記号から全角記号に変換
		//str = StringConvertFromSignHalfToSignFull(str);

		// 全角スペースから半角スペースに変換
		//str = StringConvertFromSpaceFullToSpaceHalf(str);

		// 半角スペースから全角スペースに変換
		//str = StringConvertFromSpaceHalfToSpaceFull(str);

		// 半角カタカナから全角カタカナに変換
		str = StringConvertFromKatakanaFullToKatakanaHalf(str);

		// 全角カタカナから半角カタカナに変換
		//str = StringConvertFromKatakanaHalfToKatakanaFull(str);

		// ひらがなからカタカナに変換
		//str = StringConvertFromHiraganaToKatakana(str);

		// カタカナからひらがなに変換
		//str = StringConvertFromKatakanaToHiragana(str);

		// 文字列をセット
		DomNodeSetNodeValue(text_node,str);

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]"
				};

				// --------------------------------------------------------------------------------
				// ハイパーリンク置換定義
				// --------------------------------------------------------------------------------
				createArrayContainer("replacement_to_link");

				// 追加
				update(proj.replacement_to_link,"*",function(obj){
					if(!(obj.name))						obj.name = new Object();
					if(!(obj.name.standard))			obj.name.standard = "";
					if(!(obj.name.locales))				obj.name.locales = new Object();

					if(!(obj.script))	obj.script = "[]";
				});

				// ノーリファラ属性を追加
				var obj = addPreset(proj.replacement_to_link,"no_referrer",null);
				obj.preset = {
					name:{
						standard:"No Referer",
						locales:{
							ja:"ノーリファラ属性を追加",
							en:"No Referer"
						}
					},
					script:
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		// "noreferrer" が含まれない場合
		if(!(anchor_element.rel.match(/noreferrer/i))){

			// "noreferrer" を追加
			if(anchor_element.rel){
				anchor_element.rel += " noreferrer";
			}else{
				anchor_element.rel = "noreferrer";
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]"
				};

				// ソーシャルサービスのカウント数を表示
				var obj = addPreset(proj.replacement_to_link,"attach_sns_counter","no_referrer");
				obj.preset = {
					name:{
						standard:"Attach SNS Counter",
						locales:{
							ja:"ソーシャルサービスのカウント数を表示",
							en:"Attach SNS Counter"
						}
					},
					script:""
				};

				// 2ch.net 用
				var obj = addPreset(proj.replacement_to_link,"direct_link_bbs","attach_sns_counter");
				obj.preset = {
					name:{
						standard:"Direct Link (bbs)",
						locales:{
							ja:"直リンクに変更（スレッド掲示板用）",
							en:"Direct Link (bbs)"
						}
					},
					script:""
				};

				// 検索用
				var obj = addPreset(proj.replacement_to_link,"direct_link_search","direct_link_bbs");
				obj.preset = {
					name:{
						standard:"Direct Link (search)",
						locales:{
							ja:"直リンクに変更（検索用）",
							en:"Direct Link (search)"
						}
					},
					script:""
				};

				// イメージ検索用
				var obj = addPreset(proj.replacement_to_link,"direct_link_image_search","direct_link_search");
				obj.preset = {
					name:{
						standard:"Direct Link (image search)",
						locales:{
							ja:"直リンクに変更（イメージ検索用）",
							en:"Direct Link (image search)"
						}
					},
					script:""
				};

				// リアルタイム検索用
				var obj = addPreset(proj.replacement_to_link,"direct_link_realtime_search","direct_link_image_search");
				obj.preset = {
					name:{
						standard:"Direct Link (realtime search)",
						locales:{
							ja:"直リンクに変更（リアルタイム検索用）",
							en:"Direct Link (realtime search)"
						}
					},
					script:""
				};

				// --------------------------------------------------------------------------------
				// リファラ置換定義
				// --------------------------------------------------------------------------------
				createArrayContainer("replacement_to_referer");

				// 追加
				update(proj.replacement_to_referer,"*",function(obj){
					if(!(obj.name))						obj.name = new Object();
					if(!(obj.name.standard))			obj.name.standard = "";
					if(!(obj.name.locales))				obj.name.locales = new Object();

					if(!(obj.script))	obj.script = "[]";
				});

				// 空文字列に変更
				var obj = addPreset(proj.replacement_to_referer,"replacement_empty",null);
				obj.preset = {
					name:{
						standard:"Replace Empty",
						locales:{
							ja:"空文字列に変更",
							en:"Replace Empty"
						}
					},
					script:""
				};

				// リンク先のURLに変更
				var obj = addPreset(proj.replacement_to_referer,"replacement_link","replacement_empty");
				obj.preset = {
					name:{
						standard:"Replace Link",
						locales:{
							ja:"リンク先のURLに変更",
							en:"Replace Link"
						}
					},
					script:""
				};

				// --------------------------------------------------------------------------------
				// ユーザーエージェント置換定義
				// --------------------------------------------------------------------------------
				createArrayContainer("replacement_to_useragent");

				// 追加
				update(proj.replacement_to_useragent,"*",function(obj){
					if(!(obj.name))						obj.name = new Object();
					if(!(obj.name.standard))			obj.name.standard = "";
					if(!(obj.name.locales))				obj.name.locales = new Object();

					if(!(obj.script))	obj.script = "[]";
				});

				// iPhone4
				var obj = addPreset(proj.replacement_to_useragent,"iphone_4",null);
				obj.preset = {
					name:{
						standard:"iPhone4",
						locales:{
							ja:"iPhone4",
							en:"iPhone4"
						}
					},
					script:""
				};

				// Android 2.1
				var obj = addPreset(proj.replacement_to_useragent,"android_2_1","iphone_4");
				obj.preset = {
					name:{
						standard:"Android 2.1",
						locales:{
							ja:"Android 2.1",
							en:"Android 2.1"
						}
					},
					script:""
				};

				// DoCoMo/2.0
				var obj = addPreset(proj.replacement_to_useragent,"docomo_2_0","android_2_1");
				obj.preset = {
					name:{
						standard:"DoCoMo / 2.0",
						locales:{
							ja:"DoCoMo / 2.0",
							en:"DoCoMo / 2.0"
						}
					},
					script:""
				};

				// --------------------------------------------------------------------------------
				// ハイパーリンク化定義
				// --------------------------------------------------------------------------------
				createArrayContainer("make_link_to_text");

				// 追加
				update(proj.make_link_to_text,"*",function(obj){
					if(!(obj.name))						obj.name = new Object();
					if(!(obj.name.standard))			obj.name.standard = "";
					if(!(obj.name.locales))				obj.name.locales = new Object();

					if(!(obj.script))	obj.script = "[]";
				});

				// 簡易
				var obj = addPreset(proj.make_link_to_text,"simple",null);
				obj.preset = {
					name:{
						standard:"Simple",
						locales:{
							ja:"簡易",
							en:"Simple"
						}
					},
					script:""
				};

				// 詳細
				var obj = addPreset(proj.make_link_to_text,"detail","simple");
				obj.preset = {
					name:{
						standard:"Detail",
						locales:{
							ja:"詳細",
							en:"Detail"
						}
					},
					script:""
				};

				// --------------------------------------------------------------------------------
				// 短縮 URL 展開
				// --------------------------------------------------------------------------------
				createArrayContainer("expand_short_url");

				// 追加
				update(proj.expand_short_url,"*",function(obj){
					if(!(obj.name))						obj.name = new Object();
					if(!(obj.name.standard))			obj.name.standard = "";
					if(!(obj.name.locales))				obj.name.locales = new Object();

					if(!(obj.filter))	obj.filter = [];
				});

				// 簡易
				var obj = addPreset(proj.expand_short_url,"simple",null);
				obj.preset = {
					name:{
						standard:"Simple",
						locales:{
							ja:"簡易",
							en:"Simple"
						}
					},
					filter:[
						"http://bit.ly/*",
						"http://j.mp/*",
						"http://goo.gl/*",
						"http://c23.biz/*",
						"http://p.tl/*",
						"http://tinyurl.com/*",
						"http://ow.ly/*",
						"http://t.co/*",
						"http://fb.me/*",
						"http://amzn.to/*",
						"http://youtu.be/*",
						"http://g.co/*",
						"http://r10.to/*",
						"http://s.nikkei.com/*",
						"http://t.asahi.com/*"
					]
				};

				// 詳細
				var obj = addPreset(proj.expand_short_url,"detail","simple");
				obj.preset = {
					name:{
						standard:"Detail",
						locales:{
							ja:"詳細",
							en:"Detail"
						}
					},
					filter:[
						"http://tinyurl.com/*",
						"http://ow.ly/*",
						"http://dlvr.it/*",
						"http://s.nikkei.com/*",
						"http://t.asahi.com/*",
						"http://is.gd/*",
						"http://t.co/*",
						"http://fb.me/*",
						"http://amzn.to/*",
						"http://youtu.be/*",
						"http://tumblr.com/*",
						"http://a.r10.to/*",
						"http://ht.ly/*",
						"http://lnk.ms/*",
						"http://ustre.am/**",
						"http://r10.to/*",
						"http://tou.ch/*",
						"http://po.st/*",
						"http://htn.to/*",
						"http://moi.st/*",
						"http://fc2.in/*",
						"http://a8.net/*",
						"http://p.tl/*",
						"http://itun.es/*",
						"http://flic.kr/*",
						"http://moby.to/*",
						"http://instapaper.com/*",
						"http://icio.us/*",
						"http://dai.ly/*",
						"http://pbckt.com/*",
						"http://nhk.jp/*",
						"http://post.ly/*",
						"http://bit.ly/*",
						"http://goo.gl/*",
						"http://r.sm3.jp/*",
						"http://cot.ag/*",
						"http://mpr.hn/*",
						"http://rss.rssad.jp/*",
						"http://to.ly/*",
						"http://g.co/*",
						"http://fon.gs/*",
						"http://tuna.be/*",
						"http://mysp.ac/*",
						"http://j.mp/*",
						"http://snurl.com/*",
						"http://v.gd/*",
						"http://ux.nu/*",
						"http://qurl.com/*",
						"http://tr.im/*",
						"http://gigaz.in/*",
						"http://3.ly/*",
						"http://artbeat.ly/*",
						"http://sgp.cm/*",
						"http://30m.in/*",
						"http://bt.io/*",
						"http://pic.gd/*",
						"http://twt.mx/*",
						"http://url4.eu/*",
						"http://idek.net/*",
						"http://c23.biz/*"
					]
				};

				// --------------------------------------------------------------------------------
				// テキスト展開定義
				// --------------------------------------------------------------------------------
				createArrayContainer("expand_text");

				// 追加
				update(proj.expand_text,"*",function(obj){
					if(!(obj.name))						obj.name = new Object();
					if(!(obj.name.standard))			obj.name.standard = "";
					if(!(obj.name.locales))				obj.name.locales = new Object();

					if(!(obj.inline))					obj.inline = new Object();
					if(!(obj.inline.disable_same_text))	obj.inline.disable_same_text = false;
					if(!(obj.inline.script_allow))		obj.inline.script_allow = "[]";
					if(!(obj.inline.script_insert))		obj.inline.script_insert = "[]";
				});

				// インライン表示
				var obj = addPreset(proj.expand_text,"inline",null);
				obj.preset = {
					name:{
						standard:"Inline",
						locales:{
							ja:"インライン表示",
							en:"Inline"
						}
					},
					inline:{
						disable_same_text:true,
						script_allow:"",
						script_insert:""
					}
				};

				// --------------------------------------------------------------------------------
				// イメージ展開定義
				// --------------------------------------------------------------------------------
				createArrayContainer("expand_image");

				// 追加
				update(proj.expand_image,"*",function(obj){
					if(!(obj.name))						obj.name = new Object();
					if(!(obj.name.standard))			obj.name.standard = "";
					if(!(obj.name.locales))				obj.name.locales = new Object();

					if(!(obj.thumbnail))									obj.thumbnail = new Object();
					if(!(obj.thumbnail.enable_popup_mouseover))				obj.thumbnail.enable_popup_mouseover = false;
					if(!(obj.thumbnail.disable_same_image))					obj.thumbnail.disable_same_image = false;
					if(!(obj.thumbnail.script_allow))						obj.thumbnail.script_allow = "[]";
					if(!(obj.thumbnail.script_insert))						obj.thumbnail.script_insert = "[]";
					if(!(obj.popup))										obj.popup = new Object();
					if(!(obj.popup.origin_type))							obj.popup.origin_type = "center";
					if(!(obj.popup.position_type))							obj.popup.position_type = "absolute";
					if(!(obj.popup.time_wait_open))							obj.popup.time_wait_open = 0;
					if(!(obj.popup.time_wait_close))						obj.popup.time_wait_close = 0;

					if(!(obj.popup.enable_animation))						obj.popup.enable_animation = false;
					if(!(obj.popup.script_allow))							obj.popup.script_allow = "[]";
					if(!(obj.reduced_image))								obj.reduced_image = new Object();
					if(!(obj.reduced_image.enable_popup))					obj.reduced_image.enable_popup = false;
					if(!(obj.reduced_image.popup_allow_slcale_less_then))	obj.reduced_image.popup_allow_slcale_less_then = 0;
				});

				// サムネイル表示
				var obj = addPreset(proj.expand_image,"thumbnail",null);
				obj.preset = {
					name:{
						standard:"Thumbnail",
						locales:{
							ja:"サムネイル表示",
							en:"Thumbnail"
						}
					},
					thumbnail:{
						enable_popup_mouseover:true,
						disable_same_image:false,
						script_allow:"",
						script_insert:""
					},
					popup:{
						origin_type:"center",
						position_type:"absolute",
						time_wait_open:0,
						time_wait_close:0,
						enable_animation:true,
						script_allow:""
					},
					reduced_image:{
						enable_popup:true,
						popup_allow_slcale_less_then:70
					}
				};

				// ポップアップ表示
				var obj = addPreset(proj.expand_image,"popup","thumbnail");
				obj.preset = {
					name:{
						standard:"Popup",
						locales:{
							ja:"ポップアップ表示",
							en:"Popup"
						}
					},
					thumbnail:{
						enable_popup_mouseover:true,
						disable_same_image:false,
						script_allow:"",
						script_insert:""
					},
					popup:{
						origin_type:"center",
						position_type:"absolute",
						time_wait_open:0,
						time_wait_close:0,
						enable_animation:true,
						script_allow:""
					},
					reduced_image:{
						enable_popup:true,
						popup_allow_slcale_less_then:70
					}
				};

				// --------------------------------------------------------------------------------
				// サウンド展開定義
				// --------------------------------------------------------------------------------
				createArrayContainer("expand_sound");

				// 追加
				update(proj.expand_sound,"*",function(obj){
					if(!(obj.name))						obj.name = new Object();
					if(!(obj.name.standard))			obj.name.standard = "";
					if(!(obj.name.locales))				obj.name.locales = new Object();

					if(!(obj.inline))						obj.inline = new Object();
					if(!(obj.inline.disable_same_audio))	obj.inline.disable_same_audio = false;
					if(!(obj.inline.script_allow))			obj.inline.script_allow = "[]";
					if(!(obj.inline.script_insert))			obj.inline.script_insert = "[]";
				});

				// インライン表示
				var obj = addPreset(proj.expand_sound,"inline",null);
				obj.preset = {
					name:{
						standard:"Inline",
						locales:{
							ja:"インライン表示",
							en:"Inline"
						}
					},
					inline:{
						disable_same_audio:true,
						script_allow:"",
						script_insert:""
					}
				};

				// --------------------------------------------------------------------------------
				// ビデオ展開定義
				// --------------------------------------------------------------------------------
				createArrayContainer("expand_video");

				// 追加
				update(proj.expand_video,"*",function(obj){
					if(!(obj.name))						obj.name = new Object();
					if(!(obj.name.standard))			obj.name.standard = "";
					if(!(obj.name.locales))				obj.name.locales = new Object();

					if(!(obj.inline))									obj.inline = new Object();
					if(!(obj.inline.disable_same_video))				obj.inline.disable_same_video = false;
					if(!(obj.inline.script_allow))						obj.inline.script_allow = "[]";
					if(!(obj.inline.script_insert))						obj.inline.script_insert = "[]";
					if(!(obj.video_element))							obj.video_element = new Object();
					if(!(obj.video_element.script_allow))				obj.video_element.script_allow = "[]";
					if(!(obj.youtube))									obj.youtube = new Object();
					if(!(obj.youtube.visible_video))					obj.youtube.visible_video = false;
					if(!(obj.nicovideo))								obj.nicovideo = new Object();
					if(!(obj.nicovideo.visible_video))					obj.nicovideo.visible_video = false;
					if(!(obj.nicovideo.visible_thumbnail_video))		obj.nicovideo.visible_thumbnail_video = false;
					if(!(obj.nicovideo.visible_thumbnail_mylist))		obj.nicovideo.visible_thumbnail_mylist = false;
					if(!(obj.nicovideo.visible_thumbnail_user))			obj.nicovideo.visible_thumbnail_user = false;
					if(!(obj.nicovideo.visible_thumbnail_community))	obj.nicovideo.visible_thumbnail_community = false;
					if(!(obj.nicovideo.visible_thumbnail_live))			obj.nicovideo.visible_thumbnail_live = false;
					if(!(obj.ustream))									obj.ustream = new Object();
					if(!(obj.ustream.visible_video))					obj.ustream.visible_video = false;
					if(!(obj.dailymotion))								obj.dailymotion = new Object();
					if(!(obj.dailymotion.visible_video))				obj.dailymotion.visible_video = false;
					if(!(obj.vimeo))									obj.vimeo = new Object();
					if(!(obj.vimeo.visible_video))						obj.vimeo.visible_video = false;
					if(!(obj.fc2video))									obj.fc2video = new Object();
					if(!(obj.fc2video.visible_video))					obj.fc2video.visible_video = false;
				});

				// インライン表示
				var obj = addPreset(proj.expand_video,"inline",null);
				obj.preset = {
					name:{
						standard:"Inline",
						locales:{
							ja:"インライン表示",
							en:"Inline"
						}
					},
					inline:{
						disable_same_video:true,
						video_max:10,
						script_allow:
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;
		var parent = anchor_element.parentNode;
		if(parent){
			var width = ElementGetClientWidth(parent);

			// 親の幅が小さすぎる場合インライン表示しない
			if(width < 150){
				response({result:false});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		// インライン表示する
		response({result:true});
		return true;
	}.toString() +
"\n]",
						script_insert:""
					},
					video_element:{
						script_allow:""
					},
					youtube:{
						visible_video:true
					},
					nicovideo:{
						visible_video:true,
						visible_thumbnail_video:true,
						visible_thumbnail_mylist:true,
						visible_thumbnail_user:true,
						visible_thumbnail_community:true,
						visible_thumbnail_live:true
					},
					ustream:{
						visible_video_live:true,
						visible_video_record:true
					},
					dailymotion:{
						visible_video:true
					},
					vimeo:{
						visible_video:true
					},
					fc2video:{
						visible_video:true
					}
				};

				// --------------------------------------------------------------------------------
				// インラインフレーム展開定義
				// --------------------------------------------------------------------------------
				createArrayContainer("expand_iframe");

				// 追加
				update(proj.expand_iframe,"*",function(obj){
					if(!(obj.name))						obj.name = new Object();
					if(!(obj.name.standard))			obj.name.standard = "";
					if(!(obj.name.locales))				obj.name.locales = new Object();

					if(!(obj.inline))						obj.inline = new Object();
					if(!(obj.inline.disable_same_iframe))	obj.inline.disable_same_iframe = false;
					if(!(obj.inline.script_allow))			obj.inline.script_allow = "[]";
					if(!(obj.inline.script_insert))			obj.inline.script_insert = "[]";
				});

				// Flash のインライン表示
				var obj = addPreset(proj.expand_iframe,"expand_flash_inline",null);
				obj.preset = {
					name:{
						standard:"Expand Flash Inline",
						locales:{
							ja:"Flash のインライン表示",
							en:"Expand Flash Inline"
						}
					},
					inline:{
						disable_same_iframe:true,
						script_allow:"",
						script_insert:""
					}
				};

				// PDF のインライン表示
				var obj = addPreset(proj.expand_iframe,"expand_pdf_inline","expand_flash_inline");
				obj.preset = {
					name:{
						standard:"Expand PDF Inline",
						locales:{
							ja:"PDF のインライン表示",
							en:"Expand PDF Inline"
						}
					},
					inline:{
						disable_same_iframe:true,
						script_allow:"",
						script_insert:""
					}
				};

				// --------------------------------------------------------------------------------
				// スタイルシート定義
				// --------------------------------------------------------------------------------
				createArrayContainer("style_sheet");

				// 追加
				update(proj.style_sheet,"*",function(obj){
					if(!(obj.name))						obj.name = new Object();
					if(!(obj.name.standard))			obj.name.standard = "";
					if(!(obj.name.locales))				obj.name.locales = new Object();

					if(!(obj.expand_text))						obj.expand_text = new Object();
					if(!(obj.expand_text.inline))				obj.expand_text.inline = "";
					if(!(obj.expand_image))						obj.expand_image = new Object();
					if(!(obj.expand_image.thumbnail))			obj.expand_image.thumbnail = "";
					if(!(obj.expand_image.popup))				obj.expand_image.popup = "";
					if(!(obj.expand_sound))						obj.expand_sound = new Object();
					if(!(obj.expand_sound.inline))				obj.expand_sound.inline = "";
					if(!(obj.expand_video))						obj.expand_video = new Object();
					if(!(obj.expand_video.inline))				obj.expand_video.inline = new Object();

					var inline = obj.expand_video.inline;
					if(!(inline.video_element))					inline.video_element = new Object();
					if(!(inline.video_element.video))			inline.video_element.video = "";
					if(!(inline.youtube))						inline.youtube = new Object();
					if(!(inline.youtube.video))					inline.youtube.video = "";
					if(!(inline.nicovideo))						inline.nicovideo = new Object();
					if(!(inline.nicovideo.video))				inline.nicovideo.video = "";
					if(!(inline.nicovideo.thumbnail_video))		inline.nicovideo.thumbnail_video = "";
					if(!(inline.nicovideo.thumbnail_mylist))	inline.nicovideo.thumbnail_mylist = "";
					if(!(inline.nicovideo.thumbnail_user))		inline.nicovideo.thumbnail_user = "";
					if(!(inline.nicovideo.thumbnail_community))	inline.nicovideo.thumbnail_community = "";
					if(!(inline.nicovideo.thumbnail_live))		inline.nicovideo.thumbnail_live = "";
					if(!(inline.ustream))						inline.ustream = new Object();
					if(!(inline.ustream.video_live))			inline.ustream.video_live = "";
					if(!(inline.ustream.video_record))			inline.ustream.video_record = "";
					if(!(inline.dailymotion))					inline.dailymotion = new Object();
					if(!(inline.dailymotion.video))				inline.dailymotion.video = "";
					if(!(inline.vimeo))							inline.vimeo = new Object();
					if(!(inline.vimeo.video))					inline.vimeo.video = "";
					if(!(inline.fc2video))						inline.fc2video = new Object();
					if(!(inline.fc2video.video))				inline.fc2video.video = "";

					if(!(obj.expand_iframe))					obj.expand_iframe = new Object();
					if(!(obj.expand_iframe.inline))				obj.expand_iframe.inline = "";
				});

				// シンプル
				var obj = addPreset(proj.style_sheet,"simple",null);
				obj.preset = {
					name:{
						standard:"Simple",
						locales:{
							ja:"シンプル",
							en:"Simple"
						}
					},
					expand_text:{
						inline:"margin:2px 0px 2px 0px;"
					},
					expand_image:{
						thumbnail:"margin:2px 0px 2px 0px; background-color:#FFF; border:1px #000 solid;",
						popup:"background-color:#FFF; border:1px #000 solid;"
					},
					expand_sound:{
						inline:"margin:2px 0px 2px 0px;"
					},
					expand_video:{
						inline:{
							video_element:{
								video:"margin:2px 0px 2px 0px; width:720px; height:405px;"
							},
							youtube:{
								video:"margin:2px 0px 2px 0px; width:720px; height:405px; border:0px;"
							},
							nicovideo:{
								video:"margin:2px 0px 2px 0px; width:674px; height:386px; border:0px;",
								thumbnail_video:"margin:2px 0px 2px 0px; width:400px; height:180px; border:0px;",
								thumbnail_mylist:"margin:2px 0px 2px 0px; width:400px; height:180px; border:0px;",
								thumbnail_user:"margin:2px 0px 2px 0px; width:340px; height:160px; border:0px;",
								thumbnail_community:"margin:2px 0px 2px 0px; width:340px; height:180px; border:0px;",
								thumbnail_live:"margin:2px 0px 2px 0px; width:340px; height:180px; border:0px;"
							},
							ustream:{
								video_live:"margin:2px 0px 2px 0px; width:720px; height:405px; border:0px;",
								video_record:"margin:2px 0px 2px 0px; width:720px; height:405px; border:0px;"
							},
							dailymotion:{
								video:"margin:2px 0px 2px 0px; width:720px; height:405px; border:0px;"
							},
							vimeo:{
								video:"margin:2px 0px 2px 0px; width:720px; height:405px; border:0px;"
							},
							fc2video:{
								video:"margin:2px 0px 2px 0px; width:720px; height:405px; border:0px;"
							}
						}
					},
					expand_iframe:{
						inline:"margin:2px 0px 2px 0px; background-color:#FFF; border:1px #000 solid;"
					}
				};

				// デフォルト
				var obj = addPreset(proj.style_sheet,"default","simple");
				obj.preset = {
					name:{
						standard:"Default",
						locales:{
							ja:"デフォルト",
							en:"Default"
						}
					},
					expand_text:{
						inline:"margin:2px 0px 2px 0px; border:1px #000 solid; padding:4px; background-color:#FFF; display:block;"
					},
					expand_image:{
						thumbnail:"margin:2px 0px 2px 0px; border:1px #000 solid; padding:1px; background-color:#FFF;",
						popup:"margin:0px; border:1px #000 solid; padding:1px; background-color:#FFF;"
					},
					expand_sound:{
						inline:"margin:2px 0px 2px 0px; border:1px #000 solid; padding:1px; background-color:#FFF;"
					},
					expand_video:{
						inline:{
							video_element:{
								video:"margin:2px 0px 2px 0px; border:1px #000 solid; background-color:#000; width:720px; height:405px;"
							},
							youtube:{
								video:"margin:2px 0px 2px 0px; border:1px #000 solid; background-color:#000; width:720px; height:405px;"
							},
							nicovideo:{
								video:"margin:2px 0px 2px 0px; border:1px #000 solid; background-color:#000; width:674px; height:386px;",
								thumbnail_video:"margin:2px 0px 2px 0px; border:1px #000 solid; padding:1px; background-color:#FFF; width:400px; height:180px;",
								thumbnail_mylist:"margin:2px 0px 2px 0px; border:1px #000 solid; padding:1px; background-color:#FFF; width:400px; height:180px;",
								thumbnail_user:"margin:2px 0px 2px 0px; border:1px #000 solid; padding:1px; background-color:#FFF; width:340px; height:160px;",
								thumbnail_community:"margin:2px 0px 2px 0px; border:1px #000 solid; padding:1px; background-color:#FFF; width:340px; height:180px;",
								thumbnail_live:"margin:2px 0px 2px 0px; border:1px #000 solid; padding:1px; background-color:#FFF; width:340px; height:180px;"
							},
							ustream:{
								video_live:"margin:2px 0px 2px 0px; border:1px #000 solid; background-color:#000; width:720px; height:405px;",
								video_record:"margin:2px 0px 2px 0px; border:1px #000 solid; background-color:#000; width:720px; height:405px;"
							},
							dailymotion:{
								video:"margin:2px 0px 2px 0px; border:1px #000 solid; background-color:#000; width:720px; height:405px;"
							},
							vimeo:{
								video:"margin:2px 0px 2px 0px; border:1px #000 solid; background-color:#000; width:720px; height:405px;"
							},
							fc2video:{
								video:"margin:2px 0px 2px 0px; border:1px #000 solid; background-color:#000; width:720px; height:405px;"
							}
						}
					},
					expand_iframe:{
						inline:"margin:2px 0px 2px 0px; border:1px #000 solid; padding:1px; background-color:#FFF;"
					}
				};

				// --------------------------------------------------------------------------------
				// 試験運用展開定義
				// --------------------------------------------------------------------------------
				createArrayContainer("experimental");

				// 追加
				update(proj.experimental,"*",function(obj){
					if(!(obj.name))						obj.name = new Object();
					if(!(obj.name.standard))			obj.name.standard = "";
					if(!(obj.name.locales))				obj.name.locales = new Object();
				});

				// --------------------------------------------------------------------------------
				// 言語設定
				// --------------------------------------------------------------------------------
				proj.language = {
					type:-1
				};
			}
			if(exit())	return proj;

			// --------------------------------------------------------------------------------
			// プロジェクト ver.2
			// --------------------------------------------------------------------------------
			if(proj.version < 2){
				// バージョン値
				proj.version = 2;

				// ニコニコ大百科
				var obj = addPreset(proj.expand_bbs,"nicovideo_dictionary","4chan");
				obj.preset = {
					name:{
						standard:"dic.nicovideo.jp",
						locales:{
							ja:"ニコニコ大百科",
							en:"dic.nicovideo.jp"
						}
					},
					enable:true,
					script_allow:"",
					script_callback:"",
					popup:{
						origin_type:"adsorb_top_bottom",
						position_type:"absolute",
						enable_animation:true,
						percent:{x:75,y:90},
						time_wait_open:0,
						time_wait_close:250,
						style_sheet:"padding:20px 10px; border:1px solid #000; background:#FFF; overflow-y:auto; word-wrap:break-word; word-break:break-all;"
					}
				};

			}
			if(exit())	return proj;

			// --------------------------------------------------------------------------------
			// プロジェクト ver.3
			// --------------------------------------------------------------------------------
			if(proj.version < 3){
				// バージョン値
				proj.version = 3;

				// URLマッピング設定 追加
				update(proj.urlmap,"*",function(obj){
					if(!(obj.enable_unsecure))	obj.enable_unsecure = false;
				});

				// スレッド掲示板 追加
				var obj = addPreset(proj.urlmap,"bbs","bbs");
				obj.preset.filter.push("*://unkar.org/r/*/*");

				// unkar.org
				var obj = addPreset(proj.expand_bbs,"unkar","mimizun");
				obj.preset = {
					name:{
						standard:"unkar.org",
						locales:{
							ja:"うんかー",
							en:"unkar.org"
						}
					},
					enable:true,
					script_allow:"",
					script_callback:"",
					popup:{
						origin_type:"adsorb_top_bottom",
						position_type:"absolute",
						enable_animation:true,
						percent:{x:75,y:90},
						time_wait_open:0,
						time_wait_close:250,
						style_sheet:"padding:20px 10px; border:1px solid #000; background:#FFF; overflow-y:auto; word-wrap:break-word; word-break:break-all;"
					}
				};
			}
			if(exit())	return proj;

			// --------------------------------------------------------------------------------
			// プロジェクト ver.4
			// --------------------------------------------------------------------------------
			if(proj.version < 4){
				// バージョン値
				proj.version = 4;

				// --------------------------------------------------------------------------------
				// 基本設定
				// --------------------------------------------------------------------------------
				proj.standard.enable_output_log = false;


				// --------------------------------------------------------------------------------
				// 掲示板設定
				// --------------------------------------------------------------------------------
				// 追加
				update(proj.expand_bbs,"*",function(obj){
					if(!(obj.filter))				obj.filter = new Array();
					if(!(obj.script_initialize))	obj.script_initialize = 
"[\n\t" + 
	function(info,response){
		var work = info.work;

		response({result:true});
		return true;
	}.toString() +
"\n]";
				});

				// 削除
				updatePreset(proj.expand_bbs,"*",function(obj){
					if(obj.script_allow !== undefined)		delete obj.script_allow;
				});

				// ２ちゃんねる掲示板
				update(proj.expand_bbs,"2ch",function(obj){
					obj.filter = [
						{
							pattern:"http://.*\\.2ch\\.net/test/read\\.cgi/.*/[0-9]+",
							flags:{i:true,g:false}
						},{
							pattern:"http://.*\\.machi\\.to/bbs/read\\.cgi/.*/[0-9]+",
							flags:{i:true,g:false}
						},{
							pattern:"http://machibbs\\.net/.*/[0-9]+.html",
							flags:{i:true,g:false}
						},{
							pattern:"http://.*\\.machibbs\\.net/.*/[0-9]+.html",
							flags:{i:true,g:false}
						},{
							pattern:"http://.*\\.bbspink\\.com/test/read\\.cgi/.*/[0-9]+",
							flags:{i:true,g:false}
						},{
							pattern:"http://jbbs\\.livedoor\\.jp/bbs/read.cgi/.*/[0-9]+/[0-9]+",
							flags:{i:true,g:false}
						},{
							pattern:"http://.*\\.kakiko\\.com/test/read\\.cgi/.*/[0-9]+",
							flags:{i:true,g:false}
						},{
							pattern:"http://.*\\.60\\.kg/test/read\\.cgi/.*/[0-9]+",
							flags:{i:true,g:false}
						}
					];
					obj.script_initialize = "";
					obj.script_callback = "";
				});

				// ログ速
				update(proj.expand_bbs,"logsoku",function(obj){
					obj.filter = [
						{
							pattern:"http://logsoku\\.com/thread/.*\\.2ch\\.net/.*/[0-9]+",
							flags:{i:true,g:false}
						},{
							pattern:"http://.*\\.atchs\\.jp/test/read\\.cgi/.*/[0-9]+",
							flags:{i:true,g:false}
						}
					];
					obj.script_initialize = "";
					obj.script_callback = "";
				});

				// みみずん検索
				update(proj.expand_bbs,"mimizun",function(obj){
					obj.filter = [
						{
							pattern:"http://mimizun\\.com/log/2ch/.*/[0-9]+",
							flags:{i:true,g:false}
						},{
							pattern:"http://mimizun\\.com/log/machi/.*/[0-9]+",
							flags:{i:true,g:false}
						}
					];
					obj.script_initialize = "";
					obj.script_callback = "";
				});

				// unkar.org
				update(proj.expand_bbs,"unkar",function(obj){
					obj.filter = [
						{
							pattern:"http://unkar\\.org/r/.*/[0-9]+",
							flags:{i:true,g:false}
						}
					];
					obj.script_initialize = "";
					obj.script_callback = "";
				});

				// ふたば☆ちゃんねる
				update(proj.expand_bbs,"2chan",function(obj){
					obj.filter = [
						{
							pattern:"http://.*?\\.2chan\\.net/.*/",
							flags:{i:true,g:false}
						}
					];
				});

				// 4chan.org
				update(proj.expand_bbs,"4chan",function(obj){
					obj.filter = [
						{
							pattern:"http://boards\\.4chan\\.org/.*/",
							flags:{i:true,g:false}
						}
					];
					obj.script_callback = "";
				});

				// ニコニコ大百科
				update(proj.expand_bbs,"nicovideo_dictionary",function(obj){
					obj.filter = [
						{
							pattern:"http://dic\\.nicovideo\\.jp/b/a/.+",
							flags:{i:true,g:false}
						},{
							pattern:"http://dic\\.nicovideo\\.jp/a/.+",
							flags:{i:true,g:false}
						}

					];
					obj.script_initialize = "";
					obj.script_callback = "";
				});

				// --------------------------------------------------------------------------------
				// 「ハイパーリンク置換定義」を「アンカー置換定義」に変更
				// --------------------------------------------------------------------------------
				update(proj.urlmap,"*",function(obj){
					obj.replacement_to_anchor = obj.replacement_to_link;
					delete obj.replacement_to_link;
				});
				proj.replacement_to_anchor = proj.replacement_to_link;
				delete proj.replacement_to_link;


				// --------------------------------------------------------------------------------
				// アクセスブロック定義
				// --------------------------------------------------------------------------------
				var obj = addPreset(proj.access_block,"opera_extension",null);
				obj.preset = {
					name:{
						standard:"For Opera Extension",
						locales:{
							ja:"Opera 拡張機能用",
							en:"For Opera Extension"
						}
					},
					filter:[]
				};


				// --------------------------------------------------------------------------------
				// エレメント置換定義
				// --------------------------------------------------------------------------------
				// 連続するBRタグを削除
				var obj = addPreset(proj.replacement_to_element,"delete_br_tags","meiryo_font");
				obj.preset = {
					name:{
						standard:"Delete BR Tags Continuous",
						locales:{
							ja:"連続するBRタグを削除",
							en:"Delete BR Tags Continuous"
						}
					},
					script:
"[\n\t" + 
	function(info,response){
		var element = info.element;

		if(element.tagName.toLowerCase() != "br"){
			return false;
		}

		// 最大連続改行数
		var allow_max = 2;

		var count = 0;
		var e = element.previousSibling;
		while(true){
			if(!e)	break;

			var node_type = e.nodeType;
			if(node_type == 1){
				if(e.tagName.toLowerCase() != "br"){
					break;
				}
				count++;
				if(count >= allow_max){
					var revise_scroll = new DocumentReviseScroll();
					revise_scroll.executeRemoveElementBefore(element);
					DomNodeRemove(element);
					revise_scroll.executeRemoveElementAfter(element);
					break;
				}
			}else if(node_type == 3){
				if(!ElementGetTextContent(e).match(new RegExp("^[ \r\n\t　]*$"))){
					break;
				}
			}



			e = e.previousSibling;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]"
				};


				// --------------------------------------------------------------------------------
				// アンカー置換定義
				// --------------------------------------------------------------------------------
				// イメージ検索用ポップアップ無効化
				var obj = addPreset(proj.replacement_to_anchor,"disable_popup_image_search","direct_link_realtime_search");
				obj.preset = {
					name:{
						standard:"Disable Popup (image search)",
						locales:{
							ja:"ポップアップを無効化（イメージ検索用）",
							en:"Disable Popup (image search)"
						}
					},
					script:""
				};

				// 「イメージ検索用」を破棄
				removePreset("replacement_to_anchor","direct_link_image_search");

				// ツイッター用
				var obj = addPreset(proj.replacement_to_anchor,"direct_link_twitter","direct_link_realtime_search");
				obj.preset = {
					name:{
						standard:"Direct Link (twitter.com)",
						locales:{
							ja:"直リンクに変更（ツイッター用）",
							en:"Direct Link (twitter.com)"
						}
					},
					script:""
				};


				// --------------------------------------------------------------------------------
				// ハイパーリンク置換定義
				// --------------------------------------------------------------------------------
				createArrayContainer("replacement_to_link");

				// イメージ検索用
				var obj = addPreset(proj.replacement_to_link,"direct_link_image_search",null);
				obj.preset = {
					name:{
						standard:"Direct Link (image search)",
						locales:{
							ja:"直リンク（イメージ検索用）",
							en:"Direct Link (image search)"
						}
					},
					filter:[
						{
							name:{
								standard:"Google",
								locales:{
									ja:"Google 画像検索",
									en:"Google"
								}
							},
							filter:[
								"*://*.google.*/imgres?*",
								"*://*.google.co.*/imgres?*",
								"*://*.google.com.*/imgres?*"
							],
							enable_reflect_to_anchor:false,
							script:""
						},{
							name:{
								standard:"Yahoo Image Search",
								locales:{
									ja:"Yahoo Image Search",
									en:"Yahoo Image Search"
								}
							},
							filter:[
								"*://images.search.yahoo.com/images/view;*"
							],
							enable_reflect_to_anchor:false,
							script:""
						},{
							name:{
								standard:"Yahoo! JAPAN",
								locales:{
									ja:"Yahoo! JAPAN 画像検索",
									en:"Yahoo! JAPAN"
								}
							},
							filter:[
								"*://ord.yahoo.co.jp/o/image/*"
							],
							enable_reflect_to_anchor:false,
							script:""
						},{
							name:{
								standard:"Bing",
								locales:{
									ja:"Bing 画像検索",
									en:"Bing"
								}
							},
							filter:[
								"*://www.bing.com/images/search?*"
							],
							enable_reflect_to_anchor:false,
							script:""
						}
					]
				};

				// 直リンク（汎用）
				var obj = addPreset(proj.replacement_to_link,"direct_link_generic","direct_link_image_search");
				obj.preset = {
					name:{
						standard:"Direct Link (generic)",
						locales:{
							ja:"直リンク（汎用）",
							en:"Direct Link (generic)"
						}
					},
					filter:[
						{
							name:{
								standard:"OGP \"og:image\"",
								locales:{
									ja:"OGP \"og:image\"",
									en:"OGP \"og:image\""
								}
							},
							filter:[
								"*://instagr.am/p/*",
								"*://www.flickr.com/photos/*/*",
								"*://lockerz.com/s/*",
								"*://pics.lockerz.com/s/*"
							],
							enable_reflect_to_anchor:false,
							script:""
						},{
							name:{
								standard:"Twitpic",
								locales:{
									ja:"Twitpic",
									en:"Twitpic"
								}
							},
							filter:[
								"*://twitpic.com/*"
							],
							enable_reflect_to_anchor:false,
							script:""
						},{
							name:{
								standard:"Twitter Photo",
								locales:{
									ja:"Twitter Photo",
									en:"Twitter Photo"
								}
							},
							filter:[
								"*://pic.twitter.com/*",
								"*://twitter.com/*/status/*/photo/*"
							],
							enable_reflect_to_anchor:false,
							script:
"[\n\t" + 
	function (info,response){
		var anchor_element = info.anchor_element;

		// # があれば終了
		if(anchor_element.href.indexOf("#") >= 0){
			response({result:false});
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		var anchor_element = info.anchor_element;

		// ローダーオブジェクトを作成
		var loader = new Loader();

		// 成功
		loader.onload = function(str){
			if(str.match(new RegExp("<img[ ].*?src=\"(https:\/\/pbs\\.twimg\\.com\/media\/.*?)\"","i"))){
				response({result:true,url:RegExp.$1});
				return;
			}
			response({result:false});
		};

		// 失敗
		loader.onerror = function(){
			response({result:false});
		};

		// テキストの読み込み
		loader.setMethod("GET");
		loader.setURL(anchor_element.href);
		loader.loadText();

		return true;
	}.toString() +
"\n]"
						},{
							name:{
								standard:"Facebook Photo",
								locales:{
									ja:"Facebook Photo",
									en:"Facebook Photo"
								}
							},
							filter:[
								"*://www.facebook.com/photo.php?*"
							],
							enable_reflect_to_anchor:false,
							script:""
						},{
							name:{
								standard:"Tumblr",
								locales:{
									ja:"Tumblr",
									en:"Tumblr"
								}
							},
							filter:[
								"*://*.tumblr.com/post/*"
							],
							enable_reflect_to_anchor:false,
							script:""
						},{
							name:{
								standard:"Photozou Photo",
								locales:{
									ja:"フォト蔵",
									en:"Photozou Photo"
								}
							},
							filter:[
								"*://photozou.jp/photo/show/*/*"
							],
							enable_reflect_to_anchor:false,
							script:""
						},{
							name:{
								standard:"Twipple Photo",
								locales:{
									ja:"ついっぷる",
									en:"Twipple Photo"
								}
							},
							filter:[
								"*://p.twipple.jp/*"
							],
							enable_reflect_to_anchor:false,
							script:""
						},{
							name:{
								standard:"NICONICO SEIGA (must log in)",
								locales:{
									ja:"ニコニコ静画 (ログインが必要)",
									en:"NICONICO SEIGA (must log in)"
								}
							},
							filter:[
								"*://seiga.nicovideo.jp/seiga/im*",
								"*://nico.ms/im*"
							],
							enable_reflect_to_anchor:false,
							script:""
						},{
							name:{
								standard:"pixiv (must referer)",
								locales:{
									ja:"ピクシブ (リファラが必要)",
									en:"pixiv (must referer)"
								}
							},
							filter:[
								"*://www.pixiv.net/member_illust.php?*illust_id*"
							],
							enable_reflect_to_anchor:false,
							script:""
						}
					]
				};

				// --------------------------------------------------------------------------------
				// リファラ置換定義
				// --------------------------------------------------------------------------------
				// 追加
				update(proj.replacement_to_referer,"*",function(obj){
					if(!(obj.filter))	obj.filter = new Array();
				});

				// 削除
				updatePreset(proj.replacement_to_referer,"*",function(obj){
					if(obj.script !== undefined)		delete obj.script;
				});

				// 空文字列に変更
				update(proj.replacement_to_referer,"replacement_empty",function(obj){
					obj.filter = [
						{
							name:{
								standard:"Empty",
								locales:{
									ja:"空文字列",
									en:"Empty"
								}
							},
							filter:[
								"*://*"
							],
							send_referer:{
								type:"custom",
								custom:"",
								regexp:{
									pattern:"",
									flags:{i:false,g:false}
								},
								replacement:""
							}
						}
					];
				});

				// リンク先のURLに変更
				var obj = addPreset(proj.replacement_to_referer,"replacement_link_url","replacement_link");
				obj.preset = {
					name:{
						standard:"Replace Link URL",
						locales:{
							ja:"リンク先のURLに変更",
							en:"Replace Link URL"
						}
					},
					filter:[
						{
							name:{
								standard:"Link URL",
								locales:{
									ja:"リンク先のURL",
									en:"Link URL"
								}
							},
							filter:[
								"*://*"
							],
							send_referer:{
								type:"link_url",
								custom:"",
								regexp:{
									pattern:"",
									flags:{i:false,g:false}
								},
								replacement:""
							}
						}
					]
				};

				// リンク先のディレクトリに変更
				var obj = addPreset(proj.replacement_to_referer,"replacement_link_directory","replacement_link");
				obj.preset = {
					name:{
						standard:"Replace Link Directory",
						locales:{
							ja:"リンク先のカレントディレクトリに変更",
							en:"Replace Link Directory"
						}
					},
					filter:[
						{
							name:{
								standard:"Link Directory",
								locales:{
									ja:"リンク先のディレクトリ",
									en:"Link Directory"
								}
							},
							filter:[
								"*://*"
							],
							send_referer:{
								type:"link_url",
								custom:"",
								regexp:{
									pattern:"^(http|https|ftp)(:\\/\\/.*\\/).*",
									flags:{i:true,g:false}
								},
								replacement:"\\1\\2"
							}
						}
					]
				};

				// リンク先のドメインに変更
				var obj = addPreset(proj.replacement_to_referer,"replacement_link_domain","replacement_link_directory");
				obj.preset = {
					name:{
						standard:"Replace Link Domain",
						locales:{
							ja:"リンク先のドメインに変更",
							en:"Replace Link Domain"
						}
					},
					filter:[
						{
							name:{
								standard:"Link Domain",
								locales:{
									ja:"リンク先のドメイン",
									en:"Link Domain"
								}
							},
							filter:[
								"*://*"
							],
							send_referer:{
								type:"link_url",
								custom:"",
								regexp:{
									pattern:"^(http|https|ftp)(:\\/\\/.*?\\/).*",
									flags:{i:true,g:false}
								},
								replacement:"\\1\\2"
							}
						}
					]
				};

				// 古い「リンク先のURL」を破棄
				removePreset("replacement_to_referer","replacement_link");


				// --------------------------------------------------------------------------------
				// ユーザーエージェント置換定義
				// --------------------------------------------------------------------------------
				// 追加
				update(proj.replacement_to_useragent,"*",function(obj){
					if(!(obj.filter))	obj.filter = new Array();
				});

				// 削除
				updatePreset(proj.replacement_to_useragent,"*",function(obj){
					if(obj.script !== undefined)		delete obj.script;
				});

				// iPhone4
				update(proj.replacement_to_useragent,"iphone_4",function(obj){
					obj.filter = [
						{
							name:{
								standard:"iPhone4",
								locales:{
									ja:"iPhone4",
									en:"iPhone4"
								}
							},
							filter:[
								"*://*"
							],
							send_useragent:{
								custom:"Mozilla/5.0 (iPhone; U; CPU iPhone OS 4_0 like Mac OS X; en-us) AppleWebKit/532.9 (KHTML, like Gecko) Version/4.0.5 Mobile/8A293 Safari/6531.22.7"
							}
						}
					];
				});

				// Android 2.1
				update(proj.replacement_to_useragent,"android_2_1",function(obj){
					obj.filter = [
						{
							name:{
								standard:"Android 2.1",
								locales:{
									ja:"Android 2.1",
									en:"Android 2.1"
								}
							},
							filter:[
								"*://*"
							],
							send_useragent:{
								custom:"Mozilla/5.0 (Linux; U; Android 2.1-update1; ja-jp; XXX Build/RA201) AppleWebKit/530.17 (KHTML, like Gecko) Version/4.0 Mobile Safari/530.17"
							}
						}
					];
				});

				// DoCoMo/2.0
				update(proj.replacement_to_useragent,"docomo_2_0",function(obj){
					obj.filter = [
						{
							name:{
								standard:"DoCoMo / 2.0",
								locales:{
									ja:"DoCoMo / 2.0",
									en:"DoCoMo / 2.0"
								}
							},
							filter:[
								"*://*"
							],
							send_useragent:{
								custom:"DoCoMo/2.0 XXX(c100;TB)"
							}
						}
					];
				});


				// --------------------------------------------------------------------------------
				// 短縮 URL 展開
				// --------------------------------------------------------------------------------
				// 詳細
				var obj = getPreset(proj.expand_short_url,"detail");
				obj.filter.splice(7,0,
					"http://pic.twitter.com/*",
					"http://tmblr.co/*"
				);


				// --------------------------------------------------------------------------------
				// テキスト展開定義
				// --------------------------------------------------------------------------------
				// インライン表示
				var obj = addPreset(proj.expand_text,"inline",null);
				obj.preset.inline.script_allow = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;
		var parent = anchor_element.parentNode;
		if(parent){
			var width = ElementGetClientWidth(parent);

			// 親の幅が小さすぎる場合インライン表示しない
			if(width < 50){
				response({result:false});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var anchor_element = info.anchor_element;
		var url = info.url;

		var ext_list = [
			"txt"
		];

		var i;
		var num = ext_list.length;
		for(i=0;i<num;i++){
			// テキストの拡張子である場合、インライン表示を試みる
			if(url.match(new RegExp("^.*/.+\\." + ext_list[i] + "($|[#?:].*$)","i"))){
				response({result:true});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		// インライン表示しない
		response({result:false});
		return true;
	}.toString() +
"\n]";


				// --------------------------------------------------------------------------------
				// イメージ展開定義
				// --------------------------------------------------------------------------------
				// サムネイル表示
				var obj = addPreset(proj.expand_image,"thumbnail",null);
				obj.preset.thumbnail.script_allow = "";

				// ポップアップ表示
				var obj = addPreset(proj.expand_image,"popup",null);
				obj.preset.popup.script_allow = "";


				// --------------------------------------------------------------------------------
				// サウンド展開定義
				// --------------------------------------------------------------------------------
				// インライン表示
				var obj = addPreset(proj.expand_sound,"inline",null);
				obj.preset.inline.script_allow = "";


				// --------------------------------------------------------------------------------
				// ビデオ展開定義
				// --------------------------------------------------------------------------------
				// 追加
				update(proj.expand_video,"*",function(obj){
					if(!(obj.nicovideo.visible_thumbnail_seiga))	obj.nicovideo.visible_thumbnail_seiga = true;
					if(!(obj.liveleak))								obj.liveleak = new Object();
					if(!(obj.liveleak.visible_video))				obj.liveleak.visible_video = true;
				});

				// インライン表示
				var obj = addPreset(proj.expand_video,"inline",null);
				obj.preset.video_element.script_allow = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;
		var url = info.url;

		var ext_list = [
			"mp4",
			"webm",
			"avi",
			"m4v",
			"ogv",
			"mpg",
			"mpeg"
		];

		var i;
		var num = ext_list.length;
		for(i=0;i<num;i++){
			// URL が動画の拡張子である場合、インライン表示を試みる
			if(url.match(new RegExp("^.*/.+\\." + ext_list[i] + "($|[#?:].*$)","i"))){
				response({result:true});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		// インライン表示しない
		response({result:false});
		return true;
	}.toString() +
"\n]";


				// --------------------------------------------------------------------------------
				// インラインフレーム展開定義
				// --------------------------------------------------------------------------------
				// Flash のインライン表示
				var obj = addPreset(proj.expand_iframe,"expand_flash_inline",null);
				obj.preset.inline.script_allow = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;
		var parent = anchor_element.parentNode;
		if(parent){
			var width = ElementGetClientWidth(parent);

			// 親の幅が小さすぎる場合インライン表示しない
			if(width < 50){
				response({result:false});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var anchor_element = info.anchor_element;
		var url = info.url;

		var ext_list = [
			"swf"
		];

		var i;
		var num = ext_list.length;
		for(i=0;i<num;i++){
			// Flash の拡張子である場合、インライン表示を試みる
			if(url.match(new RegExp("^.*/.+\\." + ext_list[i] + "($|[#?:].*$)","i"))){
				response({result:true});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		// インライン表示しない
		response({result:false});
		return true;
	}.toString() +
"\n]";

				// PDF のインライン表示
				var obj = addPreset(proj.expand_iframe,"expand_pdf_inline",null);
				obj.preset.inline.script_allow = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;
		var parent = anchor_element.parentNode;
		if(parent){
			var width = ElementGetClientWidth(parent);

			// 親の幅が小さすぎる場合インライン表示しない
			if(width < 50){
				response({result:false});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var anchor_element = info.anchor_element;
		var url = info.url;

		var ext_list = [
			"pdf"
		];

		var i;
		var num = ext_list.length;
		for(i=0;i<num;i++){
			// PDF の拡張子である場合、インライン表示を試みる
			if(url.match(new RegExp("^.*/.+\\." + ext_list[i] + "($|[#?:].*$)","i"))){
				response({result:true});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		// インライン表示しない
		response({result:false});
		return true;
	}.toString() +
"\n]";


				// --------------------------------------------------------------------------------
				// スタイルシート定義
				// --------------------------------------------------------------------------------
				// 追加
				update(proj.style_sheet,"*",function(obj){
					var inline = obj.expand_video.inline;
					if(!(inline.nicovideo.thumbnail_seiga))	inline.nicovideo.thumbnail_seiga = "";
					if(!(inline.liveleak))					inline.liveleak = new Object();
					if(!(inline.liveleak.video))			inline.liveleak.video = "";
				});

				// デフォルト
				update(proj.style_sheet,"default",function(obj){
					obj.expand_video.inline.nicovideo.thumbnail_seiga = "margin:2px 0px 2px 0px; border:1px #000 solid; padding:1px; background-color:#FFF; width:312px; height:176px;";
					obj.expand_video.inline.liveleak.video = "margin:2px 0px 2px 0px; border:1px #000 solid; background-color:#000; width:640px; height:360px;";
				});

				// シンプル
				update(proj.style_sheet,"simple",function(obj){
					obj.expand_video.inline.nicovideo.thumbnail_seiga = "margin:2px 0px 2px 0px; width:312px; height:176px; border:0px;";
					obj.expand_video.inline.liveleak.video = "margin:2px 0px 2px 0px; width:640px; height:360px; border:0px;";
				});


				// --------------------------------------------------------------------------------
				// URLマッピング設定
				// --------------------------------------------------------------------------------
				// 追加
				update(proj.urlmap,"*",function(obj){
					if(!(obj.replacement_to_link))		obj.replacement_to_link = new Object();

					var replacement_to_link = obj.replacement_to_link;
					if(!(replacement_to_link.enable))	replacement_to_link.enable = false;
					if(!(replacement_to_link.id))		replacement_to_link.id = "";
				});

				// twitter
				var preset = getPreset(proj.urlmap,"twitter");
				preset.replacement_to_anchor = {enable:true,id:"direct_link_twitter"};
				preset.replacement_to_link = {enable:true,id:"direct_link_generic"};
				preset.replacement_to_referer = {enable:true,id:"replacement_link_url"};

				// スレッド掲示板
				var preset = getPreset(proj.urlmap,"bbs");
				preset.replacement_to_link = {enable:true,id:"direct_link_generic"};
				preset.replacement_to_referer = {enable:true,id:"replacement_link_url"};

				// 画像掲示板
				var preset = getPreset(proj.urlmap,"image_bbs");
				preset.replacement_to_link = {enable:true,id:"direct_link_generic"};
				preset.replacement_to_referer = {enable:true,id:"replacement_link_url"};

				// 画像検索サイト
				var obj = addPreset(proj.urlmap,"image_search",null);
				obj.preset.replacement_to_referer = {enable:true,id:"replacement_link_url"};
				obj.preset.replacement_to_anchor = {enable:true,id:"disable_popup_image_search"};
				obj.preset.replacement_to_link = {enable:true,id:"direct_link_image_search"};
				obj.preset.filter = [
					"*://*.google.at/search?*tbm=isch*",
					"*://*.google.be/search?*tbm=isch*",
					"*://*.google.ca/search?*tbm=isch*",
					"*://*.google.ch/search?*tbm=isch*",
					"*://*.google.de/search?*tbm=isch*",
					"*://*.google.es/search?*tbm=isch*",
					"*://*.google.fr/search?*tbm=isch*",
					"*://*.google.it/search?*tbm=isch*",
					"*://*.google.nl/search?*tbm=isch*",
					"*://*.google.no/search?*tbm=isch*",
					"*://*.google.pl/search?*tbm=isch*",
					"*://*.google.ru/search?*tbm=isch*",
					"*://*.google.se/search?*tbm=isch*",
					"*://*.google.co.id/search?*tbm=isch*",
					"*://*.google.co.in/search?*tbm=isch*",
					"*://*.google.co.jp/search?*tbm=isch*",
					"*://*.google.co.th/search?*tbm=isch*",
					"*://*.google.co.uk/search?*tbm=isch*",
					"*://*.google.co.za/search?*tbm=isch*",
					"*://*.google.com/search?*tbm=isch*",
					"*://*.google.com.ar/search?*tbm=isch*",
					"*://*.google.com.au/search?*tbm=isch*",
					"*://*.google.com.br/search?*tbm=isch*",
					"*://*.google.com.mx/search?*tbm=isch*",
					"*://*.google.com.sa/search?*tbm=isch*",
					"*://*.google.com.tr/search?*tbm=isch*",
					"*://*.google.com.tw/search?*tbm=isch*",
					"*://www.google.at/images?*",
					"*://www.google.be/images?*",
					"*://www.google.ca/images?*",
					"*://www.google.ch/images?*",
					"*://www.google.de/images?*",
					"*://www.google.es/images?*",
					"*://www.google.fr/images?*",
					"*://www.google.it/images?*",
					"*://www.google.nl/images?*",
					"*://www.google.no/images?*",
					"*://www.google.pl/images?*",
					"*://www.google.ru/images?*",
					"*://www.google.se/images?*",
					"*://www.google.co.id/images?*",
					"*://www.google.co.in/images?*",
					"*://www.google.co.jp/images?*",
					"*://www.google.co.th/images?*",
					"*://www.google.co.uk/images?*",
					"*://www.google.co.za/images?*",
					"*://www.google.com/images?*",
					"*://www.google.com.ar/images?*",
					"*://www.google.com.au/images?*",
					"*://www.google.com.br/images?*",
					"*://www.google.com.mx/images?*",
					"*://www.google.com.sa/images?*",
					"*://www.google.com.tr/images?*",
					"*://www.google.com.tw/images?*",
					"*://images.search.yahoo.com/search/images*",
					"*://image.search.yahoo.co.jp/search?*",
					"*://www.bing.com/images/search?*"
				];

			}
			if(exit())	return proj;

			// --------------------------------------------------------------------------------
			// プロジェクト ver.5
			// --------------------------------------------------------------------------------
			if(proj.version < 5){
				// バージョン値
				proj.version = 5;

				// --------------------------------------------------------------------------------
				// テキスト置換定義
				// --------------------------------------------------------------------------------
				// 空白とタブを可視化
				var obj = addPreset(proj.replacement_to_text,"visualize_space_and_tab",null);
				obj.preset = {
					name:{
						standard:"Visualize spaces and tabs",
						locales:{
							ja:"空白とタブを可視化",
							en:"Visualize spaces and tabs"
						}
					},
					script:
"[\n\t" + 
	function(info,response){
		var text_node = info.text_node;

		// 透明度
		var alpha = 0.1;

		while(text_node){

			// テキストを取得
			var str = DomNodeGetNodeValue(text_node);
			if(!str){
				return false;
			}

			if(str.match(/^( |　|\t|\n|\r)+$/)){
				break;
			}

			// 空白を調べる
			var r = new RegExp("( |　|\t)","i");
			var match = str.match(r);
			if(match){
				// 左側のテキスト
				DomNodeSetNodeValue(text_node,RegExp.leftContext);

				// pre 作成
				var element = DocumentCreateElement('pre');
				element.style.display = "inline";
				switch(match[1]){
					case " ":	element.style.backgroundColor = "#f00";	break;
					case "　":	element.style.backgroundColor = "#0f0";	break;
					case "\t":	element.style.backgroundColor = "#00f";	break;
				}
				element.style.opacity = alpha;
				DomNodeInsertAfter(element,text_node);

				// テキスト作成
				var text = DocumentCreateText(match[1]);
				DomNodeSetCompletedReplacementToText(text);
				element.appendChild(text);

				// 右側のテキスト
				var text = DocumentCreateText('text');
				DomNodeSetNodeValue(text,RegExp.rightContext);
				DomNodeInsertAfter(text,element);

				text_node = text;
				continue;
			}

			break;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]"
				};

				// --------------------------------------------------------------------------------
				// アンカー置換定義
				// --------------------------------------------------------------------------------
				// 2ch.net 用
				var preset = getPreset(proj.replacement_to_anchor,"direct_link_bbs");
				preset.script = "";

				// 検索用
				var preset = getPreset(proj.replacement_to_anchor,"direct_link_search");
				preset.script = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;
		var r;

		// Google 検索
		if(anchor_element.onmousedown){
			if(anchor_element.onmousedown.toString().match(/return rwt\(this,/)){
				anchor_element.onmousedown = null;
			}
		}

		// Yahoo! JAPAN
		if(anchor_element.onmousedown){
			if(anchor_element.onmousedown.toString().match(/return lswap\(this/)){
				anchor_element.onmousedown = null;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var anchor_element = info.anchor_element;

		// Google 検索
		var url = anchor_element.href;
		var r = new RegExp("^(http|https)://www\\.google\\.(com|co\\.jp)/url[?].*","i");
		if(url.match(r)){
			// クエリを取得
			var query = StringGetQuery(url);
			if(query.url){
				anchor_element.href = unescape(query.url);
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var anchor_element = info.anchor_element;

		// Yahoo! JAPAN 検索
		var url = anchor_element.href;
		var r = new RegExp("^(http|https)://wrs\\.search\\.yahoo\\.co\\.jp/_ylt=.*[/][*][*](.*)$","i");
		if(url.match(r)){
			anchor_element.href = unescape(RegExp.$2);
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]";

				// リアルタイム検索用
				var preset = getPreset(proj.replacement_to_anchor,"direct_link_realtime_search");
				preset.script = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		// Yahoo! JAPAN リアルタイム検索
		var url = anchor_element.href;
		var r = new RegExp("^(http|https)://ord\\.yahoo\\.co\\.jp/o/realtime/.*[/][*][-](.*)$","i");
		if(url.match(r)){
			anchor_element.href = unescape(RegExp.$2);
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]";

				// ツイッター用
				var preset = getPreset(proj.replacement_to_anchor,"direct_link_twitter");
				preset.script = "";

				// イメージ検索用ポップアップ無効化
				var preset = getPreset(proj.replacement_to_anchor,"disable_popup_image_search");
				preset.script = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		// Google 画像検索
		var url = anchor_element.href;
		var r = new RegExp("^(http|https)://.*?\\.google\\.(at|be|ca|ch|de|es|fr|it|nl|no|pl|ru|se|co\\.(id|in|jp|th|uk|za)|com|com\\.(ar|au|br|mx|sa|tr|tw))/imgres[?].*","i");
		if(url.match(r)){
			// ポップアップ要素を外す
			var node = anchor_element;
			while(true){
				if(!node)	break;
				if(node.id == "rg_h"){
					DomNodeRemove(node);
					response({});
					return true;
				}
				node = node.parentNode;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var anchor_element = info.anchor_element;

		// Yahoo Image Search
		var url = anchor_element.href;
		var r = new RegExp("(image|images)\\.search\\.yahoo\\.com/images/view;.*","i");
		if(url.match(r)){
			// ポップアップ要素を非表示
			var node = anchor_element;
			while(true){
				if(!node)	break;
				if(node.id == "ihover-node-cont"){
					node.style.display = "none";
					response({});
					return true;
				}
				node = node.parentNode;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var anchor_element = info.anchor_element;

		// Bing 画像検索
		var url = anchor_element.href;
		var r = new RegExp("^(http|https)://www\\.bing\\.com/images/search[?].*","i");
		if(url.match(r)){
			// ポップアップ要素を非表示
			var node = anchor_element;
			while(true){
				if(!node)	break;
				if(node.id == "sg_hid"){
					node.style.display = "none";
					response({});
					return true;
				}
				node = node.parentNode;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var anchor_element = info.anchor_element;

		// AOL Image Search
		var url = anchor_element.href;
		var r = new RegExp("^http://search\\.aol\\..+?/aol/imageDetails[?].*","i");
		if(url.match(r)){
			// ポップアップ要素を非表示
			var node = anchor_element;
			while(true){
				if(!node)	break;
				if(node.className == "hover"){
					node.style.display = "none";
					response({});
					return true;
				}
				node = node.parentNode;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var anchor_element = info.anchor_element;

		// Baidu Image Search
		var url = anchor_element.href;
		var r = new RegExp("^http://image\\.baidu\\.com/i[?].*","i");
		if(url.match(r)){
			// ポップアップ要素を外す
			var node = anchor_element;
			while(true){
				if(!node)	break;
				if(node.id == "imgDetail"){
					DomNodeRemove(node);
					response({});
					return true;
				}
				node = node.parentNode;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var anchor_element = info.anchor_element;

		// NAVER Image Search
		var url = anchor_element.href;
		var r = new RegExp("http://imagesearch\\.naver\\.com/search.naver[?]","i");
		if(url.match(r)){
			// ポップアップ要素を外す
			var node = anchor_element;
			while(true){
				if(!node)	break;
				if(node.className == "zoom_imsch _infolayer"){
					DomNodeRemove(node);
					response({});
					return true;
				}
				node = node.parentNode;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]";

				// --------------------------------------------------------------------------------
				// ハイパーリンク置換定義
				// --------------------------------------------------------------------------------
				// 直リンク（汎用）
				updatePreset(proj.replacement_to_link,"direct_link_generic",function(obj){
					obj.filter[0].filter.splice(0,0,"*://instagram.com/p/*");
					obj.filter.splice(1,0,{
						name:{
							standard:"OGP \"twitter:*\"",
							locales:{
								ja:"OGP \"twitter:*\"",
								en:"OGP \"twitter:*\""
							}
						},
						filter:[],
						enable_reflect_to_anchor:false,
						script:""
					});
				});

				// イメージ検索用
				updatePreset(proj.replacement_to_link,"direct_link_image_search",function(obj){

					obj.filter[1].filter.push("*://*.images.search.yahoo.com/images/view;*");
					obj.filter[1].filter.push("*://*.image.search.yahoo.com/images/view;*");
					obj.filter[1].script = "";

					obj.filter.splice(3,0,{
						name:{
							standard:"yahoo.cn",
							locales:{
								ja:"yahoo.cn",
								en:"yahoo.cn"
							}
						},
						filter:[
							"http://image.yahoo.cn/view?*"
						],
						enable_reflect_to_anchor:false,
						script:""
					});

					obj.filter.push({
						name:{
							standard:"Ask.com",
							locales:{
								ja:"Ask 画像検索",
								en:"Ask.com"
							}
						},
						filter:[
							"*://*.ask.com/fr?*"
						],
						enable_reflect_to_anchor:false,
						script:""
					});

					obj.filter.push({
						name:{
							standard:"AOL Image Search",
							locales:{
								ja:"AOL 画像検索",
								en:"AOL Image Search"
							}
						},
						filter:[
							"*://search.aol.*/aol/imageDetails?*"
						],
						enable_reflect_to_anchor:false,
						script:""
					});

					obj.filter.push({
						name:{
							standard:"goo",
							locales:{
								ja:"goo 画像検索",
								en:"goo"
							}
						},
						filter:[
							"*://*bsearch.goo.ne.jp/image_detail.php?*DOC_ID=*",
							"*://*bsearch.goo.ne.jp/similarity.php?*DOC_ID=*",
							"*://*bsearch.goo.ne.jp/imgdt.php?*DOC_ID=*"
						],
						enable_reflect_to_anchor:false,
						script:""
					});

					obj.filter.push({
						name:{
							standard:"Baidu",
							locales:{
								ja:"百度",
								en:"Baidu"
							}
						},
						filter:[
							"http://image.baidu.com/i*"
						],
						enable_reflect_to_anchor:false,
						script:""
					});

					obj.filter.push({
						name:{
							standard:"Baidu.jp",
							locales:{
								ja:"Baidu.jp",
								en:"Baidu.jp"
							}
						},
						filter:[
							"http://image.baidu.jp/*baiduimagedetail*di=*"
						],
						enable_reflect_to_anchor:false,
						script:""
					});

					obj.filter.push({
						name:{
							standard:"NAVER",
							locales:{
								ja:"NAVER 画像検索",
								en:"NAVER"
							}
						},
						filter:[
							"http://imagesearch.naver.com/search*",
							"http://image.search.naver.com/search*"
						],
						enable_reflect_to_anchor:false,
						script:""
					});

					obj.filter.push({
						name:{
							standard:"naver.jp",
							locales:{
								ja:"naver.jp",
								en:"naver.jp"
							}
						},
						filter:[
							"http://*search.naver.jp/image?*",
							"http://image.search.biglobe.ne.jp/search?*"
						],
						enable_reflect_to_anchor:false,
						script:""
					});
				});

				// ウィキペディア用
				var obj = addPreset(proj.replacement_to_link,"direct_link_wikipedia",null);
				obj.preset = {
					name:{
						standard:"Direct Link (wikipedia.org)",
						locales:{
							ja:"直リンク（ウィキペディア用）",
							en:"Direct Link (wikipedia.org)"
						}
					},
					filter:[
						{
							name:{
								standard:"File:",
								locales:{
									ja:"ファイル:",
									en:"File:"
								}
							},
							filter:[
								"*://*.wikipedia.org/wiki/*:*",
								"*://*.wikipedia.org/w/*:*",
								"*://*.wikimedia.org/wiki/*:*",
								"*://*.wikimedia.org/w/*:*"
							],
							enable_reflect_to_anchor:false,
							script:""
						}
					]
				};

				// --------------------------------------------------------------------------------
				// サウンド展開定義
				// --------------------------------------------------------------------------------
				// 追加
				update(proj.expand_sound,"*",function(obj){
					if(!obj.audio_element)	obj.audio_element = new Object();
					obj.audio_element.script_allow = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;
		var url = info.url;

		var ext_list = [
			"mp3",
			"wav",
			"ogg",
			"m4a",
			"aac",
			"midi",
			"mid"
		];

		var i;
		var num = ext_list.length;
		for(i=0;i<num;i++){
			// URL がサウンドの拡張子である場合、インライン表示を試みる
			if(url.match(new RegExp("^.*/.+\\." + ext_list[i] + "($|[#?:].*$)","i"))){
				response({result:true});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		// インライン表示しない
		response({result:false});
		return true;
	}.toString() +
"\n]";

					if(!obj.soundcloud)		obj.soundcloud = new Object();
					obj.soundcloud.visible_player_flash = true;
					obj.soundcloud.visible_player_html5 = false;

					if(!obj.mixcloud)		obj.mixcloud = new Object();
					obj.mixcloud.visible_player = true;

					obj.inline.script_allow = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;
		var parent = anchor_element.parentNode;
		if(parent){
			var width = ElementGetClientWidth(parent);

			// 親の幅が小さすぎる場合インライン表示しない
			if(width < 150){
				response({result:false});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		// インライン表示する
		response({result:true});
		return true;
	}.toString() +
"\n]";

					obj.inline.script_insert = "";

					obj.inline.sound_max = 10;
				});


				// --------------------------------------------------------------------------------
				// スタイルシート定義
				// --------------------------------------------------------------------------------
				// 追加
				update(proj.style_sheet,"*",function(obj){
					var inline = new Object();
					if(!(inline.audio_element))				inline.audio_element = new Object();
					inline.audio_element.audio = obj.expand_sound.inline;

					if(!(inline.soundcloud))				inline.soundcloud = new Object();
					if(!(inline.mixcloud))					inline.mixcloud = new Object();

					obj.expand_sound.inline = inline;
				});

				// デフォルト
				update(proj.style_sheet,"default",function(obj){
					obj.expand_sound.inline.soundcloud.player_flash = "margin:2px 0px 2px 0px; border:1px #000 solid; padding:1px; background-color:#FFF; width:100%;";
					obj.expand_sound.inline.soundcloud.player_html5 = "margin:2px 0px 2px 0px; border:1px #000 solid; padding:1px; background-color:#FFF; width:100%;";
					obj.expand_sound.inline.mixcloud.player = "margin:2px 0px 2px 0px; border:1px #000 solid; padding:1px; background-color:#FFF; width:460px; height:68px;";
				});

				// シンプル
				update(proj.style_sheet,"simple",function(obj){
					obj.expand_sound.inline.soundcloud.player_flash = "margin:2px 0px 2px 0px; width:100%; border:0px;";
					obj.expand_sound.inline.soundcloud.player_html5 = "margin:2px 0px 2px 0px; width:100%; border:0px;";
					obj.expand_sound.inline.mixcloud.player = "margin:2px 0px 2px 0px; width:460px; border:0px; height:68px;";
				});

				// --------------------------------------------------------------------------------
				// URLマッピング設定
				// --------------------------------------------------------------------------------
				// 追加
				update(proj.urlmap,"*",function(obj){
					// マルチ化
					if(obj.replacement_to_element.enable){
						obj.replacement_to_element.id = [obj.replacement_to_element.id];
					}else{
						obj.replacement_to_element.id = [];
					}
					if(obj.replacement_to_text.enable){
						obj.replacement_to_text.id = [obj.replacement_to_text.id];
					}else{
						obj.replacement_to_text.id = [];
					}
					if(obj.replacement_to_anchor.enable){
						obj.replacement_to_anchor.id = [obj.replacement_to_anchor.id];
					}else{
						obj.replacement_to_anchor.id = [];
					}
				});

				// リアルタイム検索用
				var preset = getPreset(proj.urlmap,"realtime_search");
				preset.replacement_to_anchor.id.push("no_referrer");
				preset.filter.push("*://search.goo.ne.jp/web.jsp?*from=lside_twitter*");
				preset.filter.push("*://search.goo.ne.jp/web.jsp?*mode=1*");
				preset.replacement_to_link = {enable:true,id:"direct_link_generic"};
				preset.expand_short_url = {enable:true,id:"detail"};

				// 検索サイト
				var preset = getPreset(proj.urlmap,"search");
				preset.replacement_to_anchor.id.push("no_referrer");

				// twitter
				var preset = getPreset(proj.urlmap,"twitter");
				preset.replacement_to_anchor.id.push("no_referrer");

				// スレッド掲示板
				var preset = getPreset(proj.urlmap,"bbs");
				preset.replacement_to_anchor.id.push("no_referrer");

				// 画像検索サイト
				var preset = getPreset(proj.urlmap,"image_search");
				preset.replacement_to_anchor.id.push("no_referrer");
				preset.filter.splice(55,0,"*://*.images.search.yahoo.com/search/images*");
				preset.filter.splice(56,0,"*://*.image.search.yahoo.com/search/images*");
				preset.filter.splice(58,0,"*://image.yahoo.cn/s?*");
				preset.filter.push("*://*.ask.com/pictures?*");
				preset.filter.push("*://search.aol.com/aol/image?*");
				preset.filter.push("*://search.aol.jp/aol/image?*");
				preset.filter.push("*://*bsearch.goo.ne.jp/image.php?*MT=*");
				preset.filter.push("*://*bsearch.goo.ne.jp/scrimg.php?*MT=*");
				preset.filter.push("*://*bsearch.goo.ne.jp/similarity.php?*MT=*");
				preset.filter.push("*://image.baidu.com/*");
				preset.filter.push("*://image.baidu.jp/*");
				preset.filter.push("*://image.search.naver.com/*");
				preset.filter.push("*://*search.naver.jp/image?*");
				preset.filter.push("*://image.search.biglobe.ne.jp/search?*");

				// ウィキペディア
				var obj = addPreset(proj.urlmap,"wikipedia","default");
				obj.preset = {
					name:{
						standard:"Wikipedia",
						locales:{
							ja:"ウィキペディア",
							en:"Wikipedia"
						}
					},
					enable:true,
					filter:[
						"*://*.wikipedia.org/*"
					],
					enable_unsecure:false,
					access_block:{enable:false,id:""},
					replacement_to_element:{enable:false,id:[]},
					replacement_to_text:{enable:false,id:[]},
					replacement_to_anchor:{enable:true,id:["no_referrer"]},
					replacement_to_link:{enable:true,id:"direct_link_wikipedia"},
					replacement_to_referer:{enable:false,id:""},
					replacement_to_useragent:{enable:false,id:""},
					make_link_to_text:{enable:true,id:"simple"},
					expand_short_url:{enable:true,id:"simple"},
					expand_text:{enable:false,id:""},
					expand_image:{enable:true,id:"popup"},
					expand_sound:{enable:true,id:"inline"},
					expand_video:{enable:true,id:"inline"},
					expand_iframe:{enable:false,id:""},
					style_sheet:{enable:true,id:"default"},
					experimental:{enable:false,id:""}
				};
			}
			if(exit())	return proj;

			// --------------------------------------------------------------------------------
			// プロジェクト ver.6
			// --------------------------------------------------------------------------------
			if(proj.version < 6){
				// バージョン値
				proj.version = 6;

				// --------------------------------------------------------------------------------
				// ハイパーリンク置換定義
				// --------------------------------------------------------------------------------
				// イメージ検索用
				updatePreset(proj.replacement_to_link,"direct_link_image_search",function(obj){

					obj.filter.splice(7,0,{
						name:{
							standard:"Yandex Images",
							locales:{
								ja:"Yandex 画像検索",
								en:"Yandex Images"
							}
						},
						filter:[
							"http://images.yandex.ru/yandsearch?*",
							"http://images.yandex.com/yandsearch?*"
						],
						enable_reflect_to_anchor:false,
						script:""
					});

				});

				// --------------------------------------------------------------------------------
				// URLマッピング設定
				// --------------------------------------------------------------------------------
				// 画像検索サイト
				var preset = getPreset(proj.urlmap,"image_search");
				preset.filter.splice(63,0,"*://images.yandex.ru/*");
				preset.filter.splice(64,0,"*://images.yandex.com/*");

			}
			if(exit())	return proj;

			// --------------------------------------------------------------------------------
			// プロジェクト ver.7
			// --------------------------------------------------------------------------------
			if(proj.version < 7){
				// バージョン値
				proj.version = 7;

				// --------------------------------------------------------------------------------
				// 掲示板設定
				// --------------------------------------------------------------------------------
				// ログ速
				update(proj.expand_bbs,"logsoku",function(obj){
					obj.filter = [
						{
							pattern:"http://logsoku\\.com/thread/.*\\.2ch\\.net/.*?/[0-9]+",
							flags:{i:true,g:false}
						},{
							pattern:"http://.*?\\.logsoku\\.com/r/.*?/[0-9]+",
							flags:{i:true,g:false}
						},{
							pattern:"http://logsoku\\.com/r/.*?/[0-9]+",
							flags:{i:true,g:false}
						}
					];
					obj.script_initialize = "";
					obj.script_callback = "";
				});

				// あっとちゃんねるず
				var obj = addPreset(proj.expand_bbs,"atchs","unkar");
				obj.preset = {
					name:{
						standard:"atchs.jp",
						locales:{
							ja:"あっとちゃんねるず",
							en:"atchs.jp"
						}
					},
					enable:true,
					filter:[],
					script_initialize:"",
					script_callback:"",
					popup:{
						origin_type:"adsorb_top_bottom",
						position_type:"absolute",
						enable_animation:true,
						percent:{x:75,y:90},
						time_wait_open:0,
						time_wait_close:250,
						style_sheet:"padding:20px 10px; border:1px solid #000; background:#FFF; overflow-y:auto; word-wrap:break-word; word-break:break-all;"
					}
				};

				// --------------------------------------------------------------------------------
				// アクセスブロック定義
				// --------------------------------------------------------------------------------
				var obj = addPreset(proj.access_block,"firefox_extension","opera_extension");
				obj.preset = {
					name:{
						standard:"For Firefox Extension",
						locales:{
							ja:"Firefox 拡張機能用",
							en:"For Firefox Extension"
						}
					},
					filter:[]
				};

				// --------------------------------------------------------------------------------
				// リファラ置換定義
				// --------------------------------------------------------------------------------
				update(proj.replacement_to_referer,"*",function(obj){
					var filter = obj.filter;
					var i;
					var num = filter.length;
					for(i=0;i<num;i++){
						var send_referer = filter[i].send_referer;
						var str = send_referer.replacement.replace(new RegExp("[$]","g"), "$$$$");
						send_referer.replacement = str.replace(new RegExp("\\\\\\\\|\\\\[0-9]","g"),function(str, p1, p2) {
							if(str == "\\\\")	return "\\";
							return "$" + str[1];
						});
					}
				});
				var obj = addPreset(proj.replacement_to_referer,"firefox_extension",null);
				obj.preset = {
					name:{
						standard:"For Firefox Extension",
						locales:{
							ja:"Firefox 拡張機能用",
							en:"For Firefox Extension"
						}
					},
					filter:[]
				};

				// --------------------------------------------------------------------------------
				// ユーザーエージェント置換定義
				// --------------------------------------------------------------------------------
				var obj = addPreset(proj.replacement_to_useragent,"firefox_extension",null);
				obj.preset = {
					name:{
						standard:"For Firefox Extension",
						locales:{
							ja:"Firefox 拡張機能用",
							en:"For Firefox Extension"
						}
					},
					filter:[]
				};

				// --------------------------------------------------------------------------------
				// アンカー置換定義
				// --------------------------------------------------------------------------------
				// ツイッター用
				var preset = getPreset(proj.replacement_to_anchor,"direct_link_twitter");
				preset.script = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		var expanded_url = anchor_element.getAttribute("data-expanded-url");
		if(expanded_url){
			if(StringUrlMatchAsteriskWord(anchor_element.href,"*://t.co/*")){
				anchor_element.href = expanded_url;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]";

				// --------------------------------------------------------------------------------
				// ハイパーリンク置換定義
				// --------------------------------------------------------------------------------
				// 追加
				updatePreset(proj.replacement_to_link,"*",function(obj){
					var filter = obj.filter;
					var i;
					var num = filter.length;
					for(i=0;i<num;i++){
						filter[i].enable_cache = true;
					}
				});
				// 直リンク（汎用）
				updatePreset(proj.replacement_to_link,"direct_link_generic",function(obj){
					var filter = obj.filter;
					// Facebook Photo
					filter[4].script = "";
				});

				// --------------------------------------------------------------------------------
				// 短縮 URL 展開
				// --------------------------------------------------------------------------------
				// 簡易
				var obj = getPreset(proj.expand_short_url,"simple");
				obj.filter[7] = "*://t.co/*";
				// 詳細
				var obj = getPreset(proj.expand_short_url,"detail");
				obj.filter[6] = "*://t.co/*";

				// --------------------------------------------------------------------------------
				// URLマッピング設定
				// --------------------------------------------------------------------------------
				// スレッド掲示板 追加
				var obj = addPreset(proj.urlmap,"bbs","bbs");
				obj.preset.filter.splice(8,0,"*://*.logsoku.com/*");

			}
			if(exit())	return proj;

			// --------------------------------------------------------------------------------
			// プロジェクト ver.8
			// --------------------------------------------------------------------------------
			if(proj.version < 8){
				// バージョン値
				proj.version = 8;

				// --------------------------------------------------------------------------------
				// ハイパーリンク置換定義
				// --------------------------------------------------------------------------------
				// 直リンク（汎用）
				updatePreset(proj.replacement_to_link,"direct_link_generic",function(obj){
					var filter = obj.filter;

					// Twitter Photo
					filter[3].script = 
"[\n\t" + 
	function (info,response){
		var anchor_element = info.anchor_element;

		// # があれば終了
		if(anchor_element.href.indexOf("#") >= 0){
			response({result:false});
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		var anchor_element = info.anchor_element;

		// ローダーオブジェクトを作成
		var loader = new Loader();

		// 成功
		loader.onload = function(str){
			if(str.match(new RegExp("<img[ ].*?src=\"(https:\/\/pbs\\.twimg\\.com\/media\/.*?)\"","i"))){
				response({result:true,url:RegExp.$1});
				return;
			}
			response({result:false});
		};

		// 失敗
		loader.onerror = function(){
			response({result:false});
		};

		// テキストの読み込み
		loader.setMethod("GET");
		loader.setURL(anchor_element.href);
		loader.loadText();

		return true;
	}.toString() +
"\n]";
				});

				// イメージ検索用
				updatePreset(proj.replacement_to_link,"direct_link_image_search",function(obj){
					var filter = obj.filter;

					// Bing 画像検索
					filter[4].script = "";

					// Yandex 画像検索
					filter[7].script = "";

					// 百度
					filter[9].script = "";

					// naver.jp
					filter[12].enable_cache = false;
				});

				// --------------------------------------------------------------------------------
				// イメージ展開定義
				// --------------------------------------------------------------------------------
				// 追加
				update(proj.expand_image,"*",function(obj){
					var enable_animation = false;
					if(obj.popup.enable_animation){
						enable_animation = true;
					}
					obj.popup.enable_animation_scale = enable_animation;
					obj.popup.enable_animation_alpha = enable_animation;
					delete obj.popup.enable_animation;

					if((obj.popup.load_type) === undefined)				obj.popup.load_type = "preload";
					if((obj.thumbnail.load_type) === undefined)			obj.thumbnail.load_type ="preload";

					if((obj.load) === undefined)					obj.load = new Object();
					if((obj.load.enable_notify) === undefined)			obj.load.enable_notify = true;
					if((obj.load.enable_unload) === undefined)			obj.load.enable_unload = false;
					if((obj.load.unload_allow_size_more_then) === undefined)	obj.load.unload_allow_size_more_then = 256;
				});

			}
			if(exit())	return proj;

			// --------------------------------------------------------------------------------
			// プロジェクト ver.9
			// --------------------------------------------------------------------------------
			if(proj.version < 9){
				// バージョン値
				proj.version = 9;

				// --------------------------------------------------------------------------------
				// アンカー置換定義
				// --------------------------------------------------------------------------------
				// ソーシャルサービスのカウント数を表示
				updatePreset(proj.replacement_to_anchor,"attach_sns_counter",function(obj){
					obj.script = 
"[\n\t" + 
	function(info,response){
		// Twitterボタンを追加
		var anchor_element = info.anchor_element;
		var url = anchor_element.href;

		// キュー
		var result = new Array();
		var queue = [
			// Twitter
			function(){
				var loader = new Loader();
				loader.onerror = error;
				loader.onload = function(v){
					try{
						var param = JsonParse(v);
						if(param.count){
							result.push("t:" + param.count);
						}
					}catch(e){}
					execute();
				};
				loader.setURL("http://urls.api.twitter.com/1/urls/count.json?url=" + url);
				loader.loadText();
			},
			// Facebook
			function(){
				var loader = new Loader();
				loader.onerror = error;
				loader.onload = function(v){
					try{
						var param = JsonParse(v);
						if(param[0].total_count){
							result.push("f:" + param[0].total_count);
						}
					}catch(e){}
					execute();
				};
				var fql = "SELECT total_count FROM link_stat WHERE url=\"" + url + "\"";
				fql = encodeURIComponent(fql).replace(/!/g, '%21').replace(/'/g, '%27').replace(/\(/g, '%28').replace(/\)/g, '%29').replace(/\*/g, '%2A').replace(/%20/g, '+');
				loader.setURL("https://api.facebook.com/method/fql.query?format=json&query=" + fql);
				loader.loadText();
			},
			// Google +1
			function(){
				var loader = new Loader();
				loader.onerror = error;
				loader.onload = function(v){
					if(v.match(/window\.__SSR = [{]c: ([0-9]+)/i)){
						var count = parseInt(RegExp.$1);
						if(count){
							result.push("g+:" + count);
						}
					}
					execute();
				};
				loader.setURL("https://plusone.google.com/u/0/_/+1/fastbutton?count=true&url=" + url);
				loader.loadText();
			},
			// はてなブックマーク
			function(){
				var loader = new Loader();
				loader.onerror = error;
				loader.onload = function(v){
					if(v){
						result.push("B!:" + v);
					}
					execute();
				};
				loader.setURL("http://api.b.st-hatena.com/entry.count?url=" + escape(url));
				loader.loadText();
			},
			// Yahoo!ブックマーク
			function(){
				var loader = new Loader();
				loader.onerror = error;
				loader.onload = function(v){
					if(v.match(/ct="([0-9]+)"/i)){
						var count = parseInt(RegExp.$1);
						if(count){
							result.push("Y:" + count);
						}
					}
					execute();
				};
				loader.setURL("http://num.bookmarks.yahoo.co.jp/yjnostb.php?urls=" + url);
				loader.loadText();
			},
			// livedoorクリップ
			function(){
				var loader = new Loader();
				loader.onerror = error;
				loader.onload = function(v){
					try{
						var param = JsonParse(v);
						if(param.total_clip_count){
							result.push("l:" + param.total_clip_count);
						}
					}catch(e){}
					execute();
				};
				loader.setURL("http://api.clip.livedoor.com/json/comments?link=" + encodeURIComponent(url));
				loader.loadText();
			},
			// 出力
			function(){
				var num = result.length;
				if(num){
					var str = "(";
					var i;
					for(i=0;i<num;i++){
						if(i)	str += " ";
						str += result[i];
					}
					str += ")";

					// span を生成
					var span = DocumentCreateElement("span");
					ElementSetStyle(span,"font-weight:bold; font-size:12px; background:#FFF; color:#000; padding:1px; margin:1px; display:inline-block; line-height:1.0;");
					ElementSetTextContent(span,str);

					// 直後に登録
					DomNodeInsertAfter(span,anchor_element);
				}
			}
		];

		// 実行
		function execute(){
			var f = queue.shift();
			if(f){
				f();
			}
		}

		// エラー
		function error(){
			execute();
		}

		// 初回実行開始
		execute();

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]";
				});

				// --------------------------------------------------------------------------------
				// ハイパーリンク置換定義
				// --------------------------------------------------------------------------------
				// 直リンク（汎用）
				updatePreset(proj.replacement_to_link,"direct_link_generic",function(obj){
					var filter = obj.filter;

					// OGP "og:image"
					filter[0].filter.push("*://twitter.yfrog.com/*");
					filter[0].filter.push("*://yfrog.com/*");

					// OGP "twitter:*"
					filter[1].filter.push("*://campl.us/*");

					// Twitpic
					filter[2].script = 
"[\n\t" + 
	function(info,response){

		var anchor_element = info.anchor_element;

		// ローダーオブジェクトを作成
		var loader = new Loader();

		// 成功
		loader.onload = function(str){
			if(str.match(new RegExp("<img src=\"(http:\/\/.+?\/(large|full)\/.+?)\"","i"))){
				response({result:true,url:RegExp.$1});
				return;
			}
			response({result:false});
		};

		// 失敗
		loader.onerror = function(){
			response({result:false});
		};

		// テキストの読み込み
		loader.setMethod("GET");
		loader.setURL(anchor_element.href);
		loader.loadText();

		return true;
	}.toString() +
"\n]";

					// Giphy
					filter.splice(6,0,{
						name:{
							standard:"giphy.com",
							locales:{
								ja:"giphy.com",
								en:"giphy.com"
							}
						},
						filter:[
							"*://giphy.com/gifs/*",
							"*://giphy.com/embed/*"
						],
						enable_reflect_to_anchor:false,
						enable_cache:true,
						script:
"[\n\t" + 
	function(info,response){

		var anchor_element = info.anchor_element;

		// ローダーオブジェクトを作成
		var loader = new Loader();

		// 成功
		loader.onload = function(str){
			if(str.match(new RegExp("(http://media\\.giphy\\.com/media/[0-9a-zA-Z]+/).+?(\\.gif)","i"))){
				var image_url = RegExp.$1 + "original" + RegExp.$2;
				response({result:true,url:image_url});
				return;
			}
			response({result:false});
		};

		// 失敗
		loader.onerror = function(){
			response({result:false});
		};

		// テキストの読み込み
		loader.setMethod("GET");
		loader.setURL(anchor_element.href);
		loader.loadText();

		return true;
	}.toString() +
"\n]"
					});

					// Gyazo
					filter.splice(7,0,{
						name:{
							standard:"gyazo.com",
							locales:{
								ja:"Gyazo",
								en:"gyazo.com"
							}
						},
						filter:[
							"*://gyazo.com/*"
						],
						enable_reflect_to_anchor:false,
						enable_cache:true,
						script:""
					});

					// フォト蔵
					filter[8].script = 
"[\n\t" + 
	function(info,response){

		var anchor_element = info.anchor_element;

		// ローダーオブジェクトを作成
		var loader = new Loader();

		// 成功
		loader.onload = function(str){
			if(str.match(new RegExp("<meta.*?property.*?=.*?\"og:image\".*?content.*?=.*?\"(.*?)\"","i"))){
				var image_url = RegExp.$1;
				var m = image_url.match(new RegExp("_[0-9]+\\.v","i"));
				if(m){
					image_url = RegExp.leftContext + "_org.v" + RegExp.rightContext;
				}

				response({result:true,url:image_url});
				return;
			}
			response({result:false});
		};

		// 失敗
		loader.onerror = function(){
			response({result:false});
		};

		// テキストの読み込み
		loader.setMethod("GET");
		loader.setURL(anchor_element.href);
		loader.loadText();

		return true;
	}.toString() +
"\n]";

					// ピクシブ
					filter[11].script = "";
				});

				// イメージ検索用
				updatePreset(proj.replacement_to_link,"direct_link_image_search",function(obj){
					var filter = obj.filter;

					// Bing 画像検索
					filter[4].script = "";
				});

				// --------------------------------------------------------------------------------
				// 短縮 URL 展開
				// --------------------------------------------------------------------------------
				// 詳細
				var obj = getPreset(proj.expand_short_url,"detail");
				obj.filter.push("http://gph.is/*");

			}
			if(exit())	return proj;

			// --------------------------------------------------------------------------------
			// プロジェクト ver.10
			// --------------------------------------------------------------------------------
			if(proj.version < 10){
				// バージョン値
				proj.version = 10;

				// --------------------------------------------------------------------------------
				// 掲示板設定
				// --------------------------------------------------------------------------------
				// 4chan.org
				var obj = addPreset(proj.expand_bbs,"4chan",null);
				var preset = obj.preset;
				preset.name = {
					standard:"4chan.org (Image Boards)",
					locales:{
						ja:"4chan (Image Boards)",
						en:"4chan.org (Image Boards)"
					}
				};
				preset.filter = [
					{
						pattern:"^(http|https)://boards\\.4chan\\.org/.*/",
						flags:{i:true,g:false}
					}
				];
				preset.popup.style_sheet = "padding:20px 10px; border:1px solid #000; overflow-y:auto; word-wrap:break-word; word-break:break-all; display:block;";

				// ニコニコ大百科
				var obj = addPreset(proj.expand_bbs,"nicovideo_dictionary",null);
				var preset = obj.preset;
				preset.filter = [
					{
						pattern:"^http://dic\\.nicovideo\\.jp/b/(a|c|i|l|u|v)/.+",
						flags:{i:true,g:false}
					},{
						pattern:"^http://dic\\.nicovideo\\.jp/(a|c|i|l|u|v)/.+",
						flags:{i:true,g:false}
					}
				];

				// --------------------------------------------------------------------------------
				// ハイパーリンク化定義
				// --------------------------------------------------------------------------------
				// 簡易
				updatePreset(proj.make_link_to_text,"simple",function(obj){
					obj.script =
"[\n\t" + 
	function(info,response){
		var text_node = info.text_node;

		// 対応URIスキーム
		var scheme_list = [
			["https://","https://"],
			["http://","http://"],
			["ftp://","ftp://"]
		];

		// 辞書を作成
		var i;
		var num = scheme_list.length;
		var str = "(";
		var scheme_dictionary = new Object();
		for(i=0;i<num;i++){
			var scheme = scheme_list[i];
			scheme_dictionary[scheme[0]] = scheme[1];
			str += scheme[0];
			if(i < num - 1){
				str += "|";
			}
		}
		str += ")";
		var ignore_dictionary = {"WBR":1};
		var inline_dictionary = {"SPAN":1,"FONT":1,"TT":1,"EM":1,"B":1,"I":1,"BIG":1,"SMALL":1};

		// 正規表現を作成
		var char = "[-a-zA-Z0-9<>#%_.!~*'();/?:@&=+$,]";
		var search_regexp = new RegExp(str + "(" + char + "*)","ig");
		var char_regexp = new RegExp("^(" + char + "*)","i");
		var url_regexp = new RegExp("^(http|https|ftp)://(" + char + "{4,})$","");
		var omit_regexp = new RegExp("\\.\\.\\.$","");

		// テキストを取得
		var base = DomNodeGetNodeValue(text_node);

		var p = 0;
		var b = 0;
		var l1;
		var l2;
		var size = base.length;
		base.replace(search_regexp, function(str,p1,p2,o,s){
			p += o;
			l1 = p1.length;
			l2 = p2.length;
			var url = scheme_dictionary[p1] + base.substr(p+l1,l2);

			if(size > p + l1 + l2){

				// 有効
				if(url.match(url_regexp) && !url.match(omit_regexp)){

					// 元のテキストノード
					text_node.nodeValue = base.substring(b,p);

					// アンカーを作成
					var anchor_element = DocumentCreateElement('a');
					anchor_element.href = url;
					ElementSetTextContent(anchor_element,p1 + p2);
					DomNode_InsertAfter(text_node,anchor_element);

					p += l1 + l2;
					b = p;

					// 右側のテキストノードを作成
					text_node = DocumentCreateText(base.substring(p));
					DomNode_InsertAfter(anchor_element,text_node);

				}

			}else{
				var nodes = new Array();

				// 元のテキスト
				var prev_text = base.substring(b,p);

				// アンカーテキスト
				nodes.push(DocumentCreateText(p1 + p2));

				var next_node = text_node.nextSibling;
				while(next_node){
					if(next_node.nodeType == 1){
						var result = false;
						var tag_name = next_node.tagName;

						// 無視するタグ
						if(ignore_dictionary[tag_name]){
							nodes.push(next_node);
							result = true;

						// テキストとして取得を試みるタグ
						}else if(inline_dictionary[tag_name]){
							var children = next_node.childNodes;
							num = children.length;
							for(i=0;i<num;i++){
								var node = children[i];
								if(node.nodeType == 3)	continue;
								if(node.nodeType == 1){
									if(ignore_dictionary[node.tagName]){
										continue;
									}
								}
								break;
							}
							if(i >= num){
								base = ElementGetTextContent(next_node);
								m = base.match(char_regexp);
								if(m){
									if(!RegExp.rightContext){
										url += base.substr(0,m[1].length);
										nodes.push(next_node);
										result = true;
									}
								}
							}
						}

						if(!result){
							break;
						}

					}else if(next_node.nodeType == 3){
						base = DomNodeGetNodeValue(next_node);

						m = base.match(char_regexp);
						if(m){
							url += base.substr(0,m[1].length);
							if(RegExp.rightContext){
								// 有効
								if(url.match(url_regexp) && !url.match(omit_regexp)){
									// 元のテキストノード
									next_node.nodeValue = base.substr(0,m[1].length);
									nodes.push(next_node);

									// 右側のテキストノードを作成
									var node = DocumentCreateText(base.substring(m[1].length));
									DomNode_InsertAfter(next_node,node);
								}
								break;
							}else{
								nodes.push(next_node);
							}
						}

					}

					next_node = next_node.nextSibling;
				}

				// 有効
				if(url.match(url_regexp) && !url.match(omit_regexp)){

					// 元のテキストノード
					text_node.nodeValue = prev_text;

					// アンカーを作成
					var anchor_element = DocumentCreateElement('a');
					anchor_element.href = url;
					DomNode_InsertAfter(text_node,anchor_element);

					num = nodes.length;
					for(i=0;i<num;i++){
						if(nodes[i]){
							anchor_element.appendChild(nodes[i]);
						}
					}
				}
			}
		});

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]";
				});

				// 詳細
				updatePreset(proj.make_link_to_text,"detail",function(obj){
					obj.script =
"[\n\t" + 
	function(info,response){
		var text_node = info.text_node;

		// 対応URIスキーム
		var scheme_list = [
			["https://","https://"],
			["http://","http://"],
			["ttps://","https://"],
			["ttp://","http://"],
			["ftp://","ftp://"],
			["tps://","https://"],
			["tp://","http://"]
		];

		// 辞書を作成
		var i;
		var num = scheme_list.length;
		var str = "(";
		var scheme_dictionary = new Object();
		for(i=0;i<num;i++){
			var scheme = scheme_list[i];
			scheme_dictionary[scheme[0]] = scheme[1];
			str += scheme[0];
			if(i < num - 1){
				str += "|";
			}
		}
		str += ")";
		var ignore_dictionary = {"WBR":1};
		var inline_dictionary = {"SPAN":1,"FONT":1,"TT":1,"EM":1,"B":1,"I":1,"BIG":1,"SMALL":1};

		// 正規表現を作成
		var char = "[-a-zA-Z0-9<>#%_.!~*'();/?:@&=+$,]";
		var search_regexp = new RegExp(str + "(" + char + "*)","ig");
		var char_regexp = new RegExp("^(" + char + "*)","i");
		var url_regexp = new RegExp("^(http|https|ftp)://(" + char + "{4,})$","");
		var omit_regexp = new RegExp("\\.\\.\\.$","");

		// テキストを取得
		var base = DomNodeGetNodeValue(text_node);
		var half = StringConvertFromAlphabeticFullToAlphabeticHalf(base);
		half = StringConvertFromNumericFullToNumericHalf(half);
		half = StringConvertFromSignFullToSignHalf(half);

		var p = 0;
		var b = 0;
		var l1;
		var l2;
		var size = half.length;
		half.replace(search_regexp, function(str,p1,p2,o,s){
			p += o;
			l1 = p1.length;
			l2 = p2.length;
			var url = scheme_dictionary[p1] + half.substr(p+l1,l2);

			if(size > p + l1 + l2){

				// 有効
				if(url.match(url_regexp) && !url.match(omit_regexp)){

					// 元のテキストノード
					text_node.nodeValue = base.substring(b,p);

					// アンカーを作成
					var anchor_element = DocumentCreateElement('a');
					anchor_element.href = url;
					ElementSetTextContent(anchor_element,base.substr(p,l1+l2));
					DomNode_InsertAfter(text_node,anchor_element);

					p += l1 + l2;
					b = p;

					// 右側のテキストノードを作成
					text_node = DocumentCreateText(base.substring(p));
					DomNode_InsertAfter(anchor_element,text_node);

				}

			}else{
				var nodes = new Array();

				// 元のテキスト
				var prev_text = base.substring(b,p);

				// アンカーテキスト
				nodes.push(DocumentCreateText(base.substr(p,l1+l2)));

				var next_node = text_node.nextSibling;
				while(next_node){
					if(next_node.nodeType == 1){
						var result = false;
						var tag_name = next_node.tagName;

						// 無視するタグ
						if(ignore_dictionary[tag_name]){
							nodes.push(next_node);
							result = true;

						// テキストとして取得を試みるタグ
						}else if(inline_dictionary[tag_name]){
							var children = next_node.childNodes;
							num = children.length;
							for(i=0;i<num;i++){
								var node = children[i];
								if(node.nodeType == 3)	continue;
								if(node.nodeType == 1){
									if(ignore_dictionary[node.tagName]){
										continue;
									}
								}
								break;
							}
							if(i >= num){
								base = ElementGetTextContent(next_node);
								half = StringConvertFromAlphabeticFullToAlphabeticHalf(base);
								half = StringConvertFromNumericFullToNumericHalf(half);
								half = StringConvertFromSignFullToSignHalf(half);
								m = half.match(char_regexp);
								if(m){
									if(!RegExp.rightContext){
										url += half.substr(0,m[1].length);
										nodes.push(next_node);
										result = true;
									}
								}
							}
						}

						if(!result){
							break;
						}

					}else if(next_node.nodeType == 3){
						base = DomNodeGetNodeValue(next_node);
						half = StringConvertFromAlphabeticFullToAlphabeticHalf(base);
						half = StringConvertFromNumericFullToNumericHalf(half);
						half = StringConvertFromSignFullToSignHalf(half);

						m = half.match(char_regexp);
						if(m){
							url += half.substr(0,m[1].length);
							if(RegExp.rightContext){
								// 有効
								if(url.match(url_regexp) && !url.match(omit_regexp)){
									// 元のテキストノード
									next_node.nodeValue = base.substr(0,m[1].length);
									nodes.push(next_node);

									// 右側のテキストノードを作成
									var node = DocumentCreateText(base.substring(m[1].length));
									DomNode_InsertAfter(next_node,node);
								}
								break;
							}else{
								nodes.push(next_node);
							}
						}

					}

					next_node = next_node.nextSibling;
				}

				// 有効
				if(url.match(url_regexp) && !url.match(omit_regexp)){

					// 元のテキストノード
					text_node.nodeValue = prev_text;

					// アンカーを作成
					var anchor_element = DocumentCreateElement('a');
					anchor_element.href = url;
					DomNode_InsertAfter(text_node,anchor_element);

					num = nodes.length;
					for(i=0;i<num;i++){
						if(nodes[i]){
							anchor_element.appendChild(nodes[i]);
						}
					}
				}
			}
		});

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]";
				});

				// --------------------------------------------------------------------------------
				// アンカー置換定義
				// --------------------------------------------------------------------------------
				// 2ch.net 用
				updatePreset(proj.replacement_to_anchor,"direct_link_bbs",function(obj){
					obj.script = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;
		var r;

		// リンク先を取得
		var url = anchor_element.href;

		var list = [
			// 2ちゃんねる
			{search:"^http://ime\\.nu/",replace:"http://"},
			// まちBBS
			{search:"^http://machi\\.to/bbs/link\\.cgi[?]URL=",replace:""},
			// PINKちゃんねる
			{search:"^http://pinktower\\.com/",replace:"http://"},
			// したらば掲示板
			{search:"^http://jbbs\\.livedoor\\.jp/bbs/link\\.cgi[?]url=",replace:""},
			// ログ速
			{search:"^http://l\\.moapi\\.net/",replace:""},
			// かきこ
			{search:"^http://fast\\.io/",replace:"http://"},
			// あっとちゃんねるず
			{search:"^http://z4c\\.in/",replace:"http://"},
			{search:"^http://www[0-9]+\\.atchs\\.jp/j/",replace:"http://"}
		];

		var i;
		var num = list.length;
		for(i=0;i<num;i++){
			r = new RegExp(list[i].search,"i");
			if(url.match(r)){
				anchor_element.href = url.replace(r,list[i].replace);
				return false;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]";
				});

				// リンク先をツールチップで表示
				var obj = addPreset(proj.replacement_to_anchor,"display_url_in_tooltip","attach_sns_counter");

				obj.preset = {
					name:{
						standard:"Display URL in the ToolTip",
						locales:{
							ja:"ツールチップにリンク先を表示",
							en:"Display URL in the ToolTip"
						}
					},
					script:
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;
		var event_dispatcher = info.event_dispatcher;

		// 開放時に実行される関数
		function release(){
			if(event_handler_change){
				event_handler_change.release();
				event_handler_change = null;
			}
			if(event_handler_release){
				event_handler_release.release();
				event_handler_release = null;
			}
		}

		// 変更時に実行される関数
		function change(){
			// ツールチップを設定
			anchor_element.title = anchor_element.href;
		}


		// 開放時に実行されるイベント
		var event_handler_release = event_dispatcher.createEventHandler("release");
		event_handler_release.setFunction(release);

		// 変更時に実行されるイベント
		var event_handler_change = event_dispatcher.createEventHandler("anchor_href_change");
		event_handler_change.setFunction(change);

		change();
		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]"
				};

				// --------------------------------------------------------------------------------
				// ハイパーリンク置換定義
				// --------------------------------------------------------------------------------
				// 直リンク（汎用）
				updatePreset(proj.replacement_to_link,"direct_link_generic",function(obj){
					var filter = obj.filter;

					// Google+ Photo
					filter.splice(5,0,{
						name:{
							standard:"Google+ Photo",
							locales:{
								ja:"Google+ Photo",
								en:"Google+ Photo"
							}
						},
						filter:[
							"*://plus.google.com/*photos/*/albums/*"
						],
						enable_reflect_to_anchor:false,
						enable_cache:true,
						script:
"[\n\t" + 
	function(info,response){

		var anchor_element = info.anchor_element;

		// ローダーオブジェクトを作成
		var loader = new Loader();

		// 成功
		loader.onload = function(str){
			if(str.match(new RegExp("<meta.*?property.*?=.*?\"og:image\".*?content.*?=.*?\"(.*?)\"","i"))){
				var image_url = RegExp.$1;
				if(image_url.match(new RegExp("(.*)/(s[0-9]{1,3})(|-c)/(.*?)$","i"))){
					image_url = RegExp.$1 + "/s9999/" + RegExp.$4;
				}

				response({result:true,url:image_url,content_type:["image"]});
				return;
			}
			response({result:false});
		};

		// 失敗
		loader.onerror = function(){
			response({result:false});
		};

		// テキストの読み込み
		loader.setMethod("GET");
		loader.setURL(anchor_element.href);
		loader.loadText();

		return true;
	}.toString() +
"\n]"
					});

					// Picasa Photo
					filter.splice(6,0,{
						name:{
							standard:"Picasa Photo",
							locales:{
								ja:"Picasa Photo",
								en:"Picasa Photo"
							}
						},
						filter:[
							"*://picasaweb.google.com/lh/photo/*",
							"*://picasaweb.google.com/*/*?*#*",
							"*://picasaweb.google.com/*/*#*"
						],
						enable_reflect_to_anchor:false,
						enable_cache:true,
						script:
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;
		if(anchor_element.href.match("^(http|https)://picasaweb\\.google\\.com/lh/photo/[0-9a-zA-Z]+(|[?].*)$","i")){
			// ローダーオブジェクトを作成
			var loader = new Loader();

			// 成功
			loader.onload = function(str){
				if(str.match(new RegExp("<link.*?rel.*?=.*?\'image_src\'.*?href.*?=.*?\"(.*?)\"","i"))){
					var image_url = RegExp.$1;
					if(image_url.match(new RegExp("(.*)/(s[0-9]{1,3})(|-c)/(.*?)$","i"))){
						image_url = RegExp.$1 + "/s9999/" + RegExp.$4;
					}

					response({result:true,url:image_url,content_type:["image"]});
					return;
				}
				response({result:false});
			};

			// 失敗
			loader.onerror = function(){
				response({result:false});
			};

			// テキストの読み込み
			loader.setMethod("GET");
			loader.setURL(anchor_element.href);
			loader.loadText();

			return true;
		}
		
		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		var anchor_element = info.anchor_element;
		if(anchor_element.href.match("^(http|https)://picasaweb\\.google\\.com/[0-9]+/[0-9a-zA-Z]+(|[?].*)#([0-9]+)$","i")){
			var photo_id = RegExp.$3;

			// ローダーオブジェクトを作成
			var loader = new Loader();

			// 成功
			loader.onload = function(str){
				var pos = str.indexOf(photo_id);
				if(pos >= 0){
					if(str.substring(pos).match(new RegExp("\"thumbnail\":[[][{]\"url\":\"(.*?)\"","i"))){
						var image_url = RegExp.$1;
						if(image_url.match(new RegExp("(.*)/(s[0-9]{1,3})(|-c)/(.*?)$","i"))){
							image_url = RegExp.$1 + "/s9999/" + RegExp.$4;
						}

						response({result:true,url:image_url,content_type:["image"]});
						return;
					}
				}
				response({result:false});
			};

			// 失敗
			loader.onerror = function(){
				response({result:false});
			};

			// テキストの読み込み
			loader.setMethod("GET");
			loader.setURL(anchor_element.href);
			loader.loadText();

			return true;
		}
		
		return false;
	}.toString() +
"\n]"
					});

					// ついっぷる (直リンク)
					filter.splice(12,0,{
							name:{
								standard:"Twipple Photo (Direct Link)",
								locales:{
									ja:"ついっぷる (直リンク)",
									en:"Twipple Photo (Direct Link)"
								}
							},
							filter:[
								"*://p.twpl.jp/show/*"
							],
							enable_reflect_to_anchor:false,
							enable_cache:true,
							script:
"[\n\t" + 
	function(info,response){

		var anchor_element = info.anchor_element;
		var m = anchor_element.href.match(new RegExp("^(http|https)(://p.twpl.jp/show/)(orig|large)(/[0-9a-zA-Z]{4,}$)","i"));
		if(m){
			response({result:true,url:m[1]+m[2]+"orig"+m[4],content_type:["image"]});
		}else{
			response({result:false});
		}

		return true;
	}.toString() +
"\n]"
					});

					// Gyazo
					filter[9].script = 
"[\n\t" + 
	function(info,response){

		var anchor_element = info.anchor_element;

		// ローダーオブジェクトを作成
		var loader = new Loader();

		// 成功
		loader.onload = function(str){
			var m = str.match(new RegExp("<meta.*?property.*?=.*?\"og:image\".*?content.*?=.*?\"(.*?)\"","i"));
			if(m){
				var image_url = m[1];
				m = image_url.match(new RegExp("/thumb/","i"));
				if(m){
					image_url = RegExp.leftContext + "/" + RegExp.rightContext;
				}

				response({result:true,url:image_url,content_type:["image"]});
				return;
			}
			response({result:false});
		};

		// 失敗
		loader.onerror = function(){
			response({result:false});
		};

		// テキストの読み込み
		loader.setMethod("GET");
		loader.setURL(anchor_element.href);
		loader.loadText();

		return true;
	}.toString() +
"\n]";

					// ニコニコ静画
					filter[13].script = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		function directLink(){
			var list = [
				"^(http|https)://seiga\\.nicovideo\\.jp/seiga/im([0-9]+)",
				"^(http|https)://nico\\.ms/im([0-9]+)"
			];
			var i;
			var num = list.length;
			for(i=0;i<num;i++){
				var m = anchor_element.href.match(new RegExp(list[i],"i"));
				if(m){
					response({result:true,url:"http://seiga.nicovideo.jp/image/source?id=" + m[2],content_type:["image"]});
					return;
				}
			}
			response({result:false});
		}

		// ローダーオブジェクトを作成
		var loader = new Loader();

		// 成功
		loader.onload = function(str){
			var m = str.match(new RegExp("class=\"siteHeaderLogin\"","i"));
			if(!m){
				// ログイン中
				directLink();
				return;
			}

			var m = str.match(new RegExp("<meta.*?property.*?=.*?\"og:image\".*?content.*?=.*?\"(.*?)\"","i"));
			if(m){
				response({result:true,url:m[1],content_type:["image"]});
				return;
			}
			response({result:false});
		};

		// 失敗
		loader.onerror = function(){
			directLink();
		};

		// テキストの読み込み
		loader.setMethod("GET");
		loader.setURL(anchor_element.href);
		loader.loadText();

		return true;
	}.toString() +
"\n]";

					// ピクシブ
					filter[14].filter.push("*://touch.pixiv.net/member_illust.php?*illust_id*");
					filter[14].script = "";
				});

				// イメージ検索用
				updatePreset(proj.replacement_to_link,"direct_link_image_search",function(obj){
					var filter = obj.filter;

					// Bing 画像検索
					filter[4].script = "";

					// 百度
					filter[9].script = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		// 画像を取得
		var images = ElementGetElementsByTagName(anchor_element,"img");
		if(images.length == 1){
			var image = images[0];

			var str = anchor_element.getAttribute("data-clickstr");
			if(!str){
				str = anchor_element.getAttribute("onclick");
			}
			if(str){
				if(str.match(new RegExp("u:\'(.*?)\'","i"))){
					if(RegExp.$1.indexOf("http") == 0){
						response({result:true,url:RegExp.$1,content_type:["image"]});
						return true;
					}
				}
			}

			var str = image.getAttribute("obj_url");
			if(str){
				response({result:true,url:str,content_type:["image"]});
				return true;
			}

			var str = image.getAttribute("data-origin");
			if(str){
				try{
					var uncompile = function (i) {
						var g = {
							w:"a",k:"b",v:"c","1":"d",j:"e",u:"f","2":"g",i:"h",t:"i","3":"j",
							h:"k",s:"l","4":"m",g:"n","5":"o",r:"p",q:"q","6":"r",f:"s",p:"t",
							"7":"u",e:"v",o:"w","8":"1",d:"2",n:"3","9":"4",c:"5",m:"6","0":"7",
							b:"8",l:"9",a:"0","_z2C$q":":","_z&e3B":".",AzdH3F:"/"};
						var e = /([a-w\d])/g;
						var b = /(_z2C\$q|_z&e3B|AzdH3F)/g;

						if (!i || i.indexOf("http") === 0) {
							return i;
						}
						var h = i.replace(b, function (k, j) {
							return g[j];
						});
						return h.replace(e, function (k, j) {
							return g[j];
						});
					};

					str = uncompile(str);

					response({result:true,url:str,content_type:["image"]});
					return true;

				}catch(e){}
			}
		}

		response({result:false});
		return true;
	}.toString() +
"\n]";
				});

				// --------------------------------------------------------------------------------
				// テキスト展開定義
				// --------------------------------------------------------------------------------
				// インライン表示
				updatePreset(proj.expand_text,"inline",function(obj){
					obj.inline.script_insert = 
"[\n\t" + 
	function(info,response){

		var anchor_element = info.anchor_element;
		var textarea = info.textarea_element;
		var event_dispatcher = info.event_dispatcher;
		var style = textarea.style;

		// ピクセル値によるサイズ指定
		var width  = 400;

		// スクロール補正
		var revise_scroll = new DocumentReviseScroll();
		revise_scroll.executeAttachElementBefore(textarea);

		// 改行用
		var div_prev = DocumentCreateElement("div");
		var analyze_div_prev = new ElementAnalyzeManager(div_prev,true);
		ElementSetStyle(div_prev,"height:0px;");
		DomNode_InsertAfter(anchor_element,div_prev);

		// テキストエリアを挿入
		DomNode_InsertAfter(div_prev,textarea);

		// 改行用
		var div_next = DocumentCreateElement("div");
		var analyze_div_next = new ElementAnalyzeManager(div_next,true);
		ElementSetStyle(div_next,"height:0px;");
		DomNode_InsertAfter(textarea,div_next);

		// 高さを取得
		var bounding_size = ElementGetBoundingClientRect(textarea);
		var height = bounding_size.bottom  - bounding_size.top;

		// スタイルのサイズを取得
		style.width  = "0px";
		style.height = "0px";
		bounding_size = ElementGetBoundingClientRect(textarea);
		var style_w = bounding_size.right  - bounding_size.left;
		var style_h = bounding_size.bottom  - bounding_size.top;

		// 親の幅を取得
		var width_max = ElementGetClientWidth(textarea.parentNode);

		// エレメントのサイズ
		width  -= style_w;

		// 最大幅補正
		w = width_max - style_w;
		if(w < width){
			width = w;
		}

		// サイズをセット
		style.width  = width  + "px";
		style.height = (height - style_h) + "px";

		// スクロール補正
		revise_scroll.executeAttachElementAfter(textarea);

		// 開放時に実行されるイベント
		var event_handler = event_dispatcher.createEventHandler("release");
		event_handler.setFunction(function (result){
			if(analyze_div_prev){
				analyze_div_prev.release();
				analyze_div_prev = null;
			}
			if(analyze_div_next){
				analyze_div_next.release();
				analyze_div_next = null;
			}
			if(event_handler){
				event_handler.release();
				event_handler = null;
			}
		});

		response();
		return false;
	}.toString() +
"\n]";
				});

				// --------------------------------------------------------------------------------
				// イメージ展開定義
				// --------------------------------------------------------------------------------
				// サムネイル表示
				updatePreset(proj.expand_image,"thumbnail",function(obj){
					obj.thumbnail.script_allow = "";
				});

				// ポップアップ表示
				updatePreset(proj.expand_image,"popup",function(obj){
					obj.popup.script_allow = "";
				});

				// サムネイル許可
				updatePreset(proj.expand_image,"*",function(obj){
					obj.thumbnail.script_insert = "";
				});

				// 画像掲示板用
				var obj = addPreset(proj.expand_image,"image_bbs",null);
				obj.preset = {
						name:{
							standard:"For www.4chan.org",
							locales:{
								ja:"画像掲示板用",
								en:"For www.4chan.org"
							}
						},
						thumbnail:{
						enable_popup_mouseover:true,
						disable_same_image:false,
						load_type:"preload",
						script_allow:"[]",
						script_insert:"[]"
					},
					popup:{
						origin_type:"center",
						position_type:"absolute",
						time_wait_open:0,
						time_wait_close:0,
						enable_animation_scale:true,
						enable_animation_alpha:true,
						load_type:"preload",
						script_allow:"[]"
					},
					reduced_image:{
						enable_popup:true,
						popup_allow_slcale_less_then:70
					},
					load:{
						enable_notify:true,
						enable_unload:false,
						unload_allow_size_more_then:256
					}
				};

				obj.preset.thumbnail.script_allow = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		// 本文中のみ許可
		var node = anchor_element.parentNode;
		if(node){
			if(node.tagName == "BLOCKQUOTE"){
					return false;
			}
		}

		response({result:false});
		return true;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var anchor_element = info.anchor_element;
		var parent = anchor_element.parentNode;
		if(parent){
			var width = ElementGetClientWidth(parent);

			// 親の幅が小さすぎる場合サムネイル化しない
			if(width < 50){
				response({result:false});
				return true;
			}
		}

		// 子にイメージが含まれる場合サムネイル化しない
		var nodes = ElementGetElementsByTagName(anchor_element,"img");
		if(nodes.length > 0){
			response({result:false});
			return true;
		}

		// 子が無い
		var nodes = anchor_element.childNodes;
		if(nodes.length == 0){
			response({result:false});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var anchor_element = info.anchor_element;
		var url = info.url;

		var ext_list = [
			"bmp",
			"gif",
			"jpg",
			"jpe",
			"jpeg",
			"png"
		];

		var i;
		var num = ext_list.length;
		for(i=0;i<num;i++){
			// URL が画像の拡張子である場合、サムネイル表示を試みる
			if(url.match(new RegExp("^.*/.+\\." + ext_list[i] + "($|[#?:].*$)","i"))){
				response({result:true});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var anchor_element = info.anchor_element;
		var content_type = info.content_type;

		// コンテンツタイプに "image" が含まれる
		if(content_type.join(",").match(/image/i)){
			response({result:true});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		// サムネイル表示しない
		response({result:false});
		return true;
	}.toString() +
"\n]";

				obj.preset.popup.script_allow =
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		// イメージが１つだけ含まれる場合許可
		var nodes = ElementGetElementsByTagName(anchor_element,"IMG");
		if(nodes.length == 1){
			var node = nodes[0];

			// 拡張ボタンは除外
			if(node.className == "extButton"){
			}else{
				return false;
			}
		}

		response({result:false});
		return true;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var anchor_element = info.anchor_element;
		var url = info.url;

		var ext_list = [
			"bmp",
			"gif",
			"jpg",
			"jpe",
			"jpeg",
			"png"
		];

		var i;
		var num = ext_list.length;
		for(i=0;i<num;i++){
			// URL が画像の拡張子である場合、ポップアップ表示を試みる
			if(url.match(new RegExp("^.*/.+\\." + ext_list[i] + "($|[#?:].*$)","i"))){
				response({result:true});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var anchor_element = info.anchor_element;
		var content_type = info.content_type;

		// コンテンツタイプに "image" が含まれる
		if(content_type.join(",").match(/image/i)){
			response({result:true});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		// ポップアップ表示しない
		response({result:false});
		return true;
	}.toString() +
"\n]";


				// --------------------------------------------------------------------------------
				// サウンド展開定義
				// --------------------------------------------------------------------------------
				// インライン表示
				updatePreset(proj.expand_sound,"inline",function(obj){
					obj.inline.script_insert = 
"[\n\t" + 
	function(info,response){

		var anchor_element = info.anchor_element;
		var audio = info.element;
		var event_dispatcher = info.event_dispatcher;
		var style = audio.style;
		var width;
		var height;

		// スクロール補正
		var revise_scroll = new DocumentReviseScroll();
		revise_scroll.executeAttachElementBefore(audio);

		// 改行用
		var div_prev = DocumentCreateElement("div");
		var analyze_div_prev = new ElementAnalyzeManager(div_prev,true);
		ElementSetStyle(div_prev,"height:0px;");
		DomNode_InsertAfter(anchor_element,div_prev);

		// オーディオを挿入
		DomNode_InsertAfter(div_prev,audio);

		// 改行用
		var div_next = DocumentCreateElement("div");
		var analyze_div_next = new ElementAnalyzeManager(div_next,true);
		ElementSetStyle(div_next,"height:0px;");
		DomNode_InsertAfter(audio,div_next);

		// サイズを取得
		var bounding_size = ElementGetBoundingClientRect(audio);
		var width  = bounding_size.right  - bounding_size.left;
		var height = bounding_size.bottom  - bounding_size.top;

		// スタイルのサイズを取得
		style.width  = "0px";
		style.height = "0px";
		bounding_size = ElementGetBoundingClientRect(audio);
		var style_w = bounding_size.right  - bounding_size.left;
		var style_h = bounding_size.bottom - bounding_size.top;

		// 親の幅を取得
		var width_max = ElementGetClientWidth(audio.parentNode);

		// エレメントのサイズ
		width  -= style_w;
		height -= style_h;

		// 最大幅補正
		w = width_max - style_w;
		if(w < width){
			width = w;
		}

		// サイズをセット
		style.width  = width  + "px";
		style.height = height + "px";

		// スクロール補正
		revise_scroll.executeAttachElementAfter(audio);

		// 開放時に実行されるイベント
		var event_handler = event_dispatcher.createEventHandler("release");
		event_handler.setFunction(function (result){
			if(analyze_div_prev){
				analyze_div_prev.release();
				analyze_div_prev = null;
			}
			if(analyze_div_next){
				analyze_div_next.release();
				analyze_div_next = null;
			}
			if(event_handler){
				event_handler.release();
				event_handler = null;
			}
		});

		response();
		return false;
	}.toString() +
"\n]";
				});

				// --------------------------------------------------------------------------------
				// ビデオ展開定義
				// --------------------------------------------------------------------------------
				// インライン表示
				updatePreset(proj.expand_video,"inline",function(obj){
					obj.inline.script_insert = 
"[\n\t" + 
	function(info,response){

		var anchor_element = info.anchor_element;
		var video = info.element;
		var event_dispatcher = info.event_dispatcher;
		var style = video.style;
		var width;
		var height;

		// スクロール補正
		var revise_scroll = new DocumentReviseScroll();
		revise_scroll.executeAttachElementBefore(video);

		// 改行用
		var div_prev = DocumentCreateElement("div");
		var analyze_div_prev = new ElementAnalyzeManager(div_prev,true);
		ElementSetStyle(div_prev,"height:0px;");
		DomNode_InsertAfter(anchor_element,div_prev);

		// ビデオを挿入
		DomNode_InsertAfter(div_prev,video);

		// 改行用
		var div_next = DocumentCreateElement("div");
		var analyze_div_next = new ElementAnalyzeManager(div_next,true);
		ElementSetStyle(div_next,"height:0px;");
		DomNode_InsertAfter(video,div_next);

		// サイズを取得
		var bounding_size = ElementGetBoundingClientRect(video);
		var width  = bounding_size.right  - bounding_size.left;
		var height = bounding_size.bottom  - bounding_size.top;

		// スタイルのサイズを取得
		style.width  = "0px";
		style.height = "0px";
		bounding_size = ElementGetBoundingClientRect(video);
		var style_w = bounding_size.right  - bounding_size.left;
		var style_h = bounding_size.bottom - bounding_size.top;

		// 親の幅を取得
		var width_max = ElementGetClientWidth(video.parentNode);

		// エレメントのサイズ
		width  -= style_w;
		height -= style_h;

		// 最大幅補正
		w = width_max - style_w;
		if(w < width){
			height *= w / width;
			width = w;
		}

		// サイズをセット
		style.width  = width  + "px";
		style.height = height + "px";

		// スクロール補正
		revise_scroll.executeAttachElementAfter(video);

		// 開放時に実行されるイベント
		var event_handler = event_dispatcher.createEventHandler("release");
		event_handler.setFunction(function (result){
			if(analyze_div_prev){
				analyze_div_prev.release();
				analyze_div_prev = null;
			}
			if(analyze_div_next){
				analyze_div_next.release();
				analyze_div_next = null;
			}
			if(event_handler){
				event_handler.release();
				event_handler = null;
			}
		});

		response();
		return false;
	}.toString() +
"\n]";
				});

				// --------------------------------------------------------------------------------
				// インラインフレーム展開定義
				// --------------------------------------------------------------------------------
				// Flash のインライン表示
				updatePreset(proj.expand_iframe,"expand_flash_inline",function(obj){
					obj.inline.script_insert = 
"[\n\t" + 
	function(info,response){

		var anchor_element = info.anchor_element;
		var iframe = info.iframe_element;
		var event_dispatcher = info.event_dispatcher;

		// ピクセル値によるサイズ指定
		width  = 640;
		height = 480;

		// スクロール補正
		var revise_scroll = new DocumentReviseScroll();
		revise_scroll.executeAttachElementBefore(iframe);

		// div_dummy を作成
		var div_dummy = DocumentCreateElement("div");
		var analyze_div_dummy = new ElementAnalyzeManager(div_dummy,true);
		ElementSetStyle(div_dummy,ElementGetStyle(iframe));
		DomNode_InsertAfter(anchor_element,div_dummy);

		// 改行を作成
		var div_prev = DocumentCreateElement("div");
		var analyze_div_prev = new ElementAnalyzeManager(div_prev,true);
		ElementSetStyle(div_prev,"height:0px;");
		DomNode_InsertAfter(anchor_element,div_prev);

		// div を挿入
		DomNode_InsertAfter(div_prev,div_dummy);

		// 改行を作成
		var div_next = DocumentCreateElement("div");
		var analyze_div_next = new ElementAnalyzeManager(div_next,true);
		ElementSetStyle(div_next,"height:0px");
		DomNode_InsertAfter(div_dummy,div_next);

		// スタイルのサイズを取得
		div_dummy.style.width  = "0px";
		div_dummy.style.height = "0px";
		var bounding_size = ElementGetBoundingClientRect(div_dummy);
		var style_w = bounding_size.right  - bounding_size.left;
		var style_h = bounding_size.bottom - bounding_size.top;

		// 親の幅を取得
		var width_max = ElementGetClientWidth(div_dummy.parentNode);

		// エレメントのサイズ
		width  -= style_w;
		height -= style_h;

		// 最大幅補正
		w = width_max - style_w;
		if(w < width){
			height *= w / width;
			width = w;
		}

		// サイズをセット
		div_dummy.style.width  = width  + "px";
		div_dummy.style.height = height + "px";
		iframe.style.width  = width  + "px";
		iframe.style.height = height + "px";

		// スクロール補正
		revise_scroll.executeAttachElementAfter(iframe);

		// クリック時に実行されるイベント
		function click_func(e){
			// iframe を挿入
			DomNode_InsertAfter(div_dummy,iframe);
			// div_dummy を解放
			if(analyze_div_dummy){
				analyze_div_dummy.release();
				analyze_div_dummy = null;
			}
		}
		if(div_dummy.addEventListener){
			div_dummy.addEventListener("click",click_func,true);
		}else if(div_dummy.attachEvent){
			div_dummy.attachEvent("onclick",click_func);
		}

		// 開放時に実行されるイベント
		var event_handler = event_dispatcher.createEventHandler("release");
		event_handler.setFunction(function (result){
			if(analyze_div_dummy){
				analyze_div_dummy.release();
				analyze_div_dummy = null;
			}
			if(analyze_div_prev){
				analyze_div_prev.release();
				analyze_div_prev = null;
			}
			if(analyze_div_next){
				analyze_div_next.release();
				analyze_div_next = null;
			}
			if(event_handler){
				event_handler.release();
				event_handler = null;
			}
		});

		response();
		return false;
	}.toString() +
"\n]";
				});

				// PDF のインライン表示
				updatePreset(proj.expand_iframe,"expand_pdf_inline",function(obj){
					obj.inline.script_insert = 
"[\n\t" + 
	function(info,response){

		var anchor_element = info.anchor_element;
		var iframe = info.iframe_element;
		var event_dispatcher = info.event_dispatcher;

		// ピクセル値によるサイズ指定
		width  = 597;
		height = 844;

		// スクロール補正
		var revise_scroll = new DocumentReviseScroll();
		revise_scroll.executeAttachElementBefore(iframe);

		// 改行を作成
		var div_prev = DocumentCreateElement("div");
		var analyze_div_prev = new ElementAnalyzeManager(div_prev,true);
		ElementSetStyle(div_prev,"height:0px;");
		DomNode_InsertAfter(anchor_element,div_prev);

		// iframe を挿入
		DomNode_InsertAfter(div_prev,iframe);

		// 改行を作成
		var div_next = DocumentCreateElement("div");
		var analyze_div_next = new ElementAnalyzeManager(div_next,true);
		ElementSetStyle(div_next,"height:0px");
		DomNode_InsertAfter(iframe,div_next);

		// スタイルのサイズを取得
		iframe.style.width  = "0px";
		iframe.style.height = "0px";
		var bounding_size = ElementGetBoundingClientRect(iframe);
		var style_w = bounding_size.right  - bounding_size.left;
		var style_h = bounding_size.bottom - bounding_size.top;

		// 親の幅を取得
		var width_max = ElementGetClientWidth(iframe.parentNode);

		// エレメントのサイズ
		width  -= style_w;
		height -= style_h;

		// 最大幅補正
		w = width_max - style_w;
		if(w < width){
			width = w;
		}

		// サイズをセット
		iframe.style.width  = width  + "px";
		iframe.style.height = height + "px";

		// スクロール補正
		revise_scroll.executeAttachElementAfter(iframe);

		// 開放時に実行されるイベント
		var event_handler = event_dispatcher.createEventHandler("release");
		event_handler.setFunction(function (result){
			if(analyze_div_prev){
				analyze_div_prev.release();
				analyze_div_prev = null;
			}
			if(analyze_div_next){
				analyze_div_next.release();
				analyze_div_next = null;
			}
			if(event_handler){
				event_handler.release();
				event_handler = null;
			}
		});

		response();
		return false;
	}.toString() +
"\n]";
				});

				// --------------------------------------------------------------------------------
				// URLマッピング設定
				// --------------------------------------------------------------------------------
				// 画像検索サイト
				updatePreset(proj.urlmap,"image_bbs",function(obj){
					obj.expand_image.id = "image_bbs";
				});

			}
			if(exit())	return proj;

			// --------------------------------------------------------------------------------
			// プロジェクト ver.11
			// --------------------------------------------------------------------------------
			if(proj.version < 11){
				// バージョン値
				proj.version = 11;

				// --------------------------------------------------------------------------------
				// エレメント置換定義
				// --------------------------------------------------------------------------------
				createArrayContainer("replacement_to_element");

				// 追加
				update(proj.replacement_to_element,"*",function(obj){
					if(!(obj.name))						obj.name = new Object();
					if(!(obj.name.standard))			obj.name.standard = "";
					if(!(obj.name.locales))				obj.name.locales = new Object();

					if(!(obj.script))	obj.script = "[]";
				});

				// フォントの種類をメイリオに変更
				var obj = addPreset(proj.replacement_to_element,"meiryo_font",null);
				obj.preset = {
					name:{
						standard:"Meiryo Font",
						locales:{
							ja:"フォントの種類をメイリオに変更",
							en:"Meiryo Font"
						}
					},
					script:
"[\n\t" + 
	function(info,response){
		var element = info.element;
		var style = element.style;
		if(style){
			// フォントのサイズ(font-size)
			//style.fontSize = "12px";

			// フォントの太さ(font-weight)
			//style.fontWeight = "bold";

			// フォントの斜体(font-style)
			//style.fontStyle = "italic";

			// フォントの種類(font-family)
			style.fontFamily = "'メイリオ','Meiryo'";

			// 行の高さ(line-height)
			//style.lineHeight = "1.4";
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]"
				};

				// --------------------------------------------------------------------------------
				// エレメント置換定義
				// --------------------------------------------------------------------------------
				// 展開アシスト（画像検索用）
				var obj = addPreset(proj.replacement_to_element,"assist_image_search",null);
				obj.preset = {
					name:{
						standard:"Assist Expand (image search)",
						locales:{
							ja:"展開アシスト（画像検索用）",
							en:"Assist Expand (image search)"
						}
					},
					script:
"[\n\t" + 
	function(info,response){
		var element = info.element;

		if(element.tagName == "A"){

			// NAVER 画像検索
			var org_src = element.getAttribute("src");
			if(org_src){
				if(org_src.indexOf(".search.naver.jp/") >= 0){
					response({url:org_src});
					return true;
				}
			}

			// BIGLOBE 画像検索
			var org_imgsrc = element.getAttribute("org_imgsrc");
			if(org_imgsrc){
				response({url:org_imgsrc});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]"
				};

				// 展開アシスト（ツイッター用）
				var obj = addPreset(proj.replacement_to_element,"assist_twitter",null);
				obj.preset = {
					name:{
						standard:"Assist Expand (twitter)",
						locales:{
							ja:"展開アシスト（ツイッター用）",
							en:"Assist Expand (twitter)"
						}
					},
					script:
"[\n\t" + 
	function(info,response){
		var element = info.element;

		var resolved_url = element.getAttribute("data-resolved-url-large");
		if(resolved_url){
			response({url:resolved_url});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]"
				};

				// 展開アシスト（ピクシブ用）
				var obj = addPreset(proj.replacement_to_element,"assist_pixiv",null);
				obj.preset = {
					name:{
						standard:"Assist Expand (pixiv)",
						locales:{
							ja:"展開アシスト（ピクシブ用）",
							en:"Assist Expand (pixiv)"
						}
					},
					script:
"[\n\t" + 
	function(info,response){
		var element = info.element;

		if(element.tagName != "LI") return false;

		var url = document.URL;
		if(url.indexOf("mode=manga") < 0) return false;

		var query = StringGetQuery(url);
		if(!(query.illust_id)) return false;

		var pos = element.getAttribute("data-position");
		if(!pos) return false;

		var tooltip = element.getAttribute("data-tooltip");
		if(!tooltip) return false;
		
		if(!tooltip.match(/^[0-9]+$/)) return false;

		response({url:"http://www.pixiv.net/member_illust.php?mode=manga_big&illust_id=" + query.illust_id + "&page=" + pos});
		return true;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]"
				};

				// --------------------------------------------------------------------------------
				// アンカー置換定義
				// --------------------------------------------------------------------------------
				// 直リンクに変更（フェイスブック用）
				var obj = addPreset(proj.replacement_to_anchor,"direct_link_facebook","direct_link_realtime_search");
				obj.preset = {
					name:{
						standard:"Direct Link (facebook.com)",
						locales:{
							ja:"直リンクに変更（フェイスブック用）",
							en:"Direct Link (facebook.com)"
						}
					},
					script:
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		var url = anchor_element.href;
		var m = url.match(new RegExp("^(http|https)://[^\\.]+\\.facebook\\.com/l\\.php?","i"));
		if(m){
			var query = StringGetQuery(url);
			if(query["u"]){
				anchor_element.href = unescape(query["u"]);
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]"
				};

				// イベントを無効化（フェイスブック用）
				var obj = addPreset(proj.replacement_to_anchor,"disable_event_facebook","direct_link_twitter");
				obj.preset = {
					name:{
						standard:"Disable Event (facebook)",
						locales:{
							ja:"イベントを無効化（フェイスブック用）",
							en:"Disable Event (facebook)"
						}
					},
					script:
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;
		var parent = anchor_element.parentNode;
		if(parent){
			var m = parent.className.match(new RegExp("(^| )userContent( |$)","i"));
			if(m){
				anchor_element.removeAttribute("onmouseover");
				anchor_element.removeAttribute("onclick");
				anchor_element.onmouseover = null;
				anchor_element.onclick = null;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({});
		return true;
	}.toString() +
"\n]"
				};

				// --------------------------------------------------------------------------------
				// ハイパーリンク置換定義
				// --------------------------------------------------------------------------------
				// 直リンク（汎用）
				updatePreset(proj.replacement_to_link,"direct_link_generic",function(obj){
					var filter = obj.filter;

					// OGP "og:image"
					filter[0].filter.push("*://seiga.nicovideo.jp/watch/bk*");
					filter[0].script = 
"[\n\t" + 
	function(info,response){

		var anchor_element = info.anchor_element;

		// ローダーオブジェクトを作成
		var loader = new Loader();

		// 成功
		loader.onload = function(str){
			if(str.match(new RegExp("<meta[ \n\r\t]+?property[ \n\r\t]*?=[ \n\r\t]*?\"og:image\"[ \n\r\t]+?content[ \n\r\t]*=[ \n\r\t]*\"([^\"]+?)\"","i"))){
				response({result:true,url:RegExp.$1,content_type:["image"]});
				return;
			}
			response({result:false});
		};

		// 失敗
		loader.onerror = function(){
			response({result:false});
		};

		// テキストの読み込み
		loader.setMethod("GET");
		loader.setURL(anchor_element.href);
		loader.loadText();

		return true;
	}.toString() +
"\n]";

					// OGP "twitter:*"
					filter[1].script = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		// ローダーオブジェクトを作成
		var loader = new Loader();

		// 成功
		loader.onload = function(str){

			// twitter:card
			if(str.match(new RegExp("<meta[ \n\r\t]+?name[ \n\r\t]*?=[ \n\r\t]*?\"twitter:card\"[ \n\r\t]+?content[ \n\r\t]*?=[ \n\r\t]*?\"([^\"]+?)\"","i"))){

				switch(RegExp.$1){
				case "player":
					if(str.match(new RegExp("<meta[ \n\r\t]+?name[ \n\r\t]*?=[ \n\r\t]*?\"twitter:player\"[ \n\r\t]+?content[ \n\r\t]*?=[ \n\r\t]*?\"([^\"]+?)\"","i"))){
						var video_url = RegExp.$1.replace(/&amp;/g, "&");
						video_url = video_url.replace(/&amp;/g, "&");
						response({result:true,url:video_url});
						return;
					}

				case "photo":
				case "summary":
					if(str.match(new RegExp("<meta[ \n\r\t]+?name[ \n\r\t]*?=[ \n\r\t]*?\"twitter:image\"[ \n\r\t]+?content[ \n\r\t]*?=[ \n\r\t]*?\"([^\"]+?)\"","i"))){
						var image_url = RegExp.$1.replace(/&amp;/g, "&");
						image_url = image_url.replace(/&amp;/g, "&");
						response({result:true,url:image_url,content_type:["image"]});
						return;
					}

				}
			}

			response({result:false});
		};

		// 失敗
		loader.onerror = function(){
			response({result:false});
		};

		// テキストの読み込み
		loader.setMethod("GET");
		loader.setURL(anchor_element.href);
		loader.loadText();

		return true;
	}.toString() +
"\n]";

					// Facebook Photo
					filter[4].script = 
"[\n\t" + 
	function(info,response){

		var anchor_element = info.anchor_element;

		// ローダーオブジェクトを作成
		var loader = new Loader();

		// 成功
		loader.onload = function(str){
			// 高解像度
			if(str.match(new RegExp("<a.+?class=\"fbPhotosPhotoActionsItem\".+?href=\"([^\"]+?)[?]dl=1\".+?rel=\"ignore\"","i"))){
				response({result:true,url:RegExp.$1});
				return;
			}
			// 中解像度
			if(str.match(new RegExp("<img.+?id=\"fbPhotoImage\".+?src=\"([^\"]+?)\"","i"))){
				response({result:true,url:RegExp.$1});
				return;
			}
			response({result:false});
		};

		// 失敗
		loader.onerror = function(){
			response({result:false});
		};

		// テキストの読み込み
		loader.setMethod("GET");
		loader.setURL(anchor_element.href);
		loader.loadText();

		return true;
	}.toString() +
"\n]";

					// Tumblr
					filter[7].script = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		// ローダーオブジェクトを作成
		var loader = new Loader();

		// 成功
		loader.onload = function(str){
			// photo
			if(str.match(new RegExp("<meta[ \n\r\t]+?property[ \n\r\t]*?=[ \n\r\t]*?\"og:image\"[ \n\r\t]+?content[ \n\r\t]*?=[ \n\r\t]*?\"([^\"]+?)\"","i"))){
				var m = RegExp.$1.match(new RegExp("^.*\/(tumblr_.*)_[0-9]+\\..*?$","i"));
				if(m){
					var file_name = RegExp.$1;
					var image_url;
					var size = 0;
					str.replace(new RegExp("\"(http:\/\/[^\"]*?\/" + file_name + "_)([0-9]+)(\\..*?)\"","gi"),function(str, p1, p2) {
						var s = parseInt(RegExp.$2);
						if(s > size){
							size = s;
							image_url = RegExp.$1 + RegExp.$2 + RegExp.$3;
						}
					});

					response({result:true,url:image_url,content_type:["image"]});
					return;
				}

			}

			// player
			if(str.match(new RegExp("<meta[ \n\r\t]+?name[ \n\r\t]*?=[ \n\r\t]*?\"twitter:player\"[ \n\r\t]+?content[ \n\r\t]*?=[ \n\r\t]*?\"([^\"]+?)\"","i"))){
				var video_url = RegExp.$1.replace(/&amp;/g, "&");
				video_url = video_url.replace(/&amp;/g, "&");
				response({result:true,url:video_url});
				return;
			}

			response({result:false});
		};

		// 失敗
		loader.onerror = function(){
			response({result:false});
		};

		// テキストの読み込み
		loader.setMethod("GET");
		loader.setURL(anchor_element.href);
		loader.loadText();

		return true;
	}.toString() +
"\n]";

					// ついっぷる
					filter[11].script = 
"[\n\t" + 
	function(info,response){

		var anchor_element = info.anchor_element;

		// ローダーオブジェクトを作成
		var loader = new Loader();

		// 成功
		loader.onload = function(str){
			if(str.match(new RegExp("<meta[ \n\r\t]+?property[ \n\r\t]*?=[ \n\r\t]*?\"og:image\"[ \n\r\t]+?content[ \n\r\t]*?=[ \n\r\t]*?\"([^\"]+?)\"","i"))){
				var image_url = RegExp.$1;
				var m = image_url.match(new RegExp("thumb","i"));
				if(m){
					image_url = RegExp.leftContext + "orig" + RegExp.rightContext;
				}

				response({result:true,url:image_url,content_type:["image"]});
				return;
			}
			response({result:false});
		};

		// 失敗
		loader.onerror = function(){
			response({result:false});
		};

		// テキストの読み込み
		loader.setMethod("GET");
		loader.setURL(anchor_element.href);
		loader.loadText();

		return true;
	}.toString() +
"\n]";

					// blog.fc2.com
					filter.splice(13,0,{
						name:{
							standard:"blog.fc2.com",
							locales:{
								ja:"FC2ブログ Photo",
								en:"blog.fc2.com"
							}
						},
						filter:[
							"http://*.blog.fc2.com/img/*/"
						],
						enable_reflect_to_anchor:false,
						enable_cache:true,
						script:
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;
		if(anchor_element.href.match("^(http|https)://[a-z0-9]+?\\.blog\\.fc2\\.com/img/.+?./$","i")){
			// ローダーオブジェクトを作成
			var loader = new Loader();

			// 成功
			loader.onload = function(str){
				var m = str.match(new RegExp("<a href=\"(http://blog[-]imgs[-][0-9]+?\\.fc2\\.com/./././[a-z0-9_]+?/.+?)\" class=\"thickbox\">","i"));
				if(m){
					var image_url = m[1];
					response({result:true,url:image_url,content_type:["image"]});
					return;
				}
				response({result:false});
			};

			// 失敗
			loader.onerror = function(){
				response({result:false});
			};

			// テキストの読み込み
			loader.setMethod("GET");
			loader.setURL(anchor_element.href);
			loader.loadText();

			return true;
		}
		
		return false;
	}.toString() +
"\n]"
					});

					// Miiverse
					filter.splice(16,0,{
						name:{
							standard:"Miiverse",
							locales:{
								ja:"Miiverse",
								en:"Miiverse"
							}
						},
						filter:[
							"*://miiverse.nintendo.net/posts/*"
						],
						enable_reflect_to_anchor:false,
						enable_cache:true,
						script:
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		// ローダーオブジェクトを作成
		var loader = new Loader();

		// 成功
		loader.onload = function(str){
			var image_url;
			var m;
			if(!image_url){
				m = str.match(new RegExp("<img src=\"(https://.+?\\.cloudfront\\.net/pap/.+?)\" class=\"post-memo\">","i"));
				if(m){
					image_url = m[1];
				}
			}
			if(!image_url){
				m = str.match(new RegExp("<div class=\"screenshot-container\"><img src=\"(https://.+?\\.cloudfront\\.net/ss/.+?)\">","i"));
				if(m){
					image_url = m[1];
				}
			}
			if(image_url){
				response({result:true,url:image_url,content_type:["image"]});
				return;
			}
			response({result:false});
		};

		// 失敗
		loader.onerror = function(){
			response({result:false});
		};

		// テキストの読み込み
		loader.setMethod("GET");
		loader.setURL(anchor_element.href);
		loader.loadText();

		return false;
	}.toString() +
"\n]"
					});

					// ピクシブ
					filter[15].script = 
"[\n\t" + 
	function (info,response){

		var anchor_element = info.anchor_element;

		var url = anchor_element.href;
		var query = StringGetQuery(url);

		// PC用ドメインに変更
		var m = url.match(new RegExp("(http|https)(://)([^\\.]+)(\\.pixiv\\.net/.*)","i"));
		if(m){
			url = m[1] + m[2] + "www" + m[4];
		}

		// ローダーオブジェクトを作成
		var loader = new Loader();

		// マンガの取得
		if((query["mode"] == "manga_big") && (query["page"])){

			// 成功
			loader.onload = function(str){

				// ログイン時
				var m = str.match(new RegExp("<body><img src=\"([^\"]+)\"","i"));
				if(m){
					response({result:true,url:m[1],content_type:["image"]});
					return;
				}

				// 非ログイン時
				var m = str.match(new RegExp("pixiv\\.context\\.images\\[" + query["page"] + "\\] = '([^']+)';","i"));
				if(m){
					m = m[1].match("(.*)(_p[0-9]+\\.[a-z]+)$","i");
					if(m){
						response({result:true,url:m[1] + "_big" + m[2],content_type:["image"]});
						return;
					}
				}

				response({result:false});
			};

		}else{
			// モードを medium に変更
			var m = url.match(new RegExp("mode=([a-z]+)","i"));
			if(m){
				url = RegExp.leftContext + "mode=medium" + RegExp.rightContext;
			}

			// 成功
			loader.onload = function(str){

				var m = str.match(new RegExp("<div class=\"(img-container|front-centered|works_display)\">.*","i"));
				if(m){
					m = m[0].match(new RegExp("<a href=\"([^\"]+)\".*","i"));
					if(m){
						var link_url = m[1];
						var image_url = "";

						m = m[0].match(new RegExp("<img src=\"([^\"]+)\"","i"));
						if(m){
							image_url = m[1];
						}

						// マンガ以外
						if(link_url.indexOf("mode=manga") == -1){

							// 高解像度画像
							var m = image_url.match(new RegExp("^(.*)_m(\\.[a-z]+)$","i"));
							if(m){
								image_url = m[1] + m[2];
							}
						}

						if(image_url){
							response({result:true,url:image_url,content_type:["image"]});
							return;
						}
					}
				}
				response({result:false});
			};
		}

		// 失敗
		loader.onerror = function(){
			response({result:false});
		};

		// テキストの読み込み
		loader.setMethod("GET");
		loader.setURL(url);
		loader.loadText();

		return true;
	}.toString() +
"\n]";
				});

				// イメージ検索用
				updatePreset(proj.replacement_to_link,"direct_link_image_search",function(obj){
					var filter = obj.filter;

					// Google 画像検索
					filter[0].script = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		var url = anchor_element.href;
		var r = new RegExp("^(http|https)://.*?\\.google\\.(at|be|ca|ch|de|es|fr|it|nl|no|pl|ru|se|co\\.(id|in|jp|th|uk|za)|com|com\\.(ar|au|br|mx|sa|tr|tw))/imgres[?].*","i");
		if(url.match(r)){
			// クエリを取得
			var query = StringGetQuery(url);
			if(query.imgurl){
				response({result:true,url:unescape(unescape(query.imgurl)),content_type:["image"]});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({result:false});
		return true;
	}.toString() +
"\n]";

					// Yahoo Image Search
					filter[1].script = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		var url = anchor_element.href;
		var r = new RegExp("(image|images)\\.search\\.yahoo\\.com/images/view;.*","i");
		if(url.match(r)){
			// クエリを取得
			var query = StringGetQuery(url);
			if(query.imgurl){
				response({result:true,url:"http://" + unescape(query.imgurl),content_type:["image"]});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({result:false});
		return true;
	}.toString() +
"\n]";

					// Yahoo! JAPAN 画像検索
					filter[2].script = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		var url = anchor_element.href;
		var r = new RegExp("^(http|https)://ord\\.yahoo\\.co\\.jp/o/image/.*/[*][-](.*)$","i");
		if(url.match(r)){
			response({result:true,url:decodeURIComponent(RegExp.$2),content_type:["image"]});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({result:false});
		return true;
	}.toString() +
"\n]";

					// yahoo.cn
					filter[3].script = 
"[\n\t" + 
	function(info,response){

		var anchor_element = info.anchor_element;

		// 画像を取得
		var images = ElementGetElementsByTagName(anchor_element,"img");
		if(images.length == 1){

			var str = anchor_element.getAttribute("onmousedown");
			if(str){
				if(str.match(new RegExp("'img_src':'(.*?)'","i"))){
					response({result:true,url:RegExp.$1,content_type:["image"]});
					return true;
				}
			}

		}

		response({result:false});
		return true;
	}.toString() +
"\n]";

					// Bing 画像検索
					filter[4].script = 
"[\n\t" + 
	function (info,response){
		var anchor_element = info.anchor_element;

		var url = anchor_element.href;
		var r = new RegExp("^(http|https)://www\\.bing\\.com/images/search[?].*","i");
		if(url.match(r)){
			// 画像を取得
			var images = ElementGetElementsByTagName(anchor_element,"img");
			if(images.length){
				var image_url;

				try{
					// クエリを取得
					var query = StringGetQuery(images[0].src);
					if(query.url){
						image_url = unescape(query.url);
					}
				}catch(e){}

				try{
					// m 属性を取得
					var span = anchor_element.parentNode.parentNode;
					var m = span.getAttribute("m");
					if(!m)	m = span.getAttribute("_pageexpand_m");
					if(m.match(new RegExp("imgurl:\"(.*?)\"","i"))){
						image_url = RegExp.$1;
					}
				}catch(e){}

				try{
					// m 属性を取得
					var m = anchor_element.getAttribute("m");
					if(!m)	m = span.getAttribute("_pageexpand_m");
					if(m.match(new RegExp("oi:\"(.*?)\"","i"))){
						image_url = RegExp.$1;
					}
				}catch(e){}

				if(image_url){
					response({result:true,url:image_url,content_type:["image"]});
					return true;
				}
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		var anchor_element = info.anchor_element;

		var div = anchor_element.parentNode;
		if(div.className != "dg_u"){
			return false;
		}

		// ローダーオブジェクトを作成
		var loader = new Loader();

		// 成功
		loader.onload = function(str){
			if(str.match(new RegExp("<a[ ]+?id=\"m_fsi\"[ ]+?href=\"(.*?)\"","i"))){
				response({result:true,url:RegExp.$1,content_type:["image"]});
				return;
			}
			response({result:false});
		};

		// 失敗
		loader.onerror = function(){
			response({result:false});
		};

		// テキストの読み込み
		loader.setMethod("GET");
		loader.setURL(anchor_element.href);
		loader.loadText();

		return true;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		response({result:false});
		return true;
	}.toString() +
"\n]";

					// Ask 画像検索
					filter[5].script = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		// クエリを取得
		var query = StringGetQuery(anchor_element.href);
		if(query.ftURI){
			query = StringGetQuery(decodeURIComponent(query.ftURI));
			if(query.imagesrc){
				response({result:true,url:unescape(decodeURIComponent(query.imagesrc)),content_type:["image"]});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({result:false});
		return true;
	}.toString() +
"\n]";

					// AOL 画像検索
					filter[6].script = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		// クエリを取得
		var query = StringGetQuery(anchor_element.href);
		if(query.img){
			response({result:true,url:unescape(query.img),content_type:["image"]});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({result:false});
		return true;
	}.toString() +
"\n]";

					// Yandex 画像検索
					filter[7].script = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		var url = anchor_element.href;
		var r = new RegExp("images.yandex.(com|ru)/yandsearch[?]","i");
		if(url.match(r)){
			// クエリを取得
			var query = StringGetQuery(url);
			if(query.img_url){
				var image_url = decodeURIComponent(query.img_url);
				if(image_url.indexOf("http") != 0){
					image_url = "http://" + image_url;
				}
				response({result:true,url:image_url,content_type:["image"]});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({result:false});
		return true;
	}.toString() +
"\n]";

					// goo 画像検索
					filter[8].script = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		// クエリを取得
		var query = StringGetQuery(anchor_element.href);
		if(query.DOC_ID){
			response({result:true,url:"http://" + decodeURIComponent(query.DOC_ID).replace(/%2f/ig,"/"),content_type:["image"]});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({result:false});
		return true;
	}.toString() +
"\n]";

					// Baidu.jp
					filter[10].script = 
"[\n\t" + 
	function(info,response){

		var anchor_element = info.anchor_element;
		var url = anchor_element.href.replace(/(tn=).*?($|&)/i,"$1baiduimagejson$2");

		// ローダーオブジェクトを作成
		var loader = new Loader();

		// 成功
		loader.onload = function(str){
			try{
				var obj = JsonParse(str);
				var url = obj.data[0].objUrl;

				response({result:true,url:url,content_type:["image"]});
				return;
			}catch(e){
			}

			response({result:false});
		};

		// 失敗
		loader.onerror = function(){
			response({result:false});
		};

		// テキストの読み込み
		loader.setMethod("GET");
		loader.setURL(url);
		loader.loadText();

		return true;
	}.toString() +
"\n]";

					// NAVER 画像検索
					filter[11].script = 
"[\n\t" + 
	function(info,response){

		var anchor_element = info.anchor_element;
		// 画像を取得
		var images = ElementGetElementsByTagName(anchor_element,"img");
		if(images.length == 1){
			var image = images[0];
			if(image.src.match(new RegExp("search\\.naver\\.net/ugc[?]","i"))){
				// クエリを取得
				var query = StringGetQuery(image.src);
				if(query.q){
					response({result:true,url:query.q,content_type:["image"]});
					return true;
				}
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({result:false});
		return true;
	}.toString() +
"\n]";

					// naver.jp
					filter[12].filter = [
						"http://*search.naver.jp/jthumb?*",
						"http://*search.naver.jp/jdanmi?*"
					];
					filter[12].enable_cache = true;
					filter[12].script = 
"[\n\t" + 
	function(info,response){

		var anchor_element = info.anchor_element;

		// クエリを取得
		var query = StringGetQuery(anchor_element.href);
		if(query.q){
			response({result:true,url:query.q,content_type:["image"]});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		response({result:false});
		return true;
	}.toString() +
"\n]";
				});

				// ウィキペディア用
				updatePreset(proj.replacement_to_link,"direct_link_wikipedia",function(obj){
					var filter = obj.filter;

					filter[0].script = 
"[\n\t" + 
	function(info,response){
		var anchor_element = info.anchor_element;

		var ext_list = [
			"jpg",
			"jpeg",
			"png",
			"gif",
			"svg",
			"ogg"
		];

		var i;
		var num = ext_list.length;
		for(i=0;i<num;i++){
			if(anchor_element.href.match(new RegExp("^.*/.+:.+\\." + ext_list[i] + "($|&|[?])","i"))){
				break;
			}
		}
		if(i != num){
			// ローダーオブジェクトを作成
			var loader = new Loader();

			// 成功
			loader.onload = function(str){
				// audio
				if(str.match(new RegExp("<div[ ]class=\"fullImageLink\".*?<audio[ ].*?<source.*?src=\"(.*?)\"","i"))){
					response({result:true,url:RegExp.$1});
					return;
				}

				// svg
				if(str.match(new RegExp("<div[ ]class=\"fullImageLink\".*?<a href=\".*?\\.svg\".*?<img.*?src=\"(.*?)\"","i"))){
					response({result:true,url:RegExp.$1,content_type:["image"]});
					return;
				}

				// 高解像度画像
				if(str.match(new RegExp("<div[ ]class=\"fullImageLink\".*?<a href=\"(.*?)\"","i"))){
					response({result:true,url:RegExp.$1,content_type:["image"]});
					return;
				}

				response({result:false});
			};

			// 失敗
			loader.onerror = function(){
				response({result:false});
			};

			// テキストの読み込み
			loader.setMethod("GET");
			loader.setURL(anchor_element.href);
			loader.loadText();
		}

		return true;
	}.toString() +
"\n]";

					filter = filter[0].filter;
					filter.push("*://*.m.wikipedia.org/wiki/*:*");
					filter.push("*://*.m.wikipedia.org/w/*:*");
					filter.push("*://*.m.wikimedia.org/wiki/*:*");
					filter.push("*://*.m.wikimedia.org/w/*:*");
				});

				// --------------------------------------------------------------------------------
				// 短縮 URL 展開
				// --------------------------------------------------------------------------------
				// 簡易
				var obj = getPreset(proj.expand_short_url,"simple");
				obj.filter.splice(12,3);
				obj.filter.push("http://dlvr.it/*");
				obj.filter.push("http://is.gd/*");
				obj.filter.push("http://ht.ly/*");
				obj.filter.push("http://lnk.ms/*");
				obj.filter.push("http://po.st/*");
				obj.filter.push("http://htn.to/*");
				obj.filter.push("http://r.sm3.jp/*");
				obj.filter.push("http://cot.ag/*");
				obj.filter.push("http://to.ly/*");
				obj.filter.push("http://ux.nu/*");
				obj.filter.push("http://qurl.com/*");
				obj.filter.push("http://tr.im/*");
				obj.filter.push("http://spr.ly/*");
				obj.filter.push("http://buff.ly/*");

				// 詳細
				var obj = getPreset(proj.expand_short_url,"detail");
				obj.filter.splice(59,1);
				obj.filter.splice(54,4);
				obj.filter.splice(52,1);
				obj.filter.splice(47,1);
				obj.filter.splice(42,1);
				obj.filter.splice(38,1);
				obj.filter.splice(33,1);
				obj.filter.splice(28,2);
				obj.filter.splice(23,1);
				obj.filter.splice(12,1);
				obj.filter.push("http://spr.ly/*");
				obj.filter.push("http://buff.ly/*");
				obj.filter.push("http://amba.to/*");
				obj.filter.push("http://nico.ms/*");
				obj.filter.push("http://yhoo.it/*");
				obj.filter.push("http://shar.es/*");
				obj.filter.push("http://feedly.com/k/*");
				obj.filter.push("http://wp.me/*");
				obj.filter.push("http://migre.me/*");
				obj.filter.push("http://flip.it/*");

				// --------------------------------------------------------------------------------
				// イメージ展開定義
				// --------------------------------------------------------------------------------
				// 「サムネイル表示」を破棄
				removePreset("expand_image","thumbnail");

				// 「ポップアップ表示」を破棄
				removePreset("expand_image","popup");

				// 追加
				update(proj.expand_image,"*",function(obj){
					if(!(obj.popup.scale_percent))	obj.popup.scale_percent = 100;
				});

				// ポップアップ表示（すべてのリンク）
				var obj = addPreset(proj.expand_image,"popup_all","image_bbs");
				obj.preset = {
					name:{
						standard:"Popup (all)",
						locales:{
							ja:"ポップアップ表示（すべてのリンク）",
							en:"Popup (all)"
						}
					},
					thumbnail:{
						enable_popup_mouseover:true,
						disable_same_image:false,
						load_type:"preload",
						script_allow:"[]",
						script_insert:"[]"
					},
					popup:{
						origin_type:"center",
						position_type:"absolute",
						time_wait_open:0,
						time_wait_close:0,
						enable_animation_scale:true,
						enable_animation_alpha:true,
						load_type:"preload",
						scale_percent:100,
						script_allow:"[]"
					},
					reduced_image:{
						enable_popup:true,
						popup_allow_slcale_less_then:70
					},
					load:{
						enable_notify:true,
						enable_unload:false,
						unload_allow_size_more_then:256
					}
				};

				obj.preset.thumbnail.script_allow =
"[\n\t" + 
	function(info,response){
		// サムネイル表示しない
		response({result:false});
		return true;
	}.toString() +
"\n]";

				obj.preset.popup.script_allow = 
"[\n\t" + 
	function(info,response){
		var current_element = info.current_element;
		var url = info.url;

		var ext_list = [
			"bmp",
			"gif",
			"jpg",
			"jpe",
			"jpeg",
			"png"
		];

		var i;
		var num = ext_list.length;
		for(i=0;i<num;i++){
			// URL が画像の拡張子である場合、ポップアップ表示を試みる
			if(url.match(new RegExp("^.*/.+\\." + ext_list[i] + "($|[#?:].*$)","i"))){
				response({result:true});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var current_element = info.current_element;
		var content_type = info.content_type;

		// コンテンツタイプに "image" が含まれる
		if(content_type.join(",").match(/image/i)){
			response({result:true});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		// ポップアップ表示しない
		response({result:false});
		return true;
	}.toString() +
"\n]";

				// ポップアップ表示（画像を含むリンク）
				var obj = addPreset(proj.expand_image,"popup_include_image","image_bbs");
				obj.preset = {
					name:{
						standard:"Popup (include image)",
						locales:{
							ja:"ポップアップ表示（画像を含むリンク）",
							en:"Popup (include image)"
						}
					},
					thumbnail:{
						enable_popup_mouseover:true,
						disable_same_image:false,
						load_type:"preload",
						script_allow:"[]",
						script_insert:"[]"
					},
					popup:{
						origin_type:"center",
						position_type:"absolute",
						time_wait_open:0,
						time_wait_close:0,
						enable_animation_scale:true,
						enable_animation_alpha:true,
						load_type:"preload",
						scale_percent:100,
						script_allow:"[]"
					},
					reduced_image:{
						enable_popup:true,
						popup_allow_slcale_less_then:70
					},
					load:{
						enable_notify:true,
						enable_unload:false,
						unload_allow_size_more_then:256
					}
				};

				obj.preset.thumbnail.script_allow =
"[\n\t" + 
	function(info,response){
		// サムネイル表示しない
		response({result:false});
		return true;
	}.toString() +
"\n]";

				obj.preset.popup.script_allow = 
"[\n\t" + 
	function(info,response){
		var current_element = info.current_element;
		var result = (function(){

			// イメージ要素を含む
			var nodes = ElementGetElementsByTagName(current_element,"img");
			if(nodes.length){
				return true;
			}

			// バックグラウンドイメージを含む
			var nodes = ElementGetElementsByTagName(current_element,"*");
			var i;
			var num = nodes.length;
			for(i=0;i<num;i++){
				var style = ElementGetComputedStyle(nodes[i],null);
				if(style){
					if(style.backgroundImage != "none"){
						return true;
					}
				}
			}

			return false;
		})();

		if(result) return false;

		response({result:false});
		return true;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var current_element = info.current_element;
		var url = info.url;

		var ext_list = [
			"bmp",
			"gif",
			"jpg",
			"jpe",
			"jpeg",
			"png"
		];

		var i;
		var num = ext_list.length;
		for(i=0;i<num;i++){
			// URL が画像の拡張子である場合、ポップアップ表示を試みる
			if(url.match(new RegExp("^.*/.+\\." + ext_list[i] + "($|[#?:].*$)","i"))){
				response({result:true});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var current_element = info.current_element;
		var content_type = info.content_type;

		// コンテンツタイプに "image" が含まれる
		if(content_type.join(",").match(/image/i)){
			response({result:true});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		// ポップアップ表示しない
		response({result:false});
		return true;
	}.toString() +
"\n]";

				// サムネイル表示（すべて）
				var obj = addPreset(proj.expand_image,"thumbnail_all","image_bbs");
				obj.preset = {
					name:{
						standard:"Thumbnail (all)",
						locales:{
							ja:"サムネイル表示（すべてのリンク）",
							en:"Thumbnail (all)"
						}
					},
					thumbnail:{
						enable_popup_mouseover:true,
						disable_same_image:false,
						load_type:"preload",
						script_allow:"[]",
						script_insert:"[]"
					},
					popup:{
						origin_type:"center",
						position_type:"absolute",
						time_wait_open:0,
						time_wait_close:0,
						enable_animation_scale:true,
						enable_animation_alpha:true,
						load_type:"preload",
						scale_percent:100,
						script_allow:"[]"
					},
					reduced_image:{
						enable_popup:true,
						popup_allow_slcale_less_then:70
					},
					load:{
						enable_notify:true,
						enable_unload:false,
						unload_allow_size_more_then:256
					}
				};

				obj.preset.thumbnail.script_allow = 
"[\n\t" + 
	function(info,response){
		var current_element = info.current_element;
		var parent = current_element.parentNode;
		if(parent){
			var width = ElementGetClientWidth(parent);

			// 親の幅が小さすぎる場合サムネイル化しない
			if(width < 50){
				response({result:false});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var current_element = info.current_element;
		var url = info.url;

		var ext_list = [
			"bmp",
			"gif",
			"jpg",
			"jpe",
			"jpeg",
			"png"
		];

		var i;
		var num = ext_list.length;
		for(i=0;i<num;i++){
			// URL が画像の拡張子である場合、サムネイル表示を試みる
			if(url.match(new RegExp("^.*/.+\\." + ext_list[i] + "($|[#?:].*$)","i"))){
				response({result:true});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var current_element = info.current_element;
		var content_type = info.content_type;

		// コンテンツタイプに "image" が含まれる
		if(content_type.join(",").match(/image/i)){
			response({result:true});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		// サムネイル表示しない
		response({result:false});
		return true;
	}.toString() +
"\n]";

				obj.preset.popup.script_allow =
"[\n\t" + 
	function(info,response){
		// ポップアップ表示しない
		response({result:false});
		return true;
	}.toString() +
"\n]";

				// サムネイル表示（画像を含まないリンク）
				var obj = addPreset(proj.expand_image,"thumbnail_not_include_image","image_bbs");
				obj.preset = {
					name:{
						standard:"Thumbnail (not include image)",
						locales:{
							ja:"サムネイル表示（画像を含まないリンク）",
							en:"Thumbnail (not include image)"
						}
					},
					thumbnail:{
						enable_popup_mouseover:true,
						disable_same_image:false,
						load_type:"preload",
						script_allow:"[]",
						script_insert:"[]"
					},
					popup:{
						origin_type:"center",
						position_type:"absolute",
						time_wait_open:0,
						time_wait_close:0,
						enable_animation_scale:true,
						enable_animation_alpha:true,
						load_type:"preload",
						scale_percent:100,
						script_allow:"[]"
					},
					reduced_image:{
						enable_popup:true,
						popup_allow_slcale_less_then:70
					},
					load:{
						enable_notify:true,
						enable_unload:false,
						unload_allow_size_more_then:256
					}
				};

				obj.preset.thumbnail.script_allow = 
"[\n\t" + 
	function(info,response){
		var current_element = info.current_element;
		var parent = current_element.parentNode;
		if(parent){
			var width = ElementGetClientWidth(parent);

			// 親の幅が小さすぎる場合サムネイル化しない
			if(width < 50){
				response({result:false});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var current_element = info.current_element;
		var result = (function(){

			// イメージ要素を含む
			var nodes = ElementGetElementsByTagName(current_element,"img");
			if(nodes.length){
				return false;
			}

			// バックグラウンドイメージを含む
			var nodes = ElementGetElementsByTagName(current_element,"*");
			var i;
			var num = nodes.length;
			for(i=0;i<num;i++){
				var style = ElementGetComputedStyle(nodes[i],null);
				if(style){
					if(style.backgroundImage != "none"){
						return false;
					}
				}
			}

			// 子が無い
			if(!(current_element.childNodes.length)){
				return false;
			}

			return true;
		})();

		if(!result){
			response({result:false});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var current_element = info.current_element;
		var url = info.url;

		var ext_list = [
			"bmp",
			"gif",
			"jpg",
			"jpe",
			"jpeg",
			"png"
		];

		var i;
		var num = ext_list.length;
		for(i=0;i<num;i++){
			// URL が画像の拡張子である場合、サムネイル表示を試みる
			if(url.match(new RegExp("^.*/.+\\." + ext_list[i] + "($|[#?:].*$)","i"))){
				response({result:true});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var current_element = info.current_element;
		var content_type = info.content_type;

		// コンテンツタイプに "image" が含まれる
		if(content_type.join(",").match(/image/i)){
			response({result:true});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		// サムネイル表示しない
		response({result:false});
		return true;
	}.toString() +
"\n]";

				obj.preset.popup.script_allow =
"[\n\t" + 
	function(info,response){
		// ポップアップ表示しない
		response({result:false});
		return true;
	}.toString() +
"\n]";

				// ツイッター用
				var obj = addPreset(proj.expand_image,"twitter",null);
				obj.preset = {
					name:{
						standard:"For twitter",
						locales:{
							ja:"ツイッター用",
							en:"For twitter"
						}
					},
					thumbnail:{
						enable_popup_mouseover:true,
						disable_same_image:false,
						load_type:"preload",
						script_allow:"[]",
						script_insert:"[]"
					},
					popup:{
						origin_type:"center",
						position_type:"absolute",
						time_wait_open:0,
						time_wait_close:0,
						enable_animation_scale:true,
						enable_animation_alpha:true,
						load_type:"preload",
						scale_percent:100,
						script_allow:"[]"
					},
					reduced_image:{
						enable_popup:true,
						popup_allow_slcale_less_then:70
					},
					load:{
						enable_notify:true,
						enable_unload:false,
						unload_allow_size_more_then:256
					}
				};

				obj.preset.thumbnail.script_allow = 
"[\n\t" + 
	function(info,response){
		var current_element = info.current_element;
		var url = info.url;

		var result = (function(){
			var node = current_element.parentNode;
			if(!node) return false;
			if(node.tagName != "P") return false;

			var m = node.className.match(new RegExp("(^| )tweet-text( |$)","i"));
			if(!m) return false;

			var anchor_count = 0;
			var nodes = ElementGetElementsByTagName(node,"a");
			var i;
			var num = nodes.length;
			for(i=0;i<num;i++){
				if(nodes[i].getAttribute("data-expanded-url")){
					anchor_count ++;
					if(anchor_count > 1) return true;
				}
			}

			node = node.nextSibling;
			while(node){
				if(node.nodeType == 1){
					var m = node.className.match(new RegExp("(^| )(cards-media-container|permalink-footer)( |$)","i"));
					if(m){
						var nodes = ElementGetElementsByTagName(node,"img");
						if(nodes.length){
							return false;
						}
					}
				}
				node = node.nextSibling;
			}

			return true;
		})();

		if(result) return false;

		response({result:false});
		return true;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var current_element = info.current_element;
		var parent = current_element.parentNode;
		if(parent){
			var width = ElementGetClientWidth(parent);

			// 親の幅が小さすぎる場合サムネイル化しない
			if(width < 50){
				response({result:false});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var current_element = info.current_element;
		var result = (function(){

			// イメージ要素を含む
			var nodes = ElementGetElementsByTagName(current_element,"img");
			if(nodes.length){
				return false;
			}

			// バックグラウンドイメージを含む
			var nodes = ElementGetElementsByTagName(current_element,"*");
			var i;
			var num = nodes.length;
			for(i=0;i<num;i++){
				var style = ElementGetComputedStyle(nodes[i],null);
				if(style){
					if(style.backgroundImage != "none"){
						return false;
					}
				}
			}

			// 子が無い
			if(!(current_element.childNodes.length)){
				return false;
			}

			return true;
		})();

		if(!result){
			response({result:false});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var current_element = info.current_element;
		var url = info.url;

		var ext_list = [
			"bmp",
			"gif",
			"jpg",
			"jpe",
			"jpeg",
			"png"
		];

		var i;
		var num = ext_list.length;
		for(i=0;i<num;i++){
			// URL が画像の拡張子である場合、サムネイル表示を試みる
			if(url.match(new RegExp("^.*/.+\\." + ext_list[i] + "($|[#?:].*$)","i"))){
				response({result:true});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var current_element = info.current_element;
		var content_type = info.content_type;

		// コンテンツタイプに "image" が含まれる
		if(content_type.join(",").match(/image/i)){
			response({result:true});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		// サムネイル表示しない
		response({result:false});
		return true;
	}.toString() +
"\n]";

				obj.preset.popup.script_allow =
"[\n\t" + 
	function(info,response){
		var current_element = info.current_element;
		var result = (function(){
			var node = current_element.parentNode;
			while(node){
				if(!(node.className)) break;

				var m = node.className.match(new RegExp("(^| )stream-media-grid-items( |$)","i"));
				if(m){
					return true;
				}

				// イメージ要素を含む
				var nodes = ElementGetElementsByTagName(current_element,"img");
				if(nodes.length){
					return true;
				}

				// バックグラウンドイメージを含む
				var nodes = ElementGetElementsByTagName(current_element,"*");
				var i;
				var num = nodes.length;
				for(i=0;i<num;i++){
					var style = ElementGetComputedStyle(nodes[i],null);
					if(style){
						if(style.backgroundImage != "none"){
							return true;
						}
					}
				}

				node = node.parentNode;
			}

			return false;
		})();

		if(result){
			return false;
		}

		response({result:false});
		return true;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var current_element = info.current_element;
		var url = info.url;

		var ext_list = [
			"bmp",
			"gif",
			"jpg",
			"jpe",
			"jpeg",
			"png"
		];

		var i;
		var num = ext_list.length;
		for(i=0;i<num;i++){
			// URL が画像の拡張子である場合、ポップアップ表示を試みる
			if(url.match(new RegExp("^.*/.+\\." + ext_list[i] + "($|[#?:].*$)","i"))){
				response({result:true});
				return true;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		var current_element = info.current_element;
		var content_type = info.content_type;

		// コンテンツタイプに "image" が含まれる
		if(content_type.join(",").match(/image/i)){
			response({result:true});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function(info,response){
		// ポップアップ表示しない
		response({result:false});
		return true;
	}.toString() +
"\n]";

				// サムネイル挿入
				updatePreset(proj.expand_image,"*",function(obj){
					obj.thumbnail.script_insert = 
"[\n\t" + 
	function(info,response){

		var current_element = info.current_element;
		var image = info.image_element;
		var event_dispatcher = info.event_dispatcher;
		var style = image.style;
		var width;
		var height;

		// 開放時に実行される関数
		function release(){
			DomNodeRemove(image);

			if(analyze_div_prev){
				analyze_div_prev.release();
				analyze_div_prev = null;
			}
			if(analyze_div_next){
				analyze_div_next.release();
				analyze_div_next = null;
			}
			if(event_handler){
				event_handler.release();
				event_handler = null;
			}
		}

		// スクロール補正
		var revise_scroll = new DocumentReviseScroll();
		revise_scroll.executeAttachElementBefore(image);

		// デフォルトの画像サイズを取得
		var natural_size = ImageGetNaturalSize(image);


		// サムネイルの最小サイズ
		var width_min  = 50;
		var height_min = 50;

		// サムネイルの最大サイズ
		var width_max  = 300;
		var height_max = 300;

		// ピクセル値によるサイズ指定
		//width  = 200;
		//height = 200;

		// パーセントによるサイズ指定
		var percent = 20;
		width  = natural_size.width  / 100 * percent;
		height = natural_size.height / 100 * percent;


		// 改行を作成
		var div_prev = DocumentCreateElement("div");
		var analyze_div_prev = new ElementAnalyzeManager(div_prev,true);
		ElementSetStyle(div_prev,"height:0px;");
		DomNode_InsertAfter(current_element,div_prev);

		// イメージを挿入
		DomNode_InsertAfter(div_prev,image);

		// 改行を作成
		var div_next = DocumentCreateElement("div");
		var analyze_div_next = new ElementAnalyzeManager(div_next,true);
		ElementSetStyle(div_next,"height:0px");
		DomNode_InsertAfter(image,div_next);

		// スタイルのサイズを取得
		style.width  = "0px";
		style.height = "0px";
		var bounding_size = ElementGetBoundingClientRect(image);
		var style_w = bounding_size.right  - bounding_size.left;
		var style_h = bounding_size.bottom - bounding_size.top;

		// 親の幅を取得
		var parent_width = ElementGetClientWidth(image.parentNode);
		if(width_max > parent_width)	width_max = parent_width;

		// エレメントのサイズ
		width  -= style_w;
		height -= style_h;

		// 最小幅補正
		var w = width_min - style_w;
		if(w > width){
			height *= w / width;
			width = w;
		}

		// 最小高補正
		var h = height_min - style_h;
		if(h > height){
			width *= h / height;
			height = h;
		}

		// 最大幅補正
		w = width_max - style_w;
		if(w < width){
			height *= w / width;
			width = w;
		}

		// 最大高補正
		h = height_max - style_h;
		if(h < height){
			width *= h / height;
			height = h;
		}

		// サイズをセット
		style.width  = width  + "px";
		style.height = height + "px";

		// スクロール補正
		revise_scroll.executeAttachElementAfter(image);

		// クリック時に実行されるイベント
		function click_func(e){
			if(e.ctrlKey){
				// Ctrl + クリックで等倍配置
				style.width  = natural_size.width  + "px";
				style.height = natural_size.height + "px";

			}else{
				release();
			}
		}
		if(image.addEventListener){
			image.addEventListener("click",click_func,true);
		}else if(image.attachEvent){
			image.attachEvent("onclick",click_func);
		}

		// 開放時に実行されるイベント
		var event_handler = event_dispatcher.createEventHandler("release");
		event_handler.setFunction(release);

		response();
		return false;
	}.toString() +
"\n]";
				});

				// --------------------------------------------------------------------------------
				// URLマッピング設定
				// --------------------------------------------------------------------------------
				// 追加
				update(proj.urlmap,"*",function(obj){
					if(obj.enable_mixed_content === undefined) obj.enable_mixed_content = false;
				});

				// デフォルト
				var preset = getPreset(proj.urlmap,"default");
				preset.make_link_to_text = {enable:false,id:""};
				preset.expand_image = {enable:true,id:"popup_all"};

				// 検索サイト
				var preset = getPreset(proj.urlmap,"search");
				preset.expand_image = {enable:true,id:"popup_include_image"};

				// 画像検索サイト
				var preset = getPreset(proj.urlmap,"image_search");
				preset.replacement_to_element = {enable:true,id:["assist_image_search"]};
				preset.expand_image = {enable:true,id:"popup_include_image"};

				// リアルタイム検索用
				var preset = getPreset(proj.urlmap,"realtime_search");
				preset.expand_image = {enable:true,id:"thumbnail_not_include_image"};

				// スレッド掲示板
				var preset = getPreset(proj.urlmap,"bbs");
				preset.expand_image = {enable:true,id:"thumbnail_not_include_image"};

				// twitter
				var preset = getPreset(proj.urlmap,"twitter");
				preset.replacement_to_element = {enable:true,id:["assist_twitter"]};
				preset.expand_image = {enable:true,id:"twitter"};

				// ウィキペディア
				var preset = getPreset(proj.urlmap,"wikipedia");
				preset.expand_image = {enable:true,id:"popup_include_image"};
				preset.filter.push("*://*.m.wikipedia.org/*");

				// ピクシブ
				var obj = addPreset(proj.urlmap,"pixiv","default");
				obj.preset = {
					name:{
						standard:"pixiv",
						locales:{
							ja:"ピクシブ",
							en:"pixiv"
						}
					},
					enable:true,
					filter:[
						"http://*.pixiv.net/",
						"http://*.pixiv.net/*"
					],
					enable_unsecure:false,
					enable_mixed_content:false,
					access_block:{enable:false,id:""},
					replacement_to_element:{enable:true,id:["assist_pixiv"]},
					replacement_to_text:{enable:false,id:[]},
					replacement_to_anchor:{enable:false,id:[]},
					replacement_to_link:{enable:true,id:"direct_link_generic"},
					replacement_to_referer:{enable:false,id:""},
					replacement_to_useragent:{enable:false,id:""},
					make_link_to_text:{enable:true,id:"simple"},
					expand_short_url:{enable:true,id:"detail"},
					expand_text:{enable:false,id:""},
					expand_image:{enable:true,id:"popup_include_image"},
					expand_sound:{enable:false,id:""},
					expand_video:{enable:false,id:""},
					expand_iframe:{enable:false,id:""},
					style_sheet:{enable:true,id:"default"},
					experimental:{enable:false,id:""}
				};

				// フェイスブック
				var obj = addPreset(proj.urlmap,"facebook","twitter");
				obj.preset = {
					name:{
						standard:"Facebook",
						locales:{
							ja:"フェイスブック",
							en:"Facebook"
						}
					},
					enable:true,
					filter:[
						"*://www.facebook.com/*"
					],
					enable_unsecure:false,
					enable_mixed_content:false,
					access_block:{enable:false,id:""},
					replacement_to_element:{enable:false,id:[]},
					replacement_to_text:{enable:false,id:[]},
					replacement_to_anchor:{enable:true,id:["disable_event_facebook","direct_link_facebook","no_referrer"]},
					replacement_to_link:{enable:true,id:"direct_link_generic"},
					replacement_to_referer:{enable:false,id:""},
					replacement_to_useragent:{enable:false,id:""},
					make_link_to_text:{enable:true,id:"simple"},
					expand_short_url:{enable:true,id:"detail"},
					expand_text:{enable:false,id:""},
					expand_image:{enable:true,id:"popup_include_image"},
					expand_sound:{enable:false,id:""},
					expand_video:{enable:false,id:""},
					expand_iframe:{enable:false,id:""},
					style_sheet:{enable:true,id:"default"},
					experimental:{enable:false,id:""}
				};

			}
			if(exit())	return proj;

			// --------------------------------------------------------------------------------
			// プロジェクト ver.12
			// --------------------------------------------------------------------------------
			if(proj.version < 12){
				// バージョン値
				proj.version = 12;

				// --------------------------------------------------------------------------------
				// URLマッピング設定
				// --------------------------------------------------------------------------------
				// 追加
				update(proj.urlmap,"*",function(obj){
					// マルチ化
					if(obj.access_block.enable){
						obj.access_block.id = [obj.access_block.id];
					}else{
						obj.access_block.id = [];
					}
					if(obj.replacement_to_link.enable){
						obj.replacement_to_link.id = [obj.replacement_to_link.id];
					}else{
						obj.replacement_to_link.id = [];
					}
					if(obj.replacement_to_referer.enable){
						obj.replacement_to_referer.id = [obj.replacement_to_referer.id];
					}else{
						obj.replacement_to_referer.id = [];
					}
					if(obj.replacement_to_useragent.enable){
						obj.replacement_to_useragent.id = [obj.replacement_to_useragent.id];
					}else{
						obj.replacement_to_useragent.id = [];
					}
				});
			}
			if(exit())	return proj;

			// --------------------------------------------------------------------------------
			// プロジェクト ver.13
			// --------------------------------------------------------------------------------
			if(proj.version < 13){
				// バージョン値
				proj.version = 13;

				// --------------------------------------------------------------------------------
				// 掲示板設定
				// --------------------------------------------------------------------------------
				// ２ちゃんねる掲示板
				var obj = addPreset(proj.expand_bbs,"2ch",null);
				var preset = obj.preset;
				preset.filter = [
					{
						pattern:"^http://[^.]+\\.2ch\\.net/test/read\\.cgi/[^/]+/[0-9]+",
						flags:{i:true,g:false}
					},{
						pattern:"^http://(|[^.]+\\.)machi\\.to/bbs/read\\.cgi/[^/]+/[0-9]+",
						flags:{i:true,g:false}
					},{
						pattern:"^http://(|[^.]+\\.)machibbs\\.net/[^/]+/[0-9]+",
						flags:{i:true,g:false}
					},{
						pattern:"^http://[^.]+\\.bbspink\\.com/test/read\\.cgi/[^/]+/[0-9]+",
						flags:{i:true,g:false}
					},{
						pattern:"^http://jbbs\\.livedoor\\.jp/bbs/read.cgi/[^/]+/[0-9]+/[0-9]+",
						flags:{i:true,g:false}
					},{
						pattern:"^http://[^.]+\\.kakiko\\.com/test/read\\.cgi/[^/]+/[0-9]+",
						flags:{i:true,g:false}
					},{
						pattern:"^http://[^.]+\\.60\\.kg/test/read\\.cgi/[^/]+/[0-9]+",
						flags:{i:true,g:false}
					}
				];
				preset.script_initialize = 
"[\n\t" + 
	function(info,response){
		var work = info.work;

		// --------------------------------------------------------------------------------
		// 基本URL抽出
		// --------------------------------------------------------------------------------
		var url = document.URL;
		var bbs_list = [
			{url:"(http://[^.]+\\.2ch\\.net/test/read\\.cgi/[^/]+/[0-9]+)",replace:"$1/",name:"2ch"},
			{url:"(http://(|[^.]+\\.)machi\\.to/bbs/read\\.cgi/[^/]+/[0-9]+)",replace:"$1/",name:"machi"},
			{url:"(http://(|[^.]+\\.)machibbs\\.net/[^/]+/[0-9]+)",replace:"$1",name:"machibbs"},
			{url:"(http://[^.]+\\.bbspink\\.com/test/read\\.cgi/[^/]+/[0-9]+)",replace:"$1/",name:"pink"},
			{url:"(http://jbbs\\.livedoor\\.jp/bbs/read.cgi/[^/]+/[0-9]+/[0-9]+)",replace:"$1/",name:"shitaraba"},
			{url:"(http://[^.]+\\.kakiko\\.com/test/read\\.cgi/[^/]+/[0-9]+)",replace:"$1/",name:"kakiko"},
			{url:"(http://[^.]+\\.60\\.kg/test/read\\.cgi/[^/]+/[0-9]+)",replace:"$0/",name:"kakiko"}
		];

		var i;
		var num = bbs_list.length;
		for(i=0;i<num;i++){
			var bbs = bbs_list[i];
			var re = new RegExp(bbs.url,"i");
			var m = url.match(re);
			if(m){
				work.base_url = m[1].replace(re,bbs.replace);
				work.bbs_name = bbs.name;
				break;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		var work = info.work;

		if(work.bbs_name){
			var first_id = 1;
			var last_id = 1;
			var dictionary_id = new Array();
			var load_shadow_func = null;
			var load_more_func = null;
			var element_parent = null;
			var read_more_button = null;
			var element_form = null;
			var base_url = work.base_url;
			var resource_url_shadow;
			var resource_url_more;

			// --------------------------------------------------------------------------------
			// 文字列からレスポンス番号を取得
			// --------------------------------------------------------------------------------
			work.createResponseAnchorNumbers = function (str){
				var numbers = new ResponseAnchorNumbers();

				var re_search = new RegExp("^(>>|<<|＞＞|＜＜|>|＞|》|≫|&gt;&gt;)([0-9０-９]+)","i");
				var re_range = new RegExp("^([0-9０-９]+)[-]([0-9０-９]+)","i");
				var re_number = new RegExp("^([0-9０-９]+)","i");

				var m = str.match(re_search);
				if(m){
					var p = m[1].length;
					while(true){
						// 番号-番号
						m = str.substr(p).match(re_range);
						if(m){
							var id0 = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
							var id1 = parseInt(StringConvertFromNumericFullToNumericHalf(m[2]));
							if(id0 < 1) id0 = 1;
							if(id1 < 1) id1 = 1;
							if(id0 > 10000) id0 = 10000;
							if(id1 > 10000) id1 = 10000;
							p += m[0].length;
							numbers.addNumbers(id0,id1);
						}else{
							// 番号
							m = str.substr(p).match(re_number);
							if(m){
								p += m[0].length;
								var id = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
								if(id < 1) id = 1;
								if(id > 0x7fffffff) id = 0x7fffffff;
								numbers.addNumber(id);
							}
						}

						if(m){
							// カンマ
							if(RegExp.rightContext.search(",") == 0){
								p += 1;
								continue;
							}
						}
						break;
					}
				}
				return numbers;
			};

			// --------------------------------------------------------------------------------
			// レスアンカー拡張
			// --------------------------------------------------------------------------------
			work.extendResponseAnchor = function (target){
				if(BbsControlResponseAnchorExist(target))	return;

				var re_simple = new RegExp("^(>>|<<|>)[-,0-9０-９]+$","i");
				var re_detail = new RegExp("(>>|<<|＞＞|＜＜|>|＞|》|≫|&gt;&gt;)(([0-9０-９]+[-][0-9０-９]+|[0-9０-９]+),)*([0-9０-９]+[-][0-9０-９]+|[0-9０-９]+)","i");
				var re_range = new RegExp("([0-9０-９]+)[-]([0-9０-９]+)","i");
				var re_number = new RegExp("([0-9０-９]+)","i");

				var i;
				var nodes = ElementGetElementsByTagName(target,"a");
				var num = nodes.length;
				for(i=num-1;i>=0;i--){
					var node = nodes[i];
					var m = ElementGetTextContent(node).match(re_simple);
					if(m){
						var text_node = DocumentCreateText(m[0]);
						DomNode_InsertBefore(node,text_node);
						DomNodeRemove(node);
					}
				}

				// テキストノードを統合
				target.normalize();

				var p;
				var n;
				var q;
				var ignore_dictionary = {"A":1,"SCRIPT":1};
				var queue = new Object();
				q = {p:queue,n:queue,node:target};
				queue.p = q;
				queue.n = q;

				while(queue.n != queue){
					q = queue.n;
					p = q.p;
					n = q.n;
					p.n = n;
					n.p = p;
					var node = q.node;
					switch(node.nodeType){
					case 1:
						var i;
						var nodes = node.childNodes;
						var num = nodes.length;
						for(i=0;i<num;i++){
							n = queue;
							p = n.p;
							q = {p:p,n:n,node:nodes[i]};
							p.n = q;
							n.p = q;
						}
						break;
					case 3:
						while(node){
							var m = DomNodeGetNodeValue(node).match(re_detail);
							if(!m)	break;

							// 元のテキストノード
							DomNodeSetNodeValue(node,RegExp.leftContext);

							// BbsControlName を生成
							var element = DocumentCreateElement("a");
							ElementSetTextContent(element,m[0]);
							DomNode_InsertAfter(node,element);

							// 直後テキスト
							node = DocumentCreateText(RegExp.rightContext);
							DomNode_InsertAfter(element,node);

							var query = "";
							m = ElementGetTextContent(element).match(re_range);
							if(m){
								var min = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
								var max = parseInt(StringConvertFromNumericFullToNumericHalf(m[2]));
								if(min < 1) min = 1;
								if(max < 1) max = 1;
								if(min > 10000) min = 10000;
								if(max > 10000) max = 10000;
								if(max < min){
									var tmp = min;
									min = max;
									max = tmp;
								}
								query = min + "-" + max;
							}else{
								// 番号
								m = ElementGetTextContent(element).match(re_number);
								if(m){
									query = parseInt(StringConvertFromNumericFullToNumericHalf(m[0]));
									if(query < 1) query = 1;
									if(query > 0x7fffffff) query = 0x7fffffff;
								}

							}
							element.href = work.base_url + query;
						}
					}
				}
			};

			// --------------------------------------------------------------------------------
			// HTML 文書をシャドウ読み込み
			// --------------------------------------------------------------------------------
			function loadShadowFromHTML(str){

				var re_number;
				var re_id = new RegExp("ID:([-a-zA-Z0-9+/.]+)[●!]{0,2}","i");
				var re_name = new RegExp("(◆[a-zA-Z0-9+/.]{10,12})","i");
				switch(work.bbs_name){
				case "2ch":
				case "pink":
				case "kakiko":
				case "machi":
				case "machibbs":
						re_number = new RegExp("([0-9]+)","i");
					break;
				case "shitaraba":
						re_number = new RegExp("<a href=\".*?\">([0-9]+)</a> ：","i");
					break;
				}

				var p = 0;
				var n = str.length;
				function f(){
					if(p >= n) return;
					p = str.indexOf("<dt>",p);
					if(p < 0) return;
					var e = str.indexOf("\n",p);
					var s = str.substring(p,e);
					var m = s.match(re_number);
					if(m){
						var id = parseInt(m[1]);
						if((first_id <= id) && (id <= last_id)){
						}else if(dictionary_id[id]){
						}else{
							var nodes = StringHtmlCreateDomNodesSafe(s);
							var dt = nodes[0];
							var dd = nodes[1];

							try{
								if(dt.tagName != "DT")	return;
								if(dd.tagName != "DD")	return;
							}catch(e){
								return;
							}

							// ナンバーからレスポンスオブジェクトを取得
							var response = bbs_dictionary.getResponse(id);
							if(!(response.getAnalyzed())){
								var dt_text = ElementGetTextContent(dt);

								// レスアンカー拡張
								work.extendResponseAnchor(dd);

								// IDの取得
								if(dt_text.match(re_id)){
									response.setId(RegExp.$1);
								}

								// 名前の取得
								if(dt_text.match(re_name)){
									response.setName(RegExp.$1);
								}

								// ホスト名の取得
								(function(){
									var p;
									var n;
									var q;
									var ignore_dictionary = {"B":1,"SCRIPT":1};
									var queue = new Object();
									q = {p:queue,n:queue,node:dt};
									queue.p = q;
									queue.n = q;

									while(queue.n != queue){
										q = queue.n;
										p = q.p;
										n = q.n;
										p.n = n;
										n.p = p;
										var node = q.node;
										switch(node.nodeType){
										case 1:
											if(!(ignore_dictionary[node.tagName])){
												var i;
												var nodes = node.childNodes;
												var num = nodes.length;
												for(i=0;i<num;i++){
													n = queue;
													p = n.p;
													q = {p:p,n:n,node:nodes[i]};
													p.n = q;
													n.p = q;
												}
											}
											break;
										case 3:
											var m = DomNodeGetNodeValue(node).match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
											if(m){
												response.setHost(m[2]);
												return;
											}
											var m = DomNodeGetNodeValue(node).match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})(|\\n) \\]","i"));
											if(m){
												response.setHost(m[2]);
												return;
											}
											var m = DomNodeGetNodeValue(node).match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
											if(m){
												response.setHost(m[2]);
												return;
											}
											break;
										}
									}
								})();

								// フォロー解析
								var dictionary = new Object();
								(function(){
									var nodes = ElementGetElementsByTagName(dd,"a");
									var i;
									var num = nodes.length;
									for(i=0;i<num;i++){
										var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(nodes[i]));
										numbers.getNumbers(function(n){
											if(!dictionary[n]){
												var following = bbs_dictionary.getResponse(n);
												following.addFollower(response);
												dictionary[n] = true;
											}
										});
									}
								})();

								// オリジナルエレメントをセット
								if(dt)	response.addOriginalElements("dt",dt);
								if(dd)	response.addOriginalElements("dd",dd);

								// 消去時に実行されるイベント
								response.onerase = function(){};

								response.setAnalyzed();
							}
						}
					}

					if(p < e){
						p = e + 1;
						execute_queue.attachFirst(f,null);
					}
				}
				execute_queue.attachFirst(f,null);
			}

			// --------------------------------------------------------------------------------
			// HTML 文書を継ぎ足し読み込み
			// --------------------------------------------------------------------------------
			function loadMoreFromHTML(str){
				var re_number;
				switch(work.bbs_name){
				case "2ch":
				case "pink":
				case "kakiko":
				case "machi":
				case "machibbs":
						re_number = new RegExp("([0-9]+)","i");
					break;
				case "shitaraba":
						re_number = new RegExp("<a href=\".*?\">([0-9]+)</a> ：","i");
					break;
				}

				var p = 0;
				var n = str.length;
				function f(){
					try{
						if(p >= n) throw 0;
						p = str.indexOf("<dt>",p);
						if(p < 0) throw 0;
						var e = str.indexOf("\n",p);
						var s = str.substring(p,e);
						var m = s.match(re_number);
						if(m){
							var id = parseInt(m[1]);
							if(last_id < id){
								var response = bbs_dictionary.getResponse(id);
								response.clearAnalyzed();
								response.clearOriginalElements();
								response.clearFollowing();

								var nodes = StringHtmlCreateDomNodesSafe(s);
								var j;
								var node_num = nodes.length;
								for(j=0;j<node_num;j++){
									element_parent.appendChild(nodes[j]);
								}
								last_id = id;
								resource_url_more = base_url + (last_id) + "-";
							}
						}

						if(p < e){
							p = e + 1;
							execute_queue.attachFirst(f,null);
							return;
						}
					}catch(e){
					}
					read_more_button.init();
				}
				execute_queue.attachFirst(f,null);
			}

			// --------------------------------------------------------------------------------
			// DAT 文書をシャドウ読み込み
			// --------------------------------------------------------------------------------
			function loadShadowFromDAT(str){
				var re_search = new RegExp("(.*?)<>(.*?)<>(.*?)<>(.*?)<>","i");
				var re_number = new RegExp("([0-9]+)","i");
				var re_id = new RegExp("ID:([-a-zA-Z0-9+/.]+)[●!]{0,2}","i");
				var re_name = new RegExp("(◆[a-zA-Z0-9+/.]{10,12})","i");
				var re_icon = new RegExp("^ sssp://img.2ch.net/ico/(.*?)( <br> .*)$","i");

				var p = 0;
				var n = str.length;
				var id = 1;
				function f(){
					if(p >= n) return;
					var e = str.indexOf("\n",p);
					if((first_id <= id) && (id <= last_id)){
					}else if(dictionary_id[id]){
					}else{
						// ナンバーからレスポンスオブジェクトを取得
						var response = bbs_dictionary.getResponse(id);
						if(!(response.getAnalyzed())){
							var m = str.substring(p,e).match(re_search);
							if(m){
								var html = "<dt>" + id + " ：";
								if(m[2]){
									html += "<a href=\"mailto:" + m[2] + "\"><b>" + m[1] + "</b></a>";
								}else{
									html += "<font color=green><b>" + m[1] + "</b></font>";
								}
								html += "：" + m[3] + "<dd>";
								var msg = m[4];
								if(msg.match(re_icon)){
									msg = "<img src=\"http://img.2ch.net/ico/" + m[1] + "\">" + m[2];
								}
								html += msg + "<br><br>";

								var nodes = StringHtmlCreateDomNodesSafe(html);
								var dt = nodes[0];
								var dd = nodes[1];

								try{
									if(dt.tagName != "DT")	return;
									if(dd.tagName != "DD")	return;
								}catch(e){
									return;
								}

								var dt_text = ElementGetTextContent(dt);

								// レスアンカー拡張
								work.extendResponseAnchor(dd);

								// IDの取得
								if(dt_text.match(re_id)){
									response.setId(RegExp.$1);
								}

								// 名前の取得
								if(dt_text.match(re_name)){
									response.setName(RegExp.$1);
								}

								// ホスト名の取得
								(function(){
									var p;
									var n;
									var q;
									var ignore_dictionary = {"B":1,"SCRIPT":1};
									var queue = new Object();
									q = {p:queue,n:queue,node:dt};
									queue.p = q;
									queue.n = q;

									while(queue.n != queue){
										q = queue.n;
										p = q.p;
										n = q.n;
										p.n = n;
										n.p = p;
										var node = q.node;
										switch(node.nodeType){
										case 1:
											if(!(ignore_dictionary[node.tagName])){
												var i;
												var nodes = node.childNodes;
												var num = nodes.length;
												for(i=0;i<num;i++){
													n = queue;
													p = n.p;
													q = {p:p,n:n,node:nodes[i]};
													p.n = q;
													n.p = q;
												}
											}
											break;
										case 3:
											var m = DomNodeGetNodeValue(node).match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
											if(m){
												response.setHost(m[2]);
												return;
											}
											var m = DomNodeGetNodeValue(node).match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})(|\\n) \\]","i"));
											if(m){
												response.setHost(m[2]);
												return;
											}
											var m = DomNodeGetNodeValue(node).match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
											if(m){
												response.setHost(m[2]);
												return;
											}
											break;
										}
									}
								})();

								// フォロー解析
								var dictionary = new Object();
								(function(){
									var nodes = ElementGetElementsByTagName(dd,"a");
									var i;
									var num = nodes.length;
									for(i=0;i<num;i++){
										var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(nodes[i]));
										numbers.getNumbers(function(n){
											if(!dictionary[n]){
												var following = bbs_dictionary.getResponse(n);
												following.addFollower(response);
												dictionary[n] = true;
											}
										});
									}
								})();

								// オリジナルエレメントをセット
								if(dt)	response.addOriginalElements("dt",dt);
								if(dd)	response.addOriginalElements("dd",dd);

								// 消去時に実行されるイベント
								response.onerase = function(){};

								response.setAnalyzed();
							}
						}
					}

					id += 1;
					if(p < e){
						p = e + 1;
						execute_queue.attachFirst(f,null);
					}
				}
				execute_queue.attachFirst(f,null);
			}

			// --------------------------------------------------------------------------------
			// DAT 文書を継ぎ足し読み込み
			// --------------------------------------------------------------------------------
			function loadMoreFromDAT(str){

				// 最後尾 ID
				var nodes = ElementGetElementsByTagName(element_parent,"dt");
				var node_num = nodes.length;
				if(node_num){
					if(ElementGetTextContent(nodes[node_num-1]).match(new RegExp("^([0-9]+)[ ]：","i"))){
						last_id = parseInt(RegExp.$1);
					}
				}

				var re_search = new RegExp("(.*?)<>(.*?)<>(.*?)<>(.*?)<>","i");
				var re_icon = new RegExp("^ sssp://img.2ch.net/ico/(.*?)( <br> .*)$","i");

				// レスポンス抽出
				var p = 0;
				var n = str.length;
				var id = 1;
				function f(){
					try{
						if(p >= n) throw 0;
						var e = str.indexOf("\n",p);
						if(last_id < id){
							var m = str.substring(p,e).match(re_search);
							if(m){
								var response = bbs_dictionary.getResponse(id);
								response.clearAnalyzed();
								response.clearOriginalElements();
								response.clearFollowing();

								var html = "<dt>" + id + " ：";
								if(m[2]){
									html += "<a href=\"mailto:" + m[2] + "\"><b>" + m[1] + "</b></a>";
								}else{
									html += "<font color=green><b>" + m[1] + "</b></font>";
								}
								html += "：" + m[3] + "<dd>";
								var msg = m[4];
								if(msg.match(re_icon)){
									msg = "<img src=\"http://img.2ch.net/ico/" + m[1] + "\">" + m[2];
								}
								html += msg + "<br><br>";

								var nodes = StringHtmlCreateDomNodesSafe(html);
								var j;
								var node_num = nodes.length;
								for(j=0;j<node_num;j++){
									element_parent.appendChild(nodes[j]);
								}
								last_id = id;
							}
						}

						id += 1;
						if(p < e){
							p = e + 1;
							execute_queue.attachFirst(f,null);
							return;
						}
					}catch(e){
					}
					read_more_button.init();
				}
				execute_queue.attachFirst(f,null);
			}

			// --------------------------------------------------------------------------------
			// 継ぎ足し読み込み
			// --------------------------------------------------------------------------------
			function readMore(){

				// ローダーオブジェクトを作成
				var loader = new Loader();

				// 成功
				loader.onload = function(str){
					if(load_more_func){
						load_more_func(str);
					}
				};

				// 失敗
				loader.onerror = function(){
					read_more_button.init();
				};

				// テキストの読み込み
				loader.setMethod("GET");
				loader.setURL(resource_url_more);
				switch(work.bbs_name){
				case "2ch":
				case "machi":
				case "machibbs":
				case "pink":
				case "kakiko":
					loader.overrideMimeType("text/plain; charset=Shift_JIS");
					break;
				case "shitaraba":
					loader.overrideMimeType("text/plain; charset=EUC-JP");
					break;
				}
				loader.loadText();
			}

			// --------------------------------------------------------------------------------
			// レスポンス親要素
			// --------------------------------------------------------------------------------
			var i;
			var nodes = ElementGetElementsByTagName(document.body,"dl");
			var num = nodes.length;
			for(i=0;i<num;i++){
				element_parent = nodes[i];
				break;
			}

			if(!element_parent) return false;

			// --------------------------------------------------------------------------------
			// フォーム位置修正
			// --------------------------------------------------------------------------------
			switch(work.bbs_name){
			case "machi":
				var nodes = ElementGetElementsByTagName(element_parent,"dt");
				if(nodes.length){
					var dt = nodes[nodes.length - 1];
					var node = dt.firstChild;
					while(node){
						var next = node.nextSibling;
						DomNode_InsertAfter(element_parent,node);
						node = next;
					}
					DomNodeRemove(dt);
				}

				var nodes = ElementGetElementsByTagName(element_parent,"dd");
				if(nodes.length){
					nodes = ElementGetElementsByTagName(nodes[nodes.length - 1],"br");
					if(nodes.length){
						var node = nodes[nodes.length - 1];
						node = node.nextSibling;
						while(node){
							var next = node.nextSibling;
							DomNode_InsertAfter(element_parent,node);
							node = next;
						}
					}
				}

				break;
			}

			// --------------------------------------------------------------------------------
			// 範囲取得
			// --------------------------------------------------------------------------------
			var nodes = ElementGetElementsByTagName(element_parent,"dt");
			var node_num = nodes.length;
			if(node_num){
				var re_id = new RegExp("^([0-9]+)","i");

				if(ElementGetTextContent(nodes[0]).match(re_id)){
					first_id = parseInt(RegExp.$1);
					dictionary_id[0] = true;
				}

				if((first_id == 1) && (node_num > 1)){
					if(ElementGetTextContent(nodes[1]).match(re_id)){
						first_id = parseInt(RegExp.$1);
						dictionary_id[first_id] = true;
						if(first_id <= 2) first_id = 1;
					}
				}

				if(ElementGetTextContent(nodes[node_num-1]).match(re_id)){
					last_id = parseInt(RegExp.$1);
					dictionary_id[last_id] = true;
				}
			}

			// --------------------------------------------------------------------------------
			// 読み込み方式
			// --------------------------------------------------------------------------------
			load_shadow_func = loadShadowFromHTML;
			load_more_func = loadMoreFromHTML;

			// JavaScript モード検出
			if(work.bbs_name == "2ch"){
				load_shadow_func = loadShadowFromDAT;

				var nodes = ElementGetElementsByTagName(DocumentGetHeadElement(document),"meta");
				var i;
				var num = nodes.length;
				for(i=0;i<num;i++){
					var node = nodes[i];
					var http_equiv = node.getAttribute("http-equiv");
					if(!http_equiv)	http_equiv = node.httpEquiv;
					if(!http_equiv)	continue;
					if(http_equiv.toLowerCase() != "content-type")	continue;
					var content = node.getAttribute("content");
					if(!content)	content = node.content;
					if(!content)	continue;
					if(content.indexOf("application") == -1)	continue;

					load_more_func = loadMoreFromDAT;
					break;
				}
			}

			// --------------------------------------------------------------------------------
			// アクセス先 URL
			// --------------------------------------------------------------------------------
			if(load_more_func == loadMoreFromHTML){
				resource_url_more = base_url + last_id + "-";
			}else{
				if(base_url.match(new RegExp("http://([^.]+\\.2ch\\.net)/test/read\\.cgi/([^/]+)/([0-9]+)/","i"))){
					resource_url_more = "http://" + RegExp.$1 + "/" + RegExp.$2 + "/dat/" + RegExp.$3 + ".dat";
				}
			}
			if(load_shadow_func == loadShadowFromHTML){
				resource_url_shadow = base_url;
			}else{
				if(base_url.match(new RegExp("http://([^.]+\\.2ch\\.net)/test/read\\.cgi/([^/]+)/([0-9]+)/","i"))){
					resource_url_shadow = "http://" + RegExp.$1 + "/" + RegExp.$2 + "/dat/" + RegExp.$3 + ".dat";
				}
			}

			// --------------------------------------------------------------------------------
			// BbsControlReadMoreButton 作成
			// --------------------------------------------------------------------------------
			read_more_button = new BbsControlReadMoreButton();
			read_more_button.setWaitTime(2 * 1000);
			read_more_button.onclick = readMore;
			DomNode_InsertAfter(element_parent,read_more_button.getElement());


			// --------------------------------------------------------------------------------
			// 書き込みをポップアップ化
			// --------------------------------------------------------------------------------
			if(load_more_func == loadMoreFromHTML){
				// フォーム
				var nodes = ElementGetElementsByTagName(document.body,"form");
				var element_form;
				var input_submit;
				var element_textarea;

				// フォーム
				var i;
				switch(work.bbs_name){
				case "2ch":
				case "pink":
					for(i=0;i<nodes.length;i++){
						if(nodes[i].action.indexOf("/test/bbs.cgi") >= 0){
							element_form = nodes[i];
							break;
						}
					}
					break;
				case "shitaraba":
					for(i=0;i<nodes.length;i++){
						if(nodes[i].action.indexOf("/bbs/write.cgi/") >= 0){
							element_form = nodes[i];
							break;
						}
					}
					break;
				}

				// サブミットボタン
				if(element_form){
					var nodes = ElementGetElementsByTagName(element_form,"input");
					for(i=0;i<nodes.length;i++){
						if(nodes[i].type.toLowerCase() == "submit"){
							input_submit = nodes[i];
							break;
						}
					}
					var nodes = ElementGetElementsByTagName(element_form,"textarea");
					if(nodes.length){
						element_textarea = nodes[0];
					}
				}

				if(input_submit){

					function inputClick(e){

						var w = 800;
						var h = 600;
						var cookie = document.cookie;
						if(cookie){
							if(cookie.indexOf("PREN=") != -1){
								w = 600;
								h = 450;
							}
						}

						var screen_obj = window.screen;
						if(w > screen_obj.availWidth)	w = screen_obj.availWidth;
						if(h > screen_obj.availHeight)	h = screen_obj.availHeight;
						var x = (screen_obj.availWidth  / 2) - (w / 2);
						var y = (screen_obj.availHeight / 2) - (h / 2);

						var window_name = "_pageexpand_" + Math.floor(Math.random() * 0x7FFFFFFF);
						var window_obj = window.open("",window_name,"left=" + x + ",top=" + y + ",width=" + w + ",height=" + h);
						element_form.target = window_name;

						(function(){
							var closed = false;
							var timer = null;

							// タスク生成
							var task = task_container.createTask();
							task.setExecuteFunc(function(){
								try{
									if(window_obj.closed){
										closed = true;
									}

									// アドレスを監視
									var href = "";
									try{
										href = window_obj.location.href;
									}catch(e){}
									if(href.indexOf("http://") == 0){

										switch(work.bbs_name){
										case "2ch":
										case "pink":
											if(href.indexOf("test/bbs.cgi?guid=") == -1){
												closed = true;
											}else if(!timer){
												var body = window_obj.document.body;
												if(body){
													if(ElementGetTextContent(body).indexOf("書きこみが終わりました") != -1){
														timer = (new Date()).getTime();
													}
												}
											}
											break;
										case "shitaraba":
											if(href.indexOf("/bbs/write.cgi/") == -1){
												closed = true;
											}else if(!timer){
												var body = window_obj.document.body;
												if(body){
													if(ElementGetTextContent(body).indexOf("書きこみが終りました") != -1){
														timer = (new Date()).getTime();
													}
												}
											}
											break;
										}
									}

									if(timer){
										if((new Date()).getTime() - timer > 1000 * 2){
											closed = true;
										}
									}
								}catch(e){
									closed = true;
								}

								if(closed){
									try{
										window_obj.close();
									}catch(e){
										return;
									}
									window_obj = null;
									task.release();
									input_submit.disabled = false;
									if(timer){
										readMore();
										element_textarea.value = "";
									}
								}
							});
						})();
					}

					function formSubmit(e){
						input_submit.disabled = true;
					}

					if(window.addEventListener){
						input_submit.addEventListener("click",inputClick);
						element_form.addEventListener("submit",formSubmit);
					}else if(window.attachEvent){
						input_submit.attachEvent("onclick",inputClick);
						element_form.attachEvent("onsubmit",formSubmit);
					}
				}
			}

			// --------------------------------------------------------------------------------
			// シャドウロード
			// --------------------------------------------------------------------------------
			(function(){
				// ローダーオブジェクトを作成
				var loader = new Loader();

				// 成功
				loader.onload = function(str){
					if(load_shadow_func){
						load_shadow_func(str);
					}
				};

				// 失敗
				loader.onerror = function(){
				};

				// テキストの読み込み
				loader.setMethod("GET");
				loader.setURL(resource_url_shadow);
				switch(work.bbs_name){
				case "2ch":
				case "pink":
					loader.overrideMimeType("text/plain; charset=Shift_JIS");
					break;
				case "shitaraba":
					loader.overrideMimeType("text/plain; charset=EUC-JP");
					break;
				}
				loader.loadText();
			})();

			response({result:true});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		response({result:false});
		return true;
	}.toString() +
"\n]";
				preset.script_callback = 
"[\n\t" + 
	function(info,response){
		var element = info.element;
		var work = info.work;

		// --------------------------------------------------------------------------------
		// レスポンスダイアログを登録
		// --------------------------------------------------------------------------------
		function attachBbsResponseDialog(response,node,parent_dialog,type){

			// --------------------------------------------------------------------------------
			// レスアンカー
			// --------------------------------------------------------------------------------
			function forResponseAnchor(target){
				if(BbsControlResponseAnchorExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlResponseAnchor を生成
				// --------------------------------------------------------------------------------
				(function(){
					var i;
					var nodes = ElementGetElementsByTagName(target,"a");
					var num = nodes.length;
					for(i=0;i<num;i++){
						var node = nodes[i];
						var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(node));
						if(numbers.getCount()){
							var control_res_anchor = new BbsControlResponseAnchor(node,false);
							control_res_anchor.setResponseAnchorNumbers(numbers);
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlResponseAnchor を検索
				// --------------------------------------------------------------------------------
				BbsControlResponseAnchorSearch(target,function(control_res_anchor){

					var element_res_anchor = control_res_anchor.getElement();
					var numbers = control_res_anchor.getResponseAnchorNumbers();

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_res_anchor);
					response_dialog.oncreate = function(_window,callback){

						var dl = DocumentCreateElement("dl");
						dl.style.margin = "0px";
						_window.appendChild(dl);

						var created = false;
						var i = 0;
						var number_list = numbers.getNumberList();
						var num = number_list.length;
						if(!num) return false;

						function f(){
							var following = bbs_dictionary.getResponse(number_list[i]);
							var clone = following.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){
								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									dl.appendChild(obj.element);
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(following,param,response_dialog,"response");

								created = true;
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:created});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// ID
			// --------------------------------------------------------------------------------
			function forId(target){
				if(BbsControlIdExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlId を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"A":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}

							break;
						case 3:
							while(node){

								var m = DomNodeGetNodeValue(node).match(new RegExp("ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(node,RegExp.leftContext);

								// BbsControlId を生成
								var control_id = new BbsControlId(null,false);
								control_id.setId(m[1]);
								var element_id = control_id.getElement();
								ElementSetTextContent(element_id,m[0]);
								DomNode_InsertAfter(node,element_id);

								// 直後テキスト
								node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(element_id,node);
							}
							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlId を検索
				// --------------------------------------------------------------------------------
				BbsControlIdSearch(target,function(control_id){

					control_id.setResponse(response);

					var id = control_id.getId();
					var element_id = control_id.getElement();
					var textnode_id = DocumentCreateText("");

					element_id.appendChild(textnode_id);

					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_id.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_id,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_id,"");
						}

						var style = element_id.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","small");
						}
					};
					control_id.update();

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "id"){
						if(response.getId() == id)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_id);
					response_dialog.oncreate = function(_window,callback){

						var dl = DocumentCreateElement("dl");
						dl.style.margin = "0px";
						_window.appendChild(dl);

						var responses = bbs_dictionary.getResponsesFromId(id);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_id = responses[i];
							var clone = response_id.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									dl.appendChild(obj.element);
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_id,param,response_dialog,"id");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// トリップ
			// --------------------------------------------------------------------------------
			function forName(target){
				if(BbsControlNameExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlName を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							while(node){

								// 本文
								var m = DomNodeGetNodeValue(node).match(new RegExp("(◆[a-zA-Z0-9+/.]{10,12})","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(node,RegExp.leftContext);

								// BbsControlName を生成
								var control_name = new BbsControlName(null,false);
								control_name.setName(m[0]);
								var element_name = control_name.getElement();
								ElementSetTextContent(element_name,m[0]);
								DomNode_InsertAfter(node,element_name);

								// 直後テキスト
								node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(element_name,node);
							}
							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlName を検索
				// --------------------------------------------------------------------------------
				BbsControlNameSearch(target,function(control_name){

					control_name.setResponse(response);

					var name = control_name.getName();
					var element_name = control_name.getElement();
					var textnode_name = DocumentCreateText("");


					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_name.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_name,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_name,"");
						}

						var style = element_name.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","small");
						}
					};
					control_name.update();
					element_name.appendChild(textnode_name);

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "name"){
						if(response.getName() == name)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_name);
					response_dialog.oncreate = function(_window,callback){

						var dl = DocumentCreateElement("dl");
						dl.style.margin = "0px";
						_window.appendChild(dl);

						var responses = bbs_dictionary.getResponsesFromName(name);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_name = responses[i];
							var clone = response_name.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									dl.appendChild(obj.element);
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_name,param,response_dialog,"name");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// ホスト
			// --------------------------------------------------------------------------------
			function forHost(target){
				if(BbsControlHostExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlHost を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"B":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							while(node){
								var text_value = DomNodeGetNodeValue(node);

								var m = text_value.match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
								if(m){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext + m[1]);

									// BbsControlHost を生成
									var control_host = new BbsControlHost(null,false);
									control_host.setHost(m[2]);
									var element_host = control_host.getElement();
									ElementSetTextContent(element_host,m[2]);
									DomNode_InsertAfter(node,element_host);

									// 直後テキスト
									node = DocumentCreateText(RegExp.rightContext);
									DomNode_InsertAfter(element_host,node);
									continue;
								}

								var m = text_value.match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})((|\\n) \\])","i"));
								if(m){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext + m[1]);

									// BbsControlHost を生成
									var control_host = new BbsControlHost(null,false);
									control_host.setHost(m[2]);
									var element_host = control_host.getElement();
									ElementSetTextContent(element_host,m[2]);
									DomNode_InsertAfter(node,element_host);

									// 直後テキスト
									node = DocumentCreateText("\n ]" + RegExp.rightContext);
									DomNode_InsertAfter(element_host,node);
									continue;
								}

								var m = text_value.match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
								if(m){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext + m[1]);

									// BbsControlHost を生成
									var control_host = new BbsControlHost(null,false);
									control_host.setHost(m[2]);
									var element_host = control_host.getElement();
									ElementSetTextContent(element_host,m[2]);
									DomNode_InsertAfter(node,element_host);

									// 直後テキスト
									node = DocumentCreateText(RegExp.rightContext);
									DomNode_InsertAfter(element_host,node);
									continue;
								}

								break;
							}

							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlHost を検索
				// --------------------------------------------------------------------------------
				BbsControlHostSearch(target,function(control_host){

					control_host.setResponse(response);

					var host = control_host.getHost();
					var element_host = control_host.getElement();
					var textnode_host = DocumentCreateText("");


					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_host.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_host,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_host,"");
						}

						var style = element_host.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","80%");
						}
					};
					control_host.update();
					element_host.appendChild(textnode_host);

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "host"){
						if(response.getHost() == host)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_host);
					response_dialog.oncreate = function(_window,callback){

						var dl = DocumentCreateElement("dl");
						dl.style.margin = "0px";
						_window.appendChild(dl);

						var responses = bbs_dictionary.getResponsesFromHost(host);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_host = responses[i];
							var clone = response_host.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									dl.appendChild(obj.element);
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_host,param,response_dialog,"host");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// フォロワー
			// --------------------------------------------------------------------------------
			function forFollower(target){
				if(BbsControlFollowerExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlFollower を生成
				// --------------------------------------------------------------------------------
				var control_follower = new BbsControlFollower(null,true);
				control_follower.setResponse(response);

				var element_follower = control_follower.getElement();
				var textnode_follower = DocumentCreateText("");

				element_follower.appendChild(textnode_follower);

				// --------------------------------------------------------------------------------
				// 変化があったときに実行されるイベント
				// --------------------------------------------------------------------------------
				control_follower.onchange = function(count){
					if(count){
						textnode_follower.nodeValue = " follower(" + count + ")";
					}else{
						textnode_follower.nodeValue = "";
					}

					var style = element_follower.style;
					if(count >= 3){
						StyleDeclarationSetProperty(style,"color","#e80000");
						StyleDeclarationRemoveProperty(style,"font-size");

					}else{
						StyleDeclarationSetProperty(style,"color","#888");
						StyleDeclarationSetProperty(style,"font-size","small");
					}
					if(count){
						StyleDeclarationSetProperty(style,"margin","0px 4px 0px 0px");
					}else{
						StyleDeclarationRemoveProperty(style,"margin");
					}
				};
				control_follower.update();
				var nodes = ElementGetElementsByTagName(target,"br");
				if(nodes.length){
					DomNode_InsertBefore(nodes[0],element_follower);
				}else{
					target.appendChild(element_follower);
				}

				// --------------------------------------------------------------------------------
				// ポップアップ化
				// --------------------------------------------------------------------------------
				// ダイアログを作成
				var response_dialog = new BbsResponseDialog();
				if(parent_dialog)	parent_dialog.attachChild(response_dialog);
				response_dialog.setElementParent(node.parent);
				response_dialog.setElementHitArea(element_follower);
				response_dialog.oncreate = function(_window,callback){

					var dl = DocumentCreateElement("dl");
					dl.style.margin = "0px";
					_window.appendChild(dl);

					var ary = response.getFollower();
					var i = 0;
					var num = ary.length;
					if(num <= 0) return false;

					function f(){
						var follower = bbs_dictionary.getResponse(ary[i].getNumber());
						var clone = follower.getCloneElements();

						var j;
						var clone_num = clone.length;
						if(clone_num){

							var param = new Object();
							param.parent = node.parent;
							for(j=0;j<clone_num;j++){
								var obj = clone[j];
								param[obj.name] = obj.element;
								dl.appendChild(obj.element);
							}

							// レスポンスダイアログを登録
							attachBbsResponseDialog(follower,param,response_dialog,"response");
						}

						i += 1;
						if(i < num){
							execute_queue.attachFirst(f,null);
						}else{
							callback({result:true});
						}
					}
					execute_queue.attachFirst(f,null);
				};
			}

			if(node.dt){
				forResponseAnchor(node.dt);
				forId(node.dt);
				forName(node.dt);
				forHost(node.dt);
				forFollower(node.dt);
			}
			if(node.dd){
				forResponseAnchor(node.dd);
				forId(node.dd);
				forName(node.dd);
			}
		}

		// --------------------------------------------------------------------------------
		// エレメントを解析
		// --------------------------------------------------------------------------------
		var useful = (function(){
			var dt = element;
			var dd;

			try{
				if(dt.tagName != "DT")	return false;
			}catch(e){
				return false;
			}

			dd = dt.nextSibling;
			try{
				if(dd.tagName != "DD")	return false;
			}catch(e){
				return false;
			}

			try{
				var dl = dt.parentNode;
				if(dl.tagName != "DL")	return false;
				if(dl.parentNode != document.body)	return false;
			}catch(e){
				return false;
			}

			// document に未登録
			if(!DomNodeGetAttachedDocument(dt))	return false;

			// --------------------------------------------------------------------------------
			// レスアンカー拡張
			// --------------------------------------------------------------------------------
			work.extendResponseAnchor(dd);

			// --------------------------------------------------------------------------------
			// クリーンアップ
			// --------------------------------------------------------------------------------
			(function(){
				function cleanup(target){
					BbsControlSearchTrash(target,function(element){
						var node = element.firstChild;
						if(!node)	return null;
						if(node.nodeType != 3)	return null;

						// ID
						var m = node.nodeValue.match(new RegExp("^ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);
							return null;
						}

						// トリップ
						var m = node.nodeValue.match(new RegExp("^(◆[a-zA-Z0-9+/.]{10,12})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);
							return null;
						}

						// ホスト名
						var m = node.nodeValue.match(new RegExp("^([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);

							// テキストノードを統合
							node.parentNode.normalize();
							return null;
						}
						var m = node.nodeValue.match(new RegExp("^([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);

							// テキストノードを統合
							node.parentNode.normalize();
							return null;
						}

						return null;
					});
				}

				if(dt){
					cleanup(dt);
				}
				if(dd){
					cleanup(dd);
				}
			})();

			// ナンバーを取得
			var dt_text = ElementGetTextContent(dt);
			if(!(dt_text.match(new RegExp("^([0-9]+)[ ]","i"))))	return false;

			// ナンバーからレスポンスオブジェクトを取得
			var response = bbs_dictionary.getResponse(parseInt(RegExp.$1));

			// レスポンス解析
			if(!response.getAnalyzed()){

				// IDの取得
				if(dt_text.match(new RegExp("ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"))){
					response.setId(RegExp.$1);
				}

				// 名前の取得
				if(dt_text.match(new RegExp("(◆[a-zA-Z0-9+/.]{10,12})","i"))){
					response.setName(RegExp.$1);
				}

				// ホスト名の取得
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"B":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:dt};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							var m = DomNodeGetNodeValue(node).match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
							if(m){
								response.setHost(m[2]);
								return;
							}
							var m = DomNodeGetNodeValue(node).match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})(|\\n) \\]","i"));
							if(m){
								response.setHost(m[2]);
								return;
							}
							var m = DomNodeGetNodeValue(node).match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
							if(m){
								response.setHost(m[2]);
								return;
							}
							break;
						}
					}
				})();

				// フォロー解析
				var dictionary = new Object();
				(function(){
					var nodes = ElementGetElementsByTagName(dd,"a");
					var i;
					var num = nodes.length;
					for(i=0;i<num;i++){
						var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(nodes[i]));
						numbers.getNumbers(function(n){
							if(!dictionary[n]){
								var following = bbs_dictionary.getResponse(n);
								following.addFollower(response);
								dictionary[n] = true;
							}
						});
					}
				})();

				// オリジナルエレメントをセット
				if(dt)	response.addOriginalElements("dt",dt);
				if(dd)	response.addOriginalElements("dd",dd);

				// 消去時に実行されるイベント
				response.onerase = function(){
					var original = response.getOriginalElements();

					// オリジナルエレメントを外す
					var i;
					var num = original.length;
					for(i=0;i<num;i++){
						var revise_scroll = new DocumentReviseScroll();
						var node = original[i].element;
						revise_scroll.executeRemoveElementBefore(node);
						DomNodeRemove(node);
						revise_scroll.executeRemoveElementAfter(node);
					}
				};

				response.setAnalyzed();
			}
			
			var dl = document.body;
			var node = dt;
			while(node){
				if(node.tagName == "DL"){
					dl = node;
				}
				node = node.parentNode;
			}

			// レスポンスダイアログを登録（ルート）
			attachBbsResponseDialog(
				response,
				{
					dt:dt,
					dd:dd,
					parent:dl
				},
				null,
				null
			);

			return true;
		})();

		response({useful:useful});
		return true;
	}.toString() +
"\n]";

				// ログ速
				var obj = addPreset(proj.expand_bbs,"logsoku",null);
				var preset = obj.preset;
				preset.filter = [
					{
						pattern:"^http://logsoku\\.com/thread/.*\\.2ch\\.net/[^/]+/[0-9]+",
						flags:{i:true,g:false}
					},{
						pattern:"^http://[^.]+\\.logsoku\\.com/r/[^/]+/[0-9]+",
						flags:{i:true,g:false}
					},{
						pattern:"^http://logsoku\\.com/r/[^/]+/[0-9]+",
						flags:{i:true,g:false}
					}
				];
				preset.script_initialize = 
"[\n\t" + 
	function(info,response){
		var work = info.work;

		// --------------------------------------------------------------------------------
		// 基本URL抽出
		// --------------------------------------------------------------------------------
		var url = document.URL;
		var bbs_list = [
			{url:"http://logsoku\\.com/thread/.*?\\.2ch\\.net/.*?/[0-9]+/",name:"logsoku"},
			{url:"http://.*?\\.logsoku\\.com/r/.*?/[0-9]+/",name:"logsoku"},
			{url:"http://logsoku\\.com/r/.*?/[0-9]+/",name:"logsoku"}
		];

		var i;
		var num = bbs_list.length;
		for(i=0;i<num;i++){
			var bbs = bbs_list[i];
			var re = new RegExp(bbs.url,"i");
			var m = url.match(re);
			if(m){
				work.base_url = m[0];
				work.bbs_name = bbs.name;
				break;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		var work = info.work;

		if(work.bbs_name){
			var first_id = 1;
			var last_id = 1;
			var dictionary_id = new Array();
			var element_parent = null;
			var read_more_button = null;
			var element_form = null;
			var base_url = work.base_url;
			var resource_url_shadow = base_url;
			var resource_url_more = base_url;

			// --------------------------------------------------------------------------------
			// 文字列からレスポンス番号を取得
			// --------------------------------------------------------------------------------
			work.createResponseAnchorNumbers = function (str){
				var numbers = new ResponseAnchorNumbers();

				var re_search = new RegExp("^(>>|<<|＞＞|＜＜|>|＞|》|≫|&gt;&gt;)([0-9０-９]+)","i");
				var re_range = new RegExp("^([0-9０-９]+)[-]([0-9０-９]+)","i");
				var re_number = new RegExp("^([0-9０-９]+)","i");

				var m = str.match(re_search);
				if(m){
					var p = m[1].length;
					while(true){
						// 番号-番号
						m = str.substr(p).match(re_range);
						if(m){
							var id0 = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
							var id1 = parseInt(StringConvertFromNumericFullToNumericHalf(m[2]));
							if(id0 < 1) id0 = 1;
							if(id1 < 1) id1 = 1;
							if(id0 > 10000) id0 = 10000;
							if(id1 > 10000) id1 = 10000;
							p += m[0].length;
							numbers.addNumbers(id0,id1);
						}else{
							// 番号
							m = str.substr(p).match(re_number);
							if(m){
								p += m[0].length;
								var id = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
								if(id < 1) id = 1;
								if(id > 0x7fffffff) id = 0x7fffffff;
								numbers.addNumber(id);
							}
						}

						if(m){
							// カンマ
							if(RegExp.rightContext.search(",") == 0){
								p += 1;
								continue;
							}
						}
						break;
					}
				}
				return numbers;
			};

			// --------------------------------------------------------------------------------
			// レスアンカー拡張
			// --------------------------------------------------------------------------------
			work.extendResponseAnchor = function (target){
				if(BbsControlResponseAnchorExist(target))	return;

				var re_simple = new RegExp("^(>>|<<|>)[-,0-9０-９]+$","i");
				var re_detail = new RegExp("(>>|<<|＞＞|＜＜|>|＞|》|≫|&gt;&gt;)(([0-9０-９]+[-][0-9０-９]+|[0-9０-９]+),)*([0-9０-９]+[-][0-9０-９]+|[0-9０-９]+)","i");
				var re_range = new RegExp("([0-9０-９]+)[-]([0-9０-９]+)","i");
				var re_number = new RegExp("([0-9０-９]+)","i");

				var i;
				var nodes = ElementGetElementsByTagName(target,"a");
				var num = nodes.length;
				for(i=num-1;i>=0;i--){
					var node = nodes[i];
					var m = ElementGetTextContent(node).match(re_simple);
					if(m){
						var text_node = DocumentCreateText(m[0]);
						DomNode_InsertBefore(node,text_node);
						DomNodeRemove(node);
					}
				}

				// テキストノードを統合
				target.normalize();

				var p;
				var n;
				var q;
				var ignore_dictionary = {"A":1,"SCRIPT":1};
				var queue = new Object();
				q = {p:queue,n:queue,node:target};
				queue.p = q;
				queue.n = q;

				while(queue.n != queue){
					q = queue.n;
					p = q.p;
					n = q.n;
					p.n = n;
					n.p = p;
					var node = q.node;
					switch(node.nodeType){
					case 1:
						var i;
						var nodes = node.childNodes;
						var num = nodes.length;
						for(i=0;i<num;i++){
							n = queue;
							p = n.p;
							q = {p:p,n:n,node:nodes[i]};
							p.n = q;
							n.p = q;
						}
						break;
					case 3:
						while(node){
							var m = DomNodeGetNodeValue(node).match(re_detail);
							if(!m)	break;

							// 元のテキストノード
							DomNodeSetNodeValue(node,RegExp.leftContext);

							// BbsControlName を生成
							var element = DocumentCreateElement("a");
							ElementSetTextContent(element,m[0]);
							DomNode_InsertAfter(node,element);

							// 直後テキスト
							node = DocumentCreateText(RegExp.rightContext);
							DomNode_InsertAfter(element,node);

							var query = "";
							m = ElementGetTextContent(element).match(re_range);
							if(m){
								var min = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
								var max = parseInt(StringConvertFromNumericFullToNumericHalf(m[2]));
								if(min < 1) min = 1;
								if(max < 1) max = 1;
								if(min > 10000) min = 10000;
								if(max > 10000) max = 10000;
								if(max < min){
									var tmp = min;
									min = max;
									max = tmp;
								}
								query = min + "-" + max;
							}else{
								// 番号
								m = ElementGetTextContent(element).match(re_number);
								if(m){
									query = parseInt(StringConvertFromNumericFullToNumericHalf(m[0]));
									if(query < 1) query = 1;
									if(query > 0x7fffffff) query = 0x7fffffff;
								}

							}
							element.href = work.base_url + query;
						}
					}
				}
			};

			// --------------------------------------------------------------------------------
			// 継ぎ足し読み込み
			// --------------------------------------------------------------------------------
			function readMore(){

				// ローダーオブジェクトを作成
				var loader = new Loader();

				// 成功
				loader.onload = function(str){
					var re_number = new RegExp("<div id=\"([0-9]+)\">","i");

					var p = 0;
					var n = str.length;
					function f(){
						try{
							if(p >= n) throw 0;
							p = str.indexOf("<div id=",p);
							if(p < 0) throw 0;
							var e = str.indexOf("</div>",p);
							if(e >= 0){
								e = str.indexOf("</div>",e + 6);
								if(e >= 0) e += 6;
							}
							var s = str.substring(p,e);
							var m = s.match(re_number);
							if(m){
								var id = parseInt(m[1]);
								if(last_id < id){
									var response = bbs_dictionary.getResponse(id);
									response.clearAnalyzed();
									response.clearOriginalElements();
									response.clearFollowing();

									var nodes = StringHtmlCreateDomNodesSafe(s);
									var j;
									var node_num = nodes.length;
									for(j=0;j<node_num;j++){
										element_parent.appendChild(nodes[j]);
									}
									last_id = id;
									resource_url_more = base_url + (last_id) + "-";
								}
							}

							if(p < e){
								p = e;
								execute_queue.attachFirst(f,null);
								return;
							}
						}catch(e){
						}
						read_more_button.init();
					}

					p = str.indexOf("<div id=\"comments\">",p);
					if(p >= 0){
						p += 19;
						execute_queue.attachFirst(f,null);
					}
				};

				// 失敗
				loader.onerror = function(){
					read_more_button.init();
				};

				// テキストの読み込み
				loader.setMethod("GET");
				loader.setURL(resource_url_more);
				loader.loadText();
			}

			// --------------------------------------------------------------------------------
			// レスポンス親要素
			// --------------------------------------------------------------------------------
			element_parent = document.getElementById("comments");
			if(!element_parent) return false;

			// --------------------------------------------------------------------------------
			// 範囲取得
			// --------------------------------------------------------------------------------
			var nodes = ElementGetElementsByTagName(element_parent,"div");
			var i;
			var node_num = nodes.length;
			for(i=0;i<node_num;i++){
				var node = nodes[i];
				var m = node.id.match(new RegExp("^([0-9]+)$","i"));
				if(m){
					first_id = parseInt(m[1]);
					dictionary_id[first_id] = true;
					if(first_id != 1){
						break;
					}
				}
			}
			for(i=node_num-1;i>=0;i--){
				var node = nodes[i];
				var m = node.id.match(new RegExp("^([0-9]+)$","i"));
				if(m){
					last_id = parseInt(m[1]);
					dictionary_id[last_id] = true;
					break;
				}
			}

			// --------------------------------------------------------------------------------
			// アクセス先 URL
			// --------------------------------------------------------------------------------
			resource_url_shadow = base_url;
			resource_url_more = base_url + last_id + "-";

			// --------------------------------------------------------------------------------
			// BbsControlReadMoreButton 作成
			// --------------------------------------------------------------------------------
			read_more_button = new BbsControlReadMoreButton();
			read_more_button.setWaitTime(2 * 1000);
			read_more_button.onclick = readMore;
			DomNode_InsertAfter(element_parent,read_more_button.getElement());


			// --------------------------------------------------------------------------------
			// シャドウロード
			// --------------------------------------------------------------------------------
			(function(){
				// ローダーオブジェクトを作成
				var loader = new Loader();

				// 成功
				loader.onload = function(str){
					var re_number = new RegExp("<div id=\"([0-9]+)\">","i");
					var re_id = new RegExp("ID:([-a-zA-Z0-9+/.]+)[●!]{0,2}","i");
					var re_name = new RegExp("(◆[a-zA-Z0-9+/.]{10,12})","i");

					var p = 0;
					var n = str.length;
					function f(){
						if(p >= n) return;
						p = str.indexOf("<div id=",p);
						if(p < 0) return;
						var e = str.indexOf("</div>",p);
						if(e >= 0){
							e = str.indexOf("</div>",e + 6);
							if(e >= 0) e += 6;
						}
						var s = str.substring(p,e);
						var m = s.match(re_number);
						if(m){
							var id = parseInt(m[1]);
							if((first_id <= id) && (id <= last_id)){
							}else if(dictionary_id[id]){
							}else{
								// ナンバーからレスポンスオブジェクトを取得
								var response = bbs_dictionary.getResponse(id);
								if(!(response.getAnalyzed())){
									var nodes = StringHtmlCreateDomNodesSafe(s);
									var dt = nodes[0];
									var dd = ElementGetElementsByTagName(dt,"DIV")[0];

									try{
										if(dt.tagName != "DIV")	return;
										if(!dt.id.match(/^[0-9]+$/))	return;
										if(dd.className != "comment")	return;
									}catch(e){
										return;
									}

									var dt_text = ElementGetTextContent(dt);

									// レスアンカー拡張
									work.extendResponseAnchor(dd);

									// IDの取得
									if(dt_text.match(re_id)){
										response.setId(RegExp.$1);
									}

									// 名前の取得
									if(dt_text.match(re_name)){
										response.setName(RegExp.$1);
									}

									// ホスト名の取得
									(function(){
										var p;
										var n;
										var q;
										var ignore_dictionary = {"B":1,"SCRIPT":1};
										var queue = new Object();
										q = {p:queue,n:queue,node:dt};
										queue.p = q;
										queue.n = q;

										while(queue.n != queue){
											q = queue.n;
											p = q.p;
											n = q.n;
											p.n = n;
											n.p = p;
											var node = q.node;
											switch(node.nodeType){
											case 1:
												if(!(ignore_dictionary[node.tagName])){
													var i;
													var nodes = node.childNodes;
													var num = nodes.length;
													for(i=0;i<num;i++){
														n = queue;
														p = n.p;
														q = {p:p,n:n,node:nodes[i]};
														p.n = q;
														n.p = q;
													}
												}
												break;
											case 3:
												var m = DomNodeGetNodeValue(node).match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
												if(m){
													response.setHost(m[2]);
													return;
												}
												var m = DomNodeGetNodeValue(node).match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})\\n \\]","i"));
												if(m){
													response.setHost(m[2]);
													return;
												}
												var m = DomNodeGetNodeValue(node).match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
												if(m){
													response.setHost(m[2]);
													return;
												}
												break;
											}
										}
									})();

									// フォロー解析
									var dictionary = new Object();
									(function(){
										var nodes = ElementGetElementsByTagName(dd,"a");
										var i;
										var num = nodes.length;
										for(i=0;i<num;i++){
											var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(nodes[i]));
											numbers.getNumbers(function(n){
												if(!dictionary[n]){
													var following = bbs_dictionary.getResponse(n);
													following.addFollower(response);
													dictionary[n] = true;
												}
											});
										}
									})();

									// オリジナルエレメントをセット
									if(dt)	response.addOriginalElements("dt",dt);
									if(dd)	response.addOriginalElements("dd",dd);

									// 消去時に実行されるイベント
									response.onerase = function(){};

									response.setAnalyzed();
								}
							}
						}
						if(p < e){
							p = e;
							execute_queue.attachFirst(f,null);
						}
					}

					p = str.indexOf("<div id=\"comments\">",p);
					if(p >= 0){
						p += 19;
						execute_queue.attachFirst(f,null);
					}
				};

				// 失敗
				loader.onerror = function(){
				};

				// テキストの読み込み
				loader.setMethod("GET");
				loader.setURL(resource_url_shadow);
				loader.loadText();
			})();

			response({result:true});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		response({result:false});
		return true;
	}.toString() +
"\n]";

					preset.script_callback = 
"[\n\t" + 
	function(info,response){
		var element = info.element;
		var work = info.work;

		// --------------------------------------------------------------------------------
		// レスポンスダイアログを登録
		// --------------------------------------------------------------------------------
		function attachBbsResponseDialog(response,node,parent_dialog,type){

			// --------------------------------------------------------------------------------
			// レスアンカー
			// --------------------------------------------------------------------------------
			function forResponseAnchor(target){
				if(BbsControlResponseAnchorExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlResponseAnchor を生成
				// --------------------------------------------------------------------------------
				(function(){
					var i;
					var nodes = ElementGetElementsByTagName(target,"a");
					var num = nodes.length;
					for(i=0;i<num;i++){
						var node = nodes[i];
						var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(node));
						if(numbers.getCount()){
							var control_res_anchor = new BbsControlResponseAnchor(node,false);
							control_res_anchor.setResponseAnchorNumbers(numbers);
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlResponseAnchor を検索
				// --------------------------------------------------------------------------------
				BbsControlResponseAnchorSearch(target,function(control_res_anchor){

					var element_res_anchor = control_res_anchor.getElement();
					var numbers = control_res_anchor.getResponseAnchorNumbers();

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_res_anchor);
					response_dialog.oncreate = function(_window,callback){

						var created = false;
						var i = 0;
						var number_list = numbers.getNumberList();
						var num = number_list.length;
						if(!num) return false;

						function f(){
							var following = bbs_dictionary.getResponse(number_list[i]);
							var clone = following.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){
								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									_window.appendChild(obj.element);
								}
								try{
									var dd = ElementGetElementsByTagName(param["dt"],"div")[0];
									DomNode_InsertBefore(dd,param["dd"]);
									DomNodeRemove(dd);
									param["dd"].style.minHeight = "0px";
								}catch(e){
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(following,param,response_dialog,"response");

								created = true;
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:created});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// ID
			// --------------------------------------------------------------------------------
			function forId(target){
				if(BbsControlIdExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlId を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"A":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}

							// 名前欄
							if(node.tagName == "A"){
								var m = node.href.match(new RegExp("/ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}$","i"));
								if(m){
									// BbsControlId を生成
									var control_id = new BbsControlId(null,true);
									control_id.setId(m[1]);
									var element_id = control_id.getElement();
									DomNode_InsertAfter(node,element_id);
									var textnode_id = DocumentCreateText("");
									element_id.appendChild(textnode_id);
									control_id.setTextNode(textnode_id);
								}
							}

							break;
						case 3:
							while(node){

								var m = DomNodeGetNodeValue(node).match(new RegExp("ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(node,RegExp.leftContext);

								// BbsControlId を生成
								var control_id = new BbsControlId(null,false);
								control_id.setId(m[1]);
								var element_id = control_id.getElement();
								ElementSetTextContent(element_id,m[0]);
								DomNode_InsertAfter(node,element_id);
								var textnode_id = DocumentCreateText("");
								element_id.appendChild(textnode_id);
								control_id.setTextNode(textnode_id);

								// 直後テキスト
								node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(element_id,node);
							}
							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlId を検索
				// --------------------------------------------------------------------------------
				BbsControlIdSearch(target,function(control_id){

					control_id.setResponse(response);

					var id = control_id.getId();
					var element_id = control_id.getElement();
					var textnode_id = control_id.getTextNode();

					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_id.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_id,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_id,"");
						}

						var style = element_id.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","small");
						}
					};
					control_id.update();

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "id"){
						if(response.getId() == id)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_id);
					response_dialog.oncreate = function(_window,callback){

						var responses = bbs_dictionary.getResponsesFromId(id);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_id = responses[i];
							var clone = response_id.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									_window.appendChild(obj.element);
								}
								try{
									var dd = ElementGetElementsByTagName(param["dt"],"div")[0];
									DomNode_InsertBefore(dd,param["dd"]);
									DomNodeRemove(dd);
									param["dd"].style.minHeight = "0px";
								}catch(e){
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_id,param,response_dialog,"id");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// トリップ
			// --------------------------------------------------------------------------------
			function forName(target){
				if(BbsControlNameExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlName を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							while(node){

								// 本文
								var m = DomNodeGetNodeValue(node).match(new RegExp("(◆(|[ ])[a-zA-Z0-9+/.]{10,12})","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(node,RegExp.leftContext);

								// BbsControlName を生成
								var control_name = new BbsControlName(null,false);
								control_name.setName(m[0]);
								var element_name = control_name.getElement();
								ElementSetTextContent(element_name,m[0]);
								DomNode_InsertAfter(node,element_name);

								// 直後テキスト
								node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(element_name,node);
							}
							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlName を検索
				// --------------------------------------------------------------------------------
				BbsControlNameSearch(target,function(control_name){

					control_name.setResponse(response);

					var name = control_name.getName();
					var element_name = control_name.getElement();
					var textnode_name = DocumentCreateText("");


					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_name.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_name,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_name,"");
						}

						var style = element_name.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","small");
						}
					};
					control_name.update();
					element_name.appendChild(textnode_name);

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "name"){
						if(response.getName() == name)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_name);
					response_dialog.oncreate = function(_window,callback){

						var responses = bbs_dictionary.getResponsesFromName(name);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_name = responses[i];
							var clone = response_name.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									_window.appendChild(obj.element);
								}
								try{
									var dd = ElementGetElementsByTagName(param["dt"],"div")[0];
									DomNode_InsertBefore(dd,param["dd"]);
									DomNodeRemove(dd);
									param["dd"].style.minHeight = "0px";
								}catch(e){
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_name,param,response_dialog,"name");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// ホスト
			// --------------------------------------------------------------------------------
			function forHost(target){
				if(BbsControlHostExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlHost を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"B":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							while(node){
								var text_value = DomNodeGetNodeValue(node);

								var m = text_value.match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
								if(m){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext + m[1]);

									// BbsControlHost を生成
									var control_host = new BbsControlHost(null,false);
									control_host.setHost(m[2]);
									var element_host = control_host.getElement();
									ElementSetTextContent(element_host,m[2]);
									DomNode_InsertAfter(node,element_host);

									// 直後テキスト
									node = DocumentCreateText(RegExp.rightContext);
									DomNode_InsertAfter(element_host,node);
									continue;
								}

								var m = text_value.match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})(\\n \\])","i"));
								if(m){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext + m[1]);

									// BbsControlHost を生成
									var control_host = new BbsControlHost(null,false);
									control_host.setHost(m[2]);
									var element_host = control_host.getElement();
									ElementSetTextContent(element_host,m[2]);
									DomNode_InsertAfter(node,element_host);

									// 直後テキスト
									node = DocumentCreateText("\n ]" + RegExp.rightContext);
									DomNode_InsertAfter(element_host,node);
									continue;
								}

								var m = text_value.match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
								if(m){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext + m[1]);

									// BbsControlHost を生成
									var control_host = new BbsControlHost(null,false);
									control_host.setHost(m[2]);
									var element_host = control_host.getElement();
									ElementSetTextContent(element_host,m[2]);
									DomNode_InsertAfter(node,element_host);

									// 直後テキスト
									node = DocumentCreateText(RegExp.rightContext);
									DomNode_InsertAfter(element_host,node);
									continue;
								}

								break;
							}

							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlHost を検索
				// --------------------------------------------------------------------------------
				BbsControlHostSearch(target,function(control_host){

					control_host.setResponse(response);

					var host = control_host.getHost();
					var element_host = control_host.getElement();
					var textnode_host = DocumentCreateText("");


					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_host.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_host,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_host,"");
						}

						var style = element_host.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","80%");
						}
					};
					control_host.update();
					element_host.appendChild(textnode_host);

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "host"){
						if(response.getHost() == host)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_host);
					response_dialog.oncreate = function(_window,callback){

						var responses = bbs_dictionary.getResponsesFromHost(host);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_host = responses[i];
							var clone = response_host.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									_window.appendChild(obj.element);
								}
								try{
									var dd = ElementGetElementsByTagName(param["dt"],"div")[0];
									DomNode_InsertBefore(dd,param["dd"]);
									DomNodeRemove(dd);
									param["dd"].style.minHeight = "0px";
								}catch(e){
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_host,param,response_dialog,"host");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// フォロワー
			// --------------------------------------------------------------------------------
			function forFollower(target){
				if(BbsControlFollowerExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlFollower を生成
				// --------------------------------------------------------------------------------
				var control_follower = new BbsControlFollower(null,true);
				control_follower.setResponse(response);

				var element_follower = control_follower.getElement();
				var textnode_follower = DocumentCreateText("");

				element_follower.appendChild(textnode_follower);

				// --------------------------------------------------------------------------------
				// 変化があったときに実行されるイベント
				// --------------------------------------------------------------------------------
				control_follower.onchange = function(count){
					if(count){
						textnode_follower.nodeValue = " follower(" + count + ")";
					}else{
						textnode_follower.nodeValue = "";
					}

					var style = element_follower.style;
					if(count >= 3){
						StyleDeclarationSetProperty(style,"color","#e80000");
						StyleDeclarationRemoveProperty(style,"font-size");

					}else{
						StyleDeclarationSetProperty(style,"color","#888");
						StyleDeclarationSetProperty(style,"font-size","small");
					}
					if(count){
						StyleDeclarationSetProperty(style,"margin","0px 4px 0px 0px");
					}else{
						StyleDeclarationRemoveProperty(style,"margin");
					}
				};
				control_follower.update();
				var nodes = ElementGetElementsByTagName(target,"div");
				if(nodes.length){
					DomNode_InsertBefore(nodes[0],element_follower);
				}else{
					target.appendChild(element_follower);
				}

				// --------------------------------------------------------------------------------
				// ポップアップ化
				// --------------------------------------------------------------------------------
				// ダイアログを作成
				var response_dialog = new BbsResponseDialog();
				if(parent_dialog)	parent_dialog.attachChild(response_dialog);
				response_dialog.setElementParent(node.parent);
				response_dialog.setElementHitArea(element_follower);
				response_dialog.oncreate = function(_window,callback){

					var ary = response.getFollower();
					var i = 0;
					var num = ary.length;
					if(num <= 0) return false;

					function f(){
						var follower = bbs_dictionary.getResponse(ary[i].getNumber());
						var clone = follower.getCloneElements();

						var j;
						var clone_num = clone.length;
						if(clone_num){

							var param = new Object();
							param.parent = node.parent;
							for(j=0;j<clone_num;j++){
								var obj = clone[j];
								param[obj.name] = obj.element;
								_window.appendChild(obj.element);
							}
							try{
								var dd = ElementGetElementsByTagName(param["dt"],"div")[0];
								DomNode_InsertBefore(dd,param["dd"]);
								DomNodeRemove(dd);
								param["dd"].style.minHeight = "0px";
							}catch(e){
							}

							// レスポンスダイアログを登録
							attachBbsResponseDialog(follower,param,response_dialog,"response");
						}

						i += 1;
						if(i < num){
							execute_queue.attachFirst(f,null);
						}else{
							callback({result:true});
						}
					}
					execute_queue.attachFirst(f,null);
				};
			}

			if(node.dt){
				forResponseAnchor(node.dt);
				forId(node.dt);
				forName(node.dt);
				forHost(node.dt);
				forFollower(node.dt);
			}
			if(node.dd){
				forResponseAnchor(node.dd);
				forId(node.dd);
				forName(node.dd);
			}
		}

		// --------------------------------------------------------------------------------
		// エレメントを解析
		// --------------------------------------------------------------------------------
		var useful = (function(){
			var dt = element;
			var dd;

			try{
				if(dt.tagName != "DIV")	return false;
				if(!dt.id.match(/^[0-9]+$/))	return false;
			}catch(e){
				return false;
			}

			try{
				dd = ElementGetElementsByTagName(dt,"DIV")[0];
				if(dd.className != "comment")	return false;
			}catch(e){
				return false;
			}

			try{
				var div = dt.parentNode;
				if(div.tagName != "DIV")	return false;
				if(div.id != "comments")	return false;
			}catch(e){
				return false;
			}

			// document に未登録
			if(!DomNodeGetAttachedDocument(dt))	return false;

			// --------------------------------------------------------------------------------
			// レスアンカー拡張
			// --------------------------------------------------------------------------------
			work.extendResponseAnchor(dd);

			// --------------------------------------------------------------------------------
			// クリーンアップ
			// --------------------------------------------------------------------------------
			(function(){
				function cleanupIdInfo(target){
					var p;
					var n;
					var q;
					var ignore_tag = {"A":1};
					var ignore_class = {"comment":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(ignore_tag[node.tagName]){
							}else if(ignore_class[node.className]){
							}else{
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}

							break;
						case 3:
							while(node){
								var m = DomNodeGetNodeValue(node).match(new RegExp("\[[0-9]+/[0-9]+回.*?\]","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(node,RegExp.leftContext);

								// 直後テキスト
								var next_node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(node,next_node);
								node = next_node;
							}
							break;
						}
					}
				}

				function cleanup(target){
					BbsControlSearchTrash(target,function(element){
						var node = element.firstChild;
						if(!node)	return null;
						if(node.nodeType != 3)	return null;

						// ID
						var m = node.nodeValue.match(new RegExp("^ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);
							return null;
						}

						// トリップ
						var m = node.nodeValue.match(new RegExp("^(◆(|[ ])[a-zA-Z0-9+/.]{10,12})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);
							return null;
						}

						// ホスト名
						var m = node.nodeValue.match(new RegExp("^([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);

							// テキストノードを統合
							node.parentNode.normalize();
							return null;
						}
						var m = node.nodeValue.match(new RegExp("^([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);

							// テキストノードを統合
							node.parentNode.normalize();
							return null;
						}

						return null;
					});
				}

				if(dt){
					cleanupIdInfo(dt);
					cleanup(dt);
				}
				if(dd){
					cleanup(dd);
				}
			})();

			// ナンバーを取得
			var dt_text = ElementGetTextContent(dt);
			if(!(dt_text.match(new RegExp("([0-9]+)","i"))))	return false;

			// ナンバーからレスポンスオブジェクトを取得
			var response = bbs_dictionary.getResponse(parseInt(RegExp.$1));

			// レスポンス解析
			if(!response.getAnalyzed()){

				(function(){
					// 本文を除外
					var dt_clone = dt.cloneNode(true);
					try{
						var div = ElementGetElementsByTagName(dt_clone,"div")[0];
						DomNodeRemove(div);
					}catch(e){
					}
					dt_text = ElementGetTextContent(dt_clone);
				})();

				// IDの取得
				if(dt_text.match(new RegExp("ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"))){
					response.setId(RegExp.$1);
				}

				// 名前の取得
				if(dt_text.match(new RegExp("(◆(|[ ])[a-zA-Z0-9+/.]{10,12})","i"))){
					response.setName(RegExp.$1);
				}

				// ホスト名の取得
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"B":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:dt};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							var m = DomNodeGetNodeValue(node).match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
							if(m){
								response.setHost(m[2]);
								return;
							}
							var m = DomNodeGetNodeValue(node).match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})\\n \\]","i"));
							if(m){
								response.setHost(m[2]);
								return;
							}
							var m = DomNodeGetNodeValue(node).match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
							if(m){
								response.setHost(m[2]);
								return;
							}
							break;
						}
					}
				})();

				// フォロー解析
				var dictionary = new Object();
				(function(){
					var nodes = ElementGetElementsByTagName(dd,"a");
					var i;
					var num = nodes.length;
					for(i=0;i<num;i++){
						var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(nodes[i]));
						numbers.getNumbers(function(n){
							if(!dictionary[n]){
								var following = bbs_dictionary.getResponse(n);
								following.addFollower(response);
								dictionary[n] = true;
							}
						});
					}
				})();

				// オリジナルエレメントをセット
				if(dt)	response.addOriginalElements("dt",dt);
				if(dd)	response.addOriginalElements("dd",dd);

				// 消去時に実行されるイベント
				response.onerase = function(){
					var original = response.getOriginalElements();

					// オリジナルエレメントを外す
					var i;
					var num = original.length;
					for(i=0;i<num;i++){
						var revise_scroll = new DocumentReviseScroll();
						var node = original[i].element;
						revise_scroll.executeRemoveElementBefore(node);
						DomNodeRemove(node);
						revise_scroll.executeRemoveElementAfter(node);
					}
				};

				response.setAnalyzed();
			}

			// レスポンスダイアログを登録（ルート）
			attachBbsResponseDialog(
				response,
				{
					dt:dt,
					dd:dd,
					parent:dt.parentNode
				},
				null,
				null
			);

			return true;
		})();

		response({useful:useful});
		return true;
	}.toString() +
"\n]";

				// みみずん検索
				var obj = addPreset(proj.expand_bbs,"mimizun",null);
				var preset = obj.preset;
				preset.filter = [
					{
						pattern:"^http://mimizun\\.com/log/2ch/[^/]+/[0-9]+",
						flags:{i:true,g:false}
					},{
						pattern:"^http://mimizun\\.com/log/machi/[^/]+/[0-9]+",
						flags:{i:true,g:false}
					}
				];
				preset.script_initialize = 
"[\n\t" + 
	function(info,response){
		var work = info.work;

		// --------------------------------------------------------------------------------
		// 基本URL抽出
		// --------------------------------------------------------------------------------
		var url = document.URL;
		var bbs_list = [
			{url:"(http://mimizun\\.com/log/2ch/[^/]+/[0-9]+)",replace:"$1/",name:"mimizun"},
			{url:"(http://mimizun\\.com/log/machi/[^/]+/[0-9]+)",replace:"$1/",name:"mimizun"}
		];

		var i;
		var num = bbs_list.length;
		for(i=0;i<num;i++){
			var bbs = bbs_list[i];
			var re = new RegExp(bbs.url,"i");
			var m = url.match(re);
			if(m){
				work.base_url = m[1].replace(re,bbs.replace);
				work.bbs_name = bbs.name;
				break;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		var work = info.work;

		if(work.bbs_name){
			var first_id = 1;
			var last_id = 1;
			var dictionary_id = new Array();
			var element_parent = null;
			var read_more_button = null;
			var element_form = null;
			var base_url = work.base_url;
			var resource_url_shadow = base_url;
			var resource_url_more = base_url;

			// --------------------------------------------------------------------------------
			// 文字列からレスポンス番号を取得
			// --------------------------------------------------------------------------------
			work.createResponseAnchorNumbers = function (str){
				var numbers = new ResponseAnchorNumbers();

				var re_search = new RegExp("^(>>|<<|＞＞|＜＜|>|＞|》|≫|&gt;&gt;)([0-9０-９]+)","i");
				var re_range = new RegExp("^([0-9０-９]+)[-]([0-9０-９]+)","i");
				var re_number = new RegExp("^([0-9０-９]+)","i");

				var m = str.match(re_search);
				if(m){
					var p = m[1].length;
					while(true){
						// 番号-番号
						m = str.substr(p).match(re_range);
						if(m){
							var id0 = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
							var id1 = parseInt(StringConvertFromNumericFullToNumericHalf(m[2]));
							if(id0 < 1) id0 = 1;
							if(id1 < 1) id1 = 1;
							if(id0 > 10000) id0 = 10000;
							if(id1 > 10000) id1 = 10000;
							p += m[0].length;
							numbers.addNumbers(id0,id1);
						}else{
							// 番号
							m = str.substr(p).match(re_number);
							if(m){
								p += m[0].length;
								var id = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
								if(id < 1) id = 1;
								if(id > 0x7fffffff) id = 0x7fffffff;
								numbers.addNumber(id);
							}
						}

						if(m){
							// カンマ
							if(RegExp.rightContext.search(",") == 0){
								p += 1;
								continue;
							}
						}
						break;
					}
				}
				return numbers;
			};

			// --------------------------------------------------------------------------------
			// レスアンカー拡張
			// --------------------------------------------------------------------------------
			work.extendResponseAnchor = function (target){
				if(BbsControlResponseAnchorExist(target))	return;

				var re_simple = new RegExp("^(>>|<<|>)[-,0-9０-９]+$","i");
				var re_detail = new RegExp("(>>|<<|＞＞|＜＜|>|＞|》|≫|&gt;&gt;)(([0-9０-９]+[-][0-9０-９]+|[0-9０-９]+),)*([0-9０-９]+[-][0-9０-９]+|[0-9０-９]+)","i");
				var re_range = new RegExp("([0-9０-９]+)[-]([0-9０-９]+)","i");
				var re_number = new RegExp("([0-9０-９]+)","i");

				var i;
				var nodes = ElementGetElementsByTagName(target,"a");
				var num = nodes.length;
				for(i=num-1;i>=0;i--){
					var node = nodes[i];
					var m = ElementGetTextContent(node).match(re_simple);
					if(m){
						var text_node = DocumentCreateText(m[0]);
						DomNode_InsertBefore(node,text_node);
						DomNodeRemove(node);
					}
				}

				// テキストノードを統合
				target.normalize();

				var p;
				var n;
				var q;
				var ignore_dictionary = {"A":1,"SCRIPT":1};
				var queue = new Object();
				q = {p:queue,n:queue,node:target};
				queue.p = q;
				queue.n = q;

				while(queue.n != queue){
					q = queue.n;
					p = q.p;
					n = q.n;
					p.n = n;
					n.p = p;
					var node = q.node;
					switch(node.nodeType){
					case 1:
						var i;
						var nodes = node.childNodes;
						var num = nodes.length;
						for(i=0;i<num;i++){
							n = queue;
							p = n.p;
							q = {p:p,n:n,node:nodes[i]};
							p.n = q;
							n.p = q;
						}
						break;
					case 3:
						while(node){
							var m = DomNodeGetNodeValue(node).match(re_detail);
							if(!m)	break;

							// 元のテキストノード
							DomNodeSetNodeValue(node,RegExp.leftContext);

							// BbsControlName を生成
							var element = DocumentCreateElement("a");
							ElementSetTextContent(element,m[0]);
							DomNode_InsertAfter(node,element);

							// 直後テキスト
							node = DocumentCreateText(RegExp.rightContext);
							DomNode_InsertAfter(element,node);

							var query = "";
							m = ElementGetTextContent(element).match(re_range);
							if(m){
								var min = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
								var max = parseInt(StringConvertFromNumericFullToNumericHalf(m[2]));
								if(min < 1) min = 1;
								if(max < 1) max = 1;
								if(min > 10000) min = 10000;
								if(max > 10000) max = 10000;
								if(max < min){
									var tmp = min;
									min = max;
									max = tmp;
								}
								query = min + "-" + max;
							}else{
								// 番号
								m = ElementGetTextContent(element).match(re_number);
								if(m){
									query = parseInt(StringConvertFromNumericFullToNumericHalf(m[0]));
									if(query < 1) query = 1;
									if(query > 0x7fffffff) query = 0x7fffffff;
								}

							}
							element.href = work.base_url + query;
						}
					}
				}
			};

			// --------------------------------------------------------------------------------
			// 継ぎ足し読み込み
			// --------------------------------------------------------------------------------
			function readMore(){

				// ローダーオブジェクトを作成
				var loader = new Loader();

				// 成功
				loader.onload = function(str){
					var re_number = new RegExp("<a name=\"([0-9]+)\">","i");

					var p = 0;
					var n = str.length;
					function f(){
						try{
							if(p >= n) throw 0;
							p = str.indexOf("<div class=\"contributor\">",p);
							if(p < 0) throw 0;
							var e = str.indexOf("\n",p);
							var s = str.substring(p,e);
							var m = s.match(re_number);
							if(m){
								var id = parseInt(m[1]);
								if(last_id < id){
									var response = bbs_dictionary.getResponse(id);
									response.clearAnalyzed();
									response.clearOriginalElements();
									response.clearFollowing();

									var nodes = StringHtmlCreateDomNodesSafe(s);
									var j;
									var node_num = nodes.length;
									for(j=0;j<node_num;j++){
										element_parent.appendChild(nodes[j]);
									}
									last_id = id;
									resource_url_more = base_url + (last_id) + "-";
								}
							}

							if(p < e){
								p = e + 1;
								execute_queue.attachFirst(f,null);
								return;
							}
						}catch(e){
						}
						read_more_button.init();
					}
					execute_queue.attachFirst(f,null);
				};

				// 失敗
				loader.onerror = function(){
					read_more_button.init();
				};

				// テキストの読み込み
				loader.setMethod("GET");
				loader.setURL(resource_url_more);
				loader.overrideMimeType("text/plain; charset=Shift_JIS");
				loader.loadText();
			}

			// --------------------------------------------------------------------------------
			// レスポンス親要素
			// --------------------------------------------------------------------------------
			if(!element_parent) element_parent = document.getElementById("thread");
			if(!element_parent) element_parent = document.getElementById("thread2");
			if(!element_parent) return false;

			// --------------------------------------------------------------------------------
			// 範囲取得
			// --------------------------------------------------------------------------------
			var nodes = ElementGetElementsByTagName(element_parent,"div");
			var i;
			var node_num = nodes.length;
			for(i=0;i<node_num;i++){
				var node = nodes[i];
				if(node.className == "contributor"){
					var m = ElementGetTextContent(node).match(new RegExp("([0-9]+)","i"));
					if(m){
						first_id = parseInt(m[1]);
						dictionary_id[first_id] = true;
						if(first_id != 1){
							break;
						}
					}
				}
			}
			for(i=node_num-1;i>=0;i--){
				var node = nodes[i];
				if(node.className == "contributor"){
					var m = ElementGetTextContent(node).match(new RegExp("([0-9]+)","i"));
					if(m){
						last_id = parseInt(m[1]);
						dictionary_id[last_id] = true;
						break;
					}
				}
			}

			// --------------------------------------------------------------------------------
			// アクセス先 URL
			// --------------------------------------------------------------------------------
			resource_url_shadow = base_url;
			resource_url_more = base_url + last_id + "-";

			// --------------------------------------------------------------------------------
			// BbsControlReadMoreButton 作成
			// --------------------------------------------------------------------------------
			read_more_button = new BbsControlReadMoreButton();
			read_more_button.setWaitTime(2 * 1000);
			read_more_button.onclick = readMore;
			DomNode_InsertAfter(element_parent,read_more_button.getElement());

			// --------------------------------------------------------------------------------
			// シャドウロード
			// --------------------------------------------------------------------------------
			(function(){
				// ローダーオブジェクトを作成
				var loader = new Loader();

				// 成功
				loader.onload = function(str){
					var re_number = new RegExp("<a name=\"([0-9]+)\">","i");
					var re_id = new RegExp("ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i");
					var re_name = new RegExp("(◆(|[ ])[a-zA-Z0-9+/.]{10,12})","i");

					var p = 0;
					var n = str.length;
					function f(){
						if(p >= n) return;
						p = str.indexOf("<div class=\"contributor\">",p);
						if(p < 0) return;
						var e = str.indexOf("\n",p);
						var s = str.substring(p,e);
						var m = s.match(re_number);
						if(m){
							var id = parseInt(m[1]);
							if((first_id <= id) && (id <= last_id)){
							}else if(dictionary_id[id]){
							}else{
								// ナンバーからレスポンスオブジェクトを取得
								var response = bbs_dictionary.getResponse(id);
								if(!(response.getAnalyzed())){
									var nodes = StringHtmlCreateDomNodesSafe(s);
									var dt = nodes[0];
									var dd = nodes[1];

									try{
										if(dt.tagName != "DIV")	return;
										if(dt.className != "contributor")	return;
										if(dd.tagName != "DIV")	return;
										if(dd.className != "res")	return;
									}catch(e){
										return;
									}

									var dt_text = ElementGetTextContent(dt);

									// レスアンカー拡張
									work.extendResponseAnchor(dd);

									// IDの取得
									if(dt_text.match(re_id)){
										response.setId(RegExp.$1);
									}

									// 名前の取得
									if(dt_text.match(re_name)){
										response.setName(RegExp.$1);
									}

									// ホスト名の取得
									(function(){
										var p;
										var n;
										var q;
										var ignore_dictionary = {"B":1,"SCRIPT":1};
										var queue = new Object();
										q = {p:queue,n:queue,node:dt};
										queue.p = q;
										queue.n = q;

										while(queue.n != queue){
											q = queue.n;
											p = q.p;
											n = q.n;
											p.n = n;
											n.p = p;
											var node = q.node;
											switch(node.nodeType){
											case 1:
												if(!(ignore_dictionary[node.tagName])){
													var i;
													var nodes = node.childNodes;
													var num = nodes.length;
													for(i=0;i<num;i++){
														n = queue;
														p = n.p;
														q = {p:p,n:n,node:nodes[i]};
														p.n = q;
														n.p = q;
													}
												}
												break;
											case 3:
												var m = DomNodeGetNodeValue(node).match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
												if(m){
													response.setHost(m[2]);
													return;
												}
												var m = DomNodeGetNodeValue(node).match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,}) \\]","i"));
												if(m){
													response.setHost(m[2]);
													return;
												}
												var m = DomNodeGetNodeValue(node).match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
												if(m){
													response.setHost(m[2]);
													return;
												}
												break;
											}
										}
									})();

									// フォロー解析
									var dictionary = new Object();
									(function(){
										var nodes = ElementGetElementsByTagName(dd,"a");
										var i;
										var num = nodes.length;
										for(i=0;i<num;i++){
											var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(nodes[i]));
											numbers.getNumbers(function(n){
												if(!dictionary[n]){
													var following = bbs_dictionary.getResponse(n);
													following.addFollower(response);
													dictionary[n] = true;
												}
											});
										}
									})();

									// オリジナルエレメントをセット
									if(dt)	response.addOriginalElements("dt",dt);
									if(dd)	response.addOriginalElements("dd",dd);

									// 消去時に実行されるイベント
									response.onerase = function(){};

									response.setAnalyzed();
								}
							}
						}

						if(p < e){
							p = e + 1;
							execute_queue.attachFirst(f,null);
						}
					}
					execute_queue.attachFirst(f,null);
				};

				// 失敗
				loader.onerror = function(){
				};

				// テキストの読み込み
				loader.setMethod("GET");
				loader.setURL(resource_url_shadow);
				loader.loadText();
			})();

			response({result:true});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		response({result:false});
		return true;
	}.toString() +
"\n]";

					preset.script_callback = 
"[\n\t" + 
	function(info,response){
		var element = info.element;
		var work = info.work;

		// --------------------------------------------------------------------------------
		// レスポンスダイアログを登録
		// --------------------------------------------------------------------------------
		function attachBbsResponseDialog(response,node,parent_dialog,type){

			// --------------------------------------------------------------------------------
			// レスアンカー
			// --------------------------------------------------------------------------------
			function forResponseAnchor(target){
				if(BbsControlResponseAnchorExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlResponseAnchor を生成
				// --------------------------------------------------------------------------------
				(function(){
					var i;
					var nodes = ElementGetElementsByTagName(target,"a");
					var num = nodes.length;
					for(i=0;i<num;i++){
						var node = nodes[i];
						var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(node));
						if(numbers.getCount()){
							var control_res_anchor = new BbsControlResponseAnchor(node,false);
							control_res_anchor.setResponseAnchorNumbers(numbers);
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlResponseAnchor を検索
				// --------------------------------------------------------------------------------
				BbsControlResponseAnchorSearch(target,function(control_res_anchor){

					var element_res_anchor = control_res_anchor.getElement();
					var numbers = control_res_anchor.getResponseAnchorNumbers();

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_res_anchor);
					response_dialog.oncreate = function(_window,callback){

						var created = false;
						var i = 0;
						var number_list = numbers.getNumberList();
						var num = number_list.length;
						if(!num) return false;

						function f(){
							var following = bbs_dictionary.getResponse(number_list[i]);
							var clone = following.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){
								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									_window.appendChild(obj.element);
								}
								try{
									var dd = ElementGetElementsByTagName(param["dt"],"p")[0];
									DomNode_InsertBefore(dd,param["dd"]);
									DomNodeRemove(dd);
								}catch(e){
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(following,param,response_dialog,"response");

								created = true;
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:created});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// ID
			// --------------------------------------------------------------------------------
			function forId(target){
				if(BbsControlIdExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlId を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"A":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}

							break;
						case 3:
							while(node){

								var m = DomNodeGetNodeValue(node).match(new RegExp("ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(node,RegExp.leftContext);

								// BbsControlId を生成
								var control_id = new BbsControlId(null,false);
								control_id.setId(m[1]);
								var element_id = control_id.getElement();
								ElementSetTextContent(element_id,m[0]);
								DomNode_InsertAfter(node,element_id);

								// 直後テキスト
								node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(element_id,node);
							}
							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlId を検索
				// --------------------------------------------------------------------------------
				BbsControlIdSearch(target,function(control_id){

					control_id.setResponse(response);

					var id = control_id.getId();
					var element_id = control_id.getElement();
					var textnode_id = DocumentCreateText("");

					element_id.appendChild(textnode_id);

					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_id.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_id,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_id,"");
						}

						var style = element_id.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","small");
						}
					};
					control_id.update();

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "id"){
						if(response.getId() == id)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_id);
					response_dialog.oncreate = function(_window,callback){

						var responses = bbs_dictionary.getResponsesFromId(id);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_id = responses[i];
							var clone = response_id.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									_window.appendChild(obj.element);
								}
								try{
									var dd = ElementGetElementsByTagName(param["dt"],"p")[0];
									DomNode_InsertBefore(dd,param["dd"]);
									DomNodeRemove(dd);
								}catch(e){
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_id,param,response_dialog,"id");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// トリップ
			// --------------------------------------------------------------------------------
			function forName(target){
				if(BbsControlNameExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlName を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							while(node){

								// 本文
								var m = DomNodeGetNodeValue(node).match(new RegExp("(◆(|[ ])[a-zA-Z0-9+/.]{10,12})","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(node,RegExp.leftContext);

								// BbsControlName を生成
								var control_name = new BbsControlName(null,false);
								control_name.setName(m[0]);
								var element_name = control_name.getElement();
								ElementSetTextContent(element_name,m[0]);
								DomNode_InsertAfter(node,element_name);

								// 直後テキスト
								node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(element_name,node);
							}
							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlName を検索
				// --------------------------------------------------------------------------------
				BbsControlNameSearch(target,function(control_name){

					control_name.setResponse(response);

					var name = control_name.getName();
					var element_name = control_name.getElement();
					var textnode_name = DocumentCreateText("");


					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_name.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_name,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_name,"");
						}

						var style = element_name.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","small");
						}
					};
					control_name.update();
					element_name.appendChild(textnode_name);

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "name"){
						if(response.getName() == name)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_name);
					response_dialog.oncreate = function(_window,callback){

						var responses = bbs_dictionary.getResponsesFromName(name);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_name = responses[i];
							var clone = response_name.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									_window.appendChild(obj.element);
								}
								try{
									var dd = ElementGetElementsByTagName(param["dt"],"p")[0];
									DomNode_InsertBefore(dd,param["dd"]);
									DomNodeRemove(dd);
								}catch(e){
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_name,param,response_dialog,"name");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// ホスト
			// --------------------------------------------------------------------------------
			function forHost(target){
				if(BbsControlHostExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlHost を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"B":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							while(node){
								var text_value = DomNodeGetNodeValue(node);

								var m = text_value.match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
								if(m){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext + m[1]);

									// BbsControlHost を生成
									var control_host = new BbsControlHost(null,false);
									control_host.setHost(m[2]);
									var element_host = control_host.getElement();
									ElementSetTextContent(element_host,m[2]);
									DomNode_InsertAfter(node,element_host);

									// 直後テキスト
									node = DocumentCreateText(RegExp.rightContext);
									DomNode_InsertAfter(element_host,node);
									continue;
								}

								var m = text_value.match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})( \\])","i"));
								if(m){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext + m[1]);

									// BbsControlHost を生成
									var control_host = new BbsControlHost(null,false);
									control_host.setHost(m[2]);
									var element_host = control_host.getElement();
									ElementSetTextContent(element_host,m[2]);
									DomNode_InsertAfter(node,element_host);

									// 直後テキスト
									node = DocumentCreateText(" ]" + RegExp.rightContext);
									DomNode_InsertAfter(element_host,node);
									continue;
								}

								var m = text_value.match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
								if(m){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext + m[1]);

									// BbsControlHost を生成
									var control_host = new BbsControlHost(null,false);
									control_host.setHost(m[2]);
									var element_host = control_host.getElement();
									ElementSetTextContent(element_host,m[2]);
									DomNode_InsertAfter(node,element_host);

									// 直後テキスト
									node = DocumentCreateText(RegExp.rightContext);
									DomNode_InsertAfter(element_host,node);
									continue;
								}

								break;
							}

							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlHost を検索
				// --------------------------------------------------------------------------------
				BbsControlHostSearch(target,function(control_host){

					control_host.setResponse(response);

					var host = control_host.getHost();
					var element_host = control_host.getElement();
					var textnode_host = DocumentCreateText("");


					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_host.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_host,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_host,"");
						}

						var style = element_host.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","80%");
						}
					};
					control_host.update();
					element_host.appendChild(textnode_host);

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "host"){
						if(response.getHost() == host)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_host);
					response_dialog.oncreate = function(_window,callback){

						var responses = bbs_dictionary.getResponsesFromHost(host);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_host = responses[i];
							var clone = response_host.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									_window.appendChild(obj.element);
								}
								try{
									var dd = ElementGetElementsByTagName(param["dt"],"p")[0];
									DomNode_InsertBefore(dd,param["dd"]);
									DomNodeRemove(dd);
								}catch(e){
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_host,param,response_dialog,"host");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// フォロワー
			// --------------------------------------------------------------------------------
			function forFollower(target){
				if(BbsControlFollowerExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlFollower を生成
				// --------------------------------------------------------------------------------
				var control_follower = new BbsControlFollower(null,true);
				control_follower.setResponse(response);

				var element_follower = control_follower.getElement();
				var textnode_follower = DocumentCreateText("");

				element_follower.appendChild(textnode_follower);

				// --------------------------------------------------------------------------------
				// 変化があったときに実行されるイベント
				// --------------------------------------------------------------------------------
				control_follower.onchange = function(count){
					if(count){
						textnode_follower.nodeValue = " follower(" + count + ")";
					}else{
						textnode_follower.nodeValue = "";
					}

					var style = element_follower.style;
					if(count >= 3){
						StyleDeclarationSetProperty(style,"color","#e80000");
						StyleDeclarationRemoveProperty(style,"font-size");

					}else{
						StyleDeclarationSetProperty(style,"color","#888");
						StyleDeclarationSetProperty(style,"font-size","small");
					}
					if(count){
						StyleDeclarationSetProperty(style,"margin","0px 4px 0px 0px");
					}else{
						StyleDeclarationRemoveProperty(style,"margin");
					}
				};
				control_follower.update();
				var nodes = ElementGetElementsByTagName(target,"br");
				if(nodes.length){
					DomNode_InsertBefore(nodes[0],element_follower);
				}else{
					target.appendChild(element_follower);
				}

				// --------------------------------------------------------------------------------
				// ポップアップ化
				// --------------------------------------------------------------------------------
				// ダイアログを作成
				var response_dialog = new BbsResponseDialog();
				if(parent_dialog)	parent_dialog.attachChild(response_dialog);
				response_dialog.setElementParent(node.parent);
				response_dialog.setElementHitArea(element_follower);
				response_dialog.oncreate = function(_window,callback){

					var ary = response.getFollower();
					var i = 0;
					var num = ary.length;
					if(num <= 0) return false;

					function f(){
						var follower = bbs_dictionary.getResponse(ary[i].getNumber());
						var clone = follower.getCloneElements();

						var j;
						var clone_num = clone.length;
						if(clone_num){

							var param = new Object();
							param.parent = node.parent;
							for(j=0;j<clone_num;j++){
								var obj = clone[j];
								param[obj.name] = obj.element;
								_window.appendChild(obj.element);
							}
							try{
								var dd = ElementGetElementsByTagName(param["dt"],"p")[0];
								DomNode_InsertBefore(dd,param["dd"]);
								DomNodeRemove(dd);
							}catch(e){
							}

							// レスポンスダイアログを登録
							attachBbsResponseDialog(follower,param,response_dialog,"response");
						}

						i += 1;
						if(i < num){
							execute_queue.attachFirst(f,null);
						}else{
							callback({result:true});
						}
					}
					execute_queue.attachFirst(f,null);
				};
			}

			if(node.dt){
				forResponseAnchor(node.dt);
				forId(node.dt);
				forName(node.dt);
				forHost(node.dt);
				forFollower(node.dt);
			}
			if(node.dd){
				forResponseAnchor(node.dd);
				forId(node.dd);
				forName(node.dd);
			}
		}

		// --------------------------------------------------------------------------------
		// エレメントを解析
		// --------------------------------------------------------------------------------
		var useful = (function(){
			var dt = element;
			var dd;

			try{
				if(dt.tagName != "DIV")	return false;
				if(dt.className != "contributor")	return false;
			}catch(e){
				return false;
			}

			dd = dt.nextSibling;
			try{
				if(dd.tagName != "DIV")	return false;
				if(dd.className != "res")	return false;
			}catch(e){
				return false;
			}

			try{
				var div = dt.parentNode;
				if(div.tagName != "DIV")	return false;
				if(div.id.indexOf("thread") != 0)	return false;
			}catch(e){
				return false;
			}

			// document に未登録
			if(!DomNodeGetAttachedDocument(dt))	return false;

			// --------------------------------------------------------------------------------
			// レスアンカー拡張
			// --------------------------------------------------------------------------------
			work.extendResponseAnchor(dd);

			// --------------------------------------------------------------------------------
			// クリーンアップ
			// --------------------------------------------------------------------------------
			(function(){
				function cleanup(target){
					BbsControlSearchTrash(target,function(element){
						var node = element.firstChild;
						if(!node)	return null;
						if(node.nodeType != 3)	return null;

						// ID
						var m = node.nodeValue.match(new RegExp("^ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);
							return null;
						}

						// トリップ
						var m = node.nodeValue.match(new RegExp("^(◆(|[ ])[a-zA-Z0-9+/.]{10,12})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);
							return null;
						}

						// ホスト名
						var m = node.nodeValue.match(new RegExp("^([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);

							// テキストノードを統合
							node.parentNode.normalize();
							return null;
						}
						var m = node.nodeValue.match(new RegExp("^([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);

							// テキストノードを統合
							node.parentNode.normalize();
							return null;
						}

						return null;
					});
				}

				if(dt){
					cleanup(dt);
				}
				if(dd){
					cleanup(dd);
				}
			})();

			// ナンバーを取得
			var dt_text = ElementGetTextContent(dt);
			if(!(dt_text.match(new RegExp("([0-9]+)","i"))))	return false;

			// ナンバーからレスポンスオブジェクトを取得
			var response = bbs_dictionary.getResponse(parseInt(RegExp.$1));

			// レスポンス解析
			if(!response.getAnalyzed()){

				(function(){
					// 本文を除外
					var dt_clone = dt.cloneNode(true);
					try{
						var dd = ElementGetElementsByTagName(dt_clone,"p")[0];
						DomNodeRemove(dd);
					}catch(e){
					}
					dt_text = ElementGetTextContent(dt_clone);
				})();

				// IDの取得
				if(dt_text.match(new RegExp("ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"))){
					response.setId(RegExp.$1);
				}

				// 名前の取得
				if(dt_text.match(new RegExp("(◆(|[ ])[a-zA-Z0-9+/.]{10,12})","i"))){
					response.setName(RegExp.$1);
				}

				// ホスト名の取得
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"B":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:dt};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							var m = DomNodeGetNodeValue(node).match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
							if(m){
								response.setHost(m[2]);
								return;
							}
							var m = DomNodeGetNodeValue(node).match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,}) \\]","i"));
							if(m){
								response.setHost(m[2]);
								return;
							}
							var m = DomNodeGetNodeValue(node).match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
							if(m){
								response.setHost(m[2]);
								return;
							}
							break;
						}
					}
				})();

				// フォロー解析
				var dictionary = new Object();
				(function(){
					var nodes = ElementGetElementsByTagName(dd,"a");
					var i;
					var num = nodes.length;
					for(i=0;i<num;i++){
						var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(nodes[i]));
						numbers.getNumbers(function(n){
							if(!dictionary[n]){
								var following = bbs_dictionary.getResponse(n);
								following.addFollower(response);
								dictionary[n] = true;
							}
						});
					}
				})();

				// オリジナルエレメントをセット
				if(dt)	response.addOriginalElements("dt",dt);
				if(dd)	response.addOriginalElements("dd",dd);

				// 消去時に実行されるイベント
				response.onerase = function(){
					var original = response.getOriginalElements();

					// オリジナルエレメントを外す
					var i;
					var num = original.length;
					for(i=0;i<num;i++){
						var revise_scroll = new DocumentReviseScroll();
						var node = original[i].element;
						revise_scroll.executeRemoveElementBefore(node);
						DomNodeRemove(node);
						revise_scroll.executeRemoveElementAfter(node);
					}
				};

				response.setAnalyzed();
			}

			// レスポンスダイアログを登録（ルート）
			attachBbsResponseDialog(
				response,
				{
					dt:dt,
					dd:dd,
					parent:dt.parentNode
				},
				null,
				null
			);

			return true;
		})();

		response({useful:useful});
		return true;
	}.toString() +
"\n]";

				// unkar.org
				var obj = addPreset(proj.expand_bbs,"unkar",null);
				var preset = obj.preset;
				preset.filter = [
					{
						pattern:"^http://unkar\\.org/r/[^/]+/[0-9]+",
						flags:{i:true,g:false}
					}
				];
				preset.script_initialize = 
"[\n\t" + 
	function(info,response){
		var work = info.work;

		// --------------------------------------------------------------------------------
		// 基本URL抽出
		// --------------------------------------------------------------------------------
		var url = document.URL;
		var bbs_list = [
			{url:"(http://unkar\\.org/r/.+?/[0-9]+)",replace:"$1/",name:"unkar"}
		];

		var i;
		var num = bbs_list.length;
		for(i=0;i<num;i++){
			var bbs = bbs_list[i];
			var re = new RegExp(bbs.url,"i");
			var m = url.match(re);
			if(m){
				work.base_url = m[1].replace(re,bbs.replace);
				work.bbs_name = bbs.name;
				break;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		var work = info.work;

		if(work.bbs_name){
			var first_id = 1;
			var last_id = 1;
			var dictionary_id = new Array();
			var element_parent = null;
			var read_more_button = null;
			var element_form = null;
			var base_url = work.base_url;
			var resource_url_shadow = base_url;
			var resource_url_more = base_url;

			// --------------------------------------------------------------------------------
			// 文字列からレスポンス番号を取得
			// --------------------------------------------------------------------------------
			work.createResponseAnchorNumbers = function (str){
				var numbers = new ResponseAnchorNumbers();

				var re_search = new RegExp("^(>>|<<|＞＞|＜＜|>|＞|》|≫|&gt;&gt;)([0-9０-９]+)","i");
				var re_range = new RegExp("^([0-9０-９]+)[-]([0-9０-９]+)","i");
				var re_number = new RegExp("^([0-9０-９]+)","i");

				var m = str.match(re_search);
				if(m){
					var p = m[1].length;
					while(true){
						// 番号-番号
						m = str.substr(p).match(re_range);
						if(m){
							var id0 = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
							var id1 = parseInt(StringConvertFromNumericFullToNumericHalf(m[2]));
							if(id0 < 1) id0 = 1;
							if(id1 < 1) id1 = 1;
							if(id0 > 10000) id0 = 10000;
							if(id1 > 10000) id1 = 10000;
							p += m[0].length;
							numbers.addNumbers(id0,id1);
						}else{
							// 番号
							m = str.substr(p).match(re_number);
							if(m){
								p += m[0].length;
								var id = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
								if(id < 1) id = 1;
								if(id > 0x7fffffff) id = 0x7fffffff;
								numbers.addNumber(id);
							}
						}

						if(m){
							// カンマ
							if(RegExp.rightContext.search(",") == 0){
								p += 1;
								continue;
							}
						}
						break;
					}
				}
				return numbers;
			};

			// --------------------------------------------------------------------------------
			// レスアンカー拡張
			// --------------------------------------------------------------------------------
			work.extendResponseAnchor = function (target){
				if(BbsControlResponseAnchorExist(target))	return;

				var re_simple = new RegExp("^(>>|<<|>)[-,0-9０-９]+$","i");
				var re_detail = new RegExp("(>>|<<|＞＞|＜＜|>|＞|》|≫|&gt;&gt;)(([0-9０-９]+[-][0-9０-９]+|[0-9０-９]+),)*([0-9０-９]+[-][0-9０-９]+|[0-9０-９]+)","i");
				var re_range = new RegExp("([0-9０-９]+)[-]([0-9０-９]+)","i");
				var re_number = new RegExp("([0-9０-９]+)","i");

				var i;
				var nodes = ElementGetElementsByTagName(target,"a");
				var num = nodes.length;
				for(i=num-1;i>=0;i--){
					var node = nodes[i];
					var m = ElementGetTextContent(node).match(re_simple);
					if(m){
						var text_node = DocumentCreateText(m[0]);
						DomNode_InsertBefore(node,text_node);
						DomNodeRemove(node);
					}
				}

				// テキストノードを統合
				target.normalize();

				var p;
				var n;
				var q;
				var ignore_dictionary = {"A":1,"SCRIPT":1};
				var queue = new Object();
				q = {p:queue,n:queue,node:target};
				queue.p = q;
				queue.n = q;

				while(queue.n != queue){
					q = queue.n;
					p = q.p;
					n = q.n;
					p.n = n;
					n.p = p;
					var node = q.node;
					switch(node.nodeType){
					case 1:
						var i;
						var nodes = node.childNodes;
						var num = nodes.length;
						for(i=0;i<num;i++){
							n = queue;
							p = n.p;
							q = {p:p,n:n,node:nodes[i]};
							p.n = q;
							n.p = q;
						}
						break;
					case 3:
						while(node){
							var m = DomNodeGetNodeValue(node).match(re_detail);
							if(!m)	break;

							// 元のテキストノード
							DomNodeSetNodeValue(node,RegExp.leftContext);

							// BbsControlName を生成
							var element = DocumentCreateElement("a");
							var span = DocumentCreateElement("font");
							element.appendChild(span);
							ElementSetTextContent(span,m[0]);
							DomNode_InsertAfter(node,element);

							// 直後テキスト
							node = DocumentCreateText(RegExp.rightContext);
							DomNode_InsertAfter(element,node);

							var query = "";
							m = ElementGetTextContent(element).match(re_range);
							if(m){
								var min = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
								var max = parseInt(StringConvertFromNumericFullToNumericHalf(m[2]));
								if(min < 1) min = 1;
								if(max < 1) max = 1;
								if(min > 10000) min = 10000;
								if(max > 10000) max = 10000;
								if(max < min){
									var tmp = min;
									min = max;
									max = tmp;
								}
								query = min + "-" + max;
							}else{
								// 番号
								m = ElementGetTextContent(element).match(re_number);
								if(m){
									query = parseInt(StringConvertFromNumericFullToNumericHalf(m[0]));
									if(query < 1) query = 1;
									if(query > 0x7fffffff) query = 0x7fffffff;
								}

							}
							element.href = work.base_url + query;
						}
					}
				}
			};

			// --------------------------------------------------------------------------------
			// 継ぎ足し読み込み
			// --------------------------------------------------------------------------------
			function readMore(){

				// ローダーオブジェクトを作成
				var loader = new Loader();

				// 成功
				loader.onload = function(str){
					var re_number = new RegExp("<dt id=\"l([0-9]+)\">","i");

					var p = 0;
					var n = str.length;
					function f(){
						try{
							if(p >= n) throw 0;
							p = str.indexOf("<dt id=",p);
							if(p < 0) throw 0;
							var e = str.indexOf("\n",p);
							var s = str.substring(p,e);
							var m = s.match(re_number);
							if(m){
								var id = parseInt(m[1]);
								if(last_id < id){
									var response = bbs_dictionary.getResponse(id);
									response.clearAnalyzed();
									response.clearOriginalElements();
									response.clearFollowing();

									var nodes = StringHtmlCreateDomNodesSafe(s);
									var j;
									var node_num = nodes.length;
									for(j=0;j<node_num;j++){
										element_parent.appendChild(nodes[j]);
									}
									last_id = id;
									resource_url_more = base_url + (last_id) + "-";
								}
							}

							if(p < e){
								p = e + 1;
								execute_queue.attachFirst(f,null);
								return;
							}
						}catch(e){
						}
						read_more_button.init();
					}
					execute_queue.attachFirst(f,null);
				};

				// 失敗
				loader.onerror = function(){
					read_more_button.init();
				};

				// テキストの読み込み
				loader.setMethod("GET");
				loader.setURL(resource_url_more);
				loader.loadText();
			}

			// --------------------------------------------------------------------------------
			// レスポンス親要素
			// --------------------------------------------------------------------------------
			element_parent = document.getElementById("content");
			if(!element_parent) return false;

			// --------------------------------------------------------------------------------
			// 範囲取得
			// --------------------------------------------------------------------------------
			var nodes = ElementGetElementsByTagName(element_parent,"dt");
			var i;
			var node_num = nodes.length;
			for(i=0;i<node_num;i++){
				var node = nodes[i];
				var m = ElementGetTextContent(node).match(new RegExp("([0-9]+)","i"));
				if(m){
					first_id = parseInt(m[1]);
					dictionary_id[first_id] = true;
					if(first_id != 1){
						break;
					}
				}
			}
			for(i=node_num-1;i>=0;i--){
				var node = nodes[i];
				var m = ElementGetTextContent(node).match(new RegExp("([0-9]+)","i"));
				if(m){
					last_id = parseInt(m[1]);
					dictionary_id[last_id] = true;
					break;
				}
			}

			// --------------------------------------------------------------------------------
			// アクセス先 URL
			// --------------------------------------------------------------------------------
			resource_url_shadow = base_url;
			resource_url_more = base_url + last_id + "-";

			// --------------------------------------------------------------------------------
			// BbsControlReadMoreButton 作成
			// --------------------------------------------------------------------------------
			read_more_button = new BbsControlReadMoreButton();
			read_more_button.setWaitTime(2 * 1000);
			read_more_button.onclick = readMore;
			DomNode_InsertAfter(element_parent,read_more_button.getElement());


			// --------------------------------------------------------------------------------
			// シャドウロード
			// --------------------------------------------------------------------------------
			(function(){
				// ローダーオブジェクトを作成
				var loader = new Loader();

				// 成功
				loader.onload = function(str){
					var re_number = new RegExp("<dt id=\"l([0-9]+)\">","i");
					var re_id = new RegExp("ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i");
					var re_name = new RegExp("(◆(|[ ])[a-zA-Z0-9+/.]{10,12})","i");

					var p = 0;
					var n = str.length;
					function f(){
						if(p >= n) return;
						p = str.indexOf("<dt id=",p);
						if(p < 0) return;
						var e = str.indexOf("\n",p);
						var s = str.substring(p,e);
						var m = s.match(re_number);
						if(m){
							var id = parseInt(m[1]);
							if((first_id <= id) && (id <= last_id)){
							}else if(dictionary_id[id]){
							}else{
								// ナンバーからレスポンスオブジェクトを取得
								var response = bbs_dictionary.getResponse(id);
								if(!(response.getAnalyzed())){
									var nodes = StringHtmlCreateDomNodesSafe(s);
									var dt = nodes[0];
									var dd = nodes[1];

									try{
										if(dt.tagName != "DT")	return;
										if(dd.tagName != "DD")	return;
									}catch(e){
										return;
									}

									var dt_text = ElementGetTextContent(dt);

									// レスアンカー拡張
									work.extendResponseAnchor(dd);

									// IDの取得
									if(dt_text.match(re_id)){
										response.setId(RegExp.$1);
									}

									// 名前の取得
									if(dt_text.match(re_name)){
										response.setName(RegExp.$1);
									}

									// ホスト名の取得
									(function(){
										var p;
										var n;
										var q;
										var ignore_dictionary = {"B":1,"SCRIPT":1};
										var queue = new Object();
										q = {p:queue,n:queue,node:dt};
										queue.p = q;
										queue.n = q;

										while(queue.n != queue){
											q = queue.n;
											p = q.p;
											n = q.n;
											p.n = n;
											n.p = p;
											var node = q.node;
											switch(node.nodeType){
											case 1:
												if(!(ignore_dictionary[node.tagName])){
													var i;
													var nodes = node.childNodes;
													var num = nodes.length;
													for(i=0;i<num;i++){
														n = queue;
														p = n.p;
														q = {p:p,n:n,node:nodes[i]};
														p.n = q;
														n.p = q;
													}
												}
												break;
											case 3:
												var m = DomNodeGetNodeValue(node).match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
												if(m){
													response.setHost(m[2]);
													return;
												}
												var m = DomNodeGetNodeValue(node).match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})\\n \\]","i"));
												if(m){
													response.setHost(m[2]);
													return;
												}
												var m = DomNodeGetNodeValue(node).match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
												if(m){
													response.setHost(m[2]);
													return;
												}
												break;
											}
										}
									})();

									// フォロー解析
									var dictionary = new Object();
									(function(){
										var nodes = ElementGetElementsByTagName(dd,"a");
										var i;
										var num = nodes.length;
										for(i=0;i<num;i++){
											var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(nodes[i]));
											numbers.getNumbers(function(n){
												if(!dictionary[n]){
													var following = bbs_dictionary.getResponse(n);
													following.addFollower(response);
													dictionary[n] = true;
												}
											});
										}
									})();

									// オリジナルエレメントをセット
									if(dt)	response.addOriginalElements("dt",dt);
									if(dd)	response.addOriginalElements("dd",dd);

									// 消去時に実行されるイベント
									response.onerase = function(){};

									response.setAnalyzed();
								}
							}
						}

						if(p < e){
							p = e + 1;
							execute_queue.attachFirst(f,null);
						}
					}
					execute_queue.attachFirst(f,null);
				};

				// 失敗
				loader.onerror = function(){
				};

				// テキストの読み込み
				loader.setMethod("GET");
				loader.setURL(resource_url_shadow);
				loader.loadText();
			})();

			response({result:true});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		response({result:false});
		return true;
	}.toString() +
"\n]";

				preset.script_callback = 
"[\n\t" + 
	function(info,response){
		var element = info.element;
		var work = info.work;

		// --------------------------------------------------------------------------------
		// レスポンスダイアログを登録
		// --------------------------------------------------------------------------------
		function attachBbsResponseDialog(response,node,parent_dialog,type){

			// --------------------------------------------------------------------------------
			// レスアンカー
			// --------------------------------------------------------------------------------
			function forResponseAnchor(target){
				if(BbsControlResponseAnchorExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlResponseAnchor を生成
				// --------------------------------------------------------------------------------
				(function(){
					var i;
					var nodes = ElementGetElementsByTagName(target,"a");
					var num = nodes.length;
					for(i=0;i<num;i++){
						var node = nodes[i];
						var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(node));
						if(numbers.getCount()){
							var control_res_anchor = new BbsControlResponseAnchor(node,false);
							control_res_anchor.setResponseAnchorNumbers(numbers);
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlResponseAnchor を検索
				// --------------------------------------------------------------------------------
				BbsControlResponseAnchorSearch(target,function(control_res_anchor){

					var element_res_anchor = control_res_anchor.getElement();
					var numbers = control_res_anchor.getResponseAnchorNumbers();

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_res_anchor);
					response_dialog.oncreate = function(_window,callback){

						var created = false;
						var i = 0;
						var number_list = numbers.getNumberList();
						var num = number_list.length;
						if(!num) return false;

						function f(){
							var following = bbs_dictionary.getResponse(number_list[i]);
							var clone = following.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){
								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									_window.appendChild(obj.element);
								}
								try{
									var dd = ElementGetElementsByTagName(param["dt"],"p")[0];
									DomNode_InsertBefore(dd,param["dd"]);
									DomNodeRemove(dd);
								}catch(e){
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(following,param,response_dialog,"response");

								created = true;
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:created});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// ID
			// --------------------------------------------------------------------------------
			function forId(target){
				if(BbsControlIdExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlId を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"A":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}

							if(node.tagName == "A"){
								var m = ElementGetTextContent(node).match(new RegExp("^ID:$","i"));
								if(!m)	break;

								var next = node.nextSibling;
								if(!next)	break;
								if(next.nodeType != 3)	break;

								var m = DomNodeGetNodeValue(next).match(new RegExp("^([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(next,m[0]);

								// BbsControlId を生成
								var control_id = new BbsControlId(null,false);
								control_id.setId(m[1]);
								var element_id = control_id.getElement();
								DomNode_InsertAfter(next,element_id);
								element_id.appendChild(next);

								// 直後テキスト
								node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(element_id,node);
							}

							break;
						case 3:
							while(node){

								var m = DomNodeGetNodeValue(node).match(new RegExp("ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(node,RegExp.leftContext);

								// BbsControlId を生成
								var control_id = new BbsControlId(null,false);
								control_id.setId(m[1]);
								var element_id = control_id.getElement();
								ElementSetTextContent(element_id,m[0]);
								DomNode_InsertAfter(node,element_id);

								// 直後テキスト
								node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(element_id,node);
							}
							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlId を検索
				// --------------------------------------------------------------------------------
				BbsControlIdSearch(target,function(control_id){

					control_id.setResponse(response);

					var id = control_id.getId();
					var element_id = control_id.getElement();
					var textnode_id = DocumentCreateText("");

					element_id.appendChild(textnode_id);

					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_id.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_id,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_id,"");
						}

						var style = element_id.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","small");
						}
					};
					control_id.update();

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "id"){
						if(response.getId() == id)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_id);
					response_dialog.oncreate = function(_window,callback){

						var responses = bbs_dictionary.getResponsesFromId(id);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_id = responses[i];
							var clone = response_id.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									_window.appendChild(obj.element);
								}
								try{
									var dd = ElementGetElementsByTagName(param["dt"],"p")[0];
									DomNode_InsertBefore(dd,param["dd"]);
									DomNodeRemove(dd);
								}catch(e){
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_id,param,response_dialog,"id");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// トリップ
			// --------------------------------------------------------------------------------
			function forName(target){
				if(BbsControlNameExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlName を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							while(node){

								// 本文
								var m = DomNodeGetNodeValue(node).match(new RegExp("(◆(|[ ])[a-zA-Z0-9+/.]{10,12})","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(node,RegExp.leftContext);

								// BbsControlName を生成
								var control_name = new BbsControlName(null,false);
								control_name.setName(m[0]);
								var element_name = control_name.getElement();
								ElementSetTextContent(element_name,m[0]);
								DomNode_InsertAfter(node,element_name);

								// 直後テキスト
								node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(element_name,node);
							}
							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlName を検索
				// --------------------------------------------------------------------------------
				BbsControlNameSearch(target,function(control_name){

					control_name.setResponse(response);

					var name = control_name.getName();
					var element_name = control_name.getElement();
					var textnode_name = DocumentCreateText("");


					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_name.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_name,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_name,"");
						}

						var style = element_name.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","small");
						}
					};
					control_name.update();
					element_name.appendChild(textnode_name);

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "name"){
						if(response.getName() == name)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_name);
					response_dialog.oncreate = function(_window,callback){

						var responses = bbs_dictionary.getResponsesFromName(name);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_name = responses[i];
							var clone = response_name.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									_window.appendChild(obj.element);
								}
								try{
									var dd = ElementGetElementsByTagName(param["dt"],"p")[0];
									DomNode_InsertBefore(dd,param["dd"]);
									DomNodeRemove(dd);
								}catch(e){
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_name,param,response_dialog,"name");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// ホスト
			// --------------------------------------------------------------------------------
			function forHost(target){
				if(BbsControlHostExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlHost を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"B":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							while(node){
								var text_value = DomNodeGetNodeValue(node);

								var m = text_value.match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
								if(m){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext + m[1]);

									// BbsControlHost を生成
									var control_host = new BbsControlHost(null,false);
									control_host.setHost(m[2]);
									var element_host = control_host.getElement();
									ElementSetTextContent(element_host,m[2]);
									DomNode_InsertAfter(node,element_host);

									// 直後テキスト
									node = DocumentCreateText(RegExp.rightContext);
									DomNode_InsertAfter(element_host,node);
									continue;
								}

								var m = text_value.match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})(\\n \\])","i"));
								if(m){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext + m[1]);

									// BbsControlHost を生成
									var control_host = new BbsControlHost(null,false);
									control_host.setHost(m[2]);
									var element_host = control_host.getElement();
									ElementSetTextContent(element_host,m[2]);
									DomNode_InsertAfter(node,element_host);

									// 直後テキスト
									node = DocumentCreateText("\n ]" + RegExp.rightContext);
									DomNode_InsertAfter(element_host,node);
									continue;
								}

								var m = text_value.match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
								if(m){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext + m[1]);

									// BbsControlHost を生成
									var control_host = new BbsControlHost(null,false);
									control_host.setHost(m[2]);
									var element_host = control_host.getElement();
									ElementSetTextContent(element_host,m[2]);
									DomNode_InsertAfter(node,element_host);

									// 直後テキスト
									node = DocumentCreateText(RegExp.rightContext);
									DomNode_InsertAfter(element_host,node);
									continue;
								}

								break;
							}

							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlHost を検索
				// --------------------------------------------------------------------------------
				BbsControlHostSearch(target,function(control_host){

					control_host.setResponse(response);

					var host = control_host.getHost();
					var element_host = control_host.getElement();
					var textnode_host = DocumentCreateText("");


					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_host.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_host,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_host,"");
						}

						var style = element_host.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","80%");
						}
					};
					control_host.update();
					element_host.appendChild(textnode_host);

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "host"){
						if(response.getHost() == host)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_host);
					response_dialog.oncreate = function(_window,callback){

						var responses = bbs_dictionary.getResponsesFromHost(host);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_host = responses[i];
							var clone = response_host.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									_window.appendChild(obj.element);
								}
								try{
									var dd = ElementGetElementsByTagName(param["dt"],"p")[0];
									DomNode_InsertBefore(dd,param["dd"]);
									DomNodeRemove(dd);
								}catch(e){
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_host,param,response_dialog,"host");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// フォロワー
			// --------------------------------------------------------------------------------
			function forFollower(target){
				if(BbsControlFollowerExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlFollower を生成
				// --------------------------------------------------------------------------------
				var control_follower = new BbsControlFollower(null,true);
				control_follower.setResponse(response);

				var element_follower = control_follower.getElement();
				var textnode_follower = DocumentCreateText("");

				element_follower.appendChild(textnode_follower);

				// --------------------------------------------------------------------------------
				// 変化があったときに実行されるイベント
				// --------------------------------------------------------------------------------
				control_follower.onchange = function(count){
					if(count){
						textnode_follower.nodeValue = " follower(" + count + ")";
					}else{
						textnode_follower.nodeValue = "";
					}

					var style = element_follower.style;
					if(count >= 3){
						StyleDeclarationSetProperty(style,"color","#e80000");
						StyleDeclarationRemoveProperty(style,"font-size");

					}else{
						StyleDeclarationSetProperty(style,"color","#888");
						StyleDeclarationSetProperty(style,"font-size","small");
					}
					if(count){
						StyleDeclarationSetProperty(style,"margin","0px 4px 0px 0px");
					}else{
						StyleDeclarationRemoveProperty(style,"margin");
					}
				};
				control_follower.update();
				var nodes = ElementGetElementsByTagName(target,"br");
				if(nodes.length){
					DomNode_InsertBefore(nodes[0],element_follower);
				}else{
					target.appendChild(element_follower);
				}

				// --------------------------------------------------------------------------------
				// ポップアップ化
				// --------------------------------------------------------------------------------
				// ダイアログを作成
				var response_dialog = new BbsResponseDialog();
				if(parent_dialog)	parent_dialog.attachChild(response_dialog);
				response_dialog.setElementParent(node.parent);
				response_dialog.setElementHitArea(element_follower);
				response_dialog.oncreate = function(_window,callback){

					var ary = response.getFollower();
					var i = 0;
					var num = ary.length;
					if(num <= 0) return false;

					function f(){
						var follower = bbs_dictionary.getResponse(ary[i].getNumber());
						var clone = follower.getCloneElements();

						var j;
						var clone_num = clone.length;
						if(clone_num){

							var param = new Object();
							param.parent = node.parent;
							for(j=0;j<clone_num;j++){
								var obj = clone[j];
								param[obj.name] = obj.element;
								_window.appendChild(obj.element);
							}
							try{
								var dd = ElementGetElementsByTagName(param["dt"],"p")[0];
								DomNode_InsertBefore(dd,param["dd"]);
								DomNodeRemove(dd);
							}catch(e){
							}

							// レスポンスダイアログを登録
							attachBbsResponseDialog(follower,param,response_dialog,"response");
						}

						i += 1;
						if(i < num){
							execute_queue.attachFirst(f,null);
						}else{
							callback({result:true});
						}
					}
					execute_queue.attachFirst(f,null);
				};
			}

			if(node.dt){
				forResponseAnchor(node.dt);
				forId(node.dt);
				forName(node.dt);
				forHost(node.dt);
				forFollower(node.dt);
			}
			if(node.dd){
				forResponseAnchor(node.dd);
				forId(node.dd);
				forName(node.dd);
			}
		}

		// --------------------------------------------------------------------------------
		// エレメントを解析
		// --------------------------------------------------------------------------------
		var useful = (function(){
			var dt = element;
			var dd;

			try{
				if(dt.tagName != "DT")	return false;
			}catch(e){
				return false;
			}

			dd = dt.nextSibling;
			try{
				if(dd.tagName != "DD")	return false;
			}catch(e){
				return false;
			}

			try{
				var dl = dt.parentNode;
				if(dl.tagName != "DL")	return false;
				if(dl.id != "content")	return false;
			}catch(e){
				return false;
			}

			// document に未登録
			if(!DomNodeGetAttachedDocument(dt))	return false;

			// --------------------------------------------------------------------------------
			// ポップアップ無効化
			// --------------------------------------------------------------------------------
			(function(target){
				var p;
				var n;
				var q;
				var ignore_dictionary = {"A":1,"SCRIPT":1};
				var queue = new Object();
				q = {p:queue,n:queue,node:target};
				queue.p = q;
				queue.n = q;

				while(queue.n != queue){
					q = queue.n;
					p = q.p;
					n = q.n;
					p.n = n;
					n.p = p;
					var node = q.node;
					switch(node.nodeType){
					case 1:
						var i;
						var nodes = node.childNodes;
						var num = nodes.length;
						for(i=0;i<num;i++){
							n = queue;
							p = n.p;
							q = {p:p,n:n,node:nodes[i]};
							p.n = q;
							n.p = q;
						}

						if(node.tagName == "A"){
							if(nodes.length == 1){
								var text = nodes[0];
								if(text.nodeType == 3){
									var span = DocumentCreateElement("font");
									span.appendChild(text);
									node.appendChild(span);
								}
							}
						}
						break;
					}
				}
			})(dt);

			// --------------------------------------------------------------------------------
			// レスアンカー拡張
			// --------------------------------------------------------------------------------
			work.extendResponseAnchor(dd);

			// --------------------------------------------------------------------------------
			// クリーンアップ
			// --------------------------------------------------------------------------------
			(function(){
				function cleanup(target){
					BbsControlSearchTrash(target,function(element){
						var node = element.firstChild;
						if(!node)	return null;
						if(node.nodeType != 3)	return null;

						// ID
						var m = node.nodeValue.match(new RegExp("^ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);
							return null;
						}
						var m = node.nodeValue.match(new RegExp("^([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"));
						if(m){
							var prev = element.previousSibling;
							if(prev){
								if(prev.tagName == "A"){
									if(ElementGetTextContent(prev) == "ID:"){
										var node = DocumentCreateText(m[0]);
										DomNode_InsertAfter(element,node);
										DomNodeRemove(element);
										return null;
									}
								}
							}
						}

						// トリップ
						var m = node.nodeValue.match(new RegExp("^(◆(|[ ])[a-zA-Z0-9+/.]{10,12})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);
							return null;
						}

						// ホスト名
						var m = node.nodeValue.match(new RegExp("^([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);

							// テキストノードを統合
							node.parentNode.normalize();
							return null;
						}
						var m = node.nodeValue.match(new RegExp("^([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);

							// テキストノードを統合
							node.parentNode.normalize();
							return null;
						}

						return null;
					});
				}

				if(dt){
					cleanup(dt);
				}
				if(dd){
					cleanup(dd);
				}
			})();

			// ナンバーを取得
			var dt_text = ElementGetTextContent(dt);
			if(!(dt_text.match(new RegExp("([0-9]+)","i"))))	return false;

			// ナンバーからレスポンスオブジェクトを取得
			var response = bbs_dictionary.getResponse(parseInt(RegExp.$1));

			// レスポンス解析
			if(!response.getAnalyzed()){

				(function(){
					// 本文を除外
					var dt_clone = dt.cloneNode(true);
					try{
						var dd = ElementGetElementsByTagName(dt_clone,"p")[0];
						DomNodeRemove(dd);
					}catch(e){
					}
					dt_text = ElementGetTextContent(dt_clone);
				})();

				// IDの取得
				if(dt_text.match(new RegExp("ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"))){
					response.setId(RegExp.$1);
				}

				// 名前の取得
				if(dt_text.match(new RegExp("(◆(|[ ])[a-zA-Z0-9+/.]{10,12})","i"))){
					response.setName(RegExp.$1);
				}

				// ホスト名の取得
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"B":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:dt};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							var m = DomNodeGetNodeValue(node).match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
							if(m){
								response.setHost(m[2]);
								return;
							}
							var m = DomNodeGetNodeValue(node).match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})\\n \\]","i"));
							if(m){
								response.setHost(m[2]);
								return;
							}
							var m = DomNodeGetNodeValue(node).match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
							if(m){
								response.setHost(m[2]);
								return;
							}
							break;
						}
					}
				})();

				// フォロー解析
				var dictionary = new Object();
				(function(){
					var nodes = ElementGetElementsByTagName(dd,"a");
					var i;
					var num = nodes.length;
					for(i=0;i<num;i++){
						var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(nodes[i]));
						numbers.getNumbers(function(n){
							if(!dictionary[n]){
								var following = bbs_dictionary.getResponse(n);
								following.addFollower(response);
								dictionary[n] = true;
							}
						});
					}
				})();

				// オリジナルエレメントをセット
				if(dt)	response.addOriginalElements("dt",dt);
				if(dd)	response.addOriginalElements("dd",dd);

				// 消去時に実行されるイベント
				response.onerase = function(){
					var original = response.getOriginalElements();

					// オリジナルエレメントを外す
					var i;
					var num = original.length;
					for(i=0;i<num;i++){
						var revise_scroll = new DocumentReviseScroll();
						var node = original[i].element;
						revise_scroll.executeRemoveElementBefore(node);
						DomNodeRemove(node);
						revise_scroll.executeRemoveElementAfter(node);
					}
				};

				response.setAnalyzed();
			}

			// レスポンスダイアログを登録（ルート）
			attachBbsResponseDialog(
				response,
				{
					dt:dt,
					dd:dd,
					parent:dt.parentNode
				},
				null,
				null
			);

			return true;
		})();

		response({useful:useful});
		return true;
	}.toString() +
"\n]";

				// あっとちゃんねるず
				var obj = addPreset(proj.expand_bbs,"atchs",null);
				var preset = obj.preset;
				preset.filter = [
					{
						pattern:"^http://[^.]+\\.atchs\\.jp/test/read\\.cgi/[^/]+/[0-9]+",
						flags:{i:true,g:false}
					}
				];
				preset.script_initialize = 
"[\n\t" + 
	function(info,response){
		var work = info.work;

		// --------------------------------------------------------------------------------
		// 基本URL抽出
		// --------------------------------------------------------------------------------
		var url = document.URL;
		var bbs_list = [
			{url:"(http://[^.]+\\.atchs\\.jp/test/read\\.cgi/[^/]+/[0-9]+)",replace:"$1/",name:"atchs"}
		];

		var i;
		var num = bbs_list.length;
		for(i=0;i<num;i++){
			var bbs = bbs_list[i];
			var re = new RegExp(bbs.url,"i");
			var m = url.match(re);
			if(m){
				work.base_url = m[1].replace(re,bbs.replace);
				work.bbs_name = bbs.name;
				break;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		var work = info.work;

		if(work.bbs_name){
			var first_id = 1;
			var last_id = 1;
			var dictionary_id = new Array();
			var element_parent = null;
			var read_more_button = null;
			var element_form = null;
			var base_url = work.base_url;
			var resource_url_shadow = base_url;
			var resource_url_more = base_url;

			// --------------------------------------------------------------------------------
			// 文字列からレスポンス番号を取得
			// --------------------------------------------------------------------------------
			work.createResponseAnchorNumbers = function (str){
				var numbers = new ResponseAnchorNumbers();

				var re_search = new RegExp("^(>>|<<|＞＞|＜＜|>|＞|》|≫|&gt;&gt;)([0-9０-９]+)","i");
				var re_range = new RegExp("^([0-9０-９]+)[-]([0-9０-９]+)","i");
				var re_number = new RegExp("^([0-9０-９]+)","i");

				var m = str.match(re_search);
				if(m){
					var p = m[1].length;
					while(true){
						// 番号-番号
						m = str.substr(p).match(re_range);
						if(m){
							var id0 = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
							var id1 = parseInt(StringConvertFromNumericFullToNumericHalf(m[2]));
							if(id0 < 1) id0 = 1;
							if(id1 < 1) id1 = 1;
							if(id0 > 10000) id0 = 10000;
							if(id1 > 10000) id1 = 10000;
							p += m[0].length;
							numbers.addNumbers(id0,id1);
						}else{
							// 番号
							m = str.substr(p).match(re_number);
							if(m){
								p += m[0].length;
								var id = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
								if(id < 1) id = 1;
								if(id > 0x7fffffff) id = 0x7fffffff;
								numbers.addNumber(id);
							}
						}

						if(m){
							// カンマ
							if(RegExp.rightContext.search(",") == 0){
								p += 1;
								continue;
							}
						}
						break;
					}
				}
				return numbers;
			};

			// --------------------------------------------------------------------------------
			// レスアンカー拡張
			// --------------------------------------------------------------------------------
			work.extendResponseAnchor = function (target){
				if(BbsControlResponseAnchorExist(target))	return;

				var re_simple = new RegExp("^(>>|<<|>)[-,0-9０-９]+$","i");
				var re_detail = new RegExp("(>>|<<|＞＞|＜＜|>|＞|》|≫|&gt;&gt;)(([0-9０-９]+[-][0-9０-９]+|[0-9０-９]+),)*([0-9０-９]+[-][0-9０-９]+|[0-9０-９]+)","i");
				var re_range = new RegExp("([0-9０-９]+)[-]([0-9０-９]+)","i");
				var re_number = new RegExp("([0-9０-９]+)","i");

				var i;
				var nodes = ElementGetElementsByTagName(target,"a");
				var num = nodes.length;
				for(i=num-1;i>=0;i--){
					var node = nodes[i];
					var m = ElementGetTextContent(node).match(re_simple);
					if(m){
						var text_node = DocumentCreateText(m[0]);
						DomNode_InsertBefore(node,text_node);
						DomNodeRemove(node);
					}
				}

				// テキストノードを統合
				target.normalize();

				var p;
				var n;
				var q;
				var ignore_dictionary = {"A":1,"SCRIPT":1};
				var queue = new Object();
				q = {p:queue,n:queue,node:target};
				queue.p = q;
				queue.n = q;

				while(queue.n != queue){
					q = queue.n;
					p = q.p;
					n = q.n;
					p.n = n;
					n.p = p;
					var node = q.node;
					switch(node.nodeType){
					case 1:
						var i;
						var nodes = node.childNodes;
						var num = nodes.length;
						for(i=0;i<num;i++){
							n = queue;
							p = n.p;
							q = {p:p,n:n,node:nodes[i]};
							p.n = q;
							n.p = q;
						}
						break;
					case 3:
						while(node){
							var m = DomNodeGetNodeValue(node).match(re_detail);
							if(!m)	break;

							// 元のテキストノード
							DomNodeSetNodeValue(node,RegExp.leftContext);

							// BbsControlName を生成
							var element = DocumentCreateElement("a");
							ElementSetTextContent(element,m[0]);
							DomNode_InsertAfter(node,element);

							// 直後テキスト
							node = DocumentCreateText(RegExp.rightContext);
							DomNode_InsertAfter(element,node);

							var query = "";
							m = ElementGetTextContent(element).match(re_range);
							if(m){
								var min = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
								var max = parseInt(StringConvertFromNumericFullToNumericHalf(m[2]));
								if(min < 1) min = 1;
								if(max < 1) max = 1;
								if(min > 10000) min = 10000;
								if(max > 10000) max = 10000;
								if(max < min){
									var tmp = min;
									min = max;
									max = tmp;
								}
								query = min + "-" + max;
							}else{
								// 番号
								m = ElementGetTextContent(element).match(re_number);
								if(m){
									query = parseInt(StringConvertFromNumericFullToNumericHalf(m[0]));
									if(query < 1) query = 1;
									if(query > 0x7fffffff) query = 0x7fffffff;
								}

							}
							element.href = work.base_url + query;
						}
					}
				}
			};

			// --------------------------------------------------------------------------------
			// 継ぎ足し読み込み
			// --------------------------------------------------------------------------------
			function readMore(){

				// ローダーオブジェクトを作成
				var loader = new Loader();

				// 成功
				loader.onload = function(str){
					var re_number = new RegExp("<a href=\".*?\">([0-9]+)</a>","i");

					var p = 0;
					var n = str.length;
					function f(){
						try{
							if(p >= n) throw 0;
							p = str.indexOf("<div class=\"res\">",p);
							if(p < 0) throw 0;
							var e = str.indexOf("</div>",p);
							if(e >= 0) e += 6;
							var s = str.substring(p,e);
							var m = s.match(re_number);
							if(m){
								var id = parseInt(m[1]);
								if(last_id < id){
									var response = bbs_dictionary.getResponse(id);
									response.clearAnalyzed();
									response.clearOriginalElements();
									response.clearFollowing();

									var nodes = StringHtmlCreateDomNodesSafe(s);
									var j;
									var node_num = nodes.length;
									for(j=0;j<node_num;j++){
										element_parent.appendChild(nodes[j]);
									}
									last_id = id;
									resource_url_more = base_url + (last_id) + "-";
								}
							}

							if(p < e){
								p = e;
								execute_queue.attachFirst(f,null);
								return;
							}
						}catch(e){
						}
						read_more_button.init();
					}
					execute_queue.attachFirst(f,null);
				};

				// 失敗
				loader.onerror = function(){
					read_more_button.init();
				};

				// テキストの読み込み
				loader.setMethod("GET");
				loader.setURL(resource_url_more);
				loader.loadText();
			}

			// --------------------------------------------------------------------------------
			// レスポンス親要素
			// --------------------------------------------------------------------------------
			element_parent = document.getElementById("article");
			if(!element_parent) return false;


			// --------------------------------------------------------------------------------
			// 範囲取得
			// --------------------------------------------------------------------------------
			var nodes = ElementGetElementsByTagName(element_parent,"div");
			var i;
			var node_num = nodes.length;
			for(i=0;i<node_num;i++){
				var node = nodes[i];
				if(node.className == "res"){
					var m = ElementGetTextContent(node).match(new RegExp("([0-9]+)","i"));
					if(m){
						first_id = parseInt(m[1]);
						dictionary_id[first_id] = true;
						if(first_id != 1){
							break;
						}
					}
				}
			}
			for(i=node_num-1;i>=0;i--){
				var node = nodes[i];
				if(node.className == "res"){
					var m = ElementGetTextContent(node).match(new RegExp("([0-9]+)","i"));
					if(m){
						last_id = parseInt(m[1]);
						dictionary_id[last_id] = true;
						if(last_id <= 1000){
							break;
						}
					}
				}
			}

			// --------------------------------------------------------------------------------
			// アクセス先 URL
			// --------------------------------------------------------------------------------
			resource_url_shadow = base_url;
			resource_url_more = base_url + last_id + "-";

			// --------------------------------------------------------------------------------
			// BbsControlReadMoreButton 作成
			// --------------------------------------------------------------------------------
			read_more_button = new BbsControlReadMoreButton();
			read_more_button.setWaitTime(2 * 1000);
			read_more_button.onclick = readMore;
			var read_more_button_prev = document.getElementById("wrap");
			if(read_more_button_prev){
				DomNode_InsertAfter(read_more_button_prev,read_more_button.getElement());
			}

			// --------------------------------------------------------------------------------
			// 書き込みをポップアップ化
			// --------------------------------------------------------------------------------
			// フォーム
			var nodes = ElementGetElementsByTagName(document.body,"form");
			var element_form;
			var input_submit;
			var element_textarea;

			// フォーム
			var i;
			for(i=0;i<nodes.length;i++){
				if(nodes[i].action.indexOf("/test/bbs.cgi/") >= 0){
					element_form = nodes[i];
					break;
				}
			}

			// サブミットボタン
			if(element_form){
				var nodes = ElementGetElementsByTagName(element_form,"input");
				for(i=0;i<nodes.length;i++){
					if(nodes[i].type.toLowerCase() == "submit"){
						input_submit = nodes[i];
						break;
					}
				}
				var nodes = ElementGetElementsByTagName(element_form,"textarea");
				if(nodes.length){
					element_textarea = nodes[0];
				}
			}

			if(input_submit){

				function inputClick(e){

					var w = 800;
					var h = 600;
					var screen_obj = window.screen;
					if(w > screen_obj.availWidth)	w = screen_obj.availWidth;
					if(h > screen_obj.availHeight)	h = screen_obj.availHeight;
					var x = (screen_obj.availWidth  / 2) - (w / 2);
					var y = (screen_obj.availHeight / 2) - (h / 2);

					var window_name = "_pageexpand_" + Math.floor(Math.random() * 0x7FFFFFFF);
					var window_obj = window.open("",window_name,"left=" + x + ",top=" + y + ",width=" + w + ",height=" + h);
					element_form.target = window_name;

					(function(){
						var closed = false;
						var timer = null;

						// タスク生成
						var task = task_container.createTask();
						task.setExecuteFunc(function(){
							try{
								if(window_obj.closed){
									closed = true;
								}

								// アドレスを監視
								var href = "";
								try{
									href = window_obj.location.href;
								}catch(e){}
								if(href.indexOf("http://") == 0){
									if(href.indexOf("/test/read.cgi/") != -1){
										if(!timer){
											timer = (new Date()).getTime();
										}
									}else if(href.indexOf("/test/bbs.cgi/") == -1){
										closed = true;
									}else{
										var document_obj = window_obj.document;
										if(document_obj.readyState == "complete"){
											if(document_obj.title === ""){
												if(!timer){
													timer = (new Date()).getTime();
												}
											}
										}
									}
								}

								if(timer){
									if((new Date()).getTime() - timer > 1000 * 0){
										closed = true;
									}
								}
							}catch(e){
								closed = true;
							}

							if(closed){
								try{
									window_obj.close();
								}catch(e){
									return;
								}
								window_obj = null;
								task.release();
								input_submit.disabled = false;
								if(timer){
									readMore();
									element_textarea.value = "";
								}
							}
						});
					})();
				}

				function formSubmit(e){
					input_submit.disabled = true;
				}

				if(window.addEventListener){
					input_submit.addEventListener("click",inputClick);
					element_form.addEventListener("submit",formSubmit);
				}else if(window.attachEvent){
					input_submit.attachEvent("onclick",inputClick);
					element_form.attachEvent("onsubmit",formSubmit);
				}
			}


			// --------------------------------------------------------------------------------
			// シャドウロード
			// --------------------------------------------------------------------------------
			(function(){
				// ローダーオブジェクトを作成
				var loader = new Loader();

				// 成功
				loader.onload = function(str){
					var re_number = new RegExp("<a href=\".*?\">([0-9]+)</a>","i");
					var re_id = new RegExp("ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i");
					var re_name = new RegExp("(◆(|[ ])[a-zA-Z0-9+/.]{10,12})","i");

					var p = 0;
					var n = str.length;
					function f(){
						if(p >= n) return;
						p = str.indexOf("<div class=\"res\">",p);
						if(p < 0) return;
						var e = str.indexOf("</div>",p);
						if(e >= 0) e += 6;
						var s = str.substring(p,e);
						var m = s.match(re_number);
						if(m){
							var id = parseInt(m[1]);
							if((first_id <= id) && (id <= last_id)){
							}else if(dictionary_id[id]){
							}else{
								// ナンバーからレスポンスオブジェクトを取得
								var response = bbs_dictionary.getResponse(id);
								if(!(response.getAnalyzed())){
									var nodes = StringHtmlCreateDomNodesSafe(s);
									var dt = nodes[0];
									var dd = ElementGetElementsByTagName(dt,"p")[0];

									try{
										if(dt.tagName != "DIV")	return false;
										if(dt.className != "res")	return false;
										if(dd.className != "res_body")	return false;
									}catch(e){
										return false;
									}

									var dt_text = ElementGetTextContent(dt);

									// レスアンカー拡張
									work.extendResponseAnchor(dd);

									// IDの取得
									if(dt_text.match(re_id)){
										response.setId(RegExp.$1);
									}

									// 名前の取得
									if(dt_text.match(re_name)){
										response.setName(RegExp.$1);
									}

									// ホスト名の取得
									(function(){
										var p;
										var n;
										var q;
										var ignore_dictionary = {"B":1,"SCRIPT":1};
										var queue = new Object();
										q = {p:queue,n:queue,node:dt};
										queue.p = q;
										queue.n = q;

										while(queue.n != queue){
											q = queue.n;
											p = q.p;
											n = q.n;
											p.n = n;
											n.p = p;
											var node = q.node;
											switch(node.nodeType){
											case 1:
												if(!(ignore_dictionary[node.tagName])){
													var i;
													var nodes = node.childNodes;
													var num = nodes.length;
													for(i=0;i<num;i++){
														n = queue;
														p = n.p;
														q = {p:p,n:n,node:nodes[i]};
														p.n = q;
														n.p = q;
													}
												}
												break;
											case 3:
												var m = DomNodeGetNodeValue(node).match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
												if(m){
													response.setHost(m[2]);
													return;
												}
												var m = DomNodeGetNodeValue(node).match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})\\n \\]","i"));
												if(m){
													response.setHost(m[2]);
													return;
												}
												var m = DomNodeGetNodeValue(node).match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
												if(m){
													response.setHost(m[2]);
													return;
												}
												break;
											}
										}
									})();

									// フォロー解析
									var dictionary = new Object();
									(function(){
										var nodes = ElementGetElementsByTagName(dd,"a");
										var i;
										var num = nodes.length;
										for(i=0;i<num;i++){
											var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(nodes[i]));
											numbers.getNumbers(function(n){
												if(!dictionary[n]){
													var following = bbs_dictionary.getResponse(n);
													following.addFollower(response);
													dictionary[n] = true;
												}
											});
										}
									})();

									// オリジナルエレメントをセット
									if(dt)	response.addOriginalElements("dt",dt);
									if(dd)	response.addOriginalElements("dd",dd);

									// 消去時に実行されるイベント
									response.onerase = function(){};

									response.setAnalyzed();
								}
							}
						}

						if(p < e){
							p = e;
							execute_queue.attachFirst(f,null);
						}
					}
					execute_queue.attachFirst(f,null);
				};

				// 失敗
				loader.onerror = function(){
				};

				// テキストの読み込み
				loader.setMethod("GET");
				loader.setURL(resource_url_shadow);
				loader.loadText();
			})();

			response({result:true});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		response({result:false});
		return true;
	}.toString() +
"\n]";

				preset.script_callback = 
"[\n\t" + 
	function(info,response){
		var element = info.element;
		var work = info.work;

		// --------------------------------------------------------------------------------
		// レスポンスダイアログを登録
		// --------------------------------------------------------------------------------
		function attachBbsResponseDialog(response,node,parent_dialog,type){

			// --------------------------------------------------------------------------------
			// レスアンカー
			// --------------------------------------------------------------------------------
			function forResponseAnchor(target){
				if(BbsControlResponseAnchorExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlResponseAnchor を生成
				// --------------------------------------------------------------------------------
				(function(){
					var i;
					var nodes = ElementGetElementsByTagName(target,"a");
					var num = nodes.length;
					for(i=0;i<num;i++){
						var node = nodes[i];
						var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(node));
						if(numbers.getCount()){
							var control_res_anchor = new BbsControlResponseAnchor(node,false);
							control_res_anchor.setResponseAnchorNumbers(numbers);
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlResponseAnchor を検索
				// --------------------------------------------------------------------------------
				BbsControlResponseAnchorSearch(target,function(control_res_anchor){

					var element_res_anchor = control_res_anchor.getElement();
					var numbers = control_res_anchor.getResponseAnchorNumbers();

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_res_anchor);
					response_dialog.oncreate = function(_window,callback){

						var created = false;
						var i = 0;
						var number_list = numbers.getNumberList();
						var num = number_list.length;
						if(!num) return false;

						function f(){
							var following = bbs_dictionary.getResponse(number_list[i]);
							var clone = following.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){
								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									_window.appendChild(obj.element);
								}
								try{
									var dd = ElementGetElementsByTagName(param["dt"],"p")[0];
									DomNode_InsertBefore(dd,param["dd"]);
									DomNodeRemove(dd);
								}catch(e){
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(following,param,response_dialog,"response");

								created = true;
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:created});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// ID
			// --------------------------------------------------------------------------------
			function forId(target){
				if(BbsControlIdExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlId を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"A":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}

							break;
						case 3:
							while(node){

								var m = DomNodeGetNodeValue(node).match(new RegExp("ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(node,RegExp.leftContext);

								// BbsControlId を生成
								var control_id = new BbsControlId(null,false);
								control_id.setId(m[1]);
								var element_id = control_id.getElement();
								ElementSetTextContent(element_id,m[0]);
								DomNode_InsertAfter(node,element_id);

								// 直後テキスト
								node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(element_id,node);
							}
							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlId を検索
				// --------------------------------------------------------------------------------
				BbsControlIdSearch(target,function(control_id){

					control_id.setResponse(response);

					var id = control_id.getId();
					var element_id = control_id.getElement();
					var textnode_id = DocumentCreateText("");

					element_id.appendChild(textnode_id);

					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_id.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_id,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_id,"");
						}

						var style = element_id.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","small");
						}
					};
					control_id.update();

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "id"){
						if(response.getId() == id)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_id);
					response_dialog.oncreate = function(_window,callback){

						var responses = bbs_dictionary.getResponsesFromId(id);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_id = responses[i];
							var clone = response_id.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									_window.appendChild(obj.element);
								}
								try{
									var dd = ElementGetElementsByTagName(param["dt"],"p")[0];
									DomNode_InsertBefore(dd,param["dd"]);
									DomNodeRemove(dd);
								}catch(e){
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_id,param,response_dialog,"id");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// トリップ
			// --------------------------------------------------------------------------------
			function forName(target){
				if(BbsControlNameExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlName を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							while(node){

								// 本文
								var m = DomNodeGetNodeValue(node).match(new RegExp("(◆(|[ ])[a-zA-Z0-9+/.]{10,12})","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(node,RegExp.leftContext);

								// BbsControlName を生成
								var control_name = new BbsControlName(null,false);
								control_name.setName(m[0]);
								var element_name = control_name.getElement();
								ElementSetTextContent(element_name,m[0]);
								DomNode_InsertAfter(node,element_name);

								// 直後テキスト
								node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(element_name,node);
							}
							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlName を検索
				// --------------------------------------------------------------------------------
				BbsControlNameSearch(target,function(control_name){

					control_name.setResponse(response);

					var name = control_name.getName();
					var element_name = control_name.getElement();
					var textnode_name = DocumentCreateText("");


					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_name.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_name,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_name,"");
						}

						var style = element_name.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","small");
						}
					};
					control_name.update();
					element_name.appendChild(textnode_name);

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "name"){
						if(response.getName() == name)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_name);
					response_dialog.oncreate = function(_window,callback){

						var responses = bbs_dictionary.getResponsesFromName(name);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_name = responses[i];
							var clone = response_name.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									_window.appendChild(obj.element);
								}
								try{
									var dd = ElementGetElementsByTagName(param["dt"],"p")[0];
									DomNode_InsertBefore(dd,param["dd"]);
									DomNodeRemove(dd);
								}catch(e){
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_name,param,response_dialog,"name");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// ホスト
			// --------------------------------------------------------------------------------
			function forHost(target){
				if(BbsControlHostExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlHost を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"B":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							while(node){
								var text_value = DomNodeGetNodeValue(node);

								var m = text_value.match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
								if(m){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext + m[1]);

									// BbsControlHost を生成
									var control_host = new BbsControlHost(null,false);
									control_host.setHost(m[2]);
									var element_host = control_host.getElement();
									ElementSetTextContent(element_host,m[2]);
									DomNode_InsertAfter(node,element_host);

									// 直後テキスト
									node = DocumentCreateText(RegExp.rightContext);
									DomNode_InsertAfter(element_host,node);
									continue;
								}

								var m = text_value.match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})(\\n \\])","i"));
								if(m){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext + m[1]);

									// BbsControlHost を生成
									var control_host = new BbsControlHost(null,false);
									control_host.setHost(m[2]);
									var element_host = control_host.getElement();
									ElementSetTextContent(element_host,m[2]);
									DomNode_InsertAfter(node,element_host);

									// 直後テキスト
									node = DocumentCreateText("\n ]" + RegExp.rightContext);
									DomNode_InsertAfter(element_host,node);
									continue;
								}

								var m = text_value.match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
								if(m){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext + m[1]);

									// BbsControlHost を生成
									var control_host = new BbsControlHost(null,false);
									control_host.setHost(m[2]);
									var element_host = control_host.getElement();
									ElementSetTextContent(element_host,m[2]);
									DomNode_InsertAfter(node,element_host);

									// 直後テキスト
									node = DocumentCreateText(RegExp.rightContext);
									DomNode_InsertAfter(element_host,node);
									continue;
								}

								break;
							}

							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlHost を検索
				// --------------------------------------------------------------------------------
				BbsControlHostSearch(target,function(control_host){

					control_host.setResponse(response);

					var host = control_host.getHost();
					var element_host = control_host.getElement();
					var textnode_host = DocumentCreateText("");


					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_host.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_host,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_host,"");
						}

						var style = element_host.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","80%");
						}
					};
					control_host.update();
					element_host.appendChild(textnode_host);

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "host"){
						if(response.getHost() == host)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_host);
					response_dialog.oncreate = function(_window,callback){

						var responses = bbs_dictionary.getResponsesFromHost(host);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_host = responses[i];
							var clone = response_host.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									_window.appendChild(obj.element);
								}
								try{
									var dd = ElementGetElementsByTagName(param["dt"],"p")[0];
									DomNode_InsertBefore(dd,param["dd"]);
									DomNodeRemove(dd);
								}catch(e){
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_host,param,response_dialog,"host");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// フォロワー
			// --------------------------------------------------------------------------------
			function forFollower(target){
				if(BbsControlFollowerExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlFollower を生成
				// --------------------------------------------------------------------------------
				var control_follower = new BbsControlFollower(null,true);
				control_follower.setResponse(response);

				var element_follower = control_follower.getElement();
				var textnode_follower = DocumentCreateText("");

				element_follower.appendChild(textnode_follower);

				// --------------------------------------------------------------------------------
				// 変化があったときに実行されるイベント
				// --------------------------------------------------------------------------------
				control_follower.onchange = function(count){
					if(count){
						textnode_follower.nodeValue = " follower(" + count + ")";
					}else{
						textnode_follower.nodeValue = "";
					}

					var style = element_follower.style;
					if(count >= 3){
						StyleDeclarationSetProperty(style,"color","#e80000");
						StyleDeclarationRemoveProperty(style,"font-size");

					}else{
						StyleDeclarationSetProperty(style,"color","#888");
						StyleDeclarationSetProperty(style,"font-size","small");
					}
					if(count){
						StyleDeclarationSetProperty(style,"margin","0px 4px 0px 0px");
					}else{
						StyleDeclarationRemoveProperty(style,"margin");
					}
				};
				control_follower.update();
				var nodes = ElementGetElementsByTagName(target,"br");
				if(nodes.length){
					DomNode_InsertBefore(nodes[0],element_follower);
				}else{
					target.appendChild(element_follower);
				}

				// --------------------------------------------------------------------------------
				// ポップアップ化
				// --------------------------------------------------------------------------------
				// ダイアログを作成
				var response_dialog = new BbsResponseDialog();
				if(parent_dialog)	parent_dialog.attachChild(response_dialog);
				response_dialog.setElementParent(node.parent);
				response_dialog.setElementHitArea(element_follower);
				response_dialog.oncreate = function(_window,callback){

					var ary = response.getFollower();
					var i = 0;
					var num = ary.length;
					if(num <= 0) return false;

					function f(){
						var follower = bbs_dictionary.getResponse(ary[i].getNumber());
						var clone = follower.getCloneElements();

						var j;
						var clone_num = clone.length;
						if(clone_num){

							var param = new Object();
							param.parent = node.parent;
							for(j=0;j<clone_num;j++){
								var obj = clone[j];
								param[obj.name] = obj.element;
								_window.appendChild(obj.element);
							}
							try{
								var dd = ElementGetElementsByTagName(param["dt"],"p")[0];
								DomNode_InsertBefore(dd,param["dd"]);
								DomNodeRemove(dd);
							}catch(e){
							}

							// レスポンスダイアログを登録
							attachBbsResponseDialog(follower,param,response_dialog,"response");
						}

						i += 1;
						if(i < num){
							execute_queue.attachFirst(f,null);
						}else{
							callback({result:true});
						}
					}
					execute_queue.attachFirst(f,null);
				};
			}

			if(node.dt){
				forResponseAnchor(node.dt);
				forId(node.dt);
				forName(node.dt);
				forHost(node.dt);
				forFollower(node.dt);
			}
			if(node.dd){
				forResponseAnchor(node.dd);
				forId(node.dd);
				forName(node.dd);
			}
		}

		// --------------------------------------------------------------------------------
		// エレメントを解析
		// --------------------------------------------------------------------------------
		var useful = (function(){
			var dt = element;
			var dd;

			try{
				if(dt.tagName != "DIV")	return false;
				if(dt.className != "res")	return false;
			}catch(e){
				return false;
			}

			try{
				dd = ElementGetElementsByTagName(dt,"p")[0];
				if(dd.className != "res_body")	return false;
			}catch(e){
				return false;
			}

			try{
				var div = dt.parentNode;
				if(div.id != "article")	return false;
			}catch(e){
				return false;
			}

			// document に未登録
			if(!DomNodeGetAttachedDocument(dt))	return false;

			// --------------------------------------------------------------------------------
			// レスアンカー拡張
			// --------------------------------------------------------------------------------
			work.extendResponseAnchor(dd);

			// --------------------------------------------------------------------------------
			// クリーンアップ
			// --------------------------------------------------------------------------------
			(function(){
				function cleanup(target){
					BbsControlSearchTrash(target,function(element){
						var node = element.firstChild;
						if(!node)	return null;
						if(node.nodeType != 3)	return null;

						// ID
						var m = node.nodeValue.match(new RegExp("^ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);
							return null;
						}

						// トリップ
						var m = node.nodeValue.match(new RegExp("^(◆(|[ ])[a-zA-Z0-9+/.]{10,12})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);
							return null;
						}

						// ホスト名
						var m = node.nodeValue.match(new RegExp("^([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);

							// テキストノードを統合
							node.parentNode.normalize();
							return null;
						}
						var m = node.nodeValue.match(new RegExp("^([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);

							// テキストノードを統合
							node.parentNode.normalize();
							return null;
						}

						return null;
					});
				}

				if(dt){
					cleanup(dt);
				}
				if(dd){
					cleanup(dd);
				}
			})();

			// ナンバーを取得
			var dt_text = ElementGetTextContent(dt);
			if(!(dt_text.match(new RegExp("([0-9]+)","i"))))	return false;

			// ナンバーからレスポンスオブジェクトを取得
			var response = bbs_dictionary.getResponse(parseInt(RegExp.$1));

			// レスポンス解析
			if(!response.getAnalyzed()){

				(function(){
					// 本文を除外
					var dt_clone = dt.cloneNode(true);
					try{
						var dd = ElementGetElementsByTagName(dt_clone,"p")[0];
						DomNodeRemove(dd);
					}catch(e){
					}
					dt_text = ElementGetTextContent(dt_clone);
				})();

				// IDの取得
				if(dt_text.match(new RegExp("ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"))){
					response.setId(RegExp.$1);
				}

				// 名前の取得
				if(dt_text.match(new RegExp("(◆(|[ ])[a-zA-Z0-9+/.]{10,12})","i"))){
					response.setName(RegExp.$1);
				}

				// ホスト名の取得
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"B":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:dt};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							var m = DomNodeGetNodeValue(node).match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
							if(m){
								response.setHost(m[2]);
								return;
							}
							var m = DomNodeGetNodeValue(node).match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})\\n \\]","i"));
							if(m){
								response.setHost(m[2]);
								return;
							}
							var m = DomNodeGetNodeValue(node).match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
							if(m){
								response.setHost(m[2]);
								return;
							}
							break;
						}
					}
				})();

				// フォロー解析
				var dictionary = new Object();
				(function(){
					var nodes = ElementGetElementsByTagName(dd,"a");
					var i;
					var num = nodes.length;
					for(i=0;i<num;i++){
						var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(nodes[i]));
						numbers.getNumbers(function(n){
							if(!dictionary[n]){
								var following = bbs_dictionary.getResponse(n);
								following.addFollower(response);
								dictionary[n] = true;
							}
						});
					}
				})();

				// オリジナルエレメントをセット
				if(dt)	response.addOriginalElements("dt",dt);
				if(dd)	response.addOriginalElements("dd",dd);

				// 消去時に実行されるイベント
				response.onerase = function(){
					var original = response.getOriginalElements();

					// オリジナルエレメントを外す
					var i;
					var num = original.length;
					for(i=0;i<num;i++){
						var revise_scroll = new DocumentReviseScroll();
						var node = original[i].element;
						revise_scroll.executeRemoveElementBefore(node);
						DomNodeRemove(node);
						revise_scroll.executeRemoveElementAfter(node);
					}
				};

				response.setAnalyzed();
			}

			// レスポンスダイアログを登録（ルート）
			attachBbsResponseDialog(
				response,
				{
					dt:dt,
					dd:dd,
					parent:dt.parentNode
				},
				null,
				null
			);

			return true;
		})();

		response({useful:useful});
		return true;
	}.toString() +
"\n]";

				// ふたば☆ちゃんねる
				var obj = addPreset(proj.expand_bbs,"2chan",null);
				var preset = obj.preset;
				preset.filter = [
					{
						pattern:"^http://[^.]+\\.2chan\\.net/[^/]+/res/[0-9]+.htm",
						flags:{i:true,g:false}
					}
				];
				preset.script_initialize = 
"[\n\t" + 
	function(info,response){
		var work = info.work;

		// --------------------------------------------------------------------------------
		// 基本URL抽出
		// --------------------------------------------------------------------------------
		var url = document.URL;
		var bbs_list = [
			{url:"^http://[^.]+\\.2chan\\.net/[^/]+/res/[0-9]+.htm",name:"2chan"}
		];

		var i;
		var num = bbs_list.length;
		for(i=0;i<num;i++){
			var m = url.match(new RegExp(bbs_list[i].url,"i"));
			if(m){
				work.base_url = m[0];
				work.bbs_name = bbs_list[i].name;
				break;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		var work = info.work;

		if(work.bbs_name){
			var last_id = 1;
			var element_parent = null;
			var read_more_button = null;
			var element_form = null;
			var base_url = work.base_url;
			var resource_url = base_url;

			// --------------------------------------------------------------------------------
			// 双葉辞書
			// --------------------------------------------------------------------------------
			function FutabaDictionary(){
				var _container = new Object();

				// --------------------------------------------------------------------------------
				// レスポンス生成
				// --------------------------------------------------------------------------------
				function createResponse(number){
					var _response = new Object();

					// --------------------------------------------------------------------------------
					// 開放
					// --------------------------------------------------------------------------------
					_response.release = function(obj){
						var _prev = _response._prev;
						var _next = _response._next;
						_prev._next = _next;
						_next._prev = _prev;
						_response._prev = _response;
						_response._next = _response;
						delete _number_dictionary[_image_id];
						delete _image_id_dictionary[_image_id];
						_response._text_dictionary = new Object();
					};

					// --------------------------------------------------------------------------------
					// 番号を取得
					// --------------------------------------------------------------------------------
					_response.getNumber = function(){
						return number;
					};

					// --------------------------------------------------------------------------------
					// テキストを登録
					// --------------------------------------------------------------------------------
					_response.attachText = function(str){
						m = str.match(new RegExp("([ 　]*)(.+?)([ 　]*)$"));
						if(!m) return;
						if(!m[2]) return;
						_response._text_dictionary[m[2]] = true;
					};

					// --------------------------------------------------------------------------------
					// テキストからレスポンスを取得
					// --------------------------------------------------------------------------------
					_response.getResponsesFromText = function(str){
						var ary = new Array();
						var str_num = str.length;
						if(str_num < 2) return ary;

						// 完全一致
						var list = _response._prev;
						while(_response_list != list){
							if(list._text_dictionary[str]){
								ary.push(list);
							}
							list = list._prev;
						}
						if(ary.length) return ary;
						if(str_num < 3) return ary;

						// 部分一致
						var list = _response._prev;
						while(_response_list != list){
							var k;
							var d = list._text_dictionary;
							for(k in d){
								if(k.indexOf(str) >= 0){
									ary.push(list);
									break;
								}
							}
							list = list._prev;
						}
						return ary;
					};

					// --------------------------------------------------------------------------------
					// イメージ ID を登録
					// --------------------------------------------------------------------------------
					_response.setImageId = function(id){
						_image_id = id;
						_image_id_dictionary[_image_id] = _response;
					};

					// --------------------------------------------------------------------------------
					// プライベート変数
					// --------------------------------------------------------------------------------
					var _image_id;

					// --------------------------------------------------------------------------------
					// 初期化
					// --------------------------------------------------------------------------------
					(function(){
						_response._prev = _response;
						_response._next = _response;
						_response._text_dictionary = new Object();
						var list = _response_list._prev;
						while(_response_list != list){
							if(list.getNumber() >= number){
								break;
							}
							list = list._prev;
						}
						var _next = list;
						var _prev = _next._prev;
						_prev._next = _response;
						_next._prev = _response;
						_response._prev = _prev;
						_response._next = _next;
						_number_dictionary[number] = _response;
					})();

					return _response;
				}

				// --------------------------------------------------------------------------------
				// 番号からレスポンスを生成
				// --------------------------------------------------------------------------------
				_container.createResponse = function(number){
					var response = _number_dictionary[number];
					if(!response){
						response = createResponse(number);
						_number_dictionary[number] = response;
					}
					return response;
				};

				// --------------------------------------------------------------------------------
				// 番号からレスポンスを取得
				// --------------------------------------------------------------------------------
				_container.getResponse = function(number){
					return _number_dictionary[number];
				};

				// --------------------------------------------------------------------------------
				// 画像 ID からレスポンスを取得
				// --------------------------------------------------------------------------------
				_container.getResponseFromImageId = function(id){
					return _image_id_dictionary[id];
				};

				// --------------------------------------------------------------------------------
				// プライベート変数
				// --------------------------------------------------------------------------------
				var _number_dictionary;
				var _image_id_dictionary;
				var _response_list;

				// --------------------------------------------------------------------------------
				// 初期化
				// --------------------------------------------------------------------------------
				(function(){
					_number_dictionary = new Object();
					_image_id_dictionary = new Object();
					_response_list = new Object();
					_response_list._prev = _response_list;
					_response_list._next = _response_list;
				})();

				return _container;
			}

			// --------------------------------------------------------------------------------
			// テーブル解析
			// --------------------------------------------------------------------------------
			work.analyzeTable = function(table){
				var re_number = new RegExp("No\\.([0-9]+)","i");
				var re_image = new RegExp(".*/([0-9]+)\\.(bmp|gif|jpeg|jpe|jpg|png)","i");

				// ナンバーを取得
				var info_text = ElementGetTextContent(table);
				var m = info_text.match(re_number);
				if(m){
					var id = parseInt(m[1]);
					if(work.futaba_dictionary.getResponse(id)) return;
					var response = work.futaba_dictionary.createResponse(id);

					try{
						var blockquote = ElementGetElementsByTagName(table,"BLOCKQUOTE")[0];

						// 画像 ID
						var anchor = blockquote.previousSibling;
						while(anchor){
							if(anchor.tagName == "A"){
								if(anchor.href.match(re_image)){
									response.setImageId(RegExp.$1);
									break;
								}
							}
							anchor = anchor.previousSibling;
						}

						// 本文
						var nodes = blockquote.childNodes;
						var node_num = nodes.length;
						var i;
						var s = "";
						for(i=0;i<node_num;i++){
							var node = nodes[i];
							switch(node.nodeType){
							case 1:
								if(node.tagName == "BR"){
									if(s){
										response.attachText(s);
									}
									s = "";
								}else{
									s += ElementGetTextContent(node);
								}
								break;
							case 3:
								s += node.nodeValue;
								break;
							}
						}
						if(s){
							response.attachText(s);
						}
					}catch(e){
					}
				}
			};

			// --------------------------------------------------------------------------------
			// フォーム位置補正
			// --------------------------------------------------------------------------------
			function revisePositionForm(){
				try{
					var ftbl = document.getElementById("ftbl");
					var ufm = document.getElementById("ufm");
					if(ftbl.style.position == "absolute"){
						var p = DocumentGetScrollPos();
						var r = ufm.getBoundingClientRect();
						ftbl.style.top = (p.y + r.top) + "px";
					}
				}catch(e){}
			}

			// --------------------------------------------------------------------------------
			// 継ぎ足し読み込み
			// --------------------------------------------------------------------------------
			function readMore(){

				// ローダーオブジェクトを作成
				var loader = new Loader();

				// 成功
				loader.onload = function(str){
					var re_number = new RegExp("Name[ ].*?No\\.([0-9]+)","i");
					var element_last;

					var p = 0;
					var n = str.length;
					function f(){
						try{
							if(p >= n) throw 0;
							p = str.indexOf("<table border=0>",p);
							if(p < 0) throw 0;
							var e = str.indexOf("</td>",p);
							if(e >= 0){
								e = str.indexOf("</tr>",e + 5);
								if(e >= 0){
									e = str.indexOf("</table>",e + 5);
									if(e >= 0) e += 8;
								}
							}
							var s = str.substring(p,e);
							var m = s.match(re_number);
							if(m){
								var id = parseInt(m[1]);
								if(last_id < id){
									var response = bbs_dictionary.getResponse(id);
									response.clearAnalyzed();
									response.clearOriginalElements();
									response.clearFollowing();

									var nodes = StringHtmlCreateDomNodesSafe(s);
									var j;
									var node_num = nodes.length;
									for(j=0;j<node_num;j++){
										DomNode_InsertAfter(element_last,nodes[j]);
										element_last = nodes[j];
									}

									// フォーム位置補正
									revisePositionForm();

									last_id = id;
								}
							}

							if(p < e){
								p = e;
								execute_queue.attachFirst(f,null);
								return;
							}
						}catch(e){
						}

						read_more_button.init();
					}

					var nodes = ElementGetElementsByTagName(element_parent,"table");
					if(nodes.length){
						element_last = nodes[nodes.length-1];
					}

					execute_queue.attachFirst(f,null);
				};

				// 失敗
				loader.onerror = function(){
					read_more_button.init();
				};

				// テキストの読み込み
				loader.setMethod("GET");
				loader.setURL(resource_url);
				loader.overrideMimeType("text/plain; charset=Shift_JIS");
				loader.loadText();
			}

			// --------------------------------------------------------------------------------
			// レスポンス親要素
			// --------------------------------------------------------------------------------
			var i;
			var nodes = ElementGetElementsByTagName(document.body,"form");
			var num = nodes.length;
			for(i=0;i<num;i++){
				var node = nodes[i];
				if(node.action.indexOf("futaba.php") != -1){
					if(ElementGetElementsByTagName(node,"blockquote").length){
						element_parent = node;
						break;
					}
				}
			}

			if(!element_parent) return false;

			// --------------------------------------------------------------------------------
			// 最後尾 ID
			// --------------------------------------------------------------------------------
			var nodes = ElementGetElementsByTagName(element_parent,"table");
			var i;
			var node_num = nodes.length;
			for(i=node_num-1;i>=0;i--){
				var node = nodes[i];
				var m = ElementGetTextContent(node).match(new RegExp("No\\.([0-9]+)","i"));
				if(m){
					last_id = parseInt(m[1]);
					break;
				}
			}

			// --------------------------------------------------------------------------------
			// アクセス先 URL
			// --------------------------------------------------------------------------------
			resource_url = base_url;

			// --------------------------------------------------------------------------------
			// BbsControlReadMoreButton 作成
			// --------------------------------------------------------------------------------
			read_more_button = new BbsControlReadMoreButton();
			read_more_button.setWaitTime(2 * 1000);
			read_more_button.onclick = readMore;
			var nodes = ElementGetElementsByTagName(element_parent,"hr");
			if(nodes.length){
				DomNode_InsertBefore(nodes[nodes.length-1],read_more_button.getElement());
			}


			// --------------------------------------------------------------------------------
			// 書き込みをポップアップ化
			// --------------------------------------------------------------------------------
			// フォーム
			var nodes = ElementGetElementsByTagName(document.body,"form");
			var element_form;
			var input_submit;
			var element_textarea;

			// フォーム
			var node = document.getElementById("ftbl");
			while(node){
				if(node.tagName == "FORM"){
					element_form = node;
					break;
				}
				node = node.parentNode;
			}

			// サブミットボタン
			if(element_form){
				var nodes = ElementGetElementsByTagName(element_form,"input");
				for(i=0;i<nodes.length;i++){
					if(nodes[i].type.toLowerCase() == "submit"){
						input_submit = nodes[i];
						break;
					}
				}
				var nodes = ElementGetElementsByTagName(element_form,"textarea");
				if(nodes.length){
					element_textarea = nodes[0];
				}
			}

			if(input_submit){

				function inputClick(e){

					var w = 600;
					var h = 600;
					var cookie = document.cookie;
					if(cookie){
						if(cookie.indexOf("PREN=") != -1){
							w = 600;
							h = 450;
						}
					}

					var screen_obj = window.screen;
					if(w > screen_obj.availWidth)	w = screen_obj.availWidth;
					if(h > screen_obj.availHeight)	h = screen_obj.availHeight;
					var x = (screen_obj.availWidth  / 2) - (w / 2);
					var y = (screen_obj.availHeight / 2) - (h / 2);

					var window_name = "_pageexpand_" + Math.floor(Math.random() * 0x7FFFFFFF);
					var window_obj = window.open("",window_name,"left=" + x + ",top=" + y + ",width=" + w + ",height=" + h);
					element_form.target = window_name;

					(function(){
						var closed = false;
						var timer = null;

						// タスク生成
						var task = task_container.createTask();
						task.setExecuteFunc(function(){
							try{
								if(window_obj.closed){
									closed = true;
								}

								// アドレスを監視
								var href = "";
								try{
									href = window_obj.location.href;
								}catch(e){}
								if(href.indexOf("http://") == 0){
									if(href.indexOf("/res/") != -1){
										if(!timer){
											timer = (new Date()).getTime();
										}
									}else if(href.indexOf("/futaba.php") == -1){
										closed = true;
									}
								}

								if(timer){
									if((new Date()).getTime() - timer > 1000 * 0){
										closed = true;
									}
								}
							}catch(e){
								closed = true;
							}

							if(closed){
								try{
									window_obj.close();
								}catch(e){
									return;
								}
								window_obj = null;
								task.release();
								input_submit.disabled = false;
								if(timer){
									readMore();
									element_textarea.value = "";
								}
							}
						});
					})();
				}

				function formSubmit(e){
					input_submit.disabled = true;
				}

				if(window.addEventListener){
					input_submit.addEventListener("click",inputClick);
					element_form.addEventListener("submit",formSubmit);
				}else if(window.attachEvent){
					input_submit.attachEvent("onclick",inputClick);
					element_form.attachEvent("onsubmit",formSubmit);
				}
			}

			// --------------------------------------------------------------------------------
			// 双葉辞書を生成
			// --------------------------------------------------------------------------------
			(function(){
				work.futaba_dictionary = new FutabaDictionary();
				var nodes = ElementGetElementsByTagName(element_parent,"table");
				var node_num = nodes.length;
				var p = 0;

				(function(){
					var post_message = ElementGetElementsByTagName(document.body,"blockquote")[0];
					var post_container = post_message.parentNode;
					if(post_container.tagName == "FORM"){
						work.analyzeTable(post_container);
					}
				})();

				function f(){
					try{
						var node = nodes[p];
						if(!node) throw 0;

						work.analyzeTable(node);
					}catch(e){
					}

					if(p < node_num){
						p += 1;
						execute_queue.attachFirst(f,null);
						return;
					}

					response({result:true});
				}

				execute_queue.attachFirst(f,null);
				return true;
			})();
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		response({result:false});
		return true;
	}.toString() +
"\n]";

				preset.script_callback = 
"[\n\t" + 
	function(info,response){
		var element = info.element;
		var work = info.work;

		// --------------------------------------------------------------------------------
		// レスポンスダイアログを登録
		// --------------------------------------------------------------------------------
		function attachBbsResponseDialog(response,node,parent_dialog,type){

			var br_add_dictionary = {"post_info":1,"post_file_info":1};

			// --------------------------------------------------------------------------------
			// レスアンカー
			// --------------------------------------------------------------------------------
			function forResponseAnchor(target){
				if(BbsControlResponseAnchorExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlResponseAnchor を生成
				// --------------------------------------------------------------------------------
				(function(){
					var i;
					var nodes = ElementGetElementsByTagName(target,"a");
					var num = nodes.length;
					for(i=0;i<num;i++){
						var node = nodes[i];
						var numbers = StringCreateResponseAnchorNumbers(ElementGetTextContent(node));
						if(numbers.getCount()){
							var control_res_anchor = new BbsControlResponseAnchor(node,false);
							control_res_anchor.setResponseAnchorNumbers(numbers);
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlResponseAnchor を検索
				// --------------------------------------------------------------------------------
				BbsControlResponseAnchorSearch(target,function(control_res_anchor){

					var element_res_anchor = control_res_anchor.getElement();
					var numbers = control_res_anchor.getResponseAnchorNumbers();

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_res_anchor);
					response_dialog.oncreate = function(_window,callback){

						var created = false;
						var i = 0;
						var number_list = numbers.getNumberList();
						var num = number_list.length;
						if(!num) return false;

						function f(){
							var following = bbs_dictionary.getResponse(number_list[i]);
							var clone = following.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){
								var table = DocumentCreateElement("table");
								var tr = DocumentCreateElement("tr");
								var td = DocumentCreateElement("td");
								table.style.margin = "0px 0px 10px";
								_window.appendChild(table);
								table.appendChild(tr);
								tr.appendChild(td);

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									td.appendChild(obj.element);

									// 改行追加
									if(br_add_dictionary[obj.name]){
										td.appendChild(DocumentCreateElement("br"));
									}
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(following,param,response_dialog,"response");

								created = true;
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:created});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// 引用
			// --------------------------------------------------------------------------------
			function forQuote(target){
				if(BbsControlQuoteExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlQuote を生成
				// --------------------------------------------------------------------------------
				(function(){
					function NumberListEqual(a,b){
						var i;
						var n = a.length;
						if(n != b.length) return false;
						for(i=0;i<n;i++){
							if(a[i] != b[i]) return false;
						}
						return true;
					}

					var numbers_old = null;
					var numbers_new = null;
					var i;
					var nodes = target.childNodes;
					var num = nodes.length;
					for(i=num-1;i>=0;i--){
						var node = nodes[i];
						if(node.tagName == "FONT"){
							var numbers = QuoteStringCreateResponseAnchorNumbers(response.getNumber(),ElementGetTextContent(node));
							if(numbers.getCount()){
								numbers_new = numbers.getNumberList();
								var abbreviate = false;
								if(numbers_old){
									if(NumberListEqual(numbers_old,numbers_new)){
										abbreviate = true;
									}
								}
								if(!abbreviate){
									var control_quote = new BbsControlQuote(null,true);
									var element_quote = control_quote.getElement();
									element_quote.style.cssText = "font-size:small; text-decoration:underline; margin-left:10px;";
									var textnode_quote = DocumentCreateText(" >>" + numbers_new.join(","));
									element_quote.appendChild(textnode_quote);
									DomNode_InsertLastChild(node,element_quote);
									control_quote.setResponseAnchorNumbers(numbers);
									numbers_old = numbers_new;
								}
							}
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlQuote を検索
				// --------------------------------------------------------------------------------
				BbsControlQuoteSearch(target,function(control_quote){

					var element_res_anchor = control_quote.getElement();
					var numbers = control_quote.getResponseAnchorNumbers();

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_res_anchor);
					response_dialog.oncreate = function(_window,callback){

						var created = false;
						var i = 0;
						var number_list = numbers.getNumberList();
						var num = number_list.length;
						if(!num) return false;

						function f(){
							var following = bbs_dictionary.getResponse(number_list[i]);
							var clone = following.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){
								var table = DocumentCreateElement("table");
								var tr = DocumentCreateElement("tr");
								var td = DocumentCreateElement("td");
								table.style.margin = "0px 0px 10px";
								_window.appendChild(table);
								table.appendChild(tr);
								tr.appendChild(td);

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									td.appendChild(obj.element);

									// 改行追加
									if(br_add_dictionary[obj.name]){
										td.appendChild(DocumentCreateElement("br"));
									}
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(following,param,response_dialog,"response");

								created = true;
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:created});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// ID
			// --------------------------------------------------------------------------------
			function forId(target){
				if(BbsControlIdExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlId を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"A":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}

							break;
						case 3:
							while(node){

								var m = DomNodeGetNodeValue(node).match(new RegExp("ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(node,RegExp.leftContext);

								// BbsControlId を生成
								var control_id = new BbsControlId(null,false);
								control_id.setId(m[1]);
								var element_id = control_id.getElement();
								ElementSetTextContent(element_id,m[0]);
								DomNode_InsertAfter(node,element_id);

								// 直後テキスト
								node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(element_id,node);
							}
							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlId を検索
				// --------------------------------------------------------------------------------
				BbsControlIdSearch(target,function(control_id){

					control_id.setResponse(response);

					var id = control_id.getId();
					var element_id = control_id.getElement();
					var textnode_id = DocumentCreateText("");

					element_id.appendChild(textnode_id);

					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_id.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_id,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_id,"");
						}

						var style = element_id.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#707070");
							StyleDeclarationSetProperty(style,"font-size","small");
						}
					};
					control_id.update();

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "id"){
						if(response.getId() == id)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_id);
					response_dialog.oncreate = function(_window,callback){

						var responses = bbs_dictionary.getResponsesFromId(id);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_id = responses[i];
							var clone = response_id.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){
								var table = DocumentCreateElement("table");
								var tr = DocumentCreateElement("tr");
								var td = DocumentCreateElement("td");
								table.style.margin = "0px 0px 10px";
								_window.appendChild(table);
								table.appendChild(tr);
								tr.appendChild(td);

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									td.appendChild(obj.element);

									// 改行追加
									if(br_add_dictionary[obj.name]){
										td.appendChild(DocumentCreateElement("br"));
									}
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_id,param,response_dialog,"id");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// トリップ
			// --------------------------------------------------------------------------------
			function forName(target){
				if(BbsControlNameExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlName を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							while(node){

								// 本文
								var m = DomNodeGetNodeValue(node).match(new RegExp("(◆(|[ ])[a-zA-Z0-9+/.]{10,12})","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(node,RegExp.leftContext);

								// BbsControlName を生成
								var control_name = new BbsControlName(null,false);
								control_name.setName(m[0]);
								var element_name = control_name.getElement();
								ElementSetTextContent(element_name,m[0]);
								DomNode_InsertAfter(node,element_name);

								// 直後テキスト
								node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(element_name,node);
							}
							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlName を検索
				// --------------------------------------------------------------------------------
				BbsControlNameSearch(target,function(control_name){

					control_name.setResponse(response);

					var name = control_name.getName();
					var element_name = control_name.getElement();
					var textnode_name = DocumentCreateText("");


					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_name.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_name,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_name,"");
						}

						var style = element_name.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#707070");
							StyleDeclarationSetProperty(style,"font-size","small");
						}
					};
					control_name.update();
					element_name.appendChild(textnode_name);

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "name"){
						if(response.getName() == name)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_name);
					response_dialog.oncreate = function(_window,callback){

						var responses = bbs_dictionary.getResponsesFromName(name);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_name = responses[i];
							var clone = response_name.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){
								var table = DocumentCreateElement("table");
								var tr = DocumentCreateElement("tr");
								var td = DocumentCreateElement("td");
								table.style.margin = "0px 0px 10px";
								_window.appendChild(table);
								table.appendChild(tr);
								tr.appendChild(td);

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									td.appendChild(obj.element);

									// 改行追加
									if(br_add_dictionary[obj.name]){
										td.appendChild(DocumentCreateElement("br"));
									}
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_name,param,response_dialog,"name");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// ホスト
			// --------------------------------------------------------------------------------
			function forHost(target){
				if(BbsControlHostExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlHost を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"B":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							while(node){
								var text_value = DomNodeGetNodeValue(node);

								var m = text_value.match(new RegExp("(IP:)([0-9]{1,3}\\.[0-9]{1,3}\\.[*][(][-.a-zA-Z0-9]+[)])","i"));
								if(m){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext + m[1]);

									// BbsControlHost を生成
									var control_host = new BbsControlHost(null,false);
									control_host.setHost(m[2]);
									var element_host = control_host.getElement();
									ElementSetTextContent(element_host,m[2]);
									DomNode_InsertAfter(node,element_host);

									// 直後テキスト
									node = DocumentCreateText(RegExp.rightContext);
									DomNode_InsertAfter(element_host,node);
									continue;
								}

								break;
							}

							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlHost を検索
				// --------------------------------------------------------------------------------
				BbsControlHostSearch(target,function(control_host){

					control_host.setResponse(response);

					var host = control_host.getHost();
					var element_host = control_host.getElement();
					var textnode_host = DocumentCreateText("");


					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_host.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_host,"[" + count + "]");
						}else{
							DomNodeSetNodeValue(textnode_host,"");
						}

						var style = element_host.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#707070");
							StyleDeclarationSetProperty(style,"font-size","80%");
						}
					};
					control_host.update();
					element_host.appendChild(textnode_host);

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "host"){
						if(response.getHost() == host)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_host);
					response_dialog.oncreate = function(_window,callback){

						var responses = bbs_dictionary.getResponsesFromHost(host);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_host = responses[i];
							var clone = response_host.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){
								var table = DocumentCreateElement("table");
								var tr = DocumentCreateElement("tr");
								var td = DocumentCreateElement("td");
								table.style.margin = "0px 0px 10px";
								_window.appendChild(table);
								table.appendChild(tr);
								tr.appendChild(td);

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									td.appendChild(obj.element);

									// 改行追加
									if(br_add_dictionary[obj.name]){
										td.appendChild(DocumentCreateElement("br"));
									}
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_host,param,response_dialog,"host");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// フォロワー
			// --------------------------------------------------------------------------------
			function forFollower(target){
				if(BbsControlFollowerExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlFollower を生成
				// --------------------------------------------------------------------------------
				var control_follower = new BbsControlFollower(null,true);
				control_follower.setResponse(response);

				var element_follower = control_follower.getElement();
				var textnode_follower = DocumentCreateText("");

				element_follower.appendChild(textnode_follower);

				// --------------------------------------------------------------------------------
				// 変化があったときに実行されるイベント
				// --------------------------------------------------------------------------------
				control_follower.onchange = function(count){
					if(count){
						textnode_follower.nodeValue = " follower(" + count + ")";
					}else{
						textnode_follower.nodeValue = "";
					}

					var style = element_follower.style;
					if(count >= 3){
						StyleDeclarationSetProperty(style,"color","#e80000");
						StyleDeclarationRemoveProperty(style,"font-size");

					}else{
						StyleDeclarationSetProperty(style,"color","#707070");
						StyleDeclarationSetProperty(style,"font-size","small");
					}
					if(count){
						StyleDeclarationSetProperty(style,"margin","0px 4px 0px 0px");
					}else{
						StyleDeclarationRemoveProperty(style,"margin");
					}
				};
				control_follower.update();
				var nodes = ElementGetElementsByTagName(target,"br");
				if(nodes.length){
					DomNode_InsertBefore(nodes[0],element_follower);
				}else{
					target.appendChild(element_follower);
				}

				// --------------------------------------------------------------------------------
				// ポップアップ化
				// --------------------------------------------------------------------------------
				// ダイアログを作成
				var response_dialog = new BbsResponseDialog();
				if(parent_dialog)	parent_dialog.attachChild(response_dialog);
				response_dialog.setElementParent(node.parent);
				response_dialog.setElementHitArea(element_follower);
				response_dialog.oncreate = function(_window,callback){

					var ary = response.getFollower();
					var i = 0;
					var num = ary.length;
					if(num <= 0) return false;

					function f(){
						var follower = bbs_dictionary.getResponse(ary[i].getNumber());
						var clone = follower.getCloneElements();

						var j;
						var clone_num = clone.length;
						if(clone_num){
							var table = DocumentCreateElement("table");
							var tr = DocumentCreateElement("tr");
							var td = DocumentCreateElement("td");
							table.style.margin = "0px 0px 10px";
							_window.appendChild(table);
							table.appendChild(tr);
							tr.appendChild(td);

							var param = new Object();
							param.parent = node.parent;
							for(j=0;j<clone_num;j++){
								var obj = clone[j];
								param[obj.name] = obj.element;
								td.appendChild(obj.element);

								// 改行追加
								if(br_add_dictionary[obj.name]){
									td.appendChild(DocumentCreateElement("br"));
								}
							}

							// レスポンスダイアログを登録
							attachBbsResponseDialog(follower,param,response_dialog,"response");
						}

						i += 1;
						if(i < num){
							execute_queue.attachFirst(f,null);
						}else{
							callback({result:true});
						}
					}
					execute_queue.attachFirst(f,null);
				};
			}

			if(node.post_info){
				forId(node.post_info);
				forName(node.post_info);
				forHost(node.post_info);
				forFollower(node.post_info);
			}
			if(node.post_message){
				forResponseAnchor(node.post_message);
				forQuote(node.post_message);
				forId(node.post_message);
				forName(node.post_message);
			}
		}

		// --------------------------------------------------------------------------------
		// 文字列からレスポンス番号を取得
		// --------------------------------------------------------------------------------
		function StringCreateResponseAnchorNumbers(str){
			var numbers = new ResponseAnchorNumbers();

			var re_search = new RegExp("^(No\\.|>>|<<|＞＞|＜＜|>|＞|》|≫|&gt;&gt;)([0-9０-９]+)","i");
			var re_image = new RegExp("([0-9０-９]+)\\.(bmp|gif|jpeg|jpe|jpg|png)","i");
			var re_number = new RegExp("^([0-9０-９]+)","i");

			var m = str.match(re_search);
			if(m){
				var p = m[1].length;
				while(true){
					// 番号
					m = str.substr(p).match(re_number);
					if(m){
						p += m[0].length;

						var response = null;
						var id = StringConvertFromNumericFullToNumericHalf(m[1]);
						if(!response) response = work.futaba_dictionary.getResponseFromImageId(id);

						id = parseInt(id);
						if(id < 1) id = 1;
						if(id > 0x7fffffff) id = 0x7fffffff;
						if(!response) response = work.futaba_dictionary.getResponse(id);

						if(response){
							id = response.getNumber();
						}

						numbers.addNumber(id);
					}

					if(m){
						// カンマ
						if(RegExp.rightContext.search(",") == 0){
							p += 1;
							continue;
						}
					}
					break;
				}
			}
			var m = str.match(re_image);
			if(m){
				var id = StringConvertFromNumericFullToNumericHalf(m[1]);
				var response = work.futaba_dictionary.getResponseFromImageId(id);
				if(response){
					numbers.addNumber(response.getNumber());
				}

			}
			return numbers;
		}

		// --------------------------------------------------------------------------------
		// 引用文字列からレスポンス番号を取得
		// --------------------------------------------------------------------------------
		function QuoteStringCreateResponseAnchorNumbers(id,str){
			var numbers = new ResponseAnchorNumbers();
			var response = work.futaba_dictionary.getResponse(id);
			if(!response) return numbers;

			var re_search = new RegExp("^(>|＞)([ 　]*)(.+?)([ 　]*)$","i");

			var m = str.match(re_search);
			if(m){
				var responses = response.getResponsesFromText(m[3]);
				var num = responses.length;
				var i;
				for(i=0;i<num;i++){
					numbers.addNumber(responses[i].getNumber());
				}
			}
			return numbers;
		}

		// --------------------------------------------------------------------------------
		// エレメントを解析
		// --------------------------------------------------------------------------------
		var useful = (function(){
			var post_container;
			var post_info;
			var post_file;
			var post_file_info;
			var post_message = element;

			try{
				if(post_message.tagName != "BLOCKQUOTE")	return false;
			}catch(e){
				return false;
			}

			// コンテナ取得
			try{
				post_container = post_message.parentNode;
				if(post_container.tagName == "FORM"){
				}else if(post_container.tagName == "TD"){
					while(post_container){
						if(post_container.tagName == "TABLE"){
							break;
						}
						post_container = post_container.parentNode;
					}
					if(!post_container){
						return false;
					}
				}else{
					return false;
				}
			}catch(e){
				return false;
			}

			// 画像取得
			try{
				var anchor = post_message.previousSibling;
				while(anchor){
					if(anchor.tagName == "A"){
						var images = ElementGetElementsByTagName(anchor,"img");
						if(images.length == 1){
							post_file = anchor;
							break;
						}
					}
					anchor = anchor.previousSibling;
				}
			}catch(e){
			}

			// document に未登録
			if(!DomNodeGetAttachedDocument(post_message))	return;

			// ファイル情報をグループ化
			try{
				var node = post_file.previousSibling;
				if(node.tagName == "BR"){
					node = node.previousSibling;
					if(node.tagName == "SPAN"){
						post_file_info = node;
					}else{
						post_file_info = DocumentCreateElement("span");
						DomNode_InsertAfter(node,post_file_info);
						var node = post_file_info.previousSibling;
						while(node){
							var prev = node.previousSibling;
							if(node.tagName == "BR")	break;
							DomNode_InsertFirstChild(post_file_info,node);
							node = prev;
						}
					}
				}
			}catch(e){
			}

			// 名前情報をグループ化
			try{
				var input;
				var nodes = ElementGetElementsByTagName(post_container,"input");
				if(nodes.length){
					input = nodes[0];
				}

				if(input){
					var node = input.parentNode;
					if(node.tagName == "SPAN"){
						post_info = node;
					}else{
						post_info = DocumentCreateElement("span");
						DomNode_InsertBefore(input,post_info);
						node = input;
						var dic = {"DIV":1,"SMALL":1,"BLOCKQUOTE":1,"BR":1};
						while(node){
							var next = node.nextSibling;
							if(dic[node.tagName])	break;
							post_info.appendChild(node);
							node = next;
						}
					}
				}
			}catch(e){
			}

			if(post_container.tagName == "FORM"){
				try{
					function nodeTest(node){
						while(node){
							if(node.tagName == "TABLE"){
								return false;
							}
							if(node == post_container){
								return true;
							}
							node = node.parentNode;
						}
						return false;
					}

					if(!nodeTest(post_info)){
						return false;
					}

					if(!nodeTest(post_file_info)){
						return false;
					}

				}catch(e){
				}
			}

			if(post_container.tagName == "FORM"){
				try{
					if(post_container.parentNode != document.body) return false;
				}catch(e){
					return false;
				}
			}
			if(post_container.tagName == "TABLE"){
				try{
					var form = post_container.parentNode;
					if(form.tagName != "FORM") return false;
					if(form.parentNode != document.body) return false;
				}catch(e){
					return false;
				}
			}

			// 双葉辞書追加
			work.analyzeTable(post_container);

			// --------------------------------------------------------------------------------
			// レスアンカー拡張
			// --------------------------------------------------------------------------------
			(function(target){
				if(BbsControlResponseAnchorExist(target))	return;
				if(BbsControlQuoteExist(target))	return;

				var re_simple = new RegExp("^(No\\.|>>|<<|>)[-,0-9０-９]+$","i");
				var re_image = new RegExp("([0-9０-９]+)\\.(bmp|gif|jpeg|jpe|jpg|png)","i");
				var re_detail = new RegExp("(No\\.|>>|<<|＞＞|＜＜|>|＞|》|≫|&gt;&gt;)([0-9０-９]+,)*[0-9０-９]+","i");
				var re_number = new RegExp("([0-9０-９]+)","i");

				var i;
				var nodes = ElementGetElementsByTagName(target,"a");
				var num = nodes.length;
				for(i=num-1;i>=0;i--){
					var node = nodes[i];
					var m = ElementGetTextContent(node).match(re_simple);
					if(m){
						var text_node = DocumentCreateText(m[0]);
						DomNode_InsertBefore(node,text_node);
						DomNodeRemove(node);
					}
				}

				// テキストノードを統合
				target.normalize();

				var p;
				var n;
				var q;
				var ignore_dictionary = {"A":1,"SCRIPT":1};
				var queue = new Object();
				q = {p:queue,n:queue,node:target};
				queue.p = q;
				queue.n = q;

				while(queue.n != queue){
					q = queue.n;
					p = q.p;
					n = q.n;
					p.n = n;
					n.p = p;
					var node = q.node;
					switch(node.nodeType){
					case 1:
						var i;
						var nodes = node.childNodes;
						var num = nodes.length;
						for(i=0;i<num;i++){
							n = queue;
							p = n.p;
							q = {p:p,n:n,node:nodes[i]};
							p.n = q;
							n.p = q;
						}
						break;
					case 3:
						while(node){
							var m = DomNodeGetNodeValue(node).match(re_image);
							if(m){
								var response = work.futaba_dictionary.getResponseFromImageId(m[1]);
								if(response){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext);

									// BbsControlName を生成
									var element = DocumentCreateElement("a");
									ElementSetTextContent(element,m[0]);
									DomNode_InsertAfter(node,element);

									// 直後テキスト
									node = DocumentCreateText(RegExp.rightContext);
									element.href = work.base_url + "#" + response.getNumber();
									DomNode_InsertAfter(element,node);
									continue;
								}
							}

							var m = DomNodeGetNodeValue(node).match(re_detail);
							if(!m)	break;

							var text_left  = RegExp.leftContext;
							var text_match = m[0];
							var text_right = RegExp.rightContext;

							var query = 0;
							m = text_match.match(re_number);
							while(m){
								var v = parseInt(StringConvertFromNumericFullToNumericHalf(m[0]));
								if(v < 1) v = 1;
								if(v > 0x7fffffff) v = 0x7fffffff;

								var response = null;
								if(!response) response = work.futaba_dictionary.getResponse(v);
								if(!response) response = work.futaba_dictionary.getResponseFromImageId(v);
								if(response){
									query = v;
									break;
								}

								m = RegExp.rightContext.match(re_number);
							}

							if(!query) break;

							// 元のテキストノード
							DomNodeSetNodeValue(node,text_left);

							// BbsControlName を生成
							var element = DocumentCreateElement("a");
							ElementSetTextContent(element,text_match);
							DomNode_InsertAfter(node,element);

							// 直後テキスト
							node = DocumentCreateText(text_right);
							element.href = work.base_url + "#" + query;
							DomNode_InsertAfter(element,node);
						}
					}
				}
			})(post_message);

			// --------------------------------------------------------------------------------
			// クリーンアップ
			// --------------------------------------------------------------------------------
			(function(){
				function cleanup(target){
					BbsControlSearchTrash(target,function(element){
						var node = element.firstChild;
						if(!node)	return null;
						if(node.nodeType != 3)	return null;

						// ID
						var m = node.nodeValue.match(new RegExp("^ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);
							return null;
						}

						// トリップ
						var m = node.nodeValue.match(new RegExp("^(◆(|[ ])[a-zA-Z0-9+/.]{10,12})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);
							return null;
						}

						// ホスト名
						var m = node.nodeValue.match(new RegExp("^([0-9]{1,3}\\.[0-9]{1,3}\\.[*][(][-.a-zA-Z0-9]+[)])","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);

							// テキストノードを統合
							node.parentNode.normalize();
							return null;
						}

						return null;
					});
				}

				if(post_info){
					cleanup(post_info);
				}
				if(post_message){
					cleanup(post_message);
				}
			})();

			// ナンバーを取得
			var info_text = ElementGetTextContent(post_info);
			if(!(info_text.match(new RegExp("No\\.([0-9]+)","i"))))	return false;

			// ナンバーからレスポンスオブジェクトを取得
			var response = bbs_dictionary.getResponse(parseInt(RegExp.$1));

			// アンカー追加
			try{
				var node = post_container.previousSibling;
				if(node.tagName != "A"){
					var anchor = DocumentCreateElement("a");
					anchor.name = "" + RegExp.$1;
					DomNode_InsertBefore(post_container,anchor);
				}
			}catch(e){
			}

			// レスポンス解析
			if(!response.getAnalyzed()){

				// IDの取得
				if(info_text.match(new RegExp("ID:([a-zA-Z0-9+/.]{8,10})[●!]{0,2}","i"))){
					response.setId(RegExp.$1);
				}

				// 名前の取得
				if(info_text.match(new RegExp("(◆(|[ ])[a-zA-Z0-9+/.]{10,12})","i"))){
					response.setName(RegExp.$1);
				}

				// ホスト名の取得
				if(info_text.match(new RegExp("IP:([0-9]{1,3}\\.[0-9]{1,3}\\.[*][(][-.a-zA-Z0-9]+[)])","i"))){
					response.setHost(RegExp.$1);
				}

				// フォロー解析
				var dictionary = new Object();
				(function(){
					var nodes = ElementGetElementsByTagName(post_message,"a");
					var i;
					var num = nodes.length;
					for(i=0;i<num;i++){
						var numbers = StringCreateResponseAnchorNumbers(ElementGetTextContent(nodes[i]));
						numbers.getNumbers(function(n){
							if(!dictionary[n]){
								var following = bbs_dictionary.getResponse(n);
								following.addFollower(response);
								dictionary[n] = true;
							}
						});
					}
					var nodes = post_message.childNodes;
					var i;
					var num = nodes.length;
					for(i=0;i<num;i++){
						var node = nodes[i];
						if(node.tagName == "FONT"){
							var numbers = QuoteStringCreateResponseAnchorNumbers(response.getNumber(),ElementGetTextContent(node));
							numbers.getNumbers(function(n){
								if(!dictionary[n]){
									var following = bbs_dictionary.getResponse(n);
									following.addFollower(response);
									dictionary[n] = true;
								}
							});
						}
					}
				})();

				// オリジナルエレメントをセット
				if(post_info)			response.addOriginalElements("post_info",post_info);
				if(post_file_info)		response.addOriginalElements("post_file_info",post_file_info);
				if(post_file)			response.addOriginalElements("post_file",post_file);
				if(post_message)		response.addOriginalElements("post_message",post_message);

				// 消去時に実行されるイベント
				response.onerase = function(){
					var original = response.getOriginalElements();

					var node;
					if(original.length){
						node = original[original.length-1].element;
						while(node){
							if(node.tagName == "TABLE")	break;
							node = node.parentNode;
						}
					}
					if(node){
						var revise_scroll = new DocumentReviseScroll();
						revise_scroll.executeRemoveElementBefore(node);
						DomNodeRemove(node);
						revise_scroll.executeRemoveElementAfter(node);
					}

					// オリジナルエレメントを外す
					var i;
					var num = original.length;
					for(i=0;i<num;i++){
						var revise_scroll = new DocumentReviseScroll();
						var node = original[i].element;
						revise_scroll.executeRemoveElementBefore(node);
						DomNodeRemove(node);
						revise_scroll.executeRemoveElementAfter(node);
					}
				};

				response.setAnalyzed();
			}

			// レスポンスダイアログを登録（ルート）
			attachBbsResponseDialog(
				response,
				{
					post_info:post_info,
					post_file_info:post_file_info,
					post_file:post_file,
					post_message:post_message,
					parent:document.body
				},
				null,
				null
			);

			return true;
		})();

		response({useful:useful});
		return true;
	}.toString() +
"\n]";

				// 4chan.org
				var obj = addPreset(proj.expand_bbs,"4chan",null);
				var preset = obj.preset;
				preset.script_callback = 
"[\n\t" + 
	function(info,response){
		var element = info.element;

		// --------------------------------------------------------------------------------
		// レスポンスダイアログを登録
		// --------------------------------------------------------------------------------
		function attachBbsResponseDialog(response,node,parent_dialog,type){

			// --------------------------------------------------------------------------------
			// レスアンカー
			// --------------------------------------------------------------------------------
			function forResponseAnchor(target){
				if(BbsControlResponseAnchorExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlResponseAnchor を生成
				// --------------------------------------------------------------------------------
				(function(){
					var i;
					var nodes = ElementGetElementsByTagName(target,"a");
					var num = nodes.length;
					for(i=0;i<num;i++){
						var node = nodes[i];
						var numbers = StringCreateResponseAnchorNumbers(ElementGetTextContent(node));
						if(numbers.getCount()){
							var control_res_anchor = new BbsControlResponseAnchor(node,false);
							control_res_anchor.setResponseAnchorNumbers(numbers);
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlResponseAnchor を検索
				// --------------------------------------------------------------------------------
				BbsControlResponseAnchorSearch(target,function(control_res_anchor){

					var element_res_anchor = control_res_anchor.getElement();
					var numbers = control_res_anchor.getResponseAnchorNumbers();

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_res_anchor);
					response_dialog.oncreate = function(_window,callback){

						_window.className = "reply";

						var created = false;
						var i = 0;
						var number_list = numbers.getNumberList();
						var num = number_list.length;
						if(!num) return false;

						function f(){
							var following = bbs_dictionary.getResponse(number_list[i]);
							var clone = following.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){
								var container = DocumentCreateElement("table");
								container.style.margin = "0px 0px 10px";
								_window.appendChild(container);

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									container.appendChild(obj.element);
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(following,param,response_dialog,"response");

								created = true;
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:created});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// ID
			// --------------------------------------------------------------------------------
			function forId(target){
				if(BbsControlIdExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlId を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"A":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}

							// 名前欄
							if(node.tagName == "SPAN"){
								if(node.className == "hand"){
									var m = ElementGetTextContent(node).match(new RegExp("^([a-zA-Z0-9+/.]{8})$","i"));
									if(m){
										// BbsControlId を生成
										var control_id = new BbsControlId(null,true);
										control_id.setId(m[1]);
										var element_id = control_id.getElement();
										DomNode_InsertAfter(node,element_id);
									}
								}
							}

							break;
						case 3:
							while(node){

								// 本文
								var m = DomNodeGetNodeValue(node).match(new RegExp("ID:(|[ ])([a-zA-Z0-9+/.]{8})","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(node,RegExp.leftContext);

								// BbsControlId を生成
								var control_id = new BbsControlId(null,false);
								control_id.setId(m[2]);
								var element_id = control_id.getElement();
								ElementSetTextContent(element_id,m[0]);
								DomNode_InsertAfter(node,element_id);

								// 直後テキスト
								node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(element_id,node);
							}
							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlId を検索
				// --------------------------------------------------------------------------------
				BbsControlIdSearch(target,function(control_id){

					control_id.setResponse(response);

					var id = control_id.getId();
					var element_id = control_id.getElement();
					var textnode_id = DocumentCreateText("");

					element_id.appendChild(textnode_id);

					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_id.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_id,"[" + count + "]");
						}else{
							DomNodeSetNodeValue(textnode_id,"");
						}

						var style = element_id.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#707070");
							StyleDeclarationSetProperty(style,"font-size","small");
						}
						if(count > 1){
							StyleDeclarationSetProperty(style,"margin","0px 4px 0px 4px");
						}else{
							StyleDeclarationRemoveProperty(style,"margin");
						}
					};
					control_id.update();

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "id"){
						if(response.getId() == id)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_id);
					response_dialog.oncreate = function(_window,callback){

						_window.className = "reply";

						var responses = bbs_dictionary.getResponsesFromId(id);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_id = responses[i];
							var clone = response_id.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){
								var container = DocumentCreateElement("table");
								container.style.margin = "0px 0px 10px";
								_window.appendChild(container);

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									container.appendChild(obj.element);
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_id,param,response_dialog,"id");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// トリップ
			// --------------------------------------------------------------------------------
			function forName(target){
				if(BbsControlNameExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlName を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							while(node){

								// 本文
								var m = DomNodeGetNodeValue(node).match(new RegExp("(!|!!)([a-zA-Z0-9+/.]{10})","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(node,RegExp.leftContext);

								// BbsControlName を生成
								var control_name = new BbsControlName(null,false);
								control_name.setName(m[0]);
								var element_name = control_name.getElement();
								ElementSetTextContent(element_name,m[0]);
								DomNode_InsertAfter(node,element_name);

								// 直後テキスト
								node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(element_name,node);
							}
							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlName を検索
				// --------------------------------------------------------------------------------
				BbsControlNameSearch(target,function(control_name){

					control_name.setResponse(response);

					var name = control_name.getName();
					var element_name = control_name.getElement();
					var textnode_name = DocumentCreateText("");


					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_name.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_name,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_name,"");
						}

						var style = element_name.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#707070");
							StyleDeclarationSetProperty(style,"font-size","small");
						}
					};
					control_name.update();
					element_name.appendChild(textnode_name);

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "name"){
						if(response.getName() == name)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_name);
					response_dialog.oncreate = function(_window,callback){

						_window.className = "reply";

						var responses = bbs_dictionary.getResponsesFromName(name);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_name = responses[i];
							var clone = response_name.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){
								var container = DocumentCreateElement("table");
								container.style.margin = "0px 0px 10px";
								_window.appendChild(container);

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									container.appendChild(obj.element);
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_name,param,response_dialog,"name");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// フォロワー
			// --------------------------------------------------------------------------------
			function forFollower(target){
				if(BbsControlFollowerExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlFollower を生成
				// --------------------------------------------------------------------------------
				var control_follower = new BbsControlFollower(null,true);
				control_follower.setResponse(response);

				var element_follower = control_follower.getElement();
				var textnode_follower = DocumentCreateText("");

				element_follower.appendChild(textnode_follower);

				// --------------------------------------------------------------------------------
				// 変化があったときに実行されるイベント
				// --------------------------------------------------------------------------------
				control_follower.onchange = function(count){
					if(count){
						textnode_follower.nodeValue = " follower(" + count + ")";
					}else{
						textnode_follower.nodeValue = "";
					}

					var style = element_follower.style;
					if(count >= 3){
						StyleDeclarationSetProperty(style,"color","#e80000");
						StyleDeclarationRemoveProperty(style,"font-size");

					}else{
						StyleDeclarationSetProperty(style,"color","#707070");
						StyleDeclarationSetProperty(style,"font-size","small");
					}
					if(count){
						StyleDeclarationSetProperty(style,"margin","0px 4px 0px 0px");
					}else{
						StyleDeclarationRemoveProperty(style,"margin");
					}
				};
				control_follower.update();
				target.appendChild(element_follower);


				// --------------------------------------------------------------------------------
				// ポップアップ化
				// --------------------------------------------------------------------------------
				// ダイアログを作成
				var response_dialog = new BbsResponseDialog();
				if(parent_dialog)	parent_dialog.attachChild(response_dialog);
				response_dialog.setElementParent(node.parent);
				response_dialog.setElementHitArea(element_follower);
				response_dialog.oncreate = function(_window,callback){

					_window.className = "reply";

					var ary = response.getFollower();
					var i = 0;
					var num = ary.length;
					if(num <= 0) return false;

					function f(){
						var follower = bbs_dictionary.getResponse(ary[i].getNumber());
						var clone = follower.getCloneElements();

						var j;
						var clone_num = clone.length;
						if(clone_num){
							var container = DocumentCreateElement("table");
							container.style.margin = "0px 0px 10px";
							_window.appendChild(container);

							var param = new Object();
							param.parent = node.parent;
							for(j=0;j<clone_num;j++){
								var obj = clone[j];
								param[obj.name] = obj.element;
								container.appendChild(obj.element);
							}

							// レスポンスダイアログを登録
							attachBbsResponseDialog(follower,param,response_dialog,"response");
						}

						i += 1;
						if(i < num){
							execute_queue.attachFirst(f,null);
						}else{
							callback({result:true});
						}
					}
					execute_queue.attachFirst(f,null);
				};
			}

			if(node.post_info){
				forResponseAnchor(node.post_info);
				forId(node.post_info);
				forName(node.post_info);
				forFollower(node.post_info);
			}
			if(node.post_message){
				forResponseAnchor(node.post_message);
				forId(node.post_message);
				forName(node.post_message);
			}
		}

		// --------------------------------------------------------------------------------
		// 文字列からレスポンス番号を取得
		// --------------------------------------------------------------------------------
		function StringCreateResponseAnchorNumbers(str){
			var numbers = new ResponseAnchorNumbers();

			var re_search = new RegExp("^(>>|<<|＞＞|＜＜|>|＞)([0-9０-９]+)","i");
			var re_range = new RegExp("^([0-9０-９]+)[-]([0-9０-９]+)","i");
			var re_number = new RegExp("^([0-9０-９]+)","i");

			var m = str.match(re_search);
			if(m){
				var p = m[1].length;
				while(true){
					// 番号-番号
					m = str.substr(p).match(re_range);
					if(m){
						var min = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
						var max = parseInt(StringConvertFromNumericFullToNumericHalf(m[2]));
						if(min < 1) min = 1;
						if(max < 1) max = 1;
						if(min > 0x7fffffff) min = 0x7fffffff;
						if(max > 0x7fffffff) max = 0x7fffffff;
						if(max < min){
							var tmp = min;
							min = max;
							max = tmp;
						}
						if(max - min > 10000) max = min + 10000;
						p += m[0].length;
						numbers.addNumbers(min,max);
					}else{
						// 番号
						m = str.substr(p).match(re_number);
						if(m){
							p += m[0].length;
							var id = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
							if(id < 1) id = 1;
							if(id > 0x7fffffff) id = 0x7fffffff;
							numbers.addNumber(id);
						}
					}

					if(m){
						// カンマ
						if(RegExp.rightContext.search(",") == 0){
							p += 1;
							continue;
						}
					}
					break;
				}
			}
			return numbers;
		}

		// --------------------------------------------------------------------------------
		// エレメントを解析
		// --------------------------------------------------------------------------------
		var useful = (function(){
			var post_info = element;
			var post_file;
			var post_message;

			try{
				if(post_info.tagName != "DIV")	return false;
				if(!(post_info.className.match(new RegExp("^postInfo","i"))))	return false;
			}catch(e){
				return false;
			}

			try{
				post_message = post_info.nextSibling;
				if(post_message.tagName == "DIV"){
					if(post_message.className == "file"){
						post_file = post_message;
						post_message = post_file.nextSibling;
					}
				}
			}catch(e){
			}

			try{
				if(post_message.tagName != "BLOCKQUOTE")	return false;
				if(post_message.className != "postMessage")	return false;
			}catch(e){
				return false;
			}

			if(!post_file){
				try{
					var node = post_info.previousSibling;
					if(node.tagName == "DIV"){
						if(node.className == "file"){
							post_file = node;
						}
					}
				}catch(e){
				}
			}

			// document に未登録
			if(!DomNodeGetAttachedDocument(post_info))	return false;

			// ポップアップを除外
			var board = false;
			var node = post_info;
			while(node){
				if(node.className == "board"){
					board = true;
					break;
				}
				node = node.parentNode;
			}
			if(!board)	return false;

			// --------------------------------------------------------------------------------
			// クリーンアップ
			// --------------------------------------------------------------------------------
			(function(){
				function cleanupInfo(target){
					var nodes = ElementGetElementsByTagName(post_info,"span");
					var i;
					var num = nodes.length;
					for(i=0;i<num;i++){
						var node = nodes[i];
						if(node.className == "postertrip"){
							// トリップ
							var m = ElementGetTextContent(element).match(new RegExp("(!|!!)([a-zA-Z0-9+/.]{10})","i"));
							if(m){
								ElementSetTextContent(node,m[0]);
							}
							break;
						}
					}
				}

				function cleanupMessage(target){
					BbsControlSearchTrash(target,function(element){
						var node = element.firstChild;
						if(!node)	return null;
						if(node.nodeType != 3)	return null;

						// ID
						var m = node.nodeValue.match(new RegExp("^ID:(|[ ])([a-zA-Z0-9+/.]{8})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);
							return null;
						}

						// トリップ
						var m = node.nodeValue.match(new RegExp("^(!|!!)([a-zA-Z0-9+/.]{10})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);
							return null;
						}

						return null;
					});
				}

				if(post_info){
					cleanupInfo(post_info);
				}
				if(post_message){
					cleanupMessage(post_message);
				}
			})();

			// ナンバーを取得
			var info_text = ElementGetTextContent(post_info);
			if(!(info_text.match(new RegExp("No\\.([0-9]+)","i"))))	return false;

			// ナンバーからレスポンスオブジェクトを取得
			var response = bbs_dictionary.getResponse(parseInt(RegExp.$1));

			// レスポンス解析
			if(!response.getAnalyzed()){

				// IDの取得
				if(info_text.match(new RegExp("\\(ID:[ ]([a-zA-Z0-9+/.]+)\\)","i"))){
					response.setId(RegExp.$1);
				}

				// 名前の取得
				(function(){
					var nodes = ElementGetElementsByTagName(post_info,"span");
					var i;
					var num = nodes.length;
					for(i=0;i<num;i++){
						var node = nodes[i];
						if(node.className == "postertrip"){
							response.setName(ElementGetTextContent(node));
							break;
						}
					}
				})();

				// フォロー解析
				var dictionary = new Object();
				(function(){
					var nodes = ElementGetElementsByTagName(post_message,"a");
					var i;
					var num = nodes.length;
					for(i=0;i<num;i++){
						var numbers = StringCreateResponseAnchorNumbers(ElementGetTextContent(nodes[i]));
						numbers.getNumbers(function(n){
							if(!dictionary[n]){
								var following = bbs_dictionary.getResponse(n);
								following.addFollower(response);
								dictionary[n] = true;
							}
						});
					}
				})();

				// オリジナルエレメントをセット
				if(post_info)		response.addOriginalElements("post_info",post_info);
				if(post_file)		response.addOriginalElements("post_file",post_file);
				if(post_message)	response.addOriginalElements("post_message",post_message);

				// 消去時に実行されるイベント
				response.onerase = function(){
					var original = response.getOriginalElements();
					if(original.length){
						var node = original[0].element;
						while(node){
							if(node.className.match(new RegExp("^postContainer","i"))){
								var revise_scroll = new DocumentReviseScroll();
								revise_scroll.executeRemoveElementBefore(node);
								DomNodeRemove(node);
								revise_scroll.executeRemoveElementAfter(node);
								break;
							}
							node = node.parentNode;
						}
					}
				};

				response.setAnalyzed();
			}

			// レスポンスダイアログを登録（ルート）
			attachBbsResponseDialog(
				response,
				{
					post_info:post_info,
					post_file:post_file,
					post_message:post_message,
					parent:document.body
				},
				null,
				null
			);

			return true;
		})();

		response({useful:useful});
		return true;
	}.toString() +
"\n]";

				// ニコニコ大百科
				var obj = addPreset(proj.expand_bbs,"nicovideo_dictionary",null);
				var preset = obj.preset;
				preset.script_initialize = 
"[\n\t" + 
	function(info,response){
		var work = info.work;

		// --------------------------------------------------------------------------------
		// 基本URL抽出
		// --------------------------------------------------------------------------------
		var url = document.URL;
		var bbs_list = [
			{url:"^http://dic\\.nicovideo\\.jp/b/(a|c|i|l|u|v)/.+?/",name:"nicopedia"},
			{url:"^http://dic\\.nicovideo\\.jp/(a|c|i|l|u|v)/.+?/",name:"nicopedia"}
		];

		var i;
		var num = bbs_list.length;
		for(i=0;i<num;i++){
			var m = url.match(new RegExp(bbs_list[i].url,"i"));
			if(m){
				work.base_url = m[0];
				work.bbs_name = bbs_list[i].name;
				break;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		var work = info.work;

		if(work.bbs_name){
			var load_separate = 1000;
			var load_dose = 30;
			var load_offset = 1;
			var first_id = 1;
			var last_id = 1;
			var load_shadow_id = 1;
			var load_more_id = 1;
			var dictionary_id = new Array();
			var element_parent = null;
			var read_more_button = null;
			var element_form = null;
			var base_url = work.base_url;
			var resource_url_shadow = base_url;
			var resource_url_more = base_url;

			// --------------------------------------------------------------------------------
			// 文字列からレスポンス番号を取得
			// --------------------------------------------------------------------------------
			work.createResponseAnchorNumbers = function (str){
				var numbers = new ResponseAnchorNumbers();

				var re_search = new RegExp("^(>>|<<|＞＞|＜＜|>|＞|》|≫|&gt;&gt;)([0-9０-９]+)","i");
				var re_range = new RegExp("^([0-9０-９]+)[-]([0-9０-９]+)","i");
				var re_number = new RegExp("^([0-9０-９]+)","i");

				var m = str.match(re_search);
				if(m){
					var p = m[1].length;
					while(true){
						// 番号-番号
						m = str.substr(p).match(re_range);
						if(m){
							var min = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
							var max = parseInt(StringConvertFromNumericFullToNumericHalf(m[2]));
							if(min < 1) min = 1;
							if(max < 1) max = 1;
							if(min > 0x7fffffff) min = 0x7fffffff;
							if(max > 0x7fffffff) max = 0x7fffffff;
							if(max < min){
								var tmp = min;
								min = max;
								max = tmp;
							}
							if(max - min > 10000) max = min + 10000;
							p += m[0].length;
							numbers.addNumbers(min,max);
						}else{
							// 番号
							m = str.substr(p).match(re_number);
							if(m){
								p += m[0].length;
								var id = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
								if(id < 1) id = 1;
								if(id > 0x7fffffff) id = 0x7fffffff;
								numbers.addNumber(id);
							}
						}

						if(m){
							// カンマ
							if(RegExp.rightContext.search(",") == 0){
								p += 1;
								continue;
							}
						}
						break;
					}
				}
				return numbers;
			};

			// --------------------------------------------------------------------------------
			// レスアンカー拡張
			// --------------------------------------------------------------------------------
			work.extendResponseAnchor = function (target){
				if(BbsControlResponseAnchorExist(target))	return;

				var re_simple = new RegExp("^(>>|<<|>)[-,0-9０-９]+$","i");
				var re_detail = new RegExp("(>>|<<|＞＞|＜＜|>|＞|》|≫|&gt;&gt;)(([0-9０-９]+[-][0-9０-９]+|[0-9０-９]+),)*([0-9０-９]+[-][0-9０-９]+|[0-9０-９]+)","i");
				var re_range = new RegExp("([0-9０-９]+)[-]([0-9０-９]+)","i");
				var re_number = new RegExp("([0-9０-９]+)","i");

				var i;
				var nodes = ElementGetElementsByTagName(target,"a");
				var num = nodes.length;
				for(i=num-1;i>=0;i--){
					var node = nodes[i];
					var m = ElementGetTextContent(node).match(re_simple);
					if(m){
						var text_node = DocumentCreateText(m[0]);
						DomNode_InsertBefore(node,text_node);
						DomNodeRemove(node);
					}
				}

				// テキストノードを統合
				target.normalize();

				var p;
				var n;
				var q;
				var ignore_dictionary = {"A":1,"SCRIPT":1};
				var queue = new Object();
				q = {p:queue,n:queue,node:target};
				queue.p = q;
				queue.n = q;

				while(queue.n != queue){
					q = queue.n;
					p = q.p;
					n = q.n;
					p.n = n;
					n.p = p;
					var node = q.node;
					switch(node.nodeType){
					case 1:
						var i;
						var nodes = node.childNodes;
						var num = nodes.length;
						for(i=0;i<num;i++){
							n = queue;
							p = n.p;
							q = {p:p,n:n,node:nodes[i]};
							p.n = q;
							n.p = q;
						}
						break;
					case 3:
						while(node){
							var m = DomNodeGetNodeValue(node).match(re_detail);
							if(!m)	break;

							// 元のテキストノード
							DomNodeSetNodeValue(node,RegExp.leftContext);

							// BbsControlName を生成
							var element = DocumentCreateElement("a");
							ElementSetTextContent(element,m[0]);
							DomNode_InsertAfter(node,element);

							// 直後テキスト
							node = DocumentCreateText(RegExp.rightContext);
							DomNode_InsertAfter(element,node);

							var query = "";
							m = ElementGetTextContent(element).match(re_range);
							if(m){
								var min = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
								var max = parseInt(StringConvertFromNumericFullToNumericHalf(m[2]));
								if(min < 1) min = 1;
								if(max < 1) max = 1;
								if(min > 0x7fffffff) min = 0x7fffffff;
								if(max > 0x7fffffff) max = 0x7fffffff;
								if(max < min){
									var tmp = min;
									min = max;
									max = tmp;
								}
								query = min;
							}else{
								// 番号
								m = ElementGetTextContent(element).match(re_number);
								if(m){
									query = parseInt(StringConvertFromNumericFullToNumericHalf(m[0]));
									if(query < 1) query = 1;
									if(query > 0x7fffffff) query = 0x7fffffff;
								}

							}
							element.href = work.base_url + (Math.floor(query / 30) * 30 + 1) + "-#" + query;
						}
					}
				}
			};

			// --------------------------------------------------------------------------------
			// 継ぎ足し読み込み
			// --------------------------------------------------------------------------------
			function readMore(){

				// ローダーオブジェクトを作成
				var loader = new Loader();

				// 成功
				loader.onload = function(str){
					var re_number = new RegExp("<a name=\"([0-9]+)\"","i");

					var p = 0;
					var n = str.length;
					function f(){
						try{
							if(p >= n) throw 0;
							p = str.indexOf("<dt class=\"reshead\">",p);
							if(p < 0) throw 0;
							var e = str.indexOf("</dd>",p);
							if(e >= 0) e += 5;
							var s = str.substring(p,e);
							var m = s.match(re_number);
							if(m){
								var id = parseInt(m[1]);
								if(last_id < id){
									var response = bbs_dictionary.getResponse(id);
									response.clearAnalyzed();
									response.clearOriginalElements();
									response.clearFollowing();

									var nodes = StringHtmlCreateDomNodesSafe(s);
									var j;
									var node_num = nodes.length;
									for(j=0;j<node_num;j++){
										element_parent.appendChild(nodes[j]);
									}
									last_id = id;
									resource_url_more = base_url + (last_id) + "-";
								}
							}

							if(p < e){
								p = e;
								execute_queue.attachFirst(f,null);
								return;
							}
						}catch(e){
						}

						var reload = false;
						(function(){
							if(((last_id + 1) % load_dose) != load_offset){
								return;
							}
							var p = Math.floor(load_more_id / load_dose);
							var n = Math.floor(last_id / load_dose);
							if(p >= n){
								return;
							}
							var p = Math.floor(load_more_id / load_separate);
							var n = Math.floor(last_id / load_separate);
							if(p < n){
								return;
							}

							reload = true;
						})();

						var next_id = Math.floor(last_id / load_dose) * load_dose + load_offset;
						resource_url_more = base_url + next_id + "-";

						if(reload){
							readMore();
						}else{
							read_more_button.init();
						}
					}

					load_more_id = last_id;
					execute_queue.attachFirst(f,null);
				};

				// 失敗
				loader.onerror = function(){
					read_more_button.init();
				};

				// テキストの読み込み
				loader.setMethod("GET");
				loader.setURL(resource_url_more);
				loader.loadText();
			}

			// --------------------------------------------------------------------------------
			// レスポンス親要素
			// --------------------------------------------------------------------------------
			var i;
			var nodes = ElementGetElementsByTagName(document.body,"dl");
			var num = nodes.length;
			for(i=0;i<num;i++){
				element_parent = nodes[i];
				break;
			}

			if(!element_parent) return false;

			// --------------------------------------------------------------------------------
			// 最後尾 ID
			// --------------------------------------------------------------------------------
			var nodes = ElementGetElementsByTagName(element_parent,"dt");
			var i;
			var node_num = nodes.length;
			for(i=0;i<node_num;i++){
				var node = nodes[i];
				var m = ElementGetTextContent(node).match(new RegExp("([0-9]+)[ ]","i"));
				if(m){
					first_id = parseInt(m[1]);
					dictionary_id[first_id] = true;
					if(first_id != 1){
						break;
					}
				}
			}
			for(i=node_num-1;i>=0;i--){
				var node = nodes[i];
				var m = ElementGetTextContent(node).match(new RegExp("([0-9]+)[ ]","i"));
				if(m){
					last_id = parseInt(m[1]);
					dictionary_id[last_id] = true;
					break;
				}
			}

			// --------------------------------------------------------------------------------
			// アクセス先 URL
			// --------------------------------------------------------------------------------
			var next_id = Math.floor(last_id / load_dose) * load_dose + load_offset;
			resource_url_shadow = base_url + "1-";
			resource_url_more = base_url + next_id + "-";

			// --------------------------------------------------------------------------------
			// BbsControlReadMoreButton 作成
			// --------------------------------------------------------------------------------
			read_more_button = new BbsControlReadMoreButton();
			read_more_button.setWaitTime(2 * 1000);
			read_more_button.onclick = readMore;
			DomNode_InsertAfter(element_parent,read_more_button.getElement());

			// --------------------------------------------------------------------------------
			// シャドウロード
			// --------------------------------------------------------------------------------
			function loadShadow(){
				var load_shadow_last_id = load_shadow_id;
				
				// ローダーオブジェクトを作成
				var loader = new Loader();

				// 成功
				loader.onload = function(str){
					var re_number = new RegExp("<a name=\"([0-9]+)\"","i");
					var re_id = new RegExp("ID:[ ]([a-zA-Z0-9+/.]{8,10})","i");
					var re_name = new RegExp("(◆[a-zA-Z0-9+/.]{10,12})","i");

					var p = 0;
					var n = str.length;
					function f(){
						try{
							if(p >= n) throw 0;
							p = str.indexOf("<dt class=\"reshead\">",p);
							if(p < 0) throw 0;
							var e = str.indexOf("</dd>",p);
							if(e >= 0) e += 5;
							var s = str.substring(p,e);
							var m = s.match(re_number);
							if(m){
								var id = load_shadow_last_id = parseInt(m[1]);
								if((first_id <= id) && (id <= last_id)){
								}else if(dictionary_id[id]){
								}else{
									// ナンバーからレスポンスオブジェクトを取得
									var response = bbs_dictionary.getResponse(id);
									if(!(response.getAnalyzed())){
										var nodes = StringHtmlCreateDomNodesSafe(s);
										var dt = nodes[0];
										var dd = nodes[2];

										try{
											if(dt.tagName != "DT")	throw 0;
											if(dd.tagName != "DD")	throw 0;
										}catch(e){
											throw 0;
										}

										var dt_text = ElementGetTextContent(dt);

										// レスアンカー拡張
										work.extendResponseAnchor(dd);

										// IDの取得
										if(dt_text.match(re_id)){
											response.setId(RegExp.$1);
										}

										// 名前の取得
										if(dt_text.match(re_name)){
											response.setName(RegExp.$1);
										}

										// フォロー解析
										var dictionary = new Object();
										(function(){
											var nodes = ElementGetElementsByTagName(dd,"a");
											var i;
											var num = nodes.length;
											for(i=0;i<num;i++){
												var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(nodes[i]));
												numbers.getNumbers(function(n){
													if(!dictionary[n]){
														var following = bbs_dictionary.getResponse(n);
														following.addFollower(response);
														dictionary[n] = true;
													}
												});
											}
										})();

										// オリジナルエレメントをセット
										if(dt)	response.addOriginalElements("dt",dt);
										if(dd)	response.addOriginalElements("dd",dd);

										// 消去時に実行されるイベント
										response.onerase = function(){};

										response.setAnalyzed();
									}
								}
							}

							if(p < e){
								p = e;
								execute_queue.attachFirst(f,null);
								return;
							}
						}catch(e){
						}

						var reload = false;
						(function(){
							if(((load_shadow_last_id + 1) % load_dose) != load_offset){
								return;
							}
							var p = Math.floor(load_shadow_id / load_dose);
							var n = Math.floor(load_shadow_last_id / load_dose);
							if(p >= n){
								return;
							}
							if(load_shadow_last_id > first_id){
								return;
							}

							reload = true;
						})();

						var next_id = Math.floor(load_shadow_last_id / load_dose) * load_dose + load_offset;
						resource_url_shadow = base_url + next_id + "-";

						if(reload){
							load_shadow_id = load_shadow_last_id;
							loadShadow();
						}
					}
					execute_queue.attachFirst(f,null);
				};

				// 失敗
				loader.onerror = function(){
				};

				// テキストの読み込み
				loader.setMethod("GET");
				loader.setURL(resource_url_shadow);
				loader.loadText();
			}
			loadShadow();

			response({result:true});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		response({result:false});
		return true;
	}.toString() +
"\n]";

					preset.script_callback = 
"[\n\t" + 
	function(info,response){
		var element = info.element;
		var work = info.work;

		// --------------------------------------------------------------------------------
		// レスポンスダイアログを登録
		// --------------------------------------------------------------------------------
		function attachBbsResponseDialog(response,node,parent_dialog,type){

			// --------------------------------------------------------------------------------
			// レスアンカー
			// --------------------------------------------------------------------------------
			function forResponseAnchor(target){
				if(BbsControlResponseAnchorExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlResponseAnchor を生成
				// --------------------------------------------------------------------------------
				(function(){
					var i;
					var nodes = ElementGetElementsByTagName(target,"a");
					var num = nodes.length;
					for(i=0;i<num;i++){
						var node = nodes[i];
						var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(node));
						if(numbers.getCount()){
							var control_res_anchor = new BbsControlResponseAnchor(node,false);
							control_res_anchor.setResponseAnchorNumbers(numbers);
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlResponseAnchor を検索
				// --------------------------------------------------------------------------------
				BbsControlResponseAnchorSearch(target,function(control_res_anchor){

					var element_res_anchor = control_res_anchor.getElement();
					var numbers = control_res_anchor.getResponseAnchorNumbers();

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_res_anchor);
					response_dialog.oncreate = function(_window,callback){

						var dl = DocumentCreateElement("dl");
						dl.style.margin = "0px";
						_window.appendChild(dl);

						var created = false;
						var i = 0;
						var number_list = numbers.getNumberList();
						var num = number_list.length;
						if(!num) return false;

						function f(){
							var following = bbs_dictionary.getResponse(number_list[i]);
							var clone = following.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){
								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									dl.appendChild(obj.element);
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(following,param,response_dialog,"response");

								created = true;
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:created});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// ID
			// --------------------------------------------------------------------------------
			function forId(target){
				if(BbsControlIdExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlId を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"A":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}

							break;
						case 3:
							while(node){

								var m = DomNodeGetNodeValue(node).match(new RegExp("ID:[ ]([a-zA-Z0-9+/.]{8,10})","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(node,RegExp.leftContext);

								// BbsControlId を生成
								var control_id = new BbsControlId(null,false);
								control_id.setId(m[1]);
								var element_id = control_id.getElement();
								ElementSetTextContent(element_id,m[0]);
								DomNode_InsertAfter(node,element_id);

								// 直後テキスト
								node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(element_id,node);
							}
							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlId を検索
				// --------------------------------------------------------------------------------
				BbsControlIdSearch(target,function(control_id){

					control_id.setResponse(response);

					var id = control_id.getId();
					var element_id = control_id.getElement();
					var textnode_id = DocumentCreateText("");

					element_id.appendChild(textnode_id);

					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_id.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_id,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_id,"");
						}

						var style = element_id.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","small");
						}
					};
					control_id.update();

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "id"){
						if(response.getId() == id)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_id);
					response_dialog.oncreate = function(_window,callback){

						var dl = DocumentCreateElement("dl");
						dl.style.margin = "0px";
						_window.appendChild(dl);

						var responses = bbs_dictionary.getResponsesFromId(id);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_id = responses[i];
							var clone = response_id.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									dl.appendChild(obj.element);
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_id,param,response_dialog,"id");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// トリップ
			// --------------------------------------------------------------------------------
			function forName(target){
				if(BbsControlNameExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlName を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							while(node){

								// 本文
								var m = DomNodeGetNodeValue(node).match(new RegExp("(◆[a-zA-Z0-9+/.]{10,12})","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(node,RegExp.leftContext);

								// BbsControlName を生成
								var control_name = new BbsControlName(null,false);
								control_name.setName(m[0]);
								var element_name = control_name.getElement();
								ElementSetTextContent(element_name,m[0]);
								DomNode_InsertAfter(node,element_name);

								// 直後テキスト
								node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(element_name,node);
							}
							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlName を検索
				// --------------------------------------------------------------------------------
				BbsControlNameSearch(target,function(control_name){

					control_name.setResponse(response);

					var name = control_name.getName();
					var element_name = control_name.getElement();
					var textnode_name = DocumentCreateText("");


					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_name.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_name,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_name,"");
						}

						var style = element_name.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","small");
						}
					};
					control_name.update();
					element_name.appendChild(textnode_name);

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "name"){
						if(response.getName() == name)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_name);
					response_dialog.oncreate = function(_window,callback){

						var dl = DocumentCreateElement("dl");
						dl.style.margin = "0px";
						_window.appendChild(dl);

						var responses = bbs_dictionary.getResponsesFromName(name);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_name = responses[i];
							var clone = response_name.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									dl.appendChild(obj.element);
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_name,param,response_dialog,"name");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// フォロワー
			// --------------------------------------------------------------------------------
			function forFollower(target){
				if(BbsControlFollowerExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlFollower を生成
				// --------------------------------------------------------------------------------
				var control_follower = new BbsControlFollower(null,true);
				control_follower.setResponse(response);

				var element_follower = control_follower.getElement();
				var textnode_follower = DocumentCreateText("");

				element_follower.appendChild(textnode_follower);

				// --------------------------------------------------------------------------------
				// 変化があったときに実行されるイベント
				// --------------------------------------------------------------------------------
				control_follower.onchange = function(count){
					if(count){
						textnode_follower.nodeValue = " follower(" + count + ")";
					}else{
						textnode_follower.nodeValue = "";
					}

					var style = element_follower.style;
					if(count >= 3){
						StyleDeclarationSetProperty(style,"color","#e80000");
						StyleDeclarationRemoveProperty(style,"font-size");

					}else{
						StyleDeclarationSetProperty(style,"color","#888");
						StyleDeclarationSetProperty(style,"font-size","small");
					}
					if(count){
						StyleDeclarationSetProperty(style,"margin","0px 4px 0px 0px");
					}else{
						StyleDeclarationRemoveProperty(style,"margin");
					}
				};
				control_follower.update();
				var nodes = ElementGetElementsByTagName(target,"br");
				if(nodes.length){
					DomNode_InsertBefore(nodes[0],element_follower);
				}else{
					target.appendChild(element_follower);
				}

				// --------------------------------------------------------------------------------
				// ポップアップ化
				// --------------------------------------------------------------------------------
				// ダイアログを作成
				var response_dialog = new BbsResponseDialog();
				if(parent_dialog)	parent_dialog.attachChild(response_dialog);
				response_dialog.setElementParent(node.parent);
				response_dialog.setElementHitArea(element_follower);
				response_dialog.oncreate = function(_window,callback){

					var dl = DocumentCreateElement("dl");
					dl.style.margin = "0px";
					_window.appendChild(dl);

					var ary = response.getFollower();
					var i = 0;
					var num = ary.length;
					if(num <= 0) return false;

					function f(){
						var follower = bbs_dictionary.getResponse(ary[i].getNumber());
						var clone = follower.getCloneElements();

						var j;
						var clone_num = clone.length;
						if(clone_num){

							var param = new Object();
							param.parent = node.parent;
							for(j=0;j<clone_num;j++){
								var obj = clone[j];
								param[obj.name] = obj.element;
								dl.appendChild(obj.element);
							}

							// レスポンスダイアログを登録
							attachBbsResponseDialog(follower,param,response_dialog,"response");
						}

						i += 1;
						if(i < num){
							execute_queue.attachFirst(f,null);
						}else{
							callback({result:true});
						}
					}
					execute_queue.attachFirst(f,null);
				};
			}

			if(node.dt){
				forResponseAnchor(node.dt);
				forId(node.dt);
				forName(node.dt);
				forFollower(node.dt);
			}
			if(node.dd){
				forResponseAnchor(node.dd);
				forId(node.dd);
				forName(node.dd);
			}
		}

		// --------------------------------------------------------------------------------
		// エレメントを解析
		// --------------------------------------------------------------------------------
		var useful = (function(){
			var dt = element;
			var dd;

			try{
				if(dt.tagName != "DT")	return false;
			}catch(e){
				return false;
			}

			dd = dt.nextSibling;
			try{
				dd = dd.nextSibling;
				if(dd.tagName != "DD")	return false;
			}catch(e){
				return false;
			}

			try{
				var dl = dt.parentNode;
				if(dl.tagName != "DL")	return false;

				var div = dl.parentNode;
				if(div.tagName != "DIV")	return false;
				if(div.className != "content")	return false;
			}catch(e){
				return false;
			}

			// document に未登録
			if(!DomNodeGetAttachedDocument(dt))	return false;

			// --------------------------------------------------------------------------------
			// レスアンカー拡張
			// --------------------------------------------------------------------------------
			work.extendResponseAnchor(dd);

			// --------------------------------------------------------------------------------
			// クリーンアップ
			// --------------------------------------------------------------------------------
			(function(){
				function cleanup(target){
					BbsControlSearchTrash(target,function(element){
						var node = element.firstChild;
						if(!node)	return null;
						if(node.nodeType != 3)	return null;

						// ID
						var m = node.nodeValue.match(new RegExp("^ID:[ ]([a-zA-Z0-9+/.]{8,10})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);
							return null;
						}

						// トリップ
						var m = node.nodeValue.match(new RegExp("^(◆[a-zA-Z0-9+/.]{10,12})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);
							return null;
						}

						return null;
					});
				}

				if(dt){
					cleanup(dt);
				}
				if(dd){
					cleanup(dd);
				}
			})();

			// ナンバーを取得
			var dt_text = ElementGetTextContent(dt);
			if(!(dt_text.match(new RegExp("([0-9]+)[ ]","i"))))	return false;

			// ナンバーからレスポンスオブジェクトを取得
			var response = bbs_dictionary.getResponse(parseInt(RegExp.$1));

			// レスポンス解析
			if(!response.getAnalyzed()){

				// IDの取得
				if(dt_text.match(new RegExp("ID:[ ]([a-zA-Z0-9+/.]{8,10})","i"))){
					response.setId(RegExp.$1);
				}

				// 名前の取得
				if(dt_text.match(new RegExp("(◆[a-zA-Z0-9+/.]{10,12})","i"))){
					response.setName(RegExp.$1);
				}

				// フォロー解析
				var dictionary = new Object();
				(function(){
					var nodes = ElementGetElementsByTagName(dd,"a");
					var i;
					var num = nodes.length;
					for(i=0;i<num;i++){
						var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(nodes[i]));
						numbers.getNumbers(function(n){
							if(!dictionary[n]){
								var following = bbs_dictionary.getResponse(n);
								following.addFollower(response);
								dictionary[n] = true;
							}
						});
					}
				})();

				// オリジナルエレメントをセット
				if(dt)	response.addOriginalElements("dt",dt);
				if(dd)	response.addOriginalElements("dd",dd);

				// 消去時に実行されるイベント
				response.onerase = function(){
					var original = response.getOriginalElements();

					// オリジナルエレメントを外す
					var i;
					var num = original.length;
					for(i=0;i<num;i++){
						var revise_scroll = new DocumentReviseScroll();
						var node = original[i].element;
						revise_scroll.executeRemoveElementBefore(node);
						DomNodeRemove(node);
						revise_scroll.executeRemoveElementAfter(node);
					}
				};

				response.setAnalyzed();
			}

			// レスポンスダイアログを登録（ルート）
			attachBbsResponseDialog(
				response,
				{
					dt:dt,
					dd:dd,
					parent:dt.parentNode
				},
				null,
				null
			);

			return true;
		})();

		response({useful:useful});
		return true;
	}.toString() +
"\n]";

				// chaika
				var obj = addPreset(proj.expand_bbs,"chaika","atchs");
				obj.preset = {
					name:{
						standard:"chaika",
						locales:{
							ja:"chaika",
							en:"chaika"
						}
					},
					enable:true,
					filter:[
						{
							pattern:"^http://127\\.0\\.0\\.1:[0-9]+/thread/http://[^.]+\\.2ch\\.net/test/read\\.cgi/[^/]+/[0-9]+",
							flags:{i:true,g:false}
						},{
							pattern:"^http://127\\.0\\.0\\.1:[0-9]+/thread/http://[^.]+\\.bbspink\\.com/test/read\\.cgi/[^/]+/[0-9]+",
							flags:{i:true,g:false}
						},{
							pattern:"^http://127\\.0\\.0\\.1:[0-9]+/thread/http://jbbs\\.livedoor\\.jp/bbs/read.cgi/[^/]+/[0-9]+/[0-9]+",
							flags:{i:true,g:false}
						}
					],
					script_initialize:"[\n\t" + 
	function(info,response){
		var work = info.work;

		// --------------------------------------------------------------------------------
		// 基本URL抽出
		// --------------------------------------------------------------------------------
		var url = document.URL;
		var bbs_list = [
			{url:"(http://[^.]+\\.2ch\\.net/test/read\\.cgi/[^/]+/[0-9]+)",replace:"$1/",name:"2ch"},
			{url:"(http://[^.]+\\.bbspink\\.com/test/read\\.cgi/[^/]+/[0-9]+)",replace:"$1/",name:"pink"},
			{url:"(http://jbbs\\.livedoor\\.jp/bbs/read.cgi/[^/]+/[0-9]+/[0-9]+)",replace:"$1/",name:"shitaraba"}
		];

		var i;
		var num = bbs_list.length;
		for(i=0;i<num;i++){
			var bbs = bbs_list[i];
			var re = new RegExp(bbs.url,"i");
			var m = url.match(re);
			if(m){
				work.base_url = m[1].replace(re,bbs.replace);
				work.bbs_name = bbs.name;
				break;
			}
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		var work = info.work;

		if(work.bbs_name){
			var first_id = 1;
			var last_id = 1;
			var dictionary_id = new Array();
			var load_shadow_func = null;
			var load_more_func = null;
			var element_parent = null;
			var element_last = null;
			var element_footer = null;
			var read_more_button = null;
			var element_form = null;
			var base_url = work.base_url;
			var resource_url_shadow;
			var resource_url_more;
			var generate_html_func = null;

			// --------------------------------------------------------------------------------
			// 文字列からレスポンス番号を取得
			// --------------------------------------------------------------------------------
			work.createResponseAnchorNumbers = function (str){
				var numbers = new ResponseAnchorNumbers();

				var re_search = new RegExp("^(>>|<<|＞＞|＜＜|>|＞|》|≫|&gt;&gt;)([0-9０-９]+)","i");
				var re_range = new RegExp("^([0-9０-９]+)[-]([0-9０-９]+)","i");
				var re_number = new RegExp("^([0-9０-９]+)","i");

				var m = str.match(re_search);
				if(m){
					var p = m[1].length;
					while(true){
						// 番号-番号
						m = str.substr(p).match(re_range);
						if(m){
							var id0 = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
							var id1 = parseInt(StringConvertFromNumericFullToNumericHalf(m[2]));
							if(id0 < 1) id0 = 1;
							if(id1 < 1) id1 = 1;
							if(id0 > 10000) id0 = 10000;
							if(id1 > 10000) id1 = 10000;
							p += m[0].length;
							numbers.addNumbers(id0,id1);
						}else{
							// 番号
							m = str.substr(p).match(re_number);
							if(m){
								p += m[0].length;
								var id = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
								if(id < 1) id = 1;
								if(id > 0x7fffffff) id = 0x7fffffff;
								numbers.addNumber(id);
							}
						}

						if(m){
							// カンマ
							if(RegExp.rightContext.search(",") == 0){
								p += 1;
								continue;
							}
						}
						break;
					}
				}
				return numbers;
			};

			// --------------------------------------------------------------------------------
			// レスアンカー拡張
			// --------------------------------------------------------------------------------
			work.extendResponseAnchor = function (target){
				if(BbsControlResponseAnchorExist(target))	return;

				var re_simple = new RegExp("^(>>|<<|>)[-,0-9０-９]+$","i");
				var re_detail = new RegExp("(>>|<<|＞＞|＜＜|>|＞|》|≫|&gt;&gt;)(([0-9０-９]+[-][0-9０-９]+|[0-9０-９]+),)*([0-9０-９]+[-][0-9０-９]+|[0-9０-９]+)","i");
				var re_range = new RegExp("([0-9０-９]+)[-]([0-9０-９]+)","i");
				var re_number = new RegExp("([0-9０-９]+)","i");

				var i;
				var nodes = ElementGetElementsByTagName(target,"a");
				var num = nodes.length;
				for(i=num-1;i>=0;i--){
					var node = nodes[i];
					var m = ElementGetTextContent(node).match(re_simple);
					if(m){
						var text_node = DocumentCreateText(m[0]);
						DomNode_InsertBefore(node,text_node);
						DomNodeRemove(node);
					}
				}

				// テキストノードを統合
				target.normalize();

				var p;
				var n;
				var q;
				var ignore_dictionary = {"A":1,"SCRIPT":1};
				var queue = new Object();
				q = {p:queue,n:queue,node:target};
				queue.p = q;
				queue.n = q;

				while(queue.n != queue){
					q = queue.n;
					p = q.p;
					n = q.n;
					p.n = n;
					n.p = p;
					var node = q.node;
					switch(node.nodeType){
					case 1:
						var i;
						var nodes = node.childNodes;
						var num = nodes.length;
						for(i=0;i<num;i++){
							n = queue;
							p = n.p;
							q = {p:p,n:n,node:nodes[i]};
							p.n = q;
							n.p = q;
						}
						break;
					case 3:
						while(node){
							var m = DomNodeGetNodeValue(node).match(re_detail);
							if(!m)	break;

							// 元のテキストノード
							DomNodeSetNodeValue(node,RegExp.leftContext);

							// BbsControlName を生成
							var element = DocumentCreateElement("a");
							ElementSetTextContent(element,m[0]);
							DomNode_InsertAfter(node,element);

							// 直後テキスト
							node = DocumentCreateText(RegExp.rightContext);
							DomNode_InsertAfter(element,node);

							var query = "";
							m = ElementGetTextContent(element).match(re_range);
							if(m){
								var min = parseInt(StringConvertFromNumericFullToNumericHalf(m[1]));
								var max = parseInt(StringConvertFromNumericFullToNumericHalf(m[2]));
								if(min < 1) min = 1;
								if(max < 1) max = 1;
								if(min > 10000) min = 10000;
								if(max > 10000) max = 10000;
								if(max < min){
									var tmp = min;
									min = max;
									max = tmp;
								}
								query = min + "-" + max;
							}else{
								// 番号
								m = ElementGetTextContent(element).match(re_number);
								if(m){
									query = parseInt(StringConvertFromNumericFullToNumericHalf(m[0]));
									if(query < 1) query = 1;
									if(query > 0x7fffffff) query = 0x7fffffff;
								}

							}
							element.href = work.base_url + query;
						}
					}
				}
			};

			// --------------------------------------------------------------------------------
			// HTML 文書をシャドウ読み込み
			// --------------------------------------------------------------------------------
			function loadShadowFromHTML(str){
				var re_search;
				var re_number;
				var re_name = new RegExp("<b>(.*?)</b>","i");
				var re_mail = new RegExp("<a href=\"mailto:(.*)\">","i");
				var re_date;
				var re_id;
				var re_be;
				var re_gen_id = new RegExp("ID:([-a-zA-Z0-9+/.]+)[●!]{0,2}","i");
				var re_gen_name = new RegExp("(◆[a-zA-Z0-9+/.]{10,12})","i");
				switch(work.bbs_name){
				case "2ch":
				case "pink":
					re_search = new RegExp("([0-9]+) ：(.*?)<dd> (.*)","i");
					re_number = new RegExp("([0-9]+)","i");
					re_date = new RegExp("([0-9]+/[0-9]+/[0-9]+.* [0-9]+:[0-9]+:[0-9]+.*?)($| ID:|<)","i");
					re_id = new RegExp("(ID):([^ ]+)","i");
					re_be = new RegExp("<a href=\"javascript:be\\(([0-9]+)\\);\">[?](.*?)</a>","i");
					break;
				case "shitaraba":
					re_search = new RegExp("<a href=\".*?\">([0-9]+)</a> ：(.*?)<dd> (.*)","i");
					re_number = new RegExp("<a href=\".*?\">([0-9]+)</a> ：","i");
					re_date = new RegExp("([0-9]+/[0-9]+/[0-9]+.* [0-9]+:[0-9]+:[0-9]+.*?)($| ID:| HOST:|<)","i");
					re_id = new RegExp("(ID|HOST):([^ ]+)","i");
					break;
				}

				var p = 0;
				var n = str.length;
				function f(){
					if(p >= n) return;
					p = str.indexOf("<dt>",p);
					if(p < 0) return;
					var e = str.indexOf("\n",p);
					var s = str.substring(p,e);
					var m = s.match(re_number);
					if(m){
						var id = parseInt(m[1]);
						if((first_id <= id) && (id <= last_id)){
						}else if(dictionary_id[id]){
						}else{
							// ナンバーからレスポンスオブジェクトを取得
							var response = bbs_dictionary.getResponse(id);
							if(!(response.getAnalyzed())){
								var m = s.match(re_search);
								if(m){
									var obj = new Object();
									obj.number = id;
									obj.name = "";
									obj.mail = "";
									obj.date = "";
									obj.id = "";
									obj.be = "";
									obj.message = m[3];
									if(m[2].match(re_date)){
										obj.date = RegExp.$1;
									}
									if(m[2].match(re_name)){
										obj.name = RegExp.$1;
									}
									if(m[2].match(re_id)){
										obj.id = RegExp.$2;
									}
									if(m[2].match(re_mail)){
										obj.mail = RegExp.$1;
									}
									if(re_be){
										if(m[2].match(re_be)){
											obj.be = RegExp.$1 + "-" + RegExp.$2;
										}
									}

									var nodes = StringHtmlCreateDomNodesSafe(generate_html_func(obj));
									var dt = ElementGetElementsByTagName(nodes[0],"dt")[0];
									var dd = ElementGetElementsByTagName(nodes[0],"dd")[0];

									try{
										if(dt.tagName != "DT")	return;
										if(dd.tagName != "DD")	return;
									}catch(e){
										return;
									}

									var dt_text = ElementGetTextContent(dt);

									// レスアンカー拡張
									work.extendResponseAnchor(dd);

									// IDの取得
									if(dt_text.match(re_gen_id)){
										response.setId(RegExp.$1);
									}

									// 名前の取得
									if(dt_text.match(re_gen_name)){
										response.setName(RegExp.$1);
									}

									// ホスト名の取得
									(function(){
										var p;
										var n;
										var q;
										var ignore_dictionary = {"B":1,"SCRIPT":1};
										var queue = new Object();
										q = {p:queue,n:queue,node:dt};
										queue.p = q;
										queue.n = q;

										while(queue.n != queue){
											q = queue.n;
											p = q.p;
											n = q.n;
											p.n = n;
											n.p = p;
											var node = q.node;
											switch(node.nodeType){
											case 1:
												if(!(ignore_dictionary[node.tagName])){
													var i;
													var nodes = node.childNodes;
													var num = nodes.length;
													for(i=0;i<num;i++){
														n = queue;
														p = n.p;
														q = {p:p,n:n,node:nodes[i]};
														p.n = q;
														n.p = q;
													}
												}
												break;
											case 3:
												var m = DomNodeGetNodeValue(node).match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
												if(m){
													response.setHost(m[2]);
													return;
												}
												var m = DomNodeGetNodeValue(node).match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})(|\\n) \\]","i"));
												if(m){
													response.setHost(m[2]);
													return;
												}
												var m = DomNodeGetNodeValue(node).match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
												if(m){
													response.setHost(m[2]);
													return;
												}
												break;
											}
										}
									})();

									// フォロー解析
									var dictionary = new Object();
									(function(){
										var nodes = ElementGetElementsByTagName(dd,"a");
										var i;
										var num = nodes.length;
										for(i=0;i<num;i++){
											var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(nodes[i]));
											numbers.getNumbers(function(n){
												if(!dictionary[n]){
													var following = bbs_dictionary.getResponse(n);
													following.addFollower(response);
													dictionary[n] = true;
												}
											});
										}
									})();

									// オリジナルエレメントをセット
									if(dt)	response.addOriginalElements("dt",dt);
									if(dd)	response.addOriginalElements("dd",dd);

									// 消去時に実行されるイベント
									response.onerase = function(){};

									response.setAnalyzed();
								}
							}

						}
					}

					if(p < e){
						p = e + 1;
						execute_queue.attachFirst(f,null);
					}
				}
				execute_queue.attachFirst(f,null);
			}

			// --------------------------------------------------------------------------------
			// HTML 文書を継ぎ足し読み込み
			// --------------------------------------------------------------------------------
			function loadMoreFromHTML(str){
				var re_search;
				var re_number;
				var re_name = new RegExp("<b>(.*?)</b>","i");
				var re_mail = new RegExp("<a href=\"mailto:(.*)\">","i");
				var re_date;
				var re_id;
				var re_be;
				switch(work.bbs_name){
				case "2ch":
				case "pink":
					re_search = new RegExp("([0-9]+) ：(.*?)<dd> (.*)","i");
					re_number = new RegExp("([0-9]+)","i");
					re_date = new RegExp("([0-9]+/[0-9]+/[0-9]+.* [0-9]+:[0-9]+:[0-9]+.*?)($| ID:|<)","i");
					re_id = new RegExp("(ID):([^ ]+)","i");
					re_be = new RegExp("<a href=\"javascript:be\\(([0-9]+)\\);\">[?](.*?)</a>","i");
					break;
				case "shitaraba":
					re_search = new RegExp("<a href=\".*?\">([0-9]+)</a> ：(.*?)<dd> (.*)","i");
					re_number = new RegExp("<a href=\".*?\">([0-9]+)</a> ：","i");
					re_date = new RegExp("([0-9]+/[0-9]+/[0-9]+.* [0-9]+:[0-9]+:[0-9]+.*?)($| ID:| HOST:|<)","i");
					re_id = new RegExp("(ID|HOST):([^ ]+)","i");
					break;
				}

				var p = 0;
				var n = str.length;
				function f(){
					try{
						if(p >= n) throw 0;
						p = str.indexOf("<dt>",p);
						if(p < 0) throw 0;
						var e = str.indexOf("\n",p);
						var s = str.substring(p,e);
						var m = s.match(re_number);
						if(m){
							var id = parseInt(m[1]);
							if(last_id < id){
								var m = s.match(re_search);
								if(m){
									var obj = new Object();
									obj.number = id;
									obj.name = "";
									obj.mail = "";
									obj.date = "";
									obj.id = "";
									obj.be = "";
									obj.message = m[3];
									if(m[2].match(re_date)){
										obj.date = RegExp.$1;
									}
									if(m[2].match(re_name)){
										obj.name = RegExp.$1;
									}
									if(m[2].match(re_id)){
										obj.id = RegExp.$2;
									}
									if(m[2].match(re_mail)){
										obj.mail = RegExp.$1;
									}
									if(re_be){
										if(m[2].match(re_be)){
											obj.be = RegExp.$1 + "-" + RegExp.$2;
										}
									}

									var response = bbs_dictionary.getResponse(id);
									response.clearAnalyzed();
									response.clearOriginalElements();
									response.clearFollowing();

									var nodes = StringHtmlCreateDomNodesSafe(generate_html_func(obj));
									var j;
									var node_num = nodes.length;
									if(element_last){
										for(j=0;j<node_num;j++){
											DomNode_InsertAfter(element_last,nodes[j]);
											element_last = nodes[j];
										}
									}
									if(element_parent){
										for(j=0;j<node_num;j++){
											element_parent.appendChild(nodes[j]);
										}
									}
									last_id = id;
									resource_url_more = base_url + (last_id) + "-";
								}
							}
						}

						if(p < e){
							p = e + 1;
							execute_queue.attachFirst(f,null);
							return;
						}
					}catch(e){
					}
					read_more_button.init();
				}
				execute_queue.attachFirst(f,null);
			}

			// --------------------------------------------------------------------------------
			// DAT 文書をシャドウ読み込み
			// --------------------------------------------------------------------------------
			function loadShadowFromDAT(str){
				var re_search = new RegExp("(.*?)<>(.*?)<>(.*?)<> (.*?) <>","i");
				var re_date = new RegExp("([0-9]+/[0-9]+/[0-9]+.* [0-9]+:[0-9]+:[0-9]+.*?)($| ID:| BE:)","i");
				var re_id = new RegExp("ID:([^ ]+)","i");
				var re_be = new RegExp("BE:([^ ]+)","i");
				var re_icon = new RegExp("^sssp://img.2ch.net/ico/(.*?)( <br> .*)$","i");
				var re_gen_id = new RegExp("ID:([-a-zA-Z0-9+/.]+)[●!]{0,2}","i");
				var re_gen_name = new RegExp("(◆[a-zA-Z0-9+/.]{10,12})","i");

				var p = 0;
				var n = str.length;
				var id = 1;
				function f(){
					if(p >= n) return;
					var e = str.indexOf("\n",p);
					if((first_id <= id) && (id <= last_id)){
					}else if(dictionary_id[id]){
					}else{
						// ナンバーからレスポンスオブジェクトを取得
						var response = bbs_dictionary.getResponse(id);
						if(!(response.getAnalyzed())){
							var m = str.substring(p,e).match(re_search);
							if(m){
								var obj = new Object();
								obj.number = id;
								obj.name = m[1];
								obj.mail = m[2];
								obj.date = "";
								obj.id = "";
								obj.be = "";
								obj.message = m[4];
								if(m[3].match(re_date)){
									obj.date = RegExp.$1;
								}
								if(m[3].match(re_id)){
									obj.id = RegExp.$1;
								}
								if(m[3].match(re_be)){
									obj.be = RegExp.$1;
								}
								if(obj.message.match(re_icon)){
									obj.message = "<img src=\"http://img.2ch.net/ico/" + RegExp.$1 + "\">" + RegExp.$2;
								}

								var nodes = StringHtmlCreateDomNodesSafe(generate_html_func(obj));
								var dt = ElementGetElementsByTagName(nodes[0],"dt")[0];
								var dd = ElementGetElementsByTagName(nodes[0],"dd")[0];

								try{
									if(dt.tagName != "DT")	return;
									if(dd.tagName != "DD")	return;
								}catch(e){
									return;
								}

								var dt_text = ElementGetTextContent(dt);

								// レスアンカー拡張
								work.extendResponseAnchor(dd);

								// IDの取得
								if(dt_text.match(re_gen_id)){
									response.setId(RegExp.$1);
								}

								// 名前の取得
								if(dt_text.match(re_gen_name)){
									response.setName(RegExp.$1);
								}

								// ホスト名の取得
								(function(){
									var p;
									var n;
									var q;
									var ignore_dictionary = {"B":1,"SCRIPT":1};
									var queue = new Object();
									q = {p:queue,n:queue,node:dt};
									queue.p = q;
									queue.n = q;

									while(queue.n != queue){
										q = queue.n;
										p = q.p;
										n = q.n;
										p.n = n;
										n.p = p;
										var node = q.node;
										switch(node.nodeType){
										case 1:
											if(!(ignore_dictionary[node.tagName])){
												var i;
												var nodes = node.childNodes;
												var num = nodes.length;
												for(i=0;i<num;i++){
													n = queue;
													p = n.p;
													q = {p:p,n:n,node:nodes[i]};
													p.n = q;
													n.p = q;
												}
											}
											break;
										case 3:
											var m = DomNodeGetNodeValue(node).match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
											if(m){
												response.setHost(m[2]);
												return;
											}
											var m = DomNodeGetNodeValue(node).match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})(|\\n) \\]","i"));
											if(m){
												response.setHost(m[2]);
												return;
											}
											var m = DomNodeGetNodeValue(node).match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
											if(m){
												response.setHost(m[2]);
												return;
											}
											break;
										}
									}
								})();

								// フォロー解析
								var dictionary = new Object();
								(function(){
									var nodes = ElementGetElementsByTagName(dd,"a");
									var i;
									var num = nodes.length;
									for(i=0;i<num;i++){
										var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(nodes[i]));
										numbers.getNumbers(function(n){
											if(!dictionary[n]){
												var following = bbs_dictionary.getResponse(n);
												following.addFollower(response);
												dictionary[n] = true;
											}
										});
									}
								})();

								// オリジナルエレメントをセット
								if(dt)	response.addOriginalElements("dt",dt);
								if(dd)	response.addOriginalElements("dd",dd);

								// 消去時に実行されるイベント
								response.onerase = function(){};

								response.setAnalyzed();
							}
						}
					}

					id += 1;
					if(p < e){
						p = e + 1;
						execute_queue.attachFirst(f,null);
					}
				}
				execute_queue.attachFirst(f,null);
			}

			// --------------------------------------------------------------------------------
			// DAT 文書を継ぎ足し読み込み
			// --------------------------------------------------------------------------------
			function loadMoreFromDAT(str){
				var re_search = new RegExp("(.*?)<>(.*?)<>(.*?)<> (.*?) <>","i");
				var re_date = new RegExp("([0-9]+/[0-9]+/[0-9]+.* [0-9]+:[0-9]+:[0-9]+.*?)($| ID:| BE:)","i");
				var re_id = new RegExp("ID:([^ ]+)","i");
				var re_be = new RegExp("BE:([^ ]+)","i");
				var re_icon = new RegExp("^sssp://img.2ch.net/ico/(.*?)( <br> .*)$","i");

				var p = 0;
				var n = str.length;
				var id = 1;
				function f(){
					try{
						if(p >= n) throw 0;
						var e = str.indexOf("\n",p);
						if(last_id < id){
							var m = str.substring(p,e).match(re_search);
							if(m){
								var response = bbs_dictionary.getResponse(id);
								response.clearAnalyzed();
								response.clearOriginalElements();
								response.clearFollowing();

								var obj = new Object();
								obj.number = id;
								obj.name = m[1];
								obj.mail = m[2];
								obj.date = "";
								obj.id = "";
								obj.be = "";
								obj.message = m[4];
								if(m[3].match(re_date)){
									obj.date = RegExp.$1;
								}
								if(m[3].match(re_id)){
									obj.id = RegExp.$1;
								}
								if(m[3].match(re_be)){
									obj.be = RegExp.$1;
								}
								if(obj.message.match(re_icon)){
									obj.message = "<img src=\"http://img.2ch.net/ico/" + RegExp.$1 + "\">" + RegExp.$2;
								}
	
								var nodes = StringHtmlCreateDomNodesSafe(generate_html_func(obj));
								var j;
								var node_num = nodes.length;
								if(element_last){
									for(j=0;j<node_num;j++){
										DomNode_InsertAfter(element_last,nodes[j]);
										element_last = nodes[j];
									}
								}
								if(element_parent){
									for(j=0;j<node_num;j++){
										element_parent.appendChild(nodes[j]);
									}
								}
								last_id = id;
							}
						}

						id += 1;
						if(p < e){
							p = e + 1;
							execute_queue.attachFirst(f,null);
							return;
						}
					}catch(e){
					}
					read_more_button.init();
				}
				execute_queue.attachFirst(f,null);
			}

			// --------------------------------------------------------------------------------
			// 継ぎ足し読み込み
			// --------------------------------------------------------------------------------
			function readMore(){

				// ローダーオブジェクトを作成
				var loader = new Loader();

				// 成功
				loader.onload = function(str){
					if(load_more_func){
						load_more_func(str);
					}
				};

				// 失敗
				loader.onerror = function(){
					read_more_button.init();
				};

				// テキストの読み込み
				loader.setMethod("GET");
				loader.setURL(resource_url_more);
				switch(work.bbs_name){
				case "2ch":
				case "pink":
					loader.overrideMimeType("text/plain; charset=Shift_JIS");
					break;
				case "shitaraba":
					loader.overrideMimeType("text/plain; charset=EUC-JP");
					break;
				}
				loader.loadText();
			}

			// --------------------------------------------------------------------------------
			// フッダ要素
			// --------------------------------------------------------------------------------
			element_footer = document.getElementById("footer");

			// --------------------------------------------------------------------------------
			// Default スタイル
			// --------------------------------------------------------------------------------
			if(!generate_html_func){
				(function(){
					var nodes = ElementGetElementsByTagName(document.body,"dl");
					var node_num = nodes.length;
					var i;
					if(node_num){
						if(nodes[0].parentNode != document.body) return;
					}

					// --------------------------------------------------------------------------------
					// 範囲取得
					// --------------------------------------------------------------------------------
					var re_number = new RegExp("^([0-9]+)","i");
					for(i=node_num-1;i>=0;i--){
						var node = nodes[i];
						if(ElementGetTextContent(node).match(re_number)){
							last_id = parseInt(RegExp.$1);
							dictionary_id[last_id] = true;
							element_last = node;
							break;
						}
					}
					if(!element_last) return;
					for(i=0;i<node_num;i++){
						var node = nodes[i];
						if(ElementGetTextContent(node).match(re_number)){
							first_id = parseInt(RegExp.$1);
							dictionary_id[first_id] = true;
							if(first_id != 1){
								break;
							}
						}
					}

					// --------------------------------------------------------------------------------
					// コード生成コールバック
					// --------------------------------------------------------------------------------
					generate_html_func = function(param){
						return '<dl id="res' + param.number + '" class="resContainer" resid="' + param.id + '" collapsed="false" isabone="false">' +
							'<dt class="resHeader">' +
								'<span class="resNumber">' + param.number + ' </span>' +
								'<span class="resHeaderContent">' +
									'<span class="resName"><span class="resSystem">' + param.name + '</span></span> ' +
									'[<span class="resMail">' + param.mail + '</span>] ' +
									'<span class="resDate">' + param.date + ' </span> ' +
									((param.id) ? ('ID:' + param.id + ' ') : ('')) +
									((param.be) ? ('Be:<span class="resBeID">' + param.be + '</span>') : ('')) +
								'</span>' +
								'<span class="resHeaderAboneContent"></span>' +
								'<span style="color: rgb(136, 136, 136); font-size: small;"></span>' +
							'</dt>' +
							'<dd class="resBody"> ' + param.message + ' </dd>' +
						'</dl>';
					}

					work.skin_type = "default";
				})();
			}

			if(!generate_html_func) return false;

			// --------------------------------------------------------------------------------
			// 読み込み方式
			// --------------------------------------------------------------------------------
			load_shadow_func = loadShadowFromHTML;
			load_more_func = loadMoreFromHTML;

			if(work.bbs_name == "2ch"){
				// DAT ファイル
				load_shadow_func = loadShadowFromDAT;
				load_more_func = loadMoreFromDAT;
			}

			// --------------------------------------------------------------------------------
			// アクセス先 URL
			// --------------------------------------------------------------------------------
			if(load_more_func == loadMoreFromHTML){
				resource_url_shadow = base_url;
				resource_url_more = base_url + last_id + "-";
			}else{
				if(base_url.match(new RegExp("http://([^.]+\\.2ch\\.net)/test/read\\.cgi/([^/]+)/([0-9]+)/","i"))){
					resource_url_shadow = resource_url_more = "http://" + RegExp.$1 + "/" + RegExp.$2 + "/dat/" + RegExp.$3 + ".dat";
				}
			}

			// --------------------------------------------------------------------------------
			// BbsControlReadMoreButton 作成
			// --------------------------------------------------------------------------------
			read_more_button = new BbsControlReadMoreButton();
			read_more_button.setWaitTime(2 * 1000);
			read_more_button.onclick = readMore;
			if(element_footer){
				DomNode_InsertBefore(element_footer,read_more_button.getElement());
			}else{
				document.body.appendChild(read_more_button.getElement());
			}

			// --------------------------------------------------------------------------------
			// シャドウロード
			// --------------------------------------------------------------------------------
			(function(){
				// ローダーオブジェクトを作成
				var loader = new Loader();

				// 成功
				loader.onload = function(str){
					if(load_shadow_func){
						load_shadow_func(str);
					}
				};

				// 失敗
				loader.onerror = function(){
				};

				// テキストの読み込み
				loader.setMethod("GET");
				loader.setURL(resource_url_shadow);
				switch(work.bbs_name){
				case "2ch":
				case "pink":
					loader.overrideMimeType("text/plain; charset=Shift_JIS");
					break;
				case "shitaraba":
					loader.overrideMimeType("text/plain; charset=EUC-JP");
					break;
				}
				loader.loadText();
			})();

			response({result:true});
			return true;
		}

		return false;
	}.toString() +
	",\n\n\t" +
	function (info,response){
		response({result:false});
		return true;
	}.toString() +
"\n]",
					script_callback:
"[\n\t" + 
	function(info,response){
		var element = info.element;
		var work = info.work;

		// --------------------------------------------------------------------------------
		// レスポンスダイアログを登録
		// --------------------------------------------------------------------------------
		function attachBbsResponseDialog(response,node,parent_dialog,type){

			// --------------------------------------------------------------------------------
			// レスアンカー
			// --------------------------------------------------------------------------------
			function forResponseAnchor(target){
				if(BbsControlResponseAnchorExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlResponseAnchor を生成
				// --------------------------------------------------------------------------------
				(function(){
					var i;
					var nodes = ElementGetElementsByTagName(target,"a");
					var num = nodes.length;
					for(i=0;i<num;i++){
						var node = nodes[i];
						var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(node));
						if(numbers.getCount()){
							var control_res_anchor = new BbsControlResponseAnchor(node,false);
							control_res_anchor.setResponseAnchorNumbers(numbers);
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlResponseAnchor を検索
				// --------------------------------------------------------------------------------
				BbsControlResponseAnchorSearch(target,function(control_res_anchor){

					var element_res_anchor = control_res_anchor.getElement();
					var numbers = control_res_anchor.getResponseAnchorNumbers();

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_res_anchor);
					response_dialog.oncreate = function(_window,callback){

						var dl = DocumentCreateElement("dl");
						dl.style.margin = "0px";
						_window.appendChild(dl);

						var created = false;
						var i = 0;
						var number_list = numbers.getNumberList();
						var num = number_list.length;
						if(!num) return false;

						function f(){
							var following = bbs_dictionary.getResponse(number_list[i]);
							var clone = following.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){
								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									dl.appendChild(obj.element);
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(following,param,response_dialog,"response");

								created = true;
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:created});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// ID
			// --------------------------------------------------------------------------------
			function forId(target){
				if(BbsControlIdExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlId を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"A":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}

							// 名前欄
							if(node.className == "resID"){
								var m = ElementGetTextContent(node).match(new RegExp("([-a-zA-Z0-9+/.]+)[●!]{0,2}$","i"));
								if(m){
									// BbsControlId を生成
									var control_id = new BbsControlId(null,true);
									control_id.setId(m[1]);
									var element_id = control_id.getElement();
									DomNode_InsertAfter(node,element_id);
									var textnode_id = DocumentCreateText("");
									element_id.appendChild(textnode_id);
									control_id.setTextNode(textnode_id);
								}
							}

							break;
						case 3:
							while(node){

								var m = DomNodeGetNodeValue(node).match(new RegExp("ID:([-a-zA-Z0-9+/.]+)[●!]{0,2}","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(node,RegExp.leftContext);

								// BbsControlId を生成
								var control_id = new BbsControlId(null,false);
								control_id.setId(m[1]);
								var element_id = control_id.getElement();
								ElementSetTextContent(element_id,m[0]);
								DomNode_InsertAfter(node,element_id);
								var textnode_id = DocumentCreateText("");
								element_id.appendChild(textnode_id);
								control_id.setTextNode(textnode_id);

								// 直後テキスト
								node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(element_id,node);
							}
							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlId を検索
				// --------------------------------------------------------------------------------
				BbsControlIdSearch(target,function(control_id){

					control_id.setResponse(response);

					var id = control_id.getId();
					var element_id = control_id.getElement();
					var textnode_id = control_id.getTextNode();

					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_id.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_id,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_id,"");
						}

						var style = element_id.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","small");
						}
					};
					control_id.update();

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "id"){
						if(response.getId() == id)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_id);
					response_dialog.oncreate = function(_window,callback){

						var dl = DocumentCreateElement("dl");
						dl.style.margin = "0px";
						_window.appendChild(dl);

						var responses = bbs_dictionary.getResponsesFromId(id);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_id = responses[i];
							var clone = response_id.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									dl.appendChild(obj.element);
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_id,param,response_dialog,"id");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// トリップ
			// --------------------------------------------------------------------------------
			function forName(target){
				if(BbsControlNameExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlName を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							while(node){

								// 本文
								var m = DomNodeGetNodeValue(node).match(new RegExp("(◆[a-zA-Z0-9+/.]{10,12})","i"));
								if(!m)	break;

								// 元のテキストノード
								DomNodeSetNodeValue(node,RegExp.leftContext);

								// BbsControlName を生成
								var control_name = new BbsControlName(null,false);
								control_name.setName(m[0]);
								var element_name = control_name.getElement();
								ElementSetTextContent(element_name,m[0]);
								DomNode_InsertAfter(node,element_name);

								// 直後テキスト
								node = DocumentCreateText(RegExp.rightContext);
								DomNode_InsertAfter(element_name,node);
							}
							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlName を検索
				// --------------------------------------------------------------------------------
				BbsControlNameSearch(target,function(control_name){

					control_name.setResponse(response);

					var name = control_name.getName();
					var element_name = control_name.getElement();
					var textnode_name = DocumentCreateText("");


					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_name.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_name,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_name,"");
						}

						var style = element_name.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","small");
						}
					};
					control_name.update();
					element_name.appendChild(textnode_name);

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "name"){
						if(response.getName() == name)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_name);
					response_dialog.oncreate = function(_window,callback){

						var dl = DocumentCreateElement("dl");
						dl.style.margin = "0px";
						_window.appendChild(dl);

						var responses = bbs_dictionary.getResponsesFromName(name);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_name = responses[i];
							var clone = response_name.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									dl.appendChild(obj.element);
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_name,param,response_dialog,"name");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// ホスト
			// --------------------------------------------------------------------------------
			function forHost(target){
				if(BbsControlHostExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlHost を生成
				// --------------------------------------------------------------------------------
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"B":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							while(node){
								var text_value = DomNodeGetNodeValue(node);

								var m = text_value.match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
								if(m){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext + m[1]);

									// BbsControlHost を生成
									var control_host = new BbsControlHost(null,false);
									control_host.setHost(m[2]);
									var element_host = control_host.getElement();
									ElementSetTextContent(element_host,m[2]);
									DomNode_InsertAfter(node,element_host);

									// 直後テキスト
									node = DocumentCreateText(RegExp.rightContext);
									DomNode_InsertAfter(element_host,node);
									continue;
								}

								var m = text_value.match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})((|\\n) \\])","i"));
								if(m){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext + m[1]);

									// BbsControlHost を生成
									var control_host = new BbsControlHost(null,false);
									control_host.setHost(m[2]);
									var element_host = control_host.getElement();
									ElementSetTextContent(element_host,m[2]);
									DomNode_InsertAfter(node,element_host);

									// 直後テキスト
									node = DocumentCreateText("\n ]" + RegExp.rightContext);
									DomNode_InsertAfter(element_host,node);
									continue;
								}

								var m = text_value.match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
								if(m){
									// 元のテキストノード
									DomNodeSetNodeValue(node,RegExp.leftContext + m[1]);

									// BbsControlHost を生成
									var control_host = new BbsControlHost(null,false);
									control_host.setHost(m[2]);
									var element_host = control_host.getElement();
									ElementSetTextContent(element_host,m[2]);
									DomNode_InsertAfter(node,element_host);

									// 直後テキスト
									node = DocumentCreateText(RegExp.rightContext);
									DomNode_InsertAfter(element_host,node);
									continue;
								}

								break;
							}

							break;
						}
					}
				})();

				// --------------------------------------------------------------------------------
				// BbsControlHost を検索
				// --------------------------------------------------------------------------------
				BbsControlHostSearch(target,function(control_host){

					control_host.setResponse(response);

					var host = control_host.getHost();
					var element_host = control_host.getElement();
					var textnode_host = DocumentCreateText("");


					// --------------------------------------------------------------------------------
					// 変化があったときに実行されるイベント
					// --------------------------------------------------------------------------------
					control_host.onchange = function(count){
						if(count > 1){
							DomNodeSetNodeValue(textnode_host,"(" + count + ")");
						}else{
							DomNodeSetNodeValue(textnode_host,"");
						}

						var style = element_host.style;
						if(count >= 5){
							StyleDeclarationSetProperty(style,"color","#e80000");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else if(count >= 2){
							StyleDeclarationRemoveProperty(style,"color");
							StyleDeclarationRemoveProperty(style,"font-size");
						}else{
							StyleDeclarationSetProperty(style,"color","#888");
							StyleDeclarationSetProperty(style,"font-size","80%");
						}
					};
					control_host.update();
					element_host.appendChild(textnode_host);

					// --------------------------------------------------------------------------------
					// ポップアップ化
					// --------------------------------------------------------------------------------
					if(type == "host"){
						if(response.getHost() == host)	return null;
					}

					// ダイアログを作成
					var response_dialog = new BbsResponseDialog();
					if(parent_dialog)	parent_dialog.attachChild(response_dialog);
					response_dialog.setElementParent(node.parent);
					response_dialog.setElementHitArea(element_host);
					response_dialog.oncreate = function(_window,callback){

						var dl = DocumentCreateElement("dl");
						dl.style.margin = "0px";
						_window.appendChild(dl);

						var responses = bbs_dictionary.getResponsesFromHost(host);
						var i = 0;
						var num = responses.length;
						if(num <= 1) return false;

						function f(){
							var response_host = responses[i];
							var clone = response_host.getCloneElements();

							var j;
							var clone_num = clone.length;
							if(clone_num){

								var param = new Object();
								param.parent = node.parent;
								for(j=0;j<clone_num;j++){
									var obj = clone[j];
									param[obj.name] = obj.element;
									dl.appendChild(obj.element);
								}

								// レスポンスダイアログを登録
								attachBbsResponseDialog(response_host,param,response_dialog,"host");
							}

							i += 1;
							if(i < num){
								execute_queue.attachFirst(f,null);
							}else{
								callback({result:true});
							}
						}
						execute_queue.attachFirst(f,null);
					};

					return null;
				});
			}

			// --------------------------------------------------------------------------------
			// フォロワー
			// --------------------------------------------------------------------------------
			function forFollower(target){
				if(BbsControlFollowerExist(target))	return;

				// --------------------------------------------------------------------------------
				// BbsControlFollower を生成
				// --------------------------------------------------------------------------------
				var control_follower = new BbsControlFollower(null,true);
				control_follower.setResponse(response);

				var element_follower = control_follower.getElement();
				var textnode_follower = DocumentCreateText("");

				element_follower.appendChild(textnode_follower);

				// --------------------------------------------------------------------------------
				// 変化があったときに実行されるイベント
				// --------------------------------------------------------------------------------
				control_follower.onchange = function(count){
					if(count){
						textnode_follower.nodeValue = " follower(" + count + ")";
					}else{
						textnode_follower.nodeValue = "";
					}

					var style = element_follower.style;
					if(count >= 3){
						StyleDeclarationSetProperty(style,"color","#e80000");
						StyleDeclarationRemoveProperty(style,"font-size");

					}else{
						StyleDeclarationSetProperty(style,"color","#888");
						StyleDeclarationSetProperty(style,"font-size","small");
					}
					if(count){
						StyleDeclarationSetProperty(style,"margin","0px 4px 0px 0px");
					}else{
						StyleDeclarationRemoveProperty(style,"margin");
					}
				};
				control_follower.update();
				var nodes = ElementGetElementsByTagName(target,"br");
				if(nodes.length){
					DomNode_InsertBefore(nodes[0],element_follower);
				}else{
					target.appendChild(element_follower);
				}

				// --------------------------------------------------------------------------------
				// ポップアップ化
				// --------------------------------------------------------------------------------
				// ダイアログを作成
				var response_dialog = new BbsResponseDialog();
				if(parent_dialog)	parent_dialog.attachChild(response_dialog);
				response_dialog.setElementParent(node.parent);
				response_dialog.setElementHitArea(element_follower);
				response_dialog.oncreate = function(_window,callback){

					var dl = DocumentCreateElement("dl");
					dl.style.margin = "0px";
					_window.appendChild(dl);

					var ary = response.getFollower();
					var i = 0;
					var num = ary.length;
					if(num <= 0) return false;

					function f(){
						var follower = bbs_dictionary.getResponse(ary[i].getNumber());
						var clone = follower.getCloneElements();

						var j;
						var clone_num = clone.length;
						if(clone_num){

							var param = new Object();
							param.parent = node.parent;
							for(j=0;j<clone_num;j++){
								var obj = clone[j];
								param[obj.name] = obj.element;
								dl.appendChild(obj.element);
							}

							// レスポンスダイアログを登録
							attachBbsResponseDialog(follower,param,response_dialog,"response");
						}

						i += 1;
						if(i < num){
							execute_queue.attachFirst(f,null);
						}else{
							callback({result:true});
						}
					}
					execute_queue.attachFirst(f,null);
				};
			}

			if(node.dt){
				forResponseAnchor(node.dt);
				forId(node.dt);
				forName(node.dt);
				forHost(node.dt);
				forFollower(node.dt);
			}
			if(node.dd){
				forResponseAnchor(node.dd);
				forId(node.dd);
				forName(node.dd);
			}
		}

		// --------------------------------------------------------------------------------
		// エレメントを解析
		// --------------------------------------------------------------------------------
		var useful = (function(){
			var dt = element;
			var dd;

			try{
				if(dt.tagName != "DT")	return false;
			}catch(e){
				return false;
			}

			dd = dt.nextSibling;
			try{
				if(dd.tagName != "DD")	return false;
			}catch(e){
				return false;
			}

			try{
				var dl = dt.parentNode;
				if(dl.tagName != "DL")	return false;
				if(dl.parentNode != document.body)	return false;
			}catch(e){
				return false;
			}

			// document に未登録
			if(!DomNodeGetAttachedDocument(dt))	return false;

			// --------------------------------------------------------------------------------
			// レスアンカー拡張
			// --------------------------------------------------------------------------------
			work.extendResponseAnchor(dd);

			// --------------------------------------------------------------------------------
			// クリーンアップ
			// --------------------------------------------------------------------------------
			(function(){
				function cleanupHeader(target){
					var p;
					var n;
					var q;
					var queue = new Object();
					q = {p:queue,n:queue,node:target};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(node.className == "resID"){
								var prev = node.previousSibling;
								if(prev){
									if((prev.nodeType == 3) && (DomNodeGetNodeValue(prev).indexOf("ID:") >= 0)){
										if(!(node.childNodes.length)){
											DomNodeRemove(prev);
											DomNodeRemove(node);
										}else{
											DomNodeSetNodeValue(prev,DomNodeGetNodeValue(prev) + ElementGetTextContent(node));
											DomNodeRemove(node);
										}
									}
								}
							}else if(node.className == "resBeID"){
								var prev = node.previousSibling;
								if(prev){
									if((prev.nodeType == 3) && (DomNodeGetNodeValue(prev).indexOf("Be:") >= 0)){
										if(!(node.childNodes.length)){
											DomNodeRemove(prev);
											DomNodeRemove(node);
										}
									}
								}
							}else{
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						}
					}
				}

				function cleanup(target){
					BbsControlSearchTrash(target,function(element){
						var node = element.firstChild;
						if(!node)	return null;
						if(node.nodeType != 3)	return null;

						// ID
						var m = node.nodeValue.match(new RegExp("^ID:([-a-zA-Z0-9+/.]+)[●!]{0,2}","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);
							return null;
						}

						// トリップ
						var m = node.nodeValue.match(new RegExp("^(◆[a-zA-Z0-9+/.]{10,12})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);
							return null;
						}

						// ホスト名
						var m = node.nodeValue.match(new RegExp("^([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);

							// テキストノードを統合
							node.parentNode.normalize();
							return null;
						}
						var m = node.nodeValue.match(new RegExp("^([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
						if(m){
							// 直後テキスト
							var node = DocumentCreateText(m[0]);
							DomNode_InsertAfter(element,node);
							DomNodeRemove(element);

							// テキストノードを統合
							node.parentNode.normalize();
							return null;
						}

						return null;
					});
				}

				if(dt){
					cleanupHeader(dt);
					cleanup(dt);
				}
				if(dd){
					cleanup(dd);
				}
			})();

			// ナンバーを取得
			var dt_text = ElementGetTextContent(dt);
			if(!(dt_text.match(new RegExp("([0-9]+)[ ]","i"))))	return false;

			// ナンバーからレスポンスオブジェクトを取得
			var response = bbs_dictionary.getResponse(parseInt(RegExp.$1));

			// レスポンス解析
			if(!response.getAnalyzed()){

				// IDの取得
				if(dt_text.match(new RegExp("ID:([-a-zA-Z0-9+/.]+)[●!]{0,2}","i"))){
					response.setId(RegExp.$1);
				}

				// 名前の取得
				if(dt_text.match(new RegExp("(◆[a-zA-Z0-9+/.]{10,12})","i"))){
					response.setName(RegExp.$1);
				}

				// ホスト名の取得
				(function(){
					var p;
					var n;
					var q;
					var ignore_dictionary = {"B":1,"SCRIPT":1};
					var queue = new Object();
					q = {p:queue,n:queue,node:dt};
					queue.p = q;
					queue.n = q;

					while(queue.n != queue){
						q = queue.n;
						p = q.p;
						n = q.n;
						p.n = n;
						n.p = p;
						var node = q.node;
						switch(node.nodeType){
						case 1:
							if(!(ignore_dictionary[node.tagName])){
								var i;
								var nodes = node.childNodes;
								var num = nodes.length;
								for(i=0;i<num;i++){
									n = queue;
									p = n.p;
									q = {p:p,n:n,node:nodes[i]};
									p.n = q;
									n.p = q;
								}
							}
							break;
						case 3:
							var m = DomNodeGetNodeValue(node).match(new RegExp("(^|HOST:)([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})","i"));
							if(m){
								response.setHost(m[2]);
								return;
							}
							var m = DomNodeGetNodeValue(node).match(new RegExp("(\\[ )([-._a-zA-Z0-9]{1,}(\\.[-._a-zA-Z0-9]{1,}){2,})(|\\n) \\]","i"));
							if(m){
								response.setHost(m[2]);
								return;
							}
							var m = DomNodeGetNodeValue(node).match(new RegExp("(発信元:)([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})","i"));
							if(m){
								response.setHost(m[2]);
								return;
							}
							break;
						}
					}
				})();

				// フォロー解析
				var dictionary = new Object();
				(function(){
					var nodes = ElementGetElementsByTagName(dd,"a");
					var i;
					var num = nodes.length;
					for(i=0;i<num;i++){
						var numbers = work.createResponseAnchorNumbers(ElementGetTextContent(nodes[i]));
						numbers.getNumbers(function(n){
							if(!dictionary[n]){
								var following = bbs_dictionary.getResponse(n);
								following.addFollower(response);
								dictionary[n] = true;
							}
						});
					}
				})();

				// オリジナルエレメントをセット
				if(dt)	response.addOriginalElements("dt",dt);
				if(dd)	response.addOriginalElements("dd",dd);

				// 消去時に実行されるイベント
				response.onerase = function(){
					var original = response.getOriginalElements();

					// オリジナルエレメントを外す
					var i;
					var num = original.length;
					for(i=0;i<num;i++){
						var revise_scroll = new DocumentReviseScroll();
						var node = original[i].element;
						revise_scroll.executeRemoveElementBefore(node);
						DomNodeRemove(node);
						revise_scroll.executeRemoveElementAfter(node);
					}
				};

				response.setAnalyzed();
			}

			// レスポンスダイアログを登録（ルート）
			attachBbsResponseDialog(
				response,
				{
					dt:dt,
					dd:dd,
					parent:dt.parentNode
				},
				null,
				null
			);

			return true;
		})();

		response({useful:useful});
		return true;
	}.toString() +
"\n]",
					popup:{
						origin_type:"adsorb_top_bottom",
						position_type:"absolute",
						enable_animation:true,
						percent:{x:75,y:90},
						time_wait_open:0,
						time_wait_close:250,
						style_sheet:"padding:20px 10px; border:1px solid #000; background:#FFF; overflow-y:auto; word-wrap:break-word; word-break:break-all;"
					}
				};


				// --------------------------------------------------------------------------------
				// URLマッピング設定
				// --------------------------------------------------------------------------------
				// chaika
				var obj = addPreset(proj.urlmap,"chaika","image_bbs");
				obj.preset = {
					name:{
						standard:"chaika",
						locales:{
							ja:"chaika",
							en:"chaika"
						}
					},
					enable:true,
					filter:[
						"http://127.0.0.1:*/thread/http://2ch.net/*",
						"http://127.0.0.1:*/thread/http://*.2ch.net/*",
						"http://127.0.0.1:*/thread/http://*.bbspink.com/*",
						"http://127.0.0.1:*/thread/http://jbbs.livedoor.jp/*"
					],
					enable_unsecure:false,
					enable_mixed_content:false,
					access_block:{enable:false,id:[]},
					replacement_to_element:{enable:false,id:[]},
					replacement_to_text:{enable:false,id:[]},
					replacement_to_anchor:{enable:true,id:["direct_link_bbs","no_referrer"]},
					replacement_to_link:{enable:true,id:["direct_link_generic"]},
					replacement_to_referer:{enable:true,id:["replacement_link_url"]},
					replacement_to_useragent:{enable:false,id:""},
					make_link_to_text:{enable:true,id:"detail"},
					expand_short_url:{enable:true,id:"detail"},
					expand_text:{enable:false,id:""},
					expand_image:{enable:true,id:"thumbnail_not_include_image"},
					expand_sound:{enable:true,id:"inline"},
					expand_video:{enable:true,id:"inline"},
					expand_iframe:{enable:false,id:""},
					style_sheet:{enable:true,id:"default"},
					experimental:{enable:false,id:""}
				};

			}
			if(exit())	return proj;

			return proj;
		}

		// --------------------------------------------------------------------------------
		// ローカルストレージからロード
		// --------------------------------------------------------------------------------
		_container.loadLocalStorage = function(func){
			_proj = null;

			function projUpdate(){
				try{
					_proj = _container.margePresetFromObject(_proj);
					_proj = ProjectUpdate(_proj,null);
					// 辞書生成
					createDictionary();
					func({result:true});
				}catch(e){
					projDefault();
				}
			}

			function projDefault(){
				_proj = ProjectUpdate(null,null);
				// 辞書生成
				createDictionary();
				func({result:true});
			}

			if(project_import_manual){
				// 手動のインポート設定を使用
				_proj = project_import_manual;
				projUpdate();
			}else{
				// ローカルストレージから読み込み
				LocalStorageGetItem(_key,function(e){
					if(e.result){
						try{
							_proj = JsonParse(e.value);
						}catch(e){}
						projUpdate();
					}else{
						projDefault();
					}
				});
			}
		};

		// --------------------------------------------------------------------------------
		// ローカルストレージへセーブ
		// --------------------------------------------------------------------------------
		_container.saveLocalStorage = function(func){
			var obj = _container.exportObject();
			obj = page_expand_project.removePresetFromObject(obj);
			LocalStorageSetItem(_key,JsonStringify(obj),function(e){
				func(e);
			});
		};

		// --------------------------------------------------------------------------------
		// ローカルストレージから削除
		// --------------------------------------------------------------------------------
		_container.removeLocalStorage = function(func){
			LocalStorageRemoveItem(_key,function(e){
				func(e);
			});
		};

		// --------------------------------------------------------------------------------
		// 同期ストレージからロード
		// --------------------------------------------------------------------------------
		_container.loadSyncStorage = function(func){
			SyncStorageGetItem(_key,function(e){
				if(e.result){
					var obj = null;
					if(e.value){
						obj = JsonParse(e.value);
						obj = _container.margePresetFromObject(obj);
					}
					_proj = ProjectUpdate(obj,null);
					// 辞書生成
					createDictionary();
					func({result:true});
				}else{
					func(e);
				}
			});
		};

		// --------------------------------------------------------------------------------
		// 同期ストレージへセーブ
		// --------------------------------------------------------------------------------
		_container.saveSyncStorage = function(func){
			var obj = ObjectCopy(_container.getObject());
			obj = _container.removePresetFromObject(obj);
			SyncStorageSetItem(_key,JsonStringify(obj),function(e){
				func(e);
			});
		};

		// --------------------------------------------------------------------------------
		// 同期ストレージから削除
		// --------------------------------------------------------------------------------
		_container.removeSyncStorage = function(func){
			SyncStorageRemoveItem(_key,function(e){
				func(e);
			});
		};

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		_container.initialize = function(json){
			_proj = null;
			_proj = ProjectUpdate(_proj,null);
			// 辞書生成
			createDictionary();
		};

		// --------------------------------------------------------------------------------
		// JSON 文字列からインポート
		// --------------------------------------------------------------------------------
		_container.importJSON = function(json){
			_proj = JsonParse(json);
			_proj = ProjectUpdate(_proj,null);
			// 辞書生成
			createDictionary();
		};

		// --------------------------------------------------------------------------------
		// オブジェクトからインポート
		// --------------------------------------------------------------------------------
		_container.importObject = function(obj){
			_proj = ObjectCopy(obj);
			_proj = ProjectUpdate(_proj,null);
			// 辞書生成
			createDictionary();
		};

		// --------------------------------------------------------------------------------
		// 定義をインポート
		// --------------------------------------------------------------------------------
		_container.importDefineObject = function(user_obj,asset){
			if(user_obj.version === undefined)	return;

			var preset_obj = ProjectUpdate(null,{version:user_obj.version});

			var user_dictionary = new Object();
			var preset_dictionary = new Object();
			var proj_dictionary = new Object();
			var user_asset = new Object();

			// ユーザー辞書
			(function(){
				var p;
				for(p in user_obj){
					var a = user_obj[p];
					if(typeof(a) == "object"){
						if(a.constructor == Array){
							user_dictionary[p] = new Object();
							var ary = new Array();
							var i;
							var num = a.length;
							for(i=0;i<num;i++){
								var o = a[i];
								if(o.id !== undefined){
									user_dictionary[p][o.id] = o;
									if(o.user){
										ary.push(o.id);
									}
								}
							}
							if(ary.length){
								user_asset[p] = ary;
							}
						}
					}
				}
			})();

			// 更新なし
			if(!(user_asset[asset])){
				return;
			}

			// プリセット辞書
			(function(){
				var p;
				for(p in preset_obj){
					var a = preset_obj[p];
					if(typeof(a) == "object"){
						if(a.constructor == Array){
							preset_dictionary[p] = new Object();
							var i;
							var num = a.length;
							for(i=0;i<num;i++){
								var o = a[i];
								if(o.id !== undefined){
									preset_dictionary[p][o.id] = o;
								}
							}
						}
					}
				}
			})();

			// ユーザー設定をプリセット設定にマージ
			(function(){
				var p;
				for(p in preset_obj){
					var a = preset_obj[p];
					if(typeof(a) == "object"){
						if(a.constructor == Array){
							if(!user_asset[p])	continue;

							var i;
							var num = a.length;
							for(i=0;i<num;i++){
								var o = a[i];
								if(user_dictionary[p][o.id]){
									o.user = user_dictionary[p][o.id].user;
								}
							}

							var user_obj = user_dictionary[p];
							var user_id;
							for(user_id in user_obj){
								if(!(preset_dictionary[p][user_id])){
									a.push(user_obj[user_id]);
								}
							}
						}
					}
				}

				preset_obj = ProjectUpdate(preset_obj,null);
			})();

			// プロジェクト辞書
			(function(){
				var p;
				for(p in preset_obj){
					var a = preset_obj[p];
					if(typeof(a) == "object"){
						if(a.constructor == Array){
							proj_dictionary[p] = new Object();
							var i;
							var num = a.length;
							for(i=0;i<num;i++){
								var o = a[i];
								if(o.id !== undefined){
									proj_dictionary[p][o.id] = o;
								}
							}
						}
					}
				}
			})();

			// プロジェクトにインポート
			(function(){
				var define_id = asset;

				var define_ary = _proj[define_id];
				var define_dictionary = new Object();

				var i;
				var num = define_ary.length;
				for(i=0;i<num;i++){
					var d = define_ary[i];
					define_dictionary[d.id] = d;
				}

				var asset_ary = user_asset[define_id];
				num = asset_ary.length;
				for(i=num-1;i>=0;i--){
					var d = proj_dictionary[define_id][asset_ary[i]];
					if(d.preset){
						define_dictionary[d.id].user = d.user;
					}else{
						var user_id = _container.createUserId(define_id);
						define_ary.unshift(d);
						d.id = user_id;
					}
				}
			})();
		};

		// --------------------------------------------------------------------------------
		// JSON 文字列をエクスポート
		// --------------------------------------------------------------------------------
		_container.exportJSON = function(){
			return JsonStringify(_proj);
		};

		// --------------------------------------------------------------------------------
		// オブジェクトをエクスポート
		// --------------------------------------------------------------------------------
		_container.exportObject = function(){
			return ObjectCopy(_proj);
		};

		// --------------------------------------------------------------------------------
		// プリセットを除去
		// --------------------------------------------------------------------------------
		_container.removePresetFromObject = function(obj){
			var p;
			for(p in obj){
				var a = obj[p];
				if(typeof(a) == "object"){
					if(a.constructor == Array){
						var i;
						var num = a.length;
						for(i=0;i<num;i++){
							var o = a[i];
							if(o.id !== undefined){
								if(o.preset !== undefined){
									ObjectDeleteProperty(o,"preset");
								}
							}
						}
					}
				}
			}
			return obj;
		};

		// --------------------------------------------------------------------------------
		// プリセットをマージ
		// --------------------------------------------------------------------------------
		_container.margePresetFromObject = function(obj){
			if(obj.version === undefined)	return null;

			var p;
			var preset = ProjectUpdate(null,{version:obj.version});

			// 辞書を作成
			var dictionary = new Object();
			for(p in preset){
				var a = preset[p];
				if(typeof(a) == "object"){
					if(a.constructor == Array){
						dictionary[p] = new Object();
						var i;
						var num = a.length;
						for(i=0;i<num;i++){
							var o = a[i];
							if(o.id !== undefined){
								dictionary[p][o.id] = o;
							}
						}
					}
				}
			}

			// マージ
			for(p in obj){
				var a = obj[p];
				if(typeof(a) == "object"){
					if(a.constructor == Array){
						var i;
						var num = a.length;
						for(i=0;i<num;i++){
							var o = a[i];
							if(o.id !== undefined){
								if(dictionary[p][o.id] !== undefined){
									o.preset = dictionary[p][o.id].preset;
								}
							}
						}
					}
				}
			}

			return obj;
		};

		// --------------------------------------------------------------------------------
		// オブジェクトを直接取得
		// --------------------------------------------------------------------------------
		_container.getObject = function (){
			return _proj;
		};

		// --------------------------------------------------------------------------------
		// URLキャッシュオブジェクトを取得（内部用）
		// --------------------------------------------------------------------------------
		function getUrlCache(url){

			var cache_obj = _url_cache.getObject(url);

			// キャッシュ
			if(cache_obj.project){
				return cache_obj;

			// 新規作成
			}else{
				var proj_obj = new Object();

				// 有効
				proj_obj.enable = getEnable(url);

				// 基本設定
				proj_obj.standard = _proj.standard;

				if(proj_obj.enable){
					if(url){
						// 掲示板拡張設定
						var i;
						var j;
						var bbs_num = _dictionary_expand_bbs.length;
						var expand_bbs;
						for(i=0;i<bbs_num;i++){
							var filter = _dictionary_expand_bbs[i].filter;
							var filter_num = filter.length;
							for(j=0;j<filter_num;j++){
								var regexp = filter[j];
								if(regexp){
									var m = url.match(regexp);
									if(m){
										expand_bbs = _dictionary_expand_bbs[i];
										break;
									}
								}
							}
							if(expand_bbs)	break;
						}
						proj_obj.expand_bbs = expand_bbs;

						// URLマッチング
						var i;
						var j;
						var urlmap_num = _dictionary_urlmap.length;
						var urlmap;
						for(i=0;i<urlmap_num;i++){
							var filter = _dictionary_urlmap[i].filter;
							var filter_num = filter.length;
							for(j=0;j<filter_num;j++){
								if(StringUrlMatchRegExpList(url,filter[j])){
									urlmap = _dictionary_urlmap[i];
									break;
								}
							}
							if(urlmap)	break;
						}
						for(var p in urlmap){
							proj_obj[p] = urlmap[p];
						}

						// セキュアページ
						if(url.indexOf("https://") == 0){
							proj_obj.current_secure = true;
						}else{
							proj_obj.current_secure = false;
						}
					}
				}

				// キャッシュに登録
				cache_obj.project = proj_obj;

				// URLキャッシュ辞書を作成
				var url_cache = new UrlCacheDictionary();
				url_cache.setCacheMax(64);
				cache_obj.url_cache = url_cache;

				return cache_obj;
			}
		}

		// --------------------------------------------------------------------------------
		// プロジェクトオブジェクトを取得
		// --------------------------------------------------------------------------------
		_container.getProject = function (url){
			return getUrlCache(url).project;
		};

		// --------------------------------------------------------------------------------
		// Opera拡張機能用アクセスブロックを取得
		// --------------------------------------------------------------------------------
		_container.getAccessBlockForOperaExtension = function (){
			return _opera_access_block;
		};

		// --------------------------------------------------------------------------------
		// プロジェクトの定義からフィルタを取得（内部用）
		// --------------------------------------------------------------------------------
		function getFilterFromURL(defines,url){
			var i;
			var j;
			var k;
			var filters;
			var filter;
			var filter_num;
			var url_filters;
			var url_filter_num;
			var define;
			var define_num = defines.length;
			for(i=0;i<define_num;i++){
				define = defines[i];
				filters = define.filter;
				filter_num = filters.length;
				for(j=0;j<filter_num;j++){
					filter = filters[j];
					url_filters = filter.filter;
					url_filter_num = url_filters.length;
					for(k=0;k<url_filter_num;k++){
						if(StringUrlMatchRegExpList(url,url_filters[k])){
							return filter;
						}
					}
				}
			}
			return null;
		}

		// --------------------------------------------------------------------------------
		// ウェブリクエスト用オブジェクトを取得
		// --------------------------------------------------------------------------------
		_container.getWebRequest = function(current_url,url){
			var cache_obj = getUrlCache(current_url);
			var proj = cache_obj.project;

			var obj = cache_obj.url_cache.getObject(url);

			if(obj.web_request){
				return obj.web_request;
			}else{
				var web_request = new Object();

				if(proj.enable){
					var access_block = proj.access_block;
					var replacement_to_useragent = proj.replacement_to_useragent;
					var replacement_to_referer = proj.replacement_to_referer;


					// アクセスブロック
					if(access_block){
						var i;
						var j;
						var filters;
						var filter_num;
						var define;
						var define_num = access_block.length;
						for(i=0;i<define_num;i++){
							define = access_block[i];
							filters = define.filter_regexp;
							filter_num = filters.length;
							for(j=0;j<filter_num;j++){
								if(StringUrlMatchRegExpList(url,filters[j])){
									web_request.access_block = true;
									break;
								}
							}
						}
					}

					// リファラ
					if(replacement_to_referer){
						var filter = getFilterFromURL(replacement_to_referer,url);
						if(filter){
							var obj = new Object();
							var send_referer = filter.send_referer;

							var regexp;
							if(send_referer.regexp.pattern){
								regexp = RegExpObjectGetRegExp(send_referer.regexp);
							}

							if(regexp){
								switch(send_referer.type){
								case "default":
									obj.regexp = regexp;
									obj.replacement = send_referer.replacement;
									break;
								case "current_url":
									obj.referer = RegExpReplacementDollarWord(regexp,current_url,send_referer.replacement);
									break;
								case "link_url":
									obj.referer = RegExpReplacementDollarWord(regexp,url,send_referer.replacement);
									break;
								case "custom":
									obj.referer = RegExpReplacementDollarWord(regexp,send_referer.custom,send_referer.replacement);
									break;
								}
							}else{
								switch(send_referer.type){
								case "current_url":
									obj.referer = current_url;
									break;
								case "link_url":
									obj.referer = url;
									break;
								case "custom":
									obj.referer = send_referer.custom;
									break;
								}
							}

							web_request.replacement_to_referer = obj;
						}
					}

					// ユーザーエージェント
					if(replacement_to_useragent){
						var filter = getFilterFromURL(replacement_to_useragent,url);
						if(filter){
							web_request.replacement_to_useragent = filter.send_useragent.custom;
						}
					}
				}

				obj.web_request = web_request;
				return web_request;
			}
		};

		// --------------------------------------------------------------------------------
		// ユーザーIDを生成
		// --------------------------------------------------------------------------------
		_container.createUserId = function (asset){
			return createUserId(_proj[asset]);
		};

		// --------------------------------------------------------------------------------
		// 辞書生成（内部用）
		// --------------------------------------------------------------------------------
		function createDictionary(){

			// URLキャッシュ辞書を作成
			_url_cache = new UrlCacheDictionary();
			_url_cache.setCacheMax(32);

			var i;
			var j;
			var k;
			var asset_num;
			var urlmap_num;
			var expand_bbs_num;

			// 基本設定
			var standard = _proj.standard;
			_standard = new Object();
			switch(standard.filter_type){
			case "deny":
				_standard.filter_allow = false;
				var filter = ObjectCopy(standard.filter_deny);
				var filter_num = filter.length;
				for(i=0;i<filter_num;i++){
					filter[i] = StringRegExpListFromAsteriskWord(filter[i]);
				}
				_standard.filter = filter;
				break;
			case "allow":
				_standard.filter_allow = true;
				var filter = ObjectCopy(standard.filter_allow);
				var filter_num = filter.length;
				for(i=0;i<filter_num;i++){
					filter[i] = StringRegExpListFromAsteriskWord(filter[i]);
				}
				_standard.filter = filter;
				break;
			}

			// 定義一覧
			var define_asset = [
				"access_block",
				"replacement_to_element",
				"replacement_to_text",
				"replacement_to_anchor",
				"replacement_to_link",
				"replacement_to_referer",
				"replacement_to_useragent",
				"make_link_to_text",
				"expand_short_url",
				"expand_text",
				"expand_image",
				"expand_sound",
				"expand_video",
				"expand_iframe",
				"style_sheet",
				"experimental"
			];

			// 定義を辞書化
			_dictionary_define = new Object();
			asset_num = define_asset.length;
			for(i=0;i<asset_num;i++){
				var o = new Object();
				var a = _proj[define_asset[i]];
				for(var p in a){
					var d = a[p];
					if(d.user){
						o[d.id] = ObjectCopy(d.user);
					}else if(d.preset){
						o[d.id] = ObjectCopy(d.preset);
					}
				}
				_dictionary_define[define_asset[i]] = o;
			}

			// Opera 用アクセスブロック
			_opera_access_block = [ObjectCopy(_dictionary_define.access_block["opera_extension"])];

			// 定義のアスタリスクワードを正規表現化
			var url_filter_asset = [
				"access_block"
			];
			var url_filter_asset_num = url_filter_asset.length;
			for(k=0;k<url_filter_asset_num;k++){
				var define = _dictionary_define[url_filter_asset[k]];
				for(var p in define){
					var filter_regexp = new Array();
					define[p].filter_regexp = filter_regexp;
					var filter = define[p].filter;
					var num = filter.length;
					for(i=0;i<num;i++){
						filter_regexp[i] = StringRegExpListFromAsteriskWord(filter[i]);
					}
				}
			}

			var filter_list_asset = [
				"replacement_to_referer",
				"replacement_to_useragent"
			];
			var filter_list_asset_num = filter_list_asset.length;
			for(k=0;k<filter_list_asset_num;k++){
				var define = _dictionary_define[filter_list_asset[k]];
				for(var p in define){
					var filter = define[p].filter;
					var filter_num = filter.length;
					for(i=0;i<filter_num;i++){
						var url_filter = filter[i].filter;
						var url_filter_num = url_filter.length;
						for(j=0;j<url_filter_num;j++){
							url_filter[j] = StringRegExpListFromAsteriskWord(url_filter[j]);
						}
					}
				}
			}

			// URLマッピングを辞書化
			_dictionary_urlmap = new Array();
			var urlmap = _proj.urlmap;
			urlmap_num = urlmap.length;
			for(j=0;j<urlmap_num;j++){
				var d = urlmap[j];
				var u;
				if(d.user){
					u = d.user;
				}else if(d.preset){
					u = d.preset;
				}

				// 有効
				if(u.enable){
					var o = new Object();
					o.enable_unsecure = u.enable_unsecure;
					o.enable_mixed_content = u.enable_mixed_content;
					o.filter = ObjectCopy(u.filter);
					for(i=0;i<asset_num;i++){
						var p = u[define_asset[i]];
						if(p.enable){
							var id = p.id;
							if(typeof(id) == "object"){
								var a = new Array();
								var id_num = id.length;
								for(k=0;k<id_num;k++){
									a.push(_dictionary_define[define_asset[i]][id[k]]);
								}
								o[define_asset[i]] = a;
							}else{
								o[define_asset[i]] = _dictionary_define[define_asset[i]][id];
							}
						}
					}

					var filter = o.filter;
					var filter_num = filter.length;
					for(i=0;i<filter_num;i++){
						filter[i] = StringRegExpListFromAsteriskWord(filter[i]);
					}

					_dictionary_urlmap.push(o);
				}
			}

			// BBS拡張を辞書化
			_dictionary_expand_bbs = new Array();
			var expand_bbs = _proj.expand_bbs;
			expand_bbs_num = expand_bbs.length;
			for(j=0;j<expand_bbs_num;j++){
				var d = expand_bbs[j];
				var b;
				if(d.user){
					b = ObjectCopy(d.user);
				}else if(d.preset){
					b = ObjectCopy(d.preset);
				}

				// 有効
				if(b.enable){
					var filter = b.filter;
					var filter_num = filter.length;
					for(i=0;i<filter_num;i++){
						filter[i] = RegExpObjectGetRegExp(filter[i]);
					}
					_dictionary_expand_bbs.push(b);
				}
			}
		}

		// --------------------------------------------------------------------------------
		// ユーザーIDを生成（内部用）
		// --------------------------------------------------------------------------------
		function createUserId(ary){
			// 辞書作成
			var dic = new Object();
			var i;
			var num = ary.length;
			for(i=0;i<num;i++){
				dic[ary[i].id] = ary[i];
			}

			// ユニーク名を作成
			i = 0;
			while(dic["user" + i]){
				i++;
			}
			return "user" + i;
		}

		// --------------------------------------------------------------------------------
		// ログ出力が有効であるか
		// --------------------------------------------------------------------------------
		_container.getEnableOutputLog = function(){
			return _proj.standard.enable_output_log;
		};

		// --------------------------------------------------------------------------------
		// 言語を習得
		// --------------------------------------------------------------------------------
		_container.getLanguage = function(){
			try{
				var type = _proj.language.type;
				var code = [
					"ja",	// 日本語
					"en"	// 英語
				];

				if(0 <= type && type < code.length){
					return code[type];
				}
			}catch(e){
			}

			// 自動判定
			var language = NavigatorGetBrowserLanguage();

			return language;
		};

		// --------------------------------------------------------------------------------
		// 有効であるかを取得（内部用）
		// --------------------------------------------------------------------------------
		function getEnable(url){
			var filter = _standard.filter;
			var i;
			var filter_num = filter.length;
			for(i=0;i<filter_num;i++){
				if(StringUrlMatchRegExpList(url,filter[i])){
					if(_standard.filter_allow)	return true;
					return false;
				}
			}
			if(_standard.filter_allow)	return false;
			return true;
		}

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _proj;
		var _key;
		var _standard;
		var _dictionary_expand_bbs;
		var _dictionary_urlmap;
		var _dictionary_define;
		var _url_cache;
		var _opera_access_block;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_key = "PageExpandProject";
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// プロジェクト
	// --------------------------------------------------------------------------------
	function Project(){

		var _container = new Object();

		// --------------------------------------------------------------------------------
		// JSON 文字列からインポート
		// --------------------------------------------------------------------------------
		_container.importJSON = function(json){
			_container.importObject(JsonParse(json));
		};

		// --------------------------------------------------------------------------------
		// オブジェクトからインポート
		// --------------------------------------------------------------------------------
		_container.importObject = function(obj){
			_proj = obj;

			var i;
			var j;
			var k;
			var l;
			var list_num;
			var define;
			var defines;
			var define_num;
			var filter;
			var filters;
			var filter_num;
			var url_filters;
			var url_filter_num;

			// インスタンス化
			defines = _proj.replacement_to_element;
			if(defines){
				define_num = defines.length;
				for(i=0;i<define_num;i++){
					define = defines[i];
					define.script = StringEvalArrayFunction(define.script);
				}
			}

			defines = _proj.replacement_to_text;
			if(defines){
				define_num = defines.length;
				for(i=0;i<define_num;i++){
					define = defines[i];
					define.script = StringEvalArrayFunction(define.script);
				}
			}

			defines = _proj.replacement_to_anchor;
			if(defines){
				define_num = defines.length;
				for(i=0;i<define_num;i++){
					define = defines[i];
					define.script = StringEvalArrayFunction(define.script);
				}
			}

			defines = _proj.replacement_to_link;
			if(defines){
				define_num = defines.length;
				for(i=0;i<define_num;i++){
					define = defines[i];
					filters = define.filter;
					filter_num = filters.length;
					for(j=0;j<filter_num;j++){
						filter = filters[j];
						filter.script = StringEvalArrayFunction(filter.script);
					}
				}
			}

			define = _proj.make_link_to_text;
			if(define){
				define.script = StringEvalArrayFunction(define.script);
			}

			define = _proj.expand_short_url;
			if(define){
				define.script = StringEvalArrayFunction(define.script);
			}

			define = _proj.expand_text;
			if(define){
				define.inline.script_allow = StringEvalArrayFunction(define.inline.script_allow);
				define.inline.script_insert = StringEvalArrayFunction(define.inline.script_insert);
			}

			define = _proj.expand_image;
			if(define){
				define.thumbnail.script_allow = StringEvalArrayFunction(define.thumbnail.script_allow);
				define.thumbnail.script_insert = StringEvalArrayFunction(define.thumbnail.script_insert);
				define.popup.script_allow = StringEvalArrayFunction(define.popup.script_allow);
			}

			define = _proj.expand_sound;
			if(define){
				define.inline.script_allow = StringEvalArrayFunction(define.inline.script_allow);
				define.inline.script_insert = StringEvalArrayFunction(define.inline.script_insert);
				define.audio_element.script_allow = StringEvalArrayFunction(define.audio_element.script_allow);
			}

			define = _proj.expand_video;
			if(define){
				define.inline.script_allow = StringEvalArrayFunction(define.inline.script_allow);
				define.inline.script_insert = StringEvalArrayFunction(define.inline.script_insert);
				define.video_element.script_allow = StringEvalArrayFunction(define.video_element.script_allow);
			}

			define = _proj.expand_iframe;
			if(define){
				define.inline.script_allow = StringEvalArrayFunction(define.inline.script_allow);
				define.inline.script_insert = StringEvalArrayFunction(define.inline.script_insert);
			}

			// 掲示板拡張設定
			var expand_bbs = _proj.expand_bbs;
			if(expand_bbs){
				expand_bbs.script_initialize = StringEvalArrayFunction(expand_bbs.script_initialize);
				expand_bbs.script_callback = StringEvalArrayFunction(expand_bbs.script_callback);
			}

			// アスタリスクワードを正規表現化
			var multi_url_filter_asset = [
				"access_block"
			];
			list_num = multi_url_filter_asset.length;
			for(i=0;i<list_num;i++){
				defines = _proj[multi_url_filter_asset[i]];
				if(defines){
					define_num = defines.length;
					for(j=0;j<define_num;j++){
						define = defines[j];
						url_filters = define.filter;
						url_filter_num = url_filters.length;
						for(k=0;k<url_filter_num;k++){
							url_filters[k] = StringRegExpListFromAsteriskWord(url_filters[k]);
						}
					}
				}
			}

			var single_url_filter_asset = [
				"expand_short_url"
			];
			list_num = single_url_filter_asset.length;
			for(i=0;i<list_num;i++){
				define = _proj[single_url_filter_asset[i]];
				if(define){
					url_filters = define.filter;
					url_filter_num = url_filters.length;
					for(j=0;j<url_filter_num;j++){
						url_filters[j] = StringRegExpListFromAsteriskWord(url_filters[j]);
					}
				}
			}

			var multi_filter_list_asset = [
				"replacement_to_link"
			];
			list_num = multi_filter_list_asset.length;
			for(i=0;i<list_num;i++){
				defines = _proj[multi_filter_list_asset[i]];
				if(defines){
					define_num = defines.length;
					for(j=0;j<define_num;j++){
						define = defines[j];
						filters = define.filter;
						filter_num = filters.length;
						for(k=0;k<filter_num;k++){
							url_filters = filters[k].filter;
							url_filter_num = url_filters.length;
							for(l=0;l<url_filter_num;l++){
								url_filters[l] = StringRegExpListFromAsteriskWord(url_filters[l]);
							}
						}
					}
				}
			}
		};

		// --------------------------------------------------------------------------------
		// オブジェクトからインポート(バックグラウンド用)
		// --------------------------------------------------------------------------------
		_container.importObjectForBackground = function(obj){
			_proj = obj;
		};

		// --------------------------------------------------------------------------------
		// 実行可能であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnable = function(){
			return _proj.enable;
		};

		// --------------------------------------------------------------------------------
		// デバッグモードが有効であるか
		// --------------------------------------------------------------------------------
		_container.getEnableDebugMode = function(){
			return _proj.standard.enable_debug_mode;
		};

		// --------------------------------------------------------------------------------
		// ログ出力が有効であるか
		// --------------------------------------------------------------------------------
		_container.getEnableOutputLog = function(){
			return _proj.standard.enable_output_log;
		};

		// --------------------------------------------------------------------------------
		// アドレスバーアイコンが有効であるか
		// --------------------------------------------------------------------------------
		_container.getEnableIconAddressBar = function(){
			return _proj.standard.enable_icon_address_bar;
		};

		// --------------------------------------------------------------------------------
		// コンテキストメニューが有効か
		// --------------------------------------------------------------------------------
		_container.getEnableContextMenu = function(){
			return _proj.standard.enable_context_menu;
		};

		// --------------------------------------------------------------------------------
		// ロード完了時から動作を開始するか
		// --------------------------------------------------------------------------------
		_container.getEnableStartup = function(){
			return _proj.standard.enable_enable_startup;
		};

		// --------------------------------------------------------------------------------
		// ロードスレッドの最大数
		// --------------------------------------------------------------------------------
		_container.getLoadThreadMax = function(){
			var v = _proj.standard.load_thread_max;
			if(v < 1)	v = 1;
			return v;
		};

		// --------------------------------------------------------------------------------
		// 実行キューの占有時間
		// --------------------------------------------------------------------------------
		_container.getExecuteQueueOccupancyTime = function(){
			var v = _proj.standard.execute_queue.time_occupancy;
			if(v < 0)		v = 0;
			if(v > 5000)	v = 5000;
			return v;
		};
		
		// --------------------------------------------------------------------------------
		// 実行キューのスリープ時間
		// --------------------------------------------------------------------------------
		_container.getExecuteQueueSleepTime = function(){
			var v = _proj.standard.execute_queue.time_sleep;
			if(v < 0)		v = 0;
			if(v > 1000)	v = 1000;
			return v;
		};

		// --------------------------------------------------------------------------------
		// セキュアなページか
		// --------------------------------------------------------------------------------
		_container.getSecureCurrent = function(){
			return _proj.current_secure;
		};

		// --------------------------------------------------------------------------------
		// アンセキュアなアクセスが許可されているか
		// --------------------------------------------------------------------------------
		_container.checkAllowUnsecure = function(url){
			if(_proj.enable_unsecure)	return true;

			if(_proj.current_secure){
				if(url.indexOf("http://") == 0){
					return false;
				}
			}
			return true;
		};

		// --------------------------------------------------------------------------------
		// IFRAME 要素の展開が可能か
		// --------------------------------------------------------------------------------
		_container.checkAllowExpandIframeElement = function(url){
			return true;
		};

		// --------------------------------------------------------------------------------
		// EMBED 要素の展開が可能か
		// --------------------------------------------------------------------------------
		_container.checkAllowExpandEmbedElement = function(url){
			return true;
		};

		// --------------------------------------------------------------------------------
		// アクセス遮断対象か調べる
		// --------------------------------------------------------------------------------
		_container.checkAccessBlock = function(url){
			if(!(_proj.access_block)){
				return false;
			}

			var i;
			var j;
			var filters;
			var filter_num;
			var define;
			var defines = _proj.access_block;
			var define_num = defines.length;
			for(i=0;i<define_num;i++){
				define = defines[i];
				filters = define.filter;
				filter_num = filters.length;
				for(j=0;j<filter_num;j++){
					if(StringUrlMatchRegExpList(url,filters[j])){
						return true;
					}
				}
			}
			return false;
		};

		// --------------------------------------------------------------------------------
		// エレメントの置換が可能であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnableReplacementToElement = function(){
			return _proj.replacement_to_element;
		};

		// --------------------------------------------------------------------------------
		// エレメントの置換用関数を実行
		// --------------------------------------------------------------------------------
		_container.executeScriptReplacementToElement = function(element,response){

			var defines = _proj.replacement_to_element;
			if(!defines)	response({});

			var count = 0;
			var define_num = defines.length;
			var info = {element:element};

			function func(param){
				if(define_num <= count){
					response(param);
					return;
				}

				var define = defines[count];
				count++;

				var ary = define.script;
				var i;
				var num = ary.length;
				for(i=0;i<num;i++){
					if(ary[i](info,func)){
						break;
					}
				}
			}

			func({});
		};

		// --------------------------------------------------------------------------------
		// テキストの置換が可能であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnableReplacementToText = function(){
			return _proj.replacement_to_text;
		};

		// --------------------------------------------------------------------------------
		// テキストの置換用関数を実行
		// --------------------------------------------------------------------------------
		_container.executeScriptReplacementToText = function(element,response){
			var defines = _proj.replacement_to_text;
			if(!defines)	response({});

			var count = 0;
			var define_num = defines.length;
			var info = {text_node:element};

			function func(param){
				if(define_num <= count){
					response(param);
					return;
				}

				var define = defines[count];
				count++;

				var ary = define.script;
				var i;
				var num = ary.length;
				for(i=0;i<num;i++){
					if(ary[i](info,func)){
						break;
					}
				}
			}

			func({});
		};

		// --------------------------------------------------------------------------------
		// アンカーの置換が可能であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnableReplacementToAnchor = function(){
			return _proj.replacement_to_anchor;
		};

		// --------------------------------------------------------------------------------
		// アンカーの置換用関数を実行
		// --------------------------------------------------------------------------------
		_container.executeScriptReplacementToAnchor = function(element,event_dispatcher,response){
			var defines = _proj.replacement_to_anchor;
			if(!defines)	response({});

			var count = 0;
			var define_num = defines.length;
			var info = {anchor_element:element,event_dispatcher:event_dispatcher};

			function func(param){
				if(define_num <= count){
					response(param);
					return;
				}

				var define = defines[count];
				count++;

				var ary = define.script;
				var i;
				var num = ary.length;
				for(i=0;i<num;i++){
					if(ary[i](info,func)){
						break;
					}
				}
			}

			func({});
		};

		// --------------------------------------------------------------------------------
		// ハイパーリンクの置換が可能であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnableReplacementToLink = function(){
			return _proj.replacement_to_link;
		};

		// --------------------------------------------------------------------------------
		// プロジェクトの定義からフィルタを取得
		// --------------------------------------------------------------------------------
		function ProjectDefinesGetFilterFromURL(defines,element){
			var i;
			var define_num = defines.length;
			for(i=0;i<define_num;i++){
				var define = defines[i]
				var filters = define.filter;
				var j;
				var filter_num = filters.length;
				for(j=0;j<filter_num;j++){
					var filter = filters[j];
					var a = filter.filter;
					var k;
					var num = a.length;
					for(k=0;k<num;k++){
						if(StringUrlMatchRegExpList(element.href,a[k])){
							return filter;
						}
					}
				}
			}
			return null;
		}

		// --------------------------------------------------------------------------------
		// リンク置換用オブジェクト取得
		// --------------------------------------------------------------------------------
		_container.getReplacementToLink = function(element){
			var _link_container = new Object();
			
			// --------------------------------------------------------------------------------
			// リンクの変更をアンカーに反映するか
			// --------------------------------------------------------------------------------
			_link_container.getEnableReflectToAnchor = function(){
				if(_filter){
					return _filter.enable_reflect_to_anchor;
				}
				return false;
			};

			// --------------------------------------------------------------------------------
			// キャッシュが有効か
			// --------------------------------------------------------------------------------
			_link_container.getEnableCache = function(){
				if(_filter){
					return _filter.enable_cache;
				}
				return false;
			};

			// --------------------------------------------------------------------------------
			// ハイパーリンクの置換用関数を実行
			// --------------------------------------------------------------------------------
			_link_container.executeScript = function(response){
				var info = {anchor_element:element};
				var ary;
				if(_filter){
					ary = _filter.script;
				}
				if(ary){
					var i;
					var num = ary.length;
					for(i=0;i<num;i++){
						if(ary[i](info,response)){
							break;
						}
					}
				}else{
					response({result:false});
				}
			};

			// --------------------------------------------------------------------------------
			// 結果を取得
			// --------------------------------------------------------------------------------
			_link_container.getResult = function(func){
				var url = element.href;

				// キャッシュ有効
				if(_link_container.getEnableCache()){
					var page = _replacement_to_link_dictionary.getObject(url);

					// キャッシュが無い
					if(!page){
						page = new Object();
						page.complete = false;
						page.event_dispatcher = new EventDispatcher();
						page.result = null;

						_replacement_to_link_dictionary.setObject(url,page);

						// コールバック関数を実行する
						_link_container.executeScript(function(result){
							// イベント発火
							page.event_dispatcher.dispatchEvent("complete",result);
							page.event_dispatcher.removeAll();
							delete page.event_dispatcher;

							page.complete = true;
							page.result = result;

							func(result);
						});

					}else{
						// 実行完了
						if(page.complete){
							func(page.result);
						}else{
							// イベント登録
							var event_handler = page.event_dispatcher.createEventHandler("complete");
							event_handler.setFunction(function(result){
								func(result);
								event_handler.release();
							});
						}
					}
				}else{
					//コールバック関数を実行
					_link_container.executeScript(function(result){
						func(result);
					});
				}
			};

			// --------------------------------------------------------------------------------
			// プライベート変数
			// --------------------------------------------------------------------------------
			var _filter;

			// --------------------------------------------------------------------------------
			// 初期化
			// --------------------------------------------------------------------------------
			(function(){
				_filter = ProjectDefinesGetFilterFromURL(_proj.replacement_to_link,element);
			})();

			return _link_container;
		};

		// --------------------------------------------------------------------------------
		// リンク置換用辞書
		// --------------------------------------------------------------------------------
		function ReplacementToLinkDictionary(){
			var _container = new Object();

			// --------------------------------------------------------------------------------
			// オブジェクトを取得
			// --------------------------------------------------------------------------------
			_container.getObject = function(key){
				return _dictionary[key];
			};

			// --------------------------------------------------------------------------------
			// オブジェクトをセット
			// --------------------------------------------------------------------------------
			_container.setObject = function(key,obj){
				_dictionary[key] = obj;
			};

			// --------------------------------------------------------------------------------
			// プライベート変数
			// --------------------------------------------------------------------------------
			var _dictionary;

			// --------------------------------------------------------------------------------
			// 初期化
			// --------------------------------------------------------------------------------
			_dictionary = new Object();

			return _container;
		}

		// --------------------------------------------------------------------------------
		// リファラの置換が可能であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnableReplacementToReferer = function(){
			return _proj.replacement_to_referer;
		};

		// --------------------------------------------------------------------------------
		// ユーザーエージェントの置換が可能であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnableReplacementToUserAgent = function(){
			return _proj.replacement_to_useragent;
		};

		// --------------------------------------------------------------------------------
		// ハイパーリンク化が可能であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnableMakeLinkToText = function(){
			return _proj.make_link_to_text;
		};

		// --------------------------------------------------------------------------------
		// ハイパーリンク化用関数を実行
		// --------------------------------------------------------------------------------
		_container.executeScriptMakeLinkToText = function(element,response){
			var info = {text_node:element};
			var ary = _proj.make_link_to_text.script;
			var i;
			var num = ary.length;
			for(i=0;i<num;i++){
				if(ary[i](info,response)){
					break;
				}
			}
		};

		// --------------------------------------------------------------------------------
		// 短縮 URL の展開が可能であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnableExpandShortUrl = function(){
			return _proj.expand_short_url;
		};

		// --------------------------------------------------------------------------------
		// 短縮 URL の展開対象か調べる
		// --------------------------------------------------------------------------------
		_container.checkExpandShortUrl = function(url){
			if(!(_proj.expand_short_url)){
				return false;
			}

			var a = _proj.expand_short_url.filter;
			var i;
			var num = a.length;
			for(i=0;i<num;i++){
				if(StringUrlMatchRegExpList(url,a[i])){
					return true;
				}
			}
			return false;
		};

		// --------------------------------------------------------------------------------
		// BBSの展開が可能であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnableExpandBbs = function(){
			if(_proj.expand_bbs){
				return true;
			}
			return false;
		};

		// --------------------------------------------------------------------------------
		// 掲示板拡張ポップアップアニメーションが有効であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnableAnimationPopupBbsResponse = function(){
			return _proj.expand_bbs.popup.enable_animation;
		};

		// --------------------------------------------------------------------------------
		// 掲示板拡張ポップアップの表示座標系を取得
		// --------------------------------------------------------------------------------
		_container.getOriginPopupExpandBbsResponse = function(){
			return _proj.expand_bbs.popup.origin_type;
		};

		// --------------------------------------------------------------------------------
		// 掲示板拡張ポップアップの表示基点を取得
		// --------------------------------------------------------------------------------
		_container.getStylePositionPopupBbsResponse = function(){
			return _proj.expand_bbs.popup.position_type;
		};

		// --------------------------------------------------------------------------------
		// 掲示板拡張ポップアップの表示基点を取得
		// --------------------------------------------------------------------------------
		_container.getPercentPopupBbsResponse = function(){
			return _proj.expand_bbs.popup.percent;
		};

		// --------------------------------------------------------------------------------
		// 掲示板拡張ポップアップの開くまでに待機する時間を取得
		// --------------------------------------------------------------------------------
		_container.getTimeWaitOpenPopupExpandBbsResponse = function(){
			return _proj.expand_bbs.popup.time_wait_open;
		};

		// --------------------------------------------------------------------------------
		// 掲示板拡張ポップアップの閉じるまでに待機する時間を取得
		// --------------------------------------------------------------------------------
		_container.getTimeWaitClosePopupExpandBbsResponse = function(){
			return _proj.expand_bbs.popup.time_wait_close;
		};

		// --------------------------------------------------------------------------------
		// 掲示板拡張レスポンスポップアップ表示のスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandBbsPopupResponse = function(){
			return _proj.expand_bbs.popup.style_sheet;
		};

		// --------------------------------------------------------------------------------
		// 掲示板拡張用初期化関数
		// --------------------------------------------------------------------------------
		_container.initializeScriptCallbackExpandBbs = function(response){
			var info = {work:expand_bbs.work};
			var ary = _proj.expand_bbs.script_initialize;
			var i;
			var num = ary.length;
			for(i=0;i<num;i++){
				if(ary[i](info,response)){
					break;
				}
			}
		};

		// --------------------------------------------------------------------------------
		// 掲示板拡張用コールバック関数
		// --------------------------------------------------------------------------------
		_container.executeScriptCallbackExpandBbs = function(element,response){
			var info = {element:element,work:expand_bbs.work};
			var ary = _proj.expand_bbs.script_callback;
			var i;
			var num = ary.length;
			for(i=0;i<num;i++){
				if(ary[i](info,response)){
					break;
				}
			}
		};

		// --------------------------------------------------------------------------------
		// テキストの展開が可能であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnableExpandText = function(){
			return _proj.expand_text;
		};

		// --------------------------------------------------------------------------------
		// 同一のテキストはインライン展開しない
		// --------------------------------------------------------------------------------
		_container.getDisableSameInlineText = function(){
			if(_proj.expand_text){
				return _proj.expand_text.inline.disable_same_text;
			}
			return false;
		};

		// --------------------------------------------------------------------------------
		//テキストのインライン展開を許可するかコールバック関数
		// --------------------------------------------------------------------------------
		_container.executeScriptAllowInlineText = function(element,url,content_type,response){
			var info = {anchor_element:element,current_element:element,url:url,content_type:content_type};
			var ary = _proj.expand_text.inline.script_allow;
			var i;
			var num = ary.length;
			for(i=0;i<num;i++){
				if(ary[i](info,response)){
					break;
				}
			}
		};

		// --------------------------------------------------------------------------------
		// テキストのインライン展開の挿入コールバック実行
		// --------------------------------------------------------------------------------
		_container.executeScriptInsertInlineText = function(element,textarea,event_dispatcher,response){
			var info = {anchor_element:element,current_element:element,textarea_element:textarea,event_dispatcher:event_dispatcher};
			var ary = _proj.expand_text.inline.script_insert;
			var i;
			var num = ary.length;
			for(i=0;i<num;i++){
				if(ary[i](info,response)){
					break;
				}
			}
		};

		// --------------------------------------------------------------------------------
		// イメージの展開が可能であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnableExpandImage = function(){
			return _proj.expand_image;
		};

		// --------------------------------------------------------------------------------
		// 同一の画像はサムネイル化しない
		// --------------------------------------------------------------------------------
		_container.getDisableSameThumbnailImage = function(){
			if(_proj.expand_image){
				return _proj.expand_image.thumbnail.disable_same_image;
			}
			return false;
		};

		// --------------------------------------------------------------------------------
		// ポップアップアニメーションが有効であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnableAnimationPopupImage = function(){
			if(_proj.expand_image.popup.enable_animation_scale)	return true;
			if(_proj.expand_image.popup.enable_animation_alpha)	return true;
			return false;
		};

		// --------------------------------------------------------------------------------
		// ポップアップアニメーションが有効であるか取得（スケール）
		// --------------------------------------------------------------------------------
		_container.getEnableScaleAnimationPopupImage = function(){
			return _proj.expand_image.popup.enable_animation_scale;
		};

		// --------------------------------------------------------------------------------
		// ポップアップアニメーションが有効であるか取得（アルファ）
		// --------------------------------------------------------------------------------
		_container.getEnableAlphaAnimationPopupImage = function(){
			return _proj.expand_image.popup.enable_animation_alpha;
		};

		// --------------------------------------------------------------------------------
		// サムネイルイメージをポップアップ化するか取得
		// --------------------------------------------------------------------------------
		_container.getEnablePopupMouseoverToThumbnailImage = function(){
			return _proj.expand_image.thumbnail.enable_popup_mouseover;
		};

		// --------------------------------------------------------------------------------
		// イメージのサムネイル展開を許可するかコールバック関数
		// --------------------------------------------------------------------------------
		_container.executeScriptAllowThumbnailImage = function(element,url,content_type,response){
			var info = {anchor_element:element,current_element:element,url:url,content_type:content_type};
			var ary = _proj.expand_image.thumbnail.script_allow;
			var i;
			var num = ary.length;
			for(i=0;i<num;i++){
				if(ary[i](info,response)){
					break;
				}
			}
		};

		// --------------------------------------------------------------------------------
		// サムネイルイメージの挿入コールバック実行
		// --------------------------------------------------------------------------------
		_container.executeScriptInsertThumbnailImage = function(element,image,event_dispatcher,response){
			var info = {anchor_element:element,current_element:element,image_element:image,event_dispatcher:event_dispatcher};
			var ary = _proj.expand_image.thumbnail.script_insert;
			var i;
			var num = ary.length;
			for(i=0;i<num;i++){
				if(ary[i](info,response)){
					break;
				}
			}
		};

		// --------------------------------------------------------------------------------
		// サムネイルイメージのプリロード設定を取得
		// --------------------------------------------------------------------------------
		_container.getEnablePreLoadThumbnailImage = function(){
			if(_proj.expand_image.thumbnail.load_type == "preload")	return true;
			return false;
		};

		// --------------------------------------------------------------------------------
		// ポップアップイメージのプリロード設定を取得
		// --------------------------------------------------------------------------------
		_container.getEnablePreLoadPopupImage = function(){
			if(_proj.expand_image.popup.load_type == "preload")	return true;
			return false;
		};

		// --------------------------------------------------------------------------------
		// ポップアップイメージの表示座標系を取得
		// --------------------------------------------------------------------------------
		_container.getOriginPopupImage = function(){
			return _proj.expand_image.popup.origin_type;
		};

		// --------------------------------------------------------------------------------
		// ポップアップイメージの表示基点を取得
		// --------------------------------------------------------------------------------
		_container.getStylePositionPopupImage = function(){
			return _proj.expand_image.popup.position_type;
		};

		// --------------------------------------------------------------------------------
		// ポップアップイメージの表示サイズを取得
		// --------------------------------------------------------------------------------
		_container.getScalePercentPopupImage = function(){
			return _proj.expand_image.popup.scale_percent;
		};

		// --------------------------------------------------------------------------------
		// ポップアップイメージを開くまでに待機する時間を取得
		// --------------------------------------------------------------------------------
		_container.getTimeWaitOpenPopupImage = function(){
			return _proj.expand_image.popup.time_wait_open;
		};

		// --------------------------------------------------------------------------------
		// ポップアップイメージを閉じるまでに待機する時間を取得
		// --------------------------------------------------------------------------------
		_container.getTimeWaitClosePopupImage = function(){
			return _proj.expand_image.popup.time_wait_close;
		};

		// --------------------------------------------------------------------------------
		// イメージのポップアップ展開を許可するかコールバック関数
		// --------------------------------------------------------------------------------
		_container.executeScriptAllowPopupImage = function(element,url,content_type,response){
			var info = {anchor_element:element,current_element:element,url:url,content_type:content_type};
			var ary = _proj.expand_image.popup.script_allow;
			var i;
			var num = ary.length;
			for(i=0;i<num;i++){
				if(ary[i](info,response)){
					break;
				}
			}
		};

		// --------------------------------------------------------------------------------
		// 縮小イメージのポップアップが可能であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnablePopupReducedImage = function(){
			if(_proj.expand_image){
				return _proj.expand_image.reduced_image.enable_popup;
			}
			return false;
		};

		// --------------------------------------------------------------------------------
		// 縮小イメージのポップアップが有効となる縮小値
		// --------------------------------------------------------------------------------
		_container.getScaleLessThenAllowPopupReducedImage = function(){
			if(_proj.expand_image){
				return _proj.expand_image.reduced_image.popup_allow_slcale_less_then;
			}
			return false;
		};

		// --------------------------------------------------------------------------------
		// イメージのロード通知が有効であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnableLoadNotifyExpandImage = function(){
			if(_proj.expand_image){
				return _proj.expand_image.load.enable_notify;
			}
			return false;
		};

		// --------------------------------------------------------------------------------
		// イメージのアンロードが有効であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnableUnloadExpandImage = function(){
			if(_proj.expand_image){
				return _proj.expand_image.load.enable_unload;
			}
			return false;
		};

		// --------------------------------------------------------------------------------
		// イメージのアンロードサイズを取得
		// --------------------------------------------------------------------------------
		_container.getSizeMoreThenAllowUnloadExpandImage = function(){
			if(_proj.expand_image){
				return _proj.expand_image.load.unload_allow_size_more_then;
			}
			return false;
		};

		// --------------------------------------------------------------------------------
		// サウンドの展開が可能であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnableExpandSound = function(){
			return _proj.expand_sound;
		};

		// --------------------------------------------------------------------------------
		// 同一のオーディオはインライン展開しない
		// --------------------------------------------------------------------------------
		_container.getDisableSameInlineSound = function(){
			if(_proj.expand_sound){
				return _proj.expand_sound.inline.disable_same_audio;
			}
			return false;
		};

		// --------------------------------------------------------------------------------
		// インライン表示オーディオの最大表示数
		// --------------------------------------------------------------------------------
		_container.getSoundMaxInlineSound = function(){
			if(_proj.expand_sound){
				return _proj.expand_sound.inline.sound_max;
			}
			return 0;
		};

		// --------------------------------------------------------------------------------
		//オーディオのインライン展開を許可するかコールバック関数
		// --------------------------------------------------------------------------------
		_container.executeScriptAllowInlineSound = function(element,url,content_type,response){
			var info = {anchor_element:element,current_element:element,url:url,content_type:content_type};
			var ary = _proj.expand_sound.inline.script_allow;
			var i;
			var num = ary.length;
			for(i=0;i<num;i++){
				if(ary[i](info,response)){
					break;
				}
			}
		};

		// --------------------------------------------------------------------------------
		// オーディオのインライン展開の挿入コールバック実行
		// --------------------------------------------------------------------------------
		_container.executeScriptInsertInlineSound = function(element,audio,event_dispatcher,response){
			var info = {anchor_element:element,current_element:element,element:audio,event_dispatcher:event_dispatcher};
			var ary = _proj.expand_sound.inline.script_insert;
			var i;
			var num = ary.length;
			for(i=0;i<num;i++){
				if(ary[i](info,response)){
					break;
				}
			}
		};

		// --------------------------------------------------------------------------------
		// AudioElement の展開を許可するかコールバック関数
		// --------------------------------------------------------------------------------
		_container.executeScriptAllowAudioElement = function(element,url,content_type,response){
			var info = {anchor_element:element,current_element:element,url:url,content_type:content_type};
			var ary = _proj.expand_sound.audio_element.script_allow;
			var i;
			var num = ary.length;
			for(i=0;i<num;i++){
				if(ary[i](info,response)){
					break;
				}
			}
		};

		// --------------------------------------------------------------------------------
		// SoundCloud のプレイヤー (Flash 版) を表示するか
		// --------------------------------------------------------------------------------
		_container.getVisiblePlayerFlashSoundcloud = function(){
			return _proj.expand_sound.soundcloud.visible_player_flash;
		};

		// --------------------------------------------------------------------------------
		// SoundCloud のプレイヤー (HTML5 版) を表示するか
		// --------------------------------------------------------------------------------
		_container.getVisiblePlayerHtml5Soundcloud = function(){
			return _proj.expand_sound.soundcloud.visible_player_html5;
		};

		// --------------------------------------------------------------------------------
		// MixCloud のプレイヤーを表示するか
		// --------------------------------------------------------------------------------
		_container.getVisiblePlayerMixcloud = function(){
			return _proj.expand_sound.mixcloud.visible_player;
		};

		// --------------------------------------------------------------------------------
		// ビデオの展開が可能であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnableExpandVideo = function(){
			return _proj.expand_video;
		};

		// --------------------------------------------------------------------------------
		// 同一のビデオはインライン展開しない
		// --------------------------------------------------------------------------------
		_container.getDisableSameInlineVideo = function(){
			if(_proj.expand_video){
				return _proj.expand_video.inline.disable_same_video;
			}
			return false;
		};

		// --------------------------------------------------------------------------------
		// インライン表示ビデオの最大表示数
		// --------------------------------------------------------------------------------
		_container.getVideoMaxInlineVideo = function(){
			if(_proj.expand_video){
				return _proj.expand_video.inline.video_max;
			}
			return 0;
		};

		// --------------------------------------------------------------------------------
		// ビデオのインライン展開を許可するかコールバック関数
		// --------------------------------------------------------------------------------
		_container.executeScriptAllowInlineVideo = function(element,url,content_type,response){
			var info = {anchor_element:element,current_element:element,url:url,content_type:content_type};
			var ary = _proj.expand_video.inline.script_allow;
			var i;
			var num = ary.length;
			for(i=0;i<num;i++){
				if(ary[i](info,response)){
					break;
				}
			}
		};

		// --------------------------------------------------------------------------------
		// ビデオのインライン展開の挿入コールバック実行
		// --------------------------------------------------------------------------------
		_container.executeScriptInsertInlineVideo = function(element,video,event_dispatcher,response){
			var info = {anchor_element:element,current_element:element,element:video,event_dispatcher:event_dispatcher};
			var ary = _proj.expand_video.inline.script_insert;
			var i;
			var num = ary.length;
			for(i=0;i<num;i++){
				if(ary[i](info,response)){
					break;
				}
			}
		};

		// --------------------------------------------------------------------------------
		// VideoElement の展開を許可するかコールバック関数
		// --------------------------------------------------------------------------------
		_container.executeScriptAllowVideoElement = function(element,url,content_type,response){
			var info = {anchor_element:element,current_element:element,url:url,content_type:content_type};
			var ary = _proj.expand_video.video_element.script_allow;
			var i;
			var num = ary.length;
			for(i=0;i<num;i++){
				if(ary[i](info,response)){
					break;
				}
			}
		};

		// --------------------------------------------------------------------------------
		// youtube のビデオを表示するか
		// --------------------------------------------------------------------------------
		_container.getVisibleVideoYoutube = function(){
			return _proj.expand_video.youtube.visible_video;
		};

		// --------------------------------------------------------------------------------
		// nicovideo のビデオを表示するか
		// --------------------------------------------------------------------------------
		_container.getVisibleVideoNicovideo = function(){
			return _proj.expand_video.nicovideo.visible_video;
		};

		// --------------------------------------------------------------------------------
		// nicovideo のビデオサムネイルを表示するか
		// --------------------------------------------------------------------------------
		_container.getVisibleThumbnailVideoNicovideo = function(){
			return _proj.expand_video.nicovideo.visible_thumbnail_video;
		};

		// --------------------------------------------------------------------------------
		// nicovideo のマイリストサムネイルを表示するか
		// --------------------------------------------------------------------------------
		_container.getVisibleThumbnailMylistNicovideo = function(){
			return _proj.expand_video.nicovideo.visible_thumbnail_mylist;
		};

		// --------------------------------------------------------------------------------
		// nicovideo のユーザーサムネイルを表示するか
		// --------------------------------------------------------------------------------
		_container.getVisibleThumbnailUserNicovideo = function(){
			return _proj.expand_video.nicovideo.visible_thumbnail_user;
		};

		// --------------------------------------------------------------------------------
		// nicovideo のコミュニティサムネイルを表示するか
		// --------------------------------------------------------------------------------
		_container.getVisibleThumbnailCommunityNicovideo = function(){
			return _proj.expand_video.nicovideo.visible_thumbnail_community;
		};

		// --------------------------------------------------------------------------------
		// nicovideo の生放送サムネイルを表示するか
		// --------------------------------------------------------------------------------
		_container.getVisibleThumbnailLiveNicovideo = function(){
			return _proj.expand_video.nicovideo.visible_thumbnail_live;
		};

		// --------------------------------------------------------------------------------
		// nicovideo の静画サムネイルを表示するか
		// --------------------------------------------------------------------------------
		_container.getVisibleThumbnailSeigaNicovideo = function(){
			return _proj.expand_video.nicovideo.visible_thumbnail_seiga;
		};

		// --------------------------------------------------------------------------------
		// ustream の配信ビデオを表示するか
		// --------------------------------------------------------------------------------
		_container.getVisibleVideoLiveUstream = function(){
			return _proj.expand_video.ustream.visible_video_live;
		};

		// --------------------------------------------------------------------------------
		// ustream の録画ビデオを表示するか
		// --------------------------------------------------------------------------------
		_container.getVisibleVideoRecordUstream = function(){
			return _proj.expand_video.ustream.visible_video_record;
		};

		// --------------------------------------------------------------------------------
		// dailymotion の録画ビデオを表示するか
		// --------------------------------------------------------------------------------
		_container.getVisibleVideoDailymotion = function(){
			return _proj.expand_video.dailymotion.visible_video;
		};

		// --------------------------------------------------------------------------------
		// vimeo の録画ビデオを表示するか
		// --------------------------------------------------------------------------------
		_container.getVisibleVideoVimeo = function(){
			return _proj.expand_video.vimeo.visible_video;
		};

		// --------------------------------------------------------------------------------
		// fc2video の録画ビデオを表示するか
		// --------------------------------------------------------------------------------
		_container.getVisibleVideoFc2video = function(){
			return _proj.expand_video.fc2video.visible_video;
		};

		// --------------------------------------------------------------------------------
		// LiveLeak の録画ビデオを表示するか
		// --------------------------------------------------------------------------------
		_container.getVisibleVideoLiveleak = function(){
			return _proj.expand_video.liveleak.visible_video;
		};

		// --------------------------------------------------------------------------------
		// テキストインライン表示のスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandTextInline = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_text.inline;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// サムネイルイメージのスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandImageThumbnail = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_image.thumbnail;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// ポップアップイメージのスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandImagePopup = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_image.popup;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// サウンドインライン表示のスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandSoundInlineAudioElement = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_sound.inline.audio_element.audio;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// SoundCloud インライン表示 Flash 版プレイヤーのスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandSoundSoundcloudInlinePlayerFlash = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_sound.inline.soundcloud.player_flash;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// SoundCloud インライン表示 HTML5 版プレイヤーのスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandSoundSoundcloudInlinePlayerHtml5 = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_sound.inline.soundcloud.player_html5;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// MixCloud インライン表示プレイヤーのスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandSoundMixcloudInlinePlayer = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_sound.inline.mixcloud.player;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// ビデオインライン表示のスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandVideoInlineVideoElement = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_video.inline.video_element.video;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// youtube インライン表示ビデオのスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandVideoYoutubeInlineVideo = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_video.inline.youtube.video;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// nicovideo ビデオのインライン表示のスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandVideoNicovideoInlineVideo = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_video.inline.nicovideo.video;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// nicovideo ビデオサムネイルのインライン表示のスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandVideoNicovideoInlineThumbnailVideo = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_video.inline.nicovideo.thumbnail_video;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// nicovideo マイリストサムネイルのインライン表示のスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandVideoNicovideoInlineThumbnailMylist = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_video.inline.nicovideo.thumbnail_mylist;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// nicovideo ユーザーサムネイルのインライン表示のスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandVideoNicovideoInlineThumbnailUser = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_video.inline.nicovideo.thumbnail_user;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// nicovideo コミュニティサムネイルのインライン表示のスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandVideoNicovideoInlineThumbnailCommunity = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_video.inline.nicovideo.thumbnail_community;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// nicovideo 生放送サムネイルのインライン表示のスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandVideoNicovideoInlineThumbnailLive = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_video.inline.nicovideo.thumbnail_live;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// nicovideo 静画サムネイルのインライン表示のスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandVideoNicovideoInlineThumbnailSeiga = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_video.inline.nicovideo.thumbnail_seiga;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// ustream 配信ビデオのインライン表示のスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandVideoUstreamInlineVideoLive = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_video.inline.ustream.video_live;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// ustream 録画ビデオのインライン表示のスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandVideoUstreamInlineVideoRecord = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_video.inline.ustream.video_record;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// dailymotion インライン表示ビデオのスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandVideoDailymotionInlineVideo  = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_video.inline.dailymotion.video;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// vimeo インライン表示ビデオのスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandVideoVimeoInlineVideo = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_video.inline.vimeo.video;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// fc2video インライン表示ビデオのスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandVideoFc2videoInlineVideo = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_video.inline.fc2video.video;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// LiveLeak インライン表示ビデオのスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandVideoLiveleakInlineVideo = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_video.inline.liveleak.video;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// インラインフレームのインライン表示のスタイルシート
		// --------------------------------------------------------------------------------
		_container.getStyleSheetExpandIframeInline = function(){
			if(_proj.style_sheet){
				return _proj.style_sheet.expand_iframe.inline;
			}
			return "";
		};

		// --------------------------------------------------------------------------------
		// インラインフレームの展開が可能であるか取得
		// --------------------------------------------------------------------------------
		_container.getEnableExpandIframe = function(){
			return _proj.expand_iframe;
		};

		// --------------------------------------------------------------------------------
		// 同一のインラインフレームはインライン展開しない
		// --------------------------------------------------------------------------------
		_container.getDisableSameInlineIframe = function(){
			if(_proj.expand_iframe){
				return _proj.expand_iframe.inline.disable_same_iframe;
			}
			return false;
		};

		// --------------------------------------------------------------------------------
		// インラインフレームのインライン展開を許可するかコールバック関数
		// --------------------------------------------------------------------------------
		_container.executeScriptAllowInlineIframe = function(element,url,content_type,response){
			var info = {anchor_element:element,current_element:element,url:url,content_type:content_type};
			var ary = _proj.expand_iframe.inline.script_allow;
			var i;
			var num = ary.length;
			for(i=0;i<num;i++){
				if(ary[i](info,response)){
					break;
				}
			}
		};

		// --------------------------------------------------------------------------------
		// インラインフレームのインライン展開の挿入コールバック実行
		// --------------------------------------------------------------------------------
		_container.executeScriptInsertInlineIframe = function(element,iframe,event_dispatcher,response){
			var info = {anchor_element:element,current_element:element,iframe_element:iframe,event_dispatcher:event_dispatcher};
			var ary = _proj.expand_iframe.inline.script_insert;
			var i;
			var num = ary.length;
			for(i=0;i<num;i++){
				if(ary[i](info,response)){
					break;
				}
			}
		};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _proj;
		var _replacement_to_link_dictionary;
		

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_proj = new Object();
			_replacement_to_link_dictionary = new ReplacementToLinkDictionary();
		})();

		return _container;
	}


	// --------------------------------------------------------------------------------
	// PageExpand デバッグ
	// --------------------------------------------------------------------------------
	function PageExpandDebug(){

		var _container = new Object();

		// --------------------------------------------------------------------------------
		// 解放
		// --------------------------------------------------------------------------------
		function release(){
			if(_analyze_work){
				// 解析辞書除外
				analyze_work_dictionary.removeAnalyzeWork(_analyze_work);
				_analyze_work = null;
			}

			// リムーブ監視を破棄
			if(_observer_remove){
				_observer_remove.release();
				_observer_remove = null;
			}

			// タスク解放
			if(_task){
				_task.release();
				_task = null;
			}

			// ウィンドウ破棄
			if(_window){
				DomNodeRemove(_window);
				_window = null;
			}
		}

		// --------------------------------------------------------------------------------
		// 要素生成
		// --------------------------------------------------------------------------------
		function createElement(){
			// 解放
			release();

			// ウィンドウ
			var style;
			var container = DocumentCreateElement("div");
			ElementSetStyle(container,"width:220px;border:3px #888 outset; padding:0px; margin:0px; right:5px; bottom:5px; position:fixed; text-align:left; color:#000; font-size:12px; line-height:1.0; z-index:2147483647;");
			_window = container;

			// 解析ワーク作成
			_analyze_work = AnalyzeWorkCreate(_window);
			// 解析無効化
			AnalyzeWorkSetInvalid(_analyze_work);
			// 解析辞書登録
			analyze_work_dictionary.attachAnalyzeWork(_analyze_work,true);

			// リムーブ監視
			_observer_remove = new DomNodeObserverRemoveFromDocument(_window);
			_observer_remove.setFunction(release);

			var background = DocumentCreateElement("div");
			ElementSetStyle(background,"background-color:#FFF; line-height:1.0; border:1px #ccc solid; padding:0px; margin:0px; opacity:0.8;");
			container.appendChild(background);

			// PageExpandDebug
			var debug_msg = DocumentCreateElement("div");
			ElementSetStyle(debug_msg,"font-weight:bold; text-align:left; color:#000; line-height:1.0; background-color:#ccc; padding:2px 5px; margin:0px 0px 2px; position:relative;");
			ElementSetTextContent(debug_msg,"PageExpand Debug");
			background.appendChild(debug_msg);

			// 閉じるボタン
			var close_msg = DocumentCreateElement("div");
			ElementSetStyle(close_msg,"width:12px; position:absolute; right:1px; top:1px; bottom:1px; border:1px #888 solid; background:#ddd; line-height:1.0;");
			ElementSetTextContent(close_msg,"");
			debug_msg.appendChild(close_msg);
			close_msg.onclick = function(){
				release();
			};

			var element;
			var css_text_msg = "text-align:left; color:#000; font-size:12px; line-height:1.0;";
			var css_text_meter = "height:2px; min-height:0; border:1px #888 solid; margin:0px 5px 2px; line-height:1.0;";
			var css_text_bar = "height:2px; min-height:0; background-color :#888; margin:0px 0px 2px; width:0%; line-height:1.0;";

			// 実行キュー数
			element = DocumentCreateElement("div");
			ElementSetStyle(element,"margin:0px 5px 0px; " + css_text_msg);
			background.appendChild(element);
			var execute_queue_msg = DocumentCreateText("");
			element.appendChild(execute_queue_msg);

			// 実行キューエラー数
			element = DocumentCreateElement("div");
			ElementSetStyle(element,"margin:0px 5px 2px; " + css_text_msg);
			background.appendChild(element);
			var execute_queue_error_msg = DocumentCreateText("");
			element.appendChild(execute_queue_error_msg);

			// ローダーキュー数
			element = DocumentCreateElement("div");
			ElementSetStyle(element,"margin:0px 5px 0px; " + css_text_msg);
			background.appendChild(element);
			var loader_queue_msg = DocumentCreateText("");
			element.appendChild(loader_queue_msg);

			// ローダーキューエラー数
			element = DocumentCreateElement("div");
			ElementSetStyle(element,"margin:0px 5px 2px; " + css_text_msg);
			background.appendChild(element);
			var loader_queue_error_msg = DocumentCreateText("");
			element.appendChild(loader_queue_error_msg);

			// ローダースレッド数
			element = DocumentCreateElement("div");
			ElementSetStyle(element,"margin:0px 5px 1px; " + css_text_msg);
			background.appendChild(element);
			var loader_thread_msg = DocumentCreateText("");
			element.appendChild(loader_thread_msg);

			// ローダースレッドメーター
			var loader_thread_meter = DocumentCreateElement("div");
			ElementSetStyle(loader_thread_meter,css_text_meter);
			background.appendChild(loader_thread_meter);

			// ローダースレッドバー
			var loader_thread_bar = DocumentCreateElement("div");
			ElementSetStyle(loader_thread_bar,css_text_bar);
			loader_thread_meter.appendChild(loader_thread_bar);

			// タスク数
			element = DocumentCreateElement("div");
			ElementSetStyle(element,"margin:0px 5px 2px; " + css_text_msg);
			background.appendChild(element);
			var task_count_msg = DocumentCreateText("");
			element.appendChild(task_count_msg);

			// イメージ数
			element = DocumentCreateElement("div");
			ElementSetStyle(element,"margin:0px 5px 2px; " + css_text_msg);
			background.appendChild(element);
			var image_count_msg = DocumentCreateText("");
			element.appendChild(image_count_msg);

			// イメージスレッド数
			element = DocumentCreateElement("div");
			ElementSetStyle(element,"margin:0px 5px 1px; " + css_text_msg);
			background.appendChild(element);
			var image_thread_msg = DocumentCreateText("");
			element.appendChild(image_thread_msg);

			// イメージスレッドメーター
			var image_thread_meter = DocumentCreateElement("div");
			ElementSetStyle(image_thread_meter,css_text_meter);
			background.appendChild(image_thread_meter);

			// イメージスレッドバー
			var image_thread_bar = DocumentCreateElement("div");
			ElementSetStyle(image_thread_bar,css_text_bar);
			image_thread_meter.appendChild(image_thread_bar);

			// サウンド数
			element = DocumentCreateElement("div");
			ElementSetStyle(element,"margin:0px 5px 2px; " + css_text_msg);
			background.appendChild(element);
			var sound_count_msg = DocumentCreateText("");
			element.appendChild(sound_count_msg);

			// サウンドスレッド数
			element = DocumentCreateElement("div");
			ElementSetStyle(element,"margin:0px 5px 1px; " + css_text_msg);
			background.appendChild(element);
			var sound_thread_msg = DocumentCreateText("");
			element.appendChild(sound_thread_msg);

			// サウンドスレッドメーター
			var sound_thread_meter = DocumentCreateElement("div");
			ElementSetStyle(sound_thread_meter,css_text_meter);
			background.appendChild(sound_thread_meter);

			// サウンドスレッドバー
			var sound_thread_bar = DocumentCreateElement("div");
			ElementSetStyle(sound_thread_bar,css_text_bar);
			sound_thread_meter.appendChild(sound_thread_bar);

			// ビデオ数
			element = DocumentCreateElement("div");
			ElementSetStyle(element,"margin:0px 5px 2px; " + css_text_msg);
			background.appendChild(element);
			var video_count_msg = DocumentCreateText("");
			element.appendChild(video_count_msg);

			// ビデオスレッド数
			element = DocumentCreateElement("div");
			ElementSetStyle(element,"margin:0px 5px 1px; " + css_text_msg);
			background.appendChild(element);
			var video_thread_msg = DocumentCreateText("");
			element.appendChild(video_thread_msg);

			// ビデオスレッドメーター
			var video_thread_meter = DocumentCreateElement("div");
			ElementSetStyle(video_thread_meter,css_text_meter);
			background.appendChild(video_thread_meter);

			// ビデオスレッドバー
			var video_thread_bar = DocumentCreateElement("div");
			ElementSetStyle(video_thread_bar,css_text_bar);
			video_thread_meter.appendChild(video_thread_bar);

			// リムーブ監視数
			element = DocumentCreateElement("div");
			ElementSetStyle(element,"margin:0px 5px 2px; " + css_text_msg);
			background.appendChild(element);
			var observer_remove_msg = DocumentCreateText("");
			element.appendChild(observer_remove_msg);

			// スクロール監視数
			element = DocumentCreateElement("div");
			ElementSetStyle(element,"margin:0px 5px 2px; " + css_text_msg);
			background.appendChild(element);
			var observer_scroll_msg = DocumentCreateText("");
			element.appendChild(observer_scroll_msg);

			// アンカーモニター数
			element = DocumentCreateElement("div");
			ElementSetStyle(element,"margin:0px 5px 2px; " + css_text_msg);
			background.appendChild(element);
			var anchor_monitor_msg = DocumentCreateText("");
			element.appendChild(anchor_monitor_msg);

			// アドレス数
			element = DocumentCreateElement("div");
			ElementSetStyle(element,"margin:0px 5px 2px; " + css_text_msg);
			background.appendChild(element);
			var address_count_msg = DocumentCreateText("");
			element.appendChild(address_count_msg);

			// タスク実行
			_task = task_container.createTask();
			_task.setExecuteFunc(function(task){

				// 表示更新
				DomNodeSetNodeValue(execute_queue_msg,"execute queue: " + execute_queue.getCountQueue());
				DomNodeSetNodeValue(execute_queue_error_msg,"execute queue error: " + execute_queue.getCountError());
				DomNodeSetNodeValue(loader_queue_msg,"loader queue: " + loader_queue.getCountQueue());
				DomNodeSetNodeValue(loader_queue_error_msg,"loader queue error: " + loader_queue.getCountError());
				DomNodeSetNodeValue(loader_thread_msg,"loader thread: " + loader_queue.getCountThread() + " / " + loader_queue.getMaxThread());
				var loader_percent;
				if(loader_queue.getMaxThread() == 0){
					loader_percent = 0;
				}else{
					loader_percent = Math.floor(loader_queue.getCountThread() / loader_queue.getMaxThread() * 100);
				}
				loader_thread_bar.style.width = loader_percent + "%";

				DomNodeSetNodeValue(task_count_msg,"task count: " + task_container.getCountTask());

				var use_size = Math.floor(element_limitter_image.getByteSizeNow() / 1024 / 1024 * 100) / 100;
				DomNodeSetNodeValue(image_count_msg,"image size: " + use_size);
				DomNodeSetNodeValue(image_thread_msg,"image thread: " + element_limitter_image.getCountUse() + " / " + element_limitter_image.getCount());
				var image_percent;
				if(element_limitter_image.getCount() == 0){
					image_percent = 0;
				}else{
					image_percent = Math.floor(element_limitter_image.getCountUse() / element_limitter_image.getCount() * 100);
				}
				image_thread_bar.style.width = image_percent + "%";

				DomNodeSetNodeValue(sound_count_msg,"sound count: " + element_limitter_sound.getCount());
				DomNodeSetNodeValue(sound_thread_msg,"sound thread: " + element_limitter_sound.getCountUse() + " / " + element_limitter_sound.getMaxUse());
				var sound_percent;
				if(element_limitter_sound.getMaxUse() == 0){
					sound_percent = 0;
				}else{
					sound_percent = Math.floor(element_limitter_sound.getCountUse() / element_limitter_sound.getMaxUse() * 100);
				}
				sound_thread_bar.style.width = sound_percent + "%";

				DomNodeSetNodeValue(video_count_msg,"video count: " + element_limitter_video.getCount());
				DomNodeSetNodeValue(video_thread_msg,"video thread: " + element_limitter_video.getCountUse() + " / " + element_limitter_video.getMaxUse());
				var video_percent;
				if(element_limitter_video.getMaxUse() == 0){
					video_percent = 0;
				}else{
					video_percent = Math.floor(element_limitter_video.getCountUse() / element_limitter_video.getMaxUse() * 100);
				}
				video_thread_bar.style.width = video_percent + "%";

				DomNodeSetNodeValue(observer_remove_msg,"observer remove: " + document_observer_remove_node.getCount());
				DomNodeSetNodeValue(observer_scroll_msg,"observer scroll: " + document_observer_scroll.getCount());
				DomNodeSetNodeValue(anchor_monitor_msg,"observer anchor: " + anchor_monitor.getCount());
				DomNodeSetNodeValue(address_count_msg,"src count: " + address_collection.getCountAddress());
			});

			_task.execute(0xffffffff);

			document.body.appendChild(_window);
		}

		// --------------------------------------------------------------------------------
		// 表示をセット
		// --------------------------------------------------------------------------------
		_container.setVisible = function (type){
			_visible = type;
			if(_visible){
				// フレーム内では動作させない
				if (WindowGetInFrame()){
				}else{
					createElement();
				}
			}else{
				release();
			}
		};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _window;
		var _task;
		var _analyze_work;
		var _observer_remove;
		var _visible;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_visible = false;
		})();

		return _container;
	}


	// --------------------------------------------------------------------------------
	// PageExpand の解析が有効であるか
	// --------------------------------------------------------------------------------
	function PageExpandSetEnableAnalyze(type){
		enable_analyze = type;
	}

	// --------------------------------------------------------------------------------
	// コンテンツタイプをセット
	// --------------------------------------------------------------------------------
	function DomNodeSetContentType(node,type){
		// 解析ワーク取得
		var work = analyze_work_dictionary.getAnalyzeWork(node);
		if(work){
			AnalyzeWorkAddContentType(work,type);
		}
	}
	function DomNodeGetContentType(node){
		// 解析ワーク取得
		var work = analyze_work_dictionary.getAnalyzeWork(node);
		if(work){
			var ary = AnalyzeWorkGetContentType(work);
			if(ary){
				return ary.join(",");
			}
		}

		return "";
	}

	// --------------------------------------------------------------------------------
	// 「掲示板拡張」の解析状況
	// --------------------------------------------------------------------------------
	function DomNodeSetCompletedExpandBbs(node){}

	// --------------------------------------------------------------------------------
	// 「テキストの置換」の解析状況
	// --------------------------------------------------------------------------------
	function DomNodeSetCompletedReplacementToText(node){}

	// --------------------------------------------------------------------------------
	// 「挿入済み」の解析状況
	// --------------------------------------------------------------------------------
	function DomNodeClearInserted(node){ ObjectDeleteProperty(node,"_pageexpand_inserted"); }
	function DomNodeSetInserted(node){ try{ node._pageexpand_inserted = true; }catch(e){} }
	function DomNodeGetInserted(node){ try{ if(node._pageexpand_inserted){ return true; } }catch(e){} return false; }

	// --------------------------------------------------------------------------------
	// 正規表現オブジェクトを作成
	// --------------------------------------------------------------------------------
	function RegExpObjectCreate(){
		return {
			pattern:"",
			flags:{i:false,g:false}
		};
	}

	// --------------------------------------------------------------------------------
	// 正規表現オブジェクトから RegExp を生成
	// --------------------------------------------------------------------------------
	function RegExpObjectGetRegExp(obj){
		try{
			return new RegExp(obj.pattern,(obj.flags.g ? "g":"") + (obj.flags.i ? "i":""));
		}catch(e){
			return null;
		}
	}

	// --------------------------------------------------------------------------------
	// 正規表現オブジェクトからエラーを取得
	// --------------------------------------------------------------------------------
	function RegExpObjectGetError(obj){
		try{
			var regexp = new RegExp(obj.pattern,(obj.flags.g ? "g":"") + (obj.flags.i ? "i":""));
			return "";
		}catch(e){
			return e;
		}
	}

	// --------------------------------------------------------------------------------
	// ポップアップイメージ
	// --------------------------------------------------------------------------------
	function PopupImage(image){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// 開放
		// --------------------------------------------------------------------------------
		_container.release = function(){
			if(!_image)	return;

			// クリックイベントを外す
			removeEventClick();

			// マウスイベントを外す
			removeEventMouseOver();

			// リリースイベントを外す
			removeEventRelease();

			// タスクを破棄
			if(_task){
				_task.release();
				_task = null;
			}

			// 解析辞書除外
			analyze_work_dictionary.removeAnalyzeWork(_analyze_work);

			_image = null;
		};

		// --------------------------------------------------------------------------------
		// 自殺
		// --------------------------------------------------------------------------------
		_container.suicide = function(){
			if(_task){
				_container.setElementHitArea(null);
				_suicide = true;
			}else{
				_container.release();
			}
		};

		// --------------------------------------------------------------------------------
		// 親をセット
		// --------------------------------------------------------------------------------
		_container.setElementParent = function(element){
			_element_parent = element;
		};

		// --------------------------------------------------------------------------------
		// リンクをセット
		// --------------------------------------------------------------------------------
		_container.setElementAnchor = function(element){
			_element_anchor = element;
		};

		// --------------------------------------------------------------------------------
		// 当たり判定用エレメントをセット
		// --------------------------------------------------------------------------------
		_container.setElementHitArea = function(element){
			// マウスイベントを外す
			removeEventMouseOver();
			// リリースイベントを外す
			removeEventRelease();

			_element_hit_area = element;

			// マウスイベントを開始
			addEventMouseOver();
			// リリースイベントを開始
			addEventRelease();
		};

		// --------------------------------------------------------------------------------
		// 開始範囲用エレメントをセット
		// --------------------------------------------------------------------------------
		_container.setElementBeginArea = function(element){
			_element_begin_area = element;
		};

		// --------------------------------------------------------------------------------
		// トリミング範囲をセット
		// --------------------------------------------------------------------------------
		_container.setTrimRect = function(rect){
			if(!_trim_rect){
				// クリックイベントを外す
				removeEventClick();

				var div = DocumentCreateElement("div");
				// スタイルをセット
				ElementSetStyle(div,
					"overflow:hidden;"
				);
				// スタイルを追加
				ElementAddStyle(_element_current,project.getStyleSheetExpandImagePopup());
				div.appendChild(_image);
				_element_current = div;

				// クリックイベント
				addEventClick();
			}

			_trim_rect = ObjectCopy(rect);
			_trim_rect.width  = _trim_rect.right - _trim_rect.left;
			_trim_rect.height = _trim_rect.bottom - _trim_rect.top;
		};

		// --------------------------------------------------------------------------------
		// ポップアップ
		// --------------------------------------------------------------------------------
		_container.popup = function(element){
			mouseOver(null);
		};

		// --------------------------------------------------------------------------------
		// マウスオーバーイベントを追加（内部用）
		// --------------------------------------------------------------------------------
		function addEventMouseOver(){
			if(!_element_hit_area) return;

			removeEventMouseOver();

			if(_element_hit_area.addEventListener){
				_element_hit_area.addEventListener("mouseover",mouseOver,false);
			}else if(_element_hit_area.attachEvent){
				_element_hit_area.attachEvent("onmouseover",mouseOver);
			}
		}

		// --------------------------------------------------------------------------------
		// マウスオーバーイベントを外す（内部用）
		// --------------------------------------------------------------------------------
		function removeEventMouseOver(){
			if(!_element_hit_area) return;

			if(_element_hit_area.removeEventListener){
				_element_hit_area.removeEventListener("mouseover",mouseOver,false);
			}else if(_element_hit_area.detachEvent){
				_element_hit_area.detachEvent("onmouseover",mouseOver);
			}
		}

		// --------------------------------------------------------------------------------
		// クリックイベントを追加（内部用）
		// --------------------------------------------------------------------------------
		function addEventClick(){
			removeEventClick();

			if(_element_current.addEventListener){
				_element_current.addEventListener("click",_container.release,false);
			}else if(_element_current.attachEvent){
				_element_current.attachEvent("onclick",_container.release);
			}
		}

		// --------------------------------------------------------------------------------
		// クリックイベントを外す（内部用）
		// --------------------------------------------------------------------------------
		function removeEventClick(){
			if(_element_current.removeEventListener){
				_element_current.removeEventListener("click",_container.release,false);
			}else if(_element_current.detachEvent){
				_element_current.detachEvent("onclick",_container.release);
			}
		}

		// --------------------------------------------------------------------------------
		// リリースイベントを追加（内部用）
		// --------------------------------------------------------------------------------
		function addEventRelease(){
			if(!_element_hit_area) return;

			removeEventRelease();

			if(!_observer_remove){
				// リムーブ監視
				_observer_remove = new DomNodeObserverRemoveFromDocument(_element_hit_area);
				_observer_remove.setFunction(_container.suicide);
			}
		}

		// --------------------------------------------------------------------------------
		// リリースイベントを外す（内部用）
		// --------------------------------------------------------------------------------
		function removeEventRelease(){
			if(_observer_remove){
				// 監視を破棄
				_observer_remove.release();
				_observer_remove = null;
			}
		}

		// --------------------------------------------------------------------------------
		// マウスオーバーイベント（内部用）
		// --------------------------------------------------------------------------------
		function mouseOver(e){
			if(e){
				// マウス入力を更新
				input_mouse.setMouseEvent(e);
			}

			// 再構築
			if(_task){
				var work = _task.getUserWork();
				switch(work.type){
				case "fade_out":
					_task.setExecuteFunc(PopupImageClose);
					_task.execute(0xffffffff);
					break;
				}
			}

			// Shift キー押下で無視
			if(input_mouse.getKeyShift())	return;

			// ドラッグ中は無視
			if(input_mouse.getButtonLeft())	return;

			// タスクを生成
			if(!_task){
				_task = task_container.createTask();
				_task.setDestructorFunc(PopupImageDestructor);
				_task.setExecuteFunc(PopupImageInitialize);
				_task.execute(0xffffffff);
			}
		}

		// --------------------------------------------------------------------------------
		// マウスムーブ（内部用）
		// --------------------------------------------------------------------------------
		function mouseMove(){
			if(!_task)	return;

			var work = _task.getUserWork();
			var mouse_pos = ObjectCopy(input_mouse.getPositionClient());

			var hit = false;
			if(_element_hit_area){
				hit = ElementHitTestPosition(_element_hit_area,mouse_pos,true);
			}
			if(!hit){
				if(_element_rects_tree){
					var scroll_pos = DocumentGetScrollPos();
					mouse_pos.x += scroll_pos.x - _scroll_pos_begin.x;
					mouse_pos.y += scroll_pos.y - _scroll_pos_begin.y;
					hit = _element_rects_tree.hitTestPosition(mouse_pos,true);
					if(!hit) _element_rects_tree = null;
				}
			}

			// アニメーション
			if(project.getEnableAnimationPopupImage()){
				if(hit){
					switch(work.type){
					case "wait_before_close":
						// 表示へ
						_task.setExecuteFunc(PopupImageShowInit);
						_task.execute(0xffffffff);
						break;
					case "fade_out":
						// 開く
						_task.setExecuteFunc(PopupImageBeforeOpenInit);
						_task.execute(0xffffffff);
						break;
					}
				}else{
					switch(work.type){
					case "wait_before_open":
						// 閉じる
						_task.setExecuteFunc(PopupImageClose);
						_task.execute(0xffffffff);
						break;
					case "fade_in":
						// フェードアウトへ
						_task.setExecuteFunc(PopupImageFadeOut);
						_task.execute(0xffffffff);
						break;
					case "show":
						// フェードアウト待機へ
						_task.setExecuteFunc(PopupImageWaitBeforeClose);
						_task.execute(0xffffffff);
						break;
					}
				}
			}else{
				if(hit){
					switch(work.type){
					case "wait_before_close":
						// 表示へ
						_task.setExecuteFunc(PopupImageShowInit);
						_task.execute(0xffffffff);
						break;
					}
				}else{
					switch(work.type){
					case "wait_before_open":
						// 閉じる
						_task.setExecuteFunc(PopupImageClose);
						_task.execute(0xffffffff);
						break;
					case "show":
						// フェードアウト待機へ
						_task.setExecuteFunc(PopupImageWaitBeforeClose);
						_task.execute(0xffffffff);
						break;
					}
				}
			}
		}

		// --------------------------------------------------------------------------------
		// スクロール補正（内部用）
		// --------------------------------------------------------------------------------
		function reviseScroll(vec){
			if(_task){
				var work = _task.getUserWork();
				var begin_rect = work.begin_rect;
				var end_rect = work.end_rect;

				begin_rect.left   += vec.x;
				begin_rect.right  += vec.x;
				begin_rect.top    += vec.y;
				begin_rect.bottom += vec.y;
				end_rect.left   += vec.x;
				end_rect.right  += vec.x;
				end_rect.top    += vec.y;
				end_rect.bottom += vec.y;

				PopupImageSizeUpdate(_task);
			}
		}

		// --------------------------------------------------------------------------------
		// 初期化（内部用）
		// --------------------------------------------------------------------------------
		function PopupImageInitialize(task){
			var work = task.getUserWork();

			work.type = "initialize";
			work.anime_pos = 0.0;
			work.anime_spd = 0.0;

			_element_rects_tree = null;
			if(_element_hit_area){
				_element_rects_tree = new ElementClientRectsTree(_element_hit_area);
				_scroll_pos_begin = DocumentGetScrollPos();
			}

			task.setExecuteFunc(PopupImageBeforeOpenInit);
			task.execute(0xffffffff);
		}


		// --------------------------------------------------------------------------------
		// オープン前待機（内部用）
		// --------------------------------------------------------------------------------
		function PopupImageBeforeOpenInit(task){
			var work = task.getUserWork();

			work.type = "wait_before_open";
			work.frame = project.getTimeWaitOpenPopupImage() / 1000 * 60;

			task.setExecuteFunc(PopupImageBeforeOpenExec);
			task.execute(0xffffffff);
		}
		function PopupImageBeforeOpenExec(task){
			var work = task.getUserWork();

			// マウスムーブ
			mouseMove();

			work.frame -= 1;
			if(work.frame < 0){
				task.setExecuteFunc(PopupImageOpen);
				task.execute(0xffffffff);
				return;
			}
		}

		// --------------------------------------------------------------------------------
		// ポップアップイメージを開く（内部用）
		// --------------------------------------------------------------------------------
		function PopupImageOpen(task){
			var work = task.getUserWork();

			work.type = "open";

			// デフォルトのスタイル
			ElementSetStyle(_image,
				"background:rgba(0, 0, 0, 0) none repeat scroll 0% 0% / auto padding-box border-box;" +
				"border:0px none rgb(0, 0, 0);" +
				"box-shadow:none;" +
				"box-sizing:content-box;" +
				"caption-side:top;" +
				"clear:none;" +
				"clip:auto;" +
				"color:rgb(0, 0, 0);" +
				"cursor:auto;" +
				"direction:ltr;" +
				"display:inline;" +
				"empty-cells:show;" +
				"float:none;" +
				"height:0px;" +
				"image-rendering:auto;" +
				"left:auto;" +
				"letter-spacing:normal;" +
				"line-height:normal;" +
				"list-style-image:none;" +
				"list-style-position:outside;" +
				"list-style-type:disc;" +
				"margin:0px;" +
				"max-height:none;" +
				"max-width:none;" +
				"min-height:0px;" +
				"min-width:0px;" +
				"opacity:1;" +
				"orphans:auto;" +
				"outline:rgb(0, 0, 0) none 0px;" +
				"overflow:visible;" +
				"padding:0px;" +
				"page-break-after:auto;" +
				"page-break-before:auto;" +
				"page-break-inside:auto;" +
				"position:static;" +
				"resize:none;" +
				"right:auto;" +
				"speak:normal;" +
				"table-layout:auto;" +
				"tab-size:8;" +
				"text-align:start;" +
				"text-decoration:none;" +
				"text-indent:0px;" +
				"text-rendering:auto;" +
				"text-shadow:none;" +
				"text-overflow:clip;" +
				"text-transform:none;" +
				"top:auto;" +
				"transition:all 0s ease 0s;" +
				"unicode-bidi:normal;" +
				"vertical-align:baseline;" +
				"visibility:visible;" +
				"white-space:normal;" +
				"widows:auto;" +
				"width:0px;" +
				"word-break:normal;" +
				"word-spacing:0px;" +
				"word-wrap:normal;" +
				"z-index:auto;" +
				"zoom:1;" +
				"buffered-rendering:auto;" +
				"clip-path:none;" +
				"clip-rule:nonzero;" +
				"mask:none;" +
				"filter:none;" +
				"flood-color:rgb(0, 0, 0);" +
				"flood-opacity:1;" +
				"lighting-color:rgb(255, 255, 255);" +
				"stop-color:rgb(0, 0, 0);" +
				"stop-opacity:1;" +
				"color-interpolation:srgb;" +
				"color-interpolation-filters:linearrgb;" +
				"color-rendering:auto;" +
				"fill:#000000;" +
				"fill-opacity:1;" +
				"fill-rule:nonzero;" +
				"marker-end:none;" +
				"marker-mid:none;" +
				"marker-start:none;" +
				"mask-type:luminance;" +
				"shape-rendering:auto;" +
				"stroke:none;" +
				"stroke-dasharray:none;" +
				"stroke-dashoffset:0;" +
				"stroke-linecap:butt;" +
				"stroke-linejoin:miter;" +
				"stroke-miterlimit:4;" +
				"stroke-opacity:1;" +
				"stroke-width:1;" +
				"alignment-baseline:auto;" +
				"baseline-shift:baseline;" +
				"dominant-baseline:auto;" +
				"kerning:0;" +
				"text-anchor:start;" +
				"writing-mode:lr-tb;" +
				"glyph-orientation-horizontal:0deg;" +
				"glyph-orientation-vertical:auto;" +
				"vector-effect:none;"
			);

			// スタイルを追加
			ElementAddStyle(_element_current,project.getStyleSheetExpandImagePopup());

			// 最前面
			_element_current.style.zIndex = 0x7FFFFFFF - 1;
			_element_current.style.position = project.getStylePositionPopupImage();

			_element_current.style.left   = "0px";
			_element_current.style.top    = "0px";
			_element_current.style.width  = "0px";
			_element_current.style.height = "0px";

			if(_container.ontrim){
				_container.ontrim();
			}

			if(_trim_rect){
				_image.style.position = "absolute";
			}

			_element_current.style.visibility = "hidden";

			var client_size = DocumentGetClientSize(document);
			var client_rect = {
				left  :1,
				top   :1,
				right :client_size.width  - 1,
				bottom:client_size.height - 1
			};

			// スタイルのサイズを取得
			_element_parent.appendChild(_element_current);
			var bounding_size = ElementGetBoundingClientRect(_element_current);
			work.style_w = bounding_size.right  - bounding_size.left;
			work.style_h = bounding_size.bottom - bounding_size.top;

			// ネイティブサイズ
			var natural_size = ImageGetNaturalSize(_image);
			if(_trim_rect){
				natural_size.width  = _trim_rect.width;
				natural_size.height = _trim_rect.height;
			}

			// 開始矩形
			var begin_rect = new Object();
			if(_element_begin_area){
				if(_trim_rect){
					begin_rect = ElementGetViewClientRect(_element_begin_area);
				}else{
					begin_rect = ElementGetContentClientRect(_element_begin_area);
				}
			}else{
				// マウス座標をセット
				var w = work.style_w * 0.5;
				var h = work.style_h * 0.5;
				var mouse_pos = input_mouse.getPositionClient();
				begin_rect.left   = mouse_pos.x - w;
				begin_rect.right  = mouse_pos.x + w;
				begin_rect.top    = mouse_pos.y - h;
				begin_rect.bottom = mouse_pos.y + h;
			}

			// 終了サイズ
			var scale = project.getScalePercentPopupImage() / 100;
			var end_w = natural_size.width  * scale;
			var end_h = natural_size.height * scale;
			_element_current.style.width  = (end_w) + "px";
			_element_current.style.height = (end_h) + "px";

			var statusbar_h = 0;

			// クライアントサイズを修正
			switch(project.getOriginPopupImage()){
			case "adsorb_element":
				client_rect.bottom -= statusbar_h;
				var rect = {
					left  :begin_rect.left   - 1,
					right :begin_rect.right  + 1,
					top   :begin_rect.top    - 1,
					bottom:begin_rect.bottom + 1
				};
				var l = rect.left - client_rect.left;
				var r = client_rect.right - rect.right;
				var t = rect.top - client_rect.top;
				var b = client_rect.bottom - rect.bottom;
				var w0;
				var h0;
				if(l < r)	w0 = r;
				else		w0 = l;
				if(t < b)	h0 = b;
				else		h0 = t;
				var w1 = natural_size.width * h0 / natural_size.height;
				var h1 = natural_size.height * w0 / natural_size.width;
				if(w1 > client_size.width)	w1 = client_size.width;
				if(h1 > client_size.height)	h1 = client_size.height;
				if(w0 * h1 > h0 * w1){
					if(l > r)	client_rect.right = rect.left;
					else		client_rect.left = rect.right;
				}else{
					if(t > b)	client_rect.bottom = rect.top;
					else		client_rect.top = rect.bottom;
				}
				break;
			case "adsorb_mouse":
				client_rect.bottom -= statusbar_h;
				var distance = 10;
				var mouse_pos = input_mouse.getPositionClient();
				var l = (mouse_pos.x - distance) - client_rect.left;
				var r = client_rect.right - (mouse_pos.x + distance);
				var t = (mouse_pos.y - distance) - client_rect.top;
				var b = client_rect.bottom - (mouse_pos.y + distance);
				var w0;
				var h0;
				if(l < r)	w0 = r;
				else		w0 = l;
				if(t < b)	h0 = b;
				else		h0 = t;
				var w1 = natural_size.width * h0 / natural_size.height;
				var h1 = natural_size.height * w0 / natural_size.width;
				if(w1 > client_size.width)	w1 = client_size.width;
				if(h1 > client_size.height)	h1 = client_size.height;
				if(w0 * h1 > h0 * w1){
					if(l > r)	client_rect.right = (mouse_pos.x - distance);
					else		client_rect.left = (mouse_pos.x + distance);
				}else{
					if(t > b)	client_rect.bottom = (mouse_pos.y - distance);
					else		client_rect.top = (mouse_pos.y + distance);
				}
				break;
			}

			// 幅と高さがクライアント領域を超える場合補正
			client_rect.width  = client_rect.right - client_rect.left;
			client_rect.height = client_rect.bottom - client_rect.top;
			if(client_rect.width < end_w + work.style_w){
				var w = (client_rect.width - work.style_w);
				end_h *= w / end_w;
				end_w = w;
			}
			if(client_rect.height < end_h + work.style_h){
				var h = (client_rect.height - work.style_h);
				end_w *= h / end_h;
				end_h = h;
			}

			// 終了座標
			var end_x;
			var end_y;
			switch(project.getOriginPopupImage()){
			default:
			case "center":
				var x = (begin_rect.right + begin_rect.left) * 0.5;
				var y = (begin_rect.bottom + begin_rect.top) * 0.5;
				end_x = x - ((end_w + work.style_w) * 0.5);
				end_y = y - ((end_h + work.style_h) * 0.5);
				if(begin_rect.right - begin_rect.left < work.style_w){
					begin_rect.left = x - work.style_w / 2;
					begin_rect.right = begin_rect.left + work.style_w;
				}
				if(begin_rect.bottom - begin_rect.top < work.style_h){
					begin_rect.top = y - work.style_h / 2;
					begin_rect.bottom = begin_rect.top  + work.style_h;
				}
				break;
			case "upper_left":
				end_x = begin_rect.left;
				end_y = begin_rect.top;
				break;
			case "upper_right":
				end_x = begin_rect.right - end_w;
				end_y = begin_rect.top;
				break;
			case "client_center":
				end_x = (client_rect.width  * 0.5) - ((end_w + work.style_w) * 0.5);
				end_y = (client_rect.height * 0.5) - ((end_h + work.style_h) * 0.5);
				var x = (begin_rect.right + begin_rect.left) * 0.5;
				var y = (begin_rect.bottom + begin_rect.top) * 0.5;
				if(begin_rect.right - begin_rect.left < work.style_w){
					begin_rect.left = x - work.style_w / 2;
					begin_rect.right = begin_rect.left + work.style_w;
				}
				if(begin_rect.bottom - begin_rect.top < work.style_h){
					begin_rect.top = y - work.style_h / 2;
					begin_rect.bottom = begin_rect.top  + work.style_h;
				}
				break;
			}

			begin_rect.right  -= work.style_w;
			begin_rect.bottom -= work.style_h;
			work.begin_rect = begin_rect;

			if(end_x < client_rect.left)	end_x = client_rect.left;
			if(end_y < client_rect.top )	end_y = client_rect.top ;
			if(end_x + end_w + work.style_w > client_rect.right )	end_x = client_rect.right  - end_w - work.style_w;
			if(end_y + end_h + work.style_h > client_rect.bottom)	end_y = client_rect.bottom - end_h - work.style_h;

			var end_rect = new Object();
			end_rect.left   = end_x;
			end_rect.top    = end_y;
			end_rect.right  = end_rect.left + end_w;
			end_rect.bottom = end_rect.top  + end_h;
			work.end_rect = end_rect;

			// 絶対座標系
			if(project.getStylePositionPopupImage() == "absolute"){
				// スクロール位置
				var scroll_pos = DocumentGetScrollPos();

				// ルートオフセット
				var div = DocumentCreateElement("div");
				ElementSetStyle(div,"width:1px; height:1px; position:absolute; left:0px; top:0px;");
				document.body.appendChild(div);
				bounding_size = ElementGetBoundingClientRect(div);
				DomNodeRemove(div);
				bounding_size.left += scroll_pos.x;
				bounding_size.top  += scroll_pos.y;
				scroll_pos.x -= bounding_size.left;
				scroll_pos.y -= bounding_size.top;

				// 絶対座標系に変更
				begin_rect.left   += scroll_pos.x;
				begin_rect.top    += scroll_pos.y;
				begin_rect.right  += scroll_pos.x;
				begin_rect.bottom += scroll_pos.y;
				end_rect.left   += scroll_pos.x;
				end_rect.top    += scroll_pos.y;
				end_rect.right  += scroll_pos.x;
				end_rect.bottom += scroll_pos.y;

				// イベントハンドラを作成
				_event_handler_revise_scroll = page_expand_event_dispatcher.createEventHandler("revise_scroll");
				_event_handler_revise_scroll.setFunction(reviseScroll);
			}

			// スケール未対応
			if(!project.getEnableScaleAnimationPopupImage()){
				work.begin_rect = end_rect;
				PopupImageSizeUpdate(task);
			}

			// アルファ未対応
			if(!project.getEnableAlphaAnimationPopupImage()){
				PopupImageSetAlpha(task,1.0);
			}

			// マウスイベント有効化
			_element_current.style.pointerEvents = "auto";

			_element_current.style.visibility = "visible";

			if(project.getEnableAnimationPopupImage()){
				task.setExecuteFunc(PopupImageFadeIn);
			}else{
				task.setExecuteFunc(PopupImageShowInit);
			}
			task.execute(0xffffffff);
		}

		// --------------------------------------------------------------------------------
		// フェードイン（内部用）
		// --------------------------------------------------------------------------------
		function PopupImageFadeIn(task){
			var work = task.getUserWork();

			work.type = "fade_in";

			// マウスムーブ
			mouseMove();

			var sub = 1.0 - work.anime_pos;
			sub *= 0.4;
			if(sub > 0.0){
				work.anime_spd += 0.05;
				if(work.anime_spd > 0.2)	work.anime_spd = 0.2;
				if(work.anime_spd > sub)	work.anime_spd = sub;
			}

			work.anime_pos += work.anime_spd;
			if(work.anime_pos > 0.999){
				work.anime_spd = 0.0;
				work.anime_pos = 1.0;
				task.setExecuteFunc(PopupImageShowInit);
			}

			if(project.getEnableAlphaAnimationPopupImage()){
				PopupImageSetAlpha(task,work.anime_pos);
			}

			if(project.getEnableScaleAnimationPopupImage()){
				PopupImageSizeUpdate(task);
			}
		}

		// --------------------------------------------------------------------------------
		// 表示（内部用）
		// --------------------------------------------------------------------------------
		function PopupImageShowInit(task){
			var work = task.getUserWork();

			work.type = "show";
			work.anime_pos = 1.0;
			work.anime_spd = 0.0;
			work.frame = project.getTimeWaitClosePopupImage() / 1000 * 60;
			if(project.getEnableAlphaAnimationPopupImage()){
				PopupImageSetAlpha(task,work.anime_pos);
			}
			if(project.getEnableScaleAnimationPopupImage()){
				PopupImageSizeUpdate(task);
			}

			task.setExecuteFunc(PopupImageShowExec);
			task.execute(0xffffffff);
		}
		function PopupImageShowExec(task){
			var work = task.getUserWork();

			// マウスムーブ
			mouseMove();
		}

		// --------------------------------------------------------------------------------
		// 待機（内部用）
		// --------------------------------------------------------------------------------
		function PopupImageWaitBeforeClose(task){
			var work = task.getUserWork();

			work.type = "wait_before_close";

			// マウスムーブ
			mouseMove();

			work.frame -= 1;
			if(work.frame < 0){
				// アニメーション
				if(project.getEnableAnimationPopupImage()){
					// マウスイベント無効化
					_element_current.style.pointerEvents = "none";
					task.setExecuteFunc(PopupImageFadeOut);
				}else{
					task.setExecuteFunc(PopupImageClose);
				}
			}
		}

		// --------------------------------------------------------------------------------
		// フェードアウト（内部用）
		// --------------------------------------------------------------------------------
		function PopupImageFadeOut(task){
			var work = task.getUserWork();

			work.type = "fade_out";

			// マウスムーブ
			mouseMove();

			var sub = 0.0 - work.anime_pos;
			sub *= 0.4;
			if(sub < 0.0){
				work.anime_spd -= 0.2;
				if(work.anime_spd < sub)	work.anime_spd = sub;
			}
			work.anime_pos += work.anime_spd;
			if(work.anime_pos < 0.001){
				work.anime_spd = 0.0;
				work.anime_pos = 0.0;
				task.setExecuteFunc(PopupImageClose);
			}
			if(project.getEnableAlphaAnimationPopupImage()){
				PopupImageSetAlpha(task,work.anime_pos);
			}
			if(project.getEnableScaleAnimationPopupImage()){
				PopupImageSizeUpdate(task);
			}
		}

		// --------------------------------------------------------------------------------
		// 閉じる（内部用）
		// --------------------------------------------------------------------------------
		function PopupImageClose(task){
			var work = task.getUserWork();
			task.release();
		}

		// --------------------------------------------------------------------------------
		// デストラクタ（内部用）
		// --------------------------------------------------------------------------------
		function PopupImageDestructor(task){
			// 解放
			if(_event_handler_revise_scroll){
				_event_handler_revise_scroll.release();
				_event_handler_revise_scroll = null;
			}

			DomNodeRemove(_element_current);
			_task = null;

			// 自殺
			if(_suicide){
				_container.release();
			}
		}

		// --------------------------------------------------------------------------------
		// サイズ更新（内部用）
		// --------------------------------------------------------------------------------
		function PopupImageSizeUpdate(task){
			var work = task.getUserWork();
			var begin_rect = work.begin_rect;
			var end_rect = work.end_rect;

			var d = work.anime_pos;
			var l = (end_rect.left   - begin_rect.left  ) * d + begin_rect.left;
			var r = (end_rect.right  - begin_rect.right ) * d + begin_rect.right;
			var t = (end_rect.top    - begin_rect.top   ) * d + begin_rect.top;
			var b = (end_rect.bottom - begin_rect.bottom) * d + begin_rect.bottom;
			var w = r - l;
			var h = b - t;

			var style = _element_current.style;
			style.left = (l) + "px";
			style.top  = (t) + "px";
			style.width  = (w) + "px";
			style.height = (h) + "px";

			if(_trim_rect){
				var style = _image.style;
				var natural_size = ImageGetNaturalSize(_image);
				var padding_rect = ElementGetPaddingWidth(_element_current);
				var sx = w / _trim_rect.width;
				var sy = h / _trim_rect.height;
				l = _trim_rect.left * sx;
				t = _trim_rect.top  * sy;
				r = l + w;
				b = t + h;
				style.left = (-l + padding_rect.left) + "px";
				style.top  = (-t + padding_rect.top ) + "px";
				style.width  = (natural_size.width  * sx) + "px";
				style.height = (natural_size.height * sy) + "px";
				style.clip = "rect(" + (t) + "px " + (r) + "px " + (b) + "px " + (l) + "px)";
			}
		}

		// --------------------------------------------------------------------------------
		// 透明度セット（内部用）
		// --------------------------------------------------------------------------------
		function PopupImageSetAlpha(task,v){
			var work = task.getUserWork();
			_element_current.style.opacity = v;
		}

		// --------------------------------------------------------------------------------
		// トリミング要求イベント
		// --------------------------------------------------------------------------------
		_container.ontrim = function(){};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _element_parent;
		var _element_anchor;
		var _element_hit_area;
		var _element_begin_area;
		var _element_current;
		var _task;
		var _trim_rect;
		var _image;
		var _suicide;
		var _element_rects_tree;
		var _scroll_pos_begin;
		var _analyze_work;
		var _observer_remove;
		var _event_handler_revise_scroll;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_element_hit_area = null;
			_element_begin_area = null;
			_task = null;
			_image = image;
			_element_current = _image;
			_suicide = false;
			_element_rects_tree = null;
			image = null;

			// 解析ワーク作成
			_analyze_work = AnalyzeWorkCreate(_image);
			// 解析済み
			AnalyzeWorkSetAnalyzedPopupReducedImage(_analyze_work);
			// 解析辞書登録
			analyze_work_dictionary.attachAnalyzeWork(_analyze_work,true);

			// クリックイベント
			addEventClick();
		})();

		return _container;
	}


	// --------------------------------------------------------------------------------
	// インターナショナルメッセージ
	// --------------------------------------------------------------------------------
	function InternationalMessage(language){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// アドレスを登録
		// --------------------------------------------------------------------------------
		_container.getMessage = function(asset){
			if(_dictionary[asset]){
				return _dictionary[asset].message;
			}
			return "XXXXX NO LOCALE MESSAGE XXXXX";
		};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _dictionary;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		switch(language){
		case 'ja':
			_dictionary = InternationalMessage.locales.ja;
			break;
		default:
			_dictionary = InternationalMessage.locales.en;
			break;
		}

		return _container;
	}


	// --------------------------------------------------------------------------------
	// ロケールデータ
	// --------------------------------------------------------------------------------
	InternationalMessage.locales = {
		ja: {
			extension_name: {
				message: "PageExpand"
			},
			extension_description: {
				message: "すべてのWEBページをリッチに展開。短縮URLの展開、URL文字列のリンク化、画像のポップアップ表示、動画のインライン表示、掲示板の拡張表示など。"
			},
			page_expand_config: {
				message: "PageExpand 設定"
			},
			menu_setting_standard: {
				message: "基本設定"
			},
			menu_setting_standard_filter_url: {
				message: "動作を制限するＵＲＬ"
			},
			menu_setting_standard_filter_url_combo_box_item_deny: {
				message: "指定したアドレスのみ動作させない（それ以外はすべて動作する）"
			},
			menu_setting_standard_filter_url_combo_box_item_allow: {
				message: "指定したアドレスのみ動作させる（それ以外はすべて動作しない）"
			},
			menu_setting_standard_filter_url_hint: {
				message: "URL を記述します。アスタリスク使用可。複数行指定可。"
			},
			menu_setting_standard_check_box_container: {
				message: "基本設定"
			},
			menu_setting_standard_enable_icon_address_bar: {
				message: "アドレスバーにアイコンを表示"
			},
			menu_setting_standard_enable_context_menu: {
				message: "コンテキストメニューを表示"
			},
			menu_setting_standard_enable_enable_startup: {
				message: "ロード完了時から動作を開始"
			},
			menu_setting_standard_enable_debug_mode: {
				message: "デバッグモードで動作"
			},
			menu_setting_standard_enable_output_log: {
				message: "コンソールにログを出力（デバッグ用）"
			},
			menu_setting_standard_load: {
				message: "ダウンロード設定"
			},
			menu_setting_standard_load_thread_max: {
				message: "最大同時ダウンロード数"
			},
			menu_setting_standard_execute_queue: {
				message: "実行キュー設定（通常は変更の必要はありません）"
			},
			menu_setting_standard_execute_queue_time_sleep: {
				message: "スリープ時間（ミリ秒）"
			},
			menu_setting_standard_execute_queue_time_occupancy: {
				message: "最大CPU占有時間（ミリ秒）"
			},
			menu_setting_standard_execute_queue_hint: {
				message: "最大CPU占有時間が大きいほど、操作レスポンスが悪くなり、スクリプトが高速に動作します。スリープ時間が小さいほど、CPU使用率が高くなり、スクリプトが高速に動作します。"
			},
			menu_setting_standard_export_import: {
				message: "設定のエクスポート / インポート"
			},
			menu_setting_standard_export_button: {
				message: "エクスポート"
			},
			menu_setting_standard_import_button: {
				message: "インポート"
			},
			menu_setting_standard_export_dialog: {
				message: "設定のエクスポート"
			},
			menu_setting_standard_export_dialog_export: {
				message: "エクスポート"
			},
			menu_setting_standard_export_dialog_export_hint: {
				message: "テキストエリアの値をコピーして下さい。"
			},
			menu_setting_standard_import_dialog: {
				message: "設定のインポート"
			},
			menu_setting_standard_import_dialog_explanation: {
				message: "インポートについて"
			},
			menu_setting_standard_import_dialog_explanation_0: {
				message: "インポートを行うと、現在の設定は全て失われます。"
			},
			menu_setting_standard_import_dialog_explanation_1: {
				message: "インポートを行う前に、エクスポート機能でバックアップを取ることをお勧めします。"
			},
			menu_setting_standard_import_dialog_explanation_2: {
				message: "信頼の無い人物が作成した設定データを、絶対にインポートしないで下さい。悪意のあるコードが含まれる恐れがあります。"
			},
			menu_setting_standard_import_dialog_import: {
				message: "インポート"
			},
			menu_setting_standard_import_dialog_import_hint: {
				message: "エクスポートから出力したテキストをペーストして下さい。"
			},
			menu_setting_standard_import_dialog_confirm: {
				message: "インポートを実行しますか？"
			},
			menu_setting_standard_import_alert: {
				message: "インポートの結果"
			},
			menu_setting_standard_import_alert_success: {
				message: "インポートが完了しました。"
			},
			menu_setting_standard_import_alert_failure: {
				message: "インポートに失敗しました。"
			},
			menu_setting_standard_storage_sync: {
				message: "同期ストレージ"
			},
			menu_setting_standard_storage_sync_load_button: {
				message: "読込"
			},
			menu_setting_standard_storage_sync_save_button: {
				message: "保存"
			},
			menu_setting_standard_storage_sync_delete_button: {
				message: "削除"
			},
			menu_setting_standard_storage_sync_load_dialog: {
				message: "同期ストレージの読み込み"
			},
			menu_setting_standard_storage_sync_load_dialog_explanation: {
				message: "同期ストレージの読み込みについて"
			},
			menu_setting_standard_storage_sync_load_dialog_explanation_0: {
				message: "同期ストレージからデータを読み込んで設定に反映します。"
			},
			menu_setting_standard_storage_sync_load_dialog_explanation_1: {
				message: "読み込みを行うと、現在の設定は全て失われます。"
			},
			menu_setting_standard_storage_sync_load_dialog_explanation_2: {
				message: "読み込みを行う前に、エクスポート機能でバックアップを取ることをお勧めします。"
			},
			menu_setting_standard_storage_sync_load_dialog_confirm: {
				message: "同期ストレージから設定データを読み込みますか？"
			},
			menu_setting_standard_storage_sync_load_alert: {
				message: "読み込みの結果"
			},
			menu_setting_standard_storage_sync_load_alert_success: {
				message: "読み込みが完了しました。"
			},
			menu_setting_standard_storage_sync_load_alert_failure: {
				message: "読み込みに失敗しました。"
			},
			menu_setting_standard_storage_sync_save_dialog: {
				message: "同期ストレージの保存"
			},
			menu_setting_standard_storage_sync_save_dialog_explanation: {
				message: "同期ストレージの保存について"
			},
			menu_setting_standard_storage_sync_save_dialog_explanation_0: {
				message: "現在の設定を、同期ストレージに保存します。"
			},
			menu_setting_standard_storage_sync_save_dialog_explanation_1: {
				message: "ブラウザの同期機能が有効である必要があります。"
			},
			menu_setting_standard_storage_sync_save_dialog_explanation_2: {
				message: "容量に制限があります。サイズが大きすぎる場合失敗します。"
			},
			menu_setting_standard_storage_sync_save_dialog_confirm: {
				message: "同期ストレージに設定データを保存しますか？"
			},
			menu_setting_standard_storage_sync_save_alert: {
				message: "保存の結果"
			},
			menu_setting_standard_storage_sync_save_alert_success: {
				message: "保存が完了しました。"
			},
			menu_setting_standard_storage_sync_save_alert_failure: {
				message: "保存に失敗しました。"
			},
			menu_setting_standard_storage_sync_delete_dialog: {
				message: "同期ストレージの削除"
			},
			menu_setting_standard_storage_sync_delete_dialog_explanation: {
				message: "同期ストレージの削除について"
			},
			menu_setting_standard_storage_sync_delete_dialog_explanation_0: {
				message: "同期ストレージに保存した設定データをすべて削除します。"
			},
			menu_setting_standard_storage_sync_delete_dialog_confirm: {
				message: "同期ストレージの設定データを削除しますか？"
			},
			menu_setting_standard_storage_sync_delete_alert: {
				message: "削除の結果"
			},
			menu_setting_standard_storage_sync_delete_alert_success: {
				message: "削除が完了しました。"
			},
			menu_setting_standard_storage_sync_delete_alert_failure: {
				message: "削除に失敗しました。"
			},
			menu_setting_standard_reset: {
				message: "設定の初期化"
			},
			menu_setting_standard_reset_button: {
				message: "すべての設定を削除して初期状態に戻す"
			},
			menu_setting_standard_reset_dialog: {
				message: "設定の初期化"
			},
			menu_setting_standard_reset_dialog_explanation: {
				message: "設定の初期化について"
			},
			menu_setting_standard_reset_dialog_explanation_0: {
				message: "すべての設定をデフォルトの状態に戻します。"
			},
			menu_setting_standard_reset_dialog_explanation_1: {
				message: "設定の初期化を行うと現在の設定は全て失われます。"
			},
			menu_setting_standard_reset_dialog_confirm: {
				message: "設定の初期化を実行しますか？"
			},
			menu_setting_standard_reset_alert: {
				message: "設定の初期化の結果"
			},
			menu_setting_standard_reset_alert_success: {
				message: "設定の初期化が完了しました。"
			},
			menu_setting_standard_reset_alert_failure: {
				message: "設定の初期化に失敗しました。"
			},
			menu_setting_expand_bbs: {
				message: "掲示板拡張設定"
			},
			menu_setting_expand_bbs_list: {
				message: "掲示板拡張設定一覧"
			},
			menu_setting_expand_bbs_list_hint: {
				message: "リストを選択すると下部のコントロールの入力が可能です。上から順番に動作条件スクリプトを実行し、許可があればその設定が使用されます。複数選択可。複数選択時は同時編集。灰色はプリセット設定。プリセット設定は削除不可。"
			},
			menu_setting_expand_bbs_button_add: {
				message: "追加"
			},
			menu_setting_expand_bbs_button_delete: {
				message: "削除"
			},
			menu_setting_expand_bbs_button_prio_up: {
				message: "優先度を上げる"
			},
			menu_setting_expand_bbs_button_prio_down: {
				message: "優先度を下げる"
			},
			menu_setting_expand_bbs_add_dialog: {
				message: "掲示板拡張設定の新規作成"
			},
			menu_setting_expand_bbs_add_dialog_name: {
				message: "名前"
			},
			menu_setting_expand_bbs_add_dialog_copy_define: {
				message: "既存の設定から複製"
			},
			menu_setting_expand_bbs_add_dialog_define_list_box_item_new: {
				message: "複製せずに新規作成する"
			},
			menu_setting_expand_bbs_name: {
				message: "名前"
			},
			menu_setting_expand_bbs_check_box_container: {
				message: "掲示板拡張設定"
			},
			menu_setting_expand_bbs_enable_setting: {
				message: "設定を有効"
			},
			menu_setting_expand_bbs_filter_url: {
				message: "動作URLの設定"
			},
			menu_setting_expand_bbs_popup_check_box_container: {
				message: "ポップアップの設定"
			},
			menu_setting_expand_bbs_popup_enable_animation: {
				message: "ポップアップ時のアニメーション動作を有効"
			},
			menu_setting_expand_bbs_popup_origin_type: {
				message: "ポップアップの配置基点"
			},
			menu_setting_expand_bbs_popup_origin_type_combo_box_item_adsorb_top_bottom: {
				message: "上下に吸着"
			},
			menu_setting_expand_bbs_popup_origin_type_combo_box_item_adsorb_left_right: {
				message: "左右に吸着"
			},
			menu_setting_expand_bbs_popup_position_type: {
				message: "ポップアップの配置位置"
			},
			menu_setting_expand_bbs_popup_position_type_combo_box_item_absolute: {
				message: "絶対座標系に配置"
			},
			menu_setting_expand_bbs_popup_position_type_combo_box_item_fixed: {
				message: "クライアント座標系に配置"
			},
			menu_setting_expand_bbs_popup_percent: {
				message: "ポップアップサイズ"
			},
			menu_setting_expand_bbs_popup_percent_h: {
				message: "横方向パーセント (0～100)"
			},
			menu_setting_expand_bbs_popup_percent_v: {
				message: "縦方向パーセント (0～100)"
			},
			menu_setting_expand_bbs_popup_time: {
				message: "ポップアップ時間"
			},
			menu_setting_expand_bbs_popup_time_wait_open: {
				message: "開くまでに待機する時間（ミリ秒）"
			},
			menu_setting_expand_bbs_popup_time_wait_close: {
				message: "閉じるまでに待機する時間（ミリ秒）"
			},
			menu_setting_expand_bbs_popup_style_sheet: {
				message: "ポップアップのスタイル"
			},
			menu_setting_expand_bbs_script_initialize: {
				message: "初期化スクリプト"
			},
			menu_setting_expand_bbs_script_callback: {
				message: "コールバックスクリプト"
			},
			menu_setting_urlmap: {
				message: "URLマッピング設定"
			},
			menu_setting_urlmap_list: {
				message: "URLマッピング設定一覧"
			},
			menu_setting_urlmap_list_hint: {
				message: "リストを選択すると下部のコントロールの入力が可能です。上から順番にURLの比較を行いマッチすればその設定が使用されます。複数選択可。複数選択時は同時編集。灰色はプリセット設定。プリセット設定は削除不可。"
			},
			menu_setting_urlmap_button_add: {
				message: "追加"
			},
			menu_setting_urlmap_button_delete: {
				message: "削除"
			},
			menu_setting_urlmap_button_prio_up: {
				message: "優先度を上げる"
			},
			menu_setting_urlmap_button_prio_down: {
				message: "優先度を下げる"
			},
			menu_setting_urlmap_add_dialog: {
				message: "URLマッピング設定の新規作成"
			},
			menu_setting_urlmap_add_dialog_name: {
				message: "名前"
			},
			menu_setting_urlmap_add_dialog_copy_define: {
				message: "既存の設定から複製"
			},
			menu_setting_urlmap_add_dialog_define_list_box_item_new: {
				message: "複製せずに新規作成する"
			},
			menu_setting_urlmap_name: {
				message: "名前"
			},
			menu_setting_urlmap_check_box_container: {
				message: "URLマッピング設定"
			},
			menu_setting_urlmap_enable_setting: {
				message: "設定を有効"
			},
			menu_setting_urlmap_filter_url: {
				message: "動作URLの設定"
			},
			menu_setting_urlmap_filter_url_hint: {
				message: "URL を記述します。アスタリスク使用可。複数行指定可。"
			},
			menu_setting_urlmap_unsecure_check_box_container: {
				message: "セキュリティ"
			},
			menu_setting_urlmap_enable_unsecure: {
				message: "セキュアなページ内で「http://～ にあるリソース」を展開する"
			},
			menu_setting_urlmap_enable_unsecure_hint: {
				message: "無効の場合、https://～ にあるリソースだけ展開します。有効の場合、http://～ にあるリソースも展開しますが、常に暗号化の警告が表示されます。"
			},
			menu_setting_urlmap_enable_mixed_content: {
				message: "セキュアなページ内で「デフォルトでブロックされる混在コンテンツ」の展開を試みる"
			},
			menu_setting_urlmap_enable_mixed_content_hint: {
				message: "ブラウザは、一部の要素の展開をブロックします。無効の場合、ブロックされる要素を展開しません。有効の場合、すべての要素の展開を試みます。（ブラウザの設定を変更しない限り失敗します。変更は非推奨。）"
			},
			menu_setting_urlmap_define_button_edit: {
				message: "編集"
			},
			menu_setting_urlmap_define_button_add: {
				message: "追加"
			},
			menu_setting_urlmap_define_button_remove: {
				message: "除外"
			},
			menu_setting_urlmap_define_button_prio_up: {
				message: "上へ"
			},
			menu_setting_urlmap_define_button_prio_down: {
				message: "下へ"
			},
			menu_setting_urlmap_define_combo_box_item_no_use: {
				message: "定義を使用しない"
			},
			menu_setting_define_multi_select_add_dialog: {
				message: "定義の追加"
			},
			menu_setting_define_multi_select_add_dialog_list: {
				message: "追加する定義を選択"
			},
			menu_setting_access_block: {
				message: "アクセス遮断定義"
			},
			menu_setting_access_block_filter_url: {
				message: "アクセス遮断URLを設定"
			},
			menu_setting_access_block_filter_url_hint: {
				message: "URL を記述します。アスタリスク使用可。複数行指定可。"
			},
			menu_setting_replacement_to_element: {
				message: "エレメント置換定義"
			},
			menu_setting_replacement_to_element_script: {
				message: "コールバックスクリプト"
			},
			menu_setting_replacement_to_text: {
				message: "テキスト置換定義"
			},
			menu_setting_replacement_to_text_script: {
				message: "コールバックスクリプト"
			},
			menu_setting_replacement_to_anchor: {
				message: "アンカー置換定義"
			},
			menu_setting_replacement_to_anchor_script: {
				message: "コールバックスクリプト"
			},
			menu_setting_replacement_to_link: {
				message: "ハイパーリンク置換定義"
			},
			menu_setting_replacement_to_link_filter_list: {
				message: "フィルタ一覧"
			},
			menu_setting_replacement_to_link_filter_name: {
				message: "フィルタ名"
			},
			menu_setting_replacement_to_link_filter: {
				message: "フィルタ設定"
			},
			menu_setting_replacement_to_link_filter_filter_url: {
				message: "動作リンク先URLの設定"
			},
			menu_setting_replacement_to_link_filter_filter_url_hint: {
				message: "URL を記述します。アスタリスク使用可。複数行指定可。"
			},
			menu_setting_replacement_to_link_check_box_container: {
				message: "ハイパーリンク置換の設定"
			},
			menu_setting_replacement_to_link_enable_reflect_to_anchor: {
				message: "リンクの変更をアンカーに反映する"
			},
			menu_setting_replacement_to_link_enable_cache: {
				message: "コールバックスクリプトの実行結果をキャッシュする"
			},
			menu_setting_replacement_to_link_filter_script: {
				message: "コールバックスクリプト"
			},
			menu_setting_replacement_to_referer: {
				message: "リファラ置換定義"
			},
			menu_setting_replacement_to_referer_filter_list: {
				message: "フィルタ一覧"
			},
			menu_setting_replacement_to_referer_filter_name: {
				message: "フィルタ名"
			},
			menu_setting_replacement_to_referer_filter: {
				message: "フィルタ設定"
			},
			menu_setting_replacement_to_referer_filter_filter_url: {
				message: "動作リンク先URLの設定"
			},
			menu_setting_replacement_to_referer_filter_filter_url_hint: {
				message: "URL を記述します。アスタリスク使用可。複数行指定可。"
			},
			menu_setting_replacement_to_referer_filter_send_type: {
				message: "基本リファラ"
			},
			menu_setting_replacement_to_referer_filter_send_type_combo_box_item: {
				message: "基本リファラ値"
			},
			menu_setting_replacement_to_referer_filter_send_type_combo_box_item_default: {
				message: "改変しない"
			},
			menu_setting_replacement_to_referer_filter_send_type_combo_box_item_current_url: {
				message: "現在のURL"
			},
			menu_setting_replacement_to_referer_filter_send_type_combo_box_item_link_url: {
				message: "リンク先のURL"
			},
			menu_setting_replacement_to_referer_filter_send_type_combo_box_item_custom: {
				message: "カスタム文字列"
			},
			menu_setting_replacement_to_referer_filter_send_custom: {
				message: "カスタム文字列"
			},
			menu_setting_replacement_to_referer_filter_send_regexp: {
				message: "基本リファラを正規表現で置換"
			},
			menu_setting_replacement_to_referer_filter_send_regexp_match: {
				message: "マッチ条件"
			},
			menu_setting_replacement_to_referer_filter_send_regexp_replacement: {
				message: "置換後の文字列"
			},
			menu_setting_replacement_to_referer_filter_send_regexp_replacement_hint: {
				message: "$0…マッチした全体文字列。$1～$9…マッチした部分文字列。$$…ドルのエスケープシーケンス"
			},
			menu_setting_replacement_to_useragent: {
				message: "ユーザーエージェント置換定義"
			},
			menu_setting_replacement_to_useragent_filter_list: {
				message: "フィルタ一覧"
			},
			menu_setting_replacement_to_useragent_filter_name: {
				message: "フィルタ名"
			},
			menu_setting_replacement_to_useragent_filter: {
				message: "フィルタ設定"
			},
			menu_setting_replacement_to_useragent_filter_filter_url: {
				message: "動作リンク先URLの設定"
			},
			menu_setting_replacement_to_useragent_filter_filter_url_hint: {
				message: "URL を記述します。アスタリスク使用可。複数行指定可。"
			},
			menu_setting_replacement_to_useragent_filter_send: {
				message: "基本ユーザーエージェント"
			},
			menu_setting_replacement_to_useragent_filter_send_custom: {
				message: "カスタム文字列"
			},
			menu_setting_make_link_to_text: {
				message: "ハイパーリンク化定義"
			},
			menu_setting_make_link_to_text_script: {
				message: "コールバックスクリプト"
			},
			menu_setting_expand_short_url: {
				message: "短縮URL展開定義"
			},
			menu_setting_expand_short_url_filter_url: {
				message: "対象URLを設定"
			},
			menu_setting_expand_short_url_filter_url_hint: {
				message: "URL を記述します。アスタリスク使用可。複数行指定可。"
			},
			menu_setting_expand_text: {
				message: "テキスト展開定義"
			},
			menu_setting_expand_text_inline: {
				message: "インライン表示の設定"
			},
			menu_setting_expand_text_inline_check_box_container: {
				message: "インライン表示の設定"
			},
			menu_setting_expand_text_inline_disable_same_text: {
				message: "同じURLは展開しない"
			},
			menu_setting_expand_text_inline_script_allow: {
				message: "リンクからインライン表示する条件"
			},
			menu_setting_expand_text_inline_script_insert: {
				message: "テキストの挿入位置"
			},
			menu_setting_expand_image: {
				message: "イメージ展開定義"
			},
			menu_setting_expand_image_thumbnail: {
				message: "サムネイル表示設定"
			},
			menu_setting_expand_image_thumbnail_check_box_container: {
				message: "サムネイル表示設定"
			},
			menu_setting_expand_image_thumbnail_enable_popup_mouseover: {
				message: "サムネイルにマウスオーバーするとポップアップ表示"
			},
			menu_setting_expand_image_thumbnail_disable_same_thumbnail_image: {
				message: "同じイメージがすでに配置されている場合サムネイルを表示しない"
			},
			menu_setting_expand_image_thumbnail_script_allow: {
				message: "リンクからサムネイル化する条件"
			},
			menu_setting_expand_image_thumbnail_script_insert: {
				message: "サムネイルの挿入位置"
			},
			menu_setting_expand_image_popup: {
				message: "ポップアップ表示設定"
			},
			menu_setting_expand_image_popup_check_box_container: {
				message: "ポップアップ表示設定"
			},
			menu_setting_expand_image_popup_enable_animation_scale: {
				message: "拡大縮小フェードを有効"
			},
			menu_setting_expand_image_popup_enable_animation_alpha: {
				message: "半透明フェードを有効"
			},
			menu_setting_expand_image_popup_origin_type: {
				message: "ポップアップイメージの配置基点"
			},
			menu_setting_expand_image_popup_origin_type_combo_box_item_center: {
				message: "中心を基点"
			},
			menu_setting_expand_image_popup_origin_type_combo_box_item_upper_left: {
				message: "左上を基点"
			},
			menu_setting_expand_image_popup_origin_type_combo_box_item_upper_right: {
				message: "右上を基点"
			},
			menu_setting_expand_image_popup_origin_type_combo_box_item_client_center: {
				message: "クライアント中央"
			},
			menu_setting_expand_image_popup_origin_type_combo_box_item_adsorb_element: {
				message: "エレメントに吸着"
			},
			menu_setting_expand_image_popup_origin_type_combo_box_item_adsorb_mouse: {
				message: "マウスカーソルに吸着"
			},
			menu_setting_expand_image_popup_time: {
				message: "ポップアップ時間"
			},
			menu_setting_expand_image_popup_time_wait_open: {
				message: "開くまでに待機する時間（ミリ秒）"
			},
			menu_setting_expand_image_popup_time_wait_close: {
				message: "閉じるまでに待機する時間（ミリ秒）"
			},
			menu_setting_expand_image_popup_position_type: {
				message: "ポップアップイメージの配置位置"
			},
			menu_setting_expand_image_popup_position_type_combo_box_item_absolute: {
				message: "絶対座標系に配置"
			},
			menu_setting_expand_image_popup_position_type_combo_box_item_fixed: {
				message: "クライアント座標系に配置"
			},
			menu_setting_expand_image_popup_size: {
				message: "ポップアップイメージの表示サイズ"
			},
			menu_setting_expand_image_popup_size_scale: {
				message: "拡大率（パーセント）"
			},
			menu_setting_expand_image_popup_script_allow: {
				message: "リンクからポップアップ表示する条件"
			},
			menu_setting_expand_image_reduced_image: {
				message: "縮小イメージ設定"
			},
			menu_setting_expand_image_reduced_image_check_box_container: {
				message: "縮小イメージ設定"
			},
			menu_setting_expand_image_popup_enable_popup: {
				message: "縮小されたイメージをマウスオーバーするとポップアップ表示"
			},
			menu_setting_expand_image_reduced_image_allow_slcale_less_then: {
				message: "縮小イメージのポップアップ条件"
			},
			menu_setting_expand_image_reduced_image_allow_slcale_less_then_text: {
				message: "以下の拡大率の場合"
			},
			menu_setting_expand_image_load: {
				message: "イメージのロード設定"
			},
			menu_setting_expand_image_load_check_box_container: {
				message: "イメージのロード設定"
			},
			menu_setting_expand_image_load_enable_notify: {
				message: "ロード進捗を表示"
			},
			menu_setting_expand_image_load_start_type: {
				message: "イメージのロード設定"
			},
			menu_setting_expand_image_load_start_type_preload: {
				message: "すべて事前に読み込む"
			},
			menu_setting_expand_image_load_start_type_scroll: {
				message: "スクロールと連動して読み込む"
			},
			menu_setting_expand_image_load_unload_check_box_container: {
				message: "イメージのアンロード設定"
			},
			menu_setting_expand_image_load_enable_unload: {
				message: "イメージのアンロードを有効"
			},
			menu_setting_expand_image_load_unload: {
				message: "イメージのアンロード条件"
			},
			menu_setting_expand_image_load_allow_unload_more_then_text: {
				message: "MByte以上ロードした場合、古いイメージを解放する"
			},
			menu_setting_expand_sound: {
				message: "サウンド展開定義"
			},
			menu_setting_expand_sound_inline: {
				message: "インライン表示の設定"
			},
			menu_setting_expand_sound_inline_check_box_container: {
				message: "インライン表示の設定"
			},
			menu_setting_expand_sound_inline_disable_same_text: {
				message: "同じURLは展開しない"
			},
			menu_setting_expand_sound_inline_sound_max: {
				message: "最大同時表示数"
			},
			menu_setting_expand_sound_inline_script_allow: {
				message: "リンクからインライン表示する条件"
			},
			menu_setting_expand_sound_inline_script_insert: {
				message: "オーディオの挿入位置"
			},
			menu_setting_expand_sound_inline_element: {
				message: "HTMLAudioElement の設定"
			},
			menu_setting_expand_sound_inline_element_script_allow: {
				message: "HTMLAudioElement を表示する条件"
			},
			menu_setting_expand_sound_inline_soundcloud: {
				message: "soundcloud.com の設定"
			},
			menu_setting_expand_sound_inline_soundcloud_check_box_container: {
				message: "soundcloud.com の設定"
			},
			menu_setting_expand_sound_inline_soundcloud_visible_player_flash: {
				message: "Flash 版のプレイヤーを表示"
			},
			menu_setting_expand_sound_inline_soundcloud_visible_player_html5: {
				message: "HTML5 版のプレイヤーを表示"
			},
			menu_setting_expand_sound_inline_mixcloud: {
				message: "www.mixcloud.com の設定"
			},
			menu_setting_expand_sound_inline_mixcloud_check_box_container: {
				message: "www.mixcloud.com の設定"
			},
			menu_setting_expand_sound_inline_mixcloud_visible_player: {
				message: "プレイヤーを表示"
			},
			menu_setting_expand_video: {
				message: "ビデオ展開定義"
			},
			menu_setting_expand_video_inline: {
				message: "インライン表示の設定"
			},
			menu_setting_expand_video_inline_check_box_container: {
				message: "インライン表示の設定"
			},
			menu_setting_expand_video_inline_disable_same_video: {
				message: "同じURLは展開しない"
			},
			menu_setting_expand_video_inline_video_max: {
				message: "最大同時表示数"
			},
			menu_setting_expand_video_inline_script_allow: {
				message: "リンクからインライン表示する条件"
			},
			menu_setting_expand_video_inline_script_insert: {
				message: "エレメントの挿入位置"
			},
			menu_setting_expand_video_inline_element: {
				message: "HTMLVideoElement の設定"
			},
			menu_setting_expand_video_inline_element_script_allow: {
				message: "HTMLVideoElement を表示する条件"
			},
			menu_setting_expand_video_inline_youtube: {
				message: "www.youtube.com の設定"
			},
			menu_setting_expand_video_inline_youtube_check_box_container: {
				message: "www.youtube.com の設定"
			},
			menu_setting_expand_video_inline_youtube_visible_video: {
				message: "ビデオを表示"
			},
			menu_setting_expand_video_inline_nicovideo: {
				message: "www.nicovideo.jp の設定"
			},
			menu_setting_expand_video_inline_nicovideo_check_box_container: {
				message: "www.nicovideo.jp の設定"
			},
			menu_setting_expand_video_inline_nicovideo_visible_video: {
				message: "ビデオを表示"
			},
			menu_setting_expand_video_inline_nicovideo_visible_thumbnail_video: {
				message: "ビデオサムネイルを表示"
			},
			menu_setting_expand_video_inline_nicovideo_visible_thumbnail_mylist: {
				message: "マイリストサムネイルを表示"
			},
			menu_setting_expand_video_inline_nicovideo_visible_thumbnail_user: {
				message: "ユーザーサムネイルを表示"
			},
			menu_setting_expand_video_inline_nicovideo_visible_thumbnail_community: {
				message: "コミュニティサムネイルを表示"
			},
			menu_setting_expand_video_inline_nicovideo_visible_thumbnail_live: {
				message: "生放送サムネイルを表示"
			},
			menu_setting_expand_video_inline_nicovideo_visible_thumbnail_seiga: {
				message: "静画サムネイルを表示"
			},
			menu_setting_expand_video_inline_ustream: {
				message: "www.ustream.tv の設定"
			},
			menu_setting_expand_video_inline_ustream_check_box_container: {
				message: "www.ustream.tv の設定"
			},
			menu_setting_expand_video_inline_ustream_visible_video_live: {
				message: "配信ビデオを表示"
			},
			menu_setting_expand_video_inline_ustream_visible_video_record: {
				message: "録画ビデオを表示"
			},
			menu_setting_expand_video_inline_dailymotion: {
				message: "www.dailymotion.com の設定"
			},
			menu_setting_expand_video_inline_dailymotion_check_box_container: {
				message: "www.dailymotion.com の設定"
			},
			menu_setting_expand_video_inline_dailymotion_visible_video: {
				message: "ビデオを表示"
			},
			menu_setting_expand_video_inline_video: {
				message: "vimeo.com の設定"
			},
			menu_setting_expand_video_inline_video_check_box_container: {
				message: "vimeo.com の設定"
			},
			menu_setting_expand_video_inline_video_visible_video: {
				message: "ビデオを表示"
			},
			menu_setting_expand_video_inline_fc2video: {
				message: "video.fc2.com の設定"
			},
			menu_setting_expand_video_inline_fc2video_check_box_container: {
				message: "video.fc2.com の設定"
			},
			menu_setting_expand_video_inline_fc2video_visible_video: {
				message: "ビデオを表示"
			},
			menu_setting_expand_video_inline_liveleak: {
				message: "www.liveleak.com の設定"
			},
			menu_setting_expand_video_inline_liveleak_check_box_container: {
				message: "www.liveleak.com の設定"
			},
			menu_setting_expand_video_inline_liveleak_visible_video: {
				message: "ビデオを表示"
			},
			menu_setting_expand_iframe: {
				message: "インラインフレーム展開定義"
			},
			menu_setting_expand_iframe_inline: {
				message: "インライン表示の設定"
			},
			menu_setting_expand_iframe_inline_check_box_container: {
				message: "インライン表示の設定"
			},
			menu_setting_expand_iframe_inline_disable_same_iframe: {
				message: "同じURLは展開しない"
			},
			menu_setting_expand_iframe_inline_script_allow: {
				message: "リンクからインライン表示する条件"
			},
			menu_setting_expand_iframe_inline_script_insert: {
				message: "HTMLIFrameElement の挿入位置"
			},
			menu_setting_style_sheet: {
				message: "スタイルシート定義"
			},
			menu_setting_style_sheet_expand_text: {
				message: "テキスト展開のスタイル"
			},
			menu_setting_style_sheet_expand_text_element: {
				message: "HTMLTextAreaElement の設定"
			},
			menu_setting_style_sheet_expand_text_element_inline: {
				message: "テキストのインライン表示"
			},
			menu_setting_style_sheet_expand_image: {
				message: "イメージ展開のスタイル"
			},
			menu_setting_style_sheet_expand_image_element: {
				message: "HTMImageElement の設定"
			},
			menu_setting_style_sheet_expand_image_element_inline: {
				message: "イメージのサムネイル表示"
			},
			menu_setting_style_sheet_expand_image_element_popup: {
				message: "イメージのポップアップ表示"
			},
			menu_setting_style_sheet_expand_sound: {
				message: "サウンド展開のスタイル"
			},
			menu_setting_style_sheet_expand_sound_element: {
				message: "HTMLAudioElement の設定"
			},
			menu_setting_style_sheet_expand_sound_element_inline_audio: {
				message: "オーディオのインライン表示"
			},
			menu_setting_style_sheet_expand_sound_soundcloud: {
				message: "soundcloud.com の設定"
			},
			menu_setting_style_sheet_expand_sound_soundcloud_inline_player_flash: {
				message: "Flash 版プレイヤーのインライン表示"
			},
			menu_setting_style_sheet_expand_sound_soundcloud_inline_player_html5: {
				message: "HTML5 版プレイヤーのインライン表示"
			},
			menu_setting_style_sheet_expand_sound_mixcloud: {
				message: "www.mixcloud.com の設定"
			},
			menu_setting_style_sheet_expand_sound_mixcloud_inline_player: {
				message: "プレイヤーのインライン表示"
			},
			menu_setting_style_sheet_expand_video: {
				message: "ビデオ展開のスタイル"
			},
			menu_setting_style_sheet_expand_video_element: {
				message: "HTMLVideoElement の設定"
			},
			menu_setting_style_sheet_expand_video_element_inline_video: {
				message: "ビデオのインライン表示"
			},
			menu_setting_style_sheet_expand_video_youtube: {
				message: "www.youtube.com の設定"
			},
			menu_setting_style_sheet_expand_video_youtube_inline_video: {
				message: "ビデオのインライン表示"
			},
			menu_setting_style_sheet_expand_video_nicovideo: {
				message: "www.nicovideo.jp の設定"
			},
			menu_setting_style_sheet_expand_video_nicovideo_inline_video: {
				message: "ビデオのインライン表示"
			},
			menu_setting_style_sheet_expand_video_nicovideo_inline_thumbnail_video: {
				message: "ビデオサムネイルのインライン表示"
			},
			menu_setting_style_sheet_expand_video_nicovideo_inline_thumbnail_mylist: {
				message: "マイリストサムネイルのインライン表示"
			},
			menu_setting_style_sheet_expand_video_nicovideo_inline_thumbnail_user: {
				message: "ユーザーサムネイルのインライン表示"
			},
			menu_setting_style_sheet_expand_video_nicovideo_inline_thumbnail_community: {
				message: "コミュニティサムネイルのインライン表示"
			},
			menu_setting_style_sheet_expand_video_nicovideo_inline_thumbnail_live: {
				message: "生放送サムネイルのインライン表示"
			},
			menu_setting_style_sheet_expand_video_nicovideo_inline_thumbnail_seiga: {
				message: "静画サムネイルのインライン表示"
			},
			menu_setting_style_sheet_expand_video_ustream: {
				message: "www.ustream.tv の設定"
			},
			menu_setting_style_sheet_expand_video_ustream_inline_video_record: {
				message: "配信ビデオのインライン表示"
			},
			menu_setting_style_sheet_expand_video_ustream_inline_video_live: {
				message: "録画ビデオのインライン表示"
			},
			menu_setting_style_sheet_expand_video_dailymotion: {
				message: "www.dailymotion.com の設定"
			},
			menu_setting_style_sheet_expand_video_dailymotion_inline_video: {
				message: "ビデオのインライン表示"
			},
			menu_setting_style_sheet_expand_video_vimeo: {
				message: "vimeo.com の設定"
			},
			menu_setting_style_sheet_expand_video_vimeo_inline_video: {
				message: "ビデオのインライン表示"
			},
			menu_setting_style_sheet_expand_video_fc2video: {
				message: "video.fc2.com の設定"
			},
			menu_setting_style_sheet_expand_video_fc2video_inline_video: {
				message: "ビデオのインライン表示"
			},
			menu_setting_style_sheet_expand_video_liveleak: {
				message: "www.liveleak.com の設定"
			},
			menu_setting_style_sheet_expand_video_liveleak_inline_video: {
				message: "ビデオのインライン表示"
			},
			menu_setting_style_sheet_expand_iframe: {
				message: "インラインフレーム展開のスタイル"
			},
			menu_setting_style_sheet_expand_iframe_element: {
				message: "HTMLIFrameElement の設定"
			},
			menu_setting_style_sheet_expand_iframe_element_inline: {
				message: "インラインフレームのインライン表示"
			},
			menu_setting_experimental: {
				message: "試験運用機能の定義"
			},
			menu_setting_experimental_revise_scroll: {
				message: "スクロール補正機能"
			},
			menu_setting_experimental_revise_scroll_check_box_container: {
				message: "スクロール補正の設定"
			},
			menu_setting_experimental_revise_scroll_enable: {
				message: "有効"
			},
			menu_setting_experimental_revise_scroll_threshold_vertical: {
				message: "補正対象とする縦方向のしきい値（ 0 [画面上端] ～ 100 [画面下端] ）"
			},
			menu_setting_language: {
				message: "LANGUAGE (言語設定)"
			},
			menu_credit: {
				message: "クレジット"
			},
			menu_credit_info_version: {
				message: "バージョン情報"
			},
			menu_credit_info_copyright: {
				message: "製作"
			},
			menu_setting_define_list: {
				message: "定義一覧"
			},
			menu_setting_define_list_hint: {
				message: "リストを選択すると下部のコントロールの入力が可能です。複数選択可。複数選択時は同時編集。灰色はプリセット設定。プリセット設定は削除不可。"
			},
			menu_setting_define_button_add: {
				message: "追加"
			},
			menu_setting_define_button_delete: {
				message: "削除"
			},
			menu_setting_define_button_move_up: {
				message: "上に移動"
			},
			menu_setting_define_button_move_down: {
				message: "下に移動"
			},
			menu_setting_define_button_export: {
				message: "エクスポート"
			},
			menu_setting_define_button_import: {
				message: "インポート"
			},
			menu_setting_define_add_dialog: {
				message: "定義の新規作成"
			},
			menu_setting_define_add_dialog_name: {
				message: "名前"
			},
			menu_setting_define_add_dialog_copy_define: {
				message: "既存の定義から複製"
			},
			menu_setting_define_add_dialog_define_list_box_item_new: {
				message: "複製せずに新規作成する"
			},
			menu_setting_define_delete_dialog: {
				message: "定義の削除"
			},
			menu_setting_define_delete_dialog_name: {
				message: "削除する定義名"
			},
			menu_setting_define_delete_dialog_change_define: {
				message: "定義の代替選択"
			},
			menu_setting_define_delete_dialog_define_list_box_item_no_use: {
				message: "定義を使用しない"
			},
			menu_setting_define_name: {
				message: "定義名"
			},
			menu_setting_define_export_dialog: {
				message: "定義のエクスポート"
			},
			menu_setting_define_export_dialog_export: {
				message: "エクスポート"
			},
			menu_setting_define_export_dialog_export_hint: {
				message: "テキストエリアの値をコピーして下さい。"
			},
			menu_setting_define_import_dialog: {
				message: "定義のインポート"
			},
			menu_setting_define_import_dialog_explanation: {
				message: "インポートについて"
			},
			menu_setting_define_import_dialog_explanation_0: {
				message: "プリセット設定は上書き、ユーザー設定は新規追加されます。"
			},
			menu_setting_define_import_dialog_explanation_1: {
				message: "インポートを行う前に、基本設定のエクスポート機能でバックアップを取ることをお勧めします。"
			},
			menu_setting_define_import_dialog_explanation_2: {
				message: "信頼の無い人物が作成した設定データを、絶対にインポートしないで下さい。悪意のあるコードが含まれる恐れがあります。"
			},
			menu_setting_define_import_dialog_import: {
				message: "インポート"
			},
			menu_setting_define_import_dialog_import_hint: {
				message: "エクスポートから出力したテキストをペーストして下さい。"
			},
			menu_setting_define_import_dialog_confirm: {
				message: "インポートを実行しますか？"
			},
			menu_setting_define_import_alert: {
				message: "インポートの結果"
			},
			menu_setting_define_import_alert_success: {
				message: "インポートが完了しました。"
			},
			menu_setting_define_import_alert_failure: {
				message: "インポートに失敗しました。"
			},
			menu_setting_filter_list: {
				message: "フィルタ一覧"
			},
			menu_setting_filter_list_hint: {
				message: "リストを選択すると下部のコントロールの入力が可能です。上から順番にURLの比較を行いマッチすればその設定が使用されます。"
			},
			menu_setting_filter_button_add: {
				message: "追加"
			},
			menu_setting_filter_button_delete: {
				message: "削除"
			},
			menu_setting_filter_button_prio_up: {
				message: "優先度を上げる"
			},
			menu_setting_filter_button_prio_down: {
				message: "優先度を下げる"
			},
			menu_setting_filter_add_dialog: {
				message: "フィルタの新規作成"
			},
			menu_setting_filter_add_dialog_name: {
				message: "名前"
			},
			menu_setting_filter_add_dialog_copy_define: {
				message: "既存の設定から複製"
			},
			menu_setting_filter_add_dialog_define_list_box_item_new: {
				message: "複製せずに新規作成する"
			},
			menu_button_ok: {
				message: "OK"
			},
			menu_button_yes: {
				message: "決定"
			},
			menu_button_no: {
				message: "キャンセル"
			},
			menu_scriptarea_hint: {
				message: "配列に格納して匿名関数を記述します。信頼の無い人物が作成したスクリプトを、絶対に書き込まないで下さい。悪意のあるコードが含まれる恐れがあります。"
			},
			menu_text_regexp_hint: {
				message: "正規表現文字列を記述。[オプション] g…繰り返し処理、i…小文字と大文字を区別しない"
			},
			menu_regexp_list_button_add: {
				message: "追加"
			},
			menu_regexp_list_button_delete: {
				message: "削除"
			},
			menu_regexp_list_button_move_up: {
				message: "上に移動"
			},
			menu_regexp_list_button_move_down: {
				message: "下に移動"
			},
			page_expand_popup_menu: {
				message: "PageExpand メニュー"
			},
			context_menu_pageexpand_config: {
				message: "PageExpand の設定"
			},
			context_menu_pageexpand_config_current_page: {
				message: "現在のページの設定を編集"
			},
			context_menu_pageexpand_config_current_bbs: {
				message: "現在の掲示板の設定を編集"
			},
			context_menu_pageexpand_config_current_page_confirm: {
				message: "PageExpand 設定は規定のページ内でしか動作しません。（Web ページ側から悪意のあるコードが埋め込まれるのを防ぐため）\n以下の規定ページを開きますか？\n\n"
			},
			context_menu_pageexpand_execute: {
				message: "PageExpand の実行"
			},
			context_menu_pageexpand_debug: {
				message: "PageExpand デバッグ"
			}
		},
		en: {
			extension_name: {
				message: "PageExpand"
			},
			extension_description: {
				message: "Image Zoom. Expand Audio and Video. Expand the short URL. Generate a link from text. Override Referer. Extend BBS. etc..."
			},
			page_expand_config: {
				message: "PageExpand Setting"
			},
			menu_setting_standard: {
				message: "Standard Setting"
			},
			menu_setting_standard_filter_url: {
				message: "To limit the operation by URL"
			},
			menu_setting_standard_filter_url_combo_box_item_deny: {
				message: "Do not operate only at the specified address. (Otherwise it will all work.)"
			},
			menu_setting_standard_filter_url_combo_box_item_allow: {
				message: "Work only at the specified address. (Otherwise, all does not work.)"
			},
			menu_setting_standard_filter_url_hint: {
				message: "Describes the URL. Can be used an asterisk. Can be specified multi line."
			},
			menu_setting_standard_check_box_container: {
				message: "Standard Setting"
			},
			menu_setting_standard_enable_icon_address_bar: {
				message: "Displays an icon in the address bar."
			},
			menu_setting_standard_enable_context_menu: {
				message: "Display the context menu."
			},
			menu_setting_standard_enable_enable_startup: {
				message: "Operation starts from when the load is finished."
			},
			menu_setting_standard_enable_debug_mode: {
				message: "Running in debug mode."
			},
			menu_setting_standard_enable_output_log: {
				message: "Output the log to the console.(debug)"
			},
			menu_setting_standard_load: {
				message: "Download Setting"
			},
			menu_setting_standard_load_thread_max: {
				message: "Maximum number of simultaneous downloads"
			},
			menu_setting_standard_execute_queue: {
				message: "ExecuteQueue Setting (Normally, you do not need to change.)"
			},
			menu_setting_standard_execute_queue_time_sleep: {
				message: "Sleep time (Millisecond)"
			},
			menu_setting_standard_execute_queue_time_occupancy: {
				message: "Maximum CPU occupancy time (Millisecond)"
			},
			menu_setting_standard_execute_queue_hint: {
				message: "When maximum CPU occupancy time is large, Response operation is worse,The script will run faster. If the sleep time is small,CPU utilization is higher,The script will run faster."
			},
			menu_setting_standard_export_import: {
				message: "Setting Export / Import"
			},
			menu_setting_standard_export_button: {
				message: "Export"
			},
			menu_setting_standard_import_button: {
				message: "Import"
			},
			menu_setting_standard_export_dialog: {
				message: "Setting Export"
			},
			menu_setting_standard_export_dialog_export: {
				message: "Export"
			},
			menu_setting_standard_export_dialog_export_hint: {
				message: "Please copy the text of TextArea."
			},
			menu_setting_standard_import_dialog: {
				message: "Setting Import"
			},
			menu_setting_standard_import_dialog_explanation: {
				message: "information about Import"
			},
			menu_setting_standard_import_dialog_explanation_0: {
				message: "All current settings will be lost."
			},
			menu_setting_standard_import_dialog_explanation_1: {
				message: "It is recommended that you take a backup on the export function."
			},
			menu_setting_standard_import_dialog_explanation_2: {
				message: "Please note so that it does not contain malicious code."
			},
			menu_setting_standard_import_dialog_import: {
				message: "Import"
			},
			menu_setting_standard_import_dialog_import_hint: {
				message: "Please paste the output text from Export."
			},
			menu_setting_standard_import_dialog_confirm: {
				message: "Do you want to Import?"
			},
			menu_setting_standard_import_alert: {
				message: "A result of the import"
			},
			menu_setting_standard_import_alert_success: {
				message: "Import has been completed."
			},
			menu_setting_standard_import_alert_failure: {
				message: "Failed to import."
			},
			menu_setting_standard_storage_sync: {
				message: "Sync Storage"
			},
			menu_setting_standard_storage_sync_load_button: {
				message: "Load"
			},
			menu_setting_standard_storage_sync_save_button: {
				message: "Save"
			},
			menu_setting_standard_storage_sync_delete_button: {
				message: "Delete"
			},
			menu_setting_standard_storage_sync_load_dialog: {
				message: "Load from the Sync Storage"
			},
			menu_setting_standard_storage_sync_load_dialog_explanation: {
				message: "information about Load from the Sync Storage"
			},
			menu_setting_standard_storage_sync_load_dialog_explanation_0: {
				message: "Load the data from the Sync Storage, apply to PageExpand Setting."
			},
			menu_setting_standard_storage_sync_load_dialog_explanation_1: {
				message: "All current settings will be lost."
			},
			menu_setting_standard_storage_sync_load_dialog_explanation_2: {
				message: "It is recommended that you take a backup on the export function."
			},
			menu_setting_standard_storage_sync_load_dialog_confirm: {
				message: "Do you want to Load from the Sync Storage?"
			},
			menu_setting_standard_storage_sync_load_alert: {
				message: "A result of the Load from the Sync Storage"
			},
			menu_setting_standard_storage_sync_load_alert_success: {
				message: "Load from the Sync Storage has been completed."
			},
			menu_setting_standard_storage_sync_load_alert_failure: {
				message: "Failed to the Load from the Sync Storage."
			},
			menu_setting_standard_storage_sync_save_dialog: {
				message: "Save to the Sync Storage"
			},
			menu_setting_standard_storage_sync_save_dialog_explanation: {
				message: "information about Save to the Sync Storage"
			},
			menu_setting_standard_storage_sync_save_dialog_explanation_0: {
				message: "Save the current settings to the Sync Storage."
			},
			menu_setting_standard_storage_sync_save_dialog_explanation_1: {
				message: "Need to enable the functionality of the sync of browser."
			},
			menu_setting_standard_storage_sync_save_dialog_explanation_2: {
				message: "There is a limit to the size. Fail if the size is too large."
			},
			menu_setting_standard_storage_sync_save_dialog_confirm: {
				message: "Do you want to Save to the Sync Storage?"
			},
			menu_setting_standard_storage_sync_save_alert: {
				message: "A result of the Save to the Sync Storage"
			},
			menu_setting_standard_storage_sync_save_alert_success: {
				message: "Save to the Sync Storage has been completed."
			},
			menu_setting_standard_storage_sync_save_alert_failure: {
				message: "Failed to the Save to the Sync Storage."
			},
			menu_setting_standard_storage_sync_delete_dialog: {
				message: "Delete from the Sync Storage"
			},
			menu_setting_standard_storage_sync_delete_dialog_explanation: {
				message: "information about Delete from the Sync Storage"
			},
			menu_setting_standard_storage_sync_delete_dialog_explanation_0: {
				message: "Delete the setting data stored in the Sync Storage."
			},
			menu_setting_standard_storage_sync_delete_dialog_confirm: {
				message: "Do you want to Delete from the Sync Storage?"
			},
			menu_setting_standard_storage_sync_delete_alert: {
				message: "A result of the Delete from the Sync Storage"
			},
			menu_setting_standard_storage_sync_delete_alert_success: {
				message: "Delete from the Sync Storage has been completed."
			},
			menu_setting_standard_storage_sync_delete_alert_failure: {
				message: "Failed to the Delete from the Sync Storage."
			},
			menu_setting_standard_reset: {
				message: "Initialization of setting"
			},
			menu_setting_standard_reset_button: {
				message: "Remove all the settings, Return to the initial state."
			},
			menu_setting_standard_reset_dialog: {
				message: "Initialization of setting"
			},
			menu_setting_standard_reset_dialog_explanation: {
				message: "information about Initialization"
			},
			menu_setting_standard_reset_dialog_explanation_0: {
				message: "Returns all settings to their default state."
			},
			menu_setting_standard_reset_dialog_explanation_1: {
				message: "All current settings will be lost."
			},
			menu_setting_standard_reset_dialog_confirm: {
				message: "Do you want to Initialization?"
			},
			menu_setting_standard_reset_alert: {
				message: "Initialization results"
			},
			menu_setting_standard_reset_alert_success: {
				message: "Configuration initialization has been completed."
			},
			menu_setting_standard_reset_alert_failure: {
				message: "Failed to initialize the configuration."
			},
			menu_setting_expand_bbs: {
				message: "BBS Settng"
			},
			menu_setting_expand_bbs_list: {
				message: "List of BBS Setting"
			},
			menu_setting_expand_bbs_list_hint: {
				message: "When you select an item in the list, the lower control can be edited. Condition script will be executed in order from top to bottom. possible to select multiple. Can be edited by multiple selection. Gray is preset setting. Preset setting can not be deleted."
			},
			menu_setting_expand_bbs_button_add: {
				message: "add"
			},
			menu_setting_expand_bbs_button_delete: {
				message: "delete"
			},
			menu_setting_expand_bbs_button_prio_up: {
				message: "prio up"
			},
			menu_setting_expand_bbs_button_prio_down: {
				message: "prio down"
			},
			menu_setting_expand_bbs_add_dialog: {
				message: "Creating a new BBS Setting"
			},
			menu_setting_expand_bbs_add_dialog_name: {
				message: "Name"
			},
			menu_setting_expand_bbs_add_dialog_copy_define: {
				message: "Replicated from the existing setting."
			},
			menu_setting_expand_bbs_add_dialog_define_list_box_item_new: {
				message: "create a new"
			},
			menu_setting_expand_bbs_name: {
				message: "Name"
			},
			menu_setting_expand_bbs_check_box_container: {
				message: "BBS Settng"
			},
			menu_setting_expand_bbs_enable_setting: {
				message: "Enable Setting"
			},
			menu_setting_expand_bbs_filter_url: {
				message: "URL to allow the operation"
			},
			menu_setting_expand_bbs_popup_check_box_container: {
				message: "Popup Setting"
			},
			menu_setting_expand_bbs_popup_enable_animation: {
				message: "Enable pop-up animation"
			},
			menu_setting_expand_bbs_popup_origin_type: {
				message: "Placement origin of the pop-up"
			},
			menu_setting_expand_bbs_popup_origin_type_combo_box_item_adsorb_top_bottom: {
				message: "adsorb top bottom"
			},
			menu_setting_expand_bbs_popup_origin_type_combo_box_item_adsorb_left_right: {
				message: "adsorb left right"
			},
			menu_setting_expand_bbs_popup_position_type: {
				message: "Arrangement position of the pop-up"
			},
			menu_setting_expand_bbs_popup_position_type_combo_box_item_absolute: {
				message: "absolute"
			},
			menu_setting_expand_bbs_popup_position_type_combo_box_item_fixed: {
				message: "fixed"
			},
			menu_setting_expand_bbs_popup_percent: {
				message: "Popup Size"
			},
			menu_setting_expand_bbs_popup_percent_h: {
				message: "Percent Horizontal (0-100)"
			},
			menu_setting_expand_bbs_popup_percent_v: {
				message: "Percent Vertical (0-100)"
			},
			menu_setting_expand_bbs_popup_time: {
				message: "Popup Time"
			},
			menu_setting_expand_bbs_popup_time_wait_open: {
				message: "The time to wait before open (Millisecond)"
			},
			menu_setting_expand_bbs_popup_time_wait_close: {
				message: "The time to wait before close (Millisecond)"
			},
			menu_setting_expand_bbs_popup_style_sheet: {
				message: "Stylesheet of Popup"
			},
			menu_setting_expand_bbs_script_initialize: {
				message: "Initialize Script"
			},
			menu_setting_expand_bbs_script_callback: {
				message: "Callback Script"
			},
			menu_setting_urlmap: {
				message: "URL Mapping Setting"
			},
			menu_setting_urlmap_list: {
				message: "List of URL Mapping Setting"
			},
			menu_setting_urlmap_list_hint: {
				message: "When you select an item in the list, the lower control can be edited. Will be compared with the order from above. possible to select multiple. Can be edited by multiple selection. Gray is preset setting. Preset setting can not be deleted."
			},
			menu_setting_urlmap_button_add: {
				message: "add"
			},
			menu_setting_urlmap_button_delete: {
				message: "delete"
			},
			menu_setting_urlmap_button_prio_up: {
				message: "prio up"
			},
			menu_setting_urlmap_button_prio_down: {
				message: "prio down"
			},
			menu_setting_urlmap_add_dialog: {
				message: "Creating a new URL Mapping"
			},
			menu_setting_urlmap_add_dialog_name: {
				message: "Name"
			},
			menu_setting_urlmap_add_dialog_copy_define: {
				message: "Replicated from the existing setting."
			},
			menu_setting_urlmap_add_dialog_define_list_box_item_new: {
				message: "create a new"
			},
			menu_setting_urlmap_name: {
				message: "Name"
			},
			menu_setting_urlmap_check_box_container: {
				message: "URL Mapping Setting"
			},
			menu_setting_urlmap_enable_setting: {
				message: "Enable Setting"
			},
			menu_setting_urlmap_filter_url: {
				message: "URL to allow the operation"
			},
			menu_setting_urlmap_filter_url_hint: {
				message: "Describes the URL. Can be used an asterisk. Can be specified multi line."
			},
			menu_setting_urlmap_unsecure_check_box_container: {
				message: "Security"
			},
			menu_setting_urlmap_enable_unsecure: {
				message: "Expand \"resources in the http://\" in a secure page."
			},
			menu_setting_urlmap_enable_unsecure_hint: {
				message: "When disabled, Expand \"resources in the https://\". When enabled, expand \"resources in the http://\" further. However, the encryption warning is always displayed."
			},
			menu_setting_urlmap_enable_mixed_content: {
				message: "Will try to expand \"Mixed content that is blocked by default\" in a secure page."
			},
			menu_setting_urlmap_enable_mixed_content_hint: {
				message: "The browser will block the deployment of \"some of the elements\". When disabled, \"Elements that are blocked\" will not expand. When enabled, Will try to expand all elements. (Will fail unless change the settings in browser.)"
			},
			menu_setting_urlmap_define_button_edit: {
				message: "edit"
			},
			menu_setting_urlmap_define_button_add: {
				message: "add"
			},
			menu_setting_urlmap_define_button_remove: {
				message: "remove"
			},
			menu_setting_urlmap_define_button_prio_up: {
				message: "up"
			},
			menu_setting_urlmap_define_button_prio_down: {
				message: "down"
			},
			menu_setting_urlmap_define_combo_box_item_no_use: {
				message: "not use the definine"
			},
			menu_setting_define_multi_select_add_dialog: {
				message: "add the define"
			},
			menu_setting_define_multi_select_add_dialog_list: {
				message: "Select the define you want to add."
			},
			menu_setting_access_block: {
				message: "Blocking Access Define"
			},
			menu_setting_access_block_filter_url: {
				message: "URL to block access"
			},
			menu_setting_access_block_filter_url_hint: {
				message: "Describes the URL. Can be used an asterisk. Can be specified multi line."
			},
			menu_setting_replacement_to_element: {
				message: "Replace Element Define"
			},
			menu_setting_replacement_to_element_script: {
				message: "Callback Script"
			},
			menu_setting_replacement_to_text: {
				message: "Replace Text Define"
			},
			menu_setting_replacement_to_text_script: {
				message: "Callback Script"
			},
			menu_setting_replacement_to_anchor: {
				message: "Replace Anchor Define"
			},
			menu_setting_replacement_to_anchor_script: {
				message: "Callback Script"
			},
			menu_setting_replacement_to_link: {
				message: "Replace Link Define"
			},
			menu_setting_replacement_to_link_filter_list: {
				message: "Filter List"
			},
			menu_setting_replacement_to_link_filter_name: {
				message: "Filter Name"
			},
			menu_setting_replacement_to_link_filter: {
				message: "Filter Setting"
			},
			menu_setting_replacement_to_link_filter_filter_url: {
				message: "Link URL to allow the operation"
			},
			menu_setting_replacement_to_link_filter_filter_url_hint: {
				message: "Describes the URL. Can be used an asterisk. Can be specified multi line."
			},
			menu_setting_replacement_to_link_check_box_container: {
				message: "Setting to link"
			},
			menu_setting_replacement_to_link_enable_reflect_to_anchor: {
				message: "Reflected to the HTMLAnchorElement href"
			},
			menu_setting_replacement_to_link_enable_cache: {
				message: "Cache the results of callback script"
			},
			menu_setting_replacement_to_link_filter_script: {
				message: "Callback Script"
			},
			menu_setting_replacement_to_referer: {
				message: "Replace Referer Define"
			},
			menu_setting_replacement_to_referer_filter_list: {
				message: "Filter List"
			},
			menu_setting_replacement_to_referer_filter_name: {
				message: "Filter Name"
			},
			menu_setting_replacement_to_referer_filter: {
				message: "Filter Setting"
			},
			menu_setting_replacement_to_referer_filter_filter_url: {
				message: "Link URL to allow the operation"
			},
			menu_setting_replacement_to_referer_filter_filter_url_hint: {
				message: "Describes the URL. Can be used an asterisk. Can be specified multi line."
			},
			menu_setting_replacement_to_referer_filter_send_type: {
				message: "Basic Referer"
			},
			menu_setting_replacement_to_referer_filter_send_type_combo_box_item: {
				message: "Basic Referer Value"
			},
			menu_setting_replacement_to_referer_filter_send_type_combo_box_item_default: {
				message: "default"
			},
			menu_setting_replacement_to_referer_filter_send_type_combo_box_item_current_url: {
				message: "current url"
			},
			menu_setting_replacement_to_referer_filter_send_type_combo_box_item_link_url: {
				message: "link url"
			},
			menu_setting_replacement_to_referer_filter_send_type_combo_box_item_custom: {
				message: "custom"
			},
			menu_setting_replacement_to_referer_filter_send_custom: {
				message: "Custom String"
			},
			menu_setting_replacement_to_referer_filter_send_regexp: {
				message: "Replaced by a regular expression"
			},
			menu_setting_replacement_to_referer_filter_send_regexp_match: {
				message: "Match conditions"
			},
			menu_setting_replacement_to_referer_filter_send_regexp_replacement: {
				message: "Replace String"
			},
			menu_setting_replacement_to_referer_filter_send_regexp_replacement_hint: {
				message: "$0...Whole match. $1-$9...Partial match. $$…Dollar sign escape sequence."
			},
			menu_setting_replacement_to_useragent: {
				message: "Replace Useragent Define"
			},
			menu_setting_replacement_to_useragent_filter_list: {
				message: "Filter List"
			},
			menu_setting_replacement_to_useragent_filter_name: {
				message: "Filter Name"
			},
			menu_setting_replacement_to_useragent_filter: {
				message: "Filter Setting"
			},
			menu_setting_replacement_to_useragent_filter_filter_url: {
				message: "Link URL to allow the operation"
			},
			menu_setting_replacement_to_useragent_filter_filter_url_hint: {
				message: "Describes the URL. Can be used an asterisk. Can be specified multi line."
			},
			menu_setting_replacement_to_useragent_filter_send: {
				message: "Basic Useragent"
			},
			menu_setting_replacement_to_useragent_filter_send_custom: {
				message: "Custom String"
			},
			menu_setting_make_link_to_text: {
				message: "Make Link To Text Define"
			},
			menu_setting_make_link_to_text_script: {
				message: "Callback Script"
			},
			menu_setting_expand_short_url: {
				message: "Expand Short Url Define"
			},
			menu_setting_expand_short_url_filter_url: {
				message: "URL to allow the operation"
			},
			menu_setting_expand_short_url_filter_url_hint: {
				message: "Describes the URL. Can be used an asterisk. Can be specified multi line."
			},
			menu_setting_expand_text: {
				message: "Expand Text Define"
			},
			menu_setting_expand_text_inline: {
				message: "Setting to display inline"
			},
			menu_setting_expand_text_inline_check_box_container: {
				message: "Setting to display inline"
			},
			menu_setting_expand_text_inline_disable_same_text: {
				message: "If the same URL, not to Expand."
			},
			menu_setting_expand_text_inline_script_allow: {
				message: "Condition to display inline from a link"
			},
			menu_setting_expand_text_inline_script_insert: {
				message: "Text Insert"
			},
			menu_setting_expand_image: {
				message: "Expand Image Define"
			},
			menu_setting_expand_image_thumbnail: {
				message: "Setting to display thumbnail"
			},
			menu_setting_expand_image_thumbnail_check_box_container: {
				message: "Setting to display thumbnail"
			},
			menu_setting_expand_image_thumbnail_enable_popup_mouseover: {
				message: "If you mouse over the thumbnail, a pop-up display"
			},
			menu_setting_expand_image_thumbnail_disable_same_thumbnail_image: {
				message: "If the same URL, not to Expand."
			},
			menu_setting_expand_image_thumbnail_script_allow: {
				message: "Condition to display thumbnail from a link"
			},
			menu_setting_expand_image_thumbnail_script_insert: {
				message: "Thumbnail Insert"
			},
			menu_setting_expand_image_popup: {
				message: "Setting to display popup"
			},
			menu_setting_expand_image_popup_check_box_container: {
				message: "Setting to display popup"
			},
			menu_setting_expand_image_popup_enable_animation_scale: {
				message: "Enable scale fade animation"
			},
			menu_setting_expand_image_popup_enable_animation_alpha: {
				message: "Enable alpha fade animation"
			},
			menu_setting_expand_image_popup_origin_type: {
				message: "Placement origin of the pop-up image"
			},
			menu_setting_expand_image_popup_origin_type_combo_box_item_center: {
				message: "center"
			},
			menu_setting_expand_image_popup_origin_type_combo_box_item_upper_left: {
				message: "upper left"
			},
			menu_setting_expand_image_popup_origin_type_combo_box_item_upper_right: {
				message: "upper right"
			},
			menu_setting_expand_image_popup_origin_type_combo_box_item_client_center: {
				message: "client center"
			},
			menu_setting_expand_image_popup_origin_type_combo_box_item_adsorb_element: {
				message: "adsorb element"
			},
			menu_setting_expand_image_popup_origin_type_combo_box_item_adsorb_mouse: {
				message: "adsorb mouse"
			},
			menu_setting_expand_image_popup_time: {
				message: "Popup Time"
			},
			menu_setting_expand_image_popup_time_wait_open: {
				message: "The time to wait before open (Millisecond)"
			},
			menu_setting_expand_image_popup_time_wait_close: {
				message: "The time to wait before close (Millisecond)"
			},
			menu_setting_expand_image_popup_position_type: {
				message: "Arrangement position of the pop-up image"
			},
			menu_setting_expand_image_popup_position_type_combo_box_item_absolute: {
				message: "absolute"
			},
			menu_setting_expand_image_popup_position_type_combo_box_item_fixed: {
				message: "fixed"
			},
			menu_setting_expand_image_popup_size: {
				message: "Popup Size"
			},
			menu_setting_expand_image_popup_size_scale: {
				message: "Scale (Percent)"
			},
			menu_setting_expand_image_popup_script_allow: {
				message: "Conditions to display popup from the link"
			},
			menu_setting_expand_image_reduced_image: {
				message: "Reduced Image Setting"
			},
			menu_setting_expand_image_reduced_image_check_box_container: {
				message: "Reduced Image Setting"
			},
			menu_setting_expand_image_popup_enable_popup: {
				message: "If you mouse over the Reduced Image, a pop-up display"
			},
			menu_setting_expand_image_reduced_image_allow_slcale_less_then: {
				message: "Conditions to display popup"
			},
			menu_setting_expand_image_reduced_image_allow_slcale_less_then_text: {
				message: "If the magnification is less than."
			},
			menu_setting_expand_image_load: {
				message: "Load Image Setting"
			},
			menu_setting_expand_image_load_check_box_container: {
				message: "Load Image Setting"
			},
			menu_setting_expand_image_load_enable_notify: {
				message: "Display the progress."
			},
			menu_setting_expand_image_load_start_type: {
				message: "How to load image"
			},
			menu_setting_expand_image_load_start_type_preload: {
				message: "Preload"
			},
			menu_setting_expand_image_load_start_type_scroll: {
				message: "Conjunction with the scroll"
			},
			menu_setting_expand_image_load_unload_check_box_container: {
				message: "Unload Image Setting"
			},
			menu_setting_expand_image_load_enable_unload: {
				message: "Enable Unload Image"
			},
			menu_setting_expand_image_load_unload: {
				message: "Conditions to unload image"
			},
			menu_setting_expand_image_load_allow_unload_more_then_text: {
				message: "If load more than the specified of MBytes, Release the old image."
			},
			menu_setting_expand_sound: {
				message: "Expand Sound Define"
			},
			menu_setting_expand_sound_inline: {
				message: "Setting to display inline"
			},
			menu_setting_expand_sound_inline_check_box_container: {
				message: "Setting to display inline"
			},
			menu_setting_expand_sound_inline_disable_same_text: {
				message: "If the same URL, not to Expand."
			},
			menu_setting_expand_sound_inline_sound_max: {
				message: "Maximum number of simultaneous display"
			},
			menu_setting_expand_sound_inline_script_allow: {
				message: "Condition to display inline from a link"
			},
			menu_setting_expand_sound_inline_script_insert: {
				message: "Audio Insert"
			},
			menu_setting_expand_sound_inline_element: {
				message: "HTMLAudioElement Setting"
			},
			menu_setting_expand_sound_inline_element_script_allow: {
				message: "Condition to display HTMLAudioElement"
			},
			menu_setting_expand_sound_inline_soundcloud: {
				message: "soundcloud.com Setting"
			},
			menu_setting_expand_sound_inline_soundcloud_check_box_container: {
				message: "soundcloud.com Setting"
			},
			menu_setting_expand_sound_inline_soundcloud_visible_player_flash: {
				message: "enable player (Flash)"
			},
			menu_setting_expand_sound_inline_soundcloud_visible_player_html5: {
				message: "enable player (HTML5)"
			},
			menu_setting_expand_sound_inline_mixcloud: {
				message: "www.mixcloud.com Setting"
			},
			menu_setting_expand_sound_inline_mixcloud_check_box_container: {
				message: "www.mixcloud.com Setting"
			},
			menu_setting_expand_sound_inline_mixcloud_visible_player: {
				message: "enable player"
			},
			menu_setting_expand_video: {
				message: "Expand Video Define"
			},
			menu_setting_expand_video_inline: {
				message: "Setting to display inline"
			},
			menu_setting_expand_video_inline_check_box_container: {
				message: "Setting to display inline"
			},
			menu_setting_expand_video_inline_disable_same_video: {
				message: "If the same URL, not to Expand."
			},
			menu_setting_expand_video_inline_video_max: {
				message: "Maximum number of simultaneous display"
			},
			menu_setting_expand_video_inline_script_allow: {
				message: "Condition to display inline from a link"
			},
			menu_setting_expand_video_inline_script_insert: {
				message: "Element Insert"
			},
			menu_setting_expand_video_inline_element: {
				message: "HTMLVideoElement Setting"
			},
			menu_setting_expand_video_inline_element_script_allow: {
				message: " Condition to display HTMLVideoElement"
			},
			menu_setting_expand_video_inline_youtube: {
				message: "www.youtube.com Setting"
			},
			menu_setting_expand_video_inline_youtube_check_box_container: {
				message: "www.youtube.com Setting"
			},
			menu_setting_expand_video_inline_youtube_visible_video: {
				message: "enable video"
			},
			menu_setting_expand_video_inline_nicovideo: {
				message: "www.nicovideo.jp Setting"
			},
			menu_setting_expand_video_inline_nicovideo_check_box_container: {
				message: "www.nicovideo.jp Setting"
			},
			menu_setting_expand_video_inline_nicovideo_visible_video: {
				message: "enable video"
			},
			menu_setting_expand_video_inline_nicovideo_visible_thumbnail_video: {
				message: "enable video thumbnail"
			},
			menu_setting_expand_video_inline_nicovideo_visible_thumbnail_mylist: {
				message: "enable mylist thumbnail"
			},
			menu_setting_expand_video_inline_nicovideo_visible_thumbnail_user: {
				message: "enable user thumbnail"
			},
			menu_setting_expand_video_inline_nicovideo_visible_thumbnail_community: {
				message: "enable community thumbnail"
			},
			menu_setting_expand_video_inline_nicovideo_visible_thumbnail_live: {
				message: "enable live broadcast thumbnail"
			},
			menu_setting_expand_video_inline_nicovideo_visible_thumbnail_seiga: {
				message: "enable seiga thumbnail"
			},
			menu_setting_expand_video_inline_ustream: {
				message: "www.ustream.tv Setting"
			},
			menu_setting_expand_video_inline_ustream_check_box_container: {
				message: "www.ustream.tv Setting"
			},
			menu_setting_expand_video_inline_ustream_visible_video_live: {
				message: "enable delivery video"
			},
			menu_setting_expand_video_inline_ustream_visible_video_record: {
				message: "enable recorded video "
			},
			menu_setting_expand_video_inline_dailymotion: {
				message: "www.dailymotion.com Setting"
			},
			menu_setting_expand_video_inline_dailymotion_check_box_container: {
				message: "www.dailymotion.com Setting"
			},
			menu_setting_expand_video_inline_dailymotion_visible_video: {
				message: "enable video"
			},
			menu_setting_expand_video_inline_video: {
				message: "vimeo.com Setting"
			},
			menu_setting_expand_video_inline_video_check_box_container: {
				message: "vimeo.com Setting"
			},
			menu_setting_expand_video_inline_video_visible_video: {
				message: "enable video"
			},
			menu_setting_expand_video_inline_fc2video: {
				message: "video.fc2.com Setting"
			},
			menu_setting_expand_video_inline_fc2video_check_box_container: {
				message: "video.fc2.com Setting"
			},
			menu_setting_expand_video_inline_fc2video_visible_video: {
				message: "enable video"
			},
			menu_setting_expand_video_inline_liveleak: {
				message: "www.liveleak.com Setting"
			},
			menu_setting_expand_video_inline_liveleak_check_box_container: {
				message: "www.liveleak.com Setting"
			},
			menu_setting_expand_video_inline_liveleak_visible_video: {
				message: "enable video"
			},
			menu_setting_expand_iframe: {
				message: "Expand Iframe Define"
			},
			menu_setting_expand_iframe_inline: {
				message: "Setting to display inline"
			},
			menu_setting_expand_iframe_inline_check_box_container: {
				message: "Setting to display inline"
			},
			menu_setting_expand_iframe_inline_disable_same_iframe: {
				message: "If the same URL, not to Expand."
			},
			menu_setting_expand_iframe_inline_script_allow: {
				message: "Condition to display inline from a link"
			},
			menu_setting_expand_iframe_inline_script_insert: {
				message: "HTMLIFrameElement Insert"
			},
			menu_setting_style_sheet: {
				message: "Stylesheet Define"
			},
			menu_setting_style_sheet_expand_text: {
				message: "Stylesheet of Expanded Text"
			},
			menu_setting_style_sheet_expand_text_element: {
				message: "HTMLTextAreaElement Setting"
			},
			menu_setting_style_sheet_expand_text_element_inline: {
				message: "Text Inline Display"
			},
			menu_setting_style_sheet_expand_image: {
				message: "Stylesheet of Expanded Image"
			},
			menu_setting_style_sheet_expand_image_element: {
				message: "HTMImageElement Setting"
			},
			menu_setting_style_sheet_expand_image_element_inline: {
				message: "Image Thumbnail Display"
			},
			menu_setting_style_sheet_expand_image_element_popup: {
				message: "Image Popup Display"
			},
			menu_setting_style_sheet_expand_sound: {
				message: "Stylesheet of Expanded Sound"
			},
			menu_setting_style_sheet_expand_sound_element: {
				message: "HTMLAudioElement Setting"
			},
			menu_setting_style_sheet_expand_sound_element_inline_audio: {
				message: "Audo Inline Display"
			},
			menu_setting_style_sheet_expand_sound_soundcloud: {
				message: "soundcloud.com Setting"
			},
			menu_setting_style_sheet_expand_sound_soundcloud_inline_player_flash: {
				message: "Player (Flash) Inline Display"
			},
			menu_setting_style_sheet_expand_sound_soundcloud_inline_player_html5: {
				message: "Player (HTML5) Inline Display"
			},
			menu_setting_style_sheet_expand_sound_mixcloud: {
				message: "www.mixcloud.com Setting"
			},
			menu_setting_style_sheet_expand_sound_mixcloud_inline_player: {
				message: "Player Inline Display"
			},
			menu_setting_style_sheet_expand_video: {
				message: "Stylesheet of Expanded Video"
			},
			menu_setting_style_sheet_expand_video_element: {
				message: "HTMLVideoElement Setting"
			},
			menu_setting_style_sheet_expand_video_element_inline_video: {
				message: "Video Inline Display"
			},
			menu_setting_style_sheet_expand_video_youtube: {
				message: "www.youtube.com Setting"
			},
			menu_setting_style_sheet_expand_video_youtube_inline_video: {
				message: "Video Inline Display"
			},
			menu_setting_style_sheet_expand_video_nicovideo: {
				message: "www.nicovideo.jp Setting"
			},
			menu_setting_style_sheet_expand_video_nicovideo_inline_video: {
				message: "Video Inline Display"
			},
			menu_setting_style_sheet_expand_video_nicovideo_inline_thumbnail_video: {
				message: "Video Thumbnail Inline Display"
			},
			menu_setting_style_sheet_expand_video_nicovideo_inline_thumbnail_mylist: {
				message: "Mylist Thumbnail Inline Display"
			},
			menu_setting_style_sheet_expand_video_nicovideo_inline_thumbnail_user: {
				message: "User Thumbnail Inline Display"
			},
			menu_setting_style_sheet_expand_video_nicovideo_inline_thumbnail_community: {
				message: "Community Thumbnail Inline Display"
			},
			menu_setting_style_sheet_expand_video_nicovideo_inline_thumbnail_live: {
				message: "Live Broadcast Thumbnail Inline Display"
			},
			menu_setting_style_sheet_expand_video_nicovideo_inline_thumbnail_seiga: {
				message: "Seiga Thumbnail Inline Display"
			},
			menu_setting_style_sheet_expand_video_ustream: {
				message: "www.ustream.tv Setting"
			},
			menu_setting_style_sheet_expand_video_ustream_inline_video_record: {
				message: "Delivery Video Inline Display"
			},
			menu_setting_style_sheet_expand_video_ustream_inline_video_live: {
				message: "Recorded Video Inline Display"
			},
			menu_setting_style_sheet_expand_video_dailymotion: {
				message: "www.dailymotion.com Setting"
			},
			menu_setting_style_sheet_expand_video_dailymotion_inline_video: {
				message: "Video Inline Display"
			},
			menu_setting_style_sheet_expand_video_vimeo: {
				message: "vimeo.com Setting"
			},
			menu_setting_style_sheet_expand_video_vimeo_inline_video: {
				message: "Video Inline Display"
			},
			menu_setting_style_sheet_expand_video_fc2video: {
				message: "video.fc2.com Setting"
			},
			menu_setting_style_sheet_expand_video_fc2video_inline_video: {
				message: "Video Inline Display"
			},
			menu_setting_style_sheet_expand_video_liveleak: {
				message: "www.liveleak.com Setting"
			},
			menu_setting_style_sheet_expand_video_liveleak_inline_video: {
				message: "Video Inline Display"
			},
			menu_setting_style_sheet_expand_iframe: {
				message: "Stylesheet of Expanded Iframe"
			},
			menu_setting_style_sheet_expand_iframe_element: {
				message: "HTMLIFrameElement Setting"
			},
			menu_setting_style_sheet_expand_iframe_element_inline: {
				message: "Iframe Inline Display"
			},
			menu_setting_experimental: {
				message: "Experimental Define"
			},
			menu_setting_experimental_revise_scroll: {
				message: "Revise Scroll Setting"
			},
			menu_setting_experimental_revise_scroll_check_box_container: {
				message: "Revise Scroll Setting"
			},
			menu_setting_experimental_revise_scroll_enable: {
				message: "enable"
			},
			menu_setting_experimental_revise_scroll_threshold_vertical: {
				message: "Threshold Vertical ( 0 [top] ～ 100 [bottom] )"
			},
			menu_setting_language: {
				message: "LANGUAGE (Language Setting)"
			},
			menu_credit: {
				message: "Credit"
			},
			menu_credit_info_version: {
				message: "Version"
			},
			menu_credit_info_copyright: {
				message: "Copyright"
			},
			menu_setting_define_list: {
				message: "List of Define"
			},
			menu_setting_define_list_hint: {
				message: "When you select an item in the list, the lower control can be edited. Will be compared with the order from above. possible to select multiple. Can be edited by multiple selection. Gray is preset setting. Preset setting can not be deleted."
			},
			menu_setting_define_button_add: {
				message: "add"
			},
			menu_setting_define_button_delete: {
				message: "delete"
			},
			menu_setting_define_button_move_up: {
				message: "move up"
			},
			menu_setting_define_button_move_down: {
				message: "move down"
			},
			menu_setting_define_button_export: {
				message: "export"
			},
			menu_setting_define_button_import: {
				message: "import"
			},
			menu_setting_define_add_dialog: {
				message: "Create a new define"
			},
			menu_setting_define_add_dialog_name: {
				message: "Name"
			},
			menu_setting_define_add_dialog_copy_define: {
				message: "Replicated from the existing define"
			},
			menu_setting_define_add_dialog_define_list_box_item_new: {
				message: "create a new"
			},
			menu_setting_define_delete_dialog: {
				message: "Delete the Define"
			},
			menu_setting_define_delete_dialog_name: {
				message: "Define Name (Be removed)"
			},
			menu_setting_define_delete_dialog_change_define: {
				message: "Alternative Selection"
			},
			menu_setting_define_delete_dialog_define_list_box_item_no_use: {
				message: "not use the define"
			},
			menu_setting_define_name: {
				message: "Define Name"
			},
			menu_setting_define_export_dialog: {
				message: "Define Export"
			},
			menu_setting_define_export_dialog_export: {
				message: "Export"
			},
			menu_setting_define_export_dialog_export_hint: {
				message: "Please copy the text of TextArea."
			},
			menu_setting_define_import_dialog: {
				message: "Define Import"
			},
			menu_setting_define_import_dialog_explanation: {
				message: "information about Import"
			},
			menu_setting_define_import_dialog_explanation_0: {
				message: "Preset setting will be overwritten. User setting will be add new."
			},
			menu_setting_define_import_dialog_explanation_1: {
				message: "It is recommended that you take a backup on the export function."
			},
			menu_setting_define_import_dialog_explanation_2: {
				message: "Please note so that it does not contain malicious code."
			},
			menu_setting_define_import_dialog_import: {
				message: "Import"
			},
			menu_setting_define_import_dialog_import_hint: {
				message: "Please paste the output text from Export."
			},
			menu_setting_define_import_dialog_confirm: {
				message: "Do you want to Import?"
			},
			menu_setting_define_import_alert: {
				message: "A result of the import"
			},
			menu_setting_define_import_alert_success: {
				message: "Import has been completed."
			},
			menu_setting_define_import_alert_failure: {
				message: "Failed to import."
			},
			menu_setting_filter_list: {
				message: "Filter List"
			},
			menu_setting_filter_list_hint: {
				message: "When you select an item in the list, the lower control can be edited. Will be compared with the order from above. possible to select multiple. Can be edited by multiple selection."
			},
			menu_setting_filter_button_add: {
				message: "add"
			},
			menu_setting_filter_button_delete: {
				message: "delete"
			},
			menu_setting_filter_button_prio_up: {
				message: "prio up"
			},
			menu_setting_filter_button_prio_down: {
				message: "prio down"
			},
			menu_setting_filter_add_dialog: {
				message: "Creating a new Filter Setting"
			},
			menu_setting_filter_add_dialog_name: {
				message: "Name"
			},
			menu_setting_filter_add_dialog_copy_define: {
				message: "Replicated from the existing setting."
			},
			menu_setting_filter_add_dialog_define_list_box_item_new: {
				message: "create a new"
			},
			menu_button_ok: {
				message: "OK"
			},
			menu_button_yes: {
				message: "YES"
			},
			menu_button_no: {
				message: "CANCEL"
			},
			menu_scriptarea_hint: {
				message: "To describe the anonymous function to array. Please note so that it does not contain malicious code."
			},
			menu_text_regexp_hint: {
				message: "regular expression string. [flags] g...repeat. i...without case-sensitive."
			},
			menu_regexp_list_button_add: {
				message: "add"
			},
			menu_regexp_list_button_delete: {
				message: "delete"
			},
			menu_regexp_list_button_move_up: {
				message: "move up"
			},
			menu_regexp_list_button_move_down: {
				message: "move down"
			},
			page_expand_popup_menu: {
				message: "PageExpand Menu"
			},
			context_menu_pageexpand_config: {
				message: "PageExpand Setting"
			},
			context_menu_pageexpand_config_current_page: {
				message: "PageExpand Setting Current Page"
			},
			context_menu_pageexpand_config_current_bbs: {
				message: "PageExpand Setting Current BBS"
			},
			context_menu_pageexpand_config_current_page_confirm: {
				message: "PageExpand Setting will only work in the page of the provision. (for security)\nDo you want to open page?\n\n"
			},
			context_menu_pageexpand_execute: {
				message: "Execute PageExpand"
			},
			context_menu_pageexpand_debug: {
				message: "PageExpand Debug"
			}
		}
	};


	// --------------------------------------------------------------------------------
	// アドレスコレクション
	// --------------------------------------------------------------------------------
	function AddressCollection(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// アドレスを登録
		// --------------------------------------------------------------------------------
		_container.addAddress = function(category,url){
			url = convertAddress(url);

			// カテゴリが存在しない
			var obj = _dictionary[category];
			if(!obj){
				_dictionary[category] = obj = new Object();
			}

			// 登録済み
			if(obj[url]){
				return false;
			}

			// 新規登録
			obj[url] = true;
			_count += 1;
			return true;
		};

		// --------------------------------------------------------------------------------
		// アドレスの登録を外す
		// --------------------------------------------------------------------------------
		_container.removeAddress = function(category,url){
			url = convertAddress(url);

			// カテゴリが存在しない
			var obj = _dictionary[category];
			if(!obj){
				return false;
			}

			// 未登録
			if(!obj[url]){
				return false;
			}

			obj[url] = false;
			_count -= 1;

			return true;
		};

		// --------------------------------------------------------------------------------
		// アドレスが登録済みであるか調べる
		// --------------------------------------------------------------------------------
		_container.hasAddress = function(category,url){
			url = convertAddress(url);

			// カテゴリが存在しない
			var obj = _dictionary[category];
			if(!obj){
				return false;
			}

			if(obj[url])	return true;
			return false;
		};

		// --------------------------------------------------------------------------------
		// アドレスを変換（内部用）
		// --------------------------------------------------------------------------------
		function convertAddress(url){
			// 小文字に変換
			url = url.toLowerCase();
			return url;
		}

		// --------------------------------------------------------------------------------
		// 登録数を取得
		// --------------------------------------------------------------------------------
		_container.getCountAddress = function(){
			return _count;
		};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _dictionary;
		var _count;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		_count = 0;
		_dictionary = new Object();

		return _container;
	}


	// --------------------------------------------------------------------------------
	// 実行キュー
	// --------------------------------------------------------------------------------
	function ExecuteQueue(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// 最前列に処理を追加
		// --------------------------------------------------------------------------------
		_container.attachFirst = function(func,param){
			var o = {func:func,param:param};
			var _prev = _queue_list[0];
			var _next = _prev._next;
			o._prev = _prev;
			o._next = _next;
			_prev._next = o;
			_next._prev = o;

			attach(0);
		};

		// --------------------------------------------------------------------------------
		// DOM オブジェクト除外用の処理を最前列に追加
		// --------------------------------------------------------------------------------
		_container.attachFirstForRemoveDomNode = function(func,param){
			var o = {func:func,param:param};
			var _prev = _queue_list[0];
			var _next = _prev._next;
			o._prev = _prev;
			o._next = _next;
			_prev._next = o;
			_next._prev = o;

			attach(0);
		};

		// --------------------------------------------------------------------------------
		// DOM オブジェクト除外用の処理を最後尾に追加
		// --------------------------------------------------------------------------------
		_container.attachLastForRemoveDomNode = function(func,param){
			var o = {func:func,param:param};
			var _next = _queue_list[0];
			var _prev = _next._prev;
			o._prev = _prev;
			o._next = _next;
			_prev._next = o;
			_next._prev = o;

			attach(0);
		};

		// --------------------------------------------------------------------------------
		// DOM オブジェクト挿入用の処理を最前列に追加
		// --------------------------------------------------------------------------------
		_container.attachFirstForInsertDomNode = function(func,param){
			var o = {func:func,param:param};
			var _prev = _queue_list[1];
			var _next = _prev._next;
			o._prev = _prev;
			o._next = _next;
			_prev._next = o;
			_next._prev = o;

			attach(1);
		};

		// --------------------------------------------------------------------------------
		// DOM オブジェクト挿入用の処理を最後尾に追加
		// --------------------------------------------------------------------------------
		_container.attachLastForInsertDomNode = function(func,param){
			var o = {func:func,param:param};
			var _next = _queue_list[1];
			var _prev = _next._prev;
			o._prev = _prev;
			o._next = _next;
			_prev._next = o;
			_next._prev = o;

			attach(1);
		};

		// --------------------------------------------------------------------------------
		// 掲示板展開用の処理を追加
		// --------------------------------------------------------------------------------
		_container.attachForExpandBbs = function(func,param){
			var o = {func:func,param:param};
			var _next = _queue_list[2];
			var _prev = _next._prev;
			o._prev = _prev;
			o._next = _next;
			_prev._next = o;
			_next._prev = o;

			attach(2);
		};

		// --------------------------------------------------------------------------------
		// エレメント展開用の処理を追加
		// --------------------------------------------------------------------------------
		_container.attachForExpandElement = function(func,param){
			var o = {func:func,param:param};
			var _next = _queue_list[3];
			var _prev = _next._prev;
			o._prev = _prev;
			o._next = _next;
			_prev._next = o;
			_next._prev = o;

			attach(3);
		};

		// --------------------------------------------------------------------------------
		// エレメント解析用の処理を追加
		// --------------------------------------------------------------------------------
		_container.attachForAnalyzeElement = function(func,param){
			var o = {func:func,param:param};
			var _next = _queue_list[4];
			var _prev = _next._prev;
			o._prev = _prev;
			o._next = _next;
			_prev._next = o;
			_next._prev = o;

			attach(4);
		};

		// --------------------------------------------------------------------------------
		// テキストノード解析用の処理を追加
		// --------------------------------------------------------------------------------
		_container.attachForAnalyzeTextNode = function(func,param){
			var o = {func:func,param:param};
			var _next = _queue_list[5];
			var _prev = _next._prev;
			o._prev = _prev;
			o._next = _next;
			_prev._next = o;
			_next._prev = o;

			attach(5);
		};

		// --------------------------------------------------------------------------------
		// 最後尾に処理を追加
		// --------------------------------------------------------------------------------
		_container.attachLast = function(func,param){
			var o = {func:func,param:param};
			var _next = _queue_list[5];
			var _prev = _next._prev;
			o._prev = _prev;
			o._next = _next;
			_prev._next = o;
			_next._prev = o;

			attach(5);
		};

		// --------------------------------------------------------------------------------
		// 登録処理（内部用）
		// --------------------------------------------------------------------------------
		function attach(level){
			_count += 1;

			if(level < _queue_pos){
				_queue_pos = level;
				_queue = _queue_list[_queue_pos];
			}

			if(_time_handle === undefined){

				function func(){
					var time = _getTime();
					do{
						var o = _queue._next;
						var _prev = o._prev;
						var _next = o._next;
						_prev._next = _next;
						_next._prev = _prev;
						try{
							o.func(o.param);
							_success_count += 1;
						}catch(e){
							if(project.getEnableDebugMode()){
								ConsoleError(e.stack);
							}
							_error_count += 1;
						}

						while(_queue_pos<_queue_max){
							if(_queue._next != _queue)	break;
							_queue_pos++;
							_queue = _queue_list[_queue_pos];
						}

						_count -= 1;
						if(_count <= 0){
							clearTimeout(_time_handle);
							_time_handle = undefined;
							return;
						}
					}while (_getTime() - time <= _time_occupancy);
					_time_handle = setTimeout(func, _time_sleep);
				}
				_time_handle = setTimeout(func, _time_sleep);
			}
		}

		// --------------------------------------------------------------------------------
		// キューの数を取得
		// --------------------------------------------------------------------------------
		_container.getCountQueue = function(){
			return _count;
		};

		// --------------------------------------------------------------------------------
		// キューの成功数を取得
		// --------------------------------------------------------------------------------
		_container.getCountSuccess = function(){
			return _success_count;
		};

		// --------------------------------------------------------------------------------
		// キューのエラー数を取得
		// --------------------------------------------------------------------------------
		_container.getCountError = function(){
			return _error_count;
		};

		// --------------------------------------------------------------------------------
		// 占有時間をセット
		// --------------------------------------------------------------------------------
		_container.setOccupancyTime = function(v){
			_time_occupancy = v;
		};

		// --------------------------------------------------------------------------------
		// スリープ時間をセット
		// --------------------------------------------------------------------------------
		_container.setSleepTime = function(v){
			_time_sleep = v;
		};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _queue;
		var _queue_list;
		var _queue_pos;
		var _queue_max;
		var _count;
		var _success_count;
		var _error_count;
		var _time_handle;
		var _time_occupancy;
		var _time_sleep;
		var _getTime;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		_count = 0;
		_success_count = 0;
		_error_count = 0;
		_time_handle = undefined;
		_time_occupancy = 5;
		_time_sleep = 0;

		_queue_pos = 0;
		_queue_max = 6;
		var _queue_list = new Array();
		while(_queue_pos<_queue_max){
			_queue = new Object();
			_queue._prev = _queue;
			_queue._next = _queue;
			_queue_list[_queue_pos] = _queue;
			_queue_pos++;
		}

		// 時間取得関数
		_getTime = Date.now;
		if(!_getTime)	_getTime = function(){ return (new Date()).getTime(); };

		return _container;
	}


	// --------------------------------------------------------------------------------
	// ローダーキュー
	// --------------------------------------------------------------------------------
	function LoaderQueue(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// 要素を作成
		// --------------------------------------------------------------------------------
		_container.createElement = function(){
			var _element = new Object();

			// --------------------------------------------------------------------------------
			// 開始イベント
			// --------------------------------------------------------------------------------
			_element.onstart = function(){};

			// --------------------------------------------------------------------------------
			// 完了を通知
			// --------------------------------------------------------------------------------
			_element.complete = function(){
				_thread_count -= 1;
				dequeue();
			};

			// --------------------------------------------------------------------------------
			// 要素を破棄
			// --------------------------------------------------------------------------------
			_element.release = function(){
				ElementRemove(_element);
				_queue_count -= 1;
				dequeue();
			};

			// --------------------------------------------------------------------------------
			// 通常最前列に処理を追加
			// --------------------------------------------------------------------------------
			_element.attachFirst = function(){
				ElementRemove(_element);

				var _prev = _container.queue;
				var _next = _prev._next;
				_prev._next = _element;
				_next._prev = _element;
				_element._prev = _prev;
				_element._next = _next;

				dequeue();
			};

			// --------------------------------------------------------------------------------
			// 通常最後尾に追加
			// --------------------------------------------------------------------------------
			_element.attachLast = function(){
				ElementRemove(_element);

				var _next = _container.queue;
				var _prev = _next._prev;
				_prev._next = _element;
				_next._prev = _element;
				_element._prev = _prev;
				_element._next = _next;

				dequeue();
			};

			// --------------------------------------------------------------------------------
			// シングル最後尾に追加
			// --------------------------------------------------------------------------------
			_element.attachSingle = function(){
				ElementRemove(_element);

				var _next = _container.queue_single;
				var _prev = _next._prev;
				_prev._next = _element;
				_next._prev = _element;
				_element._prev = _prev;
				_element._next = _next;

				dequeue();
			};

			// --------------------------------------------------------------------------------
			// 初期化
			// --------------------------------------------------------------------------------
			(function(){
				_element._prev = _element;
				_element._next = _element;

				_queue_count += 1;
			})();

			return _element;
		};

		// --------------------------------------------------------------------------------
		// 要素のロード開始（内部用）
		// --------------------------------------------------------------------------------
		function ElementLoadStart(element){
			ElementRemove(element);
			_thread_count += 1;
			element.onstart();
		}

		// --------------------------------------------------------------------------------
		// 要素を外す（内部用）
		// --------------------------------------------------------------------------------
		function ElementRemove(element){
			var _prev = element._prev;
			var _next = element._next;
			_prev._next = _next;
			_next._prev = _prev;
			element._prev = element;
			element._next = element;
		}

		// --------------------------------------------------------------------------------
		// デキュー（内部用）
		// --------------------------------------------------------------------------------
		function dequeue(){
			// 通常キュー
			while(_thread_count < _thread_max){
				var element = _container.queue._next;

				// キューが空
				if(element == _container.queue){
					break;
				}
				ElementLoadStart(element);
			}

			// シングルキュー
			if(_thread_count <= 0){
				var element = _container.queue_single._next;

				if(element != _container.queue_single){
					ElementLoadStart(element);
				}
			}
		}

		// --------------------------------------------------------------------------------
		// キューの数を取得
		// --------------------------------------------------------------------------------
		_container.getCountQueue = function(){
			return _queue_count;
		};

		// --------------------------------------------------------------------------------
		// スレッドの数を取得
		// --------------------------------------------------------------------------------
		_container.getCountThread = function(){
			return _thread_count;
		};

		// --------------------------------------------------------------------------------
		// エラー数を取得
		// --------------------------------------------------------------------------------
		_container.getCountError = function(){
			return _error_count;
		};

		// --------------------------------------------------------------------------------
		// エラー数を加算
		// --------------------------------------------------------------------------------
		_container.addCountError = function(){
			_error_count += 1;
		};

		// --------------------------------------------------------------------------------
		// スレッドの最大数を取得
		// --------------------------------------------------------------------------------
		_container.getMaxThread = function(){
			return _thread_max;
		};

		// --------------------------------------------------------------------------------
		// ロードスレッドの最大数をセット
		// --------------------------------------------------------------------------------
		_container.setMaxThread = function(v){
			_thread_max = v;
		};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _queue_count;
		var _thread_count;
		var _thread_max;
		var _error_count;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_queue_count = 0;
			_thread_count = 0;
			_container.setMaxThread(10);
			_error_count = 0;

			var queue = new Object();
			queue._prev = queue;
			queue._next = queue;
			_container.queue = queue;

			var queue_single = new Object();
			queue_single._prev = queue_single;
			queue_single._next = queue_single;
			_container.queue_single = queue_single;
		})();

		return _container;
	}


	// --------------------------------------------------------------------------------
	// ローダー
	// --------------------------------------------------------------------------------
	function Loader(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// ロード成功イベント
		// --------------------------------------------------------------------------------
		_container.onload = function(){};

		// --------------------------------------------------------------------------------
		// ロード失敗イベント
		// --------------------------------------------------------------------------------
		_container.onerror = function(){};

		// --------------------------------------------------------------------------------
		// リクエストヘッダを設定
		// --------------------------------------------------------------------------------
		_container.setRequestHeader = function(name,value){
			_request.headers[name] = value;
		};

		// --------------------------------------------------------------------------------
		// オーバーライドコンテンツタイプを設定
		// --------------------------------------------------------------------------------
		_container.overrideMimeType = function(type){
			_request.override_mime_type = type;
		};

		// --------------------------------------------------------------------------------
		// メソッドを設定
		// --------------------------------------------------------------------------------
		_container.setMethod = function(method){
			_request.method = method;
		};

		// --------------------------------------------------------------------------------
		// アドレスを設定
		// --------------------------------------------------------------------------------
		_container.setURL = function(url){
			_request.url = url;
		};

		// --------------------------------------------------------------------------------
		// 送信データを設定
		// --------------------------------------------------------------------------------
		_container.setSendData = function(data){
			_request.data = data;
		};

		// --------------------------------------------------------------------------------
		// 画像をロード
		// --------------------------------------------------------------------------------
		_container.loadImage = function(){
			if(!(getEnable())){
				loadError();
				return;
			}

			// Image による画像の読み込み
			function tryLoadImage(){
				// アンセキュアチェック
				if(!project.checkAllowUnsecure(_request.url)){
					loadError();
					return;
				}

				// 開始関数を変更
				_queue_element.onstart = function(){

					var image = document.createElement("img");
					function removeEvent(){
						image.onload = null;
						image.onerror = null;
					}
					image.onload = function(){
						removeEvent();
						// ロード完了を通知
						_queue_element.complete();
						// イメージを返す
						loadSuccess(image);
					};
					image.onerror = function(){
						removeEvent();
						// ロード完了を通知
						_queue_element.complete();
						// キューに再登録
						if(!tryAttachElement(false)){
							// エラーで終了
							loadError();
							return;
						}
					};

					// 読み込み開始
					image.src = _request.url;
				};

				// 通常リトライ回数
				_count = 1;
				// シングルリトライ回数
				_single_count = 1;
				// キューに登録
				tryAttachElement(true);
			}

			// data URL scheme による画像の読み込み
			function tryLoadDataUriScheme(data){

				// 開始関数を変更
				_queue_element.onstart = function(){

					var image = document.createElement("img");
					function removeEvent(){
						image.onload = null;
						image.onerror = null;
					}
					image.onload = function(){
						removeEvent();
						// ロード完了を通知
						_queue_element.complete();
						// イメージを返す
						loadSuccess(image);
					};
					image.onerror = function(){
						removeEvent();
						// ロード完了を通知
						_queue_element.complete();
						// キューに再登録
						if(!tryAttachElement(false)){
							// Image による画像の読み込み
							tryLoadImage();
							return;
						}
					};

					// 読み込み開始
					image.src = data;
				};

				// 通常リトライ回数
				_count = 1;
				// シングルリトライ回数
				_single_count = 0;
				// キューに登録
				tryAttachElement(true);
			}

			// TrixieUserScript の場合処理しない
			if(ExecuteAsTrixieUserScript()){
				tryLoadImage();
				return;
			}

			// 通常リトライ回数
			_count = 1;
			// シングルリトライ回数
			_single_count = 1;
			// 開始関数をセット
			_queue_element.onstart = function(){

				// 読み込みを開始する
				var result;
				if(project.getSecureCurrent() && (_request.url.indexOf("http://") == 0)){
					var result = loadDataUriScheme(function(result,xhr){

						// ロード完了を通知
						_queue_element.complete();

						// ロード成功
						if(result){
							if(xhr.dataUriScheme){
								// data URL scheme による画像の読み込み
								tryLoadDataUriScheme(xhr.dataUriScheme);
							}else{
								// Image による画像の読み込み
								tryLoadImage();
							}

						// 失敗
						}else{
							if(xhr.status == 0){
								// Image による画像の読み込み
								tryLoadImage();
							}else if(xhr.status == 401){
								// 認証エラー
								loadError();
							}else{
								// キューに再登録
								if(!tryAttachElement(false)){
									// Image による画像の読み込み
									tryLoadImage();
								}
							}
						}
					});
				}else{
					result = loadXMLHttpRequest(function(result,xhr){

						// ロード完了を通知
						_queue_element.complete();

						// ロード成功
						if(result){

							// Imageによる画像の読み込み
							tryLoadImage();

						// 失敗
						}else{
							if(xhr.status == 0){
								// Imageによる画像の読み込み
								tryLoadImage();
							}else if(xhr.status == 401){
								// 認証エラー
								loadError();
							}else{
								// キューに再登録
								if(!tryAttachElement(false)){
									// Imageによる画像の読み込み
									tryLoadImage();
								}
							}
						}
					});
				}

				// ロードエラー
				if(!result){
					// ロード完了を通知
					_queue_element.complete();
					// Imageによる画像の読み込み
					tryLoadImage();
					return;
				}
			};

			// キューに登録
			tryAttachElement(false);
		};

		// --------------------------------------------------------------------------------
		// オーディオをロード
		// --------------------------------------------------------------------------------
		_container.loadAudio = function(){
			var error = false;
			// 無効
			if(!(getEnable())){
				error = true;
			}
			// オーディオ未対応
			if(!(window.HTMLAudioElement)){
				error = true;
			}
			// エラー
			if(error){
				loadError();
				return;
			}

			// オーディオを生成
			var audio = document.createElement("audio");
			// コントロール有効
			audio.controls = true;
			// 自動再生無し
			audio.autoplay = false;
			// プリロードを設定
			audio.preload = "metadata";

			var time_handle = null;

			// 完了
			function complete_func(){
				// 再生可能
				audio.removeEventListener("canplay",load_func,false);
				// データロード済み
				audio.removeEventListener("loadeddata",load_func,false);
				// 失敗
				audio.removeEventListener("error",error_func,false);

				if(time_handle){
					clearTimeout(time_handle);
					time_handle = null;
				}

				// ロード完了を通知
				_queue_element.complete();
			}

			// タイムアウト
			function time_out_func(){
				time_handle = null;
				error_func();
			}

			// ロード完了
			function load_func(){
				// 完了通知
				complete_func();
				// オーディオを返す
				loadSuccess(audio);
			}

			// エラー
			function error_func(){
				// 完了通知
				complete_func();
				// キューに再登録
				if(!tryAttachElement(false)){
					// エラーで終了
					loadError();
					return;
				}
			}

			// 通常リトライ回数
			_count = 1;
			// シングルリトライ回数
			_single_count = 1;
			// 開始関数をセット
			_queue_element.onstart = function(){
				// タイムアウト設定
				time_handle = setTimeout(time_out_func,10 * 1000);

				// 再生可能
				audio.addEventListener("canplay",load_func,false);
				// データロード済み
				audio.addEventListener("loadeddata",load_func,false);
				// 失敗
				audio.addEventListener("error",error_func,false);

				// ロード開始
				audio.src = _request.url;
				if(audio.load){
					audio.load();
				}
			};

			// キューに登録
			tryAttachElement(false);
		};

		// --------------------------------------------------------------------------------
		// ビデオをロード
		// --------------------------------------------------------------------------------
		_container.loadVideo = function(){
			var error = false;
			// 無効
			if(!(getEnable())){
				error = true;
			}
			// オーディオ未対応
			if(!(window.HTMLVideoElement)){
				error = true;
			}
			// エラー
			if(error){
				loadError();
				return;
			}

			// ビデオを生成
			var video = DocumentCreateElement("video");
			// コントロール有効
			video.controls = true;
			// 自動再生無し
			video.autoplay = false;
			// プリロードを設定
			video.preload = "metadata";

			var time_handle = null;

			// 完了
			function complete_func(){
				// 再生可能
				video.removeEventListener("canplay",load_func,false);
				// データロード済み
				video.removeEventListener("loadeddata",load_func,false);
				// 失敗
				video.removeEventListener("error",error_func,false);

				if(time_handle){
					clearTimeout(time_handle);
					time_handle = null;
				}

				// ロード完了を通知
				_queue_element.complete();
			}

			// タイムアウト
			function time_out_func(){
				time_handle = null;
				error_func();
			}

			// ロード完了
			function load_func(){
				// 完了通知
				complete_func();
				// ビデオを返す
				loadSuccess(video);
			}

			// エラー
			function error_func(){
				// 完了通知
				complete_func();
				// キューに再登録
				if(!tryAttachElement(false)){
					// エラーで終了
					loadError();
					return;
				}
			}

			// 通常リトライ回数
			_count = 1;
			// シングルリトライ回数
			_single_count = 1;
			// 開始関数をセット
			_queue_element.onstart = function(){
				// タイムアウト設定
				time_handle = setTimeout(time_out_func,10 * 1000);

				// 再生可能
				video.addEventListener("canplay",load_func,false);
				// データロード済み
				video.addEventListener("loadeddata",load_func,false);
				// 失敗
				video.addEventListener("error",error_func,false);

				// ロード開始
				video.src = _request.url;
				if(video.load){
					video.load();
				}
			};

			// キューに登録
			tryAttachElement(false);
		};

		// --------------------------------------------------------------------------------
		// テキストをロード
		// --------------------------------------------------------------------------------
		_container.loadText = function(){
			if(!(getEnable())){
				loadError();
				return;
			}

			// 通常リトライ回数
			_count = 1;
			// シングルリトライ回数
			_single_count = 1;
			// 開始関数をセット
			_queue_element.onstart = function(){

				// 読み込みを開始する
				var result = loadXMLHttpRequest(function(result,xhr){

					// ロード完了を通知
					_queue_element.complete();

					// ロード成功
					if(result){
						// responseText を返す
						loadSuccess(xhr.responseText);
						return;

					// 失敗
					}else{
						if(xhr.status == 401){
							// 認証エラー
							loadError();
						}else{
							// キューに再登録
							if(!tryAttachElement(false)){
								// エラーで終了
								loadError();
								return;
							}
						}
					}
				});

				// ロードエラー
				if(!result){
					// ロード完了を通知
					_queue_element.complete();

					// エラーで終了
					loadError();
					return;
				}
			};

			// キューに登録
			tryAttachElement(false);

		};

		// --------------------------------------------------------------------------------
		// リダイレクト先 URL をロード
		// --------------------------------------------------------------------------------
		_container.loadFinalURL = function(){
			if(!(getEnable())){
				loadError();
				return;
			}

			// HTTP メソッド
			_container.setMethod("HEAD");

			// カレント URL
			var current_url = _request.url;

			// TrixieUserScript の場合処理しない
			if(ExecuteAsTrixieUserScript()){
				loadSuccess(current_url);
				return;
			}

			// キャッシュがあれば返す
			var url = redirect_url_dictionary.getRedirectURL(current_url);
			if(url){
				loadSuccess(url);
				return;
			}

			function RetryCountInitialize(){
				// 通常リトライ回数
				_count = 1;
				// シングルリトライ回数
				_single_count = 1;
			}

			// リダイレクト回数
			var redirect_count = 16;

			// 開始関数をセット
			_queue_element.onstart = function(){

				// 読み込みを開始する
				var result = loadXMLHttpRequest(function(result,xhr){

					// ロード完了を通知
					_queue_element.complete();

					switch(_request.method){
					case "HEAD":
						// ロード成功
						if(result){
							// GET メソッドに変更
							_container.setMethod("GET");

							// キューに登録
							RetryCountInitialize();
							tryAttachElement(false);

						// 失敗
						}else{
							var redirect_url = null;
							switch(xhr.status){
							case 300:
							case 301:
							case 302:
							case 303:
							case 307:
								//	Location ヘッダを取得
								redirect_url = xhr.getResponseHeader("Location");
								break;
							}

							if(redirect_url){
								// リダイレクト結果を辞書に登録
								redirect_url_dictionary.addURL(_request.url,redirect_url);

								// URL を更新
								_request.url = redirect_url;

								// リダイレクト回数オーバー
								redirect_count -= 1;
								if(redirect_count <= 0){
									// 最後に取得したリダイレクト先を返す
									loadSuccess(_request.url);
									return;
								}

								// キューに登録
								RetryCountInitialize();
								tryAttachElement(false);

							}else{
								if(xhr.status == 401){
									// 認証エラー
									loadError();
									return;
								}else{
									// キューに再登録
									if(!tryAttachElement(false)){
										// エラーで終了
										loadError();
										return;
									}
								}
							}
						}
						break;

					case "GET":

						// ロード成功
						if(result){

							// メタタグのリダイレクトを調べる
							var redirect_url = null;
							var r = new RegExp("<[ \r\n\t]*(meta)[ \r\n\t]+.+?>","igm");
							var match;
							while(true){
								match = r.exec(xhr.responseText);
								if(!match)	break;

								var meta = (function(s){
									var obj = new Object();
									var i = 0;
									var num = s.length;
									// 文字の先頭を検索
									function searchName(){
										while(true){
											if(i >= num)	return false;
											if(!(s.charAt(i).match(/[ |　|\t|\r|\n|\/|<|>]/))){
												return true;
											}
											i++;
										}
									}
									// 文字を取得
									function getName(){
										var b = i;
										while(true){
											if(i >= num)	break;
											if(s.charAt(i).match(/[ |　|\t|\r|\n|\/|<|>|=]/)){
												break;
											}
											i++;
										}
										return s.substring(b,i);
									}
									// 値を持つかチェック
									function haveValue(){
										var j = i;
										while(true){
											if(j >= num)	break;
											var c = s.charAt(j);
											if(c == "=")	return true;
											if(!(c.match(/[ |　|\t|\r|\n|]/))){
												return false;
											}
											j++;
										}
										return false;
									}
									// 値の先頭を検索
									function searchValue(){
										while(true){
											if(i >= num)	return false;
											if(!(s.charAt(i).match(/[ |　|\t|\r|\n|\/|<|>|=]/))){
												return true;
											}
											i++;
										}
									}
									// 値を取得
									function getValue(){
										var q = s.charAt(i);
										var e = false;
										// 名前として取得
										if(!q.match(/['|"]/))	return getName();
										i++;
										var b = i;
										while(true){
											if(i >= num)	break;
											var c = s.charAt(i);
											if(!(e) && (q == c)){
												i++;
												return s.substring(b,i-1);
											}
											e = (c == "\\");
											i++;
										}
										return s.substring(b,i);
									}

									// 文字の先頭を検索
									if(!searchName())	return obj;
									// 名前を取得(タグ名)
									var tag_name = getName();
									while(true){
										// 文字の先頭を検索
										if(!searchName())	return obj;
										// 文字を取得
										var name = getName().toLowerCase();
										// 値を持つか
										if(!haveValue()){
											obj[name] = null;
											continue;
										}
										// 値の先頭を検索
										if(!searchValue())	return obj;
										// 値を取得
										obj[name] = getValue();
									}

								})(match[0]);

								var http_equiv = meta["http-equiv"];
								if(http_equiv){
									if(http_equiv.toLowerCase() == "refresh"){
										var content = meta["content"];
										if(content){
											// 相対パスは除外
											if(content.match(/url=(http:\/\/.*|https:\/\/.*)/i)){
												redirect_url = RegExp.$1;
											}
										}
									}
								}
							}

							if(redirect_url){

								// リダイレクト結果を辞書に登録
								redirect_url_dictionary.addURL(_request.url,redirect_url);

								// HEAD メソッドに変更
								_container.setMethod("HEAD");

								// URL を更新
								_request.url = redirect_url;

								// リダイレクト回数オーバー
								redirect_count -= 1;
								if(redirect_count <= 0){
									// 最後に取得したリダイレクト先を返す
									loadSuccess(_request.url);
									return;
								}

								// キューに登録
								RetryCountInitialize();
								tryAttachElement(false);

							}else{
								// 最後に取得したリダイレクト先を返す
								loadSuccess(_request.url);
								return;
							}

						// 失敗
						}else{
							if(xhr.status == 401){
								// 認証エラー
								loadError();
								return;
							}else{
								// キューに再登録
								if(!tryAttachElement(false)){
									// エラーで終了
									loadError();
									return;
								}
							}
						}
						break;
					}
				});

				// ロードエラー
				if(!result){
					// ロード完了を通知
					_queue_element.complete();

					// エラーで終了
					loadError();
					return;
				}
			};

			// キューに登録
			RetryCountInitialize();
			tryAttachElement(false);
		};

		// --------------------------------------------------------------------------------
		// レスポンスヘッダをロード
		// --------------------------------------------------------------------------------
		_container.loadResponseHeader = function(){
			if(!(getEnable())){
				loadError();
				return;
			}

			// HTTP メソッド
			_container.setMethod("HEAD");

			// 通常リトライ回数
			_count = 1;
			// シングルリトライ回数
			_single_count = 1;
			// 開始関数をセット
			_queue_element.onstart = function(){

				// 読み込みを開始する
				var result = loadXMLHttpRequest(function(result,xhr){

					// ロード完了を通知
					_queue_element.complete();

					// ロード成功
					if(result){
						// レスポンスヘッダオブジェクトを返す
						loadSuccess(ResponseHeadersParseObject(xhr.getAllResponseHeaders()));
						return;

					// 失敗
					}else{
						if(xhr.status == 401){
							// 認証エラー
							loadError();
							return;
						}else{
							// キューに再登録
							if(!tryAttachElement(false)){
								// エラーで終了
								loadError();
								return;
							}
						}
					}
				});

				// ロードエラー
				if(!result){
					// ロード完了を通知
					_queue_element.complete();

					// エラーで終了
					loadError();
					return;
				}
			};

			// キューに登録
			tryAttachElement(false);

		};

		// --------------------------------------------------------------------------------
		// アクセス可能か取得（内部用）
		// --------------------------------------------------------------------------------
		function getEnable(){
			if(project.checkAccessBlock(_request.url)){
				if(project.getEnableOutputLog()){
					ConsoleLog({type:"AccessBlock",current_url:document.URL,url:_request.url,call:"Cross-Origin XMLHttpRequest"});
				}
				return false;
			}
			return true;
		}

		// --------------------------------------------------------------------------------
		// 要素をキューに登録（内部用）
		// --------------------------------------------------------------------------------
		function tryAttachElement(first){
			if(_count > 0){
				_single_type = false;
				_count -= 1;
				if(first)	_queue_element.attachFirst();
				else		_queue_element.attachLast();
				return true;
			}else if(_single_count > 0){
				_single_type = true;
				_single_count -= 1;
				_queue_element.attachSingle();
				return true;
			}
			return false;
		}

		// --------------------------------------------------------------------------------
		// XMLHttpRequest を利用してロード（内部用）
		// --------------------------------------------------------------------------------
		function loadXMLHttpRequest(response){

			// アドレスチェック
			if(!(_request.url)){
				return false;
			}

			// プロトコルチェック
			if(!_request.url.match(new RegExp("^(http|https|ftp)://(.*)$","i"))){
				return false;
			}

			// バックグラウンドへ通信要求
			if(1){
				extension_message.sendRequest({command:"loadXMLHttpRequest",request:_request,single:_single_type}, function(receive) {
					var xhr = receive;
					switch(xhr.readyState){
					case 4:
						xhr.getAllResponseHeaders = function(){
							return xhr.responseHeaders;
						};

						var response_header = ResponseHeadersParseObject(xhr.responseHeaders);
						xhr.getResponseHeader = function(label){
							return response_header[label];
						};

						if((200 <= xhr.status && xhr.status < 300) || xhr.status == 304){
							// 成功を返す
							response(true,xhr);
						}else{
							// 失敗を返す
							response(false,xhr);
						}
						break;
					}
				});

				return true;
			}

			// XMLHttpRequest 作成
			var xhr = null;

			// 未対応
			if(!xhr){
				return false;
			}

			var sended = false;

			// ステート変更時に実行されるイベント
			xhr.onreadystatechange = function(r){
				if(!sended) return;
				switch(xhr.readyState){
				case 4:
					if((200 <= xhr.status && xhr.status < 300) || xhr.status == 304){
						// 成功を返す
						response(true,xhr);
					}else{
						// 失敗を返す
						response(false,xhr);
					}
					break;
				}
			};

			// 読み込み開始
			try{
				xhr.open(_request.method,_request.url,true);
			}catch(e){
				return false;
			}

			var headers = _request.headers;
			for(var name in headers){
				xhr.setRequestHeader(name,headers[name]);
			}

			if(xhr.overrideMimeType && _request.override_mime_type){
				xhr.overrideMimeType(_request.override_mime_type);
			}

			try{
				xhr.send(_request.data);
				sended = true;
			}catch(e){
				return false;
			}

			return true;

		}

		// --------------------------------------------------------------------------------
		// data URI scheme 読み込み（内部用）
		// --------------------------------------------------------------------------------
		function loadDataUriScheme(response){

			// アドレスチェック
			if(!(_request.url)){
				return false;
			}

			// プロトコルチェック
			if(!_request.url.match(new RegExp("^(http|https|ftp)://(.*)$","i"))){
				return false;
			}

			// バックグラウンドへ通信要求
			if(1){
				extension_message.sendRequest({command:"loadDataUriScheme",request:_request,single:_single_type}, function(receive) {
					var xhr = receive;
					switch(xhr.readyState){
					case 4:
						xhr.getAllResponseHeaders = function(){
							return xhr.responseHeaders;
						};
						
						var response_header = ResponseHeadersParseObject(xhr.responseHeaders);
						xhr.getResponseHeader = function(label){
							return response_header[label];
						};

						if((200 <= xhr.status && xhr.status < 300) || xhr.status == 304){
							// 成功を返す
							response(true,xhr);
						}else{
							// 失敗を返す
							response(false,xhr);
						}
						break;
					}
				});

				return true;
			}

			// XMLHttpRequest 作成
			var xhr = null;

			// 未対応
			if(!xhr){
				return false;
			}

			var sended = false;
			var response_type = "";

			// ステート変更時に実行されるイベント
			xhr.onreadystatechange = function(r){
				if(!sended) return;
				switch(xhr.readyState){
				case 4:
					if((200 <= xhr.status && xhr.status < 300) || xhr.status == 304){
						switch(response_type){
						case "arraybuffer":
							Base64FromArrayBufferAsync(xhr.response,1*1024,function(base64){
								// data URI scheme 変換
								xhr.dataUriScheme = "data:" + xhr.getResponseHeader("Content-Type") + ";base64," + base64;
								// 成功を返す
								response(true,xhr);
							});
							break;
						case "User-Defined":
							Base64FromUserDefinedAsync(xhr.responseText,1*1024,function(base64){
								// data URI scheme 変換
								xhr.dataUriScheme = "data:" + xhr.getResponseHeader("Content-Type") + ";base64," + base64;
								// 成功を返す
								response(true,xhr);
							});
							break;
						default:
							// 成功を返す
							response(true,xhr);
							break;
						}
					}else{
						// 失敗を返す
						response(false,xhr);
					}
				}
			};

			// 読み込み開始
			try{
				xhr.open(_request.method,_request.url,true);
			}catch(e){
				return false;
			}

			var headers = _request.headers;
			for(var name in headers){
				xhr.setRequestHeader(name,headers[name]);
			}
			if(xhr.responseType !== undefined){
				xhr.responseType = "arraybuffer";
				response_type = "arraybuffer";
			}else if(xhr.overrideMimeType){
				xhr.overrideMimeType("text/plain; charset=x-user-defined");
				response_type = "User-Defined";
			}
			try{
				xhr.send(_request.data);
				sended = true;
			}catch(e){
				return false;
			}

			return true;

		}

		// --------------------------------------------------------------------------------
		// ロード失敗（内部用）
		// --------------------------------------------------------------------------------
		function loadError(){
			loader_queue.addCountError();
			if(_container.onerror)	_container.onerror();
			_queue_element.release();
		}

		// --------------------------------------------------------------------------------
		// ロード成功（内部用）
		// --------------------------------------------------------------------------------
		function loadSuccess(v){
			if(_container.onload)	_container.onload(v);
			_queue_element.release();
		}

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _request;
		var _queue_element;
		var _count;
		var _single_count;
		var _single_type;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_request = {
				headers:new Object(),
				method:"GET",
				url:"",
				data:null
			};
			_count = 0;
			_single_count = 0;
			_queue_element = loader_queue.createElement();
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// タスクコンテナ
	// --------------------------------------------------------------------------------
	function TaskContainer(){

		var _container = new Object();

		// --------------------------------------------------------------------------------
		// タスク生成
		// --------------------------------------------------------------------------------
		_container.createTask = function(parent){
			var _task = new Object();

			// --------------------------------------------------------------------------------
			// タスクを実行
			// --------------------------------------------------------------------------------
			_task.execute = function(level){
				if(!_task._alive)	return;
				if(_task._execute_func){
					if(level & _task._level){
						_task._execute_func(_task);
					}
				}
			};

			// --------------------------------------------------------------------------------
			// タスクを破棄
			// --------------------------------------------------------------------------------
			_task.release = function(){
				_task.releaseChild();
				TaskRelease(_task);
			};

			// --------------------------------------------------------------------------------
			// 子タスクをすべて破棄
			// --------------------------------------------------------------------------------
			_task.releaseChild = function(){
				var a = new Array();
				var child = _task._child;
				var task = child._next;
				while(task != child){
					a.push(task);
					task = task._next;
				}
				var i;
				var num = a.length;
				for(i=0;i<num;i++){
					task = a[i];
					task.releaseChild();
					TaskRelease(task);
				}
			};

			// --------------------------------------------------------------------------------
			// 子タスクとして登録
			// --------------------------------------------------------------------------------
			_task.attachChild = function(task){
				task.removeParent();
				var prev = _task._child;
				var next = prev._next;
				prev._next = task;
				next._prev = task;
				task._prev = prev;
				task._next = next;
				task._parent = _task;
				_task._child_count += 1;
			};

			// --------------------------------------------------------------------------------
			// 自身の親子関係を外す
			// --------------------------------------------------------------------------------
			_task.removeParent = function(){
				if(_task._parent){
					_task._parent._child_count -= 1;
					var prev = _task._prev;
					var next = _task._next;
					prev._next = next;
					next._prev = prev;
					_task._prev = _task;
					_task._next = _task;
					_task._parent = null;
				}
			};

			// --------------------------------------------------------------------------------
			// 子の親子関係を外す
			// --------------------------------------------------------------------------------
			_task.removeChild = function(){
				var a = new Array();
				var child = _task._child;
				var task = child._next;
				while(task != child){
					a.push(task);
					task = task._next;
				}

				var i;
				var num = a.length;
				for(i=0;i<num;i++){
					task = a[i];
					task.removeParent();
				}
			};

			// --------------------------------------------------------------------------------
			// 子を取得
			// --------------------------------------------------------------------------------
			_task.getChild = function(func){
				var a = new Array();
				var child = _task._child;
				var task = child._next;
				while(task != child){
					a.push(task);
					task = task._next;
				}

				var i;
				var num = a.length;
				for(i=0;i<num;i++){
					task = a[i];
					func(task);
				}
			};

			// --------------------------------------------------------------------------------
			// 親を取得
			// --------------------------------------------------------------------------------
			_task.getParent = function(){
				return _task._parent;
			};

			// --------------------------------------------------------------------------------
			// 実行関数をゲット
			// --------------------------------------------------------------------------------
			_task.getExecuteFunc = function(){
				return _task._execute_func;
			};

			// --------------------------------------------------------------------------------
			// 実行関数をセット
			// --------------------------------------------------------------------------------
			_task.setExecuteFunc = function(func){
				_task._execute_func = func;
			};

			// --------------------------------------------------------------------------------
			// デストラクタ関数をゲット
			// --------------------------------------------------------------------------------
			_task.getDestructorFunc = function(){
				return _task._destructor_func;
			};

			// --------------------------------------------------------------------------------
			// デストラクタ関数をゲット
			// --------------------------------------------------------------------------------
			_task.setDestructorFunc = function(func){
				_task._destructor_func = func;
			};

			// --------------------------------------------------------------------------------
			// 自身の前の優先度でタスクを登録
			// --------------------------------------------------------------------------------
			_task.attachPrioPrev = function(task){
				TaskRemovePrio(task);
				var prev = _task._prio_prev;
				var next = _task;
				prev._prio_next = task;
				next._prio_prev = task;
				task._prio_prev = prev;
				task._prio_next = next;
			};

			// --------------------------------------------------------------------------------
			// 自身の後の優先度でタスクを登録
			// --------------------------------------------------------------------------------
			_task.attachPrioNext = function(task){
				TaskRemovePrio(task);
				var prev = _task;
				var next = _task._prio_next;
				prev._prio_next = task;
				next._prio_prev = task;
				task._prio_prev = prev;
				task._prio_next = next;
			};

			// --------------------------------------------------------------------------------
			// 自身の直前の優先度に位置するタスクを取得
			// --------------------------------------------------------------------------------
			_task.getPrioPrev = function(){
				return _task._prio_prev;
			};

			// --------------------------------------------------------------------------------
			// 自身の直後の優先度に位置するタスクを取得
			// --------------------------------------------------------------------------------
			_task.getPrioNext = function(){
				return _task._prio_next;
			};

			// --------------------------------------------------------------------------------
			// 子の総数を取得
			// --------------------------------------------------------------------------------
			_task.getCountChild = function(){
				return _task._child_count;
			};

			// --------------------------------------------------------------------------------
			// タスクレベルをゲット
			// --------------------------------------------------------------------------------
			_task.getLevel = function(){
				return _task._level;
			};

			// --------------------------------------------------------------------------------
			// タスクレベルをセット
			// --------------------------------------------------------------------------------
			_task.setLevel = function(level){
				_task._level = level;
			};

			// --------------------------------------------------------------------------------
			// 生存状態をゲット
			// --------------------------------------------------------------------------------
			_task.getAlive = function(){
				return _task._alive;
			};

			// --------------------------------------------------------------------------------
			// ユーザーワークを取得
			// --------------------------------------------------------------------------------
			_task.getUserWork = function(){
				return _task._user_work;
			};

			// --------------------------------------------------------------------------------
			// 初期化
			// --------------------------------------------------------------------------------
			_task._prio_prev = _task;
			_task._prio_next = _task;
			_task._prev = _task;
			_task._next = _task;
			_task._parent = null;
			_task._child_count = 0;
			_task._child = new Object();
			_task._child._prev = _task._child;
			_task._child._next = _task._child;
			_task._alive = true;
			_task._level = 0xffffffff;
			_task._user_work = new Object();
			_task._execute_func = null;
			_task._destructor_func = null;
			_container.attachPrioLast(_task);

			if(parent){
				parent.attachChild(_task);
			}

			_container.attachPrioLast(_task);

			if(_task_count == 1){
				if(_start_func)	_start_func();
			}
			_task_count += 1;

			return _task;
		};

		// --------------------------------------------------------------------------------
		// タスクコンテナ実行
		// --------------------------------------------------------------------------------
		_container.execute = function(level){
			var a = new Array();
			var task = _container._prio_next;
			while(task != _container){
				a.push(task);
				task = task._prio_next;
			}

			var i;
			var num = a.length;
			for(i=0;i<num;i++){
				task = a[i];
				if(task.getAlive()){
					task.execute(level);
				}else{
					// 開放
					var prev = task._prio_prev;
					var next = task._prio_next;
					prev._prio_next = next;
					next._prio_prev = prev;
				}
			}
		};

		// --------------------------------------------------------------------------------
		// タスクコンテナ開放
		// --------------------------------------------------------------------------------
		_container.release = function(){
			var a = new Array();
			var task = _container._prio_next;
			while(task != _container){
				a.push(task);
				task = task._prio_next;
			}

			var prev;
			var next;
			var i;
			var num = a.length;
			for(i=0;i<num;i++){
				task = a[i];
				TaskRelease(task);
				prev = task._prio_prev;
				next = task._prio_next;
				prev._prio_next = next;
				next._prio_prev = prev;
			}
		};

		// --------------------------------------------------------------------------------
		// 子としてタスクを登録
		// --------------------------------------------------------------------------------
		_container.attachChild = function(task){
			_root_task.attachChild(task);
		};

		// --------------------------------------------------------------------------------
		// 優先度を最前列で登録
		// --------------------------------------------------------------------------------
		_container.attachPrioFirst = function(task){
			TaskRemovePrio(task);
			var prev = _container;
			var next = prev._prio_next;
			prev._prio_next = task;
			next._prio_prev = task;
			task._prio_prev = prev;
			task._prio_next = next;
		};

		// --------------------------------------------------------------------------------
		// 優先度を最後尾で登録
		// --------------------------------------------------------------------------------
		_container.attachPrioLast = function(task){
			TaskRemovePrio(task);
			var next = _container;
			var prev = next._prio_prev;
			prev._prio_next = task;
			next._prio_prev = task;
			task._prio_prev = prev;
			task._prio_next = next;
		};

		// --------------------------------------------------------------------------------
		// 優先度を外す（内部用）
		// --------------------------------------------------------------------------------
		function TaskRemovePrio(task){
			var next = task._prio_next;
			if(task != next){
				var prev = task._prio_prev;
				prev._prio_next = next;
				next._prio_prev = prev;
				task._prio_prev = task;
				task._prio_next = task;
			}
		}

		// --------------------------------------------------------------------------------
		// 開放（内部用）
		// --------------------------------------------------------------------------------
		function TaskRelease(task){
			if(task._alive){
				task._alive = false;

				if(task._destructor_func){
					task._destructor_func(task);
				}

				task.removeParent();

				task._user_work = null;
				_task_count -= 1;

				if(_task_count == 1){
					if(_end_func)	_end_func();
				}
			}
		}

		// --------------------------------------------------------------------------------
		// タスク総数を取得
		// --------------------------------------------------------------------------------
		_container.getCountTask = function(){
			return _task_count;
		};

		// --------------------------------------------------------------------------------
		// 開始関数をセット
		// --------------------------------------------------------------------------------
		_container.setStartFunc = function(f){
			_start_func = f;
		};

		// --------------------------------------------------------------------------------
		// 終了関数をセット
		// --------------------------------------------------------------------------------
		_container.setEndFunc = function(f){
			_end_func = f;
		};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _root_task;
		var _task_count;
		var _start_func = null;
		var _end_func = null;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		_task_count = 0;
		_container._prio_prev = _container;
		_container._prio_next = _container;
		_root_task = _container.createTask(null);

		return _container;
	}

	// --------------------------------------------------------------------------------
	// リダイレクト辞書
	// --------------------------------------------------------------------------------
	function RedirectUrlDictionary(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// 要素を作成
		// --------------------------------------------------------------------------------
		function createElement(current_url){
			var _element = new Object();

			// --------------------------------------------------------------------------------
			// 双方向リストを外す
			// --------------------------------------------------------------------------------
			_element.release = function(){
				_element.remove();
				delete _dictionary[current_url];
				_count -= 1;
			};

			// --------------------------------------------------------------------------------
			// 双方向リストを外す
			// --------------------------------------------------------------------------------
			_element.remove = function(){
				var _prev = _element._prev;
				var _next = _element._next;
				_prev._next = _next;
				_next._prev = _prev;
				_element._prev = _element;
				_element._next = _element;
			};

			// --------------------------------------------------------------------------------
			// リダイレクト先 URL を取得
			// --------------------------------------------------------------------------------
			_element.getURL = function(){
				return _url;
			};

			// --------------------------------------------------------------------------------
			// リダイレクト先 URL をセット
			// --------------------------------------------------------------------------------
			_element.setURL = function(url){
				_url = url;
			};

			// --------------------------------------------------------------------------------
			// プライベート変数
			// --------------------------------------------------------------------------------
			var _url;

			// --------------------------------------------------------------------------------
			// 初期化
			// --------------------------------------------------------------------------------
			(function(){
				_element._prev = _element;
				_element._next = _element;
				_dictionary[current_url] = _element;
				_count += 1;
			})();

			return _element;
		}

		// --------------------------------------------------------------------------------
		// URL を登録
		// --------------------------------------------------------------------------------
		_container.addURL = function(current_url,url){
			var element = null;
			element = _dictionary[current_url];
			if(element){
				element.remove();
			}else{
				// 要素を新規作成
				element = createElement(current_url);
			}

			// 最新へ登録
			element.setURL(url);
			var _next = _container._prev;
			var _prev = _next._prev;
			_prev._next = element;
			_next._prev = element;
			element._prev = _prev;
			element._next = _next;

			// 古い要素を破棄
			if(_count >= _cache_max){
				element = _container._next;
				element.release();
			}
		};

		// --------------------------------------------------------------------------------
		// リダイレクト先 URL を繰り返し取得する
		// --------------------------------------------------------------------------------
		_container.getRedirectURL = function(current_url){
			var i;
			var num = _repeat_max;
			for(i=0;i<num;i++){
				if(!_dictionary[current_url])	break;
				if(current_url == _dictionary[current_url].getURL())	break;
				current_url = _dictionary[current_url].getURL();
			}

			if(i)	return current_url;
			return null;
		};

		// --------------------------------------------------------------------------------
		// キャッシュ最大数をセット
		// --------------------------------------------------------------------------------
		_container.setMaxCache = function(v){
			_cache_max = v;
		};

		// --------------------------------------------------------------------------------
		// 繰り返し最大数をセット
		// --------------------------------------------------------------------------------
		_container.setMaxRepeat = function(v){
			_cache_max = v;
		};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _dictionary;
		var _count;
		var _cache_max;
		var _repeat_max;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_dictionary = new Object();
			_container._prev = _container;
			_container._next = _container;
			_count = 0;
			_cache_max = 256;
			_repeat_max = 16;
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// ローダー進捗通知
	// --------------------------------------------------------------------------------
	function NotifyProgress(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// 要素生成
		// --------------------------------------------------------------------------------
		_container.createElement = function(){
			var _element = new Object();

			// --------------------------------------------------------------------------------
			// 開放
			// --------------------------------------------------------------------------------
			_element.release = function(){
				// マウスイベントを外す
				removeEventMouseOver();

				// タスクを破棄
				releaseTask();
			};

			// --------------------------------------------------------------------------------
			// 当たり判定用エレメントをセット
			// --------------------------------------------------------------------------------
			_element.setElementHitArea = function(element){
				_element_hit_area = element;

				// マウスイベントを開始
				addEventMouseOver();

				// マウスとの当たり判定
				if(ElementHitTestMousePosition(element,input_mouse.getPositionClient(),true)){
					mouseOver(null);
				}
			};

			// --------------------------------------------------------------------------------
			// 通知をセット
			// --------------------------------------------------------------------------------
			_element.setNotify = function(type){
				_notify = type;
				ElementSetNotify(_element,_notify);
			};

			// --------------------------------------------------------------------------------
			// 通知をセット
			// --------------------------------------------------------------------------------
			_element.hitTest = function(){
				return _hittest;
			};

			// --------------------------------------------------------------------------------
			// マウスオーバーイベントを追加（内部用）
			// --------------------------------------------------------------------------------
			function addEventMouseOver(){
				removeEventMouseOver();

				if(_element_hit_area.addEventListener){
					_element_hit_area.addEventListener("mouseover",mouseOver,false);
				}else if(_element_hit_area.attachEvent){
					_element_hit_area.attachEvent("onmouseover",mouseOver);
				}
			}

			// --------------------------------------------------------------------------------
			// マウスオーバーイベントを外す（内部用）
			// --------------------------------------------------------------------------------
			function removeEventMouseOver(){
				if(_element_hit_area.removeEventListener){
					_element_hit_area.removeEventListener("mouseover",mouseOver,false);
				}else if(_element_hit_area.detachEvent){
					_element_hit_area.detachEvent("onmouseover",mouseOver);
				}
			}

			// --------------------------------------------------------------------------------
			// マウスオーバーイベント（内部用）
			// --------------------------------------------------------------------------------
			function mouseOver(e){
				// マウス入力を更新
				if(e){
					input_mouse.setMouseEvent(e);
				}

				// タスクを生成
				createTask();
			}

			// --------------------------------------------------------------------------------
			// マウスムーブ（内部用）
			// --------------------------------------------------------------------------------
			function mouseMove(){
				if(!_task)	return;

				var work = _task.getUserWork();
				var hit = ElementHitTestPosition(_element_hit_area,input_mouse.getPositionClient(),true);
				if(!hit){
					releaseTask();
				}
			}

			// --------------------------------------------------------------------------------
			// タスク生成（内部用）
			// --------------------------------------------------------------------------------
			function createTask(){
				if(!_task){
					_hittest = true;

					ElementFocus(_element);
					ElementSetNotify(_element,_notify);

					_task = task_container.createTask();
					_task.setDestructorFunc(function(){
						_hittest = false;
						ElementBlur(_element);
					});
					_task.setExecuteFunc(function(){
						mouseMove();
					});
					_task.execute(0xffffffff);
				}
			}

			// --------------------------------------------------------------------------------
			// タスク破棄（内部用）
			// --------------------------------------------------------------------------------
			function releaseTask(){
				if(_task){
					_task.release();
					_task = null;
				}
			}

			// --------------------------------------------------------------------------------
			// プライベート変数
			// --------------------------------------------------------------------------------
			var _element_hit_area;
			var _notify;
			var _task;
			var _hittest;

			// --------------------------------------------------------------------------------
			// 初期化
			// --------------------------------------------------------------------------------
			(function(){
				_element_hit_area = null;
				_notify = NotifyProgress.NOTIFY_TYPE_UNKNOWN;
				_task = null;
				_hittest = false;
			})();

			return _element;
		};

		// --------------------------------------------------------------------------------
		// アクティブ
		// --------------------------------------------------------------------------------
		function ElementFocus(element){
			_active = element;

			if(!_task){
				// タスクを生成
				_task = task_container.createTask();
				_task.setDestructorFunc(NotifyIconDestructor);
				_task.setExecuteFunc(NotifyIconInitialize);
				_task.execute(0xffffffff);
			}else{
				_task.setExecuteFunc(NotifyIconFadeIn);
			}

		}

		// --------------------------------------------------------------------------------
		// 非アクティブ
		// --------------------------------------------------------------------------------
		function ElementBlur(element){
			if(element != _active)	return;

			if(_task){
				_task.setExecuteFunc(NotifyIconFadeOut);
			}
		}

		// --------------------------------------------------------------------------------
		// 通知をセット
		// --------------------------------------------------------------------------------
		function ElementSetNotify(element,type){
			if(element != _active)	return;
			if(_notify == type)	return;

			switch(type){
			case NotifyProgress.NOTIFY_TYPE_LOADING:
				_icon.src = "data:image/gif;base64,R0lGODlhGAAYALMAAP//3vf31sXFtYyMjHuEjGNrc0pSY0JKUv///wAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh+QQJCAAIACwAAAAAGAAYAAAEexDJSZExNetpQsBbRVQHABwhNQgFVZ6pRAhA0EovGiNFUN+dz07Sq4Euw0lRl6wYmM2o5nk4gFJUq8VnEoY6JiO4e51yjZaqNpYtS7FQlzuzzJRsoaIXuf1p9EAeIIAiNHg4JkxFAiMqLC6JFAUCAxqNEzkiSUFzTXwhEQAh+QQJCAAIACwAAAAAFgAYAAAEfxDJSZExNWsbAt4TUR0AcFQiNQgFRZpUIQyhAASt9J5SEQCCFMJ3yxk6HyKuovxcJMeihshzSTeG6ugD6mayhwPXC/2VPORJ9Dwmg8XpuByqdbVjvzqCtMw0oU4/fRNKRkg9gjkIBDaDO4Q/QRMrinslWjI0FEI6lyhuh3OAIBEAIfkECQgACAAsAAAAABgAGAAABHoQyUmRMTXraULAW0VUBwAcojYIBVWeVCEMogAErfSiUhEAglHsh5N0Pj1iruK7gS5GZajJc92WG0OVBAp5vdrDoRsKjy0/E7KcdnZMTnAbaSZnxeevXqPdb6h+TERPdlNSaGteBDZFOiZbIStYO35CE5SBFEeFgVBeEQAh+QQJCAAIACwAAAAAGAAWAAAEexDJSZExNetpQsBbRVQHAByiNggFVZ5UIQyiAASt9KJSEQCCUeyHk3Q+PWKu4ruBLkZlqMlz3ZYbQ5UECnm92sOhGwqPLT8Tspx2dkxOcBtpJmfF569eo93kpz9bOleAcRVvRRlNiYpSFAQ2jBpNQRUrWBsyNBlCep0IEQAh+QQJCAAIACwAAAAAGAAYAAAEeRDJSZExNetpQsBbRVQHAByiNggFVZ5UIQyiAASt9KJSEQCCUeyHk3Q+PWKu4ruBLkZlqMlz3ZYbQ5UECnm92sOhGwqPLT8Tspx2dkxOcBtpJmfF569+77LzdVd/Fk9Se0cgTUV6OxNNQYsmWzI0kDAUQnqHghVQXhEAIfkECQgACAAsAgAAABYAGAAABH0QyTmNoThTE8LVFIEdAHBgIjUIBUWaVCEMEyEAQSu9p1QEAEEK8cPpOB4fMIcpJhEWCceoKfZcVJDhOvqAvuDw5kD2iqHA0vM8VZvF2/J5vgUd3jEgd5dtLj9RaH1KWUgfTjoINn08E0VCEyuJCI2OMygjJXtDX4ZzGIFfEQAh+QQJCAAIACwAAAAAGAAYAAAEfBDJSZExNetpQsBbKB0AcFSESJEmVQiDOpanVASAkKrdZ+OBgkxyIQKFwwopmNQcQM2k4UCFhqZVC67ku24Bn04JbM2IuRjsU6YuR0XTzVp0aynBSE29W9Ti9UdGXXt5EgQCfzN2CHU6FQMChSw1NjAaOxOTKFIebk19IREAIfkECQgACAAsAAACABgAFgAABHgQSUSmvbLiIQrGhTBchAAE3icVASBoE3umYIt+cmBghk3XgAPmMFNNDMLPYWdsOpGHpRMBlfYAWF3zmjVwT0zVV1sNG8vTNC85NONa7AnxpsoxvZIr/ZJL9bQIfSQme0RBMS0vFxw/hnEhIxgwEo4kan9uanmZFxEAOw==";
				break;
			case NotifyProgress.NOTIFY_TYPE_COMPLETE:
				_icon.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAAAA3NCSVQICAjb4U/gAAAAwFBMVEX///+A/4CA/4D///+A/4CA/4CA/4CA/4Dn5+eA/4CA/4CA/4CA/4CA/4CSkpIqWyr5+fng4OB9fX0REREAAAAgSiAxajH6+vrz8/Pw8PDq6urX19fHx8fExMSqqqqnp6ejo6Oenp6ZmZmWlpYtLS0lJSUeHh6Mx4yu564IHAg0RTQ5TTk4STgqNioLIAtxd3FwfXBcdVyP+Y9Ci0ImUibT09O7u7uJiYmCgoJ6enpsbGxgYGBHR0c+Pj42NjYnJyeRSLVtAAAAQHRSTlMA7iL/iFUzRP8Rd6rdzP/u///////M7v////////////////////8iM3eZqqq7u8zd3e7u7v//////////////aE0y2QAAAAlwSFlzAAALEgAACxIB0t1+/AAAABx0RVh0U29mdHdhcmUAQWRvYmUgRmlyZXdvcmtzIENTNui8sowAAAAWdEVYdENyZWF0aW9uIFRpbWUAMDEvMDcvMTOlb7SWAAAA4UlEQVQokZ3R1xKCMBAFUNJIKFawF6zYe+///1dmJaA4vOh9PDczm9nVtH9jYBUj7ljnnMlwruO4M5O+YjJ9GHNq2UjGtig7ea3721NI5Vgn5OAGcz/dKxORd4MfYG5aocvnIu1yrApqK6+BO4WwYFR57uVFyr4K8I5fRFGxXEldowZ4L4OiolVrdGWzJ4S0waNisSuVyqIpvXoFt2k4/JHLEoi4bGGUZarCGN8q0Ii8A56iTFcrxtNzBdwNPVownnSz1bSzCZb4uXg8a7b7BbX2+EH8/jzpUJo2GCWf9oc8AZktDpWygbAkAAAAAElFTkSuQmCC";
				break;
			case NotifyProgress.NOTIFY_TYPE_ERROR:
				_icon.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAAAA3NCSVQICAjb4U/gAAAAwFBMVEX/////VVX3UlJNbGyULi4mDw86GhoMERHoTEzPRET/pqb/ZmZ0MTGZMzN0JCQYIiIMERH/xcWfqqrDWVnUS0u+T0+SPz9sQkJ6OTkRGBj84ODzZmboWVl3YmJhIiJMIiJBIiIGCAgRGBiIv79okpIuQUEGCAjk///N9va66enW3Ny11tb/trbqkpKOm5u7hYWGfHyycXFZfHzgVFSsX1+cTk6xQUF3SEhTTExSOzt5JCRiKysXCAh/srIRGBgpOTlzKqofAAAAQHRSTlMA///////////////////M3f//////////3f////////+ZzN3d3d3/////////////////////////////mZnMlM/YUAAAAAlwSFlzAAALEgAACxIB0t1+/AAAABx0RVh0U29mdHdhcmUAQWRvYmUgRmlyZXdvcmtzIENTNui8sowAAAAWdEVYdENyZWF0aW9uIFRpbWUAMDEvMDcvMTOlb7SWAAABLElEQVQokV2SZ2OCMBCG7yCJQAEBqWKdbUVbtzg6tPX//6teBiK9T8n75HYAjNmTwpYGdXtdzOOl53mrzSC/199n8QNq6x2+Kv3tqZSl7f2a7gw558J3LbTSs4mj3g+f1UW0ibhjlXem4hgAzQzRYl06LWIV2R39anI90oVcfubkkNKrNGtq8tlDK7RhQg6nqQgodEl2iEEExRJRAIxORPwXBbYEGmB7iJxu50cK58uksK4B6EjSliRBZBoIqEh+AytEMwNJ8FhACzGMwN5Q2doFPkiivmk+gsY/oLIzXQ4MWnqOTGbND7Ic08Ja6Y6Yqk77MqnZQir174sJTQT7u+06SVpK5+VCOnur2pMT3nQaCHMNchi/3C+9Ow5ZwBgLBZ/++yd21CCLbt/nD9ghFMIF8V9xAAAAAElFTkSuQmCC";
				break;
			}
			
			_notify = type;
		}

		// --------------------------------------------------------------------------------
		// マウスムーブ（内部用）
		// --------------------------------------------------------------------------------
		function mouseMove(){
			if(!_task)	return;
			var work = _task.getUserWork();
			var mouse_pos = input_mouse.getPositionClient();
			_icon.style.left = (mouse_pos.x - 24.0/2.0) + "px";
			_icon.style.top  = (mouse_pos.y - 24.0-2.0) + "px";
		}

		// --------------------------------------------------------------------------------
		// 初期化（内部用）
		// --------------------------------------------------------------------------------
		function NotifyIconInitialize(task){
			var work = task.getUserWork();

			work.anime_pos = 0.0;
			work.anime_spd = 0.0;

			// 最前面に配置
			_icon.style.zIndex = 0x7FFFFFFF;
			_icon.style.position = "fixed";
			_icon.style.pointerEvents = "none";
			document.body.appendChild(_icon);

			task.setExecuteFunc(NotifyIconFadeIn);
			task.execute(0xffffffff);
		}

		// --------------------------------------------------------------------------------
		// デストラクタ（内部用）
		// --------------------------------------------------------------------------------
		function NotifyIconDestructor(task){
			DomNodeRemove(_icon);
			_task = null;
		}

		// --------------------------------------------------------------------------------
		// フェードイン（内部用）
		// --------------------------------------------------------------------------------
		function NotifyIconFadeIn(task){
			var work = task.getUserWork();

			// マウスムーブ
			mouseMove();

			var sub = 1.0 - work.anime_pos;
			sub *= 0.4;
			if(sub > 0.0){
				work.anime_spd += 0.05;
				if(work.anime_spd > 0.2)	work.anime_spd = 0.2;
				if(work.anime_spd > sub)	work.anime_spd = sub;
			}

			work.anime_pos += work.anime_spd;
			if(work.anime_pos > 0.999){
				work.anime_spd = 0.0;
				work.anime_pos = 1.0;
				task.setExecuteFunc(NotifyIconShowInit);
			}
			_icon.style.opacity = work.anime_pos;
		}

		// --------------------------------------------------------------------------------
		// 表示（内部用）
		// --------------------------------------------------------------------------------
		function  NotifyIconShowInit(task){
			var work = task.getUserWork();

			work.anime_pos = 1.0;
			work.anime_spd = 0.0;
			_icon.style.opacity = work.anime_pos;

			task.setExecuteFunc( NotifyIconShowExec);
			task.execute(0xffffffff);
		}
		function  NotifyIconShowExec(task){
			var work = task.getUserWork();

			// マウスムーブ
			mouseMove();
		}

		// --------------------------------------------------------------------------------
		// フェードアウト（内部用）
		// --------------------------------------------------------------------------------
		function NotifyIconFadeOut(task){
			var work = task.getUserWork();

			// マウスムーブ
			mouseMove();

			var sub = 0.0 - work.anime_pos;
			sub *= 0.4;
			if(sub < 0.0){
				work.anime_spd -= 0.2;
				if(work.anime_spd < sub)	work.anime_spd = sub;
			}
			work.anime_pos += work.anime_spd;
			if(work.anime_pos < 0.001){
				work.anime_spd = 0.0;
				work.anime_pos = 0.0;
				task.setExecuteFunc(NotifyIconClose);
			}
			_icon.style.opacity = work.anime_pos;
		}

		// --------------------------------------------------------------------------------
		// 閉じる（内部用）
		// --------------------------------------------------------------------------------
		function NotifyIconClose(task){
			var work = task.getUserWork();
			task.release();
		}

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _icon;
		var _active;
		var _notify;

		var _task;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_icon = DocumentCreateElement("img");
			_notify = NotifyProgress.NOTIFY_TYPE_UNKNOWN;
		})();

		return _container;
	}
	NotifyProgress.NOTIFY_TYPE_UNKNOWN = 0;
	NotifyProgress.NOTIFY_TYPE_LOADING = 1;
	NotifyProgress.NOTIFY_TYPE_COMPLETE = 2;
	NotifyProgress.NOTIFY_TYPE_ERROR = 3;
	NotifyProgress.NOTIFY_TYPE_RELEASE = 4;


	// --------------------------------------------------------------------------------
	// 可視制限コンテナ（数指定）
	// --------------------------------------------------------------------------------
	function ElementLimiterByCount(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// 要素生成
		// --------------------------------------------------------------------------------
		_container.createElement = function(){
			var _element = new Object();

			// --------------------------------------------------------------------------------
			// 開放
			// --------------------------------------------------------------------------------
			_element.release = function(){
				_element.remove();
				removeObserver();
				ElementRemove(_element);
				_count -= 1;
			};

			// --------------------------------------------------------------------------------
			// 当たり判定用エレメントをセット
			// --------------------------------------------------------------------------------
			_element.setElementHitArea = function(element){
				_element._element_hit_area = element;
			};

			// --------------------------------------------------------------------------------
			// アタッチイベント
			// --------------------------------------------------------------------------------
			_element.onattach = function(){};

			// --------------------------------------------------------------------------------
			// リムーブイベント
			// --------------------------------------------------------------------------------
			_element.onremove = function(){};

			// --------------------------------------------------------------------------------
			// アタッチ
			// --------------------------------------------------------------------------------
			_element.attach = function(){
				if(!(_element._use)){
					_element._use = true;
					_use_count += 1;
					ElementAttachUseList(_element);
					removeObserver();
					_element.onattach();
				}

			};

			// --------------------------------------------------------------------------------
			// リムーブ
			// --------------------------------------------------------------------------------
			_element.remove = function(){
				if(_element._use){
					_element._use = false;
					_use_count -= 1;
					ElementAttachRestList(_element);
					attachObserver();
					_element.onremove();
				}
			};

			// --------------------------------------------------------------------------------
			// 監視開始
			// --------------------------------------------------------------------------------
			function attachObserver (){
				removeObserver();
				if(!_observer_Scroll){
					_observer_Scroll = document_observer_scroll.createElement();
					_observer_Scroll.setFunction(_element.update);
				}
			}

			// --------------------------------------------------------------------------------
			// 監視終了
			// --------------------------------------------------------------------------------
			function removeObserver (){
				if(_observer_Scroll){
					_observer_Scroll.release();
					_observer_Scroll = null;
				}
			}

			// --------------------------------------------------------------------------------
			// 更新
			// --------------------------------------------------------------------------------
			_element.update = function(){
				if(_use_count < _use_max){
					// アタッチ
					_element.attach();
				}else{
					var client_size = DocumentGetClientSize(document);
					var r = ElementGetBoundingClientRect(_element._element_hit_area);
					if(r.right < 0){
					}else if(client_size.width < r.left){
					}else if(r.bottom < 0){
					}else if(client_size.height < r.top){
					}else{
						if(!_inner){
							// 遠い要素を外す
							var element_far = getElementFar();
							if(element_far){
								element_far.remove();
							}

							// アタッチ
							_element.attach();
						}
						_inner = true;
						return;
					}
					_inner = false;
				}
			};

			// --------------------------------------------------------------------------------
			// プライベート変数
			// --------------------------------------------------------------------------------
			var _observer_Scroll;
			var _inner;

			// --------------------------------------------------------------------------------
			// 初期化
			// --------------------------------------------------------------------------------
			(function(){
				_element._use = false;
				_element._prev = _element;
				_element._next = _element;
				_element._element_hit_area = null;
				attachObserver();
				ElementAttachRestList(_element);
				_inner = false;
				_count += 1;
			})();

			return _element;
		};

		// --------------------------------------------------------------------------------
		// 使用数を取得
		// --------------------------------------------------------------------------------
		_container.getCountUse = function(){
			return _use_count;
		};

		// --------------------------------------------------------------------------------
		// 使用最大数を取得
		// --------------------------------------------------------------------------------
		_container.getMaxUse = function(){
			return _use_max;
		};

		// --------------------------------------------------------------------------------
		// 使用最大数をセット
		// --------------------------------------------------------------------------------
		_container.setMaxUse = function(v){
			_use_max = v;
		};

		// --------------------------------------------------------------------------------
		// 使用数を取得
		// --------------------------------------------------------------------------------
		_container.getCount = function(){
			return _count;
		};

		// --------------------------------------------------------------------------------
		// エレメントを外す（内部用）
		// --------------------------------------------------------------------------------
		function ElementRemove(element){
			var _prev = element._prev;
			var _next = element._next;
			_prev._next = _next;
			_next._prev = _prev;
			element._prev = element;
			element._next = element;
		}

		// --------------------------------------------------------------------------------
		// エレメント未使用リストに登録（内部用）
		// --------------------------------------------------------------------------------
		function ElementAttachRestList(element){
			ElementRemove(element);
			var _prev = _rest_list;
			var _next = _prev._next;
			_prev._next = element;
			_next._prev = element;
			element._prev = _prev;
			element._next = _next;
			element._use = false;
		}

		// --------------------------------------------------------------------------------
		// エレメント使用リストに登録（内部用）
		// --------------------------------------------------------------------------------
		function ElementAttachUseList(element){
			ElementRemove(element);
			var _prev = _use_list;
			var _next = _prev._next;
			_prev._next = element;
			_next._prev = element;
			element._prev = _prev;
			element._next = _next;
			element._use = true;
		}

		// --------------------------------------------------------------------------------
		// 一番遠い要素を取得（内部用）
		// --------------------------------------------------------------------------------
		function getElementFar(){
			var client_size = DocumentGetClientSize(document);
			var client_x = client_size.width * 0.5;
			var client_y = client_size.height * 0.5;
			var element = null;
			var distance = 0;

			// 使用リスト
			var list = _use_list._next;
			while(list != _use_list){
				var next = list._next;
				var r = ElementGetBoundingClientRect(list._element_hit_area);

				var element_x = (r.left + r.right) * 0.5;
				var element_y = (r.top + r.bottom) * 0.5;
				var x = element_x - client_x;
				var y = element_y - client_y;
				var d = x * x + y * y;
				if(d > distance){
					distance = d;
					element = list;
				}

				list = list._next;
			}

			return element;
		}

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _use_list;
		var _rest_list;
		var _count;
		var _use_count;
		var _use_max;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_use_list = new Object();
			_rest_list = new Object();
			_count = 0;
			_use_count = 0;
			_use_max = 0;

			_use_list._prev = _use_list;
			_use_list._next = _use_list;
			_rest_list._prev = _rest_list;
			_rest_list._next = _rest_list;
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// 可視制限コンテナ（バイト数指定）
	// --------------------------------------------------------------------------------
	function ElementLimiterByByteSize(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// 要素生成
		// --------------------------------------------------------------------------------
		_container.createElement = function(){
			var _element = new Object();

			// --------------------------------------------------------------------------------
			// 開放
			// --------------------------------------------------------------------------------
			_element.release = function(){
				_element.remove();
				removeObserver();
				ElementRemove(_element);
				_count -= 1;
			};

			// --------------------------------------------------------------------------------
			// プリロード設定をセット
			// --------------------------------------------------------------------------------
			_element.setEnablePreload = function(v){
				_element._preload = v;
			};

			// --------------------------------------------------------------------------------
			// 当たり判定用エレメントをセット
			// --------------------------------------------------------------------------------
			_element.setElementHitArea = function(element){
				_element._element_hit_area = element;
			};

			// --------------------------------------------------------------------------------
			// サイズをセット
			// --------------------------------------------------------------------------------
			_element.setByteSize = function(size){
				_element._byte_size = size;
				_byte_size_now += size;
			};

			// --------------------------------------------------------------------------------
			// アタッチイベント
			// --------------------------------------------------------------------------------
			_element.onattach = function(){};

			// --------------------------------------------------------------------------------
			// リムーブイベント
			// --------------------------------------------------------------------------------
			_element.onremove = function(){};

			// --------------------------------------------------------------------------------
			// アタッチ
			// --------------------------------------------------------------------------------
			_element.attach = function(){
				if(!(_element._use)){
					_element._use = true;
					_use_count += 1;
					ElementAttachUseList(_element);
					removeObserver();
					_element.onattach();
				}

			};

			// --------------------------------------------------------------------------------
			// リムーブ
			// --------------------------------------------------------------------------------
			_element.remove = function(){
				if(_element._use){
					_element._use = false;
					_use_count -= 1;
					ElementAttachRestList(_element);
					attachObserver();
					_element.onremove();

					_byte_size_now -= _element._byte_size;
					_element._byte_size = 0;
				}
			};

			// --------------------------------------------------------------------------------
			// 監視開始
			// --------------------------------------------------------------------------------
			function attachObserver (){
				removeObserver();
				if(!_observer_Scroll){
					_observer_Scroll = document_observer_scroll.createElement();
					_observer_Scroll.setFunction(_element.update);
				}
			}

			// --------------------------------------------------------------------------------
			// 監視終了
			// --------------------------------------------------------------------------------
			function removeObserver (){
				if(_observer_Scroll){
					_observer_Scroll.release();
					_observer_Scroll = null;
				}
			}

			// --------------------------------------------------------------------------------
			// 更新
			// --------------------------------------------------------------------------------
			_element.update = function(){
				var preload = false;

				if(_element._preload){
					if(!_limit){
						preload = true;
					}
				}

				if(preload){
					// アタッチ
					_element.attach();
				}else{
					var client_size = DocumentGetClientSize(document);
					var r = ElementGetBoundingClientRect(_element._element_hit_area);
					if(r.right < 0){
					}else if(client_size.width < r.left){
					}else if(r.bottom < 0){
					}else if(client_size.height < r.top){
					}else{
						if(!_inner){
							// 古いデータを破棄
							_container.removeOldElements();

							// アタッチ
							_element.attach();
						}
						_inner = true;
						return;
					}
					_inner = false;
				}
			};

			// --------------------------------------------------------------------------------
			// プライベート変数
			// --------------------------------------------------------------------------------
			var _observer_Scroll;
			var _inner;

			// --------------------------------------------------------------------------------
			// 初期化
			// --------------------------------------------------------------------------------
			(function(){
				_element._use = false;
				_element._byte_size = 0;
				_element._prev = _element;
				_element._next = _element;
				_element._element_hit_area = null;
				_element.setEnablePreload(true);
				attachObserver();
				ElementAttachRestList(_element);
				_inner = false;
				_count += 1;
			})();

			return _element;
		};

		// --------------------------------------------------------------------------------
		// 古い要素を破棄
		// --------------------------------------------------------------------------------
		_container.removeOldElements = function(){
			if(!_enable_unload)	return;

			if(_byte_size_now > _byte_size_max){
				_limit = true;
				var client_size = DocumentGetClientSize(document);

				var list = _use_list._prev;
				do {
					if(list == _use_list)	return;

					var r = ElementGetBoundingClientRect(list._element_hit_area);
					if(r.right < 0){
					}else if(client_size.width < r.left){
					}else if(r.bottom < 0){
					}else if(client_size.height < r.top){
					}else{
						list = list._prev;
						continue;
					}

					list = list._prev;
					list._next.remove();

				} while(_byte_size_now > _byte_size_max);
			}
		};

		// --------------------------------------------------------------------------------
		// 使用数を取得
		// --------------------------------------------------------------------------------
		_container.getCountUse = function(){
			return _use_count;
		};

		// --------------------------------------------------------------------------------
		// 現在の使用バイト数を取得
		// --------------------------------------------------------------------------------
		_container.getByteSizeNow = function(){
			return _byte_size_now;
		};

		// --------------------------------------------------------------------------------
		// 使用最大バイト数をセット
		// --------------------------------------------------------------------------------
		_container.setByteSizeMax = function(v){
			_byte_size_max = v * 1024 * 1024;
		};

		// --------------------------------------------------------------------------------
		// アンロード設定のセット
		// --------------------------------------------------------------------------------
		_container.setEnableUnload = function(v){
			_enable_unload = v;
		};

		// --------------------------------------------------------------------------------
		// 使用数を取得
		// --------------------------------------------------------------------------------
		_container.getCount = function(){
			return _count;
		};

		// --------------------------------------------------------------------------------
		// エレメントを外す（内部用）
		// --------------------------------------------------------------------------------
		function ElementRemove(element){
			var _prev = element._prev;
			var _next = element._next;
			_prev._next = _next;
			_next._prev = _prev;
			element._prev = element;
			element._next = element;
		}

		// --------------------------------------------------------------------------------
		// エレメント未使用リストに登録（内部用）
		// --------------------------------------------------------------------------------
		function ElementAttachRestList(element){
			ElementRemove(element);
			var _prev = _rest_list;
			var _next = _prev._next;
			_prev._next = element;
			_next._prev = element;
			element._prev = _prev;
			element._next = _next;
			element._use = false;
		}

		// --------------------------------------------------------------------------------
		// エレメント使用リストに登録（内部用）
		// --------------------------------------------------------------------------------
		function ElementAttachUseList(element){
			ElementRemove(element);
			var _prev = _use_list;
			var _next = _prev._next;
			_prev._next = element;
			_next._prev = element;
			element._prev = _prev;
			element._next = _next;
			element._use = true;
		}

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _use_list;
		var _rest_list;
		var _count;
		var _use_count;
		var _byte_size_now;
		var _byte_size_max;
		var _enable_unload;
		var _limit;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_use_list = new Object();
			_rest_list = new Object();
			_count = 0;
			_use_count = 0;
			_byte_size_now = 0;
			_byte_size_max = 0;
			_limit = false;

			_use_list._prev = _use_list;
			_use_list._next = _use_list;
			_rest_list._prev = _rest_list;
			_rest_list._next = _rest_list;
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// イベントディスパッチャー
	// --------------------------------------------------------------------------------
	function EventDispatcher(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// イベントハンドラ生成
		// --------------------------------------------------------------------------------
		_container.createEventHandler = function(name){
			var _event_handler = new Object();

			// --------------------------------------------------------------------------------
			// 開放
			// --------------------------------------------------------------------------------
			_event_handler.release = function(){
				var _prev = _event_handler._prev;
				var _next = _event_handler._next;
				_prev._next = _next;
				_next._prev = _prev;
				_event_handler._prev = _event_handler;
				_event_handler._next = _event_handler;
			};

			// --------------------------------------------------------------------------------
			// 関数を登録
			// --------------------------------------------------------------------------------
			_event_handler.setFunction = function(func){
				_event_handler._func = func;
			};

			// --------------------------------------------------------------------------------
			// 初期化
			// --------------------------------------------------------------------------------
			(function(){
				_event_handler._func = null;
				_event_handler._prev = _event_handler;
				_event_handler._next = _event_handler;

				var list = _dictionary[name];
				if(!list){
					list = new Object();
					list._prev = list;
					list._next = list;
					_dictionary[name] = list;
				}

				var _next = list;
				var _prev = _next._prev;
				_prev._next = _event_handler;
				_next._prev = _event_handler;
				_event_handler._prev = _prev;
				_event_handler._next = _next;
			})();

			return _event_handler;
		};

		// --------------------------------------------------------------------------------
		// 発火
		// --------------------------------------------------------------------------------
		_container.dispatchEvent = function(name,param){
			var list = _dictionary[name];
			if(!list)	return;

			var a = new Array();
			var handler = list._next;
			while(list != handler){
				a.push(handler);
				handler = handler._next;
			}

			var i;
			var num = a.length;
			for(i=0;i<num;i++){
				var handler = a[i];
				if(handler._func){
					handler._func(param);
				}
			}
		};

		// --------------------------------------------------------------------------------
		// すべてのイベントハンドラを外す
		// --------------------------------------------------------------------------------
		_container.removeAll = function(){
			for(var p in _dictionary){
				var list = _dictionary[p];
				while(true){
					var handler = list._next;
					if(list == handler)	break;
					handler.release();
				}
			}
		};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _dictionary;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_dictionary = new Object();
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// スクロール補正
	// --------------------------------------------------------------------------------
	function DocumentReviseScroll(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// エレメントの挿入直前に実行
		// --------------------------------------------------------------------------------
		_container.executeAttachElementBefore = function(element){
			update();
		};

		// --------------------------------------------------------------------------------
		// エレメントの挿入直後に実行
		// --------------------------------------------------------------------------------
		_container.executeAttachElementAfter = function(element){
			var bounding_size = ElementGetBoundingClientRect(element);
			_enable_revise_x = (bounding_size.right  < 0) ? true : false;
			_enable_revise_y = (bounding_size.bottom < 0) ? true : false;
			revise();
		};

		// --------------------------------------------------------------------------------
		// エレメントのリムーブ直前に実行
		// --------------------------------------------------------------------------------
		_container.executeRemoveElementBefore = function(element){
			var bounding_size = ElementGetBoundingClientRect(element);
			_enable_revise_x = (bounding_size.right  < 0) ? true : false;
			_enable_revise_y = (bounding_size.bottom < 0) ? true : false;
			update();
		};

		// --------------------------------------------------------------------------------
		// エレメントのリムーブ直後に実行
		// --------------------------------------------------------------------------------
		_container.executeRemoveElementAfter = function(element){
			revise();
		};

		// --------------------------------------------------------------------------------
		// 更新
		// --------------------------------------------------------------------------------
		function update(){
			_scroll_pos = DocumentGetScrollPos();
			_document_size = DocumentGetSize();
		}

		// --------------------------------------------------------------------------------
		// 補正
		// --------------------------------------------------------------------------------
		function revise(){
		}

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _scroll_pos;
		var _document_size;
		var _enable_revise_x;
		var _enable_revise_y;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_enable_revise_x = false;
			_enable_revise_y = false;
			update();
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// マウス入力
	// --------------------------------------------------------------------------------
	function InputMouse(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// マウスイベントをセット
		// --------------------------------------------------------------------------------
		_container.setMouseEvent = function(e){
			mouse_move_func(e);
		};

		// --------------------------------------------------------------------------------
		// 座標を取得
		// --------------------------------------------------------------------------------
		_container.getPositionClient = function(){
			return _pos_client;
		};

		// --------------------------------------------------------------------------------
		// ボタンの押下状態を取得
		// --------------------------------------------------------------------------------
		_container.getButtonLeft = function(){
			return _button;
		};

		// --------------------------------------------------------------------------------
		// シフトキーの押下状態を取得
		// --------------------------------------------------------------------------------
		_container.getKeyShift = function(){
			return _key_shift;
		};

		// --------------------------------------------------------------------------------
		// マウス入力移動（内部用）
		// --------------------------------------------------------------------------------
		function mouse_input_func(e){
			if(e.buttons !== undefined){
				_button = (e.buttons > 0);
			}
			_pos_client.x = e.clientX;
			_pos_client.y = e.clientY;
			_key_shift = e.shiftKey;
		}

		// --------------------------------------------------------------------------------
		// マウス移動（内部用）
		// --------------------------------------------------------------------------------
		function mouse_move_func(e){
			mouse_input_func(e);
		}

		// --------------------------------------------------------------------------------
		// マウスボタンダウン（内部用）
		// --------------------------------------------------------------------------------
		function mouse_down_func(e){
			var enable = false;


			if(enable){
				_button = true;
			}
			mouse_input_func(e);
		}

		// --------------------------------------------------------------------------------
		// マウスボタンアップ（内部用）
		// --------------------------------------------------------------------------------
		function mouse_up_func(e){
			_button = false;
			mouse_input_func(e);
		}

		// --------------------------------------------------------------------------------
		// 非アクティブ（内部用）
		// --------------------------------------------------------------------------------
		function blur_func(e){
			_button = false;
			_key_shift = false;
		}

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _pos_client;
		var _button;
		var _key_shift;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_pos_client = new Object();
			_pos_client.x = 0;
			_pos_client.y = 0;
			_button = false;

			if(document.addEventListener){
				document.addEventListener("mousemove",mouse_move_func,true);
				document.addEventListener("mousedown",mouse_down_func,true);
				document.addEventListener("mouseup",mouse_up_func,true);
				window.addEventListener("blur",blur_func);
			}else if(document.attachEvent){
				document.attachEvent("onmousemove",mouse_move_func);
				document.attachEvent("onmousedown",mouse_down_func);
				document.attachEvent("onmouseup",mouse_up_func);
				window.attachEvent("onblur",blur_func);
			}
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// URLキャッシュ辞書
	// --------------------------------------------------------------------------------
	function UrlCacheDictionary(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// オブジェクトを取得
		// --------------------------------------------------------------------------------
		_container.getObject = function(url){
			var obj = _dictionary[url];
			if(obj){
				var prev = obj.prev;
				var next = obj.next;
				prev.next = next;
				next.prev = prev;
				prev = _queue;
				prev = prev.next;
				prev.next = obj;
				next.prev = obj;
				obj.prev = prev;
				obj.next = next;
				return obj;
			}

			obj = new Object();
			obj.url = url;
			var prev = _queue;
			var next = prev.next;
			prev.next = obj;
			next.prev = obj;
			obj.prev = prev;
			obj.next = next;

			_queue_count ++;
			_dictionary[url] = obj;

			if(_queue_count >= _queue_max){
				var o = _queue.prev;
				prev = o.prev;
				next = o.next;
				prev.next = next;
				next.prev = prev;

				_queue_count --;
				delete _dictionary[o.url];
			}

			return obj;
		};

		// --------------------------------------------------------------------------------
		// キャッシュの最大数をセット
		// --------------------------------------------------------------------------------
		_container.setCacheMax = function(v){
			_queue_max = v;
		};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _dictionary;
		var _queue;
		var _queue_count;
		var _queue_max;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_dictionary = new Object();
			_queue = new Object();
			_queue.prev = _queue;
			_queue.next = _queue;

			_queue_count = 0;
			_queue_max = 16;
		})();

		return _container;
	}



	// --------------------------------------------------------------------------------
	// Opera 拡張機能 から PageExpandConfig を開く
	// --------------------------------------------------------------------------------
	function OperaExtensionOpenPageExpandConfig(query){

		var current_url = "options.html";
		var url = current_url;

		if(query){
			var query_count = 0;
			for(var name in query){
				if(query_count == 0){
					url += "?" + name + "=" + query[name];
				}else{
					url += "&" + name + "=" + query[name];
				}
				query_count += 1;
			}
		}

		// 新規
		opera.extension.tabs.create({
			url: url,
			focused: true
		});
	}


	// --------------------------------------------------------------------------------
	// Opera拡張機能 選択中のタブを取得
	// --------------------------------------------------------------------------------
	function OperaExtensionGetSelectedTab(){

		var tab;
		try{
			if(!tab){
				tab = opera.extension.tabs.getFocused();
			}
		}catch(e){}
		try{
			if(!tab){
				tab = opera.extension.tabs.getSelected();
			}
		}catch(e){}

		return tab;
	}



	// --------------------------------------------------------------------------------
	// Opera拡張機能通信 コンテンツ用
	// --------------------------------------------------------------------------------
	function OperaExtensionMessageForContent(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// リスナーをセット
		// --------------------------------------------------------------------------------
		_container.addListener = function(f){

			// イベントハンドラを作成
			var event_handler = _event_dispatcher.createEventHandler("message");
			event_handler.setFunction(function(event){
				var request = event.data;
				f(request.data,event.source,function(response){
					var receive = new Object();
					receive.type = "receive";
					receive.id = request.id;
					receive.data = response;

					// 返信
					event.source.postMessage(receive);
				});
			});
		};

		// --------------------------------------------------------------------------------
		// リクエストを送信
		// --------------------------------------------------------------------------------
		_container.sendRequest = function(data,callback){

			var request = new Object();
			request.type = "request";
			request.id = _unique;
			request.data = data;

			// コールバック関数を辞書に登録
			if(callback){
				_callback_dictionary[_unique] = callback;
				_unique ++;
			}

			// メッセージを送信
			opera.extension.postMessage(request);
		};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _unique;
		var _callback_dictionary;
		var _event_dispatcher;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_unique = 0;
			_callback_dictionary = new Array();
			_event_dispatcher = new EventDispatcher();

			// メッセージを受信する
			opera.extension.addEventListener('message',function(e){

				var request = e.data;

				switch(request.type){
				// リクエストを受信
				case "request":
					// イベントを発火
					_event_dispatcher.dispatchEvent("message",e);
					break;

				// 返信を受信
				case "receive":
					var callback = _callback_dictionary[request.id];

					// コールバック関数を実行
					if(callback){
						callback(request.data);
					}

					// 辞書から外す
					delete _callback_dictionary[request.id];
					break;
				}

			},false);

		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// Opera拡張機能通信 バックグラウンド用
	// --------------------------------------------------------------------------------
	function OperaExtensionMessageForBackground(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// リスナーをセット
		// --------------------------------------------------------------------------------
		_container.addListener = function(f){

			// イベントハンドラを作成
			var event_handler = _event_dispatcher.createEventHandler("message");
			event_handler.setFunction(function(event){
				var request = event.data;
				f(request.data,event.source,function(response){
					var receive = new Object();
					receive.type = "receive";
					receive.id = request.id;
					receive.data = response;

					// 返信
					event.source.postMessage(receive);
				});
			});
		};

		// --------------------------------------------------------------------------------
		// リクエストを送信
		// --------------------------------------------------------------------------------
		_container.sendRequestToContent = function(tab,data,callback){

			var request = new Object();
			request.type = "request";
			request.id = _unique;
			request.data = data;

			// コールバック関数を辞書に登録
			if(callback){
				_callback_dictionary[_unique] = callback;
				_unique ++;
			}

			// メッセージを送信
			tab.postMessage(request);
		};

		// --------------------------------------------------------------------------------
		// リクエストを送信
		// --------------------------------------------------------------------------------
		_container.sendRequestToBackground = function(data,callback){

			var request = new Object();
			request.type = "request";
			request.id = _unique;
			request.data = data;

			// コールバック関数を辞書に登録
			if(callback){
				_callback_dictionary[_unique] = callback;
				_unique ++;
			}

			// メッセージを送信
			opera.extension.postMessage(request);
		};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _unique;
		var _callback_dictionary;
		var _event_dispatcher;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_unique = 0;
			_callback_dictionary = new Array();
			_event_dispatcher = new EventDispatcher();

			// メッセージを受信する
			opera.extension.addEventListener('message',function(e){

				var request = e.data;

				switch(request.type){
				// リクエストを受信
				case "request":
					// イベントを発火
					_event_dispatcher.dispatchEvent("message",e);
					break;

				// 返信を受信
				case "receive":
					var callback = _callback_dictionary[request.id];

					// コールバック関数を実行
					if(callback){
						callback(request.data);
					}

					// 辞書から外す
					delete _callback_dictionary[request.id];
					break;
				}

			},false);

		})();

		return _container;
	}


	// --------------------------------------------------------------------------------
	// 要素管理
	// --------------------------------------------------------------------------------
	function ElementAnalyzeManager(element,outsider){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// 解放
		// --------------------------------------------------------------------------------
		_container.release = function(){
			if(!_element)	return;

			// リムーブ監視を破棄
			if(_observer_remove){
				_observer_remove.release();
				_observer_remove = null;
			}

			// 解析辞書除外
			analyze_work_dictionary.removeAnalyzeWork(_analyze_work);

			DomNodeRemove(_element);
			_element = null;
		};

		// --------------------------------------------------------------------------------
		// 解析
		// --------------------------------------------------------------------------------
		_container.analyze = function(){
			// 解析有効化
			AnalyzeWorkClearInvalid(_analyze_work);

			// 解析開始
			execute_queue.attachLastForInsertDomNode(DomNodeAnalyzeRoot,_element);
		};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _element;
		var _analyze_work;
		var _observer_remove;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_element = element;
			element = null;

			// リムーブ監視
			_observer_remove = new DomNodeObserverRemoveFromDocument(_element);
			_observer_remove.setFunction(_container.release);

			// 解析ワーク
			_analyze_work = analyze_work_dictionary.getAnalyzeWork(_element);
			if(_analyze_work){
			}else{
				// 解析ワーク作成
				_analyze_work = AnalyzeWorkCreate(_element);
			}

			// 解析辞書登録
			analyze_work_dictionary.attachAnalyzeWork(_analyze_work,outsider);

			// 解析無効化
			AnalyzeWorkSetInvalid(_analyze_work);
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// 解析ワーク作成
	// --------------------------------------------------------------------------------
	function AnalyzeWorkCreate(node){
		return {
			node:node,
			modify:1
		};
	}

	// --------------------------------------------------------------------------------
	// 解析ワークから DOM オブジェクトを取得
	// --------------------------------------------------------------------------------
	function AnalyzeWorkGetDomNode(work){
		return work.node;
	}

	// --------------------------------------------------------------------------------
	// 解析ワークにアンカー要素を登録
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearAnchorElement(work){ ObjectDeleteProperty(work,"anchor"); }
	function AnalyzeWorkSetAnchorElement(work,anchor){ work.anchor = anchor; }
	function AnalyzeWorkGetAnchorElement(work){ return work.anchor; }

	// --------------------------------------------------------------------------------
	// アンカー初期化状況
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearInitializedAnchorElement(work){ ObjectDeleteProperty(work,"i_anc"); }
	function AnalyzeWorkSetInitializedAnchorElement(work){ work.i_anc = true; }
	function AnalyzeWorkGetInitializedAnchorElement(work){ return work.i_anc; }

	// --------------------------------------------------------------------------------
	// アンカーオーバーライド状況
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearOverrodeAnchorElement(work){ ObjectDeleteProperty(work,"o_anc"); }
	function AnalyzeWorkSetOverrodeAnchorElement(work){ work.o_anc = true; }
	function AnalyzeWorkGetOverrodeAnchorElement(work){ return work.o_anc; }

	// --------------------------------------------------------------------------------
	// 「エレメントの置換」の解析状況
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearAnalyzedReplacementToElement(work){ ObjectDeleteProperty(work,"a_rte"); }
	function AnalyzeWorkSetAnalyzedReplacementToElement(work){ work.a_rte = true; }
	function AnalyzeWorkGetAnalyzedReplacementToElement(work){ return work.a_rte; }

	// --------------------------------------------------------------------------------
	// 「テキストの置換」の解析状況
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearAnalyzedReplacementToText(work){ ObjectDeleteProperty(work,"a_rtt"); }
	function AnalyzeWorkSetAnalyzedReplacementToText(work){ work.a_rtt = true; }
	function AnalyzeWorkGetAnalyzedReplacementToText(work){ return work.a_rtt; }

	// --------------------------------------------------------------------------------
	// 「アンカーの置換」の解析状況
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearAnalyzedReplacementToAnchor(work){ ObjectDeleteProperty(work,"a_rta"); }
	function AnalyzeWorkSetAnalyzedReplacementToAnchor(work){ work.a_rta = true; }
	function AnalyzeWorkGetAnalyzedReplacementToAnchor(work){ return work.a_rta; }

	// --------------------------------------------------------------------------------
	// 「ハイパーリンクの置換」の解析状況
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearAnalyzedReplacementToLink(work){ ObjectDeleteProperty(work,"a_rtl"); }
	function AnalyzeWorkSetAnalyzedReplacementToLink(work){ work.a_rtl = true; }
	function AnalyzeWorkGetAnalyzedReplacementToLink(work){ return work.a_rtl; }

	// --------------------------------------------------------------------------------
	// 展開 URL 先を設定
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearExpandUrl(work){ ObjectDeleteProperty(work,"expand_url"); }
	function AnalyzeWorkSetExpandUrl(work,url){ work.expand_url = url; }
	function AnalyzeWorkGetExpandUrl(work){ return work.expand_url; }

	// --------------------------------------------------------------------------------
	// 展開コンテンツタイプを設定
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearExpandContentType(work){ ObjectDeleteProperty(work,"expand_content_type"); }
	function AnalyzeWorkAddContentType(work,type){ if(!(work.expand_content_type)){ work.expand_content_type = new Array(); } work.expand_content_type.push(type); }
	function AnalyzeWorkGetContentType(work){ if(work.expand_content_type){ return work.expand_content_type; } return []; }

	// --------------------------------------------------------------------------------
	// 「ハイパーリンク化の置換」の解析状況
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearAnalyzedMakeLinkToText(work){ ObjectDeleteProperty(work,"a_mlt"); }
	function AnalyzeWorkSetAnalyzedMakeLinkToText(work){ work.a_mlt = true; }
	function AnalyzeWorkGetAnalyzedMakeLinkToText(work){ return work.a_mlt; }

	// --------------------------------------------------------------------------------
	// 「短縮 URL の展開」の解析状況
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearAnalyzedExpandShortUrl(work){ ObjectDeleteProperty(work,"a_esu"); }
	function AnalyzeWorkSetAnalyzedExpandShortUrl(work){ work.a_esu = true; }
	function AnalyzeWorkGetAnalyzedExpandShortUrl(work){ return work.a_esu; }

	// --------------------------------------------------------------------------------
	// 「テキストの展開」の解析状況
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearAnalyzedExpandInlineText(work){ ObjectDeleteProperty(work,"a_eit"); }
	function AnalyzeWorkSetAnalyzedExpandInlineText(work){ work.a_eit = true; }
	function AnalyzeWorkGetAnalyzedExpandInlineText(work){ return work.a_eit; }

	// --------------------------------------------------------------------------------
	// 「イメージのサムネイル展開」の解析状況
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearAnalyzedExpandThumbnailImage(work){ ObjectDeleteProperty(work,"a_eti"); }
	function AnalyzeWorkSetAnalyzedExpandThumbnailImage(work){ work.a_eti = true; }
	function AnalyzeWorkGetAnalyzedExpandThumbnailImage(work){ return work.a_eti; }

	// --------------------------------------------------------------------------------
	// 「イメージのポップアップ展開」の解析状況
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearAnalyzedExpandPopupImage(work){ ObjectDeleteProperty(work,"a_epi"); }
	function AnalyzeWorkSetAnalyzedExpandPopupImage(work){ work.a_epi = true; }
	function AnalyzeWorkGetAnalyzedExpandPopupImage(work){ return work.a_epi; }

	// --------------------------------------------------------------------------------
	// 「ポップアップ」のワーク埋め込み
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearPopupImage(work){ ObjectDeleteProperty(work,"popup_image"); }
	function AnalyzeWorkSetPopupImage(work,obj){ work.popup_image = obj; }
	function AnalyzeWorkGetPopupImage(work){ return work.popup_image; }

	// --------------------------------------------------------------------------------
	// 「サウンドのインライン展開」の解析状況
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearAnalyzedExpandInlineSound(work){ ObjectDeleteProperty(work,"a_eis"); }
	function AnalyzeWorkSetAnalyzedExpandInlineSound(work){ work.a_eis = true; }
	function AnalyzeWorkGetAnalyzedExpandInlineSound(work){ return work.a_eis; }

	// --------------------------------------------------------------------------------
	// 「ビデオのインライン展開」の解析状況
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearAnalyzedExpandInlineVideo(work){ ObjectDeleteProperty(work,"a_eiv"); }
	function AnalyzeWorkSetAnalyzedExpandInlineVideo(work){ work.a_eiv = true; }
	function AnalyzeWorkGetAnalyzedExpandInlineVideo(work){ return work.a_eiv; }

	// --------------------------------------------------------------------------------
	// 「インラインの展開」の解析状況
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearAnalyzedExpandInlineIframe(work){ ObjectDeleteProperty(work,"a_eif"); }
	function AnalyzeWorkSetAnalyzedExpandInlineIframe(work){ work.a_eif = true; }
	function AnalyzeWorkGetAnalyzedExpandInlineIframe(work){ return work.a_eif; }

	// --------------------------------------------------------------------------------
	// 「縮小画像のポップアップ」の解析状況
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearAnalyzedPopupReducedImage(work){ ObjectDeleteProperty(work,"a_pri"); }
	function AnalyzeWorkSetAnalyzedPopupReducedImage(work){ work.a_pri = true; }
	function AnalyzeWorkGetAnalyzedPopupReducedImage(work){ return work.a_pri; }

	// --------------------------------------------------------------------------------
	// 「掲示板拡張」の解析状況
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearAnalyzedExpandBbs(work){ ObjectDeleteProperty(work,"a_ebb"); }
	function AnalyzeWorkSetAnalyzedExpandBbs(work){ work.a_ebb = true; }
	function AnalyzeWorkGetAnalyzedExpandBbs(work){ return work.a_ebb; }

	// --------------------------------------------------------------------------------
	// 解析無効化
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearInvalid(work){ ObjectDeleteProperty(work,"a_inv"); }
	function AnalyzeWorkSetInvalid(work){ work.a_inv = true; }
	function AnalyzeWorkGetInvalid(work){ return work.a_inv; }

	// --------------------------------------------------------------------------------
	// 「修正カウンタ」の解析状況
	// --------------------------------------------------------------------------------
	function AnalyzeWorkInitializeModifyCount(work){ work.modify = 1; }
	function AnalyzeWorkGetModifyCount(work){ return work.modify; }
	function AnalyzeWorkAddModifyCount(work){ work.modify += 1; }
	function AnalyzeWorkEqualModifyCount(work,modify){ if(work.modify){ return (modify == work.modify); } return (modify == 0); }

	// --------------------------------------------------------------------------------
	// イベントディスパッチャーの管理
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearEventDispatcher(work){ ObjectDeleteProperty(work,"event_dispatcher"); }
	function AnalyzeWorkSetEventDispatcher(work,event_dispatcher){ work.event_dispatcher = event_dispatcher; }
	function AnalyzeWorkGetEventDispatcher(work){ return work.event_dispatcher; }

	// --------------------------------------------------------------------------------
	// アンカーモニター要素の管理
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearAnchorMonitorElement(work){ ObjectDeleteProperty(work,"anchor_monitor"); }
	function AnalyzeWorkSetAnchorMonitorElement(work,element){ work.anchor_monitor = element; }
	function AnalyzeWorkGetAnchorMonitorElement(work){ return work.anchor_monitor; }

	// --------------------------------------------------------------------------------
	// 掲示板コントロールの管理
	// --------------------------------------------------------------------------------
	function AnalyzeWorkClearBbsControl(work){ ObjectDeleteProperty(work,"bbs_control"); }
	function AnalyzeWorkSetBbsControl(work,obj){ work.bbs_control = obj; }
	function AnalyzeWorkGetBbsControl(work){ return work.bbs_control; }

	// --------------------------------------------------------------------------------
	// 解析辞書
	// --------------------------------------------------------------------------------
	function AnalyzeWorkDictionary(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// 解析ワークを登録
		// --------------------------------------------------------------------------------
		_container.attachAnalyzeWork = function(work,outsider){
			if(work.id)	return true;

			var node = AnalyzeWorkGetDomNode(work);
			if(node){
				var id = (_identity << 1) | (outsider ? 1:0);
				_dictionary[id] = work;
				_identity += 1;
				work.id = id;
				node._pageexpand_ = id;
				if(node.setAttribute){
					node.setAttribute("_pageexpand_",id);
				}
				return true;
			}

			return false;
		};

		// --------------------------------------------------------------------------------
		// 解析ワークを除外
		// --------------------------------------------------------------------------------
		_container.removeAnalyzeWork = function(work){
			var id = work.id;
			if(!id)	return false;

			try{
				ObjectDeleteProperty(_dictionary,id);
				ObjectDeleteProperty(work,"id");
			}catch(e){}
		};

		// --------------------------------------------------------------------------------
		// エレメントからオブジェクトを取得
		// --------------------------------------------------------------------------------
		_container.getAnalyzeWork = function(node){
			var id;
			id = node._pageexpand_;
			if(id){
				var work = _dictionary[parseInt(id)];
				if(work){
					if(AnalyzeWorkGetDomNode(work) == node){
						return work;
					}
				}
			}
			return null;
		};

		// --------------------------------------------------------------------------------
		// クローンであるか確認する
		// --------------------------------------------------------------------------------
		_container.verifyClone = function(node){
			if(node.getAttribute){
				var id = node.getAttribute("_pageexpand_");
				if(id){
					var id = parseInt(id);
					if(id & 0x00000001){
						var work = _dictionary[id];
						if(!work)	return true;
						if(AnalyzeWorkGetDomNode(work) != node){
							return true;
						}
					}
				}
			}

			return false;
		};

		// --------------------------------------------------------------------------------
		// 解放後の要素であるか確認する
		// --------------------------------------------------------------------------------
		_container.verifyRemoved = function(node){
			if(node.getAttribute){
				var id = node.getAttribute("_pageexpand_");
				if(id){
					var id = parseInt(id);
					var work = _dictionary[id];
					if(!work)	return true;
					if(AnalyzeWorkGetDomNode(work) != node){
						return true;
					}
				}
			}

			return false;
		};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _identity;
		var _dictionary;


		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_identity = 1;
			_dictionary = new Array();
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// 掲示板辞書
	// --------------------------------------------------------------------------------
	function BbsDictionary(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// フォロー生成
		// --------------------------------------------------------------------------------
		function createFollow(follower_response,following_response){
			var _follow = new Object();

			// --------------------------------------------------------------------------------
			// 開放
			// --------------------------------------------------------------------------------
			_follow.release = function(){
				var _follower_prev = _follow._follower_prev;
				var _follower_next = _follow._follower_next;
				_follower_prev._follower_next = _follower_next;
				_follower_next._follower_prev = _follower_prev;
				_follow._follower_prev = _follow;
				_follow._follower_next = _follow;

				var _following_prev = _follow._following_prev;
				var _following_next = _follow._following_next;
				_following_prev._following_next = _following_next;
				_following_next._following_prev = _following_prev;
				_follow._following_prev = _follow;
				_follow._following_next = _follow;

				var following = _follow.getResponseFollowing();
				if(following){
					following.addCountFollower(-1);
				}
			};

			// --------------------------------------------------------------------------------
			// フォロワーレスポンスを取得
			// --------------------------------------------------------------------------------
			_follow.getResponseFollower = function(){
				return follower_response;
			};

			// --------------------------------------------------------------------------------
			// フォローイングレスポンスを取得
			// --------------------------------------------------------------------------------
			_follow.getResponseFollowing = function(){
				return following_response;
			};

			// --------------------------------------------------------------------------------
			// 初期化
			// --------------------------------------------------------------------------------
			(function(){
				_follow._follower_prev = _follow;
				_follow._follower_next = _follow;
				_follow._following_prev = _follow;
				_follow._following_next = _follow;
			})();

			return _follow;
		}

		// --------------------------------------------------------------------------------
		// レスポンス生成
		// --------------------------------------------------------------------------------
		function createResponse(number){
			var _response = new Object();

			// --------------------------------------------------------------------------------
			// 開放
			// --------------------------------------------------------------------------------
			_response.release = function(obj){
				if(_released)	return;
				_released = true;

				release();

				_analyzed = false;

				// フォロワーを開放
				var follow = _response._follow;
				while(true){
					var follower = follow._follower_next;
					if(follow == follower)	break;
					follower.release();
				}

				// イベント解放
				if(_event_dispatcher){
					_event_dispatcher.removeAll();
					_event_dispatcher = null;
				}

				// 番号を破棄
				delete _number_dictionary[number];
			};

			// --------------------------------------------------------------------------------
			// レスポンスを消去
			// --------------------------------------------------------------------------------
			_response.erase = function(){

				// 消去イベント実行
				if(_response.onerase){
					_response.onerase();
				}

				release();
			};

			// --------------------------------------------------------------------------------
			// 開放（内部用）
			// --------------------------------------------------------------------------------
			function release(){

				// イベントを外す
				removeEventRelease();

				// オリジナルエレメントをクリア
				_response.clearOriginalElements();

				// フォローイングをクリア
				_response.clearFollowing();

				// ID を開放
				removeId();

				// 名前を開放
				removeName();

				// ホストを開放
				removeHost();

				// イベント発火
				_event_dispatcher.dispatchEvent("release",null);
			}

			// --------------------------------------------------------------------------------
			// リリースイベントを追加（内部用）
			// --------------------------------------------------------------------------------
			function addEventRelease(){
				removeEventRelease();

				var i;
				var num = _elements_original.length;
				for(i=0;i<num;i++){
					if(!_observer_remove[i]){
						var obj = _elements_original[i];
						_observer_remove[i] = new DomNodeObserverRemoveFromDocument(obj.element);
						_observer_remove[i].setFunction(_response.release);
					}
				}
			}

			// --------------------------------------------------------------------------------
			// リリースイベントを外す（内部用）
			// --------------------------------------------------------------------------------
			function removeEventRelease(){
				var i;
				var num = _elements_original.length;
				for(i=0;i<num;i++){
					if(_observer_remove[i]){
						var obj = _elements_original[i];
						// 監視を破棄
						_observer_remove[i].release();
						_observer_remove[i] = null;
					}
				}
			}

			// --------------------------------------------------------------------------------
			// 番号を取得
			// --------------------------------------------------------------------------------
			_response.getNumber = function(){
				return number;
			};

			// --------------------------------------------------------------------------------
			// ID を登録（内部用）
			// --------------------------------------------------------------------------------
			function attachId(id){
				removeId();

				var id_list = _id_dictionary[id];
				if(!id_list){
					id_list = new Object();
					id_list._id_prev = id_list;
					id_list._id_next = id_list;
					_id_dictionary[id] = id_list;
				}

				var list = id_list._id_prev;
				while(list != id_list){
					if(_response.getNumber() >= list.getNumber()){
						break;
					}
					list = list._id_prev;
				}

				var _id_prev = list;
				var _id_next = _id_prev._id_next;
				_id_prev._id_next = _response;
				_id_next._id_prev = _response;
				_response._id_prev = _id_prev;
				_response._id_next = _id_next;

				// カウンタ
				addCountId(id,1);
				_id = id;
			}

			// --------------------------------------------------------------------------------
			// ID の登録を外す（内部用）
			// --------------------------------------------------------------------------------
			function removeId(){
				if(_response != _response._id_next){
					// カウンタ
					addCountId(_id,-1);
				}

				var _id_prev = _response._id_prev;
				var _id_next = _response._id_next;
				_id_prev._id_next = _id_next;
				_id_next._id_prev = _id_prev;
				_response._id_prev = _response;
				_response._id_next = _response;
			}

			// --------------------------------------------------------------------------------
			// ID を取得
			// --------------------------------------------------------------------------------
			_response.getId = function(){
				return _id;
			};

			// --------------------------------------------------------------------------------
			// ID をセット
			// --------------------------------------------------------------------------------
			_response.setId = function(id){
				attachId(id);
			};

			// --------------------------------------------------------------------------------
			// 名前を登録（内部用）
			// --------------------------------------------------------------------------------
			function attachName(name){
				removeName();

				var name_list = _name_dictionary[name];
				if(!name_list){
					name_list = new Object();
					name_list._name_prev = name_list;
					name_list._name_next = name_list;
					_name_dictionary[name] = name_list;
				}

				var list = name_list._name_prev;
				while(list != name_list){
					if(_response.getNumber() >= list.getNumber()){
						break;
					}
					list = list._name_prev;
				}

				var _name_prev = list;
				var _name_next = _name_prev._name_next;
				_name_prev._name_next = _response;
				_name_next._name_prev = _response;
				_response._name_prev = _name_prev;
				_response._name_next = _name_next;

				// カウンタ
				addCountName(name,1);
				_name = name;
			}

			// --------------------------------------------------------------------------------
			// 名前の登録を外す（内部用）
			// --------------------------------------------------------------------------------
			function removeName(){
				if(_response != _response._name_next){
					// カウンタ
					addCountName(_name,-1);
				}

				var _name_prev = _response._name_prev;
				var _name_next = _response._name_next;
				_name_prev._name_next = _name_next;
				_name_next._name_prev = _name_prev;
				_response._name_prev = _response;
				_response._name_next = _response;
			}

			// --------------------------------------------------------------------------------
			// 名前を取得
			// --------------------------------------------------------------------------------
			_response.getName = function(){
				return _name;
			};

			// --------------------------------------------------------------------------------
			// 名前をセット
			// --------------------------------------------------------------------------------
			_response.setName = function(name){
				attachName(name);
			};

			// --------------------------------------------------------------------------------
			// ホストを登録（内部用）
			// --------------------------------------------------------------------------------
			function attachHost(host){
				removeHost();

				var host_list = _host_dictionary[host];
				if(!host_list){
					host_list = new Object();
					host_list._host_prev = host_list;
					host_list._host_next = host_list;
					_host_dictionary[host] = host_list;
				}

				var list = host_list._host_prev;
				while(list != host_list){
					if(_response.getNumber() >= list.getNumber()){
						break;
					}
					list = list._host_prev;
				}

				var _host_prev = list;
				var _host_next = _host_prev._host_next;
				_host_prev._host_next = _response;
				_host_next._host_prev = _response;
				_response._host_prev = _host_prev;
				_response._host_next = _host_next;

				// カウンタ
				addCountHost(host,1);
				_host = host;
			}

			// --------------------------------------------------------------------------------
			// ホストの登録を外す（内部用）
			// --------------------------------------------------------------------------------
			function removeHost(){
				if(_response != _response._host_next){
					// カウンタ
					addCountHost(_host,-1);
				}

				var _host_prev = _response._host_prev;
				var _host_next = _response._host_next;
				_host_prev._host_next = _host_next;
				_host_next._host_prev = _host_prev;
				_response._host_prev = _response;
				_response._host_next = _response;
			}

			// --------------------------------------------------------------------------------
			// ホストを取得
			// --------------------------------------------------------------------------------
			_response.getHost = function(){
				return _host;
			};

			// --------------------------------------------------------------------------------
			// ホストをセット
			// --------------------------------------------------------------------------------
			_response.setHost = function(host){
				attachHost(host);
			};

			// --------------------------------------------------------------------------------
			// 解析済みクリア
			// --------------------------------------------------------------------------------
			_response.clearAnalyzed = function(){
				_analyzed = false;;
			};

			// --------------------------------------------------------------------------------
			// 解析済みか調べる
			// --------------------------------------------------------------------------------
			_response.getAnalyzed = function(){
				return _analyzed;
			};

			// --------------------------------------------------------------------------------
			// 解析済みをセット
			// --------------------------------------------------------------------------------
			_response.setAnalyzed = function(){
				_analyzed = true;
			};

			// --------------------------------------------------------------------------------
			// オリジナルエレメントをクリア
			// --------------------------------------------------------------------------------
			_response.clearOriginalElements = function(){

				// イベントを外す
				removeEventRelease();

				var i;
				var num = _elements_original_work.length;
				for(i=0;i<num;i++){
					// 解析クリア
					AnalyzeWorkClearAnalyzedExpandBbs(_elements_original_work[i]);
					// 解析辞書除外
					analyze_work_dictionary.removeAnalyzeWork(_elements_original_work[i]);
				}

				_elements_original.length = 0;
				_elements_clone.length = 0;
				_elements_original_work.length = 0;
			};

			// --------------------------------------------------------------------------------
			// オリジナルエレメントを取得
			// --------------------------------------------------------------------------------
			_response.getOriginalElements = function(){
				return _elements_original;
			};

			// --------------------------------------------------------------------------------
			// オリジナルエレメントをセット
			// --------------------------------------------------------------------------------
			_response.addOriginalElements = function(name,element){
				_elements_original.push({name:name,element:element});

				// 解析ワーク
				var analyze_work = analyze_work_dictionary.getAnalyzeWork(element);
				if(analyze_work){
				}else{
					// 解析ワーク作成
					analyze_work = AnalyzeWorkCreate(element);
				}
				_elements_original_work.push(analyze_work);

				// 解析辞書登録
				analyze_work_dictionary.attachAnalyzeWork(analyze_work,false);

				// 解析済み
				AnalyzeWorkSetAnalyzedExpandBbs(analyze_work);

				// 複製して保有
				_elements_clone.push({name:name,element:ElementCloneNode(element,true)});

				// リリースイベント
				addEventRelease();
			};

			// --------------------------------------------------------------------------------
			// 複製エレメントを取得
			// --------------------------------------------------------------------------------
			_response.getCloneElements = function(){
				var ary = new Array();

				var i;
				var num = _elements_clone.length;
				for(i=0;i<num;i++){
					var obj = _elements_clone[i];
					ary.push({name:obj.name,element:ElementCloneNode(obj.element,true)});
				}
				return ary;
			};

			// --------------------------------------------------------------------------------
			// フォローイングをクリア
			// --------------------------------------------------------------------------------
			_response.clearFollowing = function(){
				var follow = _response._follow;
				while(true){
					var following = follow._following_next;
					if(follow == following)	break;
					following.release();
				}
			};

			// --------------------------------------------------------------------------------
			// フォロワーカウント数取得
			// --------------------------------------------------------------------------------
			_response.getCountFollower = function(){
				return _follower_count;
			};

			// --------------------------------------------------------------------------------
			// フォロワーカウント数加算
			// --------------------------------------------------------------------------------
			_response.addCountFollower = function(v){
				_follower_count += v;
				// イベント発火
				var event_dispatcher = _follower_counter_event_dictionary[number];
				if(event_dispatcher){
					event_dispatcher.dispatchEvent("update",_follower_count);
				}
			};

			// --------------------------------------------------------------------------------
			// フォロワー取得
			// --------------------------------------------------------------------------------
			_response.getFollower = function(){
				var ary = new Array();

				var follow = _response._follow._follower_next;
				while(follow != _response._follow){
					ary.push(follow.getResponseFollower());
					follow = follow._follower_next;
				}
				return ary;
			};

			// --------------------------------------------------------------------------------
			// フォロワーを加算
			// --------------------------------------------------------------------------------
			_response.addFollower = function(target){

				var follow = createFollow(target,_response);
				var _prev;
				var _next;

				var list = _response._follow._follower_prev;
				while(list != _response._follow){
					if(target.getNumber() >= list.getResponseFollower().getNumber()){
						break;
					}
					list = list._follower_prev;
				}

				_prev = list;
				_next = _prev._follower_next;
				_prev._follower_next = follow;
				_next._follower_prev = follow;
				follow._follower_prev = _prev;
				follow._follower_next = _next;

				_prev = target._follow._following_prev;
				_next = _prev._following_next;
				_prev._following_next = follow;
				_next._following_prev = follow;
				follow._following_prev = _prev;
				follow._following_next = _next;

				_response.addCountFollower(1);
			};

			// --------------------------------------------------------------------------------
			// イベントディスパッチャーを取得
			// --------------------------------------------------------------------------------
			_response.getEventDispatcher = function(){
				return _event_dispatcher;
			};

			// --------------------------------------------------------------------------------
			// 消去イベント
			// --------------------------------------------------------------------------------
			_response.onerase = function(){};

			// --------------------------------------------------------------------------------
			// プライベート変数
			// --------------------------------------------------------------------------------
			var _id;
			var _name;
			var _host;
			var _analyzed;
			var _released;
			var _elements_original;
			var _elements_original_work;
			var _elements_clone;
			var _follower_count;
			var _observer_remove;
			var _event_dispatcher;

			// --------------------------------------------------------------------------------
			// 初期化
			// --------------------------------------------------------------------------------
			(function(){
				_id = null;
				_name = null;
				_host = null;
				_analyzed = false;
				_released = false;
				_elements_original = new Array();
				_elements_original_work = new Array();
				_elements_clone = new Array();
				_follower_count = 0;
				_response._follow = createFollow(null,null);
				_response._id_prev = _response;
				_response._id_next = _response;
				_response._name_prev = _response;
				_response._name_next = _response;
				_response._host_prev = _response;
				_response._host_next = _response;
				_observer_remove = new Array();
				_event_dispatcher = new EventDispatcher();
			})();

			return _response;
		}

		// --------------------------------------------------------------------------------
		// 番号からレスポンスが存在するか調べる
		// --------------------------------------------------------------------------------
		_container.getExist = function(number){
			if(_number_dictionary[number]){
				return true;
			}
			return false;
		};

		// --------------------------------------------------------------------------------
		// 番号からレスポンスを取得
		// --------------------------------------------------------------------------------
		_container.getResponse = function(number){
			var response = _number_dictionary[number];
			if(!response){
				response = createResponse(number);
				_number_dictionary[number] = response;
			}
			
			return response;
		};

		// --------------------------------------------------------------------------------
		// ID からレスポンスを取得
		// --------------------------------------------------------------------------------
		_container.getResponsesFromId = function(id){
			var ary = new Array();
			var id_list = _id_dictionary[id];
			if(id_list){
				var list = id_list._id_next;
				while(list != id_list){
					ary.push(list);
					list = list._id_next;
				}
			}
			return ary;
		};

		// --------------------------------------------------------------------------------
		// 名前からレスポンスを取得
		// --------------------------------------------------------------------------------
		_container.getResponsesFromName = function(name){
			var ary = new Array();
			var name_list = _name_dictionary[name];
			if(name_list){
				var list = name_list._name_next;
				while(list != name_list){
					ary.push(list);
					list = list._name_next;
				}
			}
			return ary;
		};

		// --------------------------------------------------------------------------------
		// ホストからレスポンスを取得
		// --------------------------------------------------------------------------------
		_container.getResponsesFromHost = function(host){
			var ary = new Array();
			var host_list = _host_dictionary[host];
			if(host_list){
				var list = host_list._host_next;
				while(list != host_list){
					ary.push(list);
					list = list._host_next;
				}
			}
			return ary;
		};

		// --------------------------------------------------------------------------------
		// ID カウント用のイベントハンドラを生成
		// --------------------------------------------------------------------------------
		_container.createEventHandlerForIdCounter = function(id){
			var event_dispatcher = _id_counter_event_dictionary[id];
			if(!event_dispatcher){
				event_dispatcher = new EventDispatcher();
				_id_counter_event_dictionary[id] = event_dispatcher;
			}
			return event_dispatcher.createEventHandler("update");
		};

		// --------------------------------------------------------------------------------
		// 名前カウント用のイベントハンドラを生成
		// --------------------------------------------------------------------------------
		_container.createEventHandlerForNameCounter = function(name){
			var event_dispatcher = _name_counter_event_dictionary[name];
			if(!event_dispatcher){
				event_dispatcher = new EventDispatcher();
				_name_counter_event_dictionary[name] = event_dispatcher;
			}
			return event_dispatcher.createEventHandler("update");
		};

		// --------------------------------------------------------------------------------
		// ホストカウント用のイベントハンドラを生成
		// --------------------------------------------------------------------------------
		_container.createEventHandlerForHostCounter = function(host){
			var event_dispatcher = _host_counter_event_dictionary[host];
			if(!event_dispatcher){
				event_dispatcher = new EventDispatcher();
				_host_counter_event_dictionary[host] = event_dispatcher;
			}
			return event_dispatcher.createEventHandler("update");
		};

		// --------------------------------------------------------------------------------
		// フォロワーカウント用のイベントハンドラを生成
		// --------------------------------------------------------------------------------
		_container.createEventHandlerForFollowerCounter = function(number){
			var event_dispatcher = _follower_counter_event_dictionary[number];
			if(!event_dispatcher){
				event_dispatcher = new EventDispatcher();
				_follower_counter_event_dictionary[number] = event_dispatcher;
			}
			return event_dispatcher.createEventHandler("update");
		};

		// --------------------------------------------------------------------------------
		// IDカウント数取得
		// --------------------------------------------------------------------------------
		_container.getCountId = function(id){
			if(_id_counter_dictionary[id])	return _id_counter_dictionary[id];
			return 0;
		};

		// --------------------------------------------------------------------------------
		// IDカウント数加算（内部用）
		// --------------------------------------------------------------------------------
		function addCountId(id,v){
			if(!_id_counter_dictionary[id]){
				_id_counter_dictionary[id] = 0;
			}
			_id_counter_dictionary[id] += v;

			// イベント発火
			var event_dispatcher = _id_counter_event_dictionary[id];
			if(event_dispatcher){
				event_dispatcher.dispatchEvent("update",_id_counter_dictionary[id]);
			}
		}

		// --------------------------------------------------------------------------------
		// 名前カウント数取得
		// --------------------------------------------------------------------------------
		_container.getCountName = function(name){
			if(_name_counter_dictionary[name])	return _name_counter_dictionary[name];
			return 0;
		};

		// --------------------------------------------------------------------------------
		// 名前カウント数加算（内部用）
		// --------------------------------------------------------------------------------
		function addCountName(name,v){
			if(!_name_counter_dictionary[name]){
				_name_counter_dictionary[name] = 0;
			}
			_name_counter_dictionary[name] += v;

			// イベント発火
			var event_dispatcher = _name_counter_event_dictionary[name];
			if(event_dispatcher){
				event_dispatcher.dispatchEvent("update",_name_counter_dictionary[name]);
			}
		}

		// --------------------------------------------------------------------------------
		// ホストカウント数取得
		// --------------------------------------------------------------------------------
		_container.getCountHost = function(host){
			if(_host_counter_dictionary[host])	return _host_counter_dictionary[host];
			return 0;
		};

		// --------------------------------------------------------------------------------
		// ホストカウント数加算（内部用）
		// --------------------------------------------------------------------------------
		function addCountHost(host,v){
			if(!_host_counter_dictionary[host]){
				_host_counter_dictionary[host] = 0;
			}
			_host_counter_dictionary[host] += v;

			// イベント発火
			var event_dispatcher = _host_counter_event_dictionary[host];
			if(event_dispatcher){
				event_dispatcher.dispatchEvent("update",_host_counter_dictionary[host]);
			}
		}

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _number_dictionary;
		var _id_dictionary;
		var _id_counter_dictionary;
		var _id_counter_event_dictionary;
		var _name_dictionary;
		var _name_counter_dictionary;
		var _name_counter_event_dictionary;
		var _host_dictionary;
		var _host_counter_dictionary;
		var _host_counter_event_dictionary;
		var _follower_counter_event_dictionary;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_number_dictionary = new Object();
			_id_dictionary = new Object();
			_id_counter_dictionary = new Object();
			_id_counter_event_dictionary = new Object();
			_name_dictionary = new Object();
			_name_counter_dictionary = new Object();
			_name_counter_event_dictionary = new Object();
			_host_dictionary = new Object();
			_host_counter_dictionary = new Object();
			_host_counter_event_dictionary = new Object();
			_follower_counter_event_dictionary = new Object();
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// 掲示板ポップアップレスポンス
	// --------------------------------------------------------------------------------
	function BbsResponseDialog(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// 開放
		// --------------------------------------------------------------------------------
		_container.release = function(){
			if(_released) return;
			_released = true;

			// 子を全て破棄
			getChildren(function(dialog){
				dialog.release();
				return false;
			});

			// ダイアログの親子関係を外す
			_container.removeParent();

			// マウスイベントを外す
			removeEventMouseOverHitArea();

			// リリースイベントを外す
			removeEventRelease();

			// タスクを破棄
			if(_task){
				_task.release();
				_task = null;
			}
		};

		// --------------------------------------------------------------------------------
		// 自殺
		// --------------------------------------------------------------------------------
		_container.suicide = function(){
			if(_task){
				_container.setElementHitArea(null);
				_suicide = true;
			}else{
				_container.release();
			}
		};

		// --------------------------------------------------------------------------------
		// ヒットエリアとなる範囲を指定
		// --------------------------------------------------------------------------------
		_container.setElementHitArea = function(element){
			// マウスイベントを外す
			removeEventMouseOverHitArea();

			// リリースイベントを外す
			removeEventRelease();

			_element_hit_area = element;

			if(_element_hit_area){
				_invalid_timestamp = (new Date()).getTime();
				_invalid_once = true;
			}

			// マウスイベントを開始
			addEventMouseOverHitArea();

			// リリースイベントを開始
			addEventRelease();
		};

		// --------------------------------------------------------------------------------
		// 配置用親エレメントを指定
		// --------------------------------------------------------------------------------
		_container.setElementParent = function(element){
			_element_parent = element;
		};

		// --------------------------------------------------------------------------------
		// ウィンドウとの当たり判定
		// --------------------------------------------------------------------------------
		_container.hittestWindow = function(pos){
			if(!_window)	return false;
			return ElementHitTestPosition(_window,pos,false);
		};

		// --------------------------------------------------------------------------------
		// 子ダイアログとして登録
		// --------------------------------------------------------------------------------
		_container.attachChild = function(child){
			child.removeParent();
			var _child = _container._child;
			var _prev = _child;
			var _next = _prev._next;
			child._prev = _prev;
			child._next = _next;
			_prev._next = child;
			_next._prev = child;
			_container._parent = child;
		};

		// --------------------------------------------------------------------------------
		// 親からの登録を外す
		// --------------------------------------------------------------------------------
		_container.removeParent = function(){
			var _prev = _container._prev;
			var _next = _container._next;
			_prev._next = _next;
			_next._prev = _prev;
			_container._prev = _container;
			_container._next = _container;
			_container._parent = null;
		};

		// --------------------------------------------------------------------------------
		// 子を取得（内部用）
		// --------------------------------------------------------------------------------
		function getChildren(func){
			var queue = new Array();

			var _child = _container._child;
			var child = _child._next;
			while(child != _child){
				queue.push(child);
				child = child._next;
			}

			while(true){
				var dialog = queue.shift();
				if(!dialog)	break;

				var _child = dialog._child;
				var child = _child._next;
				while(child != _child){
					queue.push(child);
					child = child._next;
				}

				if(func(dialog)){
					return;
				}
			}
		}

		// --------------------------------------------------------------------------------
		// ヒットエリアのマウスオーバーイベントを追加（内部用）
		// --------------------------------------------------------------------------------
		function addEventMouseOverHitArea(){
			if(!_element_hit_area) return;

			removeEventMouseOverHitArea();

			if(_element_hit_area.addEventListener){
				_element_hit_area.addEventListener("mouseover",mouseOverHitArea,false);
			}else if(_element_hit_area.attachEvent){
				_element_hit_area.attachEvent("onmouseover",mouseOverHitArea);
			}
		}

		// --------------------------------------------------------------------------------
		// ヒットエリアのマウスオーバーイベントを外す（内部用）
		// --------------------------------------------------------------------------------
		function removeEventMouseOverHitArea(){
			if(!_element_hit_area) return;

			if(_element_hit_area.removeEventListener){
				_element_hit_area.removeEventListener("mouseover",mouseOverHitArea,false);
			}else if(_element_hit_area.detachEvent){
				_element_hit_area.detachEvent("onmouseover",mouseOverHitArea);
			}
		}

		// --------------------------------------------------------------------------------
		// リリースイベントを追加（内部用）
		// --------------------------------------------------------------------------------
		function addEventRelease(){
			if(!_element_hit_area) return;

			removeEventRelease();

			if(!_observer_remove){
				_observer_remove = new DomNodeObserverRemoveFromDocument(_element_hit_area);
				_observer_remove.setFunction(_container.suicide);
			}
		}

		// --------------------------------------------------------------------------------
		// リリースイベントを外す（内部用）
		// --------------------------------------------------------------------------------
		function removeEventRelease(){
			if(_observer_remove){
				// 監視を破棄
				_observer_remove.release();
				_observer_remove = null;
			}
		}

		// --------------------------------------------------------------------------------
		// ヒットエリアのマウスオーバーイベント（内部用）
		// --------------------------------------------------------------------------------
		function mouseOverHitArea(e){
			// マウス入力を更新
			input_mouse.setMouseEvent(e);

			// 一度無効化
			if(_invalid_once){
				_invalid_once = false;
				if((new Date()).getTime() - _invalid_timestamp < 100){
					return;
				}
			}

			// 再構築
			if(_task){
				var work = _task.getUserWork();
				switch(work.type){
				case "fade_out":
					_task.setExecuteFunc(ResponseDialogClose);
					_task.execute(0xffffffff);
					break;
				}
			}

			// Shift キー押下で無視
			if(input_mouse.getKeyShift())	return;

			// ドラッグ中は無視
			if(input_mouse.getButtonLeft())	return;

			// タスクを生成
			if(!_task){
				_task = task_container.createTask();
				_task.setDestructorFunc(ResponseDialogDestructor);
				_task.setExecuteFunc(ResponseDialogInitialize);
				_task.execute(0xffffffff);
			}
		}

		// --------------------------------------------------------------------------------
		// マウスムーブ（内部用）
		// --------------------------------------------------------------------------------
		function mouseMove(){
			if(!_task)	return;

			var work = _task.getUserWork();

			var hit = ElementHitTestPosition(_element_hit_area,input_mouse.getPositionClient(),false);
			if(!hit){
				hit = _container.hittestWindow(input_mouse.getPositionClient());
			}

			if(!hit){
				getChildren(function(dialog){
					hit = dialog.hittestWindow(input_mouse.getPositionClient());
					return hit;
				});
			}

			// アニメーション
			if(project.getEnableAnimationPopupBbsResponse()){
				if(hit){
					switch(work.type){
					case "wait_before_close":
						// 表示へ
						_task.setExecuteFunc(ResponseDialogShowInit);
						_task.execute(0xffffffff);
						break;
					case "fade_out":
						// フェードインへ
						_task.setExecuteFunc(ResponseDialogFadeIn);
						_task.execute(0xffffffff);
						break;
					}
				}else{
					switch(work.type){
					case "wait_before_open":
						// 閉じる
						_task.setExecuteFunc(ResponseDialogClose);
						_task.execute(0xffffffff);
						break;
					case "fade_in":
						// フェードアウトへ
						_task.setExecuteFunc(ResponseDialogFadeOut);
						_task.execute(0xffffffff);
						break;
					case "show":
						// フェードアウト待機へ
						_task.setExecuteFunc(ResponseDialogWaitBeforeClose);
						_task.execute(0xffffffff);
						break;
					}
				}
			}else{
				if(hit){
					switch(work.type){
					case "wait_before_close":
						// 表示へ
						_task.setExecuteFunc(ResponseDialogShowInit);
						_task.execute(0xffffffff);
						break;
					}
				}else{
					switch(work.type){
					case "wait_before_open":
						// 閉じる
						_task.setExecuteFunc(ResponseDialogClose);
						_task.execute(0xffffffff);
						break;
					case "show":
						// フェードアウト待機へ
						_task.setExecuteFunc(ResponseDialogWaitBeforeClose);
						_task.execute(0xffffffff);
						break;
					}
				}
			}

		}

		// --------------------------------------------------------------------------------
		// スクロール補正（内部用）
		// --------------------------------------------------------------------------------
		function reviseScroll(vec){
			if(_task){
				var work = _task.getUserWork();
				var pos = work.pos;

				pos.x += vec.x;
				pos.y += vec.y;

				ResponseDialogPositionUpdate(_task);
			}
		}

		// --------------------------------------------------------------------------------
		// 初期化（内部用）
		// --------------------------------------------------------------------------------
		function ResponseDialogInitialize(task){
			var work = task.getUserWork();

			work.type = "initialize";
			work.anime_pos = 0.0;
			work.anime_spd = 0.0;

			task.setExecuteFunc(ResponseDialogWaitBeforeOpenInit);
			task.execute(0xffffffff);
		}

		// --------------------------------------------------------------------------------
		// オープン前待機（内部用）
		// --------------------------------------------------------------------------------
		function ResponseDialogWaitBeforeOpenInit(task){
			var work = task.getUserWork();

			work.type = "wait_before_open";
			work.frame = project.getTimeWaitOpenPopupExpandBbsResponse() / 1000 * 60;

			task.setExecuteFunc(ResponseDialogWaitBeforeOpenExec);
			task.execute(0xffffffff);
		}
		function ResponseDialogWaitBeforeOpenExec(task){
			var work = task.getUserWork();

			// マウスムーブ
			mouseMove();

			work.frame -= 1;
			if(work.frame < 0){
				task.setExecuteFunc(ResponseDialogOpen);
				task.execute(0xffffffff);
				return;
			}
		}

		// --------------------------------------------------------------------------------
		// ダイアログオープン（内部用）
		// --------------------------------------------------------------------------------
		function ResponseDialogOpen(task){
			var work = task.getUserWork();

			work.type = "open";
			work.anime_pos = 0.0;
			work.anime_spd = 0.0;

			// ウィンドウ作成
			_window = DocumentCreateElement("div");

			// 解析ワーク作成
			_analyze_work = AnalyzeWorkCreate(_window);
			// 解析辞書登録
			analyze_work_dictionary.attachAnalyzeWork(_analyze_work,true);

			// スタイルをセット
			ElementSetStyle(_window,project.getStyleSheetExpandBbsPopupResponse());

			// 最前面
			_window.style.zIndex = 0x7FFFFFFF - 1;
			_window.style.position = project.getStylePositionPopupBbsResponse();

			try{
				// 親からの継承を無効化
				_window.style.minWidth  = "0";
				_window.style.minHeight = "0";
				_window.style.maxWidth  = "none";
				_window.style.maxHeight = "none";
			}catch(e){}

			_window.style.left   = "0px";
			_window.style.top    = "0px";
			_window.style.width  = "0px";
			_window.style.height = "0px";

			_window.style.visibility = "hidden";

			// スタイルのサイズを取得
			document.body.appendChild(_window);
			var bounding_size = ElementGetBoundingClientRect(_window);
			work.style_w = bounding_size.right  - bounding_size.left;
			work.style_h = bounding_size.bottom - bounding_size.top;
			DomNodeRemove(_window);


			var completed = false;
			function abort(){
				_task.setExecuteFunc(ResponseDialogClose);
				_task.execute(0xffffffff);
			}

			function response(obj){
				if(!task.getAlive())	return;

				if(completed)	return;
				completed = true;

				if(!(obj.result)){
					abort();
					return;
				}

				// クライアントサイズ
				var client_size = DocumentGetClientSize(document);

				// スクロール位置
				var scroll_pos = DocumentGetScrollPos();

				// サイズ
				var percent = project.getPercentPopupBbsResponse();
				var width  = Math.floor(client_size.width  * (percent.x / 100)) - work.style_w - 2;
				var height = Math.floor(client_size.height * (percent.y / 100)) - work.style_h - 2;

				// サイズをセット
				_window.style.width  = (width) + "px";
				_window.style.height = "auto";
				_window.style.maxHeight = (height) + "px";

				if(_element_parent){
					_element_parent.appendChild(_window);
				}else{
					document.body.appendChild(_window);
				}

				// バウンディングサイズ
				var hit_bounding_size = ElementGetBoundingClientRect(_element_hit_area);
				hit_bounding_size.left   = Math.floor(hit_bounding_size.left);
				hit_bounding_size.top    = Math.floor(hit_bounding_size.top);
				hit_bounding_size.right  = Math.ceil(hit_bounding_size.right);
				hit_bounding_size.bottom = Math.ceil(hit_bounding_size.bottom);

				// バウンディングサイズ
				var window_bounding_size = ElementGetBoundingClientRect(_window);

				var sub_x;
				var sub_y;
				var cx = (hit_bounding_size.left + hit_bounding_size.right) * 0.5;
				var cy = (hit_bounding_size.top + hit_bounding_size.bottom) * 0.5;

				// 表示位置
				switch(project.getOriginPopupExpandBbsResponse()){
				default:
				case "adsorb_left_right":

					// 左右吸着
					if((cx / client_size.width) < 0.5){
						sub_x = hit_bounding_size.right - window_bounding_size.left;
					}else{
						sub_x = hit_bounding_size.left - window_bounding_size.right;
					}
					if((cy / client_size.height) < 0.5){
						sub_y = hit_bounding_size.top - window_bounding_size.top;
					}else{
						sub_y = hit_bounding_size.bottom - window_bounding_size.bottom;
					}
					break;

				case "adsorb_top_bottom":

					// 上下吸着
					if((cx / client_size.width) < 0.5){
						sub_x = hit_bounding_size.left - window_bounding_size.left;
					}else{
						sub_x = hit_bounding_size.right - window_bounding_size.right;
					}
					if((cy / client_size.height) < 0.5){
						sub_y = hit_bounding_size.bottom - window_bounding_size.top;
					}else{
						sub_y = hit_bounding_size.top - window_bounding_size.bottom;
					}
					break;
				}

				window_bounding_size.left   += sub_x;
				window_bounding_size.right  += sub_x;
				window_bounding_size.top    += sub_y;
				window_bounding_size.bottom += sub_y;

				var pos = {
					x:window_bounding_size.left,
					y:window_bounding_size.top
				};
				work.pos = pos;

				// サイズ補正
				if(client_size.width  < window_bounding_size.right  + 1)		pos.x += client_size.width  - 1 - window_bounding_size.right;
				if(client_size.height < window_bounding_size.bottom + 1)		pos.y += client_size.height - 1 - window_bounding_size.bottom;
				if(pos.x < 1)	pos.x = 1;
				if(pos.y < 1)	pos.y = 1;

				var h = client_size.height - pos.y - work.style_h - 1;
				if(h < height){
					height = h;
					_window.style.maxHeight = (height) + "px";
				}

				// 絶対座標系
				if(project.getStylePositionPopupBbsResponse() == "absolute"){
					pos.x += scroll_pos.x;
					pos.y += scroll_pos.y;

					// イベントハンドラを作成
					_event_handler_revise_scroll = page_expand_event_dispatcher.createEventHandler("revise_scroll");
					_event_handler_revise_scroll.setFunction(reviseScroll);
				}

				ResponseDialogPositionUpdate(task);



				// マウスイベント有効化
				_window.style.pointerEvents = "auto";

				_window.style.visibility = "visible";

				// アニメーション
				if(project.getEnableAnimationPopupBbsResponse()){
					task.setExecuteFunc(ResponseDialogFadeIn);
				}else{
					task.setExecuteFunc(ResponseDialogShowInit);
				}

				task.execute(0xffffffff);
			}

			// 待機
			_task.setExecuteFunc(null);

			// 生成イベント
			var result = _container.oncreate(_window,response);
			if(result !== undefined){
				response({result:result});
			}
		}

		// --------------------------------------------------------------------------------
		// フェードイン（内部用）
		// --------------------------------------------------------------------------------
		function ResponseDialogFadeIn(task){
			var work = task.getUserWork();

			work.type = "fade_in";

			// マウスムーブ
			mouseMove();

			var sub = 1.0 - work.anime_pos;
			sub *= 0.4;
			if(sub > 0.0){
				work.anime_spd += 0.05;
				if(work.anime_spd > 0.2)	work.anime_spd = 0.2;
				if(work.anime_spd > sub)	work.anime_spd = sub;
			}

			work.anime_pos += work.anime_spd;
			if(work.anime_pos > 0.999){
				work.anime_spd = 0.0;
				work.anime_pos = 1.0;
				task.setExecuteFunc(ResponseDialogShowInit);
			}
			_window.style.opacity = work.anime_pos;
		}

		// --------------------------------------------------------------------------------
		// 表示（内部用）
		// --------------------------------------------------------------------------------
		function ResponseDialogShowInit(task){
			var work = task.getUserWork();

			work.type = "show";
			work.anime_pos = 1.0;
			work.anime_spd = 0.0;
			work.frame = project.getTimeWaitClosePopupExpandBbsResponse() / 1000 * 60;
			_window.style.opacity = work.anime_pos;

			task.setExecuteFunc(ResponseDialogShowExec);
			task.execute(0xffffffff);
		}
		function ResponseDialogShowExec(task){
			var work = task.getUserWork();

			// マウスムーブ
			mouseMove();
		}

		// --------------------------------------------------------------------------------
		// 待機（内部用）
		// --------------------------------------------------------------------------------
		function ResponseDialogWaitBeforeClose(task){
			var work = task.getUserWork();

			work.type = "wait_before_close";

			// マウスムーブ
			mouseMove();

			work.frame -= 1;
			if(work.frame < 0){
				// アニメーション
				if(project.getEnableAnimationPopupBbsResponse()){
					// マウスイベント無効化
					_window.style.pointerEvents = "none";
					task.setExecuteFunc(ResponseDialogFadeOut);
				}else{
					task.setExecuteFunc(ResponseDialogClose);
				}
			}
		}

		// --------------------------------------------------------------------------------
		// フェードアウト（内部用）
		// --------------------------------------------------------------------------------
		function ResponseDialogFadeOut(task){
			var work = task.getUserWork();

			work.type = "fade_out";

			var sub = 0.0 - work.anime_pos;
			sub *= 0.4;
			if(sub < 0.0){
				work.anime_spd -= 0.2;
				if(work.anime_spd < sub)	work.anime_spd = sub;
			}
			work.anime_pos += work.anime_spd;
			if(work.anime_pos < 0.001){
				work.anime_spd = 0.0;
				work.anime_pos = 0.0;
				task.setExecuteFunc(ResponseDialogClose);
			}
			_window.style.opacity = work.anime_pos;
		}

		// --------------------------------------------------------------------------------
		// 閉じる（内部用）
		// --------------------------------------------------------------------------------
		function ResponseDialogClose(task){
			var work = task.getUserWork();
			task.release();
		}

		// --------------------------------------------------------------------------------
		// デストラクタ（内部用）
		// --------------------------------------------------------------------------------
		function ResponseDialogDestructor(task){
			// 解放
			if(_event_handler_revise_scroll){
				_event_handler_revise_scroll.release();
				_event_handler_revise_scroll = null;
			}

			if(_analyze_work){
				// 解析辞書除外
				analyze_work_dictionary.removeAnalyzeWork(_analyze_work);
				_analyze_work = null;
			}

			if(_window){
				DomNodeRemove(_window);
				_window = null;
			}
			_task = null;

			// 自殺
			if(_suicide){
				_container.release();
			}
		}

		// --------------------------------------------------------------------------------
		// サイズ更新（内部用）
		// --------------------------------------------------------------------------------
		function ResponseDialogPositionUpdate(task){
			var work = task.getUserWork();
			var pos = work.pos;

			_window.style.left = (pos.x) + "px";
			_window.style.top  = (pos.y) + "px";
		}

		// --------------------------------------------------------------------------------
		// ダイアログ生成イベント
		// --------------------------------------------------------------------------------
		_container.oncreate = function(element){};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _task;
		var _element_hit_area;
		var _element_parent;
		var _window;
		var _invalid_once;
		var _invalid_timestamp;
		var _suicide;
		var _released;
		var _analyze_work;
		var _observer_remove;
		var _event_handler_revise_scroll;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_task = null;
			_window = null;
			_invalid_once = false;
			_invalid_timestamp = 0;
			_suicide = false;
			_released = false;
			_container._parent = null;
			_container._prev = _container;
			_container._next = _container;

			var _child = new Object();
			_child._prev = _child;
			_child._next = _child;
			_container._child = _child;
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロール レスアンカー
	// --------------------------------------------------------------------------------
	function BbsControlResponseAnchor(element,outsider){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// タイプを取得
		// --------------------------------------------------------------------------------
		_container.getType = function(id){
			return "res_a";
		};

		// --------------------------------------------------------------------------------
		// ResponseAnchorNumbers オブジェクトを取得
		// --------------------------------------------------------------------------------
		_container.getResponseAnchorNumbers = function(){
			return _numbers;
		};

		// --------------------------------------------------------------------------------
		// ResponseAnchorNumbers オブジェクトをセット
		// --------------------------------------------------------------------------------
		_container.setResponseAnchorNumbers = function(numbers){
			_numbers = numbers;
		};

		// --------------------------------------------------------------------------------
		// レスポンスオブジェクトをセット
		// --------------------------------------------------------------------------------
		_container.setResponse = function(response){
			if(!_response){
				_response = response;

				// 解放イベント
				var event_dispatcher = response.getEventDispatcher();
				_event_handler_release = event_dispatcher.createEventHandler("release");
				_event_handler_release.setFunction(_container.release);
			}
		};

		// --------------------------------------------------------------------------------
		// 要素を取得
		// --------------------------------------------------------------------------------
		_container.getElement = function(){
			return _element;
		};

		// --------------------------------------------------------------------------------
		// テキストノードを取得
		// --------------------------------------------------------------------------------
		_container.getTextNode = function(){
			return _text_node;
		};

		// --------------------------------------------------------------------------------
		// テキストノードをセット
		// --------------------------------------------------------------------------------
		_container.setTextNode = function(node){
			_text_node = node;
		};

		// --------------------------------------------------------------------------------
		// 開放
		// --------------------------------------------------------------------------------
		_container.release = function(){
			_numbers = null;

			_container.onchange(0);

			// イベント解放
			if(_event_handler_release){
				_event_handler_release.release();
				_event_handler_release = null;
			}

			// リムーブ監視を破棄
			if(_observer_remove){
				_observer_remove.release();
				_observer_remove = null;
			}

			if(_analyze_work){
				// 解析辞書除外
				AnalyzeWorkClearBbsControl(_analyze_work);
				analyze_work_dictionary.removeAnalyzeWork(_analyze_work);
				_analyze_work = null;
			}

			if(_element){
				if(outsider){
					DomNodeRemove(_element);
				}
				_element = null;
			}
		};

		// --------------------------------------------------------------------------------
		// 更新通知
		// --------------------------------------------------------------------------------
		_container.onchange = function(v){};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _numbers;
		var _element;
		var _text_node;
		var _analyze_work;
		var _observer_remove;
		var _response;
		var _event_handler_release;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			if(element){
				_element = element;
				element = null;
			}else{
				_element = DocumentCreateElement("a");
			}

			// 解析ワーク作成
			_analyze_work = AnalyzeWorkCreate(_element);
			// 掲示板コントロール登録
			AnalyzeWorkSetBbsControl(_analyze_work,_container);
			// 解析済み
			AnalyzeWorkSetInvalid(_analyze_work);
			// 解析辞書登録
			analyze_work_dictionary.attachAnalyzeWork(_analyze_work,outsider);

			// リムーブ監視
			_observer_remove = new DomNodeObserverRemoveFromDocument(_element);
			_observer_remove.setFunction(_container.release);
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロール レスアンカー の存在確認
	// --------------------------------------------------------------------------------
	function BbsControlResponseAnchorExist(element){
		var nodes = ElementGetElementsByTagName(element,"*");
		var i;
		var num = nodes.length;
		for(i=0;i<num;i++){
			// 解析ワーク取得
			var work = analyze_work_dictionary.getAnalyzeWork(nodes[i]);
			if(work){
				var control = AnalyzeWorkGetBbsControl(work);
				if(control){
					if(control.getType() == "res_a"){
						return true;
					}
				}
			}
		}
		return false;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロール レスアンカー の検索
	// --------------------------------------------------------------------------------
	function BbsControlResponseAnchorSearch(element,func){
		var result = null;
		var nodes = ElementGetElementsByTagName(element,"*");
		var i;
		var num = nodes.length;
		for(i=0;i<num;i++){
			// 解析ワーク取得
			var work = analyze_work_dictionary.getAnalyzeWork(nodes[i]);
			if(work){
				var control = AnalyzeWorkGetBbsControl(work);
				if(control){
					if(control.getType() == "res_a"){
						result = func(control);
						if(result){
							return result;
						}
					}
				}
			}
		}
		return result;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロール 引用
	// --------------------------------------------------------------------------------
	function BbsControlQuote(element,outsider){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// タイプを取得
		// --------------------------------------------------------------------------------
		_container.getType = function(id){
			return "res_q";
		};

		// --------------------------------------------------------------------------------
		// ResponseAnchorNumbers オブジェクトを取得
		// --------------------------------------------------------------------------------
		_container.getResponseAnchorNumbers = function(){
			return _numbers;
		};

		// --------------------------------------------------------------------------------
		// ResponseAnchorNumbers オブジェクトをセット
		// --------------------------------------------------------------------------------
		_container.setResponseAnchorNumbers = function(numbers){
			_numbers = numbers;
		};

		// --------------------------------------------------------------------------------
		// レスポンスオブジェクトをセット
		// --------------------------------------------------------------------------------
		_container.setResponse = function(response){
			if(!_response){
				_response = response;

				// 解放イベント
				var event_dispatcher = response.getEventDispatcher();
				_event_handler_release = event_dispatcher.createEventHandler("release");
				_event_handler_release.setFunction(_container.release);
			}
		};

		// --------------------------------------------------------------------------------
		// 要素を取得
		// --------------------------------------------------------------------------------
		_container.getElement = function(){
			return _element;
		};

		// --------------------------------------------------------------------------------
		// テキストノードを取得
		// --------------------------------------------------------------------------------
		_container.getTextNode = function(){
			return _text_node;
		};

		// --------------------------------------------------------------------------------
		// テキストノードをセット
		// --------------------------------------------------------------------------------
		_container.setTextNode = function(node){
			_text_node = node;
		};

		// --------------------------------------------------------------------------------
		// 開放
		// --------------------------------------------------------------------------------
		_container.release = function(){
			_numbers = null;

			_container.onchange(0);

			// イベント解放
			if(_event_handler_release){
				_event_handler_release.release();
				_event_handler_release = null;
			}

			// リムーブ監視を破棄
			if(_observer_remove){
				_observer_remove.release();
				_observer_remove = null;
			}

			if(_analyze_work){
				// 解析辞書除外
				AnalyzeWorkClearBbsControl(_analyze_work);
				analyze_work_dictionary.removeAnalyzeWork(_analyze_work);
				_analyze_work = null;
			}

			if(_element){
				if(outsider){
					DomNodeRemove(_element);
				}
				_element = null;
			}
		};

		// --------------------------------------------------------------------------------
		// 更新通知
		// --------------------------------------------------------------------------------
		_container.onchange = function(v){};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _numbers;
		var _element;
		var _text_node;
		var _analyze_work;
		var _observer_remove;
		var _response;
		var _event_handler_release;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			if(element){
				_element = element;
				element = null;
			}else{
				_element = DocumentCreateElement("span");
			}

			// 解析ワーク作成
			_analyze_work = AnalyzeWorkCreate(_element);
			// 掲示板コントロール登録
			AnalyzeWorkSetBbsControl(_analyze_work,_container);
			// 解析済み
			AnalyzeWorkSetInvalid(_analyze_work);
			// 解析辞書登録
			analyze_work_dictionary.attachAnalyzeWork(_analyze_work,outsider);

			// リムーブ監視
			_observer_remove = new DomNodeObserverRemoveFromDocument(_element);
			_observer_remove.setFunction(_container.release);
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロール 引用 の存在確認
	// --------------------------------------------------------------------------------
	function BbsControlQuoteExist(element){
		var nodes = ElementGetElementsByTagName(element,"*");
		var i;
		var num = nodes.length;
		for(i=0;i<num;i++){
			// 解析ワーク取得
			var work = analyze_work_dictionary.getAnalyzeWork(nodes[i]);
			if(work){
				var control = AnalyzeWorkGetBbsControl(work);
				if(control){
					if(control.getType() == "res_q"){
						return true;
					}
				}
			}
		}
		return false;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロール 引用 の検索
	// --------------------------------------------------------------------------------
	function BbsControlQuoteSearch(element,func){
		var result = null;
		var nodes = ElementGetElementsByTagName(element,"*");
		var i;
		var num = nodes.length;
		for(i=0;i<num;i++){
			// 解析ワーク取得
			var work = analyze_work_dictionary.getAnalyzeWork(nodes[i]);
			if(work){
				var control = AnalyzeWorkGetBbsControl(work);
				if(control){
					if(control.getType() == "res_q"){
						result = func(control);
						if(result){
							return result;
						}
					}
				}
			}
		}
		return result;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロール ID
	// --------------------------------------------------------------------------------
	function BbsControlId(element,outsider){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// タイプを取得
		// --------------------------------------------------------------------------------
		_container.getType = function(id){
			return "id";
		};

		// --------------------------------------------------------------------------------
		// ID を取得
		// --------------------------------------------------------------------------------
		_container.getId = function(){
			return _id;
		};

		// --------------------------------------------------------------------------------
		// ID をセット
		// --------------------------------------------------------------------------------
		_container.setId = function(id){
			if(!_id){
				_id = id;

				// ID 数の更新イベント
				_event_handler_update = bbs_dictionary.createEventHandlerForIdCounter(_id);
				_event_handler_update.setFunction(function(v){
					_container.onchange(v);
				});
			}
		};

		// --------------------------------------------------------------------------------
		// レスポンスオブジェクトをセット
		// --------------------------------------------------------------------------------
		_container.setResponse = function(response){
			if(!_response){
				_response = response;

				// 解放イベント
				var event_dispatcher = response.getEventDispatcher();
				_event_handler_release = event_dispatcher.createEventHandler("release");
				_event_handler_release.setFunction(_container.release);
			}
		};

		// --------------------------------------------------------------------------------
		// 要素を取得
		// --------------------------------------------------------------------------------
		_container.getElement = function(){
			return _element;
		};

		// --------------------------------------------------------------------------------
		// テキストノードを取得
		// --------------------------------------------------------------------------------
		_container.getTextNode = function(){
			return _text_node;
		};

		// --------------------------------------------------------------------------------
		// テキストノードをセット
		// --------------------------------------------------------------------------------
		_container.setTextNode = function(node){
			_text_node = node;
		};

		// --------------------------------------------------------------------------------
		// 更新
		// --------------------------------------------------------------------------------
		_container.update = function(){
			var v = bbs_dictionary.getCountId(_id);
			_container.onchange(v);
		};

		// --------------------------------------------------------------------------------
		// 開放
		// --------------------------------------------------------------------------------
		_container.release = function(){

			_container.onchange(0);

			// イベント解放
			if(_event_handler_update){
				_event_handler_update.release();
				_event_handler_update = null;
			}
			if(_event_handler_release){
				_event_handler_release.release();
				_event_handler_release = null;
			}

			// リムーブ監視を破棄
			if(_observer_remove){
				_observer_remove.release();
				_observer_remove = null;
			}

			if(_analyze_work){
				// 解析辞書除外
				AnalyzeWorkClearBbsControl(_analyze_work);
				analyze_work_dictionary.removeAnalyzeWork(_analyze_work);
				_analyze_work = null;
			}

			if(_element){
				removeEventClick();
				if(outsider){
					DomNodeRemove(_element);
				}
				_element = null;
			}
		};

		// --------------------------------------------------------------------------------
		// 更新通知
		// --------------------------------------------------------------------------------
		_container.onchange = function(v){};

		// --------------------------------------------------------------------------------
		// マウスクリック時に実行される関数（内部用）
		// --------------------------------------------------------------------------------
		function mouseClick(e){
			removeEventClick();

			var ary = bbs_dictionary.getResponsesFromId(_id);
			var num = ary.length;
			var i = num - 1;
			function f(){
				ary[i].erase();

				i --;
				if(i >= 0){
					execute_queue.attachFirst(f,null);
				}else{
					_container.release();
				}
			}
			execute_queue.attachFirst(f,null);
		}

		// --------------------------------------------------------------------------------
		// クリックイベントを外す（内部用）
		// --------------------------------------------------------------------------------
		function removeEventClick(){
			if(_element.removeEventListener){
				_element.removeEventListener("click",mouseClick);
			}else if(_element.detachEvent){
				_element.detachEvent("onclick",mouseClick);
			}
		}

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _element;
		var _text_node;
		var _analyze_work;
		var _observer_remove;
		var _response;
		var _id;
		var _event_handler_update;
		var _event_handler_release;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			if(element){
				_element = element;
				element = null;
			}else{
				_element = DocumentCreateElement("span");
			}

			if(_element.addEventListener){
				_element.addEventListener("click",mouseClick);
			}else if(_element.attachEvent){
				_element.attachEvent("onclick",mouseClick);
			}

			// 解析ワーク作成
			_analyze_work = AnalyzeWorkCreate(_element);
			// 掲示板コントロール登録
			AnalyzeWorkSetBbsControl(_analyze_work,_container);
			// 解析済み
			AnalyzeWorkSetInvalid(_analyze_work);
			// 解析辞書登録
			analyze_work_dictionary.attachAnalyzeWork(_analyze_work,outsider);

			// リムーブ監視
			_observer_remove = new DomNodeObserverRemoveFromDocument(_element);
			_observer_remove.setFunction(_container.release);
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロール ID の存在確認
	// --------------------------------------------------------------------------------
	function BbsControlIdExist(element){
		var nodes = ElementGetElementsByTagName(element,"*");
		var i;
		var num = nodes.length;
		for(i=0;i<num;i++){
			// 解析ワーク取得
			var work = analyze_work_dictionary.getAnalyzeWork(nodes[i]);
			if(work){
				var control = AnalyzeWorkGetBbsControl(work);
				if(control){
					if(control.getType() == "id"){
						return true;
					}
				}
			}
		}
		return false;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロール ID の検索
	// --------------------------------------------------------------------------------
	function BbsControlIdSearch(element,func){
		var result = null;
		var nodes = ElementGetElementsByTagName(element,"*");
		var i;
		var num = nodes.length;
		for(i=0;i<num;i++){
			// 解析ワーク取得
			var work = analyze_work_dictionary.getAnalyzeWork(nodes[i]);
			if(work){
				var control = AnalyzeWorkGetBbsControl(work);
				if(control){
					if(control.getType() == "id"){
						result = func(control);
						if(result){
							return result;
						}
					}
				}
			}
		}
		return result;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロール 名前
	// --------------------------------------------------------------------------------
	function BbsControlName(element,outsider){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// タイプを取得
		// --------------------------------------------------------------------------------
		_container.getType = function(name){
			return "name";
		};

		// --------------------------------------------------------------------------------
		// 名前を取得
		// --------------------------------------------------------------------------------
		_container.getName = function(){
			return _name;
		};

		// --------------------------------------------------------------------------------
		// 名前をセット
		// --------------------------------------------------------------------------------
		_container.setName = function(name){
			if(!_name){
				_name = name;

				// 名前数の更新イベント
				_event_handler_update = bbs_dictionary.createEventHandlerForNameCounter(_name);
				_event_handler_update.setFunction(function(v){
					_container.onchange(v);
				});
			}
		};

		// --------------------------------------------------------------------------------
		// レスポンスオブジェクトをセット
		// --------------------------------------------------------------------------------
		_container.setResponse = function(response){
			if(!_response){
				_response = response;

				// 解放イベント
				var event_dispatcher = response.getEventDispatcher();
				_event_handler_release = event_dispatcher.createEventHandler("release");
				_event_handler_release.setFunction(_container.release);
			}
		};

		// --------------------------------------------------------------------------------
		// 要素を取得
		// --------------------------------------------------------------------------------
		_container.getElement = function(){
			return _element;
		};

		// --------------------------------------------------------------------------------
		// テキストノードを取得
		// --------------------------------------------------------------------------------
		_container.getTextNode = function(){
			return _text_node;
		};

		// --------------------------------------------------------------------------------
		// テキストノードをセット
		// --------------------------------------------------------------------------------
		_container.setTextNode = function(node){
			_text_node = node;
		};

		// --------------------------------------------------------------------------------
		// 更新
		// --------------------------------------------------------------------------------
		_container.update = function(){
			var v = bbs_dictionary.getCountName(_name);
			_container.onchange(v);
		};

		// --------------------------------------------------------------------------------
		// 開放
		// --------------------------------------------------------------------------------
		_container.release = function(){

			_container.onchange(0);

			// イベント解放
			if(_event_handler_update){
				_event_handler_update.release();
				_event_handler_update = null;
			}
			if(_event_handler_release){
				_event_handler_release.release();
				_event_handler_release = null;
			}

			// リムーブ監視を破棄
			if(_observer_remove){
				_observer_remove.release();
				_observer_remove = null;
			}

			if(_analyze_work){
				// 解析辞書除外
				AnalyzeWorkClearBbsControl(_analyze_work);
				analyze_work_dictionary.removeAnalyzeWork(_analyze_work);
				_analyze_work = null;
			}

			if(_element){
				removeEventClick();
				if(outsider){
					DomNodeRemove(_element);
				}
				_element = null;
			}
		};

		// --------------------------------------------------------------------------------
		// 更新通知
		// --------------------------------------------------------------------------------
		_container.onchange = function(v){};

		// --------------------------------------------------------------------------------
		// マウスクリック時に実行される関数（内部用）
		// --------------------------------------------------------------------------------
		function mouseClick(e){
			removeEventClick();

			var ary = bbs_dictionary.getResponsesFromName(_name);
			var num = ary.length;
			var i = num - 1;
			function f(){
				ary[i].erase();

				i --;
				if(i >= 0){
					execute_queue.attachFirst(f,null);
				}else{
					_container.release();
				}
			}
			execute_queue.attachFirst(f,null);
		}

		// --------------------------------------------------------------------------------
		// クリックイベントを外す（内部用）
		// --------------------------------------------------------------------------------
		function removeEventClick(){
			if(_element.removeEventListener){
				_element.removeEventListener("click",mouseClick);
			}else if(_element.detachEvent){
				_element.detachEvent("onclick",mouseClick);
			}
		}

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _element;
		var _text_node;
		var _analyze_work;
		var _observer_remove;
		var _response;
		var _name;
		var _event_handler_update;
		var _event_handler_release;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			if(element){
				_element = element;
				element = null;
			}else{
				_element = DocumentCreateElement("span");
			}

			if(_element.addEventListener){
				_element.addEventListener("click",mouseClick);
			}else if(_element.attachEvent){
				_element.attachEvent("onclick",mouseClick);
			}

			// 解析ワーク作成
			_analyze_work = AnalyzeWorkCreate(_element);
			// 掲示板コントロール登録
			AnalyzeWorkSetBbsControl(_analyze_work,_container);
			// 解析済み
			AnalyzeWorkSetInvalid(_analyze_work);
			// 解析辞書登録
			analyze_work_dictionary.attachAnalyzeWork(_analyze_work,outsider);

			// リムーブ監視
			_observer_remove = new DomNodeObserverRemoveFromDocument(_element);
			_observer_remove.setFunction(_container.release);
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロール 名前 の存在確認
	// --------------------------------------------------------------------------------
	function BbsControlNameExist(element){
		var nodes = ElementGetElementsByTagName(element,"*");
		var i;
		var num = nodes.length;
		for(i=0;i<num;i++){
			// 解析ワーク取得
			var work = analyze_work_dictionary.getAnalyzeWork(nodes[i]);
			if(work){
				var control = AnalyzeWorkGetBbsControl(work);
				if(control){
					if(control.getType() == "name"){
						return true;
					}
				}
			}
		}
		return false;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロール 名前 の検索
	// --------------------------------------------------------------------------------
	function BbsControlNameSearch(element,func){
		var result = null;
		var nodes = ElementGetElementsByTagName(element,"*");
		var i;
		var num = nodes.length;
		for(i=0;i<num;i++){
			// 解析ワーク取得
			var work = analyze_work_dictionary.getAnalyzeWork(nodes[i]);
			if(work){
				var control = AnalyzeWorkGetBbsControl(work);
				if(control){
					if(control.getType() == "name"){
						result = func(control);
						if(result){
							return result;
						}
					}
				}
			}
		}
		return result;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロール ホスト
	// --------------------------------------------------------------------------------
	function BbsControlHost(element,outsider){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// タイプを取得
		// --------------------------------------------------------------------------------
		_container.getType = function(host){
			return "host";
		};

		// --------------------------------------------------------------------------------
		// ホストを取得
		// --------------------------------------------------------------------------------
		_container.getHost = function(){
			return _host;
		};

		// --------------------------------------------------------------------------------
		// ホストをセット
		// --------------------------------------------------------------------------------
		_container.setHost = function(host){
			if(!_host){
				_host = host;

				// ホスト数の更新イベント
				_event_handler_update = bbs_dictionary.createEventHandlerForHostCounter(_host);
				_event_handler_update.setFunction(function(v){
					_container.onchange(v);
				});
			}
		};

		// --------------------------------------------------------------------------------
		// レスポンスオブジェクトをセット
		// --------------------------------------------------------------------------------
		_container.setResponse = function(response){
			if(!_response){
				_response = response;

				// 解放イベント
				var event_dispatcher = response.getEventDispatcher();
				_event_handler_release = event_dispatcher.createEventHandler("release");
				_event_handler_release.setFunction(_container.release);
			}
		};

		// --------------------------------------------------------------------------------
		// 要素を取得
		// --------------------------------------------------------------------------------
		_container.getElement = function(){
			return _element;
		};

		// --------------------------------------------------------------------------------
		// テキストノードを取得
		// --------------------------------------------------------------------------------
		_container.getTextNode = function(){
			return _text_node;
		};

		// --------------------------------------------------------------------------------
		// テキストノードをセット
		// --------------------------------------------------------------------------------
		_container.setTextNode = function(node){
			_text_node = node;
		};

		// --------------------------------------------------------------------------------
		// 更新
		// --------------------------------------------------------------------------------
		_container.update = function(){
			var v = bbs_dictionary.getCountHost(_host);
			_container.onchange(v);
		};

		// --------------------------------------------------------------------------------
		// 開放
		// --------------------------------------------------------------------------------
		_container.release = function(){

			_container.onchange(0);

			// イベント解放
			if(_event_handler_update){
				_event_handler_update.release();
				_event_handler_update = null;
			}
			if(_event_handler_release){
				_event_handler_release.release();
				_event_handler_release = null;
			}

			// リムーブ監視を破棄
			if(_observer_remove){
				_observer_remove.release();
				_observer_remove = null;
			}

			if(_analyze_work){
				// 解析辞書除外
				AnalyzeWorkClearBbsControl(_analyze_work);
				analyze_work_dictionary.removeAnalyzeWork(_analyze_work);
				_analyze_work = null;
			}

			if(_element){
				removeEventClick();
				if(outsider){
					DomNodeRemove(_element);
				}
				_element = null;
			}
		};

		// --------------------------------------------------------------------------------
		// 更新通知
		// --------------------------------------------------------------------------------
		_container.onchange = function(v){};

		// --------------------------------------------------------------------------------
		// マウスクリック時に実行される関数（内部用）
		// --------------------------------------------------------------------------------
		function mouseClick(e){
			removeEventClick();

			var ary = bbs_dictionary.getResponsesFromHost(_host);
			var num = ary.length;
			var i = num - 1;
			function f(){
				ary[i].erase();

				i --;
				if(i >= 0){
					execute_queue.attachFirst(f,null);
				}else{
					_container.release();
				}
			}
			execute_queue.attachFirst(f,null);
		}

		// --------------------------------------------------------------------------------
		// クリックイベントを外す（内部用）
		// --------------------------------------------------------------------------------
		function removeEventClick(){
			if(_element.removeEventListener){
				_element.removeEventListener("click",mouseClick);
			}else if(_element.detachEvent){
				_element.detachEvent("onclick",mouseClick);
			}
		}

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _element;
		var _text_node;
		var _analyze_work;
		var _observer_remove;
		var _response;
		var _host;
		var _event_handler_update;
		var _event_handler_release;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			if(element){
				_element = element;
				element = null;
			}else{
				_element = DocumentCreateElement("span");
			}

			if(_element.addEventListener){
				_element.addEventListener("click",mouseClick);
			}else if(_element.attachEvent){
				_element.attachEvent("onclick",mouseClick);
			}

			// 解析ワーク作成
			_analyze_work = AnalyzeWorkCreate(_element);
			// 掲示板コントロール登録
			AnalyzeWorkSetBbsControl(_analyze_work,_container);
			// 解析済み
			AnalyzeWorkSetInvalid(_analyze_work);
			// 解析辞書登録
			analyze_work_dictionary.attachAnalyzeWork(_analyze_work,outsider);

			// リムーブ監視
			_observer_remove = new DomNodeObserverRemoveFromDocument(_element);
			_observer_remove.setFunction(_container.release);
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロール ホスト の存在確認
	// --------------------------------------------------------------------------------
	function BbsControlHostExist(element){
		var nodes = ElementGetElementsByTagName(element,"*");
		var i;
		var num = nodes.length;
		for(i=0;i<num;i++){
			// 解析ワーク取得
			var work = analyze_work_dictionary.getAnalyzeWork(nodes[i]);
			if(work){
				var control = AnalyzeWorkGetBbsControl(work);
				if(control){
					if(control.getType() == "host"){
						return true;
					}
				}
			}
		}
		return false;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロール ホスト の検索
	// --------------------------------------------------------------------------------
	function BbsControlHostSearch(element,func){
		var result = null;
		var nodes = ElementGetElementsByTagName(element,"*");
		var i;
		var num = nodes.length;
		for(i=0;i<num;i++){
			// 解析ワーク取得
			var work = analyze_work_dictionary.getAnalyzeWork(nodes[i]);
			if(work){
				var control = AnalyzeWorkGetBbsControl(work);
				if(control){
					if(control.getType() == "host"){
						result = func(control);
						if(result){
							return result;
						}
					}
				}
			}
		}
		return result;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロール Follower
	// --------------------------------------------------------------------------------
	function BbsControlFollower(element,outsider){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// タイプを取得
		// --------------------------------------------------------------------------------
		_container.getType = function(id){
			return "follower";
		};

		// --------------------------------------------------------------------------------
		// レスポンスオブジェクトをセット
		// --------------------------------------------------------------------------------
		_container.setResponse = function(response){
			if(!_response){
				_response = response;

				// フォロワー数の更新イベント
				_event_handler_update = bbs_dictionary.createEventHandlerForFollowerCounter(response.getNumber());
				_event_handler_update.setFunction(function(v){
					_container.onchange(v);
				});

				// 解放イベント
				var event_dispatcher = response.getEventDispatcher();
				_event_handler_release = event_dispatcher.createEventHandler("release");
				_event_handler_release.setFunction(_container.release);
			}
		};

		// --------------------------------------------------------------------------------
		// 要素を取得
		// --------------------------------------------------------------------------------
		_container.getElement = function(){
			return _element;
		};

		// --------------------------------------------------------------------------------
		// テキストノードを取得
		// --------------------------------------------------------------------------------
		_container.getTextNode = function(){
			return _text_node;
		};

		// --------------------------------------------------------------------------------
		// テキストノードをセット
		// --------------------------------------------------------------------------------
		_container.setTextNode = function(node){
			_text_node = node;
		};

		// --------------------------------------------------------------------------------
		// 更新
		// --------------------------------------------------------------------------------
		_container.update = function(){
			var v = _response.getCountFollower();
			_container.onchange(v);
		};

		// --------------------------------------------------------------------------------
		// 開放
		// --------------------------------------------------------------------------------
		_container.release = function(){
			// イベント解放
			if(_event_handler_update){
				_event_handler_update.release();
				_event_handler_update = null;
			}
			if(_event_handler_release){
				_event_handler_release.release();
				_event_handler_release = null;
			}

			// リムーブ監視を破棄
			if(_observer_remove){
				_observer_remove.release();
				_observer_remove = null;
			}

			if(_analyze_work){
				// 解析辞書除外
				AnalyzeWorkClearBbsControl(_analyze_work);
				analyze_work_dictionary.removeAnalyzeWork(_analyze_work);
				_analyze_work = null;
			}

			if(_element){
				removeEventClick();
				if(outsider){
					DomNodeRemove(_element);
				}
				_element = null;
			}
		};

		// --------------------------------------------------------------------------------
		// 更新通知
		// --------------------------------------------------------------------------------
		_container.onchange = function(v){};

		// --------------------------------------------------------------------------------
		// マウスクリック時に実行される関数（内部用）
		// --------------------------------------------------------------------------------
		function mouseClick(e){
			removeEventClick();

			var ary = _response.getFollower();
			var num = ary.length;
			var i = num - 1;
			function f(){
				var follower = bbs_dictionary.getResponse(ary[i].getNumber());
				follower.erase();

				i --;
				if(i >= 0){
					execute_queue.attachFirst(f,null);
				}else{
					_container.release();
				}
			}
			execute_queue.attachFirst(f,null);
		}

		// --------------------------------------------------------------------------------
		// クリックイベントを外す（内部用）
		// --------------------------------------------------------------------------------
		function removeEventClick(){
			if(_element.removeEventListener){
				_element.removeEventListener("click",mouseClick);
			}else if(_element.detachEvent){
				_element.detachEvent("onclick",mouseClick);
			}
		}

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _element;
		var _text_node;
		var _analyze_work;
		var _observer_remove;
		var _response;
		var _event_handler_update;
		var _event_handler_release;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			if(element){
				_element = element;
				element = null;
			}else{
				_element = DocumentCreateElement("span");
			}

			if(_element.addEventListener){
				_element.addEventListener("click",mouseClick);
			}else if(_element.attachEvent){
				_element.attachEvent("onclick",mouseClick);
			}

			// 解析ワーク作成
			_analyze_work = AnalyzeWorkCreate(_element);
			// 掲示板コントロール登録
			AnalyzeWorkSetBbsControl(_analyze_work,_container);
			// 解析済み
			AnalyzeWorkSetInvalid(_analyze_work);
			// 解析辞書登録
			analyze_work_dictionary.attachAnalyzeWork(_analyze_work,outsider);

			// リムーブ監視
			_observer_remove = new DomNodeObserverRemoveFromDocument(_element);
			_observer_remove.setFunction(_container.release);
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロール Follower の存在確認
	// --------------------------------------------------------------------------------
	function BbsControlFollowerExist(element){
		var nodes = ElementGetElementsByTagName(element,"*");
		var i;
		var num = nodes.length;
		for(i=0;i<num;i++){
			// 解析ワーク取得
			var work = analyze_work_dictionary.getAnalyzeWork(nodes[i]);
			if(work){
				var control = AnalyzeWorkGetBbsControl(work);
				if(control){
					if(control.getType() == "follower"){
						return true;
					}
				}
			}
		}
		return false;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロール Follower の検索
	// --------------------------------------------------------------------------------
	function BbsControlFollowerSearch(element,func){
		var result = null;
		var nodes = ElementGetElementsByTagName(element,"*");
		var i;
		var num = nodes.length;
		for(i=0;i<num;i++){
			// 解析ワーク取得
			var work = analyze_work_dictionary.getAnalyzeWork(nodes[i]);
			if(work){
				var control = AnalyzeWorkGetBbsControl(work);
				if(control){
					if(control.getType() == "follower"){
						result = func(control);
						if(result){
							return result;
						}
					}
				}
			}
		}
		return result;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロール ReadMoreButton
	// --------------------------------------------------------------------------------
	function BbsControlReadMoreButton(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// タイプを取得
		// --------------------------------------------------------------------------------
		_container.getType = function(id){
			return "read_more";
		};

		// --------------------------------------------------------------------------------
		// 開放
		// --------------------------------------------------------------------------------
		_container.release = function(){

			// リムーブ監視を破棄
			if(_observer_remove){
				_observer_remove.release();
				_observer_remove = null;
			}

			if(_analyze_work){
				// 解析辞書除外
				AnalyzeWorkClearBbsControl(_analyze_work);
				analyze_work_dictionary.removeAnalyzeWork(_analyze_work);
				_analyze_work = null;
			}

			if(_element){
				if(_element.removeEventListener){
					_element.removeEventListener("click",mouseClick);
				}else if(_element.detachEvent){
					_element.detachEvent("onclick",mouseClick);
				}
				DomNodeRemove(_element);
				_element = null;
			}
		};

		// --------------------------------------------------------------------------------
		// 要素取得
		// --------------------------------------------------------------------------------
		_container.getElement = function(){
			return _element;
		};

		// --------------------------------------------------------------------------------
		// 待機時間を設定 (単位:ミリ秒)
		// --------------------------------------------------------------------------------
		_container.setWaitTime = function(v){
			_wait_time = v;
		};

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		_container.init = function(){
			_element.value = "Read More";
			_element.disabled = false;
			_timer = _getTime();
			if(_task){
				_task.release();
				_task = null;
			}
		};

		// --------------------------------------------------------------------------------
		// マウスクリック時に実行される関数（内部用）
		// --------------------------------------------------------------------------------
		function mouseClick(e){
			if(_task)	return;

			_element.disabled = true;

			// タスク生成
			_task = task_container.createTask();
			_task.setExecuteFunc(function(){
				var time_sub = _getTime() - _timer;

				var t = Math.ceil((_wait_time - time_sub) / 1000);
				if(t < 0)	t = 0;
				_element.value = "wait ... " + t;

				if(time_sub > _wait_time){
					_task.release();
					_task = null;

					_element.value = "loading...";
					if(_container.onclick){
						_container.onclick();
					}
				}
			});
		}

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _element;
		var _task;
		var _onclick;
		var _timer;
		var _wait_time;
		var _analyze_work;
		var _observer_remove;
		var _getTime;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_container.onclick = null;
			_timer = 0;
			_wait_time = 5000;

			// ボタン
			_element = DocumentCreateElement("input");
			_element.type = "button";
			ElementSetStyle(_element,"width:100%; height:50px; margin:25px 0px; padding:0px;");

			if(_element.addEventListener){
				_element.addEventListener("click",mouseClick);
			}else if(_element.attachEvent){
				_element.attachEvent("onclick",mouseClick);
			}
			// 解析ワーク作成
			_analyze_work = AnalyzeWorkCreate(_element);
			// 掲示板コントロール登録
			AnalyzeWorkSetBbsControl(_analyze_work,_container);
			// 解析済み
			AnalyzeWorkSetInvalid(_analyze_work);
			// 解析辞書登録
			analyze_work_dictionary.attachAnalyzeWork(_analyze_work,true);

			// リムーブ監視
			_observer_remove = new DomNodeObserverRemoveFromDocument(_element);
			_observer_remove.setFunction(_container.release);

			// 時間取得関数
			_getTime = Date.now;
			if(!_getTime)	_getTime = function(){ return (new Date()).getTime(); };

			_container.init();
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// 掲示板コントロールの不要物検索
	// --------------------------------------------------------------------------------
	function BbsControlSearchTrash(element,func){
		var result = null;
		var nodes = ElementGetElementsByTagName(element,"*");
		var i;
		var num = nodes.length;
		for(i=num-1;i>=0;i--){
			// 解析ワーク取得
			if(analyze_work_dictionary.verifyRemoved(nodes[i])){
				result = func(nodes[i]);
				if(result){
					return result;
				}
			}
		}
		return result;
	}

	// --------------------------------------------------------------------------------
	// レスアンカー番号管理
	// --------------------------------------------------------------------------------
	function ResponseAnchorNumbers(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// 番号追加
		// --------------------------------------------------------------------------------
		_container.addNumber = function(number){
			var p;
			var n;
			var list = _list.n;
			while(list != _list){
				if(list.num >= number)	break;
				list = list.n;
			}

			if((list != _list) && (list.num == number)){
			}else{
				var list_min = {num:number,d:0};
				n = list;
				p = n.p;
				list_min.p = p;
				list_min.n = n;
				p.n = list_min;
				n.p = list_min;
			}
		};

		// --------------------------------------------------------------------------------
		// 範囲追加
		// --------------------------------------------------------------------------------
		_container.addNumbers = function(min,max){
			if(min > max){
				var t = max;
				max = min;
				min = t;
			}
			var p;
			var n;
			var list = _list.n;
			while(list != _list){
				if(list.num >= min)	break;
				list = list.n;
			}

			// 最小値
			if((list != _list) && (list.num == min)){
				list.d += 1;
			}else{
				var list_min = {num:min,d:1};
				n = list;
				p = n.p;
				list_min.p = p;
				list_min.n = n;
				p.n = list_min;
				n.p = list_min;
				list = list_min;
			}

			while(list != _list){
				if(list.num >= max)	break;
				list = list.n;
			}

			// 最大値
			if((list != _list) && (list.num == max)){
				list.d -= 1;
			}else{
				var list_max = {num:max,d:-1};
				n = list;
				p = n.p;
				list_max.p = p;
				list_max.n = n;
				p.n = list_max;
				n.p = list_max;
			}
		};

		// --------------------------------------------------------------------------------
		// すべての番号を取得
		// --------------------------------------------------------------------------------
		_container.getNumbers = function(func){
			var d = 0;
			var min = 0;
			var max = 0;
			var list = _list.n;
			while(list != _list){

				d += list.d;

				if(d == 0){
					func(list.num);
				}else if(d > 0){
					min = list.num;

					list = list.n;
					while(list != _list){
						d += list.d;
						if(d == 0){
							max = list.num + 1;
							break;
						}
						list = list.n;
					}
					
					var i;
					for(i=min;i<max;i++){
						func(i);
					}
				}

				list = list.n;
			}
		};

		// --------------------------------------------------------------------------------
		// すべての番号を配列形式で取得
		// --------------------------------------------------------------------------------
		_container.getNumberList = function(){
			var a = new Array();
			var d = 0;
			var min = 0;
			var max = 0;
			var list = _list.n;
			while(list != _list){

				d += list.d;

				if(d == 0){
					a.push(list.num);
				}else if(d > 0){
					min = list.num;

					list = list.n;
					while(list != _list){
						d += list.d;
						if(d == 0){
							max = list.num + 1;
							break;
						}
						list = list.n;
					}
					
					var i;
					for(i=min;i<max;i++){
						a.push(i);
					}
				}

				list = list.n;
			}
			return a;
		};

		// --------------------------------------------------------------------------------
		// 総数を取得
		// --------------------------------------------------------------------------------
		_container.getCount = function(){
			var count = 0;
			var d = 0;
			var min = 0;
			var max = 0;
			var list = _list.n;
			while(list != _list){

				d += list.d;

				if(d == 0){
					count += 1;
				}else if(d > 0){
					min = list.num;

					list = list.n;
					while(list != _list){
						d += list.d;
						if(d == 0){
							max = list.num + 1;
							break;
						}
						list = list.n;
					}
					count += max - min;
				}

				list = list.n;
			}
			return count;
		};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _list;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_list = new Object();
			_list.p = _list;
			_list.n = _list;
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// アンカーの更新監視
	// --------------------------------------------------------------------------------
	function AnchorMonitor(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// 要素生成
		// --------------------------------------------------------------------------------
		_container.createElement = function(){
			var _element = new Object();

			// --------------------------------------------------------------------------------
			// コールバック関数をセット
			// --------------------------------------------------------------------------------
			_element.setFunction = function(f){
				_element.callback = f;
			};

			// --------------------------------------------------------------------------------
			// URL を設定
			// --------------------------------------------------------------------------------
			_element.setBaseUrl = function(url){
				_element.base_url = url;
			};

			// --------------------------------------------------------------------------------
			// 要素をセット
			// --------------------------------------------------------------------------------
			_element.setAnchorElement = function(anchor){
				_element.anchor_element = anchor;
				_element.base_url = anchor.href;

				if(MutationObserverSupported()){
					_mutation_observer = MutationObserverCreate(function(mutations) {
						var i;
						var num = mutations.length;
						for(i=0;i<num;i++){
							var target = mutations[i].target;
							if(_element.base_url != target.href){
								_element.base_url = target.href;
								_element.callback();
								return;
							}
						}
					});
					_mutation_observer.observe(anchor,{attributes:true,attributeFilter:["href"]});
				}
			};

			// --------------------------------------------------------------------------------
			// 開放
			// --------------------------------------------------------------------------------
			_element.release = function(){
				if(_list == _element){
					_list = _element.next;
				}
				var next = _element.next;
				var prev = _element.prev;
				prev.next = next;
				next.prev = prev;
				_element.prev = _element;
				_element.next = _element;
				_count --;

				if(_mutation_observer){
					_mutation_observer.disconnect();
					_mutation_observer = null;
				}
			};

			// --------------------------------------------------------------------------------
			// プライベート変数
			// --------------------------------------------------------------------------------
			var _mutation_observer;

			// --------------------------------------------------------------------------------
			// 初期化
			// --------------------------------------------------------------------------------
			(function(){
				_element.callback = null;
				_element.anchor_element = null;
				_element.base_url = null;

				var next = _list;
				var prev = next.prev;
				prev.next = _element;
				next.prev = _element;
				_element.prev = prev;
				_element.next = next;
				_count++;
			})();

			return _element;
		};

		// --------------------------------------------------------------------------------
		// 実行
		// --------------------------------------------------------------------------------
		_container.execute = function(){
			var i = 0;
			var num = 5;
			var start = _list;
			do{
				if(_list.anchor_element){
					if(_list.base_url != _list.anchor_element.href){
						_list.base_url = _list.anchor_element.href;
						_list.callback();
					}
				}
				_list = _list.next;
				i ++;
				if(num <= i)	break;
			}while(start != _list);
		};

		// --------------------------------------------------------------------------------
		// 要素数を取得
		// --------------------------------------------------------------------------------
		_container.getCount = function(){
			return _count;
		};

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _ring_list;
		var _list;
		var _count;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_ring_list = new Object();
			_ring_list.prev = _ring_list;
			_ring_list.next = _ring_list;
			_list = _ring_list;

			_count = 0;
		})();

		return _container;
	}


	// --------------------------------------------------------------------------------
	// InternetExplorer を使用しているか
	// --------------------------------------------------------------------------------
	function UserAgentGetInternetExplorer(){
		if(window.navigator.userAgent.indexOf("Sleipnir") != -1)	return false;
		return (window.navigator.userAgent.indexOf("MSIE") != -1);
	}

	// --------------------------------------------------------------------------------
	// Firefox を使用しているか
	// --------------------------------------------------------------------------------
	function UserAgentGetFirefox(){
		return (window.navigator.userAgent.indexOf("Firefox") != -1);
	}

	// --------------------------------------------------------------------------------
	// GoogleChrome を使用しているか
	// --------------------------------------------------------------------------------
	function UserAgentGetGoogleChrome(){
		return (window.navigator.userAgent.indexOf("Chrome") != -1);
	}

	// --------------------------------------------------------------------------------
	// Opera を使用しているか
	// --------------------------------------------------------------------------------
	function UserAgentGetOpera(){
		return (window.navigator.userAgent.indexOf("Opera") != -1);
	}

	// --------------------------------------------------------------------------------
	// Safari を使用しているか
	// --------------------------------------------------------------------------------
	function UserAgentGetSafari(){
		if(window.navigator.userAgent.indexOf("Chrome") != -1)	return false;
		return (window.navigator.userAgent.indexOf("Safari") != -1);
	}

	// --------------------------------------------------------------------------------
	// Sleipnir を使用しているか
	// --------------------------------------------------------------------------------
	function UserAgentGetSleipnir(){
		return (window.navigator.userAgent.indexOf("Sleipnir") != -1);
	}

	// --------------------------------------------------------------------------------
	// ブラウザの言語を調べる
	// --------------------------------------------------------------------------------
	function NavigatorGetBrowserLanguage() {
		try {
			return (window.navigator.browserLanguage || window.navigator.language || window.navigator.userLanguage).substr(0,2);
		}
		catch(e) {
			return undefined;
		}
	}

	// --------------------------------------------------------------------------------
	// XMLHttpRequest オブジェクトを作成する関数
	// --------------------------------------------------------------------------------
	function XMLHttpRequestCreate(){
		try{
			return new XMLHttpRequest();
		}catch(e){}
		try{
			return new ActiveXObject('MSXML2.XMLHTTP.6.0');
		}catch(e){}
		try{
			return new ActiveXObject('MSXML2.XMLHTTP.3.0');
		}catch(e){}
		try{
			return new ActiveXObject('MSXML2.XMLHTTP');
		}catch(e){}

		return null;
	}


	// --------------------------------------------------------------------------------
	// コンソールにログ出力
	// --------------------------------------------------------------------------------
	function ConsoleLog(obj){
		try{
			console.log(obj);
		}catch(e){}
	}

	// --------------------------------------------------------------------------------
	// コンソールにエラー出力
	// --------------------------------------------------------------------------------
	function ConsoleError(obj){
		try{
			console.error(obj);
		}catch(e){}
	}

	// --------------------------------------------------------------------------------
	// 文字列から DOMParser を作成
	// --------------------------------------------------------------------------------
	function DOMParserCreateFromString(text){
		if (window.DOMParser){
			var parser = new DOMParser();
			return parser.parseFromString(text,"application/xml");
		}
		try{
			var xml_doc = new ActiveXObject("Microsoft.XMLDOM");
			xml_doc.async = false;
			xml_doc.loadXML(text);
			return xml_doc;
		}catch(e){}

		return null;
	}

	// --------------------------------------------------------------------------------
	// MutationObserver が利用可能か
	// --------------------------------------------------------------------------------
	function MutationObserverSupported(){
		try{
			if(window.MutationObserver || window.WebKitMutationObserver){
				return true;
			}
		}catch(e){
		}
		return false;
	}

	// --------------------------------------------------------------------------------
	// MutationObserver を作成
	// --------------------------------------------------------------------------------
	function MutationObserverCreate(func){
		try{
			var MutationObserver = window.MutationObserver || window.WebKitMutationObserver;
			var mutation_observer = new MutationObserver(func);
			return mutation_observer;
		}catch(e){
		}
		return null;
	}

	// --------------------------------------------------------------------------------
	// JSON が利用可能か
	// --------------------------------------------------------------------------------
	function JSONSupported(){
		try{
			if(JSON)	return true;
		}catch(e){
		}
		return false;
	}

	// --------------------------------------------------------------------------------
	// Object から JSON 文字列に変換
	// --------------------------------------------------------------------------------
	function JsonStringify(obj){
		if(JSONSupported()){
			return JSON.stringify(obj);
		}
		return "";
	}

	// --------------------------------------------------------------------------------
	// JSON 文字列 から Object に変換
	// --------------------------------------------------------------------------------
	function JsonParse(str){
		if(JSONSupported()){
			return JSON.parse(str);
		}
		return {};
	}

	// --------------------------------------------------------------------------------
	// バイナリから Base64 文字列に変換する (同期実行)
	// --------------------------------------------------------------------------------
	function Base64FromArrayBuffer(ary_buffer){
		var dic = [
			'A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P',
			'Q','R','S','T','U','V','W','X','Y','Z','a','b','c','d','e','f',
			'g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v',
			'w','x','y','z','0','1','2','3','4','5','6','7','8','9','+','/'
		];
		var str = "";
		var num = ary_buffer.byteLength;
		var a = new Uint8Array(ary_buffer);
		var i;
		var m = 0;
		var n = 0;
		for(i=0;i<num;i++){
			switch(m){
			case 0:
				str += dic[(a[i] >> 2)];
				n = (a[i] & 0x03) << 4;
				m = 2;
				break;
			case 2:
				str += dic[n | (a[i] >> 4)];
				n = (a[i] & 0x0f) << 2;
				m = 1;
				break;
			case 1:
				str += dic[n | (a[i] >> 6)];
				str += dic[(a[i] & 0x3f)];
				m = 0;
				break;
			}
		}
		if(m){
			str += dic[n];
		}
		if(m == 2){
			str += "==";
		}else if(m == 1){
			str += "=";
		}
		return str;
	}

	// --------------------------------------------------------------------------------
	// バイナリから Base64 文字列に変換する (非同期実行)
	// --------------------------------------------------------------------------------
	function Base64FromArrayBufferAsync(ary_buffer,increment,callback){
		var dic = [
			'A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P',
			'Q','R','S','T','U','V','W','X','Y','Z','a','b','c','d','e','f',
			'g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v',
			'w','x','y','z','0','1','2','3','4','5','6','7','8','9','+','/'
		];
		var str = "";
		var num = ary_buffer.byteLength;
		var a = new Uint8Array(ary_buffer);
		var i = 0;
		var j = 0;
		var m = 0;
		var n = 0;

		function f(){
			while(i<num){
				switch(m){
				case 0:
					str += dic[(a[i] >> 2)];
					n = (a[i] & 0x03) << 4;
					m = 2;
					break;
				case 2:
					str += dic[n | (a[i] >> 4)];
					n = (a[i] & 0x0f) << 2;
					m = 1;
					break;
				case 1:
					str += dic[n | (a[i] >> 6)];
					str += dic[(a[i] & 0x3f)];
					m = 0;
					break;
				}

				i ++;
				j ++;
				if(j > increment){
					j = 0;
					execute_queue.attachFirst(f,null);
					return;
				}
			}
			if(m){
				str += dic[n];
			}
			if(m == 2){
				str += "==";
			}else if(m == 1){
				str += "=";
			}
			callback(str);
		}

		execute_queue.attachLast(f,null);
	}

	// --------------------------------------------------------------------------------
	// x-user-defined 文字列から Base64 文字列に変換する (同期実行)
	// --------------------------------------------------------------------------------
	function Base64_From_UserDefined(user_defined){
		var dic = [
			'A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P',
			'Q','R','S','T','U','V','W','X','Y','Z','a','b','c','d','e','f',
			'g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v',
			'w','x','y','z','0','1','2','3','4','5','6','7','8','9','+','/'
		];
		var str = "";
		var num = str.length;
		var a = user_defined;
		var i;
		var m = 0;
		var n = 0;
		var b = 0;
		for(i=0;i<num;i++){
			b = a.charCodeAt(i) & 0xff;
			switch(m){
			case 0:
				str += dic[(b >> 2)];
				n = (b & 0x03) << 4;
				m = 2;
				break;
			case 2:
				str += dic[n | (b >> 4)];
				n = (b & 0x0f) << 2;
				m = 1;
				break;
			case 1:
				str += dic[n | (b >> 6)];
				str += dic[(b & 0x3f)];
				m = 0;
				break;
			}
		}
		if(m){
			str += dic[n];
		}
		if(m == 2){
			str += "==";
		}else if(m == 1){
			str += "=";
		}
		return str;
	}

	// --------------------------------------------------------------------------------
	// x-user-defined 文字列から Base64 文字列に変換する (非同期実行)
	// --------------------------------------------------------------------------------
	function Base64FromUserDefinedAsync(user_defined,increment,callback){
		var dic = [
			'A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P',
			'Q','R','S','T','U','V','W','X','Y','Z','a','b','c','d','e','f',
			'g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v',
			'w','x','y','z','0','1','2','3','4','5','6','7','8','9','+','/'
		];
		var str = "";
		var num = user_defined.length;
		var a = user_defined;
		var i = 0;
		var j = 0;
		var m = 0;
		var n = 0;
		var b = 0;
		function f(){
			while(i<num){
				b = a.charCodeAt(i) & 0xff;
				switch(m){
				case 0:
					str += dic[(b >> 2)];
					n = (b & 0x03) << 4;
					m = 2;
					break;
				case 2:
					str += dic[n | (b >> 4)];
					n = (b & 0x0f) << 2;
					m = 1;
					break;
				case 1:
					str += dic[n | (b >> 6)];
					str += dic[(b & 0x3f)];
					m = 0;
					break;
				}

				i ++;
				j ++;
				if(j > increment){
					j = 0;
					execute_queue.attachFirst(f,null);
					return;
				}
			}
			if(m){
				str += dic[n];
			}
			if(m == 2){
				str += "==";
			}else if(m == 1){
				str += "=";
			}
			callback(str);
		}

		execute_queue.attachLast(f,null);
	}

	// --------------------------------------------------------------------------------
	// レスポンスヘッダから Object に変換
	// --------------------------------------------------------------------------------
	function ResponseHeadersParseObject(str){
		var o = new Object();
		if(!str)	return o;

		// 改行コードを統一
		var s = str.replace(/\r\n?/g,"\n");
		var a = s.split("\n");
		var i;
		var num = a.length;
		for(i=0;i<num;i++){
			var m = a[i].match(new RegExp("^(.*):[ ](.*)$","i"));
			if(m){
				o[m[1]] = m[2];
			}
		}
		return o;
	}

	// --------------------------------------------------------------------------------
	// Trixie のユーザースクリプトとして動作しているか
	// --------------------------------------------------------------------------------
	function ExecuteAsTrixieUserScript(){
		return false;
	}


	// --------------------------------------------------------------------------------
	// ローカルストレージからロード
	// --------------------------------------------------------------------------------
	function LocalStorageGetItem(key,func){

		function LocalStorageLoad(){
			try{
				if(window.localStorage){
					func({result:true,value:localStorage.getItem(key)});
				}else{
					func({result:false,message:"Do not support storage."});
				}
			}catch(e){
				func({result:false,message:e});
			}
		}

		LocalStorageLoad();
	}

	// --------------------------------------------------------------------------------
	// ローカルストレージからセーブ
	// --------------------------------------------------------------------------------
	function LocalStorageSetItem(key,str,func){

		function LocalStorageSave(){
			try{
				if(window.localStorage){
					localStorage.setItem(key,str);
					func({result:true});
				}else{
					func({result:false,message:"Do not support storage."});
				}
			}catch(e){
				func({result:false,message:e});
			}
		}

		LocalStorageSave();
	}

	// --------------------------------------------------------------------------------
	// ローカルストレージから削除
	// --------------------------------------------------------------------------------
	function LocalStorageRemoveItem(key,func){

		function LocalStorageDelete(){
			try{
				if(window.localStorage){
					localStorage.removeItem(key);
					func({result:true});
				}else{
					func({result:false,message:"Do not support storage."});
				}
			}catch(e){
				func({result:false,message:e});
			}
		}

		LocalStorageDelete();
	}

	// --------------------------------------------------------------------------------
	// 同期ストレージからロード
	// --------------------------------------------------------------------------------
	function SyncStorageGetItem(key,func){
	}

	// --------------------------------------------------------------------------------
	// 同期ストレージからセーブ
	// --------------------------------------------------------------------------------
	function SyncStorageSetItem(key,str,func){
	}

	// --------------------------------------------------------------------------------
	// 同期ストレージから削除
	// --------------------------------------------------------------------------------
	function SyncStorageRemoveItem(key,func){
	}

	// --------------------------------------------------------------------------------
	// 全角アルファベットから半角アルファベットに変換
	// --------------------------------------------------------------------------------
	function StringConvertFromAlphabeticFullToAlphabeticHalf(s){

		var r;
		r = new RegExp("[ａ-ｚＡ-Ｚ]","g");
		return s.replace(r, function(c){
			return String.fromCharCode(c.charCodeAt(0) - 65248);
		});
	}

	// --------------------------------------------------------------------------------
	// 半角アルファベットから全角アルファベットに変換
	// --------------------------------------------------------------------------------
	function StringConvertFromAlphabeticHalfToAlphabeticFull(s){

		var r;
		r = new RegExp("[a-zA-Z-.]","g");
		return s.replace(r, function(c){
			return String.fromCharCode(c.charCodeAt(0) + 65248);
		});
	}

	// --------------------------------------------------------------------------------
	// 全角数字から半角数字に変換
	// --------------------------------------------------------------------------------
	function StringConvertFromNumericFullToNumericHalf(s){

		var r;
		r = new RegExp("[０-９－．]","g");
		return s.replace(r, function(c){
			return String.fromCharCode(c.charCodeAt(0) - 65248);
		});
	}

	// --------------------------------------------------------------------------------
	// 半角英数字から全角英数字に変換
	// --------------------------------------------------------------------------------
	function StringConvertFromNumericHalfToNumericFull(s){

		var r;
		r = new RegExp("[0-9]","g");
		return s.replace(r, function(c){
			return String.fromCharCode(c.charCodeAt(0) + 65248);
		});
	}

	// --------------------------------------------------------------------------------
	// 全角記号から半角記号に変換
	// --------------------------------------------------------------------------------
	function StringConvertFromSignFullToSignHalf(s){
		s = s.replace(/”/g, "\"");
		s = s.replace(/’/g, "\'");
		s = s.replace(/￥/g, "\\");
		var r = new RegExp("[！-／：-＠［-｀｛-～]","g");
		return s.replace(r, function(c){
			return String.fromCharCode(c.charCodeAt(0) - 65248);
		});
	}

	// --------------------------------------------------------------------------------
	// 半角記号から全角記号に変換
	// --------------------------------------------------------------------------------
	function StringConvertFromSignHalfToSignFull(s){
		s = s.replace(/\"/g, "”");
		s = s.replace(/\'/g, "’");
		s = s.replace(/\\/g, "￥");
		var r = new RegExp("[!-/:-@\[-`\{-~]","g");
		return s.replace(r, function(c){
			return String.fromCharCode(c.charCodeAt(0) + 65248);
		});
	}

	// --------------------------------------------------------------------------------
	// 全角スペースから半角スペースに変換
	// --------------------------------------------------------------------------------
	function StringConvertFromSpaceFullToSpaceHalf(s){
		return s.replace(/　/g, " ");
	}

	// --------------------------------------------------------------------------------
	// 半角スペースから全角スペースに変換
	// --------------------------------------------------------------------------------
	function StringConvertFromSpaceHalfToSpaceFull(s){
		return s.replace(/ /g, "　");
	}

	// --------------------------------------------------------------------------------
	// 半角カタカナから全角カタカナに変換
	// --------------------------------------------------------------------------------
	function StringConvertFromKatakanaFullToKatakanaHalf(s){
		var r;
		var code;
		var data;

		// 濁点
		data = ["ガ","ギ","グ","ゲ","ゴ","ザ","ジ","ズ","ゼ","ゾ","ダ","ヂ","ヅ","デ","ド","バ","ビ","ブ","ベ","ボ"];
		r = new RegExp("ｶﾞ|ｷﾞ|ｸﾞ|ｹﾞ|ｺﾞ|ｻﾞ|ｼﾞ|ｽﾞ|ｾﾞ|ｿﾞ|ﾀﾞ|ﾁﾞ|ﾂﾞ|ﾃﾞ|ﾄﾞ|ﾊﾞ|ﾋﾞ|ﾌﾞ|ﾍﾞ|ﾎﾞ","g");
		s = s.replace(r, function(c){
			code = c.charCodeAt(0);
			if(code <= 65409)	return data[code-65398];
			if(code >= 65418)	return data[code-65418 + 15];
			return data[code-65410 + 12];
		});

		// 半濁点
		data = ["パ","ピ","プ","ペ","ポ"];
		r = new RegExp("ﾊﾟ|ﾋﾟ|ﾌﾟ|ﾍﾟ|ﾎﾟ","g");
		s = s.replace(r, function(c){
			code = c.charCodeAt(0);
			return data[code-65418];
		});

		// その他
		data = ["。","「","」","、","・","ヲ","ァ","ィ","ゥ","ェ","ォ","ャ","ュ","ョ","ッ","ー","ア","イ","ウ","エ","オ","カ","キ","ク","ケ","コ","サ","シ","ス","セ","ソ","タ","チ","ツ","テ","ト","ナ","ニ","ヌ","ネ","ノ","ハ","ヒ","フ","ヘ","ホ","マ","ミ","ム","メ","モ","ヤ","ユ","ヨ","ラ","リ","ル","レ","ロ","ワ","ン","゛","゜"];
		r = new RegExp("[｡-ﾟ]","g");
		s = s.replace(r, function(c){
			return data[c.charCodeAt(0)-65377];
		});

		return s;
	}

	// --------------------------------------------------------------------------------
	// 全角カタカナから半角カタカナに変換
	// --------------------------------------------------------------------------------
	function StringConvertFromKatakanaHalfToKatakanaFull(s){
		var data = new Object();
		data["。"] = "｡"; data["「"] = "｢"; data["」"] = "｣"; data["、"] = "､"; data["・"] = "･";
		data["ヲ"] = "ｦ";
		data["ァ"] = "ｧ"; data["ィ"] = "ｨ"; data["ゥ"] = "ｩ"; data["ェ"] = "ｪ"; data["ォ"] = "ｫ";
		data["ャ"] = "ｬ"; data["ュ"] = "ｭ"; data["ョ"] = "ｮ"; data["ッ"] = "ｯ"; data["ー"] = "ｰ"; 
		data["ア"] = "ｱ"; data["イ"] = "ｲ"; data["ウ"] = "ｳ"; data["エ"] = "ｴ"; data["オ"] = "ｵ"; 
		data["カ"] = "ｶ"; data["キ"] = "ｷ"; data["ク"] = "ｸ"; data["ケ"] = "ｹ"; data["コ"] = "ｺ";
		data["サ"] = "ｻ"; data["シ"] = "ｼ"; data["ス"] = "ｽ"; data["セ"] = "ｾ"; data["ソ"] = "ｿ";
		data["タ"] = "ﾀ"; data["チ"] = "ﾁ"; data["ツ"] = "ﾂ"; data["テ"] = "ﾃ"; data["ト"] = "ﾄ";
		data["ナ"] = "ﾅ"; data["ニ"] = "ﾆ"; data["ヌ"] = "ﾇ"; data["ネ"] = "ﾈ"; data["ノ"] = "ﾉ";
		data["ハ"] = "ﾊ"; data["ヒ"] = "ﾋ"; data["フ"] = "ﾌ"; data["ヘ"] = "ﾍ"; data["ホ"] = "ﾎ";
		data["マ"] = "ﾏ"; data["ミ"] = "ﾐ"; data["ム"] = "ﾑ"; data["メ"] = "ﾒ"; data["モ"] = "ﾓ";
		data["ヤ"] = "ﾔ"; data["ユ"] = "ﾕ"; data["ヨ"] = "ﾖ";
		data["ラ"] = "ﾗ"; data["リ"] = "ﾘ"; data["ル"] = "ﾙ"; data["レ"] = "ﾚ"; data["ロ"] = "ﾛ";
		data["ワ"] = "ﾜ"; data["ン"] = "ﾝ"; data["゛"] = "ﾞ"; data["゜"] = "ﾟ";
		data["ガ"] = "ｶﾞ"; data["ギ"] = "ｷﾞ"; data["グ"] = "ｸﾞ"; data["ゲ"] = "ｹﾞ"; data["ゴ"] = "ｺﾞ";
		data["ザ"] = "ｻﾞ"; data["ジ"] = "ｼﾞ"; data["ズ"] = "ｽﾞ"; data["ゼ"] = "ｾﾞ"; data["ゾ"] = "ｿﾞ";
		data["ダ"] = "ﾀﾞ"; data["ヂ"] = "ﾁﾞ"; data["ヅ"] = "ﾂﾞ"; data["デ"] = "ﾃﾞ"; data["ド"] = "ﾄﾞ";
		data["バ"] = "ﾊﾞ"; data["ビ"] = "ﾋﾞ"; data["ブ"] = "ﾌﾞ"; data["ベ"] = "ﾍﾞ"; data["ボ"] = "ﾎﾞ";
		data["パ"] = "ﾊﾟ"; data["ピ"] = "ﾋﾟ"; data["プ"] = "ﾌﾟ"; data["ペ"] = "ﾍﾟ"; data["ポ"] = "ﾎﾟ";
		var r = new RegExp("[、。「」゛゜ァ-ロワヲン・ー]","g");
		return s.replace(r, function(c){
			return data[c];
		});
	}

	// --------------------------------------------------------------------------------
	// ひらがなからカタカナに変換
	// --------------------------------------------------------------------------------
	function StringConvertFromHiraganaToKatakana(s){
		var r = new RegExp("[ぁ-ん]","g");
		return s.replace(r, function(c){
			return String.fromCharCode(c.charCodeAt(0) + 96);
		});
	}

	// --------------------------------------------------------------------------------
	// カタカナからひらがなに変換
	// --------------------------------------------------------------------------------
	function StringConvertFromKatakanaToHiragana(s){
		var r = new RegExp("[ァ-ン]","g");
		return s.replace(r, function(c){
			return String.fromCharCode(c.charCodeAt(0) - 96);
		});
	}

	// --------------------------------------------------------------------------------
	// 文字列を評価して配列関数を作成
	// --------------------------------------------------------------------------------
	function StringEvalArrayFunction(src){
		try{
			var a = eval(src);

			if(typeof(a) == "function")	return [a];

			var check = false;
			if(typeof(a) == "object"){
				if(a.constructor == Array){
					var ary = new Array();
					var i;
					var num = a.length;
					for(i=0;i<num;i++){
						if(typeof(a[i]) == "function"){
							ary.push(a[i]);
						}
					}

					return ary;
				}
			}

		}catch(e){}

		return [];
	}

	// --------------------------------------------------------------------------------
	// 文字列からクエリーを取得
	// --------------------------------------------------------------------------------
	function StringGetQuery(url){
		var q = new Object();
		var m = url.match(new RegExp("[?](.*?)(#|$)"));
		if(!m)	return q;
		var a = m[1].split('&');
		var i;
		var num = a.length;
		for(i=0;i<num;i++){
			var b = a[i].split('=');
			if(b.length == 2){
				q[b[0]] = b[1];
			}
		}
		return q;
	}

	// --------------------------------------------------------------------------------
	// 文字列とアスタリスク付きワードとが一致するか調べる
	// --------------------------------------------------------------------------------
	function StringMatchAsteriskWord(src,w){
		var i_num = src.length;
		var j_num = w.length;
		var i=0;
		var j=0;
		var n;
		var l;
		n = w.indexOf("*");
		if(n < 0){
			return (src == w);
		}else if(n > 0){
			var l = n - j;
			n = src.indexOf(w.substring(j,n),i);
			if(n != 0){
				return false;
			}
			i = n + l;
			j = j + l;
		}
		while(true){
			while(true){
				j ++;
				n = w.indexOf("*",j);
				if(n != j ){
					break;
				}
			}
			if(n < 0){
				if(j >= j_num){
					return true;
				}else{
					n = j_num;
				}
			}
			l = n - j;
			n = src.indexOf(w.substring(j,n),i);
			if(n < 0){
				return false;
			}
			i = n + l;
			j = j + l ;
		}
		return false;
	}

	// --------------------------------------------------------------------------------
	// URL 文字列とアスタリスク付きワードとが一致するか調べる
	// --------------------------------------------------------------------------------
	function StringUrlMatchAsteriskWord(src,w){

		var ary = new Array();
		var r = new RegExp(":|\/|[.]|[?]|#|[*]+","i");
		while(true){
			var m = w.match(r);
			if(m){
				if(RegExp.leftContext){
					ary.push(RegExp.leftContext);
				}
				if(m[0].charAt(0) == '*')	ary.push('*');
				else						ary.push(m[0]);
				w = RegExp.rightContext;
				continue;
			}
			if(w){
				ary.push(w);
			}
			break;
		}

		var i;
		var num = src.length;
		var p = 0;
		while(true){
			w = ary.shift();
			if(!w){
				if(p >= num)	return true;
				return false;
			}
			if(w == '*'){
				w = ary.shift();
				if(!w)	return true;

				i = src.indexOf(w,p);
				if(i < 0)	return false;
				p = i + w.length;
			}else{
				if(src.indexOf(w,p) != p)	return false;
				p += w.length;
			}
		}
	}

	// --------------------------------------------------------------------------------
	// URLアスタリスク付きワードから正規表現配列を取得
	// --------------------------------------------------------------------------------
	function StringRegExpListFromAsteriskWord(w){

		var str = "^";
		var ary = new Array();
		var r = new RegExp(":|\/|[.]|[?]|#|[*]+");

		while(true){
			var m = w.match(r);
			if(m){
				if(m[0].charAt(0) == '*'){
					str += RegExp.leftContext + ".*?";
				}else{
					str += RegExp.leftContext + "[" + m[0] + "]";
					ary.push(new RegExp(str));
					str = "^";
				}
				w = RegExp.rightContext;
			}else{
				m = w.match(new RegExp("(.*)$"));
				if(m[0] || (str.length > 1)){
					str += m[0] + "$";
					ary.push(new RegExp(str));
					break;
				}
				break;
			}
		}
		return ary;
	}

	// --------------------------------------------------------------------------------
	// URL 文字列とアスタリスク付きワードとが一致するか調べる
	// --------------------------------------------------------------------------------
	function StringUrlMatchRegExpList(src,ary){
		var i;
		var num = ary.length;
		var m;
		for(i=0;i<num;i++){
			m = src.match(ary[i]);
			if(!m)	return false;
			src = RegExp.rightContext;
		}

		if(src == "")	return true;
		return false;
	}

	// --------------------------------------------------------------------------------
	// HTML 文字列から DOM オブジェクトを生成（スクリプト要素 と イベントハンドラは除外）
	// --------------------------------------------------------------------------------
	function StringHtmlCreateDomNodesSafe(html){
		var nodes = new Array();
		var stack = new Array();

		var c;
		var b;
		var e;
		var p = 0;
		var l = html.length;
		
		var edit = {
			element:null,
			name:"",
			depth:0
		};
		stack.push(edit);

		try{
			while(true){
				// SCRIPT、STYLE
				if(edit.name == "SCRIPT" || edit.name == "STYLE"){

					while(true){

						// '<'
						while(l > p){
							c = html.charAt(p);
							p ++;
							if(c == '<'){
								break;
							}
						}
						if(p >= l)	throw("end");

						// 整形無視
						while(l > p){
							c = html.charAt(p);
							p ++;
							if(c == ' '){
							}else if(c == '　'){
							}else if(c == '\t'){
							}else if(c == '\r'){
							}else if(c == '\n'){
							}else{
								break;
							}
						}
						if(p >= l)	throw("end");

						// '/'
						if(c != '/')	continue;

						// 整形無視
						while(l > p){
							c = html.charAt(p);
							if(c == ' '){
							}else if(c == '　'){
							}else if(c == '\t'){
							}else if(c == '\r'){
							}else if(c == '\n'){
							}else{
								break;
							}
							p ++;
						}
						if(p >= l)	throw("end");

						// 要素名
						var tag_name = edit.name;
						if(html.substr(p,tag_name.length).toUpperCase() != tag_name)	continue;
						p += tag_name.length;

						// 整形無視
						while(l > p){
							c = html.charAt(p);
							p ++;
							if(c == ' '){
							}else if(c == '　'){
							}else if(c == '\t'){
							}else if(c == '\r'){
							}else if(c == '\n'){
							}else{
								break;
							}
						}
						if(p >= l)	throw("end");

						// '>'
						if(c != '>')	continue;
						if(html.charAt(p - 2) == '\\')	continue;

						// スタックポップ
						if(edit.depth){
							stack.pop();
							edit = stack[stack.length - 1];
						}
						break;
					}

				}

				// 要素の開始 '<'
				b = p;
				e = -1;
				while(l > p){
					c = html.charAt(p);
					p ++;
					if(c == '<'){
						e = p - 1;
						break;
					}
				}

				// テキストノード
				if(b < e){
					// テキストノード生成
					var s = html.substring(b,e);
					s = s.replace(/&gt;/g, ">");
					s = s.replace(/&lt;/g, "<");
					s = s.replace(/&quot;/g, "\"");
					s = s.replace(/&nbsp;/g, function(str) { return String.fromCharCode(0x00a0); });
					s = s.replace(/&#([0-9]+);/g, function(str) { return String.fromCharCode(RegExp.$1); });
					s = s.replace(/&amp;/g, "&");
					var text_node = document.createTextNode(s);
					if(text_node){
						if(edit.depth){
							if(edit.element){
								edit.element.appendChild(text_node);
							}
						}else{
							nodes.push(text_node);
						}
					}
				}
				if(p >= l)	throw("end");

				// コメント "<!--"
				if(html.substr(p,3) == "!--"){
					p += 3;
					e = html.indexOf("-->",p);
					if(e >= 0)	p = e + 3;
					continue;
				}

				// 名前の開始、要素の終了 '/'
				while(l > p){
					c = html.charCodeAt(p);
					p ++;
					if((0x41 <= c && c <= 0x5a) || (0x61 <= c && c <= 0x7a) || (c == 0x2f)){
						b = p - 1;
						break;
					}
				}
				if(p >= l)	throw("end");

				// 要素の終了 '/'
				if(c == 0x2f){

					// 名前の開始
					while(l > p){
						c = html.charCodeAt(p);
						p ++;
						if((0x41 <= c && c <= 0x5a) || (0x61 <= c && c <= 0x7a)){
							b = p - 1;
							break;
						}
					}
					if(p >= l)	throw("end");

					// 名前の終了
					while(l > p){
						c = html.charCodeAt(p);
						if((0x41 <= c && c <= 0x5a) || (0x61 <= c && c <= 0x7a) || (0x30 <= c && c <= 0x39)){
						}else{
							e = p;
							break;
						}
						p ++;
					}
					if(p >= l)	throw("end");

					// 要素名
					var tag_name = html.substring(b,e).toUpperCase();

					// 要素の終了 '>'
					while(l > p){
						c = html.charAt(p);
						p ++;
						if(c == '>'){
							break;
						}
					}

					// スタックポップ
					var i;
					b = e = stack.length;
					for(i=e-1;i>=0;i--){
						if(stack[i].name == tag_name){
							b = i;
							break;
						}
					}
					for(;b<e;b++){
						if(edit.depth){
							stack.pop();
							edit = stack[stack.length - 1];
						}
					}

				// 名前の開始
				}else{
					// 名前の終了
					while(l > p){
						c = html.charCodeAt(p);
						if((0x41 <= c && c <= 0x5a) || (0x61 <= c && c <= 0x7a) || (0x30 <= c && c <= 0x3a)){
						}else{
							e = p;
							break;
						}
						p ++;
					}
					if(p >= l)	throw("end");

					// 要素名
					var tag_name = html.substring(b,e).toUpperCase();

					// 要素終了
					var tag_list = ["LI","DT","DD"];
					var i;
					var j;
					var num = tag_list.length;
					for(i=0;i<num;i++){
						if(tag_name == tag_list[i]){
							break;
						}
					}
					if(i < num){
						b = e = stack.length;
						for(i=e-1;i>=0;i--){
							for(j=0;j<num;j++){
								if(stack[i].name == tag_list[j]){
									b = i;
									break;
								}
							}
						}
						for(;b<e;b++){
							if(edit.depth){
								stack.pop();
								edit = stack[stack.length - 1];
							}
						}
					}

					// 要素生成
					var parent = edit.element;
					var empty = false;
					var element = null;
					switch(tag_name){
					case "HTML":
					case "HEAD":
					case "BODY":
					case "SCRIPT":
					case "STYLE":
					case "IFRAME":
						break;
					default:
						element = document.createElement(tag_name);
						break;
					}
					if(element){
						if(edit.depth){
							if(parent && element){
								parent.appendChild(element);
							}
						}else{
							nodes.push(element);
						}
					}

					// 空要素
					switch(tag_name){
					case "META":
					case "LINK":
					case "IMG":
					case "HR":
					case "BR":
					case "INPUT":
						empty = true;
						break;
					}

					// スタックプッシュ
					edit = {
						element:element,
						name:tag_name,
						depth:edit.depth + 1
					};
					stack.push(edit);

					// 属性
					while(true){
						// 整形無視
						while(l > p){
							c = html.charAt(p);

							// 整形無視
							if(c == ' '){
							}else if(c == '　'){
							}else if(c == '\t'){
							}else if(c == '\r'){
							}else if(c == '\n'){
							}else{
								b = p;
								break;
							}
							p ++;
						}
						if(p >= l)	throw("end");

						// 要素の終了 '>'
						if(c == '>'){
							// スタックポップ
							if(empty){
								if(edit.depth){
									stack.pop();
									edit = stack[stack.length - 1];
								}
							}
							p += 1;
							break;

						// 空要素 '/'
						}else if(c == '/'){
							empty = true;
							p += 1;

						// 属性名の開始
						}else{
							// 属性名の終了
							while(l > p){
								c = html.charAt(p);
								if((c == ' ') || (c == '　') || (c == ' ') || (c == '\t') || (c == '\r') || (c == '\n') || (c == '>') || (c == '=')){
									e = p;
									break;
								}
								p ++;

							}
							if(p >= l)	throw("end");

							var attr_name = html.substring(b,e);
							var attr_value = undefined;

							// 整形無視
							while(l > p){
								c = html.charAt(p);
								if(c == ' '){
								}else if(c == '　'){
								}else if(c == '\t'){
								}else if(c == '\r'){
								}else if(c == '\n'){
								}else{
									break;
								}
								p ++;
							}
							if(p >= l)	throw("end");

							// 属性値 '='
							if(c == '='){
								p ++;

								// 整形無視
								while(l > p){
									c = html.charAt(p);
									if(c == ' '){
									}else if(c == '　'){
									}else if(c == '\t'){
									}else if(c == '\r'){
									}else if(c == '\n'){
									}else{
										break;
									}
									p ++;
								}
								if(p >= l)	throw("end");

								// 引用符
								var li = "";
								if(c == '"' || c == '\''){
									li = c;
									p ++;
								}

								b = p;

								// 属性値の終了、引用符の終了
								while(l > p){
									c = html.charAt(p);

									if(li){
										// 引用符の終了
										if(c == li){
											if(html.charAt(p - 1) != '\\'){
												e = p;
												p ++;
												break;
											}
										}
									}else{
										// 属性値の終了
										if((c == ' ') || (c == '　') || (c == ' ') || (c == '\t') || (c == '\r') || (c == '\n') || (c == '>')){
											e = p;
											break;
										}
									}

									p ++;
								}
								if(p >= l)	throw("end");

								// 属性値
								attr_value = html.substring(b,e);

							}

							if(edit.element){
								if(attr_name.toLowerCase().indexOf("on") == 0){
								}else{
									if(attr_value === undefined)	attr_value = "";

									// 属性生成
									var attribute = document.createAttribute(attr_name);
									attribute.value = attr_value;
									edit.element.setAttributeNode(attribute);
								}
							}
						}
					}
				}
			}
		}catch(e){}

		return nodes;
	}

	// --------------------------------------------------------------------------------
	// オブジェクトをコピー
	// --------------------------------------------------------------------------------
	function ObjectCopy(obj){
		if(!obj)	return null;

		var o;
		var s;
		var p;
		var root = new (obj.constructor)();
		var que = new Array();

		que.push({o:root,s:obj});

		while(true){
			p = que.pop();
			if(!p)	break;

			o = p.o;
			s = p.s;
			if(s.constructor == Array){
				var num = s.length;
				for(p=0;p<num;p++){
					switch(typeof(s[p])){
					case "boolean":
					case "number":
					case "string":
					case "null":
						o[p] = s[p];
						break;
					case "object":
						o[p] = new (s[p].constructor)();
						que.push({o:o[p],s:s[p]});
						break;
					}
				}
			}else{
				for(p in s){
					switch(typeof(s[p])){
					case "boolean":
					case "number":
					case "string":
					case "null":
						o[p] = s[p];
						break;
					case "object":
						o[p] = new (s[p].constructor)();
						que.push({o:o[p],s:s[p]});
						break;
					}
				}
			}
		}

		return root;
	}

	// --------------------------------------------------------------------------------
	// オブジェクトからプロパティを破棄
	// --------------------------------------------------------------------------------
	function ObjectDeleteProperty(obj,key){
		try{
			obj[key] = null;
			delete obj[key];
		}catch(e){
		}
	}

	// --------------------------------------------------------------------------------
	// 正規表現でバックスラッシュワードを置換
	// --------------------------------------------------------------------------------
	function RegExpReplacementBackslashWord(re,src,w){
		if(!re)	return src;
		var ary = src.match(re);
		if(!ary)	return src;
		var num = ary.length;
		return w.replace(new RegExp("\\\\\\\\|\\\\[0-9]","g"),function(str, p1, p2) {
			if(str == "\\\\")	return "\\";
			var p = parseInt(str[1]);
			if(p > 0 && p <= num){
				return ary[p];
			}
			if(p == 0)	return ary[0];
			return "";
		});
	}

	// --------------------------------------------------------------------------------
	// 正規表現でドルワードを置換
	// --------------------------------------------------------------------------------
	function RegExpReplacementDollarWord(re,src,w){
		if(!re)	return src;
		var ary = src.match(re);
		if(!ary)	return src;
		var num = ary.length;
		return w.replace(new RegExp("[$][$]|[$][0-9]","g"),function(str, p1, p2) {
			if(str == "$$")	return "$";
			var p = parseInt(str[1]);
			if(p > 0 && p <= num){
				return ary[p];
			}
			if(p == 0)	return ary[0];
			return "";
		});
	}

	// --------------------------------------------------------------------------------
	// クリップボードにテキストをコピー
	// --------------------------------------------------------------------------------
	function ClipboardSetText(str){
	}

	// --------------------------------------------------------------------------------
	// フレーム内であるか取得
	// --------------------------------------------------------------------------------
	function WindowGetInFrame(type){
		return (window != window.parent);
	}

	// --------------------------------------------------------------------------------
	// HEAD 要素を取得
	// --------------------------------------------------------------------------------
	function DocumentGetHeadElement(document_obj){
		if(document_obj.head){
			return document_obj.head;
		}

		var nodes = document_obj.documentElement.childNodes;
		var i;
		var num = nodes.length;
		for(i=0;i<num;i++){
			if(nodes[i].tagName == "HEAD"){
				return nodes[i];
			}
		}

		return null;
	}

	// --------------------------------------------------------------------------------
	// クライアント領域のサイズを取得
	// --------------------------------------------------------------------------------
	function DocumentGetClientSize(document_obj){
		var b = document_obj.body;
		var r = document_obj.documentElement;
		var w = b.clientWidth;
		var h;
		if(w < r.clientWidth)	w = r.clientWidth;
		if(document_obj.compatMode == "BackCompat"){
			h = b.clientHeight;
		}else{
			if(r.clientHeight){
				h = r.clientHeight;
			}else{
				h = b.clientHeight;
			}
		}
		return {
			width :w,
			height:h
		};
	}

	// --------------------------------------------------------------------------------
	// スクロール座標を取得
	// --------------------------------------------------------------------------------
	function DocumentGetScrollPos(){
		return{
			x:document.body.scrollLeft || document.documentElement.scrollLeft,
			y:document.body.scrollTop  || document.documentElement.scrollTop
		};
	}

	// --------------------------------------------------------------------------------
	// スクロール座標をセット
	// --------------------------------------------------------------------------------
	function DocumentSetScrollPos(pos){
		DocumentSetScrollPosX(pos.x);
		DocumentSetScrollPosY(pos.y);
	}

	// --------------------------------------------------------------------------------
	// 水平方向スクロール座標をセット
	// --------------------------------------------------------------------------------
	function DocumentSetScrollPosX(x){
		if(document.body){
			document.body.scrollLeft = x;
		}
		if(document.documentElement){
			document.documentElement.scrollLeft = x;
		}
	}

	// --------------------------------------------------------------------------------
	// 垂直方向スクロール座標をセット
	// --------------------------------------------------------------------------------
	function DocumentSetScrollPosY(y){
		if(document.body){
			document.body.scrollTop = y;
		}
		if(document.documentElement){
			document.documentElement.scrollTop = y;
		}
	}

	// --------------------------------------------------------------------------------
	// HTML 全体のサイズを取得
	// --------------------------------------------------------------------------------
	function DocumentGetSize(){
		var width = 0;
		var height = 0;

		var body = document.body;
		if(body){
			if(width  < body.clientWidth)	width  = body.clientWidth;
			if(width  < body.scrollWidth)	width  = body.scrollWidth;
			if(height < body.clientHeight)	height = body.clientHeight;
			if(height < body.scrollHeight)	height = body.scrollHeight;
		}
		var html = document.documentElement;
		if(html){
			if(width  < html.clientWidth)	width  = html.clientWidth;
			if(width  < html.scrollWidth)	width  = html.scrollWidth;
			if(height < html.clientHeight)	height = html.clientHeight;
			if(height < html.scrollHeight)	height = html.scrollHeight;
		}

		return {
			width:width,
			height:height
		};
	}

	// ------------------------------------------------------------
	// DOM オブジェクトの構築が完了したか調べる関数
	// ------------------------------------------------------------
	function DocumentGetLoadedDomContent(document_obj,callback){

		function DOMContentLoadedFunc(e){
			document_obj.removeEventListener("readystatechange" , DOMContentLoadedFunc);
			callback();
		}

		function ReadyStateChangeFunc(e){
			switch(document_obj.readyState){
			case "interactive":
			case "complete":
				document_obj.detachEvent("onreadystatechange" , ReadyStateChangeFunc);
				callback();
			}
		}

		switch(document_obj.readyState){
		case "interactive":
		case "complete":
			callback();
			return;
		}

		if(document_obj.addEventListener){
			document_obj.addEventListener("DOMContentLoaded" , DOMContentLoadedFunc);
		}else if(document_obj.attachEvent){
			document_obj.attachEvent("onreadystatechange" , ReadyStateChangeFunc);
		}
	}

	// --------------------------------------------------------------------------------
	// エレメント作成
	// --------------------------------------------------------------------------------
	function DocumentCreateElement(type){
		var element = document.createElement(type);
//		if(element.wrappedJSObject)	return element.wrappedJSObject;
		return element;
	}

	// --------------------------------------------------------------------------------
	// テキスト作成
	// --------------------------------------------------------------------------------
	function DocumentCreateText(value){
		var element = document.createTextNode(value);
//		if(element.wrappedJSObject)	return element.wrappedJSObject;
		return element;
	}

	// --------------------------------------------------------------------------------
	// クエリーを取得
	// --------------------------------------------------------------------------------
	function DocumentGetQuery(){
		return StringGetQuery(document.URL);
	}

	// --------------------------------------------------------------------------------
	// DOMノードが外れたか監視
	// --------------------------------------------------------------------------------
	function DocumentObserverRemoveDomNode(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// 開放
		// --------------------------------------------------------------------------------
		_container.release = function(){
			if(_mutation_observer){
				_mutation_observer.disconnect();
				_mutation_observer = null;
			}
		};

		// --------------------------------------------------------------------------------
		// 要素生成
		// --------------------------------------------------------------------------------
		_container.createElement = function(){
			var _element = new Object();

			// --------------------------------------------------------------------------------
			// コールバック関数をセット
			// --------------------------------------------------------------------------------
			_element.setFunction = function(f){
				_element.callback = f;
			};

			// --------------------------------------------------------------------------------
			// 要素をセット
			// --------------------------------------------------------------------------------
			_element.setDomNode = function(node){
				_element.node = node;

				if(_mutation_observer){
					_id = node._pageexpand_remove;
					if(!_id){
						_id = node._pageexpand_remove = _identity;
						_identity++;
					}

					if(!_list[_id]){
						var o = new Object();
						o._prev = o;
						o._next = o;
						_list[_id] = o;
					}

					var _prev = _list[_id];
					var _next = _prev._next;
					_prev._next = _element;
					_next._prev = _element;
					_element._prev = _prev;
					_element._next = _next;
				}
			};

			// --------------------------------------------------------------------------------
			// 開放
			// --------------------------------------------------------------------------------
			_element.release = function(){
				if(_mutation_observer){
					var _prev = _element._prev;
					var _next = _element._next;
					_prev._next = _next;
					_next._prev = _prev;
					_element._prev = _element;
					_element._next = _element;

					if(_list[_id] == _list[_id].next){
						ObjectDeleteProperty(_list,_id);
					}

				}else{
					if(_list_end == _element){
						_list_end = _element._prev;
					}
					if(_list_pos == _element){
						_list_pos = _element._prev;
					}

					var _prev = _element._prev;
					var _next = _element._next;
					_prev._next = _next;
					_next._prev = _prev;
					_element._prev = _element;
					_element._next = _element;
				}

				_count -= 1;
			};

			// --------------------------------------------------------------------------------
			// プライベート変数
			// --------------------------------------------------------------------------------
			var _id;

			// --------------------------------------------------------------------------------
			// 初期化
			// --------------------------------------------------------------------------------
			(function(){
				if(_mutation_observer){
					_element._prev = _element;
					_element._next = _element;
				}else{
					var _next = _list_pos;
					var _prev = _next._prev;
					_element._prev = _prev;
					_element._next = _next;
					_next._prev = _element;
					_prev._next = _element;

					_list_end = _element;
				}

				_element.callback = null;
				_element.node = null;

				_count += 1;
			})();

			return _element;
		};

		// --------------------------------------------------------------------------------
		// 要素数を取得
		// --------------------------------------------------------------------------------
		_container.getCount = function(){
			return _count;
		};

		// --------------------------------------------------------------------------------
		// 実行
		// --------------------------------------------------------------------------------
		_container.execute = function(){
			_list_end = _list_pos;
			var num = 5;
			var i;
			for(i=0;i<num;i++){
				if(_list_pos.node){
					if(!(DomNodeGetAttachedDocument(_list_pos.node))){
						_list_pos.callback();
					}
				}
				_list_pos = _list_pos._next;
				if(_list_pos == _list_end){
					return;
				}
			}
		};

		// --------------------------------------------------------------------------------
		// 検出
		// --------------------------------------------------------------------------------
		function detect(node){
			var w;
			var o;
			var p;
			var n;
			var i = 0;
			var c = 0;
			var m = 100;
			var q = new Object();
			var nodes = node.childNodes;
			q.p = q;
			q.n = q;

			// 中断
			function interrupt(){
				c = 0;
				execute_queue.attachFirstForRemoveDomNode(analyze,null);
			}

			// 子孫抽出
			function analyze(){
				while(node){
					if(nodes){
						while(nodes[i]){
							o = {node:nodes[i]};
							n = q;
							p = n.p;
							o.p = p;
							o.n = n;
							p.n = o;
							n.p = o;
							i++;
							c++;
							if(c > m){
								interrupt();
								return;
							}
						}
					}

					var id = node._pageexpand_remove;
					if(id){
						if(!(DomNodeGetAttachedDocument(node))){
							var ary = new Array();
							var dict = _list[id];
							var list = dict._next;
							while(list != dict){
								ary.push(list);
								list = list._next;
							}

							var j;
							var num = ary.length;
							for(j=0;j<num;j++){
								ary[j].callback();
							}
						}
					}

					o = q.n;
					p = o.p;
					n = o.n;
					p.n = n;
					n.p = p;
					node = o.node;
					if(node){
						i = 0;
						nodes = node.childNodes;
					}

					c++;
					if(c > m){
						interrupt();
						return;
					}
				}
			}

			analyze();
		}

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _mutation_observer;
		var _task;
		var _list;
		var _list_pos;
		var _list_end;
		var _count;
		var _identity;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_count = 0;

			if(MutationObserverSupported()){
				_list = new Array();
				_identity = 1;
				_mutation_observer = MutationObserverCreate(function(mutations) {
					var i;
					var num = mutations.length;
					for(i=0;i<num;i++){
						var nodes = mutations[i].removedNodes;
						var j;
						var node_num = nodes.length;
						for(j=0;j<node_num;j++){
							execute_queue.attachLastForRemoveDomNode(detect,nodes[j]);
						}
					}
				});
				_mutation_observer.observe(document.documentElement,{childList:true,subtree:true});
			}

			if(!_mutation_observer){
				_list = new Object();
				_list._prev = _list;
				_list._next = _list;
				_list_pos = _list;
				_list_end = _list;
			}
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// スクロール監視
	// --------------------------------------------------------------------------------
	function DocumentObserverScroll(){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// 開放
		// --------------------------------------------------------------------------------
		_container.release = function(){
			if(window.addEventListener){
				window.addEventListener("scroll",scroll_func,true);
			}else if(window.attachEvent){
				window.attachEvent("onscroll",scroll_func);
			}
		};

		// --------------------------------------------------------------------------------
		// 要素生成
		// --------------------------------------------------------------------------------
		_container.createElement = function(){
			var _element = new Object();

			// --------------------------------------------------------------------------------
			// コールバック関数をセット
			// --------------------------------------------------------------------------------
			_element.setFunction = function(f){
				_element.callback = f;
			};

			// --------------------------------------------------------------------------------
			// 開放
			// --------------------------------------------------------------------------------
			_element.release = function(){
				if(_list_end == _element){
					_list_end = _element._prev;
				}
				if(_list_pos == _element){
					_list_pos = _element._prev;
				}

				var _prev = _element._prev;
				var _next = _element._next;
				_prev._next = _next;
				_next._prev = _prev;
				_element._prev = _element;
				_element._next = _element;

				_count -= 1;
			};

			// --------------------------------------------------------------------------------
			// 初期化
			// --------------------------------------------------------------------------------
			(function(){
				var _next = _list_pos;
				var _prev = _next._prev;
				_element._prev = _prev;
				_element._next = _next;
				_next._prev = _element;
				_prev._next = _element;

				_list_end = _element;

				_element.callback = null;

				_count += 1;
			})();

			return _element;
		};

		// --------------------------------------------------------------------------------
		// 要素数を取得
		// --------------------------------------------------------------------------------
		_container.getCount = function(){
			return _count;
		};

		// --------------------------------------------------------------------------------
		// 検出
		// --------------------------------------------------------------------------------
		function detect(){
			if(_task){
				_list_end = _list_pos._prev;
			}else{
				_task = task_container.createTask();
				_task.setExecuteFunc(function(){
					var num = 10;
					var i;
					for(i=0;i<num;i++){
						if(_list_pos.callback){
							_list_pos.callback();
						}

						_list_pos = _list_pos._next;

						if(_list_pos == _list_end){
							_task.release();
							_task = null;
							return;
						}
					}
				});

				_list_pos = _list;
				_list_end = _list_pos._prev;

				_task.execute(0xffffffff);
			}
		}

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _mutation_observer;
		var _task;
		var _list;
		var _list_pos;
		var _list_end;
		var _count;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			_count = 0;
			_list = new Object();
			_list._prev = _list;
			_list._next = _list;
			_list_pos = _list;
			_list_end = _list;

			if(window.addEventListener){
				window.addEventListener("scroll",detect,true);
			}else if(window.attachEvent){
				window.attachEvent("onscroll",detect);
			}
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// エレメントからタグ名を指定してエレメントを取得
	// --------------------------------------------------------------------------------
	function ElementGetElementsByTagName(node,type){
		if(node.getElementsByTagName){
			return node.getElementsByTagName(type);
		}else if(node.querySelectorAll){
			return node.querySelectorAll(type);
		}else{
			type = type.toUpperCase();
			var ary = new Array();
			var p;
			var n;
			var q;
			var queue = new Object();
			q = {p:queue,n:queue,node:node};
			queue.p = q;
			queue.n = q;

			while(queue.n != queue){
				q = queue.n;
				p = q.p;
				n = q.n;
				p.n = n;
				n.p = p;
				var node = q.node;
				switch(node.nodeType){
				case 1:
					var i;
					var nodes = node.childNodes;
					var num = nodes.length;
					for(i=0;i<num;i++){
						n = queue;
						p = n.p;
						q = {p:p,n:n,node:nodes[i]};
						p.n = q;
						n.p = q;
					}
					if(node.tagName == type || type == '*'){
						ary.push(node);
					}
					break;
				}
			}
			return ary;
		}
	}

	// --------------------------------------------------------------------------------
	// エレメントから名前を指定してエレメントを取得する
	// --------------------------------------------------------------------------------
	function ElementGetElementsByName(node,name){
		var nodes = new Array();
		var p;
		var n;
		var q;
		var queue = new Object();
		q = {p:queue,n:queue,node:node};
		queue.p = q;
		queue.n = q;

		while(queue.n != queue){
			q = queue.n;
			p = q.p;
			n = q.n;
			p.n = n;
			n.p = p;
			var node = q.node;
			switch(node.nodeType){
			case 1:
				var i;
				var nodes = node.childNodes;
				var num = nodes.length;
				for(i=0;i<num;i++){
					n = queue;
					p = n.p;
					q = {p:p,n:n,node:nodes[i]};
					p.n = q;
					n.p = q;
				}
				if(node.getAttribute("name") == name){
					nodes.push(node);
				}
				break;
			}
		}
		return nodes;
	}

	// --------------------------------------------------------------------------------
	// エレメントのスタイルシートを取得
	// --------------------------------------------------------------------------------
	function ElementGetStyle(element){
		return element.style.cssText;
	}

	// --------------------------------------------------------------------------------
	// エレメントにスタイルを追加
	// --------------------------------------------------------------------------------
	function ElementAddStyle(element,style){
		element.style.cssText += style;
	}

	// --------------------------------------------------------------------------------
	// エレメントにスタイルをセット
	// --------------------------------------------------------------------------------
	function ElementSetStyle(element,style){
		element.style.cssText = style;
	}

	// --------------------------------------------------------------------------------
	// エレメントの幅を取得
	// --------------------------------------------------------------------------------
	function ElementGetClientWidth(element){
		var w;
		while(element){
			w = element.clientWidth;
			if(w)	break;
			element = element.parentNode;
		}
		if(!element)	return 0;
		return w;
	}

	// --------------------------------------------------------------------------------
	// エレメントのクライアント領域のバウンディング矩形を取得
	// --------------------------------------------------------------------------------
	function ElementGetBoundingClientRect(element){
		if(!(element.getBoundingClientRect))	return null;
		var r = element.getBoundingClientRect();
		var o = {
			left:r.left,
			right:r.right,
			top:r.top,
			bottom:r.bottom
		};

		if(UserAgentGetInternetExplorer() || UserAgentGetSleipnir()){
			var sx = 2;
			var sy = 2;
			o.left   -= sx;
			o.right  -= sx;
			o.top    -= sy;
			o.bottom -= sy;
		}

		return o;
	}

	// --------------------------------------------------------------------------------
	// エレメントのクライアント領域のコンテンツ矩形を取得
	// --------------------------------------------------------------------------------
	function ElementGetContentClientRect(element){
		var rect = ElementGetBoundingClientRect(element);
		var style = ElementGetComputedStyle(element,null);
		if(style){
			var re = new RegExp("^([-0-9.]+)px$","i");
			var list = [
				{style:"paddingLeft"   ,key:"left"   ,sign: 1},
				{style:"paddingRight"  ,key:"right"  ,sign:-1},
				{style:"paddingTop"    ,key:"top"    ,sign: 1},
				{style:"paddingBottom" ,key:"bottom" ,sign:-1},
				{style:"borderLeftWidth"   ,key:"left"   ,sign: 1},
				{style:"borderRightWidth"  ,key:"right"  ,sign:-1},
				{style:"borderTopWidth"    ,key:"top"    ,sign: 1},
				{style:"borderBottomWidth" ,key:"bottom" ,sign:-1}
			];
			var i;
			var num = list.length;
			for(i=0;i<num;i++){
				var param = list[i];
				if(style[param.style]){
					var m = style[param.style].match(re);
					if(m){
						rect[param.key] += parseFloat(m[0]) * param.sign;
					}
				}
			}
		}
		return rect;
	}

	// --------------------------------------------------------------------------------
	// エレメントのクライアント領域の可視矩形を取得
	// --------------------------------------------------------------------------------
	function ElementGetViewClientRect(element){
		var rect = ElementGetBoundingClientRect(element);
		var overflow_hidden = {"scroll":1,"hidden":1,"auto":1};
		var display_inline = {"inline":1,"none":1,"table-column":1,"table-column-group":1};

		while(element){
			var r = ElementGetBoundingClientRect(element);
			if(!r) break;

			if(element.tagName == "BODY") break;

			var style = ElementGetComputedStyle(element,null);
			if(style){
				if(!display_inline[style.display]){
					if(overflow_hidden[style.overflow]){
						if(r.bottom < rect.bottom) rect.bottom = r.bottom;
						if(r.top    > rect.top   ) rect.top    = r.top;
						if(r.right  < rect.right ) rect.right  = r.right;
						if(r.left   > rect.left  ) rect.left   = r.left;
					}
				}
			}

			element = element.offsetParent;
		}
		return rect;
	}

	// --------------------------------------------------------------------------------
	// エレメントのパディングサイズを取得
	// --------------------------------------------------------------------------------
	function ElementGetPaddingWidth(element){
		var rect = {left:0,right:0,top:0,bottom:0};
		var style = ElementGetComputedStyle(element,null);
		if(style){
			var re = new RegExp("^([-0-9.]+)px$","i");
			var list = [
				{style:"paddingLeft"   ,key:"left"  },
				{style:"paddingRight"  ,key:"right" },
				{style:"paddingTop"    ,key:"top"   },
				{style:"paddingBottom" ,key:"bottom"}
			];
			var i;
			var num = list.length;
			for(i=0;i<num;i++){
				var param = list[i];
				if(style[param.style]){
					var m = style[param.style].match(re);
					if(m){
						rect[param.key] = parseFloat(m[0]);
					}
				}
			}
		}
		return rect;
	}

	// --------------------------------------------------------------------------------
	// エレメントのボーダーサイズを取得
	// --------------------------------------------------------------------------------
	function ElementGetBoaderWidth(element){
		var rect = {left:0,right:0,top:0,bottom:0};
		var style = ElementGetComputedStyle(element,null);
		if(style){
			var re = new RegExp("^([-0-9.]+)px$","i");
			var list = [
				{style:"borderLeftWidth"   ,key:"left"  },
				{style:"borderRightWidth"  ,key:"right" },
				{style:"borderTopWidth"    ,key:"top"   },
				{style:"borderBottomWidth" ,key:"bottom"}
			];
			var i;
			var num = list.length;
			for(i=0;i<num;i++){
				var param = list[i];
				if(style[param.style]){
					var m = style[param.style].match(re);
					if(m){
						rect[param.key] += parseFloat(m[0]);
					}
				}
			}
		}
		return rect;
	}

	// --------------------------------------------------------------------------------
	// エレメントとクライアント座標との当たり判定を取得
	// --------------------------------------------------------------------------------
	function ElementClientRectsTree(element){
		var _this = this;

		// --------------------------------------------------------------------------------
		// 座標との当たり判定
		// --------------------------------------------------------------------------------
		_this.hitTestPosition = function(pos,child_type){
			var node = _this.parentNode;
			while(node){
				var r = node.boundingClientRect;
				if(!r) break;

				if(r.bottom + 1 < pos.y) return false;
				if(r.top    - 1 > pos.y) return false;
				if(r.right  + 1 < pos.x) return false;
				if(r.left   - 1 > pos.x) return false;

				node = node.parentNode;
			}

			var queue = new Array();
			queue.push(_this);
			while(true){
				var node = queue.pop();
				if(!node)	break;

				// 子ノード
				var child_nodes = node.childNodes;
				var i;
				var num = child_nodes.length;
				for(i=0;i < num;i++){
					queue.push(child_nodes[i]);
				}

				var ary = node.clientRects;
				var i;
				var num = ary.length;
				for(i=0;i<num;i++){
					var r = ary[i];
					if(r.bottom + 2 < pos.y){
					}else if(r.top - 2 > pos.y){
					}else if(r.right + 2 < pos.x){
					}else if(r.left - 2 > pos.x){
					}else{
						return true;
					}
				}

				if(!child_type)	return false;
			}

			return false;
		};

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			var overflow_hidden = {"scroll":1,"hidden":1,"auto":1};
			var display_inline = {"inline":1,"none":1,"table-column":1,"table-column-group":1};

			var node_obj = _this;
			var node = element;
			while(node){
				var r = ElementGetBoundingClientRect(node);
				if(!r) break;

				if(node.tagName == "BODY") break;

				var style = ElementGetComputedStyle(node,null);
				if(style){
					if(!display_inline[style.display]){
						if(overflow_hidden[style.overflow]){
							node_obj.parentNode = {
								boundingClientRect:r
							};
							node_obj = node_obj.parentNode;
						}
					}
				}

				node = node.offsetParent;
			}

			_this.childNodes = new Array();
			_this.clientRects = new Array();
			var queue = new Array();
			queue.push({node:element,node_obj:_this});
			while(true){
				var param = queue.pop();
				if(!param)	break;
				var node_obj = param.node_obj;
				var node = param.node;

				var check = true;
				var style = null;
				if(node.nodeType == 1){
					style = ElementGetComputedStyle(node,null);
				}
				if(style){
					if(!display_inline[style.display]){
						if(overflow_hidden[style.overflow]){
							check = false;
						}
					}
				}
				if(check){
					// 子ノード
					var child_nodes = node.childNodes;
					var i;
					var num = child_nodes.length;
					for(i=0;i < num;i++){
						var o = {
							childNodes:new Array(),
							clientRects:new Array()
						};
						queue.push({
							node:child_nodes[i],
							node_obj:o
						});
						node_obj.childNodes.push(o);
					}
				}

				if(node.getClientRects){
					var ary = node.getClientRects();
					var i;
					var num = ary.length;
					for(i=0;i<num;i++){
						node_obj.clientRects.push(ary[i]);
					}
				}
			}
		})();
	}

	// --------------------------------------------------------------------------------
	// エレメントとクライアント座標との当たり判定を取得
	// --------------------------------------------------------------------------------
	function ElementHitTestPosition(element,pos,child_type){

		var overflow_hidden = {"scroll":1,"hidden":1,"auto":1};
		var display_inline = {"inline":1,"none":1,"table-column":1,"table-column-group":1};

		var node = element;
		while(node){
			var r = ElementGetBoundingClientRect(node);
			if(!r) break;

			if(node.tagName == "BODY") break;

			var style = ElementGetComputedStyle(node,null);
			if(style){
				if(!display_inline[style.display]){
					if(overflow_hidden[style.overflow]){
						if(r.bottom + 1 < pos.y) return false;
						if(r.top    - 1 > pos.y) return false;
						if(r.right  + 1 < pos.x) return false;
						if(r.left   - 1 > pos.x) return false;
					}
				}
			}

			node = node.offsetParent;
		}

		var queue = new Array();
		queue.push(element);
		while(true){
			element = queue.pop();
			if(!element)	break;

			var check = true;
			var style = null;
			if(element.nodeType == 1){
				style = ElementGetComputedStyle(element,null);
			}
			if(style){
				if(!display_inline[style.display]){
					if(overflow_hidden[style.overflow]){
						check = false;
					}
				}
			}
			if(check){
				// 子ノード
				var child_nodes = element.childNodes;
				var i;
				var num = child_nodes.length;
				for(i=0;i < num;i++){
					queue.push(child_nodes[i]);
				}
			}

			if(element.getClientRects){
				var ary = element.getClientRects();
				var i;
				var num = ary.length;
				for(i=0;i<num;i++){
					var r = ary[i];
					if(r.bottom + 2 < pos.y){
					}else if(r.top - 2 > pos.y){
					}else if(r.right + 2 < pos.x){
					}else if(r.left - 2 > pos.x){
					}else{
						return true;
					}
				}
			}

			if(!child_type)	return false;
		}

		return false;
	}

	// --------------------------------------------------------------------------------
	// エレメントとマウスクライアント座標との当たり判定を取得
	// --------------------------------------------------------------------------------
	function ElementHitTestMousePosition(element,pos,child_type){
		var element_hit = document.elementFromPoint(pos.x,pos.y);
		if(child_type){
			while(element_hit){
				if(element_hit == element){
					return true;
				}
				element_hit = element_hit.parentNode;
			}
			return false;
		}
		return (element_hit == element);
	}

	// --------------------------------------------------------------------------------
	// 最終的に適用されているスタイルを取得
	// --------------------------------------------------------------------------------
	function ElementGetComputedStyle(element,pseudo_element){
		var document_obj = element.ownerDocument;
		if(document_obj){
			var window_obj = document_obj.defaultView;
			if(window_obj){
				if(window_obj.getComputedStyle !== undefined){
					return window_obj.getComputedStyle(element,pseudo_element);
				}
			}
		}
		if(element.currentStyle !== undefined){
			return element.currentStyle;
		}
		return null;
	}

	// --------------------------------------------------------------------------------
	// DOM ノードの直前に DOM ノードを登録（削除予定）
	// --------------------------------------------------------------------------------
	function DomNodeInsertBefore(node_new,node_ref){
		var parent = node_ref.parentNode;
		if(!parent)	return false;

		var node =  parent.insertBefore(node_new,node_ref);
		return (node == node_new);
	}

	// --------------------------------------------------------------------------------
	// DOM ノードの直後に DOM ノードを登録（削除予定）
	// --------------------------------------------------------------------------------
	function DomNodeInsertAfter(node_new,node_ref){
		var parent = node_ref.parentNode;
		if(!parent)	return false;

		var node =  parent.insertBefore(node_new,node_ref.nextSibling);
		return (node == node_new);
	}

	// --------------------------------------------------------------------------------
	// 子の最先頭に登録（削除予定）
	// --------------------------------------------------------------------------------
	function DomNodeInsertFirstChild(node_new,node_ref){
		try{
			var child = node_ref.firstChild;
			var node =  node_ref.insertBefore(node_new,child);
			return (node == node_new);
		}catch(e){
			return false;
		}
	}

	// --------------------------------------------------------------------------------
	// 子の最後尾に登録（削除予定）
	// --------------------------------------------------------------------------------
	function DomNodeInsertLastChild(node_new,node_ref){
		try{
			var node =  node_ref.appendChild(node_new);
			return (node == node_new);
		}catch(e){
			return false;
		}
	}

	// --------------------------------------------------------------------------------
	// DOM ノードの直前に DOM ノードを登録
	// --------------------------------------------------------------------------------
	function DomNode_InsertBefore(node_ref,node_new){
		var parent = node_ref.parentNode;
		if(!parent)	return false;

		var node =  parent.insertBefore(node_new,node_ref);
		return (node == node_new);
	}

	// --------------------------------------------------------------------------------
	// DOM ノードの直後に DOM ノードを登録
	// --------------------------------------------------------------------------------
	function DomNode_InsertAfter(node_ref,node_new){
		var parent = node_ref.parentNode;
		if(!parent)	return false;

		var node =  parent.insertBefore(node_new,node_ref.nextSibling);
		return (node == node_new);
	}

	// --------------------------------------------------------------------------------
	// 子の最先頭に登録
	// --------------------------------------------------------------------------------
	function DomNode_InsertFirstChild(node_ref,node_new){
		try{
			var child = node_ref.firstChild;
			var node =  node_ref.insertBefore(node_new,child);
			return (node == node_new);
		}catch(e){
			return false;
		}
	}

	// --------------------------------------------------------------------------------
	// 子の最後尾に登録
	// --------------------------------------------------------------------------------
	function DomNode_InsertLastChild(node_ref,node_new){
		try{
			var node =  node_ref.appendChild(node_new);
			return (node == node_new);
		}catch(e){
			return false;
		}
	}

	// --------------------------------------------------------------------------------
	// DOM ノードの登録を外す
	// --------------------------------------------------------------------------------
	function DomNodeRemove(node_ref){
		var parent = node_ref.parentNode;
		if(!parent)	return false;

		var node =  parent.removeChild(node_ref);
		return (node == node_ref);
	}

	// --------------------------------------------------------------------------------
	// DOM ノードが document に登録されているか調べる
	// --------------------------------------------------------------------------------
	function DomNodeGetAttachedDocument(node){
		try{
			while(true){
				if(!node)	return false;
				if(node == document)	break;
				node = node.parentNode;
			}
		}catch(e){
			return false;
		}
		return true;
	}

	// --------------------------------------------------------------------------------
	// DOM ノードからノード値を取得
	// --------------------------------------------------------------------------------
	function DomNodeGetNodeValue(node){
		try{
			return node.nodeValue;
		}catch(e){
		}
		return "";
	}

	// --------------------------------------------------------------------------------
	// DOM ノードにノード値をセット
	// --------------------------------------------------------------------------------
	function DomNodeSetNodeValue(node,value){
		try{
			node.nodeValue = value;
		}catch(e){
		}
	}

	// --------------------------------------------------------------------------------
	// DOM ノードが外れるか調べる
	// --------------------------------------------------------------------------------
	function DomNodeObserverRemoveFromDocument(node){
		var _container = new Object();

		// --------------------------------------------------------------------------------
		// 開放
		// --------------------------------------------------------------------------------
		_container.release = function(){
			if(_observer_remove_node){
				_observer_remove_node.release();
				_observer_remove_node = null;
			}else if(node.removeEventListener){
				node.removeEventListener('DOMNodeRemovedFromDocument',detectForMutationEvent);
			}
		};

		// --------------------------------------------------------------------------------
		// コールバック関数をセット
		// --------------------------------------------------------------------------------
		_container.setFunction = function(f){
			_func = f;
		};

		// --------------------------------------------------------------------------------
		// 検出（内部用）
		// --------------------------------------------------------------------------------
		function detect(e){
			if(_func)	_func(e);
		}

		// --------------------------------------------------------------------------------
		// 検出（内部用）
		// --------------------------------------------------------------------------------
		function detectForMutationEvent(e){
			execute_queue.attachLastForRemoveDomNode(detect,e);
		}

		// --------------------------------------------------------------------------------
		// プライベート変数
		// --------------------------------------------------------------------------------
		var _func;
		var _observer_remove_node;

		// --------------------------------------------------------------------------------
		// 初期化
		// --------------------------------------------------------------------------------
		(function(){
			if(MutationObserverSupported()){
				_observer_remove_node = document_observer_remove_node.createElement();
				_observer_remove_node.setDomNode(node);
				_observer_remove_node.setFunction(detect);
			}else if(node.addEventListener){
				node.addEventListener('DOMNodeRemovedFromDocument',detectForMutationEvent);
			}
		})();

		return _container;
	}

	// --------------------------------------------------------------------------------
	// エレメント複製
	// --------------------------------------------------------------------------------
	function ElementCloneNode(element,child_clone){
		return element.cloneNode(child_clone);
	}

	// --------------------------------------------------------------------------------
	// エレメントのテキストを取得
	// --------------------------------------------------------------------------------
	function ElementGetTextContent(element){
		if(element.textContent !== undefined){
			return element.textContent;
		}
		if(element.innerText !== undefined){
			return element.innerText;
		}

		return "";
	}

	// --------------------------------------------------------------------------------
	// エレメントにテキストをセット
	// --------------------------------------------------------------------------------
	function ElementSetTextContent(element,str){
		if(element.textContent !== undefined){
			element.textContent = str;
		}
		if(element.innerText !== undefined){
			element.innerText = str;
		}
	}

	// --------------------------------------------------------------------------------
	// スタイルにプロパティをセット
	// --------------------------------------------------------------------------------
	function StyleDeclarationSetProperty(style,name,value){
		if(style.setProperty){
			style.setProperty(name,value);
		}else{
			try{
				name = name.replace(/[-]([a-z])/g, function(s,p1){ return p1.toUpperCase(); });
				style[name] = value;
			}catch(e){
			}
		}
	}

	// --------------------------------------------------------------------------------
	// スタイルからプロパティを削除
	// --------------------------------------------------------------------------------
	function StyleDeclarationRemoveProperty(style,name){
		if(style.removeProperty){
			style.removeProperty(name);
		}else{
			try{
				name = name.replace(/[-]([a-z])/g, function(s,p1){ return p1.toUpperCase(); });
				style[name] = "none";
				delete style[name];
			}catch(e){
			}
		}
	}

	// --------------------------------------------------------------------------------
	// イメージを複製
	// --------------------------------------------------------------------------------
	function ImageClone(image){
		var c = ElementCloneNode(image,false);

		var style = image.style;
		for(var p in style){
			try{
				c.style[p] = style[p];
			}catch(e){}
		}
		return c;
	}

	// --------------------------------------------------------------------------------
	// イメージのデフォルトのサイズを取得
	// --------------------------------------------------------------------------------
	function ImageGetNaturalSize(image) {
		if(image.naturalWidth === undefined){
		}else if(image.naturalHeight === undefined){
		}else{
			return {
				width :image.naturalWidth,
				height:image.naturalHeight
			};
		}

		// Opera 用
		if(UserAgentGetOpera()){
			var w = image.width;
			var h = image.height;

			image.removeAttribute("width");
			image.removeAttribute("height");

			var size = {
				width :image.width,
				height:image.height
			};
			image.width  = w;
			image.height = h;

			return size;
		}

		image = ElementCloneNode(image,false);
		return {
			width :image.width,
			height:image.height
		};
	}

